<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
  <title>PromptPay Analytics</title>
  <style>
    :root {
      --bg: #0a0a12; --bg2: #12121e; --surface: #1a1a2e; --border: #262640;
      --accent: #7c3aed; --accent2: #a78bfa; --green: #22c55e; --red: #ef4444;
      --yellow: #f59e0b; --text: #f0f2f5; --text2: #8b92a5; --text3: #555;
      --font: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      --safe-top: env(safe-area-inset-top, 0px);
      --safe-bottom: env(safe-area-inset-bottom, 0px);
    }
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body {
      font-family: var(--font); background: var(--bg); color: var(--text);
      min-height: 100vh; padding: max(16px, var(--safe-top)) 16px max(16px, var(--safe-bottom));
    }
    a { color: var(--accent2); text-decoration: none; }

    /* Header */
    .an-header {
      display: flex; align-items: center; gap: 12px; padding: 16px 0; margin-bottom: 16px;
      border-bottom: 1px solid var(--border);
    }
    .an-header-back {
      width: 40px; height: 40px; border-radius: 50%; border: 1px solid var(--border);
      background: var(--surface); color: var(--text); display: flex; align-items: center;
      justify-content: center; cursor: pointer; text-decoration: none;
    }
    .an-header h1 { font-size: 20px; font-weight: 700; flex: 1; }
    .an-header .role-badge {
      font-size: 10px; padding: 4px 10px; border-radius: 20px; font-weight: 600;
      background: linear-gradient(135deg, var(--accent), var(--accent2)); color: #fff; letter-spacing: .5px;
    }

    /* Tab bar */
    .an-tabs {
      display: flex; gap: 4px; overflow-x: auto; scrollbar-width: none; padding-bottom: 12px;
      -webkit-overflow-scrolling: touch;
    }
    .an-tabs::-webkit-scrollbar { display: none; }
    .an-tab {
      padding: 8px 16px; border-radius: 20px; border: 1px solid var(--border);
      background: var(--surface); color: var(--text2); font-size: 13px; font-weight: 600;
      cursor: pointer; white-space: nowrap; transition: all .2s;
    }
    .an-tab.active { background: var(--accent); color: #fff; border-color: var(--accent); }

    /* KPI Cards */
    .kpi-grid {
      display: grid; grid-template-columns: repeat(auto-fill, minmax(160px, 1fr)); gap: 12px;
      margin-bottom: 20px;
    }
    .kpi-card {
      background: var(--surface); border: 1px solid var(--border); border-radius: 14px;
      padding: 16px; transition: border-color .2s;
    }
    .kpi-card:hover { border-color: var(--accent); }
    .kpi-label { font-size: 11px; color: var(--text2); text-transform: uppercase; letter-spacing: .5px; margin-bottom: 6px; }
    .kpi-value { font-size: 22px; font-weight: 800; margin-bottom: 4px; }
    .kpi-trend { font-size: 11px; font-weight: 600; display: flex; align-items: center; gap: 4px; }
    .kpi-trend.up { color: var(--green); }
    .kpi-trend.down { color: var(--red); }
    .kpi-trend.stable { color: var(--text2); }
    .kpi-sparkline { margin-top: 8px; height: 24px; }
    .kpi-sparkline svg { width: 100%; height: 100%; }

    /* Section */
    .an-section { margin-bottom: 24px; }
    .an-section-title { font-size: 16px; font-weight: 700; margin-bottom: 12px; display: flex; align-items: center; gap: 8px; }
    .an-section-title .badge { font-size: 10px; padding: 2px 8px; border-radius: 10px; background: var(--accent); color: #fff; }

    /* Chart container */
    .chart-box {
      background: var(--surface); border: 1px solid var(--border); border-radius: 14px;
      padding: 16px; min-height: 200px; position: relative;
    }
    .chart-box canvas { width: 100% !important; height: auto !important; }
    .chart-filters {
      display: flex; flex-wrap: wrap; gap: 8px; margin-bottom: 12px;
    }
    .chart-filter {
      padding: 6px 12px; border-radius: 8px; border: 1px solid var(--border); background: var(--bg);
      color: var(--text2); font-size: 12px; cursor: pointer; outline: none;
    }
    .chart-filter:focus { border-color: var(--accent); }

    /* Insights panel */
    .insight-card {
      background: var(--surface); border: 1px solid var(--border); border-radius: 12px;
      padding: 14px 16px; margin-bottom: 8px; display: flex; gap: 12px; align-items: flex-start;
    }
    .insight-icon {
      width: 36px; height: 36px; border-radius: 10px; display: flex; align-items: center;
      justify-content: center; font-size: 18px; flex-shrink: 0;
    }
    .insight-icon.warning { background: rgba(245,158,11,.15); }
    .insight-icon.positive { background: rgba(34,197,94,.15); }
    .insight-icon.info { background: rgba(124,58,237,.15); }
    .insight-title { font-size: 13px; font-weight: 700; margin-bottom: 2px; }
    .insight-desc { font-size: 12px; color: var(--text2); line-height: 1.4; }
    .insight-meta { font-size: 10px; color: var(--text3); margin-top: 4px; }
    .insight-confidence {
      display: inline-block; padding: 1px 6px; border-radius: 4px; font-size: 10px; font-weight: 600;
    }

    /* Partner ranking table */
    .rank-table {
      width: 100%; border-collapse: collapse; font-size: 13px;
    }
    .rank-table th {
      text-align: left; padding: 10px 12px; color: var(--text2); font-size: 11px;
      text-transform: uppercase; letter-spacing: .5px; border-bottom: 1px solid var(--border);
    }
    .rank-table td { padding: 10px 12px; border-bottom: 1px solid rgba(255,255,255,.03); }
    .rank-table tr:hover td { background: rgba(124,58,237,.05); }
    .rank-num { font-weight: 800; color: var(--accent); }

    /* Forecast */
    .forecast-meta {
      display: flex; flex-wrap: wrap; gap: 12px; margin-top: 12px;
    }
    .forecast-pill {
      padding: 6px 12px; border-radius: 8px; background: var(--bg); border: 1px solid var(--border);
      font-size: 12px; color: var(--text2);
    }
    .forecast-pill b { color: var(--text); }

    /* Cash flow */
    .cf-legend { display: flex; gap: 16px; margin-top: 8px; font-size: 12px; color: var(--text2); }
    .cf-dot { width: 10px; height: 10px; border-radius: 50%; display: inline-block; margin-right: 4px; }

    /* Loading */
    .loading { text-align: center; padding: 40px; color: var(--text2); }
    .loading-spin {
      width: 32px; height: 32px; border: 3px solid var(--border); border-top-color: var(--accent);
      border-radius: 50%; animation: spin .8s linear infinite; margin: 0 auto 12px;
    }
    @keyframes spin { to { transform: rotate(360deg); } }

    /* Responsive */
    @media (max-width: 400px) {
      .kpi-grid { grid-template-columns: repeat(2, 1fr); gap: 8px; }
      .kpi-value { font-size: 18px; }
      .kpi-card { padding: 12px; }
      body { padding: 12px; }
    }
    @media (min-width: 768px) {
      body { max-width: 900px; margin: 0 auto; padding: 24px; }
      .kpi-grid { grid-template-columns: repeat(4, 1fr); }
    }
    @media (min-width: 1200px) {
      body { max-width: 1100px; }
    }
  </style>
</head>
<body>

<div class="an-header">
  <a href="/" class="an-header-back">
    <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><line x1="19" y1="12" x2="5" y2="12"/><polyline points="12 19 5 12 12 5"/></svg>
  </a>
  <h1>Analytics & Insights</h1>
  <span class="role-badge" id="an-role">SUPER ADMIN</span>
</div>

<div class="an-tabs" id="an-tabs">
  <div class="an-tab active" onclick="switchAnTab('overview')">Overview</div>
  <div class="an-tab" onclick="switchAnTab('trends')">Trends</div>
  <div class="an-tab" onclick="switchAnTab('forecast')">Forecast</div>
  <div class="an-tab" onclick="switchAnTab('insights')">AI Insights</div>
  <div class="an-tab" onclick="switchAnTab('cashflow')">Cash Flow</div>
  <div class="an-tab" onclick="switchAnTab('partners')">Partners</div>
</div>

<!-- OVERVIEW TAB -->
<div id="tab-overview" class="an-section">
  <div class="kpi-grid" id="kpi-grid">
    <div class="loading"><div class="loading-spin"></div>Loading metrics...</div>
  </div>
</div>

<!-- TRENDS TAB -->
<div id="tab-trends" class="an-section" style="display:none">
  <div class="chart-filters">
    <select class="chart-filter" id="trend-agg" onchange="loadTrends()">
      <option value="hourly">Hourly</option>
      <option value="daily" selected>Daily</option>
      <option value="weekly">Weekly</option>
      <option value="monthly">Monthly</option>
    </select>
    <select class="chart-filter" id="trend-metric" onchange="renderTrendChart()">
      <option value="volume">Volume</option>
      <option value="transactions">Transactions</option>
      <option value="revenue">Revenue</option>
    </select>
  </div>
  <div class="chart-box">
    <canvas id="trend-chart" height="250"></canvas>
  </div>
  <div style="margin-top:16px">
    <div class="an-section-title">User Growth</div>
    <div class="chart-box">
      <canvas id="user-chart" height="180"></canvas>
    </div>
  </div>
</div>

<!-- FORECAST TAB -->
<div id="tab-forecast" class="an-section" style="display:none">
  <div class="chart-filters">
    <select class="chart-filter" id="fc-horizon" onchange="loadForecast()">
      <option value="7">7 Days</option>
      <option value="30" selected>30 Days</option>
      <option value="90">90 Days</option>
    </select>
    <select class="chart-filter" id="fc-metric" onchange="loadForecast()">
      <option value="volume">Volume</option>
      <option value="revenue">Revenue</option>
      <option value="transactions">Transactions</option>
    </select>
  </div>
  <div class="chart-box">
    <canvas id="forecast-chart" height="280"></canvas>
  </div>
  <div class="forecast-meta" id="fc-meta"></div>
</div>

<!-- AI INSIGHTS TAB -->
<div id="tab-insights" class="an-section" style="display:none">
  <div class="an-section-title">AI-Generated Insights <span class="badge">Live</span></div>
  <div id="insights-summary" style="font-size:13px;color:var(--text2);margin-bottom:12px;padding:10px;background:var(--surface);border-radius:10px;border:1px solid var(--border)"></div>
  <div id="insights-list">
    <div class="loading"><div class="loading-spin"></div>Analyzing patterns...</div>
  </div>
</div>

<!-- CASH FLOW TAB -->
<div id="tab-cashflow" class="an-section" style="display:none">
  <div class="an-section-title">Cash Flow Projection</div>
  <div class="chart-box">
    <canvas id="cf-chart" height="260"></canvas>
  </div>
  <div class="cf-legend">
    <span><span class="cf-dot" style="background:var(--green)"></span>Inflow</span>
    <span><span class="cf-dot" style="background:var(--red)"></span>Outflow</span>
    <span><span class="cf-dot" style="background:var(--accent)"></span>Balance</span>
  </div>
  <div id="cf-warning" style="display:none;margin-top:12px;padding:12px;background:rgba(239,68,68,.1);border:1px solid rgba(239,68,68,.3);border-radius:10px;font-size:13px;color:var(--red)">
    Low liquidity warning: Projected balance drops below zero. Review settlement timing.
  </div>
</div>

<!-- PARTNERS TAB -->
<div id="tab-partners" class="an-section" style="display:none">
  <div class="an-section-title">Top Partners</div>
  <div class="chart-filters">
    <select class="chart-filter" id="partner-sort" onchange="loadPartners()">
      <option value="volume">By Volume</option>
      <option value="revenue">By Revenue</option>
    </select>
  </div>
  <div class="chart-box" style="overflow-x:auto">
    <table class="rank-table" id="partner-table">
      <thead><tr><th>#</th><th>Partner</th><th>Volume</th><th>Revenue</th><th>Transactions</th></tr></thead>
      <tbody id="partner-tbody"></tbody>
    </table>
  </div>
  <div style="margin-top:20px">
    <div class="an-section-title">At-Risk Partners <span class="badge" style="background:var(--red)">Churn</span></div>
    <div id="at-risk-list"></div>
  </div>
</div>

<script>
// Config
const API_BASE = '';
const AUTH_TOKEN = localStorage.getItem('pp_token') || 'promptpay-local';
const IS_PARTNER = new URLSearchParams(location.search).get('mode') === 'partner';
const PARTNER_ID = new URLSearchParams(location.search).get('partner') || '';

if (IS_PARTNER) {
  document.getElementById('an-role').textContent = 'PARTNER';
  document.querySelector('[onclick*="partners"]')?.remove();
  document.querySelector('[onclick*="cashflow"]')?.remove();
}

function apiGet(path) {
  const prefix = IS_PARTNER ? '/partner-admin/analytics' : '/super-analytics';
  const sep = path.includes('?') ? '&' : '?';
  const partnerQ = PARTNER_ID ? `${sep}partner=${PARTNER_ID}` : '';
  return fetch(`${API_BASE}${prefix}${path}${partnerQ}`, {
    headers: { Authorization: `Bearer ${AUTH_TOKEN}` }
  }).then(r => r.json()).catch(() => null);
}

// Tab switching
function switchAnTab(tab) {
  document.querySelectorAll('.an-tab').forEach(t => t.classList.remove('active'));
  document.querySelector(`.an-tab[onclick*="${tab}"]`)?.classList.add('active');
  ['overview','trends','forecast','insights','cashflow','partners'].forEach(t => {
    const el = document.getElementById('tab-' + t);
    if (el) el.style.display = t === tab ? '' : 'none';
  });
  if (tab === 'trends') loadTrends();
  if (tab === 'forecast') loadForecast();
  if (tab === 'insights') loadInsights();
  if (tab === 'cashflow') loadCashFlow();
  if (tab === 'partners') loadPartners();
}

// ═══ Sparkline SVG helper ═══
function sparklineSvg(points, color = '#7c3aed') {
  if (!points || points.length < 2) return '';
  const max = Math.max(...points, 1);
  const w = 100, h = 24;
  const coords = points.map((v, i) => `${(i / (points.length - 1)) * w},${h - (v / max) * h}`);
  return `<svg viewBox="0 0 ${w} ${h}" preserveAspectRatio="none">
    <polyline points="${coords.join(' ')}" fill="none" stroke="${color}" stroke-width="1.5" stroke-linecap="round"/>
  </svg>`;
}

// ═══ KPI Cards ═══
async function loadMetrics() {
  const data = await apiGet('/metrics');
  if (!data || !data.metrics) {
    document.getElementById('kpi-grid').innerHTML = '<div style="color:var(--text2);padding:20px">Unable to load metrics. Check authentication.</div>';
    return;
  }
  const m = data.metrics;
  const sp = data.sparklines || {};
  const cards = [
    { label: 'Total Volume', value: '$' + fmt(m.totalVolume), trend: m.growth30d, spark: sp.volume, color: '#7c3aed' },
    { label: 'Transactions', value: fmt(m.totalTransactions), trend: m.growth7d, spark: sp.transactions, color: '#3b82f6' },
    { label: 'Active Users', value: fmt(m.activeUsers), trend: null, spark: sp.users, color: '#22c55e' },
    { label: 'Revenue', value: '$' + fmt(m.totalRevenue), trend: m.growth30d, spark: sp.revenue, color: '#f59e0b' },
    { label: 'Avg Tx Size', value: '$' + m.avgTransactionSize.toFixed(2), trend: null, spark: null, color: '#8b5cf6' },
    { label: 'Growth 24h', value: m.growth24h + '%', trend: m.growth24h, spark: null, color: m.growth24h >= 0 ? '#22c55e' : '#ef4444' },
    { label: 'Growth 7d', value: m.growth7d + '%', trend: m.growth7d, spark: null, color: m.growth7d >= 0 ? '#22c55e' : '#ef4444' },
    { label: 'Partners', value: fmt(m.activePartners), trend: null, spark: null, color: '#06b6d4' },
  ];

  document.getElementById('kpi-grid').innerHTML = cards.map(c => `
    <div class="kpi-card">
      <div class="kpi-label">${c.label}</div>
      <div class="kpi-value">${c.value}</div>
      ${c.trend !== null ? `<div class="kpi-trend ${c.trend > 0 ? 'up' : c.trend < 0 ? 'down' : 'stable'}">
        ${c.trend > 0 ? '&#9650;' : c.trend < 0 ? '&#9660;' : '&#9644;'} ${Math.abs(c.trend)}%
      </div>` : ''}
      ${c.spark ? `<div class="kpi-sparkline">${sparklineSvg(c.spark, c.color)}</div>` : ''}
    </div>
  `).join('');
}

// ═══ Trends (simple line chart using canvas) ═══
let trendData = null;
async function loadTrends() {
  const agg = document.getElementById('trend-agg').value;
  const result = await apiGet(`/trends?agg=${agg}`);
  if (!result) return;
  trendData = result;
  renderTrendChart();
  renderUserChart();
}

function renderTrendChart() {
  if (!trendData) return;
  const metric = document.getElementById('trend-metric').value;
  const points = trendData.trends.map(t => t[metric]);
  const labels = trendData.trends.map(t => t.period);
  drawLineChart('trend-chart', labels, points, metric === 'revenue' ? '#f59e0b' : '#7c3aed');
}

function renderUserChart() {
  if (!trendData || !trendData.userGrowth) return;
  const points = trendData.userGrowth.map(t => t.users);
  const labels = trendData.userGrowth.map(t => t.period);
  drawLineChart('user-chart', labels, points, '#22c55e');
}

// ═══ Forecast ═══
async function loadForecast() {
  const days = document.getElementById('fc-horizon').value;
  const metric = document.getElementById('fc-metric').value;
  const result = await apiGet(`/forecast?days=${days}&metric=${metric}`);
  if (!result) return;

  const allPoints = [...result.historical, ...result.forecast];
  const labels = allPoints.map(p => p.period);
  const values = allPoints.map(p => p.value);
  const lowers = allPoints.map(p => p.lower);
  const uppers = allPoints.map(p => p.upper);
  const forecastStart = result.historical.length;

  drawForecastChart('forecast-chart', labels, values, lowers, uppers, forecastStart);

  document.getElementById('fc-meta').innerHTML = `
    <div class="forecast-pill">Method: <b>${result.method}</b></div>
    <div class="forecast-pill">Accuracy: <b>${result.accuracy}%</b></div>
    <div class="forecast-pill">Trend: <b style="color:${result.trend === 'up' ? 'var(--green)' : result.trend === 'down' ? 'var(--red)' : 'var(--text2)'}">${result.trend === 'up' ? '&#9650; Up' : result.trend === 'down' ? '&#9660; Down' : '&#9644; Stable'} (${result.growthRate}%)</b></div>
  `;
}

// ═══ Insights ═══
async function loadInsights() {
  const result = await apiGet('/insights');
  if (!result) return;

  document.getElementById('insights-summary').textContent = result.summary || 'No summary available.';

  if (!result.insights || result.insights.length === 0) {
    document.getElementById('insights-list').innerHTML = '<div style="color:var(--text2);padding:20px;text-align:center">All metrics normal. No anomalies detected.</div>';
    return;
  }

  document.getElementById('insights-list').innerHTML = result.insights.map(i => `
    <div class="insight-card">
      <div class="insight-icon ${i.type}">${i.type === 'warning' ? '&#9888;' : i.type === 'positive' ? '&#10003;' : '&#8505;'}</div>
      <div>
        <div class="insight-title">${i.title}</div>
        <div class="insight-desc">${i.description}</div>
        <div class="insight-meta">
          <span class="insight-confidence" style="background:${i.confidence > 75 ? 'rgba(34,197,94,.15);color:var(--green)' : 'rgba(245,158,11,.15);color:var(--yellow)'}">
            ${i.confidence}% confidence
          </span>
          &nbsp; Impact: <b>${i.impact_level}</b>
        </div>
      </div>
    </div>
  `).join('');
}

// ═══ Cash Flow ═══
async function loadCashFlow() {
  const result = await apiGet('/cash-flow?days=30');
  if (!result || !result.balanceProjection) return;

  const labels = result.balanceProjection.map(p => p.period);
  const inflow = result.balanceProjection.map(p => p.inflow);
  const outflow = result.balanceProjection.map(p => p.outflow);
  const balance = result.balanceProjection.map(p => p.balance);

  drawMultiLineChart('cf-chart', labels, [
    { data: inflow, color: '#22c55e', label: 'Inflow' },
    { data: outflow, color: '#ef4444', label: 'Outflow' },
    { data: balance, color: '#7c3aed', label: 'Balance' },
  ]);

  document.getElementById('cf-warning').style.display = result.lowLiquidityWarning ? '' : 'none';
}

// ═══ Partners ═══
async function loadPartners() {
  const sort = document.getElementById('partner-sort')?.value || 'volume';
  const result = await apiGet(`/partners?sort=${sort}`);
  if (!result) return;

  const tbody = document.getElementById('partner-tbody');
  tbody.innerHTML = (result.rankings || []).map((p, i) => `
    <tr>
      <td class="rank-num">${i + 1}</td>
      <td>${p.partnerName || p.partnerId}</td>
      <td>$${fmt(p.volume)}</td>
      <td>$${fmt(p.revenue)}</td>
      <td>${fmt(p.transactions)}</td>
    </tr>
  `).join('') || '<tr><td colspan="5" style="text-align:center;color:var(--text2)">No partner data yet</td></tr>';

  const atRiskEl = document.getElementById('at-risk-list');
  atRiskEl.innerHTML = (result.atRisk || []).map(p => `
    <div class="insight-card">
      <div class="insight-icon warning">&#9888;</div>
      <div>
        <div class="insight-title">${p.partnerName || p.partnerId}</div>
        <div class="insight-desc">Inactive — last activity unknown. Volume: $${fmt(p.volume)}, Revenue: $${fmt(p.revenue)}</div>
      </div>
    </div>
  `).join('') || '<div style="color:var(--text2);padding:12px">No at-risk partners detected.</div>';
}

// ═══ Canvas Charts ═══
function drawLineChart(canvasId, labels, data, color) {
  const canvas = document.getElementById(canvasId);
  if (!canvas) return;
  const ctx = canvas.getContext('2d');
  const dpr = window.devicePixelRatio || 1;
  const rect = canvas.parentElement.getBoundingClientRect();
  canvas.width = rect.width * dpr;
  canvas.height = (parseInt(canvas.getAttribute('height')) || 200) * dpr;
  canvas.style.width = rect.width + 'px';
  canvas.style.height = (parseInt(canvas.getAttribute('height')) || 200) + 'px';
  ctx.scale(dpr, dpr);

  const w = rect.width, h = parseInt(canvas.getAttribute('height')) || 200;
  const pad = { top: 20, right: 10, bottom: 30, left: 50 };
  const cw = w - pad.left - pad.right, ch = h - pad.top - pad.bottom;

  ctx.clearRect(0, 0, w, h);
  if (!data.length) return;

  const max = Math.max(...data, 1) * 1.1;
  const min = Math.min(...data, 0);
  const range = max - min || 1;

  // Grid
  ctx.strokeStyle = 'rgba(255,255,255,.05)';
  ctx.lineWidth = 1;
  for (let i = 0; i <= 4; i++) {
    const y = pad.top + ch - (i / 4) * ch;
    ctx.beginPath(); ctx.moveTo(pad.left, y); ctx.lineTo(w - pad.right, y); ctx.stroke();
    ctx.fillStyle = '#555'; ctx.font = '10px sans-serif'; ctx.textAlign = 'right';
    ctx.fillText(fmtShort(min + (range * i / 4)), pad.left - 4, y + 3);
  }

  // Line
  ctx.beginPath();
  ctx.strokeStyle = color;
  ctx.lineWidth = 2;
  ctx.lineJoin = 'round';
  data.forEach((v, i) => {
    const x = pad.left + (i / (data.length - 1)) * cw;
    const y = pad.top + ch - ((v - min) / range) * ch;
    if (i === 0) ctx.moveTo(x, y); else ctx.lineTo(x, y);
  });
  ctx.stroke();

  // Fill
  ctx.lineTo(pad.left + cw, pad.top + ch);
  ctx.lineTo(pad.left, pad.top + ch);
  ctx.closePath();
  const grad = ctx.createLinearGradient(0, pad.top, 0, pad.top + ch);
  grad.addColorStop(0, color + '30');
  grad.addColorStop(1, color + '05');
  ctx.fillStyle = grad;
  ctx.fill();
}

function drawForecastChart(canvasId, labels, values, lowers, uppers, fcStart) {
  const canvas = document.getElementById(canvasId);
  if (!canvas) return;
  const ctx = canvas.getContext('2d');
  const dpr = window.devicePixelRatio || 1;
  const rect = canvas.parentElement.getBoundingClientRect();
  canvas.width = rect.width * dpr;
  canvas.height = 280 * dpr;
  canvas.style.width = rect.width + 'px';
  canvas.style.height = '280px';
  ctx.scale(dpr, dpr);

  const w = rect.width, h = 280;
  const pad = { top: 20, right: 10, bottom: 30, left: 50 };
  const cw = w - pad.left - pad.right, ch = h - pad.top - pad.bottom;

  ctx.clearRect(0, 0, w, h);
  if (!values.length) return;

  const allVals = [...values, ...lowers, ...uppers];
  const max = Math.max(...allVals, 1) * 1.1;
  const min = Math.min(...allVals.filter(v => v >= 0), 0);
  const range = max - min || 1;

  const toX = i => pad.left + (i / (values.length - 1)) * cw;
  const toY = v => pad.top + ch - ((v - min) / range) * ch;

  // Grid
  ctx.strokeStyle = 'rgba(255,255,255,.05)'; ctx.lineWidth = 1;
  for (let i = 0; i <= 4; i++) {
    const y = pad.top + ch - (i / 4) * ch;
    ctx.beginPath(); ctx.moveTo(pad.left, y); ctx.lineTo(w - pad.right, y); ctx.stroke();
    ctx.fillStyle = '#555'; ctx.font = '10px sans-serif'; ctx.textAlign = 'right';
    ctx.fillText(fmtShort(min + (range * i / 4)), pad.left - 4, y + 3);
  }

  // Forecast divider
  if (fcStart > 0 && fcStart < values.length) {
    const fx = toX(fcStart);
    ctx.strokeStyle = 'rgba(124,58,237,.3)'; ctx.setLineDash([4, 4]);
    ctx.beginPath(); ctx.moveTo(fx, pad.top); ctx.lineTo(fx, pad.top + ch); ctx.stroke();
    ctx.setLineDash([]);
    ctx.fillStyle = '#7c3aed'; ctx.font = '10px sans-serif'; ctx.textAlign = 'center';
    ctx.fillText('Forecast →', fx + 30, pad.top + 10);
  }

  // Confidence band
  ctx.fillStyle = 'rgba(124,58,237,.1)';
  ctx.beginPath();
  for (let i = fcStart; i < values.length; i++) ctx.lineTo(toX(i), toY(uppers[i]));
  for (let i = values.length - 1; i >= fcStart; i--) ctx.lineTo(toX(i), toY(lowers[i]));
  ctx.closePath(); ctx.fill();

  // Historical line
  ctx.beginPath(); ctx.strokeStyle = '#7c3aed'; ctx.lineWidth = 2;
  for (let i = 0; i < fcStart; i++) {
    const x = toX(i), y = toY(values[i]);
    if (i === 0) ctx.moveTo(x, y); else ctx.lineTo(x, y);
  }
  ctx.stroke();

  // Forecast line
  ctx.beginPath(); ctx.strokeStyle = '#a78bfa'; ctx.lineWidth = 2; ctx.setLineDash([6, 3]);
  for (let i = Math.max(0, fcStart - 1); i < values.length; i++) {
    const x = toX(i), y = toY(values[i]);
    if (i === Math.max(0, fcStart - 1)) ctx.moveTo(x, y); else ctx.lineTo(x, y);
  }
  ctx.stroke(); ctx.setLineDash([]);
}

function drawMultiLineChart(canvasId, labels, series) {
  const canvas = document.getElementById(canvasId);
  if (!canvas) return;
  const ctx = canvas.getContext('2d');
  const dpr = window.devicePixelRatio || 1;
  const rect = canvas.parentElement.getBoundingClientRect();
  canvas.width = rect.width * dpr;
  canvas.height = 260 * dpr;
  canvas.style.width = rect.width + 'px';
  canvas.style.height = '260px';
  ctx.scale(dpr, dpr);

  const w = rect.width, h = 260;
  const pad = { top: 20, right: 10, bottom: 30, left: 50 };
  const cw = w - pad.left - pad.right, ch = h - pad.top - pad.bottom;

  ctx.clearRect(0, 0, w, h);
  const allVals = series.flatMap(s => s.data);
  const max = Math.max(...allVals, 1) * 1.1;
  const min = Math.min(...allVals, 0) * (Math.min(...allVals) < 0 ? 1.1 : 1);
  const range = max - min || 1;

  // Grid
  ctx.strokeStyle = 'rgba(255,255,255,.05)'; ctx.lineWidth = 1;
  for (let i = 0; i <= 4; i++) {
    const y = pad.top + ch - (i / 4) * ch;
    ctx.beginPath(); ctx.moveTo(pad.left, y); ctx.lineTo(w - pad.right, y); ctx.stroke();
    ctx.fillStyle = '#555'; ctx.font = '10px sans-serif'; ctx.textAlign = 'right';
    ctx.fillText(fmtShort(min + (range * i / 4)), pad.left - 4, y + 3);
  }

  // Lines
  for (const s of series) {
    ctx.beginPath(); ctx.strokeStyle = s.color; ctx.lineWidth = 2; ctx.lineJoin = 'round';
    s.data.forEach((v, i) => {
      const x = pad.left + (i / (s.data.length - 1)) * cw;
      const y = pad.top + ch - ((v - min) / range) * ch;
      if (i === 0) ctx.moveTo(x, y); else ctx.lineTo(x, y);
    });
    ctx.stroke();
  }
}

// Formatters
function fmt(n) { return typeof n === 'number' ? n.toLocaleString('en-US', { maximumFractionDigits: 2 }) : n; }
function fmtShort(n) {
  if (n >= 1e6) return (n / 1e6).toFixed(1) + 'M';
  if (n >= 1e3) return (n / 1e3).toFixed(1) + 'K';
  return n.toFixed(0);
}

// Init
loadMetrics();
</script>
</body>
</html>

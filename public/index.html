<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
  <meta name="theme-color" content="#0d1117">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="apple-mobile-web-app-title" content="PromptPay">

  <!-- SEO -->
  <title>PromptPay — AI-Powered Payments, Calls & Chat</title>
  <meta name="description" content="PromptPay is your AI-powered fintech platform. Send money, make international calls, buy virtual numbers, send SMS, shop, and chat — all with AI agents.">
  <meta name="keywords" content="PromptPay, AI payments, international calling, virtual numbers, SMS, digital wallet, fintech, AI chat, money transfer, airtime, POS agent">
  <meta name="author" content="PromptPay Inc.">
  <meta name="robots" content="index, follow">
  <link rel="canonical" href="https://www.upromptpay.com/">

  <!-- Open Graph -->
  <meta property="og:type" content="website">
  <meta property="og:url" content="https://www.upromptpay.com/">
  <meta property="og:title" content="PromptPay — AI Life Assistant">
  <meta property="og:description" content="AI-powered payments, international calls, virtual numbers, SMS, and money transfers. Your all-in-one fintech platform.">
  <meta property="og:image" content="https://www.upromptpay.com/icons/icon-512.png">
  <meta property="og:site_name" content="PromptPay">

  <!-- Twitter Card -->
  <meta name="twitter:card" content="summary_large_image">
  <meta name="twitter:title" content="PromptPay — AI Life Assistant">
  <meta name="twitter:description" content="AI-powered payments, international calls, virtual numbers, SMS, and money transfers.">
  <meta name="twitter:image" content="https://www.upromptpay.com/icons/icon-512.png">

  <!-- Structured Data -->
  <script type="application/ld+json">
  {
    "@context": "https://schema.org",
    "@type": "SoftwareApplication",
    "name": "PromptPay",
    "applicationCategory": "FinanceApplication",
    "operatingSystem": "Web",
    "description": "AI-powered digital payments platform. Send money, pay bills, and manage finances using natural language commands.",
    "url": "https://www.upromptpay.com",
    "offers": {
      "@type": "Offer",
      "price": "0",
      "priceCurrency": "USD"
    }
  }
  </script>

  <!-- Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=G-716753GHP9"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());
    gtag('config', 'G-716753GHP9');
  </script>

  <link rel="manifest" href="/manifest.json">
  <link rel="icon" type="image/png" href="/icons/icon-192.png">
  <link rel="apple-touch-icon" href="/icons/icon-192.png">
  <script src="https://js.stripe.com/v3/"></script>
  <script src="https://js.paystack.co/v2/inline.js"></script>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&family=JetBrains+Mono:wght@400;500;600&family=Space+Grotesk:wght@500;700&display=swap" rel="stylesheet">
  <style>
    :root {
      --bg: #06060a;
      --bg2: #0c0c14;
      --surface: rgba(255,255,255,0.03);
      --surface-hover: rgba(255,255,255,0.06);
      --glass: rgba(255,255,255,0.04);
      --glass-border: rgba(255,255,255,0.07);
      --text: #f0f2f5;
      --text2: #8b92a5;
      --text3: #6b7280;
      --accent: #7c3aed;
      --accent2: #a78bfa;
      --blue: #3b82f6;
      --cyan: #06b6d4;
      --green: #10b981;
      --emerald: #34d399;
      --yellow: #f59e0b;
      --orange: #f97316;
      --red: #ef4444;
      --pink: #ec4899;
      --gradient: linear-gradient(135deg, #7c3aed, #3b82f6, #06b6d4);
      --gradient2: linear-gradient(135deg, #7c3aed 0%, #2563eb 50%, #06b6d4 100%);
      --shadow: 0 8px 32px rgba(0,0,0,0.4);
      --shadow-lg: 0 20px 60px rgba(0,0,0,0.5);
      --radius: 16px;
      --radius-sm: 12px;
      --radius-xs: 8px;
      --safe-bottom: env(safe-area-inset-bottom, 0px);
      --safe-left: env(safe-area-inset-left, 0px);
      --safe-right: env(safe-area-inset-right, 0px);
      --safe-top: env(safe-area-inset-top, 0px);
    }
    * { margin: 0; padding: 0; box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
    html, body {
      height: 100%;
      font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'SF Pro Display', sans-serif;
      background: var(--bg); color: var(--text);
      -webkit-font-smoothing: antialiased;
      -webkit-text-size-adjust: 100%;
    }
    body.app-mode { overflow: hidden; }
    body.landing-mode { overflow-x: hidden; overflow-y: auto; }

    /* ── App Shell ── */
    .app {
      width: 100%; max-width: 100vw; margin: 0 auto; height: 100vh; height: 100dvh;
      position: relative; overflow: hidden;
      display: flex; flex-direction: column;
      background: var(--bg);
      padding-left: var(--safe-left);
      padding-right: var(--safe-right);
    }
    @media (min-width: 768px) {
      .app { max-width: 480px; }
    }
    .app::before {
      content: ''; position: fixed; inset: 0;
      background: radial-gradient(ellipse at 30% 20%, rgba(124,58,237,0.06) 0%, transparent 50%),
                  radial-gradient(ellipse at 70% 80%, rgba(59,130,246,0.04) 0%, transparent 50%),
                  radial-gradient(ellipse at 50% 50%, rgba(6,182,212,0.03) 0%, transparent 50%);
      pointer-events: none; z-index: 0;
      animation: ambientDrift 20s ease-in-out infinite alternate;
    }
    @keyframes ambientDrift {
      0% { transform: translate(0, 0) rotate(0deg); }
      100% { transform: translate(-2%, 2%) rotate(3deg); }
    }
    @media (prefers-reduced-motion: reduce) {
      .app::before, .ai-avatar, .nav-ai, .balance-card, .payment-card,
      .lp-agent-body, .lp-agent-eyeball, .fade-up { animation: none !important; transition: none !important; }
    }

    /* ── Header ── */
    .header {
      position: relative; z-index: 10; flex-shrink: 0;
      padding: 12px 16px; display: flex; align-items: center; justify-content: space-between;
      padding-top: max(12px, var(--safe-top));
    }
    .header-left { display: flex; align-items: center; gap: 12px; }
    .header-avatar {
      width: 36px; height: 36px; border-radius: 50%;
      background: var(--gradient); display: flex; align-items: center; justify-content: center;
      font-size: 14px; font-weight: 700; color: white;
      box-shadow: 0 0 0 2px var(--bg), 0 0 0 3px rgba(124,58,237,0.3);
    }
    .header-greeting { font-size: 13px; color: var(--text2); }
    .header-name { font-size: 16px; font-weight: 600; line-height: 1.2; }
    .header-right { display: flex; gap: 8px; }
    .header-btn {
      width: 38px; height: 38px; border-radius: 50%;
      background: var(--surface); border: 1px solid var(--glass-border);
      display: flex; align-items: center; justify-content: center;
      cursor: pointer; transition: all 0.2s; color: var(--text2); font-size: 16px;
    }
    .header-btn:active { transform: scale(0.92); background: var(--surface-hover); }
    .header-btn .dot {
      position: absolute; top: 8px; right: 8px; width: 7px; height: 7px;
      background: var(--accent); border-radius: 50%; border: 1.5px solid var(--bg);
    }

    /* ── Pages Container ── */
    .pages {
      flex: 1; position: relative; overflow: hidden; z-index: 1;
      min-height: 0;
    }
    .page {
      position: absolute; top: 0; left: 0; right: 0; bottom: 0;
      overflow-y: auto; overflow-x: hidden;
      padding: 0 16px 100px;
      scrollbar-width: none;
      -webkit-overflow-scrolling: touch;
      opacity: 0; pointer-events: none;
      transition: opacity 0.3s ease;
      will-change: opacity;
    }
    @media (min-width: 400px) {
      .page { padding-left: 20px; padding-right: 20px; }
    }
    .page::-webkit-scrollbar { display: none; }
    .page.active {
      opacity: 1; pointer-events: auto;
    }

    /* ── Balance Card ── */
    .balance-card {
      position: relative; border-radius: 24px; padding: 28px 24px;
      margin-bottom: 24px; overflow: hidden;
      background: linear-gradient(145deg, rgba(124,58,237,0.15), rgba(59,130,246,0.1), rgba(6,182,212,0.08));
      border: 1px solid rgba(255,255,255,0.08);
      backdrop-filter: blur(40px); -webkit-backdrop-filter: blur(40px);
    }
    .balance-card::before {
      content: ''; position: absolute; top: -50%; right: -20%; width: 200px; height: 200px;
      background: radial-gradient(circle, rgba(124,58,237,0.2), transparent 70%);
      filter: blur(40px); pointer-events: none;
    }
    .balance-card::after {
      content: ''; position: absolute; bottom: -30%; left: -10%; width: 160px; height: 160px;
      background: radial-gradient(circle, rgba(6,182,212,0.15), transparent 70%);
      filter: blur(40px); pointer-events: none;
    }
    .balance-label { font-size: 13px; color: var(--text2); margin-bottom: 6px; position: relative; z-index: 1; }
    .balance-amount {
      font-size: clamp(32px, 9vw, 42px); font-weight: 800; letter-spacing: -1.5px;
      position: relative; z-index: 1; line-height: 1.1; margin-bottom: 4px;
      background: linear-gradient(to right, #fff, rgba(255,255,255,0.85));
      -webkit-background-clip: text; -webkit-text-fill-color: transparent;
    }
    .balance-change {
      font-size: 13px; color: var(--emerald); position: relative; z-index: 1;
      display: flex; align-items: center; gap: 4px;
    }
    .balance-actions {
      display: flex; gap: 10px; margin-top: 24px; position: relative; z-index: 1;
    }
    .bal-btn {
      flex: 1; padding: 13px; border-radius: var(--radius-sm); border: none;
      font-size: 14px; font-weight: 600; cursor: pointer; display: flex;
      align-items: center; justify-content: center; gap: 8px;
      transition: all 0.2s; font-family: inherit;
      min-width: 0;
    }
    .bal-btn:active { transform: scale(0.96); }
    .bal-btn-primary {
      background: var(--gradient2); color: white;
      box-shadow: 0 4px 20px rgba(124,58,237,0.3);
    }
    .bal-btn-secondary {
      background: rgba(255,255,255,0.08); color: var(--text);
      border: 1px solid rgba(255,255,255,0.1);
    }

    /* ── Quick Actions Grid ── */
    .quick-grid {
      display: grid; grid-template-columns: repeat(4, 1fr); gap: 14px 10px;
      margin-bottom: 28px;
    }
    .quick-item {
      display: flex; flex-direction: column; align-items: center; gap: 8px;
      cursor: pointer; transition: transform 0.2s;
      -webkit-tap-highlight-color: transparent;
    }
    .quick-item:active { transform: scale(0.92); }
    .quick-icon {
      width: 54px; height: 54px; border-radius: 16px;
      display: flex; align-items: center; justify-content: center;
      font-size: 22px; transition: all 0.2s;
      border: 1px solid rgba(255,255,255,0.06);
    }
    .quick-label { font-size: 11px; color: var(--text2); font-weight: 500; text-align: center; }
    .qi-violet { background: rgba(124,58,237,0.12); }
    .qi-blue { background: rgba(59,130,246,0.12); }
    .qi-cyan { background: rgba(6,182,212,0.12); }
    .qi-green { background: rgba(16,185,129,0.12); }
    .qi-pink { background: rgba(236,72,153,0.12); }
    .qi-orange { background: rgba(249,115,22,0.12); }
    .qi-yellow { background: rgba(245,158,11,0.12); }
    .qi-red { background: rgba(239,68,68,0.12); }

    /* ── Section Headers ── */
    .section-header {
      display: flex; justify-content: space-between; align-items: center;
      margin-bottom: 14px;
    }
    .section-title { font-size: 17px; font-weight: 700; }
    .section-link { font-size: 13px; color: var(--accent2); cursor: pointer; font-weight: 500; }

    /* ── AI Agent Card ── */
    .ai-card {
      background: var(--surface); border: 1px solid var(--glass-border);
      border-radius: var(--radius); padding: 18px; margin-bottom: 24px;
      cursor: pointer; transition: all 0.2s; position: relative; overflow: hidden;
    }
    .ai-card:active { transform: scale(0.98); }
    .ai-card::before {
      content: ''; position: absolute; top: 0; left: 0; right: 0; height: 2px;
      background: var(--gradient2);
    }
    .ai-card-header {
      display: flex; align-items: center; gap: 12px; margin-bottom: 12px;
    }
    .ai-avatar {
      width: 40px; height: 40px; border-radius: 12px;
      background: var(--gradient2); display: flex; align-items: center; justify-content: center;
      font-size: 20px;
    }
    .ai-name { font-size: 14px; font-weight: 600; }
    .ai-status { font-size: 11px; color: var(--emerald); display: flex; align-items: center; gap: 4px; }
    .ai-status::before {
      content: ''; width: 6px; height: 6px; background: var(--emerald);
      border-radius: 50%; animation: pulse 2s ease infinite;
    }
    @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.4; } }
    .ai-suggestion {
      background: rgba(124,58,237,0.08); border-radius: var(--radius-xs);
      padding: 10px 14px; font-size: 13px; color: var(--text2);
      border: 1px solid rgba(124,58,237,0.12);
    }

    /* ── Transaction List ── */
    .tx-list { display: flex; flex-direction: column; gap: 2px; }
    .tx-item {
      display: flex; align-items: center; gap: 14px; padding: 14px 0;
      border-bottom: 1px solid rgba(255,255,255,0.04); cursor: pointer;
      transition: background 0.15s;
    }
    .tx-item:last-child { border-bottom: none; }
    .tx-icon {
      width: 44px; height: 44px; border-radius: 14px;
      display: flex; align-items: center; justify-content: center; font-size: 18px;
      flex-shrink: 0;
    }
    .tx-info { flex: 1; min-width: 0; }
    .tx-name { font-size: 14px; font-weight: 500; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
    .tx-desc { font-size: 12px; color: var(--text2); margin-top: 2px; }
    .tx-amount { text-align: right; }
    .tx-value { font-size: 14px; font-weight: 600; }
    .tx-time { font-size: 11px; color: var(--text3); margin-top: 2px; }
    .tx-positive { color: var(--emerald); }
    .tx-negative { color: var(--text); }

    /* ── AI Chat Page ── */
    #page-ai { padding: 0; overflow: hidden; }
    .chat-container {
      display: flex; flex-direction: column; height: 100%;
      position: relative; padding: 0 12px;
      overflow: hidden; box-sizing: border-box;
    }
    @media (min-width: 380px) {
      .chat-container { padding: 0 16px; }
    }
    .chat-header-bar {
      display: flex; align-items: center; gap: 12px; padding: 8px 0 12px;
      border-bottom: 1px solid rgba(255,255,255,0.05); margin-bottom: 8px;
      flex-shrink: 0;
    }
    .chat-messages {
      flex: 1; overflow-y: auto; overflow-x: hidden;
      display: flex; flex-direction: column; gap: 12px;
      padding-bottom: 90px; scrollbar-width: none;
      -webkit-overflow-scrolling: touch;
      min-height: 0;
    }
    .chat-messages::-webkit-scrollbar { display: none; }
    .msg {
      max-width: 88%; padding: 12px 14px; font-size: 14px; line-height: 1.5;
      animation: msgIn 0.3s ease; word-break: break-word;
      overflow-wrap: break-word; box-sizing: border-box;
    }
    @keyframes msgIn {
      from { opacity: 0; transform: translateY(8px); }
      to { opacity: 1; transform: translateY(0); }
    }
    .msg-ai {
      align-self: flex-start; background: var(--surface);
      border: 1px solid var(--glass-border);
      border-radius: 4px 18px 18px 18px; color: var(--text);
    }
    .msg-user {
      align-self: flex-end;
      background: var(--gradient2);
      border-radius: 18px 4px 18px 18px; color: white;
    }
    .msg-typing {
      align-self: flex-start; background: var(--surface);
      border: 1px solid var(--glass-border);
      border-radius: 4px 18px 18px 18px; padding: 14px 20px;
      display: flex; gap: 5px; align-items: center;
    }
    .typing-dot {
      width: 7px; height: 7px; background: var(--text2); border-radius: 50%;
      animation: typingBounce 1.4s ease-in-out infinite;
    }
    .typing-dot:nth-child(2) { animation-delay: 0.2s; }
    .typing-dot:nth-child(3) { animation-delay: 0.4s; }
    @keyframes typingBounce {
      0%, 60%, 100% { transform: translateY(0); opacity: 0.4; }
      30% { transform: translateY(-6px); opacity: 1; }
    }
    .chat-input-area {
      position: absolute; bottom: 0; left: 0; right: 0;
      background: linear-gradient(to top, var(--bg) 70%, transparent);
      padding: 12px 12px 8px;
      box-sizing: border-box;
    }
    @media (min-width: 380px) {
      .chat-input-area { padding: 12px 16px 8px; }
    }
    .chat-input-wrap {
      display: flex; align-items: center; gap: 8px;
      background: var(--surface); border: 1px solid var(--glass-border);
      border-radius: 28px; padding: 6px 6px 6px 14px;
      box-sizing: border-box;
    }
    .chat-input {
      flex: 1; min-width: 0; border: none; background: none; color: var(--text);
      font-size: 14px; font-family: inherit; outline: none;
    }
    .chat-input::placeholder { color: var(--text3); }
    .chat-send-btn {
      width: 40px; height: 40px; border-radius: 50%; flex-shrink: 0;
      background: var(--gradient2); border: none; cursor: pointer;
      display: flex; align-items: center; justify-content: center;
      color: white; font-size: 16px; transition: all 0.2s; flex-shrink: 0;
    }
    .chat-send-btn:active { transform: scale(0.9); }
    .chat-send-btn:disabled { opacity: 0.4; }
    .chat-suggestions {
      display: flex; gap: 6px; flex-wrap: wrap; margin-bottom: 12px;
      overflow-x: auto; scrollbar-width: none; -webkit-overflow-scrolling: touch;
    }
    .chat-suggestions::-webkit-scrollbar { display: none; }
    .chat-suggestion {
      padding: 7px 12px; border-radius: 20px; font-size: 12px;
      background: rgba(124,58,237,0.08); border: 1px solid rgba(124,58,237,0.15);
      color: var(--accent2); cursor: pointer; transition: all 0.15s;
      white-space: nowrap; flex-shrink: 0;
    }
    .chat-suggestion:active { transform: scale(0.95); background: rgba(124,58,237,0.15); }

    /* ── Wallet Page ── */
    .card-carousel {
      display: flex; gap: 14px; overflow-x: auto; padding-bottom: 16px;
      scrollbar-width: none; scroll-snap-type: x mandatory;
      margin-bottom: 24px;
      -webkit-overflow-scrolling: touch;
    }
    .card-carousel::-webkit-scrollbar { display: none; }
    .payment-card {
      min-width: 280px; flex-shrink: 0; padding: 24px; border-radius: 20px;
      position: relative; overflow: hidden; scroll-snap-align: start;
      border: 1px solid rgba(255,255,255,0.08);
    }
    .payment-card.pc-violet {
      background: linear-gradient(145deg, rgba(124,58,237,0.25), rgba(59,130,246,0.15));
    }
    .payment-card.pc-blue {
      background: linear-gradient(145deg, rgba(59,130,246,0.25), rgba(6,182,212,0.15));
    }
    .payment-card.pc-green {
      background: linear-gradient(145deg, rgba(16,185,129,0.25), rgba(6,182,212,0.15));
    }
    .pc-brand { font-size: 12px; font-weight: 600; color: var(--text2); letter-spacing: 1px; text-transform: uppercase; }
    .pc-number { font-size: 18px; font-weight: 500; letter-spacing: 3px; margin: 20px 0; color: var(--text); }
    .pc-row { display: flex; justify-content: space-between; }
    .pc-label { font-size: 10px; color: var(--text3); text-transform: uppercase; }
    .pc-val { font-size: 13px; font-weight: 500; margin-top: 2px; }

    /* ── Savings Goals ── */
    .goal-card {
      background: var(--surface); border: 1px solid var(--glass-border);
      border-radius: var(--radius); padding: 18px; margin-bottom: 12px;
    }
    .goal-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; }
    .goal-name { font-size: 14px; font-weight: 600; }
    .goal-amount { font-size: 13px; color: var(--accent2); font-weight: 600; }
    .goal-bar {
      height: 6px; background: rgba(255,255,255,0.06); border-radius: 3px;
      overflow: hidden; margin-top: 8px;
    }
    .goal-fill { height: 100%; border-radius: 3px; transition: width 0.8s ease; }

    /* ── Stats/Streak Card ── */
    .streak-card {
      background: var(--surface); border: 1px solid var(--glass-border);
      border-radius: var(--radius); padding: 20px; margin-bottom: 16px;
      display: flex; align-items: center; gap: 16px;
    }
    .streak-fire { font-size: 36px; line-height: 1; }
    .streak-count { font-size: 28px; font-weight: 800; }
    .streak-label { font-size: 12px; color: var(--text2); }
    .streak-multiplier {
      margin-left: auto; padding: 6px 14px; border-radius: 20px;
      background: rgba(245,158,11,0.12); color: var(--yellow);
      font-size: 14px; font-weight: 700;
    }

    /* ── Loyalty Tier ── */
    .tier-card {
      background: var(--surface); border: 1px solid var(--glass-border);
      border-radius: var(--radius); padding: 20px; margin-bottom: 16px;
      position: relative; overflow: hidden;
    }
    .tier-card::before {
      content: ''; position: absolute; top: 0; left: 0; right: 0; height: 3px;
    }
    .tier-bronze::before { background: linear-gradient(to right, #b87333, #d4a76a); }
    .tier-silver::before { background: linear-gradient(to right, #94a3b8, #cbd5e1); }
    .tier-gold::before { background: linear-gradient(to right, #f59e0b, #fbbf24); }
    .tier-platinum::before { background: linear-gradient(to right, #7c3aed, #a78bfa); }
    .tier-info { display: flex; justify-content: space-between; align-items: center; }
    .tier-name { font-size: 18px; font-weight: 700; text-transform: uppercase; letter-spacing: 2px; }
    .tier-points { font-size: 13px; color: var(--text2); }
    .tier-progress { margin-top: 14px; }
    .tier-bar { height: 4px; background: rgba(255,255,255,0.06); border-radius: 2px; overflow: hidden; }
    .tier-fill { height: 100%; border-radius: 2px; }
    .tier-next { font-size: 11px; color: var(--text3); margin-top: 6px; text-align: right; }

    /* ── Achievement Badges ── */
    .achievements-grid {
      display: grid; grid-template-columns: repeat(3, 1fr); gap: 12px;
    }
    .achievement {
      background: var(--surface); border: 1px solid var(--glass-border);
      border-radius: var(--radius-sm); padding: 16px; text-align: center;
      transition: transform 0.2s;
    }
    .achievement:active { transform: scale(0.95); }
    .achievement.locked { opacity: 0.4; }
    .ach-icon { font-size: 28px; margin-bottom: 8px; }
    .ach-name { font-size: 11px; font-weight: 600; }
    .ach-pts { font-size: 10px; color: var(--accent2); margin-top: 4px; }

    /* ── PWA Install Banner ── */
    .pwa-install-banner {
      display: none;
      position: fixed;
      bottom: 80px;
      left: 12px;
      right: 12px;
      z-index: 9999;
      background: linear-gradient(135deg, #7c3aed 0%, #6c5ce7 50%, #5b4cdb 100%);
      border-radius: 16px;
      padding: 16px;
      box-shadow: 0 8px 32px rgba(124,58,237,0.4), 0 0 0 1px rgba(255,255,255,0.1);
      animation: pwa-slide-up 0.4s ease-out;
    }
    .pwa-install-banner.show { display: block; }
    @keyframes pwa-spin {
      to { transform: rotate(360deg); }
    }
    @keyframes pwa-slide-up {
      from { transform: translateY(100px); opacity: 0; }
      to { transform: translateY(0); opacity: 1; }
    }
    .pwa-banner-content {
      display: flex;
      align-items: center;
      gap: 12px;
    }
    .pwa-banner-icon {
      width: 48px;
      height: 48px;
      border-radius: 12px;
      background: rgba(255,255,255,0.15);
      display: flex;
      align-items: center;
      justify-content: center;
      flex-shrink: 0;
    }
    .pwa-banner-icon img {
      width: 32px;
      height: 32px;
      border-radius: 6px;
    }
    .pwa-banner-text {
      flex: 1;
    }
    .pwa-banner-title {
      font-size: 15px;
      font-weight: 700;
      color: #fff;
      margin-bottom: 2px;
    }
    .pwa-banner-desc {
      font-size: 12px;
      color: rgba(255,255,255,0.8);
      line-height: 1.3;
    }
    .pwa-banner-actions {
      display: flex;
      gap: 8px;
      margin-top: 12px;
    }
    .pwa-banner-install {
      flex: 1;
      padding: 10px 16px;
      border: none;
      border-radius: 10px;
      background: #fff;
      color: #7c3aed;
      font-size: 14px;
      font-weight: 700;
      cursor: pointer;
      transition: transform 0.15s;
    }
    .pwa-banner-install:active { transform: scale(0.97); }
    .pwa-banner-dismiss {
      padding: 10px 16px;
      border: 1px solid rgba(255,255,255,0.3);
      border-radius: 10px;
      background: transparent;
      color: rgba(255,255,255,0.9);
      font-size: 13px;
      font-weight: 500;
      cursor: pointer;
    }
    .pwa-banner-close {
      position: absolute;
      top: 8px;
      right: 8px;
      width: 24px;
      height: 24px;
      border: none;
      background: rgba(255,255,255,0.15);
      border-radius: 50%;
      color: #fff;
      font-size: 14px;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    /* ── Bottom Navigation ── */
    .bottom-nav {
      position: relative; z-index: 20; flex-shrink: 0;
      display: flex; justify-content: space-around; align-items: center;
      padding: 8px 12px;
      padding-bottom: max(8px, var(--safe-bottom));
      background: rgba(6,6,10,0.95);
      backdrop-filter: blur(20px); -webkit-backdrop-filter: blur(20px);
      border-top: 1px solid rgba(255,255,255,0.05);
    }
    .nav-item {
      display: flex; flex-direction: column; align-items: center; gap: 3px;
      padding: 6px 16px; cursor: pointer; transition: all 0.2s;
      border-radius: 12px; position: relative;
      -webkit-tap-highlight-color: transparent;
    }
    .nav-item:active { transform: scale(0.9); }
    .nav-icon { font-size: 20px; transition: all 0.2s; opacity: 0.5; }
    .nav-label { font-size: 10px; color: var(--text2); font-weight: 500; transition: color 0.2s; }
    .nav-item.active .nav-icon { opacity: 1; }
    .nav-item.active .nav-label { color: var(--accent2); }
    .nav-item.active::after {
      content: ''; position: absolute; top: -8px; width: 24px; height: 3px;
      background: var(--gradient2); border-radius: 3px;
      transition: width 0.2s;
    }
    .nav-ai {
      background: var(--gradient2); width: 52px; height: 52px;
      border-radius: 50%; display: flex; align-items: center; justify-content: center;
      margin-top: -20px; box-shadow: 0 4px 20px rgba(124,58,237,0.4);
    }
    .nav-ai .nav-icon { opacity: 1; color: white; font-size: 22px; }
    .nav-ai .nav-label { display: none; }

    /* ── Utility ── */
    .fade-up { animation: fadeUp 0.4s ease both; }
    @keyframes fadeUp {
      from { opacity: 0; transform: translateY(16px); }
      to { opacity: 1; transform: translateY(0); }
    }
    .shimmer {
      background: linear-gradient(90deg, transparent, rgba(255,255,255,0.04), transparent);
      background-size: 200% 100%;
      animation: shimmer 2s infinite;
    }
    @keyframes shimmer { 0% { background-position: 200% 0; } 100% { background-position: -200% 0; } }

    /* ── Modal Overlay ── */
    .modal-overlay {
      position: fixed; inset: 0; background: rgba(0,0,0,0.5);
      backdrop-filter: blur(6px); -webkit-backdrop-filter: blur(6px); z-index: 100;
      display: flex; align-items: flex-end; justify-content: center;
      opacity: 0; pointer-events: none; transition: opacity 0.3s;
    }
    .modal-overlay.active { opacity: 1; pointer-events: auto; }
    .modal-sheet {
      background: var(--bg2); border-radius: 24px 24px 0 0;
      width: 100%; max-width: 480px; max-height: 85vh; overflow-y: auto;
      padding: 20px; padding-bottom: max(20px, var(--safe-bottom));
      transform: translateY(100%); transition: transform 0.35s cubic-bezier(0.32, 0.72, 0, 1);
      -webkit-overflow-scrolling: touch;
      overscroll-behavior-y: contain;
    }
    .modal-overlay.active .modal-sheet { transform: translateY(0); }
    .modal-handle {
      width: 40px; height: 5px; background: rgba(255,255,255,0.2);
      border-radius: 3px; margin: 0 auto 16px; cursor: grab;
    }

    /* ── Premium Popup ── */
    .premium-popup-overlay {
      position: fixed; inset: 0; background: rgba(0,0,0,0.6);
      backdrop-filter: blur(12px); -webkit-backdrop-filter: blur(12px);
      z-index: 200; display: flex; align-items: center; justify-content: center;
      opacity: 0; pointer-events: none; transition: opacity 0.3s;
    }
    .premium-popup-overlay.active { opacity: 1; pointer-events: auto; }
    .premium-popup {
      background: linear-gradient(145deg, rgba(15,15,25,0.98), rgba(12,12,20,0.95));
      border: 1px solid rgba(124,58,237,0.25); border-radius: 24px;
      padding: 32px 28px; width: 90%; max-width: 360px; text-align: center;
      transform: scale(0.9); transition: transform 0.3s ease;
      box-shadow: 0 20px 60px rgba(0,0,0,0.5), 0 0 40px rgba(124,58,237,0.1);
    }
    .premium-popup-overlay.active .premium-popup { transform: scale(1); }

    /* ═══ Holographic Wallet Cards ═══ */
    .wallet-holo-card {
      min-width: 300px; aspect-ratio: 1.586; border-radius: 20px;
      padding: 28px; position: relative; overflow: hidden; flex-shrink: 0;
      border: 1px solid rgba(255,255,255,0.08);
      box-shadow: 0 16px 48px rgba(0,0,0,0.4);
      transition: transform 0.3s ease, box-shadow 0.3s ease;
      cursor: default;
    }
    .wallet-holo-card:hover {
      transform: translateY(-6px);
      box-shadow: 0 24px 64px rgba(0,0,0,0.6);
    }
    .wallet-holo-card .holo-glint {
      position: absolute; top: 0; left: -50%; width: 50%; height: 200%;
      background: linear-gradient(90deg, transparent, rgba(255,255,255,0.07), transparent);
      animation: cardGlint 4s ease-in-out infinite; pointer-events: none;
    }
    .wallet-holo-card .holo-chip {
      width: 36px; height: 28px; border-radius: 6px;
      background: linear-gradient(135deg, #d4a853, #f0d78c, #d4a853);
      position: absolute; top: 28px; left: 28px;
      box-shadow: inset 0 1px 2px rgba(0,0,0,0.2);
    }
    .wallet-holo-card .holo-chip::after {
      content: ''; position: absolute; top: 6px; left: 6px;
      width: 24px; height: 16px; border: 1px solid rgba(180,150,80,0.4);
      border-radius: 3px;
    }
    .wallet-holo-card .holo-brand {
      position: absolute; top: 24px; right: 28px;
      font-weight: 700; font-size: 16px; text-transform: uppercase;
      letter-spacing: 2px; opacity: 0.8;
    }
    .wallet-holo-card .holo-number {
      font-family: 'JetBrains Mono', monospace; font-size: 17px;
      letter-spacing: 3px; color: rgba(255,255,255,0.75);
      position: absolute; bottom: 80px; left: 28px;
    }
    .wallet-holo-card .holo-footer {
      position: absolute; bottom: 24px; left: 28px; right: 28px;
      display: flex; justify-content: space-between; align-items: flex-end;
    }
    .wallet-holo-card .holo-label {
      font-size: 9px; text-transform: uppercase; letter-spacing: 2px;
      color: rgba(255,255,255,0.35); margin-bottom: 3px;
    }
    .wallet-holo-card .holo-value {
      font-size: 13px; color: rgba(255,255,255,0.85); font-weight: 500;
    }
    .wallet-holo-card .holo-branding {
      font-size: 10px; letter-spacing: 1px; opacity: 0.3; font-weight: 600;
    }
    .wallet-holo-card .holo-remove {
      position: absolute; top: 12px; right: 12px; background: rgba(0,0,0,0.3);
      border: none; color: rgba(255,255,255,0.5); cursor: pointer;
      width: 24px; height: 24px; border-radius: 50%; font-size: 13px;
      display: flex; align-items: center; justify-content: center;
      opacity: 0; transition: opacity 0.2s;
    }
    .wallet-holo-card:hover .holo-remove { opacity: 1; }
    .wallet-holo-card .holo-remove:hover { background: rgba(239,68,68,0.5); color: #fff; }

    /* Brand color themes */
    .brand-visa {
      background: linear-gradient(135deg, #1a1f71 0%, #0d1252 50%, #1a1f71 100%);
    }
    .brand-mastercard {
      background: linear-gradient(135deg, #eb001b 0%, #c7000f 40%, #f79e1b 100%);
    }
    .brand-amex {
      background: linear-gradient(135deg, #006fcf 0%, #004a8f 50%, #006fcf 100%);
    }
    .brand-discover {
      background: linear-gradient(135deg, #ff6000 0%, #c44b00 50%, #ff6000 100%);
    }
    .brand-default {
      background: linear-gradient(135deg, #0a0a1a 0%, #1a1040 50%, #0a0a1a 100%);
    }

    /* ═══ Reward Card ═══ */
    .wallet-reward-card {
      min-width: 300px; aspect-ratio: 1.586; border-radius: 20px;
      padding: 28px; position: relative; overflow: hidden; flex-shrink: 0;
      background: linear-gradient(135deg, #92400e 0%, #f59e0b 50%, #b45309 100%);
      border: 1px solid rgba(251,191,36,0.3);
      box-shadow: 0 16px 48px rgba(245,158,11,0.15), 0 0 30px rgba(245,158,11,0.08);
      transition: transform 0.3s ease, box-shadow 0.3s ease;
      cursor: default;
    }
    .wallet-reward-card:hover {
      transform: translateY(-6px);
      box-shadow: 0 24px 64px rgba(245,158,11,0.25), 0 0 40px rgba(245,158,11,0.12);
    }
    .wallet-reward-card .reward-glint {
      position: absolute; top: 0; left: -50%; width: 50%; height: 200%;
      background: linear-gradient(90deg, transparent, rgba(255,255,255,0.12), transparent);
      animation: cardGlint 4s ease-in-out infinite; pointer-events: none;
    }
    .wallet-reward-card .reward-star {
      position: absolute; top: 20px; right: 24px; font-size: 28px; opacity: 0.7;
    }
    .wallet-reward-card .reward-type {
      font-size: 10px; text-transform: uppercase; letter-spacing: 3px;
      color: rgba(255,255,255,0.5); margin-bottom: 6px;
    }
    .wallet-reward-card .reward-title {
      font-size: 18px; font-weight: 700; color: #fff; margin-bottom: 24px;
    }
    .wallet-reward-card .reward-balance-label {
      font-size: 10px; text-transform: uppercase; letter-spacing: 2px;
      color: rgba(255,255,255,0.45); margin-bottom: 4px;
    }
    .wallet-reward-card .reward-balance-value {
      font-size: 32px; font-weight: 800; color: #fff;
      font-family: 'Space Grotesk', sans-serif;
    }
    .wallet-reward-card .reward-footer {
      position: absolute; bottom: 24px; left: 28px; right: 28px;
      display: flex; justify-content: space-between; align-items: flex-end;
    }
    .wallet-reward-card .reward-stat-label {
      font-size: 9px; text-transform: uppercase; letter-spacing: 1.5px;
      color: rgba(255,255,255,0.4); margin-bottom: 2px;
    }
    .wallet-reward-card .reward-stat-value {
      font-size: 13px; color: rgba(255,255,255,0.85); font-weight: 600;
    }
    .premium-popup-icon { font-size: 40px; margin-bottom: 12px; }
    .premium-popup h3 { font-size: 20px; font-weight: 700; margin-bottom: 8px; }
    .premium-popup p { font-size: 14px; color: var(--text2); line-height: 1.5; margin-bottom: 20px; }
    .premium-popup .price { font-size: 28px; font-weight: 800; margin-bottom: 24px;
      background: var(--gradient); -webkit-background-clip: text; -webkit-text-fill-color: transparent; }
    .premium-popup .btn-subscribe {
      width: 100%; padding: 16px; background: var(--gradient2); border: none;
      border-radius: 14px; color: white; font-size: 16px; font-weight: 600;
      cursor: pointer; font-family: inherit; margin-bottom: 10px;
      box-shadow: 0 4px 20px rgba(124,58,237,0.3);
    }
    .premium-popup .btn-later {
      width: 100%; padding: 14px; background: none; border: none;
      color: var(--text2); font-size: 14px; cursor: pointer; font-family: inherit;
    }

    /* ── Token Matrix Display ── */
    .token-matrix {
      background: var(--surface); border: 1px solid var(--glass-border);
      border-radius: var(--radius); padding: 18px; margin-bottom: 16px;
    }
    .token-row {
      display: flex; justify-content: space-between; align-items: center;
      padding: 8px 0; border-bottom: 1px solid rgba(255,255,255,0.04);
    }
    .token-row:last-child { border-bottom: none; }
    .token-label { font-size: 13px; color: var(--text2); }
    .token-value { font-size: 13px; font-weight: 600; font-family: 'SF Mono', 'Fira Code', monospace; }
    .token-saved { color: var(--emerald); }

    /* ── Auth Gate ── */
    .auth-gate {
      position: fixed; inset: 0; z-index: 200;
      background: var(--bg);
      display: flex; align-items: center; justify-content: center;
      opacity: 1; transition: opacity 0.4s ease;
    }
    .auth-gate.hidden {
      opacity: 0; pointer-events: none;
    }
    .auth-gate::before {
      content: ''; position: absolute; top: -50%; left: -50%; width: 200%; height: 200%;
      background: radial-gradient(ellipse at 30% 20%, rgba(124,58,237,0.08) 0%, transparent 50%),
                  radial-gradient(ellipse at 70% 80%, rgba(59,130,246,0.06) 0%, transparent 50%),
                  radial-gradient(ellipse at 50% 50%, rgba(6,182,212,0.04) 0%, transparent 50%);
      pointer-events: none;
      animation: ambientDrift 20s ease-in-out infinite alternate;
    }
    .auth-card {
      position: relative; z-index: 1;
      width: calc(100% - 40px); max-width: 400px;
      margin: 0 auto;
      background: rgba(255,255,255,0.03);
      border: 1px solid rgba(255,255,255,0.07);
      border-radius: 24px; padding: 36px 24px;
      backdrop-filter: blur(40px); -webkit-backdrop-filter: blur(40px);
      box-shadow: 0 20px 60px rgba(0,0,0,0.5);
    }
    .auth-brand {
      text-align: center; margin-bottom: 32px;
    }
    .auth-brand-icon {
      width: 72px; height: 72px; border-radius: 20px;
      background: rgba(255,255,255,0.03);
      border: 1px solid rgba(255,255,255,0.06);
      margin: 0 auto 16px;
      display: flex; align-items: center; justify-content: center;
      box-shadow: 0 8px 32px rgba(79,172,254,0.12), 0 0 60px rgba(240,147,251,0.06);
    }
    .auth-brand-name {
      font-size: 28px; font-weight: 800; letter-spacing: -0.5px;
      color: #fff;
    }
    .auth-brand-tagline {
      font-size: 13px; color: var(--text2); margin-top: 6px;
    }
    .auth-tabs {
      display: flex; background: rgba(255,255,255,0.04); border-radius: 12px;
      padding: 3px; margin-bottom: 28px;
    }
    .auth-tab {
      flex: 1; padding: 10px; text-align: center; font-size: 14px; font-weight: 700;
      border-radius: 10px; cursor: pointer; transition: all 0.2s;
      color: #fff; border: none; background: none; font-family: inherit;
    }
    .auth-tab.active {
      background: var(--gradient2); color: white;
      box-shadow: 0 4px 12px rgba(124,58,237,0.3);
    }
    .auth-form { display: none; }
    .auth-form.active { display: block; }
    .auth-field {
      margin-bottom: 16px;
    }
    .auth-field label {
      display: block; font-size: 13px; color: #fff;
      margin-bottom: 6px; font-weight: 600;
    }
    .auth-field input {
      width: 100%; padding: 14px 16px;
      background: rgba(255,255,255,0.04);
      border: 1px solid rgba(255,255,255,0.08);
      border-radius: 12px; color: var(--text);
      font-size: 14px; font-family: inherit; outline: none;
      transition: border-color 0.2s;
    }
    .auth-field input:focus {
      border-color: var(--accent);
    }
    .auth-field input::placeholder { color: var(--text3); }
    .auth-field .pw-wrapper {
      position: relative;
    }
    .auth-field .pw-wrapper input { padding-right: 44px; }
    .auth-field .pw-toggle {
      position: absolute; right: 12px; top: 50%; transform: translateY(-50%);
      background: none; border: none; cursor: pointer; color: var(--text3);
      padding: 4px; display: flex; align-items: center; justify-content: center;
      transition: color 0.2s;
    }
    .auth-field .pw-toggle:hover { color: var(--text); }
    .auth-submit {
      width: 100%; padding: 16px; margin-top: 8px;
      background: var(--gradient2); border: none; border-radius: 14px;
      color: white; font-size: 15px; font-weight: 600;
      cursor: pointer; font-family: inherit;
      box-shadow: 0 4px 20px rgba(124,58,237,0.3);
      transition: all 0.2s;
    }
    .auth-submit:active { transform: scale(0.98); }
    .auth-submit:disabled {
      opacity: 0.5; cursor: not-allowed; transform: none;
    }
    .auth-error {
      color: var(--red); font-size: 13px; text-align: center;
      margin-top: 12px; min-height: 18px;
    }
    .auth-divider {
      display: flex; align-items: center; gap: 12px;
      margin: 20px 0; color: var(--text3); font-size: 12px;
    }
    .auth-divider::before, .auth-divider::after {
      content: ''; flex: 1; height: 1px;
      background: rgba(255,255,255,0.06);
    }

    /* ── Settings Dropdown ── */
    .settings-dropdown-wrap {
      position: relative;
    }
    .settings-dropdown {
      position: absolute; top: calc(100% + 8px); right: 0;
      width: 180px; background: var(--bg2);
      border: 1px solid var(--glass-border);
      border-radius: var(--radius-sm); padding: 6px;
      box-shadow: var(--shadow-lg); z-index: 50;
      opacity: 0; transform: translateY(-8px) scale(0.95);
      pointer-events: none; transition: all 0.2s ease;
    }
    .settings-dropdown.open {
      opacity: 1; transform: translateY(0) scale(1);
      pointer-events: auto;
    }
    .settings-dropdown-item {
      display: flex; align-items: center; gap: 10px;
      padding: 10px 12px; border-radius: var(--radius-xs);
      font-size: 13px; color: var(--text); cursor: pointer;
      transition: background 0.15s; border: none; background: none;
      width: 100%; font-family: inherit;
    }
    .settings-dropdown-item:hover,
    .settings-dropdown-item:active {
      background: var(--surface-hover);
    }
    .settings-dropdown-item svg {
      flex-shrink: 0; color: var(--text2);
    }
    .settings-dropdown-item.danger { color: var(--red); }
    .settings-dropdown-item.danger svg { color: var(--red); }

    /* ── Hamburger Button ── */
    .hamburger-btn {
      width: 38px; height: 38px; border-radius: 50%;
      background: var(--surface); border: 1px solid var(--glass-border);
      display: flex; align-items: center; justify-content: center;
      cursor: pointer; transition: all 0.2s; color: var(--text2);
      padding: 0; flex-shrink: 0;
    }
    .hamburger-btn:active { transform: scale(0.92); background: var(--surface-hover); }

    /* ── Navigation Drawer ── */
    .nav-drawer-overlay {
      position: fixed; inset: 0; background: rgba(0,0,0,0.6);
      backdrop-filter: blur(6px); -webkit-backdrop-filter: blur(6px);
      z-index: 200; opacity: 0; pointer-events: none;
      transition: opacity 0.3s ease;
    }
    .nav-drawer-overlay.open { opacity: 1; pointer-events: auto; }
    .nav-drawer {
      position: fixed; top: 0; left: 0; bottom: 0; width: min(280px, 85vw);
      background: var(--bg2); z-index: 201;
      transform: translateX(-100%); transition: transform 0.3s cubic-bezier(0.32, 0.72, 0, 1);
      display: flex; flex-direction: column;
      padding-top: max(20px, env(safe-area-inset-top));
      box-shadow: 4px 0 24px rgba(0,0,0,0.3);
    }
    .nav-drawer-overlay.open .nav-drawer { transform: translateX(0); }
    .nav-drawer-header {
      padding: 20px 20px 16px; display: flex; align-items: center; gap: 14px;
      border-bottom: 1px solid var(--glass-border); margin-bottom: 8px;
    }
    .nav-drawer-header .drawer-logo {
      width: 40px; height: 40px; border-radius: 12px;
      background: var(--gradient); display: flex; align-items: center; justify-content: center;
      box-shadow: 0 0 12px rgba(124,58,237,0.3);
    }
    .nav-drawer-header .drawer-info { flex: 1; min-width: 0; }
    .nav-drawer-header .drawer-name {
      font-size: 15px; font-weight: 700; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;
    }
    .nav-drawer-header .drawer-email {
      font-size: 12px; color: var(--text3); white-space: nowrap; overflow: hidden; text-overflow: ellipsis;
    }
    .nav-drawer-section {
      padding: 4px 12px;
    }
    .nav-drawer-section-label {
      padding: 12px 12px 6px; font-size: 10px; text-transform: uppercase;
      letter-spacing: 2px; color: var(--text3); font-weight: 600;
    }
    .nav-drawer-item {
      display: flex; align-items: center; gap: 14px;
      padding: 12px 14px; border-radius: 12px; cursor: pointer;
      font-size: 14px; color: var(--text); font-weight: 500;
      transition: background 0.15s; border: none; background: none;
      width: 100%; font-family: inherit; text-align: left;
    }
    .nav-drawer-item:hover { background: var(--surface-hover); }
    .nav-drawer-item.active { background: rgba(124,58,237,0.12); color: var(--accent); }
    .nav-drawer-item.active svg { color: var(--accent); }
    .nav-drawer-item svg { flex-shrink: 0; color: var(--text2); }
    .nav-drawer-item.danger { color: var(--red); }
    .nav-drawer-item.danger svg { color: var(--red); }
    .nav-drawer-divider { height: 1px; background: var(--glass-border); margin: 8px 20px; }
    .nav-drawer-footer {
      margin-top: auto; padding: 16px 20px;
      border-top: 1px solid var(--glass-border);
      font-size: 11px; color: var(--text3); text-align: center;
    }

    /* ── Back Button (sub-pages) ── */
    .page-back-btn {
      display: inline-flex; align-items: center; gap: 6px;
      background: none; border: none; color: var(--text2);
      font-size: 13px; font-weight: 500; cursor: pointer;
      padding: 4px 0; font-family: inherit; transition: color 0.2s;
    }
    .page-back-btn:hover { color: var(--text); }

    /* ── Settings Page ── */
    .settings-section {
      background: var(--surface); border: 1px solid var(--glass-border);
      border-radius: var(--radius); padding: 20px; margin-bottom: 16px;
    }
    .settings-section-title {
      font-size: 15px; font-weight: 700; margin-bottom: 16px;
      display: flex; align-items: center; gap: 8px;
    }
    .settings-section-title svg { color: var(--accent2); }
    .settings-field {
      margin-bottom: 14px;
    }
    .settings-field:last-child { margin-bottom: 0; }
    .settings-field label {
      display: block; font-size: 12px; color: var(--text2);
      margin-bottom: 6px; font-weight: 500;
    }
    .settings-field select,
    .settings-field input[type="text"],
    .settings-field input[type="password"] {
      width: 100%; padding: 12px 14px;
      background: rgba(255,255,255,0.04);
      border: 1px solid rgba(255,255,255,0.08);
      border-radius: var(--radius-xs); color: var(--text);
      font-size: 14px; font-family: inherit; outline: none;
      transition: border-color 0.2s;
      -webkit-appearance: none; appearance: none;
    }
    .settings-field select {
      background-image: url("data:image/svg+xml,%3Csvg width='12' height='8' viewBox='0 0 12 8' fill='none' xmlns='http://www.w3.org/2000/svg'%3E%3Cpath d='M1 1.5L6 6.5L11 1.5' stroke='%238b92a5' stroke-width='1.5' stroke-linecap='round' stroke-linejoin='round'/%3E%3C/svg%3E");
      background-repeat: no-repeat;
      background-position: right 14px center;
      padding-right: 36px;
    }
    .settings-field select option {
      background: var(--bg2); color: var(--text);
    }
    .settings-field input:focus,
    .settings-field select:focus {
      border-color: var(--accent);
    }
    .settings-row {
      display: flex; gap: 12px;
    }
    .settings-row .settings-field { flex: 1; }
    .settings-btn {
      padding: 12px 24px; border-radius: var(--radius-xs);
      font-size: 13px; font-weight: 600; cursor: pointer;
      font-family: inherit; transition: all 0.2s; border: none;
    }
    .settings-btn:active { transform: scale(0.97); }
    .settings-btn-primary {
      background: var(--gradient2); color: white;
      box-shadow: 0 4px 16px rgba(124,58,237,0.25);
    }
    .settings-btn-secondary {
      background: rgba(255,255,255,0.06); color: var(--text);
      border: 1px solid rgba(255,255,255,0.08);
    }
    .settings-btn-full {
      width: 100%; padding: 16px;
      font-size: 15px; border-radius: var(--radius-sm);
    }

    /* ── Channel Toggle ── */
    .channel-toggle {
      display: flex; align-items: center; justify-content: space-between;
      padding: 10px 14px;
      background: rgba(255,255,255,0.02);
      border: 1px solid rgba(255,255,255,0.05);
      border-radius: var(--radius-xs);
      transition: all 0.2s;
    }
    .channel-toggle.active {
      border-color: rgba(124,58,237,0.3);
      background: rgba(124,58,237,0.06);
    }
    .channel-label {
      font-size: 12px; font-weight: 500; color: var(--text2);
      display: flex; align-items: center; gap: 6px;
    }
    .channel-toggle.active .channel-label { color: var(--text); }
    .toggle-switch {
      position: relative; width: 38px; height: 22px;
      background: rgba(255,255,255,0.1); border-radius: 11px;
      cursor: pointer; transition: background 0.25s; flex-shrink: 0;
    }
    .toggle-switch.on {
      background: var(--accent);
    }
    .toggle-switch::after {
      content: ''; position: absolute; top: 3px; left: 3px;
      width: 16px; height: 16px; background: white;
      border-radius: 50%; transition: transform 0.25s;
    }
    .toggle-switch.on::after {
      transform: translateX(16px);
    }
    .settings-saved-toast {
      position: fixed; bottom: 100px; left: 50%; transform: translateX(-50%) translateY(20px);
      background: var(--green); color: white;
      padding: 12px 24px; border-radius: 12px;
      font-size: 14px; font-weight: 600;
      box-shadow: 0 8px 32px rgba(16,185,129,0.3);
      opacity: 0; pointer-events: none;
      transition: all 0.3s ease; z-index: 300;
    }
    .settings-saved-toast.show {
      opacity: 1; transform: translateX(-50%) translateY(0);
    }

    /* ── Responsive ── */
    @media (min-width: 481px) {
      .app { border-left: 1px solid rgba(255,255,255,0.04); border-right: 1px solid rgba(255,255,255,0.04); }
    }
    @media (min-width: 768px) {
      body.app-mode { display: flex; align-items: center; justify-content: center; }
      .app { height: 100vh; max-height: 900px; border-radius: 32px; overflow: hidden; border: 1px solid rgba(255,255,255,0.06); }
    }

    /* ═══ Landing Page ═══ */
    .landing { display: none; min-height: 100vh; background: #030308; color: #e0e0e8; }
    .landing.active { display: block; }

    @keyframes holoSweep { 0% { background-position: 0% center; } 100% { background-position: 200% center; } }
    @keyframes cardGlint { 0% { transform: translateX(-100%) rotate(25deg); } 100% { transform: translateX(200%) rotate(25deg); } }
    @keyframes lpFloat { 0%, 100% { transform: translateY(0); } 50% { transform: translateY(-12px); } }
    @keyframes lpBlink { 50% { opacity: 0; } }
    .lp-cursor { animation: lpBlink 1s step-end infinite; }
    .lp-holo-text {
      background: linear-gradient(135deg, #00f2fe, #4facfe, #f093fb, #736efe, #00f2fe);
      background-size: 200% auto; animation: holoSweep 4s linear infinite;
      -webkit-background-clip: text; -webkit-text-fill-color: transparent; background-clip: text;
    }
    .lp-logo-mark {
      width: 42px; height: 42px; border-radius: 12px; position: relative;
      background: #fff;
      display: flex; align-items: center; justify-content: center;
      box-shadow: 0 0 16px rgba(255,255,255,0.15), 0 2px 8px rgba(0,0,0,0.3);
    }

    .lp-nav {
      position: fixed; top: 0; left: 0; right: 0; z-index: 50;
      transition: all 0.3s ease; padding: 16px 0;
      padding-top: max(16px, var(--safe-top));
    }
    .lp-nav.scrolled {
      background: rgba(3,3,8,0.92); backdrop-filter: blur(20px);
      border-bottom: 1px solid rgba(255,255,255,0.06); padding: 12px 0;
    }
    .lp-nav-inner {
      max-width: 1200px; margin: 0 auto;
      padding: 0 max(24px, calc(24px + var(--safe-left)));
      padding-right: max(24px, calc(24px + var(--safe-right)));
      display: flex; justify-content: space-between; align-items: center;
    }
    .lp-logo { display: flex; align-items: center; gap: 12px; cursor: pointer; }
    .lp-logo-text { font-family: 'Space Grotesk', sans-serif; font-size: 20px; font-weight: 700; color: #fff; letter-spacing: -0.5px; }
    .lp-nav-links { display: none; gap: 28px; font-size: 14px; font-weight: 500; }
    .lp-nav-links a { color: rgba(255,255,255,0.6); text-decoration: none; transition: color 0.2s; }
    .lp-nav-links a:hover { color: #fff; }
    @media (min-width: 768px) { .lp-nav-links { display: flex; } }
    .lp-nav-actions { display: flex; align-items: center; gap: 12px; }
    .lp-btn-primary {
      background: linear-gradient(135deg, #4facfe, #736efe); color: white; font-size: 14px; font-weight: 600;
      padding: 10px 20px; border-radius: 12px; border: none;
      cursor: pointer; transition: all 0.3s; box-shadow: 0 4px 16px rgba(79,172,254,0.25);
    }
    .lp-btn-primary:hover { transform: translateY(-1px); box-shadow: 0 6px 24px rgba(79,172,254,0.35); }
    .lp-btn-secondary {
      background: rgba(255,255,255,0.06); color: #fff; font-size: 14px; font-weight: 600;
      padding: 10px 20px; border-radius: 12px; border: 1px solid rgba(255,255,255,0.1);
      cursor: pointer; transition: all 0.3s;
    }
    .lp-btn-secondary:hover { background: rgba(255,255,255,0.1); border-color: rgba(255,255,255,0.2); }
    .lp-btn-signin {
      background: none; color: #fff; font-size: 14px; font-weight: 700;
      padding: 8px 16px; border: none; cursor: pointer; transition: color 0.2s;
    }
    .lp-btn-signin:hover { color: #fff; }

    .lp-hero {
      position: relative; padding: 140px 24px 80px; max-width: 1200px; margin: 0 auto; overflow: hidden;
      padding-left: max(24px, calc(24px + var(--safe-left)));
      padding-right: max(24px, calc(24px + var(--safe-right)));
    }
    .lp-hero-glow {
      position: absolute; top: -200px; right: -100px; width: 600px; height: 600px;
      background: radial-gradient(circle, rgba(79,172,254,0.08) 0%, rgba(240,147,251,0.04) 40%, transparent 70%);
      pointer-events: none;
    }
    .lp-hero-grid { display: grid; gap: 48px; align-items: center; }
    @media (min-width: 1024px) { .lp-hero-grid { grid-template-columns: 1fr 1fr; } }
    .lp-hero h1 {
      font-family: 'Space Grotesk', sans-serif;
      font-size: clamp(40px, 6vw, 68px); font-weight: 700; color: #fff;
      line-height: 1.08; letter-spacing: -2px; margin: 20px 0;
    }
    .lp-hero-desc { font-size: 18px; color: rgba(255,255,255,0.5); max-width: 480px; line-height: 1.7; margin-bottom: 32px; }
    .lp-hero-btns { display: flex; flex-wrap: wrap; gap: 12px; }
    .lp-hero-btns .lp-btn-primary { padding: 14px 28px; font-size: 16px; border-radius: 14px; display: flex; align-items: center; gap: 8px; }
    .lp-hero-btns .lp-btn-secondary { padding: 14px 28px; font-size: 16px; border-radius: 14px; }

    .lp-terminal { position: relative; }
    .lp-terminal-inner {
      background: rgba(255,255,255,0.02); border: 1px solid rgba(255,255,255,0.06);
      border-radius: 20px; overflow: hidden;
    }
    .lp-terminal-header {
      background: rgba(255,255,255,0.02); border-bottom: 1px solid rgba(255,255,255,0.06);
      padding: 12px 16px; display: flex; align-items: center; justify-content: space-between;
    }
    .lp-terminal-header-left { display: flex; align-items: center; gap: 10px; }
    .lp-terminal-title { font-size: 12px; font-family: 'JetBrains Mono', monospace; color: rgba(255,255,255,0.35); }
    .lp-terminal-dots { display: flex; gap: 6px; }
    .lp-terminal-dots span { width: 10px; height: 10px; border-radius: 50%; background: rgba(255,255,255,0.08); }
    .lp-terminal-body { padding: 24px; font-family: 'JetBrains Mono', monospace; }

    /* ═══ Friendly AI Agent ═══ */
    @keyframes agentFloat { 0%, 100% { transform: translateY(0); } 50% { transform: translateY(-14px); } }
    @keyframes agentShimmer { 0% { transform: translateX(-100%); } 100% { transform: translateX(300%); } }
    .agent-section { display: flex; flex-direction: column; align-items: center; gap: 16px; }
    .agent-wrapper {
      position: relative; width: 220px; height: 280px;
      display: flex; flex-direction: column; align-items: center; justify-content: center;
    }
    .agent-shadow {
      position: absolute; bottom: 12px; width: 100px; height: 10px;
      background: rgba(79,172,254,0.12); filter: blur(14px); border-radius: 50%;
    }
    .agent-body { position: relative; animation: agentFloat 5s ease-in-out infinite; }
    .agent-capsule {
      position: relative; width: 140px; height: 180px;
      background: rgba(255,255,255,0.93); border-radius: 70px;
      box-shadow: 0 24px 60px rgba(0,0,0,0.35), 0 0 60px rgba(79,172,254,0.08);
      border: 1px solid rgba(255,255,255,0.4);
      overflow: hidden; display: flex; flex-direction: column;
      align-items: center; justify-content: center;
    }
    .agent-glow {
      position: absolute; inset: 0; opacity: 0.15; border-radius: 70px;
      background: #22d3ee; transition: background 0.8s;
    }
    .agent-glow.thinking { background: #fbbf24; }
    .agent-glow.success { background: #34d399; }
    .agent-face {
      position: relative; z-index: 2; display: flex; flex-direction: column;
      align-items: center; gap: 22px;
    }
    .agent-eyes { display: flex; gap: 26px; transition: transform 0.15s ease-out; }
    .agent-eye {
      width: 11px; height: 11px; background: #1e293b; border-radius: 50%;
      position: relative; transition: transform 0.15s;
    }
    .agent-eye.blink { transform: scaleY(0.1); }
    .agent-eye-sparkle {
      position: absolute; top: 1px; right: 1px; width: 3px; height: 3px;
      background: white; border-radius: 50%; opacity: 0.7;
    }
    .agent-mouth {
      width: 38px; height: 5px; background: #e2e8f0; border-radius: 3px; overflow: hidden;
    }
    .agent-mouth-fill {
      height: 100%; width: 33%; background: #22d3ee; border-radius: 3px;
      transition: all 0.5s;
    }
    .agent-mouth-fill.thinking { width: 100%; background: #fbbf24; animation: pulse 1.5s ease infinite; }
    .agent-mouth-fill.success { width: 100%; background: #34d399; }
    .agent-reflection {
      position: absolute; inset: 0; border-radius: 70px;
      background: linear-gradient(135deg, transparent 30%, rgba(255,255,255,0.35) 50%, rgba(255,255,255,0.08) 80%);
      pointer-events: none; z-index: 3;
    }
    .agent-icons {
      position: absolute; right: -36px; top: 28%; display: flex;
      flex-direction: column; gap: 12px;
    }
    .agent-icon-bubble {
      width: 34px; height: 34px; background: rgba(255,255,255,0.92);
      border-radius: 11px; display: flex; align-items: center; justify-content: center;
      box-shadow: 0 6px 20px rgba(0,0,0,0.18); border: 1px solid rgba(255,255,255,0.4);
      transition: all 0.5s; font-size: 15px;
    }
    .agent-icon-bubble.hide { transform: translateX(16px); opacity: 0; }

    /* Agent Chat Panel */
    .agent-chat {
      width: 100%; background: rgba(255,255,255,0.03);
      border: 1px solid rgba(255,255,255,0.07); border-radius: 24px;
      padding: 20px; overflow: hidden;
    }
    .agent-chat-header {
      display: flex; align-items: center; gap: 12px;
      padding-bottom: 14px; border-bottom: 1px solid rgba(255,255,255,0.06);
    }
    .agent-chat-status-icon {
      width: 38px; height: 38px; border-radius: 12px;
      display: flex; align-items: center; justify-content: center;
      transition: background 0.4s;
    }
    .agent-chat-status-icon.greeting { background: rgba(34,211,238,0.1); }
    .agent-chat-status-icon.thinking { background: rgba(251,191,36,0.1); }
    .agent-chat-status-icon.success { background: rgba(52,211,153,0.1); }
    .agent-chat-title { font-size: 14px; font-weight: 700; color: #fff; }
    .agent-chat-subtitle { font-size: 11px; color: rgba(255,255,255,0.35); margin-top: 2px; }
    .agent-chat-progress {
      height: 3px; background: rgba(255,255,255,0.05); border-radius: 2px;
      overflow: hidden; margin-top: 14px;
    }
    .agent-chat-progress-fill {
      height: 100%; width: 0; background: linear-gradient(90deg, #22d3ee, #4facfe);
      border-radius: 2px; transition: width 2s ease;
    }
    .agent-chat-progress-fill.active { width: 100%; }
    .agent-messages {
      display: flex; flex-direction: column; gap: 8px; margin-top: 14px;
      max-height: 200px; overflow-y: auto; scrollbar-width: none;
    }
    .agent-messages::-webkit-scrollbar { display: none; }
    .agent-msg {
      padding: 10px 14px; border-radius: 14px; font-size: 13px;
      line-height: 1.5; max-width: 88%; opacity: 0; transform: translateY(8px);
      animation: agentMsgIn 0.4s ease forwards;
    }
    @keyframes agentMsgIn { to { opacity: 1; transform: translateY(0); } }
    .agent-msg.user {
      background: linear-gradient(135deg, #4facfe, #736efe); color: white;
      align-self: flex-end; border-bottom-right-radius: 4px;
    }
    .agent-msg.ai {
      background: rgba(255,255,255,0.06); color: rgba(255,255,255,0.8);
      align-self: flex-start; border-bottom-left-radius: 4px;
    }
    .agent-msg.typing-msg {
      background: rgba(255,255,255,0.06); align-self: flex-start;
      border-bottom-left-radius: 4px; display: flex; gap: 5px; padding: 14px 18px;
    }
    .agent-typing-dot {
      width: 6px; height: 6px; background: rgba(255,255,255,0.3);
      border-radius: 50%; animation: typingBounce 1.4s ease-in-out infinite;
    }
    .agent-typing-dot:nth-child(2) { animation-delay: 0.2s; }
    .agent-typing-dot:nth-child(3) { animation-delay: 0.4s; }

    /* ═══ Features ═══ */
    .lp-features { padding: 80px 24px; }
    .lp-features-inner { max-width: 1200px; margin: 0 auto; }
    .lp-features-header { text-align: center; margin-bottom: 48px; }
    .lp-features-title {
      font-family: 'Space Grotesk', sans-serif;
      font-size: 32px; font-weight: 700; color: #fff; margin-bottom: 12px;
    }
    .lp-features-subtitle { font-size: 16px; color: rgba(255,255,255,0.4); max-width: 500px; margin: 0 auto; }
    .lp-features-grid { display: grid; gap: 16px; }
    @media (min-width: 768px) { .lp-features-grid { grid-template-columns: repeat(3, 1fr); } }
    .lp-feature-card {
      background: rgba(255,255,255,0.02); border: 1px solid rgba(255,255,255,0.06);
      padding: 28px; border-radius: 20px; transition: all 0.3s;
    }
    .lp-feature-card:hover {
      background: rgba(255,255,255,0.04); border-color: rgba(255,255,255,0.12);
      transform: translateY(-2px);
    }
    .lp-feature-emoji { font-size: 28px; margin-bottom: 16px; display: block; }
    .lp-feature-title {
      font-family: 'Space Grotesk', sans-serif;
      font-size: 17px; font-weight: 700; color: #fff; margin-bottom: 8px;
    }
    .lp-feature-desc { font-size: 14px; color: rgba(255,255,255,0.4); line-height: 1.6; }

    /* ═══ Showcase / How it works ═══ */
    .lp-showcase { padding: 80px 24px; }
    .lp-showcase-inner {
      max-width: 1200px; margin: 0 auto;
      display: grid; gap: 48px; align-items: center;
    }
    @media (min-width: 1024px) { .lp-showcase-inner { grid-template-columns: 1fr 1fr; } }
    .lp-showcase-left h2 {
      font-family: 'Space Grotesk', sans-serif;
      font-size: 32px; font-weight: 700; color: #fff; margin-bottom: 12px;
    }
    .lp-showcase-left p { font-size: 16px; color: rgba(255,255,255,0.4); line-height: 1.7; margin-bottom: 24px; }
    .lp-showcase-steps { display: flex; flex-direction: column; gap: 16px; }
    .lp-step {
      display: flex; align-items: center; gap: 16px; padding: 16px 20px;
      background: rgba(255,255,255,0.02); border: 1px solid rgba(255,255,255,0.06);
      border-radius: 16px; transition: all 0.3s;
    }
    .lp-step:hover { background: rgba(255,255,255,0.04); }
    .lp-step-num {
      width: 36px; height: 36px; border-radius: 10px; flex-shrink: 0;
      background: linear-gradient(135deg, #4facfe, #736efe);
      display: flex; align-items: center; justify-content: center;
      font-size: 14px; font-weight: 700; color: white;
    }
    .lp-step-text { font-size: 14px; color: rgba(255,255,255,0.7); }
    .lp-step-text strong { color: #fff; }

    /* Holographic Card */
    .lp-holo-card {
      width: 100%; max-width: 380px; aspect-ratio: 1.586; border-radius: 20px;
      background: linear-gradient(135deg, #0a0a1a 0%, #1a1040 50%, #0a0a1a 100%);
      border: 1px solid rgba(255,255,255,0.08);
      padding: 28px; position: relative; overflow: hidden;
      box-shadow: 0 24px 60px rgba(0,0,0,0.5);
      animation: lpFloat 5s ease-in-out infinite; margin: 0 auto;
    }
    .lp-holo-card-glint {
      position: absolute; top: 0; left: -50%; width: 50%; height: 200%;
      background: linear-gradient(90deg, transparent, rgba(255,255,255,0.05), transparent);
      animation: cardGlint 4s ease-in-out infinite; pointer-events: none;
    }
    .lp-holo-card-chip {
      width: 36px; height: 28px; border-radius: 6px;
      background: linear-gradient(135deg, #d4a853, #f0d78c, #d4a853);
      position: absolute; top: 28px; right: 28px;
    }
    .lp-holo-card-logo {
      font-family: 'Space Grotesk', sans-serif; font-weight: 700; font-size: 20px; margin-bottom: 32px;
    }
    .lp-holo-card-number {
      font-family: 'JetBrains Mono', monospace; font-size: 18px;
      letter-spacing: 3px; color: rgba(255,255,255,0.7); margin-bottom: 20px;
    }
    .lp-holo-card-footer { display: flex; justify-content: space-between; align-items: flex-end; }
    .lp-holo-card-label {
      font-size: 10px; text-transform: uppercase; letter-spacing: 2px;
      color: rgba(255,255,255,0.3); margin-bottom: 4px;
    }
    .lp-holo-card-value { font-size: 14px; color: rgba(255,255,255,0.8); }

    /* ═══ Footer — GitHub Industrial ═══ */
    .lp-footer {
      padding: 48px 24px 32px; border-top: 1px solid #30363d; background: #161b22;
    }
    .lp-footer-inner {
      max-width: 1200px; margin: 0 auto;
      display: flex; flex-direction: column; gap: 32px;
    }
    .lp-footer-top {
      display: flex; flex-direction: column; align-items: center; gap: 24px;
    }
    @media (min-width: 768px) {
      .lp-footer-top { flex-direction: row; justify-content: space-between; }
    }
    .lp-footer-brand { display: flex; align-items: center; gap: 12px; }
    .lp-footer-brand-icon {
      width: 32px; height: 32px; background: #f0f6fc; border-radius: 6px;
      display: flex; align-items: center; justify-content: center;
    }
    .lp-footer-brand-text span {
      font-family: 'Space Grotesk', sans-serif; font-size: 16px; font-weight: 700; color: #f0f6fc; letter-spacing: -0.5px;
    }
    .lp-footer-brand-text p {
      font-size: 10px; color: #8b949e; text-transform: uppercase; font-family: monospace; letter-spacing: 2px; margin-top: 2px;
    }
    .lp-footer-links {
      display: flex; gap: 24px; flex-wrap: wrap; justify-content: center;
    }
    .lp-footer-links a {
      font-size: 12px; color: #8b949e; text-decoration: none; text-transform: uppercase;
      font-weight: 600; letter-spacing: 1.5px; transition: color 0.2s;
    }
    .lp-footer-links a:hover { color: #58a6ff; }
    .lp-footer-bottom {
      max-width: 1200px; margin: 0 auto; padding-top: 24px;
      border-top: 1px solid #30363d;
      display: flex; flex-direction: column; align-items: center; gap: 12px;
    }
    @media (min-width: 768px) {
      .lp-footer-bottom { flex-direction: row; justify-content: space-between; }
    }
    .lp-footer-copy { font-size: 12px; color: #484f58; }
    .lp-footer-social { display: flex; gap: 16px; }
    .lp-footer-social a {
      width: 32px; height: 32px; border-radius: 6px; border: 1px solid #30363d;
      display: flex; align-items: center; justify-content: center;
      color: #8b949e; transition: all 0.2s; text-decoration: none;
    }
    .lp-footer-social a:hover { border-color: #58a6ff; color: #58a6ff; background: rgba(88,166,255,0.06); }

    /* ═══════════════════════════════════════ */
    /* POS MODE                                */
    /* ═══════════════════════════════════════ */
    /* POS Agent Card */
    .pos-agent-card {
      padding: 18px; border-radius: 16px; margin-bottom: 16px;
      background: linear-gradient(135deg, rgba(99,102,241,0.12), rgba(168,85,247,0.08));
      border: 1px solid rgba(99,102,241,0.2);
    }
    .pos-agent-card.not-registered {
      background: linear-gradient(135deg, rgba(255,255,255,0.04), rgba(124,58,237,0.06));
      border: 1px dashed rgba(124,58,237,0.3);
    }
    .pos-agent-header { display: flex; align-items: center; gap: 12px; margin-bottom: 12px; }
    .pos-agent-badge {
      padding: 4px 12px; border-radius: 20px; font-size: 11px; font-weight: 700;
      text-transform: uppercase; letter-spacing: 0.5px;
    }
    .pos-agent-code { font-family: 'JetBrains Mono', monospace; font-size: 13px; font-weight: 600; color: var(--accent2); }
    .pos-agent-limit-bar { margin-bottom: 12px; }
    .pos-limit-labels { display: flex; justify-content: space-between; font-size: 11px; color: var(--text2); margin-bottom: 4px; }
    .pos-limit-track { height: 6px; background: rgba(255,255,255,0.06); border-radius: 3px; overflow: hidden; }
    .pos-limit-fill { height: 100%; border-radius: 3px; transition: width 0.6s ease; background: var(--gradient2); }
    .pos-limit-fill.high { background: linear-gradient(90deg, #f59e0b, #ef4444); }
    .pos-agent-actions { display: flex; gap: 8px; flex-wrap: wrap; }
    .pos-agent-actions button {
      padding: 8px 16px; border-radius: 10px; border: 1px solid var(--glass-border);
      background: rgba(255,255,255,0.04); color: var(--text); font-size: 12px;
      font-weight: 600; cursor: pointer; font-family: inherit; transition: all 0.15s;
    }
    .pos-agent-actions button:hover { background: rgba(124,58,237,0.12); border-color: var(--accent); color: var(--accent2); }
    .pos-agent-actions button.primary-action {
      background: var(--gradient2); color: #fff; border: none;
      box-shadow: 0 2px 10px rgba(124,58,237,0.2);
    }
    .pos-register-form { margin-top: 14px; }
    .pos-register-form .pos-input-group { margin-bottom: 10px; }
    .pos-register-form label { display: block; font-size: 11px; color: var(--text2); margin-bottom: 4px; text-transform: uppercase; letter-spacing: 0.5px; }
    .pos-register-form input { width: 100%; padding: 12px 14px; border-radius: 10px; border: 1px solid var(--glass-border); background: rgba(255,255,255,0.04); color: var(--text); font-size: 14px; font-family: inherit; outline: none; box-sizing: border-box; }
    .pos-register-form input:focus { border-color: var(--accent); }

    .pos-wallet-strip {
      display: flex; align-items: center; gap: 12px;
      padding: 16px 18px; border-radius: 16px;
      background: linear-gradient(135deg, rgba(124,58,237,0.18), rgba(59,130,246,0.12));
      border: 1px solid rgba(124,58,237,0.2); margin-bottom: 18px;
    }
    .pos-wallet-bal { flex: 1; }
    .pos-wallet-bal .pw-label { font-size: 11px; color: var(--text2); text-transform: uppercase; letter-spacing: 0.5px; }
    .pos-wallet-bal .pw-amount { font-size: 26px; font-weight: 800; font-family: 'JetBrains Mono', monospace; }
    .pos-fund-btn {
      padding: 10px 18px; border-radius: 12px; border: none;
      background: var(--gradient2); color: #fff; font-size: 13px; font-weight: 600;
      cursor: pointer; font-family: inherit; white-space: nowrap;
      box-shadow: 0 4px 14px rgba(124,58,237,0.25);
    }
    .pos-fund-btn:active { transform: scale(0.96); }

    .pos-sell-card {
      padding: 20px; border-radius: 18px;
      background: var(--surface); border: 1px solid var(--glass-border);
      margin-bottom: 18px;
    }
    .pos-sell-card h3 { font-size: 15px; font-weight: 700; margin-bottom: 14px; }
    .pos-input-group { margin-bottom: 12px; }
    .pos-input-group label { display: block; font-size: 11px; color: var(--text2); margin-bottom: 6px; text-transform: uppercase; letter-spacing: 0.5px; }
    .pos-input {
      width: 100%; padding: 14px 16px; border-radius: 12px; border: 1px solid var(--glass-border);
      background: rgba(255,255,255,0.04); color: var(--text); font-size: 16px;
      font-family: 'JetBrains Mono', monospace; outline: none; transition: border-color 0.2s;
      box-sizing: border-box;
    }
    .pos-input:focus { border-color: var(--accent); }
    .pos-input::placeholder { color: var(--text3); }

    .pos-carrier-badge {
      display: inline-flex; align-items: center; gap: 6px;
      padding: 6px 12px; border-radius: 8px; font-size: 12px; font-weight: 600;
      background: rgba(16,185,129,0.12); color: var(--emerald); margin-top: 6px;
    }

    .pos-amount-grid {
      display: grid; grid-template-columns: repeat(4, 1fr); gap: 8px; margin-bottom: 12px;
    }
    .pos-quick-amt {
      padding: 12px 4px; border-radius: 10px; border: 1px solid var(--glass-border);
      background: rgba(255,255,255,0.03); color: var(--text); font-size: 14px;
      font-weight: 600; cursor: pointer; text-align: center; font-family: inherit;
      transition: all 0.15s;
    }
    .pos-quick-amt:active, .pos-quick-amt.active {
      background: rgba(124,58,237,0.15); border-color: var(--accent); color: var(--accent2);
    }

    .pos-sell-btn {
      width: 100%; padding: 16px; border-radius: 14px; border: none;
      background: linear-gradient(135deg, #10b981, #059669); color: #fff;
      font-size: 17px; font-weight: 700; cursor: pointer; font-family: inherit;
      box-shadow: 0 4px 20px rgba(16,185,129,0.3); transition: all 0.15s;
      text-transform: uppercase; letter-spacing: 1px;
    }
    .pos-sell-btn:disabled {
      opacity: 0.5; cursor: not-allowed; box-shadow: none;
    }
    .pos-sell-btn:not(:disabled):active { transform: scale(0.97); }

    .pos-stats-row {
      display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px; margin-bottom: 18px;
    }
    .pos-stat-card {
      padding: 14px 12px; border-radius: 14px; text-align: center;
      background: var(--surface); border: 1px solid var(--glass-border);
    }
    .pos-stat-card .ps-val { font-size: 20px; font-weight: 800; font-family: 'JetBrains Mono', monospace; }
    .pos-stat-card .ps-label { font-size: 10px; color: var(--text2); text-transform: uppercase; letter-spacing: 0.5px; margin-top: 4px; }
    .ps-green { color: var(--emerald); }
    .ps-accent { color: var(--accent2); }

    .pos-sales-list { margin-top: 4px; }
    .pos-sale-item {
      display: flex; align-items: center; gap: 12px;
      padding: 14px 0; border-bottom: 1px solid rgba(255,255,255,0.04);
    }
    .pos-sale-item:last-child { border-bottom: none; }
    .pos-sale-icon {
      width: 40px; height: 40px; border-radius: 12px;
      display: flex; align-items: center; justify-content: center; font-size: 18px;
      background: rgba(16,185,129,0.12); flex-shrink: 0;
    }
    .pos-sale-icon.failed { background: rgba(239,68,68,0.12); }
    .pos-sale-info { flex: 1; min-width: 0; }
    .pos-sale-phone { font-size: 14px; font-weight: 600; font-family: 'JetBrains Mono', monospace; }
    .pos-sale-carrier { font-size: 11px; color: var(--text2); }
    .pos-sale-right { text-align: right; flex-shrink: 0; }
    .pos-sale-amount { font-size: 14px; font-weight: 700; }
    .pos-sale-profit { font-size: 11px; color: var(--emerald); font-weight: 600; }
    .pos-sale-time { font-size: 10px; color: var(--text3); margin-top: 2px; }

    /* Fund Wallet Modal */
    .fund-modal-amounts {
      display: grid; grid-template-columns: repeat(3, 1fr); gap: 8px; margin-bottom: 16px;
    }
    .fund-amt-btn {
      padding: 14px 8px; border-radius: 12px; border: 1px solid var(--glass-border);
      background: rgba(255,255,255,0.03); color: var(--text); font-size: 15px;
      font-weight: 600; cursor: pointer; text-align: center; font-family: inherit;
      transition: all 0.15s;
    }
    .fund-amt-btn:active, .fund-amt-btn.active {
      background: rgba(124,58,237,0.15); border-color: var(--accent); color: var(--accent2);
    }

    /* Receipt modal */
    .pos-receipt {
      background: #fff; color: #111; border-radius: 16px; padding: 24px;
      font-family: 'JetBrains Mono', monospace; max-width: 320px; margin: 0 auto;
    }
    .pos-receipt h4 { text-align: center; font-size: 16px; color: #111; margin-bottom: 12px; }
    .pos-receipt hr { border: none; border-top: 1px dashed #ccc; margin: 12px 0; }
    .pos-receipt .rcpt-row { display: flex; justify-content: space-between; font-size: 13px; margin: 6px 0; }
    .pos-receipt .rcpt-label { color: #666; }
    .pos-receipt .rcpt-val { font-weight: 600; color: #111; }
    .pos-receipt .rcpt-total { font-size: 22px; text-align: center; font-weight: 800; margin: 12px 0; color: #10b981; }
    .pos-receipt .rcpt-footer { text-align: center; font-size: 10px; color: #999; margin-top: 12px; }

    /* ═══ Calls / Social Page ═══ */
    .calls-tabs {
      display: flex; gap: 4px; background: rgba(255,255,255,0.04);
      border-radius: 14px; padding: 4px; margin-bottom: 20px;
    }
    .calls-tab {
      flex: 1; padding: 10px 0; text-align: center; border-radius: 11px;
      font-size: 13px; font-weight: 600; color: var(--text3);
      cursor: pointer; transition: all 0.2s; border: none; background: none;
      font-family: inherit;
    }
    .calls-tab.active { background: var(--accent); color: #fff; box-shadow: 0 2px 12px rgba(124,58,237,0.3); }

    /* Dialpad */
    .dialpad-display {
      text-align: center; padding: 24px 0 12px;
    }
    .dialpad-number {
      font-size: 32px; font-weight: 700; color: var(--text);
      font-family: 'JetBrains Mono', monospace; letter-spacing: 2px;
      min-height: 44px; word-break: break-all;
    }
    .dialpad-rate {
      font-size: 12px; color: var(--text3); margin-top: 6px;
    }
    .dialpad-grid {
      display: grid; grid-template-columns: repeat(3, 1fr); gap: 12px;
      max-width: 280px; margin: 0 auto; padding: 12px 0;
    }
    .dial-key {
      width: 72px; height: 72px; border-radius: 50%; border: 1px solid rgba(255,255,255,0.08);
      background: rgba(255,255,255,0.04); display: flex; flex-direction: column;
      align-items: center; justify-content: center; cursor: pointer;
      transition: all 0.15s; margin: 0 auto; font-family: inherit;
      color: var(--text);
    }
    .dial-key:active { background: rgba(124,58,237,0.2); transform: scale(0.93); }
    .dial-key-num { font-size: 26px; font-weight: 600; line-height: 1; }
    .dial-key-sub { font-size: 9px; color: var(--text3); letter-spacing: 2px; margin-top: 2px; }
    .dial-actions {
      display: flex; justify-content: center; gap: 32px; align-items: center;
      padding: 16px 0;
    }
    .dial-call-btn {
      width: 64px; height: 64px; border-radius: 50%;
      background: linear-gradient(135deg, #10b981, #059669);
      border: none; cursor: pointer; display: flex; align-items: center; justify-content: center;
      box-shadow: 0 4px 20px rgba(16,185,129,0.4); transition: all 0.2s;
    }
    .dial-call-btn:active { transform: scale(0.92); }
    .dial-call-btn.hangup { background: linear-gradient(135deg, #ef4444, #dc2626); box-shadow: 0 4px 20px rgba(239,68,68,0.4); }
    .dial-backspace {
      width: 48px; height: 48px; border-radius: 50%; border: none;
      background: rgba(255,255,255,0.06); cursor: pointer;
      display: flex; align-items: center; justify-content: center;
      color: var(--text2); transition: all 0.15s; font-family: inherit;
    }
    .dial-backspace:active { background: rgba(255,255,255,0.12); }

    /* Active Call Screen Overlay */
    .call-screen {
      position: fixed; inset: 0; z-index: 999;
      background: linear-gradient(160deg, #0d1117 0%, #1a1035 50%, #0d1117 100%);
      display: none; flex-direction: column; align-items: center;
      justify-content: center; padding: 40px 24px;
    }
    .call-screen.active { display: flex; }
    .call-avatar {
      width: 96px; height: 96px; border-radius: 50%;
      background: linear-gradient(135deg, var(--accent), #3b82f6);
      display: flex; align-items: center; justify-content: center;
      font-size: 36px; font-weight: 700; color: #fff; margin-bottom: 20px;
      box-shadow: 0 0 40px rgba(124,58,237,0.3);
    }
    .call-name { font-size: 24px; font-weight: 700; color: #fff; margin-bottom: 4px; }
    .call-status { font-size: 14px; color: rgba(255,255,255,0.5); margin-bottom: 40px; }
    .call-status.connected { color: #10b981; }
    .call-timer {
      font-size: 42px; font-weight: 300; color: #fff;
      font-family: 'JetBrains Mono', monospace; margin-bottom: 48px; letter-spacing: 3px;
    }
    .call-controls {
      display: flex; gap: 24px; align-items: center; margin-bottom: 40px;
    }
    .call-ctrl-btn {
      width: 56px; height: 56px; border-radius: 50%;
      background: rgba(255,255,255,0.1); border: none; cursor: pointer;
      display: flex; align-items: center; justify-content: center;
      color: #fff; transition: all 0.2s;
    }
    .call-ctrl-btn:active { transform: scale(0.9); }
    .call-ctrl-btn.active { background: rgba(255,255,255,0.25); }
    .call-ctrl-btn.hangup-btn {
      width: 68px; height: 68px;
      background: linear-gradient(135deg, #ef4444, #dc2626);
      box-shadow: 0 4px 24px rgba(239,68,68,0.4);
    }

    /* Video Call */
    .video-call-screen {
      position: fixed; inset: 0; z-index: 998;
      background: #000; display: none; flex-direction: column;
    }
    .video-call-screen.active { display: flex; }
    .video-remote {
      flex: 1; background: #111; display: flex; align-items: center;
      justify-content: center; position: relative;
    }
    .video-remote video { width: 100%; height: 100%; object-fit: cover; }
    .video-remote .video-placeholder {
      text-align: center; color: rgba(255,255,255,0.4);
    }
    .video-remote .video-placeholder svg { margin-bottom: 12px; }
    .video-local {
      position: absolute; top: 52px; right: 16px;
      width: 120px; height: 160px; border-radius: 16px;
      overflow: hidden; border: 2px solid rgba(255,255,255,0.2);
      background: #222; z-index: 2;
    }
    .video-local video { width: 100%; height: 100%; object-fit: cover; }
    .video-controls {
      position: absolute; bottom: 40px; left: 50%; transform: translateX(-50%);
      display: flex; gap: 20px; z-index: 3;
    }

    /* Chat / Messaging */
    .chat-list-item {
      display: flex; align-items: center; gap: 12px;
      padding: 14px 0; border-bottom: 1px solid rgba(255,255,255,0.04);
      cursor: pointer; transition: all 0.15s;
    }
    .chat-list-item:active { opacity: 0.7; }
    .chat-list-avatar {
      width: 48px; height: 48px; border-radius: 50%;
      background: linear-gradient(135deg, rgba(124,58,237,0.3), rgba(59,130,246,0.3));
      display: flex; align-items: center; justify-content: center;
      font-size: 18px; font-weight: 700; color: var(--accent2); flex-shrink: 0;
    }
    .chat-list-body { flex: 1; min-width: 0; }
    .chat-list-name { font-size: 15px; font-weight: 600; color: var(--text); }
    .chat-list-preview {
      font-size: 13px; color: var(--text3); white-space: nowrap;
      overflow: hidden; text-overflow: ellipsis; margin-top: 2px;
    }
    .chat-list-meta { text-align: right; flex-shrink: 0; }
    .chat-list-time { font-size: 11px; color: var(--text3); }
    .chat-unread-badge {
      display: inline-block; min-width: 20px; height: 20px; line-height: 20px;
      border-radius: 10px; background: var(--accent); color: #fff;
      font-size: 11px; font-weight: 700; text-align: center; margin-top: 4px;
      padding: 0 6px;
    }

    /* Message Thread */
    .msg-thread-header {
      display: flex; align-items: center; gap: 12px; padding: 12px 0; margin-bottom: 8px;
    }
    .msg-thread-back {
      width: 36px; height: 36px; border-radius: 50%; border: none;
      background: rgba(255,255,255,0.06); cursor: pointer;
      display: flex; align-items: center; justify-content: center;
      color: var(--text); transition: all 0.15s; font-family: inherit;
    }
    .msg-thread-back:active { background: rgba(255,255,255,0.12); }
    .msg-thread-name { font-size: 17px; font-weight: 700; flex: 1; }
    .msg-thread-actions { display: flex; gap: 8px; }
    .msg-thread-action {
      width: 36px; height: 36px; border-radius: 50%; border: none;
      background: rgba(255,255,255,0.06); cursor: pointer;
      display: flex; align-items: center; justify-content: center;
      color: var(--text2); transition: all 0.15s; font-family: inherit;
    }
    .msg-thread-action:active { background: rgba(255,255,255,0.12); }
    .msg-bubbles {
      flex: 1; overflow-y: auto; padding-bottom: 80px;
    }
    .msg-bubble {
      max-width: 78%; padding: 10px 14px; border-radius: 18px;
      font-size: 14px; line-height: 1.45; margin-bottom: 4px;
      word-break: break-word;
    }
    .msg-bubble.sent {
      margin-left: auto; background: var(--accent); color: #fff;
      border-bottom-right-radius: 6px;
    }
    .msg-bubble.received {
      margin-right: auto; background: rgba(255,255,255,0.08); color: var(--text);
      border-bottom-left-radius: 6px;
    }
    .msg-time {
      font-size: 10px; color: var(--text3); margin-bottom: 12px;
      padding: 0 4px;
    }
    .msg-time.sent { text-align: right; }
    .msg-compose {
      position: absolute; bottom: 0; left: 0; right: 0;
      padding: 12px 16px; padding-bottom: max(12px, var(--safe-bottom));
      background: linear-gradient(to top, var(--bg) 80%, transparent);
      display: flex; align-items: center; gap: 10px;
    }
    .msg-input {
      flex: 1; padding: 12px 18px; border-radius: 24px;
      background: var(--surface); border: 1px solid var(--glass-border);
      color: var(--text); font-size: 14px; font-family: inherit; outline: none;
    }
    .msg-input::placeholder { color: var(--text3); }
    .msg-send-btn {
      width: 44px; height: 44px; border-radius: 50%;
      background: var(--gradient2); border: none; cursor: pointer;
      display: flex; align-items: center; justify-content: center;
      color: #fff; transition: all 0.2s; flex-shrink: 0;
    }
    .msg-send-btn:active { transform: scale(0.9); }

    /* AI Assistant Mini (inside social) */
    .ai-mini-card {
      background: linear-gradient(135deg, rgba(124,58,237,0.12), rgba(59,130,246,0.08));
      border: 1px solid rgba(124,58,237,0.2); border-radius: 16px;
      padding: 16px; margin-bottom: 16px; cursor: pointer; transition: all 0.2s;
    }
    .ai-mini-card:active { transform: scale(0.98); }
    .ai-mini-header { display: flex; align-items: center; gap: 10px; margin-bottom: 8px; }
    .ai-mini-icon {
      width: 36px; height: 36px; border-radius: 10px;
      background: var(--gradient2); display: flex; align-items: center;
      justify-content: center;
    }
    .ai-mini-title { font-size: 14px; font-weight: 700; color: var(--text); }
    .ai-mini-desc { font-size: 12px; color: var(--text3); line-height: 1.5; }

    /* Call History Item */
    .call-history-item {
      display: flex; align-items: center; gap: 12px; padding: 12px 0;
      border-bottom: 1px solid rgba(255,255,255,0.04);
    }
    .call-hist-avatar {
      width: 42px; height: 42px; border-radius: 50%;
      background: rgba(255,255,255,0.06); display: flex;
      align-items: center; justify-content: center;
      color: var(--text2);
    }
    .call-hist-info { flex: 1; }
    .call-hist-name { font-size: 14px; font-weight: 600; color: var(--text); }
    .call-hist-detail { font-size: 12px; color: var(--text3); margin-top: 2px; }
    .call-hist-detail .outgoing { color: #10b981; }
    .call-hist-detail .incoming { color: #3b82f6; }
    .call-hist-detail .missed { color: #ef4444; }
    .call-hist-time { font-size: 11px; color: var(--text3); }

    /* Contact list */
    .contact-item {
      display: flex; align-items: center; gap: 12px; padding: 12px 0;
      border-bottom: 1px solid rgba(255,255,255,0.04);
      cursor: pointer; transition: all 0.15s;
    }
    .contact-item:active { opacity: 0.7; }
    .contact-avatar {
      width: 44px; height: 44px; border-radius: 50%;
      background: linear-gradient(135deg, rgba(16,185,129,0.3), rgba(59,130,246,0.3));
      display: flex; align-items: center; justify-content: center;
      font-size: 16px; font-weight: 700; color: #10b981;
    }
    .contact-name { font-size: 14px; font-weight: 600; color: var(--text); }
    .contact-phone { font-size: 12px; color: var(--text3); margin-top: 1px; }
    .contact-actions { display: flex; gap: 8px; margin-left: auto; }
    .contact-action-btn {
      width: 36px; height: 36px; border-radius: 50%;
      background: rgba(255,255,255,0.06); border: none; cursor: pointer;
      display: flex; align-items: center; justify-content: center;
      color: var(--text2); transition: all 0.15s; font-family: inherit;
    }
    .contact-action-btn:active { background: rgba(255,255,255,0.12); }
    .contact-action-btn.call-btn { color: #10b981; }
    .contact-action-btn.msg-btn { color: #3b82f6; }

    /* Ripple pulse for ringing */
    @keyframes callPulse {
      0% { box-shadow: 0 0 0 0 rgba(16,185,129,0.5); }
      70% { box-shadow: 0 0 0 30px rgba(16,185,129,0); }
      100% { box-shadow: 0 0 0 0 rgba(16,185,129,0); }
    }
    .call-avatar.ringing { animation: callPulse 1.5s ease infinite; }

    /* Search bar */
    .social-search {
      display: flex; align-items: center; gap: 10px;
      background: rgba(255,255,255,0.04); border: 1px solid var(--glass-border);
      border-radius: 14px; padding: 10px 14px; margin-bottom: 16px;
    }
    .social-search input {
      flex: 1; border: none; background: none; color: var(--text);
      font-size: 14px; font-family: inherit; outline: none;
    }
    .social-search input::placeholder { color: var(--text3); }

    /* Free features badge */
    .free-badge {
      display: inline-block; padding: 2px 8px; border-radius: 6px;
      background: rgba(16,185,129,0.15); color: #10b981;
      font-size: 10px; font-weight: 700; text-transform: uppercase;
      letter-spacing: 0.5px;
    }
    /* ═══ Homepage AI Chat Widget ═══ */
    /* Hide homepage chat when user is logged in (app-mode) */
    .app-mode .pp-chat-fab,
    .app-mode .pp-chat-widget { display: none !important; }

    .pp-chat-fab {
      position: fixed; bottom: 24px; right: 24px; z-index: 9999;
      width: 60px; height: 60px; border-radius: 50%;
      background: linear-gradient(135deg, #7c3aed, #a78bfa);
      border: none; cursor: pointer; box-shadow: 0 4px 20px rgba(124,58,237,0.4);
      display: flex; align-items: center; justify-content: center;
      transition: transform 0.2s, box-shadow 0.2s;
    }
    .pp-chat-fab:hover { transform: scale(1.1); box-shadow: 0 6px 28px rgba(124,58,237,0.6); }
    .pp-chat-fab svg { width: 28px; height: 28px; fill: white; }
    .pp-chat-fab.open { display: none; }

    .pp-chat-widget {
      position: fixed; z-index: 9999;
      bottom: 0; left: 0; right: 0;
      width: 100%; height: 70dvh; max-height: calc(100dvh - 60px);
      background: #0d0d15; border-top: 1px solid rgba(124,58,237,0.3);
      border-radius: 20px 20px 0 0; display: none; flex-direction: column;
      box-shadow: 0 -4px 40px rgba(0,0,0,0.5);
      overflow: hidden; box-sizing: border-box;
    }
    @media (min-width: 480px) {
      .pp-chat-widget {
        bottom: 24px; left: auto; right: 16px;
        width: 380px; height: 520px; max-height: calc(100dvh - 80px);
        border: 1px solid rgba(124,58,237,0.3);
        border-radius: 20px;
        box-shadow: 0 8px 40px rgba(0,0,0,0.5);
      }
    }
    .pp-chat-widget.open { display: flex; }

    .pp-chat-header {
      padding: 16px 20px; display: flex; align-items: center; gap: 12px;
      background: rgba(124,58,237,0.1); border-bottom: 1px solid rgba(255,255,255,0.06);
    }
    .pp-chat-header-avatar {
      width: 36px; height: 36px; border-radius: 50%;
      background: linear-gradient(135deg, #7c3aed, #a78bfa);
      display: flex; align-items: center; justify-content: center;
      font-size: 18px;
    }
    .pp-chat-header-info { flex: 1; }
    .pp-chat-header-info h4 { margin: 0; font-size: 14px; font-weight: 600; color: #f0f2f5; }
    .pp-chat-header-info span { font-size: 11px; color: #22c55e; }
    .pp-chat-close {
      background: none; border: none; color: #8b92a5; cursor: pointer;
      font-size: 20px; padding: 4px 8px; border-radius: 8px;
    }
    .pp-chat-close:hover { background: rgba(255,255,255,0.06); color: white; }

    .pp-chat-messages {
      flex: 1; overflow-y: auto; overflow-x: hidden; padding: 12px; display: flex;
      flex-direction: column; gap: 12px; min-height: 0;
      -webkit-overflow-scrolling: touch;
    }
    @media (min-width: 480px) {
      .pp-chat-messages { padding: 16px; }
    }
    .pp-chat-messages::-webkit-scrollbar { width: 4px; }
    .pp-chat-messages::-webkit-scrollbar-thumb { background: rgba(255,255,255,0.1); border-radius: 4px; }

    .pp-chat-msg {
      max-width: 88%; padding: 10px 14px; border-radius: 16px;
      font-size: 13px; line-height: 1.5; word-break: break-word;
      overflow-wrap: break-word; box-sizing: border-box;
    }
    .pp-chat-msg.ai {
      align-self: flex-start; background: rgba(255,255,255,0.06);
      color: #e0e0e0; border-bottom-left-radius: 4px;
    }
    .pp-chat-msg.user {
      align-self: flex-end; background: #7c3aed;
      color: white; border-bottom-right-radius: 4px;
    }
    .pp-chat-msg.typing { color: #8b92a5; font-style: italic; }

    .pp-chat-input-area {
      padding: 10px 12px; border-top: 1px solid rgba(255,255,255,0.06);
      display: flex; gap: 8px; align-items: center; flex-shrink: 0;
      box-sizing: border-box;
    }
    @media (min-width: 480px) {
      .pp-chat-input-area { padding: 12px 16px; }
    }
    .pp-chat-input {
      flex: 1; min-width: 0; background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.1);
      border-radius: 12px; padding: 10px 14px; color: white; font-size: 14px;
      outline: none; font-family: inherit; box-sizing: border-box;
    }
    .pp-chat-input::placeholder { color: #6b7280; }
    .pp-chat-input:focus { border-color: rgba(124,58,237,0.5); }
    .pp-chat-send {
      background: #7c3aed; border: none; border-radius: 10px;
      width: 38px; height: 38px; flex-shrink: 0; cursor: pointer;
      display: flex; align-items: center; justify-content: center;
      transition: background 0.2s;
    }
    .pp-chat-send:hover { background: #6d28d9; }
    .pp-chat-send:disabled { opacity: 0.5; cursor: not-allowed; }
    .pp-chat-send svg { width: 18px; height: 18px; fill: white; }

    .pp-chat-suggestions {
      display: flex; flex-wrap: wrap; gap: 6px; padding: 0 16px 12px;
    }
    .pp-chat-suggestion {
      background: rgba(124,58,237,0.12); border: 1px solid rgba(124,58,237,0.25);
      color: #a78bfa; border-radius: 20px; padding: 6px 12px; font-size: 11px;
      cursor: pointer; transition: all 0.2s; white-space: nowrap;
    }
    .pp-chat-suggestion:hover { background: rgba(124,58,237,0.25); color: white; }
  </style>
</head>
<body class="landing-mode">

<!-- ═══ Landing Page ═══ -->
<div class="landing active" id="landing-page">

  <!-- Nav -->
  <nav class="lp-nav" id="lp-nav">
    <div class="lp-nav-inner">
      <div class="lp-logo">
        <div class="lp-logo-mark"><svg width="28" height="28" viewBox="0 0 40 40" fill="none"><rect x="4" y="4" width="10" height="10" rx="2" fill="#0a0a14"/><rect x="6" y="6" width="6" height="6" rx="1" fill="white"/><rect x="7.5" y="7.5" width="3" height="3" fill="#0a0a14"/><rect x="26" y="4" width="10" height="10" rx="2" fill="#0a0a14"/><rect x="28" y="28" width="6" height="6" rx="1" fill="white"/><rect x="29.5" y="29.5" width="3" height="3" fill="#0a0a14"/><rect x="4" y="26" width="10" height="10" rx="2" fill="#0a0a14"/><rect x="6" y="28" width="6" height="6" rx="1" fill="white"/><rect x="7.5" y="29.5" width="3" height="3" fill="#0a0a14"/><path d="M2 20 L10 20 L13 12 L17 28 L21 16 L24 24 L27 20 L38 20" stroke="#0a0a14" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/><circle cx="20" cy="20" r="2.5" fill="#0a0a14"/></svg></div>
        <span class="lp-logo-text">PromptPay</span>
      </div>
      <div class="lp-nav-links">
        <a href="#features">Features</a>
        <a href="#how-it-works">How it works</a>
      </div>
      <div class="lp-nav-actions">
        <button class="lp-btn-signin" onclick="showAuthGate('login')">Sign in</button>
        <button class="lp-btn-primary" onclick="showAuthGate('register')">Get Started</button>
      </div>
    </div>
  </nav>

  <!-- Hero -->
  <section class="lp-hero">
    <div class="lp-hero-glow"></div>
    <div class="lp-hero-grid">
      <div>
        <h1>Just say it.<br><span class="lp-holo-text">We'll handle it.</span></h1>
        <p class="lp-hero-desc">Pay bills, send money, and manage your finances — all through simple prompts. Your AI-powered financial assistant that actually gets things done.</p>
        <div class="lp-hero-btns">
          <button class="lp-btn-primary" onclick="showAuthGate('register')">
            Start for free
            <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="5" y1="12" x2="19" y2="12"/><polyline points="12 5 19 12 12 19"/></svg>
          </button>
          <button class="lp-btn-secondary" onclick="showAuthGate('login')">Sign in</button>
        </div>
        <button id="lp-install-btn" class="lp-btn-secondary" onclick="installApp()" style="display:none;margin-top:12px;width:100%;border:2px solid #7c3aed;background:rgba(124,58,237,0.15);color:#a78bfa;font-weight:600;gap:8px">
          <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 15v4a2 2 0 01-2 2H5a2 2 0 01-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" y1="15" x2="12" y2="3"/></svg>
          Install App
        </button>
      </div>

      <!-- AI Agent + Live Chat -->
      <div class="agent-section">
        <div class="agent-wrapper" id="agent-wrapper">
          <div class="agent-shadow"></div>
          <div class="agent-body">
            <div class="agent-capsule">
              <div class="agent-glow" id="agent-glow"></div>
              <div class="agent-face">
                <div class="agent-eyes" id="agent-eyes">
                  <div class="agent-eye"><div class="agent-eye-sparkle"></div></div>
                  <div class="agent-eye"><div class="agent-eye-sparkle"></div></div>
                </div>
                <div class="agent-mouth"><div class="agent-mouth-fill" id="agent-mouth-fill"></div></div>
              </div>
              <div class="agent-reflection"></div>
            </div>
            <div class="agent-icons">
              <div class="agent-icon-bubble">&#128176;</div>
              <div class="agent-icon-bubble">&#128179;</div>
            </div>
          </div>
        </div>

        <!-- Chat Panel -->
        <div class="agent-chat">
          <div class="agent-chat-header">
            <div class="agent-chat-status-icon greeting" id="agent-status-icon">
              <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="#22d3ee" stroke-width="2"><polygon points="12 2 15.09 8.26 22 9.27 17 14.14 18.18 21.02 12 17.77 5.82 21.02 7 14.14 2 9.27 8.91 8.26 12 2"/></svg>
            </div>
            <div>
              <div class="agent-chat-title" id="agent-chat-title">Welcome to PromptPay!</div>
              <div class="agent-chat-subtitle" id="agent-chat-subtitle">Your AI financial assistant</div>
            </div>
          </div>
          <div class="agent-messages" id="agent-messages"></div>
          <div class="agent-chat-progress">
            <div class="agent-chat-progress-fill" id="agent-progress-fill"></div>
          </div>
        </div>
      </div>
    </div>
  </section>

  <!-- Features -->
  <section class="lp-features" id="features">
    <div class="lp-features-inner">
      <div class="lp-features-header">
        <div class="lp-features-title">Everything you need</div>
        <div class="lp-features-subtitle">Powerful features wrapped in simplicity</div>
      </div>
      <div class="lp-features-grid">
        <div class="lp-feature-card">
          <span class="lp-feature-emoji">&#128172;</span>
          <div class="lp-feature-title">Natural Language</div>
          <div class="lp-feature-desc">Just type what you want. Our AI understands context, amounts, and recipients instantly.</div>
        </div>
        <div class="lp-feature-card">
          <span class="lp-feature-emoji">&#9889;</span>
          <div class="lp-feature-title">Instant Transfers</div>
          <div class="lp-feature-desc">Send money to anyone in seconds. No routing numbers, no forms, no friction.</div>
        </div>
        <div class="lp-feature-card">
          <span class="lp-feature-emoji">&#128179;</span>
          <div class="lp-feature-title">Smart Wallet</div>
          <div class="lp-feature-desc">Link cards, track spending, and manage multiple currencies in one place.</div>
        </div>
        <div class="lp-feature-card">
          <span class="lp-feature-emoji">&#128274;</span>
          <div class="lp-feature-title">Bank-Grade Security</div>
          <div class="lp-feature-desc">256-bit encryption, biometric auth, and real-time fraud detection keep you safe.</div>
        </div>
        <div class="lp-feature-card">
          <span class="lp-feature-emoji">&#128241;</span>
          <div class="lp-feature-title">Pay Bills Easily</div>
          <div class="lp-feature-desc">Utilities, airtime, subscriptions — pay any bill with a simple prompt.</div>
        </div>
        <div class="lp-feature-card">
          <span class="lp-feature-emoji">&#127760;</span>
          <div class="lp-feature-title">Global Coverage</div>
          <div class="lp-feature-desc">Send money across borders. Support for 50+ countries and growing.</div>
        </div>
      </div>
    </div>
  </section>

  <!-- How it works -->
  <section class="lp-showcase" id="how-it-works">
    <div class="lp-showcase-inner">
      <div class="lp-showcase-left">
        <h2>Three steps. That's it.</h2>
        <p>No apps to download, no forms to fill. Just tell our AI what you need.</p>
        <div class="lp-showcase-steps">
          <div class="lp-step">
            <div class="lp-step-num">1</div>
            <div class="lp-step-text"><strong>Type your request</strong> — "Send $50 to Sarah" or "Pay my electric bill"</div>
          </div>
          <div class="lp-step">
            <div class="lp-step-num">2</div>
            <div class="lp-step-text"><strong>AI verifies intent</strong> — confirms amount, recipient, and method</div>
          </div>
          <div class="lp-step">
            <div class="lp-step-num">3</div>
            <div class="lp-step-text"><strong>Done</strong> — funds sent instantly with real-time confirmation</div>
          </div>
        </div>
      </div>

      <!-- Holographic Payment Card -->
      <div style="display:flex;justify-content:center">
        <div class="lp-holo-card">
          <div class="lp-holo-card-glint"></div>
          <div class="lp-holo-card-chip"></div>
          <div class="lp-holo-card-logo lp-holo-text">PromptPay</div>
          <div class="lp-holo-card-number">4242 &bull;&bull;&bull;&bull; &bull;&bull;&bull;&bull; 8910</div>
          <div class="lp-holo-card-footer">
            <div>
              <div class="lp-holo-card-label">Card Holder</div>
              <div class="lp-holo-card-value">ALEX MORGAN</div>
            </div>
            <div>
              <div class="lp-holo-card-label">Expires</div>
              <div class="lp-holo-card-value">12/28</div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </section>

  <!-- Footer — GitHub Industrial -->
  <footer class="lp-footer">
    <div class="lp-footer-inner">
      <div class="lp-footer-top">
        <div class="lp-footer-brand">
          <div class="lp-footer-brand-icon">
            <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="#0d1117" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round">
              <rect x="3" y="3" width="7" height="7"/><rect x="14" y="3" width="7" height="7"/><rect x="3" y="14" width="7" height="7"/><rect x="14" y="14" width="7" height="7"/>
            </svg>
          </div>
          <div class="lp-footer-brand-text">
            <span>PromptPay</span>
            <p>Built with precision</p>
          </div>
        </div>

        <div class="lp-footer-links">
          <a href="#">Privacy</a>
          <a href="#">Security</a>
          <a href="#">Terms</a>
          <a href="/careers">Careers</a>
          <a href="/partners">Partners</a>
          <a href="#">Status</a>
        </div>
      </div>

      <div class="lp-footer-bottom">
        <span class="lp-footer-copy">&copy; 2025 PromptPay Inc. All rights reserved.</span>
        <div class="lp-footer-social">
          <a href="#" title="GitHub"><svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M9 19c-5 1.5-5-2.5-7-3m14 6v-3.87a3.37 3.37 0 0 0-.94-2.61c3.14-.35 6.44-1.54 6.44-7A5.44 5.44 0 0 0 20 4.77 5.07 5.07 0 0 0 19.91 1S18.73.65 16 2.48a13.38 13.38 0 0 0-7 0C6.27.65 5.09 1 5.09 1A5.07 5.07 0 0 0 5 4.77a5.44 5.44 0 0 0-1.5 3.78c0 5.42 3.3 6.61 6.44 7A3.37 3.37 0 0 0 9 18.13V22"/></svg></a>
          <a href="#" title="Twitter"><svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M22 4s-.7 2.1-2 3.4c1.6 10-9.4 17.3-18 11.6 2.2.1 4.4-.6 6-2C3 15.5.5 9.6 3 5c2.2 2.6 5.6 4.1 9 4-.9-4.2 4-6.6 7-3.8 1.1 0 3-1.2 3-1.2z"/></svg></a>
          <a href="#" title="LinkedIn"><svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M16 8a6 6 0 0 1 6 6v7h-4v-7a2 2 0 0 0-2-2 2 2 0 0 0-2 2v7h-4v-7a6 6 0 0 1 6-6z"/><rect x="2" y="9" width="4" height="12"/><circle cx="4" cy="4" r="2"/></svg></a>
        </div>
      </div>
    </div>
  </footer>
</div>

<!-- Auth Gate -->
<div class="auth-gate hidden" id="auth-gate">
  <div class="auth-card">
    <div class="auth-brand">
      <div class="auth-brand-icon"><div class="lp-logo-mark" style="width:48px;height:48px;border-radius:16px"><svg width="32" height="32" viewBox="0 0 40 40" fill="none"><rect x="4" y="4" width="10" height="10" rx="2" fill="#0a0a14"/><rect x="6" y="6" width="6" height="6" rx="1" fill="white"/><rect x="7.5" y="7.5" width="3" height="3" fill="#0a0a14"/><rect x="26" y="4" width="10" height="10" rx="2" fill="#0a0a14"/><rect x="28" y="28" width="6" height="6" rx="1" fill="white"/><rect x="29.5" y="29.5" width="3" height="3" fill="#0a0a14"/><rect x="4" y="26" width="10" height="10" rx="2" fill="#0a0a14"/><rect x="6" y="28" width="6" height="6" rx="1" fill="white"/><rect x="7.5" y="29.5" width="3" height="3" fill="#0a0a14"/><path d="M2 20 L10 20 L13 12 L17 28 L21 16 L24 24 L27 20 L38 20" stroke="#0a0a14" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/><circle cx="20" cy="20" r="2.5" fill="#0a0a14"/></svg></div></div>
      <div class="auth-brand-name">PromptPay</div>
      <div class="auth-brand-tagline">AI-Powered Financial Assistant</div>
    </div>
    <div class="auth-tabs">
      <button class="auth-tab active" onclick="switchAuthTab('login')">Sign In</button>
      <button class="auth-tab" onclick="switchAuthTab('register')">Register</button>
    </div>
    <!-- Login Form -->
    <form class="auth-form active" id="auth-login-form" onsubmit="handleLogin(event)">
      <div class="auth-field">
        <label>Email</label>
        <input type="email" id="login-email" placeholder="info@upromptpay.com" required autocomplete="email">
      </div>
      <div class="auth-field">
        <label>Password</label>
        <div class="pw-wrapper">
          <input type="password" id="login-password" placeholder="Enter your password" required autocomplete="current-password">
          <button type="button" class="pw-toggle" onclick="togglePassword('login-password', this)" aria-label="Show password">
            <svg class="eye-open" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"/><circle cx="12" cy="12" r="3"/></svg>
            <svg class="eye-closed" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="display:none"><path d="M17.94 17.94A10.07 10.07 0 0112 20c-7 0-11-8-11-8a18.45 18.45 0 015.06-5.94M9.9 4.24A9.12 9.12 0 0112 4c7 0 11 8 11 8a18.5 18.5 0 01-2.16 3.19m-6.72-1.07a3 3 0 11-4.24-4.24"/><line x1="1" y1="1" x2="23" y2="23"/></svg>
          </button>
        </div>
      </div>
      <button type="submit" class="auth-submit" id="login-submit">Sign In</button>
      <div class="auth-error" id="login-error"></div>
    </form>
    <!-- Register Form -->
    <form class="auth-form" id="auth-register-form" onsubmit="handleRegister(event)">
      <div class="auth-field">
        <label>Display Name</label>
        <input type="text" id="register-name" placeholder="Your name" required autocomplete="name">
      </div>
      <div class="auth-field">
        <label>Email</label>
        <input type="email" id="register-email" placeholder="info@upromptpay.com" required autocomplete="email">
      </div>
      <div class="auth-field">
        <label>Country</label>
        <select id="register-country" required style="width:100%;padding:14px 16px;background:rgba(255,255,255,0.04);border:1px solid rgba(255,255,255,0.08);border-radius:12px;color:var(--text);font-size:14px;font-family:inherit;outline:none;-webkit-appearance:none;appearance:none;">
          <option value="">Select your country</option>
          <optgroup label="Africa">
            <option value="NG">Nigeria</option>
            <option value="GH">Ghana</option>
            <option value="KE">Kenya</option>
            <option value="UG">Uganda</option>
            <option value="ZA">South Africa</option>
            <option value="TZ">Tanzania</option>
            <option value="CM">Cameroon</option>
            <option value="CI">Ivory Coast</option>
            <option value="SN">Senegal</option>
            <option value="ET">Ethiopia</option>
          </optgroup>
          <optgroup label="Americas">
            <option value="US">United States</option>
            <option value="CA">Canada</option>
            <option value="MX">Mexico</option>
            <option value="BR">Brazil</option>
          </optgroup>
          <optgroup label="Europe">
            <option value="GB">United Kingdom</option>
            <option value="DE">Germany</option>
            <option value="FR">France</option>
            <option value="IT">Italy</option>
            <option value="ES">Spain</option>
            <option value="NL">Netherlands</option>
          </optgroup>
          <optgroup label="Asia & Pacific">
            <option value="IN">India</option>
            <option value="PH">Philippines</option>
            <option value="AU">Australia</option>
            <option value="JP">Japan</option>
          </optgroup>
        </select>
      </div>
      <div class="auth-field">
        <label>Password</label>
        <div class="pw-wrapper">
          <input type="password" id="register-password" placeholder="Create a password" required minlength="6" autocomplete="new-password">
          <button type="button" class="pw-toggle" onclick="togglePassword('register-password', this)" aria-label="Show password">
            <svg class="eye-open" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"/><circle cx="12" cy="12" r="3"/></svg>
            <svg class="eye-closed" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="display:none"><path d="M17.94 17.94A10.07 10.07 0 0112 20c-7 0-11-8-11-8a18.45 18.45 0 015.06-5.94M9.9 4.24A9.12 9.12 0 0112 4c7 0 11 8 11 8a18.5 18.5 0 01-2.16 3.19m-6.72-1.07a3 3 0 11-4.24-4.24"/><line x1="1" y1="1" x2="23" y2="23"/></svg>
          </button>
        </div>
      </div>
      <button type="submit" class="auth-submit" id="register-submit">Create Account</button>
      <div class="auth-error" id="register-error"></div>
    </form>
    <div style="text-align:center;margin-top:20px">
      <button onclick="showLanding();startLandingTyping()" style="background:none;border:none;color:var(--text3);font-size:13px;cursor:pointer;font-family:inherit">
        <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="vertical-align:-2px;margin-right:4px"><line x1="19" y1="12" x2="5" y2="12"/><polyline points="12 19 5 12 12 5"/></svg>
        Back to home
      </button>
    </div>
  </div>
</div>

<div class="app" id="app">

  <!-- Header -->
  <div class="header">
    <div class="header-left">
      <button class="hamburger-btn" onclick="openNavDrawer()" aria-label="Menu">
        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"><line x1="3" y1="6" x2="21" y2="6"/><line x1="3" y1="12" x2="21" y2="12"/><line x1="3" y1="18" x2="21" y2="18"/></svg>
      </button>
      <div class="header-avatar">
        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="1.5"><path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"/><circle cx="12" cy="7" r="4"/></svg>
      </div>
      <div>
        <div class="header-greeting">Good <span id="time-greeting">evening</span></div>
        <div class="header-name">PromptPay</div>
      </div>
    </div>
    <div class="header-right">
      <div class="header-btn" onclick="showNotifications()" style="position:relative">
        <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M18 8A6 6 0 0 0 6 8c0 7-3 9-3 9h18s-3-2-3-9"/><path d="M13.73 21a2 2 0 0 1-3.46 0"/></svg>
        <div class="dot"></div>
      </div>
    </div>
  </div>

  <!-- Navigation Drawer -->
  <div class="nav-drawer-overlay" id="nav-drawer-overlay" onclick="closeNavDrawer()">
    <div class="nav-drawer" onclick="event.stopPropagation()">
      <div class="nav-drawer-header">
        <div class="drawer-logo lp-logo-mark"><svg width="22" height="22" viewBox="0 0 40 40" fill="none"><rect x="4" y="4" width="10" height="10" rx="2" fill="#0a0a14"/><rect x="6" y="6" width="6" height="6" rx="1" fill="white"/><rect x="7.5" y="7.5" width="3" height="3" fill="#0a0a14"/><rect x="26" y="4" width="10" height="10" rx="2" fill="#0a0a14"/><rect x="28" y="6" width="6" height="6" rx="1" fill="white"/><rect x="29.5" y="7.5" width="3" height="3" fill="#0a0a14"/><rect x="4" y="26" width="10" height="10" rx="2" fill="#0a0a14"/><rect x="6" y="28" width="6" height="6" rx="1" fill="white"/><rect x="7.5" y="29.5" width="3" height="3" fill="#0a0a14"/><path d="M2 20 L10 20 L13 12 L17 28 L21 16 L24 24 L27 20 L38 20" stroke="#0a0a14" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/><circle cx="20" cy="20" r="2.5" fill="#0a0a14"/></svg></div>
        <div class="drawer-info">
          <div class="drawer-name" id="drawer-user-name">PromptPay</div>
          <div class="drawer-email" id="drawer-user-email"></div>
        </div>
      </div>
      <div class="nav-drawer-section">
        <div class="nav-drawer-section-label">Main</div>
        <button class="nav-drawer-item active" data-drawer="home" onclick="drawerNav('home')">
          <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"/><polyline points="9 22 9 12 15 12 15 22"/></svg>
          Home
        </button>
        <button class="nav-drawer-item" data-drawer="activity" onclick="drawerNav('activity')">
          <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="22 12 18 12 15 21 9 3 6 12 2 12"/></svg>
          Activity
        </button>
        <button class="nav-drawer-item" data-drawer="ai" onclick="drawerNav('ai')">
          <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"/></svg>
          AI Assistant
        </button>
        <button class="nav-drawer-item" data-drawer="wallet" onclick="drawerNav('wallet')">
          <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 12V7H5a2 2 0 0 1 0-4h14v4"/><path d="M3 5v14a2 2 0 0 0 2 2h16v-5"/><circle cx="18" cy="16" r="1"/></svg>
          Wallet
        </button>
      </div>
      <div class="nav-drawer-divider"></div>
      <div class="nav-drawer-section">
        <div class="nav-drawer-section-label">Money</div>
        <button class="nav-drawer-item" onclick="closeNavDrawer(); openSendModal();">
          <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="22" y1="2" x2="11" y2="13"/><polygon points="22 2 15 22 11 13 2 9 22 2"/></svg>
          Send Money
        </button>
        <button class="nav-drawer-item" onclick="closeNavDrawer(); openRequestModal();">
          <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="23 6 13.5 15.5 8.5 10.5 1 18"/><polyline points="17 6 23 6 23 12"/></svg>
          Request Money
        </button>
        <button class="nav-drawer-item" onclick="closeNavDrawer(); showQrModal();">
          <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="3" width="7" height="7"/><rect x="14" y="3" width="7" height="7"/><rect x="3" y="14" width="7" height="7"/><rect x="14" y="14" width="3" height="3"/><line x1="21" y1="14" x2="21" y2="21"/><line x1="14" y1="21" x2="21" y2="21"/></svg>
          QR Code
        </button>
      </div>
      <div class="nav-drawer-divider"></div>
      <div class="nav-drawer-section">
        <div class="nav-drawer-section-label">Account</div>
        <button class="nav-drawer-item" data-drawer="profile" onclick="drawerNav('profile')">
          <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"/><circle cx="12" cy="7" r="4"/></svg>
          Profile
        </button>
        <button class="nav-drawer-item" data-drawer="settings" onclick="drawerNav('settings')">
          <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="3"/><path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1-2.83 2.83l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-4 0v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83-2.83l.06-.06A1.65 1.65 0 0 0 4.68 15a1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1 0-4h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 2.83-2.83l.06.06A1.65 1.65 0 0 0 9 4.68a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 4 0v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 2.83l-.06.06A1.65 1.65 0 0 0 19.4 9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 0 4h-.09a1.65 1.65 0 0 0-1.51 1z"/></svg>
          Settings
        </button>
        <button class="nav-drawer-item danger" onclick="closeNavDrawer(); handleLogout();">
          <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"/><polyline points="16 17 21 12 16 7"/><line x1="21" y1="12" x2="9" y2="12"/></svg>
          Logout
        </button>
      </div>
      <div class="nav-drawer-divider"></div>
      <div class="nav-drawer-section">
        <div class="nav-drawer-section-label">Build</div>
        <button class="nav-drawer-item" data-drawer="developer" onclick="drawerNav('developer')">
          <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="16 18 22 12 16 6"/><polyline points="8 6 2 12 8 18"/></svg>
          Developer Portal
        </button>
      </div>
      <div class="nav-drawer-footer">PromptPay v2.0</div>
    </div>
  </div>

  <!-- Pages -->
  <div class="pages">

    <!-- HOME -->
    <div class="page active" id="page-home">
      <div class="balance-card fade-up">
        <div class="balance-label">Total Balance</div>
        <div class="balance-amount" id="balance-display">$0.00</div>
        <div class="balance-change">
          <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3"><polyline points="18 15 12 9 6 15"/></svg>
          <span id="balance-change">+$0.00 today</span>
        </div>
        <div id="paytag-display" style="margin: 8px 0; display: none;">
          <span style="font-size: 1.1rem; font-weight: 600; color: #7c3aed; cursor: pointer;" onclick="copyPaytag()">
            <span id="user-paytag">$yourname</span> <span style="font-size: 0.75rem; opacity: 0.6;">tap to copy</span>
          </span>
        </div>
        <div class="balance-actions">
          <button class="bal-btn bal-btn-primary" onclick="openSendModal()">
            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><line x1="22" y1="2" x2="11" y2="13"/><polygon points="22 2 15 22 11 13 2 9 22 2"/></svg>
            Send
          </button>
          <button class="bal-btn bal-btn-secondary" onclick="openRequestModal()">
            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><polyline points="1 4 1 10 7 10"/><path d="M3.51 15a9 9 0 1 0 2.13-9.36L1 10"/></svg>
            Request
          </button>
        </div>
      </div>

      <div class="quick-grid fade-up" style="animation-delay:0.1s">
        <div class="quick-item" onclick="openSendModal()">
          <div class="quick-icon qi-cyan" style="background:rgba(6,182,212,0.15)">
            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="#06b6d4" stroke-width="2"><line x1="22" y1="2" x2="11" y2="13"/><polygon points="22 2 15 22 11 13 2 9 22 2"/></svg>
          </div>
          <div class="quick-label">Send</div>
        </div>
        <div class="quick-item" onclick="navigateTo('wallet')">
          <div class="quick-icon qi-green" style="background:rgba(16,185,129,0.15)">
            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="#10b981" stroke-width="2"><rect x="2" y="4" width="20" height="16" rx="2"/><path d="M22 10H18a2 2 0 0 0 0 4h4"/></svg>
          </div>
          <div class="quick-label">Wallet</div>
        </div>
        <div class="quick-item" onclick="navigateTo('pos')">
          <div class="quick-icon qi-yellow" style="background:rgba(245,158,11,0.15)">
            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="#f59e0b" stroke-width="2"><rect x="2" y="3" width="20" height="14" rx="2" ry="2"/><line x1="8" y1="21" x2="16" y2="21"/><line x1="12" y1="17" x2="12" y2="21"/></svg>
          </div>
          <div class="quick-label">POS</div>
        </div>
        <div class="quick-item" onclick="navigateTo('calls')">
          <div class="quick-icon qi-blue" style="background:rgba(59,130,246,0.15)">
            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="#3b82f6" stroke-width="2"><path d="M22 16.92v3a2 2 0 0 1-2.18 2 19.79 19.79 0 0 1-8.63-3.07 19.5 19.5 0 0 1-6-6 19.79 19.79 0 0 1-3.07-8.67A2 2 0 0 1 4.11 2h3a2 2 0 0 1 2 1.72c.127.96.361 1.903.7 2.81a2 2 0 0 1-.45 2.11L8.09 9.91a16 16 0 0 0 6 6l1.27-1.27a2 2 0 0 1 2.11-.45c.907.339 1.85.573 2.81.7A2 2 0 0 1 22 16.92z"/></svg>
          </div>
          <div class="quick-label">Calls</div>
        </div>
        <div class="quick-item" onclick="showQrModal()">
          <div class="quick-icon qi-violet" style="background:rgba(124,58,237,0.15)">
            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="#7c3aed" stroke-width="2"><rect x="3" y="3" width="7" height="7"/><rect x="14" y="3" width="7" height="7"/><rect x="3" y="14" width="7" height="7"/><rect x="14" y="14" width="3" height="3"/><line x1="21" y1="14" x2="21" y2="21"/><line x1="14" y1="21" x2="21" y2="21"/></svg>
          </div>
          <div class="quick-label">QR Pay</div>
        </div>
        <div class="quick-item" id="airtime-quick-btn" onclick="openAirtimeModal()">
          <div class="quick-icon qi-orange" style="background:rgba(249,115,22,0.15)">
            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="#f97316" stroke-width="2"><rect x="5" y="2" width="14" height="20" rx="2" ry="2"/><line x1="12" y1="18" x2="12" y2="18"/></svg>
          </div>
          <div class="quick-label">Airtime</div>
        </div>
        <div class="quick-item" onclick="sendSuggestion({dataset:{text:'Create a shopping list'}})">
          <div class="quick-icon qi-pink" style="background:rgba(236,72,153,0.15)">
            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="#ec4899" stroke-width="2"><circle cx="9" cy="21" r="1"/><circle cx="20" cy="21" r="1"/><path d="M1 1h4l2.68 13.39a2 2 0 0 0 2 1.61h9.72a2 2 0 0 0 2-1.61L23 6H6"/></svg>
          </div>
          <div class="quick-label">Shop</div>
        </div>
        <div class="quick-item" id="bills-quick-btn" onclick="sendSuggestion({dataset:{text:'Pay my bills'}})">
          <div class="quick-icon qi-red" style="background:rgba(239,68,68,0.12)">
            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="#ef4444" stroke-width="2"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/><polyline points="14 2 14 8 20 8"/><line x1="12" y1="18" x2="12" y2="12"/><line x1="9" y1="15" x2="15" y2="15"/></svg>
          </div>
          <div class="quick-label">Bills</div>
        </div>
        <div class="quick-item" onclick="window.open('/partners','_blank')">
          <div class="quick-icon" style="background:rgba(168,85,247,0.15)">
            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="#a855f7" stroke-width="2"><path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"/><circle cx="9" cy="7" r="4"/><path d="M23 21v-2a4 4 0 0 0-3-3.87"/><path d="M16 3.13a4 4 0 0 1 0 7.75"/></svg>
          </div>
          <div class="quick-label">Partners</div>
        </div>
        <div class="quick-item" onclick="window.open('/careers','_blank')">
          <div class="quick-icon" style="background:rgba(16,185,129,0.15)">
            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="#10b981" stroke-width="2"><path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"/><circle cx="12" cy="7" r="4"/></svg>
          </div>
          <div class="quick-label">Careers</div>
        </div>
      </div>

      <!-- AI Agent Preview -->
      <div class="ai-card fade-up" style="animation-delay:0.15s" onclick="navigateTo('ai')">
        <div class="ai-card-header">
          <div class="ai-avatar">&#9889;</div>
          <div>
            <div class="ai-name">PromptPay AI</div>
            <div class="ai-status">Always available</div>
          </div>
          <div style="margin-left:auto;padding:6px 14px;border-radius:20px;background:rgba(124,58,237,0.15);color:var(--accent2);font-size:12px;font-weight:600">Ask me</div>
        </div>
        <div class="ai-suggestion">
          "Send &#8358;5,000 to Sarah" &middot; "Buy MTN airtime" &middot; "Check my balance"
        </div>
      </div>

      <!-- Transactions -->
      <div class="section-header fade-up" style="animation-delay:0.2s">
        <div class="section-title">Recent Activity</div>
        <div class="section-link" onclick="navigateTo('activity')">See All</div>
      </div>
      <div class="tx-list fade-up" style="animation-delay:0.25s" id="recent-tx-list">
        <div style="padding:36px 20px;text-align:center">
          <div style="font-size:36px;margin-bottom:10px;opacity:0.3">&#128176;</div>
          <div style="color:var(--text2);font-size:14px;font-weight:500;margin-bottom:6px">No activity yet</div>
          <div style="color:var(--text3);font-size:12px">Fund your wallet or send money to get started</div>
        </div>
      </div>

    </div>

    <!-- AI CHAT -->
    <div class="page" id="page-ai">
      <div class="chat-container">
        <div class="chat-header-bar">
          <div class="ai-avatar" style="width:36px;height:36px;border-radius:10px;font-size:16px">&#9889;</div>
          <div>
            <div style="font-size:15px;font-weight:600">PromptPay AI</div>
            <div class="ai-status" style="font-size:11px">Always available &middot; Ask anything</div>
          </div>
        </div>

        <div class="chat-messages" id="chat-messages">
          <div class="msg msg-ai">
            Hey! I'm your PromptPay AI assistant. I can help you send money, make international calls, buy virtual numbers, send SMS, shop, track subscriptions, pay bills, and more. Just tell me what you need.
          </div>
        </div>

        <div class="chat-input-area">
          <div class="chat-suggestions" id="chat-suggestions">
            <div class="chat-suggestion" onclick="sendSuggestion(this)" data-text="Create a shopping list for groceries">Shopping List</div>
            <div class="chat-suggestion" onclick="navigateTo('calls')">Calls & SMS</div>
            <div class="chat-suggestion" onclick="sendSuggestion(this)" data-text="Send money to a friend">Send Money</div>
            <div class="chat-suggestion" onclick="sendSuggestion(this)" data-text="Show my subscriptions">Subscriptions</div>
          </div>
          <div class="chat-input-wrap">
            <input class="chat-input" id="chat-input" placeholder="Ask anything..." autocomplete="off" onkeydown="if(event.key==='Enter')sendMessage()">
            <button class="chat-send-btn" id="chat-send" onclick="sendMessage()">
              <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><line x1="22" y1="2" x2="11" y2="13"/><polygon points="22 2 15 22 11 13 2 9 22 2"/></svg>
            </button>
          </div>
        </div>
      </div>
    </div>

    <!-- WALLET -->
    <div class="page" id="page-wallet">
      <div style="margin-bottom:14px">
        <button class="page-back-btn" onclick="navigateTo('home')">
          <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="19" y1="12" x2="5" y2="12"/><polyline points="12 19 5 12 12 5"/></svg>
          Back
        </button>
      </div>
      <!-- KYC Status Banner -->
      <div id="kyc-banner" style="padding:12px 16px;border-radius:14px;margin-bottom:16px;display:none;cursor:pointer" onclick="openKycModal()">
        <div style="display:flex;align-items:center;gap:10px">
          <div id="kyc-banner-icon" style="width:36px;height:36px;border-radius:10px;display:flex;align-items:center;justify-content:center;font-size:18px"></div>
          <div style="flex:1">
            <div id="kyc-banner-title" style="font-size:13px;font-weight:600"></div>
            <div id="kyc-banner-desc" style="font-size:11px;opacity:0.7"></div>
          </div>
          <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="9 18 15 12 9 6"/></svg>
        </div>
      </div>

      <!-- Cards Section -->
      <div class="section-header" style="margin-bottom:18px">
        <div class="section-title">Cards</div>
        <div class="section-link" onclick="openAddCardModal()">+ Add</div>
      </div>
      <div class="card-carousel" id="payment-cards">
        <div style="min-width:280px;padding:30px 24px;border-radius:20px;border:1px dashed rgba(255,255,255,0.1);display:flex;align-items:center;justify-content:center;flex-direction:column;gap:8px;cursor:pointer;color:var(--text3)" onclick="openAddCardModal()">
          <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/></svg>
          <span style="font-size:13px">Add Card</span>
        </div>
      </div>

      <!-- Bank Accounts Section -->
      <div id="bank-accounts-section">
        <div class="section-header">
          <div class="section-title">Bank Accounts</div>
          <div class="section-link" onclick="openBankModal()">+ Link</div>
        </div>
        <div id="bank-accounts-list" style="margin-bottom:16px">
          <div style="padding:16px;text-align:center;color:var(--text3);font-size:13px">No bank accounts linked</div>
        </div>
      </div>

      <!-- Mobile Money Section -->
      <div id="momo-section">
        <div class="section-header">
          <div class="section-title">Mobile Money</div>
          <div class="section-link" onclick="openMomoModal()">+ Link</div>
        </div>
        <div id="momo-wallets-list" style="margin-bottom:16px">
          <div style="padding:16px;text-align:center;color:var(--text3);font-size:13px">No mobile wallets linked</div>
        </div>
      </div>

      <div class="section-header">
        <div class="section-title">Savings Goals</div>
        <div class="section-link" onclick="navigateTo('ai');document.getElementById('chat-input').value='Create a savings goal';sendMessage()">+ New Goal</div>
      </div>
      <div id="savings-goals">
        <div style="padding:20px 0;text-align:center;color:var(--text3);font-size:13px">
          No savings goals yet. Ask the AI to create one for you.
        </div>
      </div>

      <!-- Token Matrix -->
      <div class="section-header" style="margin-top:24px">
        <div class="section-title">Account Summary</div>
        <div class="section-link" style="color:var(--emerald)">Active</div>
      </div>
      <div class="token-matrix" id="token-matrix">
        <div class="token-row">
          <span class="token-label">Total Funded</span>
          <span class="token-value" id="tm-used">&#8358;0</span>
        </div>
        <div class="token-row">
          <span class="token-label">Total Spent</span>
          <span class="token-value" id="tm-cached">&#8358;0</span>
        </div>
        <div class="token-row">
          <span class="token-label">Rewards Earned</span>
          <span class="token-value token-saved" id="tm-saved">&#8358;0</span>
        </div>
        <div class="token-row">
          <span class="token-label">Loyalty Tier</span>
          <span class="token-value" id="tm-efficiency" style="color:var(--accent2)">Bronze</span>
        </div>
        <div class="token-row">
          <span class="token-label">Referral Bonus</span>
          <span class="token-value token-saved" id="tm-cost">$0.00</span>
        </div>
      </div>
    </div>

    <!-- POS MODE -->
    <div class="page" id="page-pos">
      <div style="margin-bottom:14px">
        <button class="page-back-btn" onclick="navigateTo('home')">
          <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="19" y1="12" x2="5" y2="12"/><polyline points="12 19 5 12 12 5"/></svg>
          Back
        </button>
      </div>

      <!-- POS Agent Card -->
      <div id="pos-agent-card" class="pos-agent-card not-registered" style="display:none"></div>

      <!-- Wallet Balance Strip -->
      <div class="pos-wallet-strip">
        <div class="pos-wallet-bal">
          <div class="pw-label">Wallet Balance</div>
          <div class="pw-amount" id="pos-balance">&#8358;0.00</div>
        </div>
        <button class="pos-fund-btn" onclick="openFundWalletModal()">+ Fund</button>
      </div>

      <!-- Today's Stats -->
      <div class="pos-stats-row">
        <div class="pos-stat-card">
          <div class="ps-val ps-accent" id="pos-today-sales">0</div>
          <div class="ps-label">Sales Today</div>
        </div>
        <div class="pos-stat-card">
          <div class="ps-val" id="pos-today-revenue">&#8358;0</div>
          <div class="ps-label">Revenue</div>
        </div>
        <div class="pos-stat-card">
          <div class="ps-val ps-green" id="pos-today-profit">&#8358;0</div>
          <div class="ps-label">Profit</div>
        </div>
      </div>

      <!-- Product Tabs -->
      <div style="display:flex;gap:0;margin-bottom:14px;border-radius:12px;overflow:hidden;border:1px solid var(--glass-border)">
        <button class="pos-product-tab active" id="tab-airtime" onclick="switchPosTab('airtime')" style="flex:1;padding:12px;border:none;font-size:14px;font-weight:600;cursor:pointer;font-family:inherit;background:rgba(124,58,237,0.15);color:var(--accent2)">Airtime</button>
        <button class="pos-product-tab" id="tab-data" onclick="switchPosTab('data')" style="flex:1;padding:12px;border:none;font-size:14px;font-weight:600;cursor:pointer;font-family:inherit;background:var(--surface);color:var(--text2)">Data</button>
      </div>

      <!-- Shared Phone + Country -->
      <div class="pos-sell-card" style="margin-bottom:0;border-bottom-left-radius:0;border-bottom-right-radius:0">
        <div class="pos-input-group">
          <label>Customer Phone Number</label>
          <input class="pos-input" id="pos-phone" type="tel" placeholder="e.g. 08012345678" oninput="posPhoneChanged()">
          <div id="pos-carrier-info"></div>
        </div>
        <div class="pos-input-group" style="margin-bottom:0">
          <label>Country</label>
          <select class="pos-input" id="pos-country" style="font-family:inherit" onchange="posPhoneChanged()">
            <option value="NG">Nigeria (+234)</option>
            <option value="GH">Ghana (+233)</option>
            <option value="KE">Kenya (+254)</option>
            <option value="ZA">South Africa (+27)</option>
            <option value="TZ">Tanzania (+255)</option>
            <option value="UG">Uganda (+256)</option>
            <option value="CM">Cameroon (+237)</option>
            <option value="SN">Senegal (+221)</option>
            <option value="ET">Ethiopia (+251)</option>
          </select>
        </div>
      </div>

      <!-- Airtime Tab -->
      <div class="pos-sell-card" id="pos-airtime-section" style="border-top-left-radius:0;border-top-right-radius:0;border-top:1px solid var(--glass-border)">
        <h3>Sell Airtime</h3>
        <div class="pos-input-group">
          <label>Amount</label>
          <div class="pos-amount-grid">
            <button class="pos-quick-amt" onclick="posSetAmount(100)">&#8358;100</button>
            <button class="pos-quick-amt" onclick="posSetAmount(200)">&#8358;200</button>
            <button class="pos-quick-amt" onclick="posSetAmount(500)">&#8358;500</button>
            <button class="pos-quick-amt" onclick="posSetAmount(1000)">&#8358;1K</button>
          </div>
          <input class="pos-input" id="pos-amount" type="number" placeholder="Custom amount" oninput="posAmountChanged()">
          <div id="pos-cost-preview" style="font-size:12px;color:var(--text2);margin-top:6px"></div>
        </div>
        <button class="pos-sell-btn" id="pos-sell-btn" onclick="posSellAirtime()" disabled>
          SELL AIRTIME
        </button>
      </div>

      <!-- Data Tab -->
      <div class="pos-sell-card" id="pos-data-section" style="display:none;border-top-left-radius:0;border-top-right-radius:0;border-top:1px solid var(--glass-border)">
        <h3>Sell Data Bundle</h3>
        <div id="pos-data-bundles-list" style="margin-bottom:12px">
          <div style="padding:16px;text-align:center;color:var(--text3);font-size:13px">Enter a phone number above to see available data plans</div>
        </div>
        <button class="pos-sell-btn" id="pos-sell-data-btn" onclick="posSellData()" disabled style="background:linear-gradient(135deg,#3b82f6,#1d4ed8);box-shadow:0 4px 20px rgba(59,130,246,0.3)">
          SELL DATA
        </button>
      </div>

      <!-- Recent Sales -->
      <div class="section-header">
        <div class="section-title">Recent Sales</div>
        <div class="section-link" onclick="posLoadAllSales()">See All</div>
      </div>
      <div class="pos-sales-list" id="pos-sales-list">
        <div style="padding:24px 0;text-align:center;color:var(--text3);font-size:13px">
          No sales yet. Sell airtime to get started.
        </div>
      </div>
    </div>

    <!-- CALLS / SOCIAL -->
    <div class="page" id="page-calls">
      <!-- Tabs: Keypad | Chats | History -->
      <div class="calls-tabs">
        <button class="calls-tab active" onclick="switchCallsTab('keypad')">Keypad</button>
        <button class="calls-tab" onclick="switchCallsTab('chats')">Chats</button>
        <button class="calls-tab" onclick="switchCallsTab('services')">Services</button>
        <button class="calls-tab" onclick="switchCallsTab('history')">History</button>
      </div>

      <!-- AI Features Cards -->
      <div id="calls-ai-features">
        <div class="ai-mini-card" onclick="navigateTo('ai');document.getElementById('chat-input').value='Translate this call for me';sendMessage()">
          <div class="ai-mini-header">
            <div class="ai-mini-icon">
              <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="#fff" stroke-width="2"><circle cx="12" cy="12" r="10"/><line x1="2" y1="12" x2="22" y2="12"/><path d="M12 2a15.3 15.3 0 0 1 4 10 15.3 15.3 0 0 1-4 10 15.3 15.3 0 0 1-4-10 15.3 15.3 0 0 1 4-10z"/></svg>
            </div>
            <div>
              <div class="ai-mini-title">AI Translator <span class="free-badge">Free</span></div>
              <div class="ai-mini-desc">Real-time language translation during calls</div>
            </div>
          </div>
        </div>
      </div>

      <!-- KEYPAD TAB -->
      <div id="calls-tab-keypad">
        <div class="dialpad-display">
          <div class="dialpad-number" id="dial-number">&nbsp;</div>
          <div class="dialpad-rate" id="dial-rate"></div>
        </div>
        <div class="dialpad-grid">
          <button class="dial-key" onclick="dialPress('1')"><span class="dial-key-num">1</span><span class="dial-key-sub">&nbsp;</span></button>
          <button class="dial-key" onclick="dialPress('2')"><span class="dial-key-num">2</span><span class="dial-key-sub">ABC</span></button>
          <button class="dial-key" onclick="dialPress('3')"><span class="dial-key-num">3</span><span class="dial-key-sub">DEF</span></button>
          <button class="dial-key" onclick="dialPress('4')"><span class="dial-key-num">4</span><span class="dial-key-sub">GHI</span></button>
          <button class="dial-key" onclick="dialPress('5')"><span class="dial-key-num">5</span><span class="dial-key-sub">JKL</span></button>
          <button class="dial-key" onclick="dialPress('6')"><span class="dial-key-num">6</span><span class="dial-key-sub">MNO</span></button>
          <button class="dial-key" onclick="dialPress('7')"><span class="dial-key-num">7</span><span class="dial-key-sub">PQRS</span></button>
          <button class="dial-key" onclick="dialPress('8')"><span class="dial-key-num">8</span><span class="dial-key-sub">TUV</span></button>
          <button class="dial-key" onclick="dialPress('9')"><span class="dial-key-num">9</span><span class="dial-key-sub">WXYZ</span></button>
          <button class="dial-key" onclick="dialPress('*')"><span class="dial-key-num">*</span><span class="dial-key-sub">&nbsp;</span></button>
          <button class="dial-key" onclick="dialPress('0')" oncontextmenu="event.preventDefault();dialPress('+')"><span class="dial-key-num">0</span><span class="dial-key-sub">+</span></button>
          <button class="dial-key" onclick="dialPress('#')"><span class="dial-key-num">#</span><span class="dial-key-sub">&nbsp;</span></button>
        </div>
        <div class="dial-actions">
          <div style="width:48px"></div>
          <button class="dial-call-btn" id="dial-call-btn" onclick="startCall()">
            <svg width="28" height="28" viewBox="0 0 24 24" fill="none" stroke="#fff" stroke-width="2"><path d="M22 16.92v3a2 2 0 0 1-2.18 2 19.79 19.79 0 0 1-8.63-3.07 19.5 19.5 0 0 1-6-6 19.79 19.79 0 0 1-3.07-8.67A2 2 0 0 1 4.11 2h3a2 2 0 0 1 2 1.72 12.84 12.84 0 0 0 .7 2.81 2 2 0 0 1-.45 2.11L8.09 9.91a16 16 0 0 0 6 6l1.27-1.27a2 2 0 0 1 2.11-.45 12.84 12.84 0 0 0 2.81.7A2 2 0 0 1 22 16.92z"/></svg>
          </button>
          <button class="dial-backspace" onclick="dialBackspace()">
            <svg width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 4H8l-7 8 7 8h13a2 2 0 0 0 2-2V6a2 2 0 0 0-2-2z"/><line x1="18" y1="9" x2="12" y2="15"/><line x1="12" y1="9" x2="18" y2="15"/></svg>
          </button>
        </div>
        <!-- Quick actions under dialpad -->
        <div style="display:flex;gap:12px;justify-content:center;flex-wrap:wrap;padding:8px 0">
          <div style="display:flex;align-items:center;gap:6px;padding:8px 16px;border-radius:20px;background:rgba(255,255,255,0.04);border:1px solid var(--glass-border);cursor:pointer;font-size:12px;color:var(--text2)" onclick="startVideoCall()">
            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="#3b82f6" stroke-width="2"><polygon points="23 7 16 12 23 17 23 7"/><rect x="1" y="5" width="15" height="14" rx="2" ry="2"/></svg>
            Video Call <span class="free-badge">Free</span>
          </div>
          <div style="display:flex;align-items:center;gap:6px;padding:8px 16px;border-radius:20px;background:rgba(255,255,255,0.04);border:1px solid var(--glass-border);cursor:pointer;font-size:12px;color:var(--text2)" onclick="openSmartDial()">
            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="#a78bfa" stroke-width="2"><path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"/></svg>
            AI Smart Dial <span class="free-badge">Free</span>
          </div>
        </div>
      </div>

      <!-- CHATS TAB -->
      <div id="calls-tab-chats" style="display:none">
        <!-- Search -->
        <div class="social-search">
          <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="var(--text3)" stroke-width="2"><circle cx="11" cy="11" r="8"/><line x1="21" y1="21" x2="16.65" y2="16.65"/></svg>
          <input type="text" placeholder="Search chats or start new..." id="chat-search-input" oninput="searchChats(this.value)">
        </div>

        <!-- Search Results (hidden by default) -->
        <div id="chat-search-results" style="display:none"></div>

        <!-- Conversation List -->
        <div id="chat-conversations-list">
          <div style="text-align:center;padding:40px 0;color:var(--text3)">
            <svg width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="var(--text3)" stroke-width="1.5" style="margin-bottom:12px"><path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"/></svg>
            <div style="font-size:14px;font-weight:600;margin-bottom:4px">No conversations yet</div>
            <div style="font-size:12px">Search for users to start chatting</div>
          </div>
        </div>
      </div>

      <!-- MESSAGE THREAD (overlays chat list) -->
      <div id="calls-tab-thread" style="display:none;position:relative;height:calc(100vh - 200px)">
        <div class="msg-thread-header">
          <button class="msg-thread-back" onclick="closeMessageThread()">
            <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="19" y1="12" x2="5" y2="12"/><polyline points="12 19 5 12 12 5"/></svg>
          </button>
          <div class="msg-thread-name" id="thread-name">User</div>
          <div class="msg-thread-actions">
            <button class="msg-thread-action" onclick="callThreadUser()" title="Call">
              <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="#10b981" stroke-width="2"><path d="M22 16.92v3a2 2 0 0 1-2.18 2 19.79 19.79 0 0 1-8.63-3.07 19.5 19.5 0 0 1-6-6 19.79 19.79 0 0 1-3.07-8.67A2 2 0 0 1 4.11 2h3a2 2 0 0 1 2 1.72c.13.83.3 1.65.52 2.44a2 2 0 0 1-.45 2.11L8.09 9.91a16 16 0 0 0 6 6l1.27-1.27a2 2 0 0 1 2.11-.45c.79.22 1.61.39 2.44.52A2 2 0 0 1 22 16.92z"/></svg>
            </button>
            <button class="msg-thread-action" onclick="videoCallThreadUser()" title="Video Call">
              <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="#3b82f6" stroke-width="2"><polygon points="23 7 16 12 23 17 23 7"/><rect x="1" y="5" width="15" height="14" rx="2" ry="2"/></svg>
            </button>
          </div>
        </div>
        <div class="msg-bubbles" id="msg-bubbles"></div>
        <div class="msg-compose">
          <input class="msg-input" id="msg-input" placeholder="Type a message..." onkeydown="if(event.key==='Enter')sendChatMessage()">
          <button class="msg-send-btn" onclick="sendChatMessage()">
            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="#fff" stroke-width="2"><line x1="22" y1="2" x2="11" y2="13"/><polygon points="22 2 15 22 11 13 2 9 22 2"/></svg>
          </button>
        </div>
      </div>

      <!-- HISTORY TAB -->
      <div id="calls-tab-history" style="display:none">
        <div id="call-history-list">
          <div style="text-align:center;padding:40px 0;color:var(--text3)">
            <svg width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="var(--text3)" stroke-width="1.5" style="margin-bottom:12px"><path d="M22 16.92v3a2 2 0 0 1-2.18 2 19.79 19.79 0 0 1-8.63-3.07 19.5 19.5 0 0 1-6-6 19.79 19.79 0 0 1-3.07-8.67A2 2 0 0 1 4.11 2h3a2 2 0 0 1 2 1.72"/></svg>
            <div style="font-size:14px;font-weight:600;margin-bottom:4px">No call history</div>
            <div style="font-size:12px">Your calls will appear here</div>
          </div>
        </div>
      </div>

      <!-- SERVICES TAB — Virtual Numbers, SIMs, SMS, AI -->
      <div id="calls-tab-services" style="display:none">

        <!-- Telnyx Account Balance -->
        <div style="display:flex;align-items:center;justify-content:space-between;padding:12px 16px;background:rgba(16,185,129,0.08);border:1px solid rgba(16,185,129,0.15);border-radius:14px;margin-bottom:16px">
          <div>
            <div style="font-size:11px;color:var(--text3);text-transform:uppercase;letter-spacing:0.5px">Telnyx Balance</div>
            <div style="font-size:20px;font-weight:700;color:#10b981" id="telnyx-balance-display">$—</div>
          </div>
          <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="#10b981" stroke-width="2"><circle cx="12" cy="12" r="10"/><line x1="12" y1="8" x2="12" y2="12"/><line x1="12" y1="16" x2="12.01" y2="16"/></svg>
        </div>

        <!-- Service Cards Grid -->
        <div style="display:grid;grid-template-columns:1fr 1fr;gap:12px;margin-bottom:20px">

          <!-- Virtual Numbers Card -->
          <div style="background:var(--surface);border:1px solid var(--glass-border);border-radius:16px;padding:16px;cursor:pointer;transition:all 0.2s" onclick="showServicePanel('numbers')">
            <div style="width:40px;height:40px;border-radius:12px;background:rgba(59,130,246,0.12);display:flex;align-items:center;justify-content:center;margin-bottom:10px">
              <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="#3b82f6" stroke-width="2"><path d="M22 16.92v3a2 2 0 0 1-2.18 2 19.79 19.79 0 0 1-8.63-3.07 19.5 19.5 0 0 1-6-6 19.79 19.79 0 0 1-3.07-8.67A2 2 0 0 1 4.11 2h3"/></svg>
            </div>
            <div style="font-size:14px;font-weight:700;color:var(--text);margin-bottom:2px">Virtual Numbers</div>
            <div style="font-size:11px;color:var(--text3)">Buy global phone numbers</div>
            <div style="font-size:11px;color:var(--text3);margin-top:2px" id="my-numbers-count">0 active</div>
          </div>

          <!-- eSIM Card -->
          <div style="background:var(--surface);border:1px solid var(--glass-border);border-radius:16px;padding:16px;cursor:pointer;transition:all 0.2s" onclick="showServicePanel('sims')">
            <div style="width:40px;height:40px;border-radius:12px;background:rgba(245,158,11,0.12);display:flex;align-items:center;justify-content:center;margin-bottom:10px">
              <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="#f59e0b" stroke-width="2"><rect x="4" y="2" width="16" height="20" rx="2"/><path d="M8 6h8"/><path d="M8 10h8"/><path d="M8 14h4"/></svg>
            </div>
            <div style="font-size:14px;font-weight:700;color:var(--text);margin-bottom:2px">eSIM / SIM</div>
            <div style="font-size:11px;color:var(--text3)">IoT & travel SIMs</div>
          </div>

          <!-- SMS Card -->
          <div style="background:var(--surface);border:1px solid var(--glass-border);border-radius:16px;padding:16px;cursor:pointer;transition:all 0.2s" onclick="showServicePanel('sms')">
            <div style="width:40px;height:40px;border-radius:12px;background:rgba(16,185,129,0.12);display:flex;align-items:center;justify-content:center;margin-bottom:10px">
              <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="#10b981" stroke-width="2"><path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"/></svg>
            </div>
            <div style="font-size:14px;font-weight:700;color:var(--text);margin-bottom:2px">SMS / MMS</div>
            <div style="font-size:11px;color:var(--text3)">Send global texts</div>
          </div>

          <!-- AI Chat Card -->
          <div style="background:var(--surface);border:1px solid var(--glass-border);border-radius:16px;padding:16px;cursor:pointer;transition:all 0.2s" onclick="showServicePanel('telnyxai')">
            <div style="width:40px;height:40px;border-radius:12px;background:linear-gradient(135deg,rgba(124,58,237,0.15),rgba(59,130,246,0.12));display:flex;align-items:center;justify-content:center;margin-bottom:10px">
              <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="#a78bfa" stroke-width="2"><path d="M12 2a10 10 0 1 0 10 10A10 10 0 0 0 12 2z"/><path d="M12 16v-4"/><path d="M12 8h.01"/></svg>
            </div>
            <div style="font-size:14px;font-weight:700;color:var(--text);margin-bottom:2px">AI Assistant <span class="free-badge">Free</span></div>
            <div style="font-size:11px;color:var(--text3)">Llama 3.1 powered</div>
          </div>
        </div>

        <!-- Service Panel (dynamic content) -->
        <div id="service-panel"></div>
      </div>
    </div>

    <!-- ACTIVITY (Payments tab) -->
    <div class="page" id="page-activity">
      <div style="margin-bottom:14px">
        <button class="page-back-btn" onclick="navigateTo('home')">
          <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="19" y1="12" x2="5" y2="12"/><polyline points="12 19 5 12 12 5"/></svg>
          Back
        </button>
      </div>
      <div class="section-header" style="margin-bottom:18px">
        <div class="section-title">All Transactions</div>
      </div>
      <div style="display:flex;gap:8px;margin-bottom:20px;overflow-x:auto;scrollbar-width:none">
        <div class="chat-suggestion" style="background:var(--accent);color:white;border-color:var(--accent)">All</div>
        <div class="chat-suggestion">Sent</div>
        <div class="chat-suggestion">Received</div>
        <div class="chat-suggestion">Bills</div>
        <div class="chat-suggestion">Savings</div>
      </div>
      <div class="tx-list" id="activity-tx-list">
        <!-- Populated by JS -->
      </div>
    </div>

    <!-- PROFILE -->
    <div class="page" id="page-profile">
      <div style="margin-bottom:14px">
        <button class="page-back-btn" onclick="navigateTo('home')">
          <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="19" y1="12" x2="5" y2="12"/><polyline points="12 19 5 12 12 5"/></svg>
          Back
        </button>
      </div>
      <!-- Profile Picture -->
      <div style="display:flex;flex-direction:column;align-items:center;margin-bottom:24px">
        <div id="profile-pic-container" style="position:relative;width:80px;height:80px;margin-bottom:12px">
          <div id="profile-pic-display" style="width:80px;height:80px;border-radius:50%;background:var(--gradient);display:flex;align-items:center;justify-content:center;font-size:28px;font-weight:700;color:white;overflow:hidden;border:3px solid rgba(124,58,237,0.3)">
            <span id="profile-pic-initials">PP</span>
            <img id="profile-pic-img" style="display:none;width:100%;height:100%;object-fit:cover" alt="Profile">
          </div>
          <label for="profile-pic-input" style="position:absolute;bottom:-2px;right:-2px;width:28px;height:28px;border-radius:50%;background:var(--gradient2);display:flex;align-items:center;justify-content:center;cursor:pointer;border:2px solid var(--bg)">
            <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="2"><path d="M23 19a2 2 0 0 1-2 2H3a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h4l2-3h6l2 3h4a2 2 0 0 1 2 2z"/><circle cx="12" cy="13" r="4"/></svg>
          </label>
          <input type="file" id="profile-pic-input" accept="image/*" onchange="handleProfilePicUpload(event)" style="display:none">
        </div>
        <div style="font-size:18px;font-weight:700" id="profile-display-name">User</div>
        <div style="font-size:13px;color:var(--text2)" id="profile-email-display"></div>
      </div>

      <!-- Streak -->
      <div class="streak-card">
        <div class="streak-fire">&#128293;</div>
        <div>
          <div class="streak-count" id="user-streak">0</div>
          <div class="streak-label">Day Streak</div>
        </div>
        <div class="streak-multiplier" id="streak-mult">1.0x</div>
      </div>

      <!-- Loyalty Tier -->
      <div class="tier-card tier-bronze" id="tier-card">
        <div class="tier-info">
          <div>
            <div class="tier-name" id="tier-name">Bronze</div>
            <div class="tier-points" id="tier-points">0 points</div>
          </div>
          <div style="font-size:32px">&#11088;</div>
        </div>
        <div class="tier-progress">
          <div class="tier-bar"><div class="tier-fill" id="tier-fill" style="width:0%;background:linear-gradient(90deg,#b87333,#d4a76a)"></div></div>
          <div class="tier-next" id="tier-next">5,000 pts to Silver</div>
        </div>
      </div>

      <!-- Achievements -->
      <div class="section-header">
        <div class="section-title">Achievements</div>
        <div class="section-link" id="ach-count">0/15</div>
      </div>
      <div class="achievements-grid" id="achievements-grid">
        <div class="achievement locked">
          <div class="ach-icon">&#128176;</div>
          <div class="ach-name">First Payment</div>
          <div class="ach-pts">100 pts</div>
        </div>
        <div class="achievement locked">
          <div class="ach-icon">&#128293;</div>
          <div class="ach-name">7-Day Streak</div>
          <div class="ach-pts">250 pts</div>
        </div>
        <div class="achievement locked">
          <div class="ach-icon">&#128279;</div>
          <div class="ach-name">First Referral</div>
          <div class="ach-pts">500 pts</div>
        </div>
        <div class="achievement locked">
          <div class="ach-icon">&#127968;</div>
          <div class="ach-name">Savings $100</div>
          <div class="ach-pts">200 pts</div>
        </div>
        <div class="achievement locked">
          <div class="ach-icon">&#127942;</div>
          <div class="ach-name">30-Day Streak</div>
          <div class="ach-pts">1,500 pts</div>
        </div>
        <div class="achievement locked">
          <div class="ach-icon">&#128142;</div>
          <div class="ach-name">$10K Volume</div>
          <div class="ach-pts">10,000 pts</div>
        </div>
      </div>

      <!-- Country/Region Setting -->
      <div class="section-header" style="margin-top:24px">
        <div class="section-title">Your Region</div>
      </div>
      <div style="background:var(--surface);border:1px solid var(--glass-border);border-radius:var(--radius);padding:18px;margin-bottom:16px;">
        <label style="font-size:12px;color:var(--text2);display:block;margin-bottom:6px">Country</label>
        <select id="profile-country" onchange="updateUserCountry(this.value)" style="width:100%;padding:12px 14px;background:rgba(255,255,255,0.04);border:1px solid rgba(255,255,255,0.08);border-radius:var(--radius-xs);color:var(--text);font-size:14px;font-family:inherit;outline:none;-webkit-appearance:none;appearance:none;">
          <option value="">Not set</option>
          <optgroup label="Africa">
            <option value="NG">Nigeria</option>
            <option value="GH">Ghana</option>
            <option value="KE">Kenya</option>
            <option value="UG">Uganda</option>
            <option value="ZA">South Africa</option>
            <option value="TZ">Tanzania</option>
            <option value="CM">Cameroon</option>
            <option value="SN">Senegal</option>
            <option value="ET">Ethiopia</option>
          </optgroup>
          <optgroup label="Americas">
            <option value="US">United States</option>
            <option value="CA">Canada</option>
          </optgroup>
          <optgroup label="Europe">
            <option value="GB">United Kingdom</option>
            <option value="DE">Germany</option>
            <option value="FR">France</option>
          </optgroup>
          <optgroup label="Asia & Pacific">
            <option value="IN">India</option>
            <option value="AU">Australia</option>
          </optgroup>
        </select>
        <div style="font-size:11px;color:var(--text3);margin-top:8px">This determines available features like airtime top-up (Africa only).</div>
      </div>

    </div>

    <!-- SETTINGS -->
    <div class="page" id="page-settings">
      <div style="margin-bottom:14px">
        <button class="page-back-btn" onclick="navigateTo('home')">
          <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="19" y1="12" x2="5" y2="12"/><polyline points="12 19 5 12 12 5"/></svg>
          Back
        </button>
      </div>
      <div class="section-header" style="margin-bottom:18px">
        <div class="section-title">Settings</div>
      </div>

      <!-- AI — Platform Provided -->
      <div class="settings-section">
        <div class="settings-section-title">
          <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"/><path d="M8 14s1.5 2 4 2 4-2 4-2"/><line x1="9" y1="9" x2="9.01" y2="9"/><line x1="15" y1="9" x2="15.01" y2="9"/></svg>
          AI Assistant
        </div>
        <div style="padding:12px 0;color:var(--text2);font-size:13px;line-height:1.6">
          AI is powered by PromptPay — no setup needed. Chat with our AI assistant, get financial insights, and manage payments all through natural conversation.
        </div>
        <div style="display:flex;gap:8px;align-items:center;padding:10px 14px;background:rgba(124,58,237,0.1);border-radius:12px;font-size:13px">
          <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="#7c3aed" stroke-width="2"><path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"/><polyline points="22 4 12 14.01 9 11.01"/></svg>
          <span style="color:var(--text)">AI is included free with your account</span>
        </div>
      </div>

      <!-- Notifications -->
      <div class="settings-section">
        <div class="settings-section-title">
          <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M18 8A6 6 0 0 0 6 8c0 7-3 9-3 9h18s-3-2-3-9"/><path d="M13.73 21a2 2 0 0 1-3.46 0"/></svg>
          Notifications
        </div>
        <div style="display:flex;flex-direction:column;gap:10px">
          <div class="channel-toggle active" data-channel="push" onclick="toggleChannel(this)">
            <span class="channel-label">Push Notifications</span>
            <div class="toggle-switch on"></div>
          </div>
          <div class="channel-toggle active" data-channel="email" onclick="toggleChannel(this)">
            <span class="channel-label">Email Alerts</span>
            <div class="toggle-switch on"></div>
          </div>
        </div>
      </div>

      <!-- Transaction Fees Info -->
      <div class="settings-section">
        <div class="settings-section-title">
          <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="12" y1="1" x2="12" y2="23"/><path d="M17 5H9.5a3.5 3.5 0 0 0 0 7h5a3.5 3.5 0 0 1 0 7H6"/></svg>
          Fee Schedule
        </div>
        <div style="display:flex;flex-direction:column;gap:8px;font-size:13px;color:var(--text2)">
          <div style="display:flex;justify-content:space-between"><span>P2P Transfer (under $50)</span><span style="color:var(--emerald);font-weight:600">Free</span></div>
          <div style="display:flex;justify-content:space-between"><span>P2P Transfer (over $50)</span><span>1.0%</span></div>
          <div style="display:flex;justify-content:space-between"><span>Wallet Top-up</span><span>1.5%</span></div>
          <div style="display:flex;justify-content:space-between"><span>Withdrawal</span><span>1.0% + $0.25</span></div>
          <div style="display:flex;justify-content:space-between"><span>Bill Payment</span><span>1.5%</span></div>
          <div style="display:flex;justify-content:space-between"><span>Merchant Payment</span><span>2.5%</span></div>
          <div style="display:flex;justify-content:space-between"><span>Cross-border</span><span>3.0%</span></div>
          <div style="margin-top:6px;padding:10px 14px;background:rgba(124,58,237,0.08);border-radius:10px;color:var(--text)">
            Loyalty members save up to 20% on fees! Your tier discount is applied automatically.
          </div>
        </div>
      </div>

      <!-- PayTag & Sharing -->
      <div style="background: rgba(124,58,237,0.1); border-radius: 16px; padding: 20px; margin-bottom: 16px; border: 1px solid rgba(124,58,237,0.2);">
        <h4 style="margin: 0 0 12px 0; font-size: 1rem;">Your $PayTag</h4>
        <div id="settings-paytag" style="font-size: 1.3rem; font-weight: 700; color: #7c3aed; margin-bottom: 8px;">Not set</div>
        <button onclick="document.getElementById('paytag-modal').classList.add('active')" style="padding: 8px 16px; border-radius: 8px; border: 1px solid rgba(124,58,237,0.3); background: transparent; color: #7c3aed; cursor: pointer; font-size: 0.85rem;">Change PayTag</button>
        <button onclick="sharePaytag()" style="padding: 8px 16px; border-radius: 8px; border: none; background: #7c3aed; color: white; cursor: pointer; font-size: 0.85rem; margin-left: 8px;">Share</button>
      </div>

      <!-- Referral -->
      <div style="background: rgba(255,255,255,0.03); border-radius: 16px; padding: 20px; margin-bottom: 16px; border: 1px solid rgba(255,255,255,0.06);">
        <h4 style="margin: 0 0 8px 0; font-size: 1rem;">Invite Friends — Earn $5</h4>
        <p style="font-size: 0.85rem; opacity: 0.6; margin: 0 0 12px 0;">You both get $5 when they make their first $5+ transaction</p>
        <button onclick="shareReferral()" style="padding: 10px 20px; border-radius: 10px; border: none; background: linear-gradient(135deg, #10b981, #059669); color: white; font-weight: 600; cursor: pointer;">Share Invite Link</button>
      </div>

      <!-- Install App -->
      <div class="settings-section" id="install-app-section">
        <div class="settings-section-title">
          <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="5" y="2" width="14" height="20" rx="2" ry="2"/><line x1="12" y1="18" x2="12.01" y2="18"/></svg>
          Install App
        </div>
        <div style="padding:4px 0 12px;color:var(--text2);font-size:13px;line-height:1.5">
          Add PromptPay to your phone's home screen for instant access — no app store needed. Works like a native app with offline support.
        </div>
        <button class="settings-btn settings-btn-primary settings-btn-full" id="install-app-btn" onclick="installApp()">
          Add to Home Screen
        </button>
      </div>

      <!-- Language & Timezone -->
      <div class="settings-section">
        <div class="settings-section-title">
          <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"/><line x1="2" y1="12" x2="22" y2="12"/><path d="M12 2a15.3 15.3 0 0 1 4 10 15.3 15.3 0 0 1-4 10 15.3 15.3 0 0 1-4-10 15.3 15.3 0 0 1 4-10z"/></svg>
          Language &amp; Region
        </div>
        <div class="settings-field">
          <label>Country</label>
          <select id="settings-country" onchange="updateUserCountry(this.value)">
            <option value="">Not set</option>
            <optgroup label="Africa">
              <option value="NG">Nigeria</option>
              <option value="GH">Ghana</option>
              <option value="KE">Kenya</option>
              <option value="UG">Uganda</option>
              <option value="ZA">South Africa</option>
              <option value="TZ">Tanzania</option>
              <option value="CM">Cameroon</option>
              <option value="SN">Senegal</option>
              <option value="ET">Ethiopia</option>
            </optgroup>
            <optgroup label="Americas">
              <option value="US">United States</option>
              <option value="CA">Canada</option>
            </optgroup>
            <optgroup label="Europe">
              <option value="GB">United Kingdom</option>
              <option value="DE">Germany</option>
              <option value="FR">France</option>
            </optgroup>
            <optgroup label="Asia & Pacific">
              <option value="IN">India</option>
              <option value="AU">Australia</option>
            </optgroup>
          </select>
        </div>
        <div class="settings-row">
          <div class="settings-field">
            <label>Language</label>
            <select id="settings-language">
              <option value="en">English</option>
              <option value="es">Spanish</option>
              <option value="fr">French</option>
              <option value="de">German</option>
              <option value="pt">Portuguese</option>
              <option value="zh">Chinese</option>
              <option value="ja">Japanese</option>
              <option value="ko">Korean</option>
              <option value="ar">Arabic</option>
              <option value="hi">Hindi</option>
              <option value="sw">Swahili</option>
            </select>
          </div>
          <div class="settings-field">
            <label>Timezone</label>
            <select id="settings-timezone">
              <option value="America/New_York">Eastern (ET)</option>
              <option value="America/Chicago">Central (CT)</option>
              <option value="America/Denver">Mountain (MT)</option>
              <option value="America/Los_Angeles">Pacific (PT)</option>
              <option value="America/Anchorage">Alaska (AKT)</option>
              <option value="Pacific/Honolulu">Hawaii (HT)</option>
              <option value="Europe/London">London (GMT)</option>
              <option value="Europe/Paris">Paris (CET)</option>
              <option value="Europe/Berlin">Berlin (CET)</option>
              <option value="Asia/Tokyo">Tokyo (JST)</option>
              <option value="Asia/Shanghai">Shanghai (CST)</option>
              <option value="Asia/Kolkata">Kolkata (IST)</option>
              <option value="Africa/Nairobi">Nairobi (EAT)</option>
              <option value="Australia/Sydney">Sydney (AEST)</option>
              <option value="UTC">UTC</option>
            </select>
          </div>
        </div>
      </div>

      <!-- Save Preferences Button -->
      <button class="settings-btn settings-btn-primary settings-btn-full" onclick="savePreferences()">
        Save Preferences
      </button>

      <div style="height:24px"></div>
    </div>

    <!-- DEVELOPER PORTAL -->
    <div class="page" id="page-developer">
      <div style="margin-bottom:14px">
        <button class="page-back-btn" onclick="navigateTo('home')">
          <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="19" y1="12" x2="5" y2="12"/><polyline points="12 19 5 12 12 5"/></svg>
          Back
        </button>
      </div>
      <div class="section-header" style="margin-bottom:8px">
        <div class="section-title">Developer Portal</div>
      </div>
      <p style="color:var(--text2);font-size:13px;margin:0 0 20px;line-height:1.5">
        Build apps with PromptPay — AI, payments, airtime, SMS, and calls. Get your API keys and start integrating.
      </p>

      <!-- Quick Start -->
      <div style="background:linear-gradient(135deg,rgba(108,92,231,0.15),rgba(108,92,231,0.05));border:1px solid rgba(108,92,231,0.2);border-radius:16px;padding:20px;margin-bottom:20px">
        <div style="display:flex;align-items:center;gap:10px;margin-bottom:12px">
          <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="#6c5ce7" stroke-width="2"><polygon points="13 2 3 14 12 14 11 22 21 10 12 10 13 2"/></svg>
          <span style="font-weight:700;font-size:15px">Quick Start</span>
        </div>
        <div style="font-size:13px;color:var(--text2);line-height:1.7">
          <div style="display:flex;gap:8px;margin-bottom:6px"><span style="background:#6c5ce7;color:#fff;border-radius:50%;min-width:20px;height:20px;display:flex;align-items:center;justify-content:center;font-size:11px;font-weight:700">1</span>Create an API key below</div>
          <div style="display:flex;gap:8px;margin-bottom:6px"><span style="background:#6c5ce7;color:#fff;border-radius:50%;min-width:20px;height:20px;display:flex;align-items:center;justify-content:center;font-size:11px;font-weight:700">2</span>Use sandbox keys (upp_test_) to test</div>
          <div style="display:flex;gap:8px;margin-bottom:6px"><span style="background:#6c5ce7;color:#fff;border-radius:50%;min-width:20px;height:20px;display:flex;align-items:center;justify-content:center;font-size:11px;font-weight:700">3</span>Switch to live keys (upp_live_) when ready</div>
        </div>
        <div style="margin-top:14px;padding:12px;background:var(--surface);border-radius:10px;font-family:monospace;font-size:12px;color:var(--text2);overflow-x:auto;white-space:pre;line-height:1.6">curl -X POST https://www.upromptpay.com/api/v1/chat \
  -H "X-API-Key: upp_test_your_key" \
  -H "Content-Type: application/json" \
  -d '{"messages":[{"role":"user","content":"Hello"}]}'</div>
      </div>

      <!-- API Keys Section -->
      <div class="settings-section">
        <div class="settings-section-title" style="display:flex;justify-content:space-between;align-items:center;width:100%">
          <div style="display:flex;align-items:center;gap:8px">
            <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 2l-2 2m-7.61 7.61a5.5 5.5 0 1 1-7.778 7.778 5.5 5.5 0 0 1 7.777-7.777zm0 0L15.5 7.5m0 0l3 3L22 7l-3-3m-3.5 3.5L19 4"/></svg>
            API Keys
          </div>
          <button onclick="showCreateKeyModal()" style="padding:6px 14px;border-radius:8px;border:none;background:#6c5ce7;color:#fff;font-size:12px;font-weight:600;cursor:pointer">+ New Key</button>
        </div>
        <div id="dev-keys-list" style="margin-top:12px">
          <div style="color:var(--text3);font-size:13px;text-align:center;padding:20px 0">Loading keys...</div>
        </div>
      </div>

      <!-- Usage Analytics -->
      <div class="settings-section">
        <div class="settings-section-title">
          <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M18 20V10"/><path d="M12 20V4"/><path d="M6 20v-6"/></svg>
          Usage Analytics
        </div>
        <div id="dev-analytics" style="margin-top:8px">
          <div style="color:var(--text3);font-size:13px;text-align:center;padding:20px 0">Create an API key to see analytics</div>
        </div>
      </div>

      <!-- Recent Logs -->
      <div class="settings-section">
        <div class="settings-section-title" style="display:flex;justify-content:space-between;align-items:center;width:100%">
          <div style="display:flex;align-items:center;gap:8px">
            <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/><polyline points="14 2 14 8 20 8"/><line x1="16" y1="13" x2="8" y2="13"/><line x1="16" y1="17" x2="8" y2="17"/></svg>
            Request Logs
          </div>
          <select id="dev-log-filter" onchange="loadDevLogs()" style="padding:4px 8px;border-radius:6px;border:1px solid var(--glass-border);background:var(--surface);color:var(--text);font-size:11px">
            <option value="">All</option>
            <option value="success">Success</option>
            <option value="error">Errors</option>
          </select>
        </div>
        <div id="dev-logs-list" style="margin-top:8px">
          <div style="color:var(--text3);font-size:13px;text-align:center;padding:20px 0">No logs yet</div>
        </div>
      </div>

      <!-- Webhooks -->
      <div class="settings-section">
        <div class="settings-section-title" style="display:flex;justify-content:space-between;align-items:center;width:100%">
          <div style="display:flex;align-items:center;gap:8px">
            <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.71"/><path d="M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.71-1.71"/></svg>
            Webhooks
          </div>
          <button onclick="showCreateWebhookModal()" style="padding:6px 14px;border-radius:8px;border:none;background:var(--surface);color:var(--text);font-size:12px;cursor:pointer;border:1px solid var(--glass-border)">+ Add</button>
        </div>
        <div id="dev-webhooks-list" style="margin-top:8px">
          <div style="color:var(--text3);font-size:13px;text-align:center;padding:20px 0">No webhooks configured</div>
        </div>
      </div>

      <!-- API Documentation -->
      <div class="settings-section">
        <div class="settings-section-title">
          <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M4 19.5A2.5 2.5 0 0 1 6.5 17H20"/><path d="M6.5 2H20v20H6.5A2.5 2.5 0 0 1 4 19.5v-15A2.5 2.5 0 0 1 6.5 2z"/></svg>
          API Reference
        </div>
        <div id="dev-api-docs" style="margin-top:8px;display:flex;flex-direction:column;gap:6px">
        </div>
      </div>

      <!-- Sandbox Tester -->
      <div class="settings-section">
        <div class="settings-section-title">
          <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="2" y="3" width="20" height="14" rx="2" ry="2"/><line x1="8" y1="21" x2="16" y2="21"/><line x1="12" y1="17" x2="12" y2="21"/></svg>
          API Playground
        </div>
        <div style="margin-top:8px">
          <div style="display:flex;gap:8px;margin-bottom:10px">
            <select id="playground-method" style="padding:8px 10px;border-radius:8px;border:1px solid var(--glass-border);background:var(--surface);color:var(--text);font-size:13px;width:90px">
              <option>GET</option>
              <option>POST</option>
            </select>
            <select id="playground-endpoint" style="flex:1;padding:8px 10px;border-radius:8px;border:1px solid var(--glass-border);background:var(--surface);color:var(--text);font-size:12px" onchange="updatePlaygroundBody()">
              <option value="/api/v1/me">GET /api/v1/me</option>
              <option value="/api/v1/wallet/balance">GET /api/v1/wallet/balance</option>
              <option value="/api/v1/wallet/transactions">GET /api/v1/wallet/transactions</option>
              <option value="/api/v1/calls/rates">GET /api/v1/calls/rates</option>
              <option value="/api/v1/numbers">GET /api/v1/numbers</option>
              <option value="/api/v1/numbers/search">GET /api/v1/numbers/search</option>
              <option value="/api/v1/chat">POST /api/v1/chat</option>
              <option value="/api/v1/airtime/send">POST /api/v1/airtime/send</option>
              <option value="/api/v1/sms/send">POST /api/v1/sms/send</option>
            </select>
          </div>
          <div id="playground-key-select" style="margin-bottom:10px">
            <select id="playground-key" style="width:100%;padding:8px 10px;border-radius:8px;border:1px solid var(--glass-border);background:var(--surface);color:var(--text);font-size:12px">
              <option value="">Select an API key...</option>
            </select>
            <div style="font-size:11px;color:var(--text3);margin-top:4px">Keys are stored locally and never sent to our servers beyond the API call.</div>
          </div>
          <textarea id="playground-body" placeholder='{"messages":[{"role":"user","content":"Hello"}]}' style="width:100%;min-height:80px;padding:10px;border-radius:8px;border:1px solid var(--glass-border);background:var(--bg);color:var(--text);font-family:monospace;font-size:12px;resize:vertical;display:none;box-sizing:border-box"></textarea>
          <button onclick="runPlayground()" style="width:100%;padding:10px;border-radius:10px;border:none;background:#6c5ce7;color:#fff;font-weight:600;cursor:pointer;margin-top:8px;font-size:14px">
            Send Request
          </button>
          <div id="playground-result" style="margin-top:10px;display:none">
            <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:6px">
              <span id="playground-status" style="font-size:12px;font-weight:600"></span>
              <span id="playground-time" style="font-size:11px;color:var(--text3)"></span>
            </div>
            <pre id="playground-response" style="padding:12px;background:var(--bg);border-radius:8px;border:1px solid var(--glass-border);font-size:11px;color:var(--text2);overflow-x:auto;max-height:300px;white-space:pre-wrap;word-break:break-word;margin:0"></pre>
          </div>
        </div>
      </div>

      <div style="height:24px"></div>
    </div>

  </div>

  <!-- Bottom Navigation -->
  <div class="bottom-nav">
    <div class="nav-item active" data-page="home">
      <div class="nav-icon">
        <svg width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"/><polyline points="9 22 9 12 15 12 15 22"/></svg>
      </div>
      <div class="nav-label">Home</div>
    </div>
    <div class="nav-item" data-page="pos">
      <div class="nav-icon">
        <svg width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="2" y="3" width="20" height="14" rx="2" ry="2"/><line x1="8" y1="21" x2="16" y2="21"/><line x1="12" y1="17" x2="12" y2="21"/></svg>
      </div>
      <div class="nav-label">POS</div>
    </div>
    <div class="nav-item nav-ai" data-page="ai">
      <div class="nav-icon">
        <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="2"><path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"/></svg>
      </div>
      <div class="nav-label">AI</div>
    </div>
    <div class="nav-item" data-page="calls">
      <div class="nav-icon">
        <svg width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M22 16.92v3a2 2 0 0 1-2.18 2 19.79 19.79 0 0 1-8.63-3.07 19.5 19.5 0 0 1-6-6 19.79 19.79 0 0 1-3.07-8.67A2 2 0 0 1 4.11 2h3a2 2 0 0 1 2 1.72 12.84 12.84 0 0 0 .7 2.81 2 2 0 0 1-.45 2.11L8.09 9.91a16 16 0 0 0 6 6l1.27-1.27a2 2 0 0 1 2.11-.45 12.84 12.84 0 0 0 2.81.7A2 2 0 0 1 22 16.92z"/></svg>
      </div>
      <div class="nav-label">Calls</div>
    </div>
    <div class="nav-item" data-page="profile">
      <div class="nav-icon">
        <svg width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"/><circle cx="12" cy="7" r="4"/></svg>
      </div>
      <div class="nav-label">Profile</div>
    </div>
  </div>

</div>

<!-- Active Call Screen Overlay -->
<div class="call-screen" id="call-screen">
  <div class="call-avatar" id="call-screen-avatar">?</div>
  <div class="call-name" id="call-screen-name">Unknown</div>
  <div class="call-status" id="call-screen-status">Dialing...</div>
  <div class="call-timer" id="call-screen-timer" style="display:none">00:00</div>
  <div class="call-controls">
    <button class="call-ctrl-btn" id="call-mute-btn" onclick="toggleCallMute()">
      <svg width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="#fff" stroke-width="2"><path d="M12 1a3 3 0 0 0-3 3v8a3 3 0 0 0 6 0V4a3 3 0 0 0-3-3z"/><path d="M19 10v2a7 7 0 0 1-14 0v-2"/><line x1="12" y1="19" x2="12" y2="23"/><line x1="8" y1="23" x2="16" y2="23"/></svg>
    </button>
    <button class="call-ctrl-btn" id="call-speaker-btn" onclick="toggleCallSpeaker()">
      <svg width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="#fff" stroke-width="2"><polygon points="11 5 6 9 2 9 2 15 6 15 11 19 11 5"/><path d="M19.07 4.93a10 10 0 0 1 0 14.14"/><path d="M15.54 8.46a5 5 0 0 1 0 7.07"/></svg>
    </button>
    <button class="call-ctrl-btn hangup-btn" onclick="endCall()">
      <svg width="26" height="26" viewBox="0 0 24 24" fill="none" stroke="#fff" stroke-width="2"><path d="M22 16.92v3a2 2 0 0 1-2.18 2 19.79 19.79 0 0 1-8.63-3.07 19.5 19.5 0 0 1-6-6 19.79 19.79 0 0 1-3.07-8.67A2 2 0 0 1 4.11 2h3a2 2 0 0 1 2 1.72 12.84 12.84 0 0 0 .7 2.81 2 2 0 0 1-.45 2.11L8.09 9.91a16 16 0 0 0 6 6l1.27-1.27a2 2 0 0 1 2.11-.45 12.84 12.84 0 0 0 2.81.7A2 2 0 0 1 22 16.92z"/></svg>
    </button>
    <button class="call-ctrl-btn" id="call-keypad-btn" onclick="toggleCallKeypad()">
      <svg width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="#fff" stroke-width="2"><rect x="4" y="2" width="4" height="4" rx="1"/><rect x="10" y="2" width="4" height="4" rx="1"/><rect x="16" y="2" width="4" height="4" rx="1"/><rect x="4" y="8" width="4" height="4" rx="1"/><rect x="10" y="8" width="4" height="4" rx="1"/><rect x="16" y="8" width="4" height="4" rx="1"/><rect x="4" y="14" width="4" height="4" rx="1"/><rect x="10" y="14" width="4" height="4" rx="1"/><rect x="16" y="14" width="4" height="4" rx="1"/></svg>
    </button>
  </div>
  <div style="font-size:12px;color:rgba(255,255,255,0.3);margin-top:20px" id="call-cost-display"></div>
</div>

<!-- Video Call Screen Overlay -->
<div class="video-call-screen" id="video-call-screen">
  <div class="video-remote" id="video-remote">
    <div class="video-placeholder" id="video-remote-placeholder">
      <svg width="64" height="64" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5"><polygon points="23 7 16 12 23 17 23 7"/><rect x="1" y="5" width="15" height="14" rx="2" ry="2"/></svg>
      <div style="font-size:16px;font-weight:600;margin-top:8px" id="video-remote-name">Waiting...</div>
      <div style="font-size:13px;margin-top:4px" id="video-call-status-text">Connecting video...</div>
    </div>
    <video id="remote-video" autoplay playsinline style="display:none"></video>
  </div>
  <div class="video-local">
    <video id="local-video" autoplay playsinline muted></video>
  </div>
  <div class="video-controls">
    <button class="call-ctrl-btn" id="video-mute-btn" onclick="toggleVideoMute()">
      <svg width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="#fff" stroke-width="2"><path d="M12 1a3 3 0 0 0-3 3v8a3 3 0 0 0 6 0V4a3 3 0 0 0-3-3z"/><path d="M19 10v2a7 7 0 0 1-14 0v-2"/></svg>
    </button>
    <button class="call-ctrl-btn" id="video-cam-btn" onclick="toggleVideoCamera()">
      <svg width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="#fff" stroke-width="2"><polygon points="23 7 16 12 23 17 23 7"/><rect x="1" y="5" width="15" height="14" rx="2" ry="2"/></svg>
    </button>
    <button class="call-ctrl-btn hangup-btn" onclick="endVideoCall()">
      <svg width="26" height="26" viewBox="0 0 24 24" fill="none" stroke="#fff" stroke-width="2"><path d="M22 16.92v3a2 2 0 0 1-2.18 2 19.79 19.79 0 0 1-8.63-3.07 19.5 19.5 0 0 1-6-6 19.79 19.79 0 0 1-3.07-8.67A2 2 0 0 1 4.11 2h3a2 2 0 0 1 2 1.72"/></svg>
    </button>
    <button class="call-ctrl-btn" id="video-flip-btn" onclick="flipVideoCamera()">
      <svg width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="#fff" stroke-width="2"><path d="M23 19a2 2 0 0 1-2 2H3a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h4l2-3h6l2 3h4a2 2 0 0 1 2 2z"/><circle cx="12" cy="13" r="4"/></svg>
    </button>
  </div>
</div>

<!-- Add Card Modal -->
<div class="modal-overlay" id="add-card-modal">
  <div class="modal-sheet">
    <div class="modal-handle"></div>
    <h3 style="margin-bottom:8px;font-size:20px;font-weight:700">Add Payment Method</h3>
    <p style="font-size:13px;color:var(--text2);margin-bottom:20px">Securely add a debit or credit card</p>
    <div id="stripe-card-element" style="padding:16px;background:var(--surface);border:1px solid var(--glass-border);border-radius:12px;margin-bottom:16px;min-height:44px"></div>
    <div id="card-errors" style="color:var(--red);font-size:13px;margin-bottom:16px;display:none"></div>
    <button id="add-card-submit" onclick="submitCardForm()" style="width:100%;padding:16px;background:var(--gradient2);border:none;border-radius:14px;color:white;font-size:16px;font-weight:600;cursor:pointer;font-family:inherit;box-shadow:0 4px 20px rgba(124,58,237,0.3)">Add Card</button>
    <button onclick="closeModals()" style="width:100%;padding:14px;background:none;border:none;color:var(--text2);font-size:14px;cursor:pointer;margin-top:8px;font-family:inherit">Cancel</button>
  </div>
</div>

<!-- Send Modal (Country-Aware) -->
<div class="modal-overlay" id="send-modal">
  <div class="modal-sheet" style="max-height:90vh">
    <div class="modal-handle"></div>
    <h3 style="margin-bottom:4px;font-size:20px;font-weight:700">Send Money</h3>
    <p id="send-currency-label" style="font-size:13px;color:var(--text2);margin-bottom:12px"></p>

    <!-- Domestic / International toggle -->
    <div id="send-scope-tabs" style="display:flex;gap:0;margin-bottom:14px;background:var(--surface);border-radius:12px;padding:3px;border:1px solid var(--glass-border)">
      <button class="send-scope-tab active" data-scope="domestic" onclick="switchSendScope('domestic')" style="flex:1;padding:10px;border-radius:10px;border:none;font-size:13px;font-weight:600;cursor:pointer;font-family:inherit;background:var(--gradient2);color:white;transition:all 0.2s">Domestic</button>
      <button class="send-scope-tab" data-scope="international" onclick="switchSendScope('international')" style="flex:1;padding:10px;border-radius:10px;border:none;font-size:13px;font-weight:600;cursor:pointer;font-family:inherit;background:transparent;color:var(--text2);transition:all 0.2s">International</button>
    </div>

    <!-- Transfer type tabs -->
    <div id="send-type-tabs" style="display:flex;gap:8px;margin-bottom:16px;overflow-x:auto;scrollbar-width:none">
      <button class="send-tab active" data-type="bank" onclick="switchSendType('bank')" style="padding:8px 16px;border-radius:20px;border:1px solid var(--glass-border);background:var(--gradient2);color:white;font-size:12px;font-weight:600;white-space:nowrap;cursor:pointer;font-family:inherit">Bank Transfer</button>
      <button class="send-tab" data-type="mobile_money" onclick="switchSendType('mobile_money')" style="padding:8px 16px;border-radius:20px;border:1px solid var(--glass-border);background:transparent;color:var(--text2);font-size:12px;font-weight:600;white-space:nowrap;cursor:pointer;font-family:inherit">Mobile Money</button>
      <button class="send-tab" data-type="wallet" onclick="switchSendType('wallet')" style="padding:8px 16px;border-radius:20px;border:1px solid var(--glass-border);background:transparent;color:var(--text2);font-size:12px;font-weight:600;white-space:nowrap;cursor:pointer;font-family:inherit">PromptPay</button>
    </div>

    <!-- Bank Transfer Fields -->
    <div id="send-bank-fields">
      <!-- Country selector for international -->
      <div id="send-intl-country-wrap" style="margin-bottom:14px;display:none">
        <label style="font-size:12px;color:var(--text2);display:block;margin-bottom:6px">Destination Country</label>
        <select id="send-intl-country" onchange="updateIntlFields()" style="width:100%;padding:14px;background:var(--surface);border:1px solid var(--glass-border);border-radius:12px;color:var(--text);font-size:14px;font-family:inherit;outline:none;-webkit-appearance:none">
          <option value="">Select country</option>
          <option value="US">United States</option>
          <option value="GB">United Kingdom</option>
          <option value="NG">Nigeria</option>
          <option value="GH">Ghana</option>
          <option value="KE">Kenya</option>
          <option value="UG">Uganda</option>
          <option value="IN">India</option>
          <option value="AU">Australia</option>
          <option value="CA">Canada</option>
          <option value="DE">Germany</option>
          <option value="FR">France</option>
        </select>
      </div>
      <div style="margin-bottom:14px">
        <label style="font-size:12px;color:var(--text2);display:block;margin-bottom:6px">Bank</label>
        <select id="send-bank" style="width:100%;padding:14px;background:var(--surface);border:1px solid var(--glass-border);border-radius:12px;color:var(--text);font-size:14px;font-family:inherit;outline:none;-webkit-appearance:none">
          <option value="">Select bank</option>
        </select>
      </div>
      <!-- Routing / Sort Code / IFSC / BSB field -->
      <div id="send-routing-wrap" style="margin-bottom:14px">
        <label id="send-routing-label" style="font-size:12px;color:var(--text2);display:block;margin-bottom:6px">Routing Number</label>
        <input id="send-routing" placeholder="000000000" inputmode="numeric" style="width:100%;padding:14px;background:var(--surface);border:1px solid var(--glass-border);border-radius:12px;color:var(--text);font-size:14px;font-family:inherit;outline:none">
        <div style="font-size:11px;color:var(--text3);margin-top:4px" id="send-routing-hint">9-digit ABA routing number</div>
      </div>
      <div style="margin-bottom:14px">
        <label style="font-size:12px;color:var(--text2);display:block;margin-bottom:6px">Account Number</label>
        <input id="send-account" placeholder="0000000000" inputmode="numeric" style="width:100%;padding:14px;background:var(--surface);border:1px solid var(--glass-border);border-radius:12px;color:var(--text);font-size:14px;font-family:inherit;outline:none">
      </div>
      <!-- SWIFT/BIC for international -->
      <div id="send-swift-wrap" style="margin-bottom:14px;display:none">
        <label style="font-size:12px;color:var(--text2);display:block;margin-bottom:6px">SWIFT / BIC Code</label>
        <input id="send-swift" placeholder="ABCDUS33XXX" maxlength="11" style="width:100%;padding:14px;background:var(--surface);border:1px solid var(--glass-border);border-radius:12px;color:var(--text);font-size:14px;font-family:inherit;outline:none;text-transform:uppercase">
      </div>
      <div id="send-recipient-name" style="padding:10px 16px;background:rgba(16,185,129,0.1);border-radius:10px;margin-bottom:14px;font-size:13px;color:var(--emerald);display:none"></div>
    </div>

    <!-- Mobile Money Fields -->
    <div id="send-momo-fields" style="display:none">
      <div style="margin-bottom:14px">
        <label style="font-size:12px;color:var(--text2);display:block;margin-bottom:6px">Provider</label>
        <select id="send-momo-provider" style="width:100%;padding:14px;background:var(--surface);border:1px solid var(--glass-border);border-radius:12px;color:var(--text);font-size:14px;font-family:inherit;outline:none;-webkit-appearance:none">
          <option value="">Select provider</option>
        </select>
      </div>
      <div style="margin-bottom:14px">
        <label style="font-size:12px;color:var(--text2);display:block;margin-bottom:6px">Phone Number</label>
        <input id="send-momo-phone" placeholder="+234..." type="tel" style="width:100%;padding:14px;background:var(--surface);border:1px solid var(--glass-border);border-radius:12px;color:var(--text);font-size:14px;font-family:inherit;outline:none">
      </div>
    </div>

    <!-- Wallet (PromptPay) Fields -->
    <div id="send-wallet-fields" style="display:none">
      <div style="margin-bottom:14px">
        <label style="font-size:12px;color:var(--text2);display:block;margin-bottom:6px">Recipient</label>
        <input id="send-to" placeholder="Email, phone, or $PayTag" style="width:100%;padding:14px;background:var(--surface);border:1px solid var(--glass-border);border-radius:12px;color:var(--text);font-size:14px;font-family:inherit;outline:none">
      </div>
    </div>

    <!-- Common: Amount + Note -->
    <div style="margin-bottom:14px">
      <label style="font-size:12px;color:var(--text2);display:block;margin-bottom:6px">Amount</label>
      <input id="send-amount" placeholder="0.00" type="number" step="0.01" style="width:100%;padding:14px;background:var(--surface);border:1px solid var(--glass-border);border-radius:12px;color:var(--text);font-size:24px;font-weight:700;font-family:inherit;outline:none;text-align:center">
    </div>
    <div id="send-fee-display" style="text-align:center;font-size:12px;color:var(--text3);margin-bottom:14px"></div>
    <div style="margin-bottom:20px">
      <label style="font-size:12px;color:var(--text2);display:block;margin-bottom:6px">Note (optional)</label>
      <input id="send-note" placeholder="What's this for?" style="width:100%;padding:14px;background:var(--surface);border:1px solid var(--glass-border);border-radius:12px;color:var(--text);font-size:14px;font-family:inherit;outline:none">
    </div>
    <button id="send-submit-btn" onclick="executeSend()" style="width:100%;padding:16px;background:var(--gradient2);border:none;border-radius:14px;color:white;font-size:16px;font-weight:600;cursor:pointer;font-family:inherit;box-shadow:0 4px 20px rgba(124,58,237,0.3)">Send Payment</button>
    <button onclick="closeModals()" style="width:100%;padding:14px;background:none;border:none;color:var(--text2);font-size:14px;cursor:pointer;margin-top:8px;font-family:inherit">Cancel</button>
    <div id="send-error" style="color:var(--red);font-size:13px;margin-top:12px;text-align:center"></div>
  </div>
</div>

<!-- QR Modal — Bidirectional -->
<div class="modal-overlay" id="qr-modal">
  <div class="modal-sheet" style="text-align:center;max-height:90vh;overflow-y:auto">
    <div class="modal-handle"></div>
    <h3 style="margin-bottom:12px;font-size:20px;font-weight:700">QR Code</h3>
    <!-- Tabs -->
    <div style="display:flex;gap:4px;background:var(--surface);border-radius:12px;padding:4px;margin-bottom:20px">
      <button id="qr-tab-display" onclick="switchQrTab('display')" style="flex:1;padding:10px;border:none;border-radius:10px;background:var(--gradient2);color:white;font-size:13px;font-weight:600;cursor:pointer;font-family:inherit">My QR</button>
      <button id="qr-tab-scan" onclick="switchQrTab('scan')" style="flex:1;padding:10px;border:none;border-radius:10px;background:transparent;color:var(--text2);font-size:13px;font-weight:600;cursor:pointer;font-family:inherit">Scan QR</button>
    </div>
    <!-- Display Tab -->
    <div id="qr-display-panel">
      <p style="font-size:13px;color:var(--text2);margin-bottom:16px">Others can scan this to pay you</p>
      <div style="background:white;border-radius:20px;padding:20px;display:inline-block;margin-bottom:12px">
        <canvas id="qr-canvas" width="200" height="200"></canvas>
      </div>
      <div style="font-size:12px;color:var(--text3);margin-bottom:16px" id="qr-pay-link"></div>
      <button onclick="copyQrLink()" style="width:100%;padding:12px;background:var(--gradient2);border:none;border-radius:12px;color:white;font-size:14px;font-weight:600;cursor:pointer;font-family:inherit;margin-bottom:8px">Copy Pay Link</button>
    </div>
    <!-- Scan Tab -->
    <div id="qr-scan-panel" style="display:none">
      <p style="font-size:13px;color:var(--text2);margin-bottom:16px">Point your camera at a QR code</p>
      <div style="position:relative;width:100%;aspect-ratio:1;border-radius:16px;overflow:hidden;background:#000;margin-bottom:12px">
        <video id="qr-video" autoplay playsinline muted style="width:100%;height:100%;object-fit:cover"></video>
        <div style="position:absolute;inset:0;display:flex;align-items:center;justify-content:center;pointer-events:none">
          <div style="width:200px;height:200px;border:2px solid rgba(124,58,237,0.8);border-radius:16px;box-shadow:0 0 0 9999px rgba(0,0,0,0.4)"></div>
        </div>
        <canvas id="qr-scan-canvas" style="display:none"></canvas>
      </div>
      <div id="qr-scan-result" style="display:none;padding:12px;background:rgba(16,185,129,0.1);border-radius:12px;margin-bottom:8px;font-size:13px;color:var(--emerald)"></div>
      <div id="qr-scan-error" style="display:none;padding:12px;background:rgba(239,68,68,0.1);border-radius:12px;margin-bottom:8px;font-size:13px;color:var(--red)"></div>
    </div>
    <button onclick="closeQrModal()" style="width:100%;padding:14px;background:var(--surface);border:1px solid var(--glass-border);border-radius:14px;color:var(--text);font-size:14px;cursor:pointer;font-family:inherit">Close</button>
  </div>
</div>

<!-- Pay by Phone Modal -->
<div class="modal-overlay" id="pay-modal">
  <div class="modal-sheet">
    <div class="modal-handle"></div>
    <h3 style="margin-bottom:8px;font-size:20px;font-weight:700">Pay by Phone</h3>
    <p style="font-size:13px;color:var(--text2);margin-bottom:20px">Use Apple Pay, Google Pay, or your saved cards</p>
    <div style="margin-bottom:16px">
      <label style="font-size:12px;color:var(--text2);display:block;margin-bottom:6px">Amount</label>
      <input id="pay-amount" placeholder="$0.00" type="number" step="0.01" style="width:100%;padding:14px;background:var(--surface);border:1px solid var(--glass-border);border-radius:12px;color:var(--text);font-size:24px;font-weight:700;font-family:inherit;outline:none;text-align:center">
    </div>
    <div style="margin-bottom:20px">
      <label style="font-size:12px;color:var(--text2);display:block;margin-bottom:6px">What's this for?</label>
      <input id="pay-label" placeholder="Coffee, groceries, etc." style="width:100%;padding:14px;background:var(--surface);border:1px solid var(--glass-border);border-radius:12px;color:var(--text);font-size:14px;font-family:inherit;outline:none">
    </div>
    <button onclick="executePayByPhone()" style="width:100%;padding:16px;background:var(--gradient2);border:none;border-radius:14px;color:white;font-size:16px;font-weight:600;cursor:pointer;font-family:inherit;box-shadow:0 4px 20px rgba(124,58,237,0.3);display:flex;align-items:center;justify-content:center;gap:8px">
      <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="5" y="2" width="14" height="20" rx="2" ry="2"/><line x1="12" y1="18" x2="12.01" y2="18"/></svg>
      Pay Now
    </button>
    <button onclick="closeModals()" style="width:100%;padding:14px;background:none;border:none;color:var(--text2);font-size:14px;cursor:pointer;margin-top:8px;font-family:inherit">Cancel</button>
  </div>
</div>

<!-- Airtime Modal -->
<div class="modal-overlay" id="airtime-modal" onclick="if(event.target===this)closeAirtimeModal()">
  <div class="modal-sheet">
    <div class="modal-handle"></div>
    <h3 style="margin-bottom: 4px;">Top Up Phone</h3>
    <p style="font-size: 0.85rem; opacity: 0.7; margin-bottom: 16px;">Buy airtime or data instantly - 2% convenience fee</p>

    <!-- Buy for self or someone else -->
    <div style="display:flex;gap:8px;margin-bottom:14px;">
      <button id="airtime-self-btn" onclick="setAirtimeRecipient('self')" style="flex:1;padding:10px;border-radius:10px;border:1px solid rgba(124,58,237,0.4);background:rgba(124,58,237,0.15);color:white;cursor:pointer;font-size:13px;font-weight:600;">For myself</button>
      <button id="airtime-other-btn" onclick="setAirtimeRecipient('other')" style="flex:1;padding:10px;border-radius:10px;border:1px solid rgba(255,255,255,0.1);background:rgba(255,255,255,0.03);color:var(--text2);cursor:pointer;font-size:13px;">For someone else</button>
    </div>

    <!-- Country -->
    <label style="font-size:12px;color:var(--text2);display:block;margin-bottom:6px">Country</label>
    <select id="airtime-country" onchange="updateCarriers()" style="width:100%;padding:14px;border-radius:12px;border:1px solid rgba(255,255,255,0.1);background:rgba(255,255,255,0.05);color:white;font-size:1rem;margin-bottom:12px;-webkit-appearance:none;appearance:none;">
      <option value="NG">Nigeria (+234)</option>
      <option value="GH">Ghana (+233)</option>
      <option value="UG">Uganda (+256)</option>
      <option value="KE">Kenya (+254)</option>
      <option value="ZA">South Africa (+27)</option>
      <option value="TZ">Tanzania (+255)</option>
      <option value="CM">Cameroon (+237)</option>
      <option value="SN">Senegal (+221)</option>
      <option value="ET">Ethiopia (+251)</option>
    </select>

    <!-- Carrier -->
    <label style="font-size:12px;color:var(--text2);display:block;margin-bottom:6px">Carrier / Operator</label>
    <select id="airtime-carrier" style="width:100%;padding:14px;border-radius:12px;border:1px solid rgba(255,255,255,0.1);background:rgba(255,255,255,0.05);color:white;font-size:1rem;margin-bottom:12px;-webkit-appearance:none;appearance:none;">
      <!-- Populated by updateCarriers() -->
    </select>

    <!-- Phone Number -->
    <label style="font-size:12px;color:var(--text2);display:block;margin-bottom:6px"><span id="airtime-phone-label">Your phone number</span></label>
    <div style="display:flex;gap:8px;margin-bottom:12px;">
      <span id="airtime-dial-code" style="padding:14px 12px;border-radius:12px;border:1px solid rgba(255,255,255,0.1);background:rgba(255,255,255,0.05);color:var(--text2);font-size:1rem;white-space:nowrap;">+234</span>
      <input id="airtime-phone" type="tel" placeholder="8012345678" style="flex:1;padding:14px;border-radius:12px;border:1px solid rgba(255,255,255,0.1);background:rgba(255,255,255,0.05);color:white;font-size:1rem;box-sizing:border-box;">
    </div>

    <!-- Amount presets (updated per country currency) -->
    <label style="font-size:12px;color:var(--text2);display:block;margin-bottom:6px">Amount (<span id="airtime-currency-label">NGN</span>)</label>
    <div id="airtime-presets" style="display:grid;grid-template-columns:repeat(4,1fr);gap:8px;margin-bottom:12px;">
      <!-- Populated by updateCarriers() -->
    </div>
    <input id="airtime-amount" type="number" placeholder="Custom amount" style="width:100%;padding:14px;border-radius:12px;border:1px solid rgba(255,255,255,0.1);background:rgba(255,255,255,0.05);color:white;font-size:1rem;margin-bottom:4px;box-sizing:border-box;">
    <div id="airtime-fee-display" style="font-size:12px;color:var(--text3);margin-bottom:14px;text-align:right;">Fee: 2% convenience charge</div>

    <!-- Action buttons -->
    <div style="display:grid;grid-template-columns:1fr 1fr;gap:8px;">
      <button onclick="executeAirtime('airtime')" style="padding:14px;border-radius:12px;border:none;background:linear-gradient(135deg,#f97316,#ea580c);color:white;font-weight:600;cursor:pointer;font-size:14px;">Buy Airtime</button>
      <button onclick="executeAirtime('data')" style="padding:14px;border-radius:12px;border:none;background:linear-gradient(135deg,#3b82f6,#2563eb);color:white;font-weight:600;cursor:pointer;font-size:14px;">Buy Data</button>
    </div>
  </div>
</div>

<!-- Request Money Modal -->
<div class="modal-overlay" id="request-modal" onclick="if(event.target===this)closeRequestModal()">
  <div class="modal-sheet">
    <div class="modal-handle"></div>
    <h3 style="margin-bottom: 4px;">💸 Request Money</h3>
    <p style="font-size: 0.85rem; opacity: 0.7; margin-bottom: 16px;">Send a payment request — they need PromptPay to pay</p>
    <input id="request-contact" type="text" placeholder="Email, phone, or $paytag" style="width: 100%; padding: 14px; border-radius: 12px; border: 1px solid rgba(255,255,255,0.1); background: rgba(255,255,255,0.05); color: white; font-size: 1rem; margin-bottom: 12px; box-sizing: border-box;">
    <input id="request-amount" type="number" placeholder="Amount ($)" style="width: 100%; padding: 14px; border-radius: 12px; border: 1px solid rgba(255,255,255,0.1); background: rgba(255,255,255,0.05); color: white; font-size: 1rem; margin-bottom: 12px; box-sizing: border-box;">
    <input id="request-message" type="text" placeholder="What's it for? (optional)" style="width: 100%; padding: 14px; border-radius: 12px; border: 1px solid rgba(255,255,255,0.1); background: rgba(255,255,255,0.05); color: white; font-size: 1rem; margin-bottom: 12px; box-sizing: border-box;">
    <button onclick="executeRequestMoney()" style="width: 100%; padding: 14px; border-radius: 12px; border: none; background: linear-gradient(135deg, #7c3aed, #6d28d9); color: white; font-weight: 600; font-size: 1rem; cursor: pointer;">Send Request</button>
  </div>
</div>

<!-- PayTag Setup Modal -->
<div class="modal-overlay" id="paytag-modal" onclick="if(event.target===this)closePaytagModal()">
  <div class="modal-sheet">
    <div class="modal-handle"></div>
    <h3 style="margin-bottom: 4px;">Claim Your $PayTag</h3>
    <p style="font-size: 0.85rem; opacity: 0.7; margin-bottom: 16px;">Like Cash App's $cashtag — your unique payment identity</p>
    <div style="display: flex; align-items: center; gap: 4px; margin-bottom: 12px;">
      <span style="font-size: 1.5rem; font-weight: 700; color: #7c3aed;">$</span>
      <input id="paytag-input" type="text" placeholder="yourname" maxlength="20" style="flex: 1; padding: 14px; border-radius: 12px; border: 1px solid rgba(255,255,255,0.1); background: rgba(255,255,255,0.05); color: white; font-size: 1.1rem; font-weight: 600; box-sizing: border-box;">
    </div>
    <p id="paytag-hint" style="font-size: 0.8rem; opacity: 0.5; margin-bottom: 16px;">Letters, numbers, and underscores only. 3-20 characters.</p>
    <button onclick="claimPaytag()" style="width: 100%; padding: 14px; border-radius: 12px; border: none; background: linear-gradient(135deg, #7c3aed, #6d28d9); color: white; font-weight: 600; font-size: 1rem; cursor: pointer;">Claim $PayTag</button>
  </div>
</div>

<!-- Settings Toast -->
<div class="settings-saved-toast" id="settings-toast">Settings saved successfully</div>

<!-- KYC Verification Modal -->
<div class="modal-overlay" id="kyc-modal">
  <div class="modal-sheet" style="max-height:90vh">
    <div class="modal-handle"></div>
    <h3 style="margin-bottom:4px;font-size:20px;font-weight:700">Verify Your Identity</h3>
    <p id="kyc-subtitle" style="font-size:13px;color:var(--text2);margin-bottom:20px">Complete verification to start sending money</p>
    <div id="kyc-tier-badge" style="display:inline-block;padding:4px 12px;border-radius:20px;font-size:11px;font-weight:600;background:rgba(255,255,255,0.06);color:var(--text2);margin-bottom:16px">Unverified</div>

    <!-- Country-specific KYC fields -->
    <div id="kyc-fields">
      <!-- Nigeria -->
      <div id="kyc-ng" class="kyc-country-form" style="display:none">
        <div style="margin-bottom:14px">
          <label style="font-size:12px;color:var(--text2);display:block;margin-bottom:6px">BVN (Bank Verification Number)</label>
          <input id="kyc-bvn" placeholder="22200000000" maxlength="11" inputmode="numeric" style="width:100%;padding:14px;background:var(--surface);border:1px solid var(--glass-border);border-radius:12px;color:var(--text);font-size:14px;font-family:inherit;outline:none">
          <div style="font-size:11px;color:var(--text3);margin-top:4px">Dial *565*0# on your phone to get your BVN</div>
        </div>
        <div style="margin-bottom:14px">
          <label style="font-size:12px;color:var(--text2);display:block;margin-bottom:6px">NIN (National ID Number) <span style="opacity:0.5">optional for Tier 1</span></label>
          <input id="kyc-nin" placeholder="00000000000" maxlength="11" inputmode="numeric" style="width:100%;padding:14px;background:var(--surface);border:1px solid var(--glass-border);border-radius:12px;color:var(--text);font-size:14px;font-family:inherit;outline:none">
        </div>
      </div>

      <!-- Ghana -->
      <div id="kyc-gh" class="kyc-country-form" style="display:none">
        <div style="margin-bottom:14px">
          <label style="font-size:12px;color:var(--text2);display:block;margin-bottom:6px">Ghana Card Number</label>
          <input id="kyc-ghana-card" placeholder="GHA-XXXXXXXXX-X" maxlength="15" style="width:100%;padding:14px;background:var(--surface);border:1px solid var(--glass-border);border-radius:12px;color:var(--text);font-size:14px;font-family:inherit;outline:none">
        </div>
      </div>

      <!-- Kenya / Uganda -->
      <div id="kyc-ke-ug" class="kyc-country-form" style="display:none">
        <div style="margin-bottom:14px">
          <label style="font-size:12px;color:var(--text2);display:block;margin-bottom:6px">National ID Number</label>
          <input id="kyc-national-id" placeholder="Enter your national ID" inputmode="numeric" style="width:100%;padding:14px;background:var(--surface);border:1px solid var(--glass-border);border-radius:12px;color:var(--text);font-size:14px;font-family:inherit;outline:none">
        </div>
      </div>

      <!-- US -->
      <div id="kyc-us" class="kyc-country-form" style="display:none">
        <div style="margin-bottom:14px">
          <label style="font-size:12px;color:var(--text2);display:block;margin-bottom:6px">Date of Birth</label>
          <input id="kyc-dob" type="date" style="width:100%;padding:14px;background:var(--surface);border:1px solid var(--glass-border);border-radius:12px;color:var(--text);font-size:14px;font-family:inherit;outline:none">
        </div>
      </div>

      <!-- South Africa -->
      <div id="kyc-za" class="kyc-country-form" style="display:none">
        <div style="margin-bottom:14px">
          <label style="font-size:12px;color:var(--text2);display:block;margin-bottom:6px">SA ID Number</label>
          <input id="kyc-sa-id" placeholder="13-digit SA ID number" maxlength="13" inputmode="numeric" style="width:100%;padding:14px;background:var(--surface);border:1px solid var(--glass-border);border-radius:12px;color:var(--text);font-size:14px;font-family:inherit;outline:none">
        </div>
      </div>

      <!-- Generic Africa (TZ, CM, SN, ET) -->
      <div id="kyc-generic-africa" class="kyc-country-form" style="display:none">
        <div style="margin-bottom:14px">
          <label style="font-size:12px;color:var(--text2);display:block;margin-bottom:6px">National ID Number</label>
          <input id="kyc-national-id-generic" placeholder="Your national ID number" style="width:100%;padding:14px;background:var(--surface);border:1px solid var(--glass-border);border-radius:12px;color:var(--text);font-size:14px;font-family:inherit;outline:none">
        </div>
      </div>

      <!-- Common fields -->
      <div style="margin-bottom:14px">
        <label style="font-size:12px;color:var(--text2);display:block;margin-bottom:6px">Full Legal Name</label>
        <input id="kyc-fullname" placeholder="As it appears on your ID" style="width:100%;padding:14px;background:var(--surface);border:1px solid var(--glass-border);border-radius:12px;color:var(--text);font-size:14px;font-family:inherit;outline:none">
      </div>
      <div style="margin-bottom:20px">
        <label style="font-size:12px;color:var(--text2);display:block;margin-bottom:6px">Phone Number</label>
        <input id="kyc-phone" placeholder="+234..." type="tel" style="width:100%;padding:14px;background:var(--surface);border:1px solid var(--glass-border);border-radius:12px;color:var(--text);font-size:14px;font-family:inherit;outline:none">
      </div>
    </div>

    <div id="kyc-limits-preview" style="padding:12px 16px;background:rgba(124,58,237,0.08);border-radius:12px;margin-bottom:16px;font-size:12px;color:var(--text2)"></div>

    <button id="kyc-submit-btn" onclick="submitKyc()" style="width:100%;padding:16px;background:var(--gradient2);border:none;border-radius:14px;color:white;font-size:16px;font-weight:600;cursor:pointer;font-family:inherit;box-shadow:0 4px 20px rgba(124,58,237,0.3)">Verify & Continue</button>
    <button onclick="closeModals()" style="width:100%;padding:14px;background:none;border:none;color:var(--text2);font-size:14px;cursor:pointer;margin-top:8px;font-family:inherit">Skip for now</button>
    <div id="kyc-error" style="color:var(--red);font-size:13px;margin-top:12px;text-align:center"></div>
  </div>
</div>

<!-- Link Bank Account Modal -->
<div class="modal-overlay" id="bank-modal">
  <div class="modal-sheet">
    <div class="modal-handle"></div>
    <h3 style="margin-bottom:8px;font-size:20px;font-weight:700">Link Bank Account</h3>
    <p style="font-size:13px;color:var(--text2);margin-bottom:20px">Add your bank for instant transfers</p>
    <div style="margin-bottom:14px">
      <label style="font-size:12px;color:var(--text2);display:block;margin-bottom:6px">Bank</label>
      <select id="bank-select" onchange="onBankSelect()" style="width:100%;padding:14px;background:var(--surface);border:1px solid var(--glass-border);border-radius:12px;color:var(--text);font-size:14px;font-family:inherit;outline:none;-webkit-appearance:none">
        <option value="">Select your bank</option>
      </select>
    </div>
    <div style="margin-bottom:14px">
      <label style="font-size:12px;color:var(--text2);display:block;margin-bottom:6px">Account Number</label>
      <input id="bank-account-number" placeholder="0000000000" maxlength="10" inputmode="numeric" style="width:100%;padding:14px;background:var(--surface);border:1px solid var(--glass-border);border-radius:12px;color:var(--text);font-size:14px;font-family:inherit;outline:none">
    </div>
    <div id="bank-account-name" style="padding:10px 16px;background:rgba(16,185,129,0.1);border-radius:10px;margin-bottom:16px;font-size:13px;color:var(--emerald);display:none"></div>
    <button onclick="submitBankAccount()" style="width:100%;padding:16px;background:var(--gradient2);border:none;border-radius:14px;color:white;font-size:16px;font-weight:600;cursor:pointer;font-family:inherit">Link Account</button>
    <button onclick="closeModals()" style="width:100%;padding:14px;background:none;border:none;color:var(--text2);font-size:14px;cursor:pointer;margin-top:8px;font-family:inherit">Cancel</button>
    <div id="bank-error" style="color:var(--red);font-size:13px;margin-top:12px;text-align:center"></div>
  </div>
</div>

<!-- Link Mobile Money Modal -->
<div class="modal-overlay" id="momo-modal">
  <div class="modal-sheet">
    <div class="modal-handle"></div>
    <h3 style="margin-bottom:8px;font-size:20px;font-weight:700">Link Mobile Money</h3>
    <p style="font-size:13px;color:var(--text2);margin-bottom:20px">Add your mobile money wallet</p>
    <div style="margin-bottom:14px">
      <label style="font-size:12px;color:var(--text2);display:block;margin-bottom:6px">Provider</label>
      <select id="momo-provider" style="width:100%;padding:14px;background:var(--surface);border:1px solid var(--glass-border);border-radius:12px;color:var(--text);font-size:14px;font-family:inherit;outline:none;-webkit-appearance:none">
        <option value="">Select provider</option>
      </select>
    </div>
    <div style="margin-bottom:14px">
      <label style="font-size:12px;color:var(--text2);display:block;margin-bottom:6px">Phone Number</label>
      <input id="momo-phone" placeholder="+233..." type="tel" style="width:100%;padding:14px;background:var(--surface);border:1px solid var(--glass-border);border-radius:12px;color:var(--text);font-size:14px;font-family:inherit;outline:none">
    </div>
    <button onclick="submitMobileWallet()" style="width:100%;padding:16px;background:var(--gradient2);border:none;border-radius:14px;color:white;font-size:16px;font-weight:600;cursor:pointer;font-family:inherit">Link Wallet</button>
    <button onclick="closeModals()" style="width:100%;padding:14px;background:none;border:none;color:var(--text2);font-size:14px;cursor:pointer;margin-top:8px;font-family:inherit">Cancel</button>
    <div id="momo-error" style="color:var(--red);font-size:13px;margin-top:12px;text-align:center"></div>
  </div>
</div>

<!-- Fund Wallet Modal -->
<div class="modal-overlay" id="fund-wallet-modal" onclick="if(event.target===this)closeFundModal()">
  <div class="modal-sheet">
    <div class="modal-handle"></div>
    <h3 style="margin-bottom:8px;font-size:20px;font-weight:700">Fund Wallet</h3>
    <p style="font-size:13px;color:var(--text2);margin-bottom:16px">Add funds from your linked card</p>
    <div class="fund-modal-amounts">
      <button class="fund-amt-btn" onclick="fundSetAmount(500)">&#8358;500</button>
      <button class="fund-amt-btn" onclick="fundSetAmount(1000)">&#8358;1,000</button>
      <button class="fund-amt-btn" onclick="fundSetAmount(2000)">&#8358;2,000</button>
      <button class="fund-amt-btn" onclick="fundSetAmount(5000)">&#8358;5,000</button>
      <button class="fund-amt-btn" onclick="fundSetAmount(10000)">&#8358;10K</button>
      <button class="fund-amt-btn" onclick="fundSetAmount(50000)">&#8358;50K</button>
    </div>
    <div style="margin-bottom:14px">
      <label style="font-size:12px;color:var(--text2);display:block;margin-bottom:6px">Custom Amount (NGN)</label>
      <input id="fund-amount" type="number" placeholder="Enter amount (min &#8358;100)" class="pos-input">
    </div>
    <div id="fund-card-select" style="margin-bottom:14px"></div>
    <button id="fund-submit-btn" onclick="submitFundWallet()" style="width:100%;padding:16px;background:var(--gradient2);border:none;border-radius:14px;color:white;font-size:16px;font-weight:600;cursor:pointer;font-family:inherit;box-shadow:0 4px 20px rgba(124,58,237,0.3)">Fund Wallet</button>
    <button onclick="closeFundModal()" style="width:100%;padding:14px;background:none;border:none;color:var(--text2);font-size:14px;cursor:pointer;margin-top:8px;font-family:inherit">Cancel</button>
    <div id="fund-error" style="color:var(--red);font-size:13px;margin-top:12px;text-align:center"></div>
  </div>
</div>

<!-- POS Receipt Modal -->
<div class="modal-overlay" id="pos-receipt-modal" onclick="if(event.target===this)closeReceiptModal()">
  <div class="modal-sheet" style="max-width:380px;margin:0 auto">
    <div class="modal-handle"></div>
    <div id="pos-receipt-content"></div>
    <div style="display:flex;gap:10px;margin-top:16px">
      <button onclick="shareReceipt()" style="flex:1;padding:14px;background:var(--surface);border:1px solid var(--glass-border);border-radius:12px;color:var(--text);font-size:14px;font-weight:600;cursor:pointer;font-family:inherit">Share</button>
      <button onclick="closeReceiptModal()" style="flex:1;padding:14px;background:var(--gradient2);border:none;border-radius:12px;color:white;font-size:14px;font-weight:600;cursor:pointer;font-family:inherit">Done</button>
    </div>
  </div>
</div>

<!-- Premium Feature Popup -->
<div class="premium-popup-overlay" id="premium-popup" onclick="if(event.target===this)closePremiumPopup()">
  <div class="premium-popup">
    <div class="premium-popup-icon" id="premium-popup-icon"></div>
    <h3 id="premium-popup-title">Unlock Premium</h3>
    <p>Unlock AI Shopping, Trading, Budgets & more with PromptPay Premium.</p>
    <div class="price">$19.99/month</div>
    <button class="btn-subscribe" onclick="subscribePremium()">Subscribe Now</button>
    <button class="btn-later" onclick="closePremiumPopup()">Maybe Later</button>
  </div>
</div>

<script>
// ═══ PromptPay Frontend Engine ═══
const API_BASE = '';
let ws = null;
let currentPage = 'home';
let tokenStats = { used: 0, cached: 0, saved: 0 };
let chatHistory = [];
let animatedBalance = 0;
let authToken = localStorage.getItem('promptpay_token') || null;
let currentUser = null;
let userKyc = null;
let countryConfig = null;
let userBankAccounts = [];
let userMobileWallets = [];
let currentSendType = 'bank';

// ── Token Expiry Check (client-side) ──
function isTokenExpired(token) {
  try {
    const parts = token.split('.');
    if (parts.length < 2) return true;
    // Token format is payloadB64.signature — payload is parts[0]
    const payload = JSON.parse(atob(parts[0].replace(/-/g, '+').replace(/_/g, '/')));
    // exp is in milliseconds (Date.now() format), no need to multiply by 1000
    return !payload.exp || payload.exp < Date.now();
  } catch { return true; }
}

// Auto-clear expired token on load
if (authToken && isTokenExpired(authToken)) {
  localStorage.removeItem('promptpay_token');
  authToken = null;
}

// ── Auth Helpers ──
function getAuthHeaders() {
  const headers = { 'Content-Type': 'application/json' };
  if (authToken) headers['Authorization'] = 'Bearer ' + authToken;
  return headers;
}

async function authFetch(url, options = {}) {
  // Auto-clear expired tokens before making requests
  if (authToken && isTokenExpired(authToken)) {
    localStorage.removeItem('promptpay_token');
    authToken = null;
    currentUser = null;
    showAuthGate('login');
    document.getElementById('login-error').textContent = 'Your session has expired. Please sign in again.';
    return new Response(JSON.stringify({ error: 'Token expired' }), { status: 401 });
  }
  options.headers = { ...getAuthHeaders(), ...(options.headers || {}) };
  const res = await fetch(url, options);
  if (res.status === 401) {
    localStorage.removeItem('promptpay_token');
    authToken = null;
    currentUser = null;
    showAuthGate('login');
    document.getElementById('login-error').textContent = 'Your session has expired. Please sign in again.';
  }
  return res;
}

// ── Auth Gate ──
function switchAuthTab(tab) {
  document.querySelectorAll('.auth-tab').forEach(t => t.classList.remove('active'));
  document.querySelectorAll('.auth-form').forEach(f => f.classList.remove('active'));
  if (tab === 'login') {
    document.querySelectorAll('.auth-tab')[0].classList.add('active');
    document.getElementById('auth-login-form').classList.add('active');
  } else {
    document.querySelectorAll('.auth-tab')[1].classList.add('active');
    document.getElementById('auth-register-form').classList.add('active');
  }
  // Clear errors
  document.getElementById('login-error').textContent = '';
  document.getElementById('register-error').textContent = '';
}

function togglePassword(inputId, btn) {
  const input = document.getElementById(inputId);
  const isHidden = input.type === 'password';
  input.type = isHidden ? 'text' : 'password';
  btn.querySelector('.eye-open').style.display = isHidden ? 'none' : 'block';
  btn.querySelector('.eye-closed').style.display = isHidden ? 'block' : 'none';
  btn.setAttribute('aria-label', isHidden ? 'Hide password' : 'Show password');
}

async function handleLogin(e) {
  e.preventDefault();
  const email = document.getElementById('login-email').value.trim();
  const password = document.getElementById('login-password').value;
  const errorEl = document.getElementById('login-error');
  const submitBtn = document.getElementById('login-submit');
  errorEl.textContent = '';
  submitBtn.disabled = true;
  submitBtn.textContent = 'Signing in...';

  try {
    const res = await fetch(API_BASE + '/api/auth/login', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ email, password })
    });
    const data = await res.json();
    if (!res.ok) {
      errorEl.textContent = data.error || data.message || 'Invalid credentials';
      return;
    }
    authToken = data.token;
    currentUser = data.user;
    localStorage.setItem('promptpay_token', authToken);
    showApp();
  } catch (err) {
    errorEl.textContent = 'Connection error. Please try again.';
  } finally {
    submitBtn.disabled = false;
    submitBtn.textContent = 'Sign In';
  }
}

async function handleRegister(e) {
  e.preventDefault();
  const displayName = document.getElementById('register-name').value.trim();
  const email = document.getElementById('register-email').value.trim();
  const country = document.getElementById('register-country').value;
  const password = document.getElementById('register-password').value;
  const errorEl = document.getElementById('register-error');
  const submitBtn = document.getElementById('register-submit');
  errorEl.textContent = '';
  if (!country) { errorEl.textContent = 'Please select your country'; return; }
  submitBtn.disabled = true;
  submitBtn.textContent = 'Creating account...';

  try {
    const res = await fetch(API_BASE + '/api/auth/register', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ email, password, displayName, country })
    });
    const data = await res.json();
    if (!res.ok) {
      errorEl.textContent = data.error || data.message || 'Registration failed';
      return;
    }
    authToken = data.token;
    currentUser = data.user;
    localStorage.setItem('promptpay_token', authToken);
    showApp();
  } catch (err) {
    errorEl.textContent = 'Connection error. Please try again.';
  } finally {
    submitBtn.disabled = false;
    submitBtn.textContent = 'Create Account';
  }
}

function handleLogout() {
  authToken = null;
  currentUser = null;
  localStorage.removeItem('promptpay_token');
  localStorage.removeItem('promptpay_user');
  document.getElementById('login-email').value = '';
  document.getElementById('login-password').value = '';
  document.getElementById('register-name').value = '';
  document.getElementById('register-email').value = '';
  document.getElementById('register-password').value = '';
  document.getElementById('login-error').textContent = '';
  document.getElementById('register-error').textContent = '';
  navigateTo('home');
  showLanding();
  startLandingTyping();
}

function showApp() {
  enterAppMode();
  if (currentUser) {
    const name = currentUser.displayName || currentUser.email || 'User';
    document.querySelector('.header-name').textContent = name;
    const initials = name.split(' ').map(n => n[0]).join('').toUpperCase().slice(0, 2);
    // Update header avatar — show picture or initials
    const headerAvatar = document.querySelector('.header-avatar');
    if (currentUser.profilePicture) {
      headerAvatar.innerHTML = '<img src="' + currentUser.profilePicture + '" style="width:100%;height:100%;object-fit:cover;border-radius:50%">';
    } else {
      headerAvatar.textContent = initials || 'PP';
    }
    // Update profile page
    const profilePicImg = document.getElementById('profile-pic-img');
    const profilePicInitials = document.getElementById('profile-pic-initials');
    if (currentUser.profilePicture && profilePicImg) {
      profilePicImg.src = currentUser.profilePicture;
      profilePicImg.style.display = 'block';
      if (profilePicInitials) profilePicInitials.style.display = 'none';
    } else if (profilePicInitials) {
      profilePicInitials.textContent = initials || 'PP';
    }
    const profileName = document.getElementById('profile-display-name');
    if (profileName) profileName.textContent = name;
    const profileEmail = document.getElementById('profile-email-display');
    if (profileEmail) profileEmail.textContent = currentUser.email || '';
    // Save country for geo-gating
    if (currentUser.country) {
      localStorage.setItem('promptpay_country', currentUser.country);
    }
  }
  // Geo-gate: hide airtime button for US/Europe users
  applyAirtimeGeoGate();
  loadData();
  connectWebSocket();
  updateTokenMatrix();
  loadSettings();
  loadPaymentMethods();
  initStripeElements(); // Pre-load Stripe for card form
}

async function handleProfilePicUpload(event) {
  const file = event.target.files[0];
  if (!file) return;
  if (!file.type.startsWith('image/')) {
    showToast('Please select an image file');
    return;
  }
  if (file.size > 5 * 1024 * 1024) {
    showToast('Image too large. Max 5MB');
    return;
  }
  showToast('Uploading...', 'info');
  // Compress image via canvas to keep payload small
  try {
    const dataUrl = await compressImage(file, 400, 0.8);
    const res = await authFetch(API_BASE + '/api/auth/profile-picture', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ image: dataUrl }),
    });
    if (res.ok) {
      currentUser.profilePicture = dataUrl;
      try { localStorage.setItem('promptpay_user', JSON.stringify(currentUser)); } catch(e) {}
      const headerAvatar = document.querySelector('.header-avatar');
      if (headerAvatar) headerAvatar.innerHTML = '<img src="' + dataUrl + '" style="width:100%;height:100%;object-fit:cover;border-radius:50%">';
      const img = document.getElementById('profile-pic-img');
      const initials = document.getElementById('profile-pic-initials');
      if (img) { img.src = dataUrl; img.style.display = 'block'; }
      if (initials) initials.style.display = 'none';
      showToast('Profile picture updated!', 'success');
    } else {
      const data = await res.json().catch(() => ({}));
      showToast(data.error || 'Failed to upload picture');
    }
  } catch(err) {
    console.error('Profile pic upload error:', err);
    showToast('Upload failed. Please try again.');
  }
}

function compressImage(file, maxSize, quality) {
  return new Promise((resolve, reject) => {
    const img = new Image();
    img.onload = () => {
      const canvas = document.createElement('canvas');
      let w = img.width, h = img.height;
      if (w > maxSize || h > maxSize) {
        if (w > h) { h = Math.round(h * maxSize / w); w = maxSize; }
        else { w = Math.round(w * maxSize / h); h = maxSize; }
      }
      canvas.width = w;
      canvas.height = h;
      const ctx = canvas.getContext('2d');
      ctx.drawImage(img, 0, 0, w, h);
      resolve(canvas.toDataURL('image/jpeg', quality));
    };
    img.onerror = reject;
    img.src = URL.createObjectURL(file);
  });
}

function applyAirtimeGeoGate() {
  const country = getUserCountry();
  const airtimeBtn = document.getElementById('airtime-quick-btn');
  const billsBtn = document.getElementById('bills-quick-btn');
  const isAfrican = ['NG','GH','KE','UG','ZA','TZ','CM','SN','ET'].includes(country);
  const owner = isOwner();
  if (airtimeBtn) {
    airtimeBtn.style.display = (owner || (isAfrican && !NON_AIRTIME_COUNTRIES.includes(country))) ? '' : 'none';
  }
  if (billsBtn) {
    billsBtn.style.display = (owner || isAfrican) ? '' : 'none';
  }
}

async function validateToken() {
  if (!authToken) return false;
  // Client-side expiry check — avoids 401 server hit entirely
  if (isTokenExpired(authToken)) {
    localStorage.removeItem('promptpay_token');
    authToken = null;
    return false;
  }
  // Load cached user immediately (profile pic, name, etc.)
  try {
    const cached = localStorage.getItem('promptpay_user');
    if (cached) currentUser = JSON.parse(cached);
  } catch(e) {}
  try {
    const res = await authFetch(API_BASE + '/api/auth/me');
    if (res.ok) {
      const data = await res.json();
      currentUser = data.user || data;
      // Cache user data in localStorage for instant load next time
      try { localStorage.setItem('promptpay_user', JSON.stringify(currentUser)); } catch(e) {}
      return true;
    }
    // Token invalid on server
    localStorage.removeItem('promptpay_token');
    localStorage.removeItem('promptpay_user');
    authToken = null;
    return false;
  } catch (e) {
    // Server might be down; keep token and cached user
    return !!currentUser;
  }
}

// ── Settings Dropdown ──
function toggleSettingsDropdown(e) {
  e.stopPropagation();
  const dropdown = document.getElementById('settings-dropdown');
  dropdown.classList.toggle('open');
}

function closeSettingsDropdown() {
  document.getElementById('settings-dropdown').classList.remove('open');
}

// Close dropdown when clicking elsewhere
document.addEventListener('click', function(e) {
  const wrap = document.getElementById('settings-dropdown-wrap');
  if (wrap && !wrap.contains(e.target)) {
    closeSettingsDropdown();
  }
});

// ── Navigation Drawer ──
function openNavDrawer() {
  // Update drawer user info
  if (currentUser) {
    const nameEl = document.getElementById('drawer-user-name');
    const emailEl = document.getElementById('drawer-user-email');
    if (nameEl) nameEl.textContent = currentUser.displayName || 'PromptPay';
    if (emailEl) emailEl.textContent = currentUser.email || '';
  }
  // Highlight current page
  document.querySelectorAll('.nav-drawer-item[data-drawer]').forEach(item => {
    item.classList.toggle('active', item.dataset.drawer === currentPage);
  });
  document.getElementById('nav-drawer-overlay').classList.add('open');
}

function closeNavDrawer() {
  document.getElementById('nav-drawer-overlay').classList.remove('open');
}

function drawerNav(page) {
  closeNavDrawer();
  navigateTo(page);
}

// ── Settings Page Logic ──
function toggleChannel(el) {
  el.classList.toggle('active');
  const toggle = el.querySelector('.toggle-switch');
  toggle.classList.toggle('on');
}

async function savePreferences() {
  const language = document.getElementById('settings-language').value;
  const timezone = document.getElementById('settings-timezone').value;
  const pushEnabled = document.querySelector('[data-channel="push"]')?.classList.contains('active');
  const emailEnabled = document.querySelector('[data-channel="email"]')?.classList.contains('active');

  try {
    const res = await authFetch(API_BASE + '/api/user/settings', {
      method: 'PUT',
      body: JSON.stringify({ preferredChannels: [pushEnabled && 'push', emailEnabled && 'email'].filter(Boolean), language, timezone })
    });
    if (res.ok) {
      showToast('Preferences saved successfully');
    } else {
      showToast('Saved locally. Will sync when online.');
    }
  } catch (e) {
    showToast('Saved locally. Will sync when online.');
  }
  localStorage.setItem('promptpay_settings', JSON.stringify({ language, timezone }));
}

async function loadSettings() {
  try {
    const res = await authFetch(API_BASE + '/api/user/settings');
    if (res.ok) {
      const data = await res.json();
      applySettings(data);
      return;
    }
  } catch (e) {}
  const local = localStorage.getItem('promptpay_settings');
  if (local) {
    try { applySettings(JSON.parse(local)); } catch(e) {}
  }
}

function applySettings(settings) {
  if (!settings) return;
  if (settings.language) document.getElementById('settings-language').value = settings.language;
  if (settings.timezone) document.getElementById('settings-timezone').value = settings.timezone;
}

// ── PWA Install ──
let deferredInstallPrompt = null;
let userWantsInstall = false;
const isStandalone = window.matchMedia('(display-mode: standalone)').matches || window.navigator.standalone;
const isMobile = /Mobi|Android|iPhone|iPad|iPod/i.test(navigator.userAgent);
const isIOS = /iPad|iPhone|iPod/.test(navigator.userAgent) && !window.MSStream;

// Capture the native install prompt
window.addEventListener('beforeinstallprompt', (e) => {
  e.preventDefault();
  deferredInstallPrompt = e;
  // Only show install prompts on mobile devices, not desktop
  if (!isMobile) return;
  // Show install buttons
  const lpBtn = document.getElementById('lp-install-btn');
  if (lpBtn) lpBtn.style.display = 'flex';
  const btn = document.getElementById('install-app-btn');
  if (btn) btn.textContent = 'Install PromptPay';
  // If user already tapped install and is waiting, trigger immediately
  if (userWantsInstall) {
    triggerNativeInstall();
  }
  // Show banner on mobile only
  showInstallBannerIfAllowed();
});

function showInstallBannerIfAllowed() {
  if (isStandalone || !isMobile) return;
  const dismissed = localStorage.getItem('pwa_banner_dismissed');
  const dismissedAt = dismissed ? parseInt(dismissed) : 0;
  const hoursSinceDismiss = (Date.now() - dismissedAt) / (1000 * 60 * 60);
  if (!dismissed || hoursSinceDismiss > 24) {
    showInstallBanner();
  }
}

function showInstallBanner() {
  if (isStandalone || !isMobile) return;
  const banner = document.getElementById('pwa-install-banner');
  if (banner) banner.classList.add('show');
}

function dismissInstallBanner(permanent) {
  const banner = document.getElementById('pwa-install-banner');
  if (banner) banner.classList.remove('show');
  if (permanent) {
    localStorage.setItem('pwa_banner_dismissed', (Date.now() + 6 * 24 * 60 * 60 * 1000).toString());
  } else {
    localStorage.setItem('pwa_banner_dismissed', Date.now().toString());
  }
}

function triggerNativeInstall() {
  if (!deferredInstallPrompt) return;
  // Remove waiting overlay if shown
  const overlay = document.getElementById('pwa-install-waiting');
  if (overlay) overlay.remove();
  deferredInstallPrompt.prompt();
  deferredInstallPrompt.userChoice.then((result) => {
    if (result.outcome === 'accepted') {
      showToast('App installed! Find it on your home screen.');
      dismissInstallBanner(true);
      const lpBtn = document.getElementById('lp-install-btn');
      if (lpBtn) lpBtn.style.display = 'none';
    }
    deferredInstallPrompt = null;
    userWantsInstall = false;
  });
}

function installApp() {
  if (isStandalone) {
    showToast('App is already installed!');
    return;
  }
  // If native prompt is ready, trigger it immediately
  if (deferredInstallPrompt) {
    triggerNativeInstall();
    return;
  }
  // On iOS, show instructions (no native install API)
  if (isIOS) {
    showInstallGuide();
    return;
  }
  // On Android/desktop — show "Preparing..." and wait for beforeinstallprompt
  userWantsInstall = true;
  showInstallWaiting();
}

function showInstallWaiting() {
  const old = document.getElementById('pwa-install-waiting');
  if (old) old.remove();

  const overlay = document.createElement('div');
  overlay.id = 'pwa-install-waiting';
  overlay.style.cssText = 'position:fixed;inset:0;z-index:99999;background:rgba(0,0,0,0.85);display:flex;align-items:center;justify-content:center;padding:20px;animation:pwa-slide-up 0.3s ease-out';
  overlay.innerHTML = `
    <div style="background:#12121e;border-radius:20px;padding:32px 24px;max-width:340px;width:100%;border:1px solid rgba(255,255,255,0.1);text-align:center">
      <img src="/icons/icon-192.png" style="width:64px;height:64px;border-radius:16px;margin-bottom:16px" onerror="this.style.display='none'">
      <div style="font-size:18px;font-weight:700;color:#fff;margin-bottom:8px">Installing PromptPay...</div>
      <div id="pwa-wait-status" style="font-size:14px;color:#8b92a5;margin-bottom:24px">Preparing download, please wait...</div>
      <div style="width:48px;height:48px;margin:0 auto 24px;border:3px solid rgba(124,58,237,0.2);border-top-color:#7c3aed;border-radius:50%;animation:pwa-spin 0.8s linear infinite"></div>
      <button onclick="cancelInstallWaiting()" style="padding:12px 24px;border:1px solid rgba(255,255,255,0.2);border-radius:10px;background:transparent;color:#8b92a5;font-size:13px;cursor:pointer">Cancel</button>
    </div>`;
  document.body.appendChild(overlay);

  // After 8 seconds, if prompt still hasn't fired, show the manual guide instead
  setTimeout(() => {
    if (userWantsInstall && !deferredInstallPrompt) {
      overlay.remove();
      userWantsInstall = false;
      showInstallGuide();
    }
  }, 8000);
}

function cancelInstallWaiting() {
  userWantsInstall = false;
  const overlay = document.getElementById('pwa-install-waiting');
  if (overlay) overlay.remove();
}

function showInstallGuide() {
  const old = document.getElementById('pwa-install-guide');
  if (old) old.remove();

  const isChrome = /Chrome/i.test(navigator.userAgent) && !/Edge|OPR/i.test(navigator.userAgent);
  const isSamsung = /SamsungBrowser/i.test(navigator.userAgent);
  const isFirefox = /Firefox/i.test(navigator.userAgent);

  const menuLabel = isIOS ? 'Share button (box with arrow) at the bottom' :
    'menu button \u22EE at the top-right';
  const installLabel = isIOS ? 'Add to Home Screen' :
    isChrome ? 'Install app' : isSamsung ? 'Add page to > Home screen' :
    isFirefox ? 'Install' : 'Add to Home screen';

  const guide = document.createElement('div');
  guide.id = 'pwa-install-guide';
  guide.style.cssText = 'position:fixed;inset:0;z-index:99999;background:rgba(0,0,0,0.85);display:flex;align-items:center;justify-content:center;padding:20px;animation:pwa-slide-up 0.3s ease-out';
  guide.innerHTML = `
    <div style="background:#12121e;border-radius:20px;padding:28px 24px;max-width:360px;width:100%;border:1px solid rgba(255,255,255,0.1)">
      <div style="display:flex;align-items:center;gap:12px;margin-bottom:20px">
        <img src="/icons/icon-192.png" style="width:48px;height:48px;border-radius:12px" onerror="this.style.display='none'">
        <div>
          <div style="font-size:18px;font-weight:700;color:#fff">Install PromptPay</div>
          <div style="font-size:13px;color:#8b92a5">Almost there! Just 2 quick steps:</div>
        </div>
      </div>
      <div style="display:flex;align-items:center;gap:12px;margin-bottom:16px">
        <div style="width:36px;height:36px;border-radius:50%;background:#7c3aed;display:flex;align-items:center;justify-content:center;font-size:16px;font-weight:700;color:#fff;flex-shrink:0">1</div>
        <div style="color:#e0e0e8;font-size:14px">Tap the <strong>${menuLabel}</strong></div>
      </div>
      <div style="display:flex;align-items:center;gap:12px;margin-bottom:20px">
        <div style="width:36px;height:36px;border-radius:50%;background:#7c3aed;display:flex;align-items:center;justify-content:center;font-size:16px;font-weight:700;color:#fff;flex-shrink:0">2</div>
        <div style="color:#e0e0e8;font-size:14px">Tap <strong>"${installLabel}"</strong></div>
      </div>
      <button onclick="document.getElementById('pwa-install-guide').remove()" style="width:100%;padding:14px;border:none;border-radius:12px;background:#7c3aed;color:#fff;font-size:15px;font-weight:600;cursor:pointer">Got it</button>
    </div>`;
  guide.addEventListener('click', (e) => { if (e.target === guide) guide.remove(); });
  document.body.appendChild(guide);
}

// Show banner + install button on mobile after 3 seconds
if (!isStandalone && isMobile) {
  setTimeout(() => {
    const lpBtn = document.getElementById('lp-install-btn');
    if (lpBtn) lpBtn.style.display = 'flex';
    if (!document.getElementById('pwa-install-banner')?.classList.contains('show')) {
      showInstallBannerIfAllowed();
    }
  }, 3000);
}

// Hide install section in settings if already installed
if (isStandalone) {
  const section = document.getElementById('install-app-section');
  if (section) {
    section.querySelector('.settings-section-title').insertAdjacentHTML('afterend',
      '<div style="padding:8px 0;color:var(--emerald);font-size:13px;font-weight:500">App is installed</div>');
    const btn = document.getElementById('install-app-btn');
    if (btn) btn.style.display = 'none';
  }
}

// Register service worker + force update on every page load
if ('serviceWorker' in navigator) {
  // Nuke old caches on every page load (ensures fresh content)
  if ('caches' in window) {
    caches.keys().then(keys => {
      keys.forEach(key => {
        if (!key.includes('v5.0')) caches.delete(key);
      });
    });
  }
  navigator.serviceWorker.register('/sw.js', { updateViaCache: 'none' }).then(async (registration) => {
    console.log('[PWA] Service worker registered, scope:', registration.scope);
    // Force check for new SW version
    registration.update();
    // If a new SW is waiting, activate it immediately
    if (registration.waiting) registration.waiting.postMessage({ type: 'SKIP_WAITING' });
    // When a new SW takes over, reload for fresh content
    let refreshing = false;
    navigator.serviceWorker.addEventListener('controllerchange', () => {
      if (!refreshing) { refreshing = true; window.location.reload(); }
    });
    // Also detect waiting state after update found
    registration.addEventListener('updatefound', () => {
      const newWorker = registration.installing;
      if (newWorker) {
        newWorker.addEventListener('statechange', () => {
          if (newWorker.state === 'installed' && navigator.serviceWorker.controller) {
            newWorker.postMessage({ type: 'SKIP_WAITING' });
          }
        });
      }
    });

    // Subscribe to push notifications if logged in
    const token = localStorage.getItem('promptpay_token') || localStorage.getItem('token');
    if (token && 'PushManager' in window) {
      try {
        const vapidRes = await fetch('/api/push/vapid-key');
        if (!vapidRes.ok) return;
        const { publicKey } = await vapidRes.json();
        if (!publicKey) return;

        let subscription = await registration.pushManager.getSubscription();
        if (!subscription) {
          const urlBase64ToUint8Array = (base64String) => {
            const padding = '='.repeat((4 - base64String.length % 4) % 4);
            const base64 = (base64String + padding).replace(/-/g, '+').replace(/_/g, '/');
            const rawData = atob(base64);
            return Uint8Array.from([...rawData].map(c => c.charCodeAt(0)));
          };
          subscription = await registration.pushManager.subscribe({
            userVisibleOnly: true,
            applicationServerKey: urlBase64ToUint8Array(publicKey),
          });
        }

        await fetch('/api/push/subscribe', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json', 'Authorization': 'Bearer ' + token },
          body: JSON.stringify({ subscription }),
        });
        console.log('Push subscription registered');
      } catch (err) {
        console.log('Push subscription skipped:', err.message || err);
      }
    }
  }).catch((err) => {
    console.log('SW registration failed:', err);
  });
}

// ── Pay by Phone (Payment Request API) ──
async function payByPhone(amount, label, merchantId) {
  if (!window.PaymentRequest) {
    showToast('Payment Request API not supported in this browser');
    return null;
  }

  const methods = [
    {
      supportedMethods: 'https://apple.com/apple-pay',
      data: {
        version: 3,
        merchantIdentifier: 'merchant.com.promptpay',
        merchantCapabilities: ['supports3DS'],
        supportedNetworks: ['visa', 'masterCard', 'amex'],
        countryCode: 'US',
      },
    },
    {
      supportedMethods: 'https://google.com/pay',
      data: {
        environment: 'PRODUCTION',
        apiVersion: 2,
        apiVersionMinor: 0,
        merchantInfo: { merchantId: merchantId || 'promptpay', merchantName: 'PromptPay' },
        allowedPaymentMethods: [{
          type: 'CARD',
          parameters: { allowedAuthMethods: ['PAN_ONLY', 'CRYPTOGRAM_3DS'], allowedCardNetworks: ['VISA', 'MASTERCARD', 'AMEX'] },
          tokenizationSpecification: { type: 'PAYMENT_GATEWAY', parameters: { gateway: 'stripe', 'stripe:version': '2024-12-18.acacia', 'stripe:publishableKey': 'pk_live_placeholder' } },
        }],
      },
    },
    { supportedMethods: 'basic-card', data: { supportedNetworks: ['visa', 'mastercard', 'amex'] } },
  ];

  const details = {
    total: { label: label || 'PromptPay Payment', amount: { currency: 'USD', value: String(amount) } },
    displayItems: [
      { label: label || 'Payment', amount: { currency: 'USD', value: String(amount) } },
    ],
  };

  try {
    const request = new PaymentRequest(methods, details);
    const canMake = await request.canMakePayment();
    if (!canMake) {
      showToast('No supported payment method found on this device');
      return null;
    }
    const response = await request.show();
    await response.complete('success');
    showToast('Payment successful!');
    return response;
  } catch (err) {
    if (err.name !== 'AbortError') {
      showToast('Payment failed: ' + err.message);
    }
    return null;
  }
}

function showToast(message, type) {
  const toast = document.getElementById('settings-toast');
  toast.textContent = message;
  toast.style.background = type === 'error' ? 'linear-gradient(135deg,#ef4444,#dc2626)' : type === 'success' ? 'linear-gradient(135deg,#10b981,#059669)' : '';
  toast.classList.add('show');
  setTimeout(() => { toast.classList.remove('show'); toast.style.background = ''; }, 3000);
}

// ── Time greeting ──
(function() {
  const h = new Date().getHours();
  const g = h < 12 ? 'morning' : h < 17 ? 'afternoon' : 'evening';
  document.getElementById('time-greeting').textContent = g;
})();

// ── Navigation ──
document.querySelectorAll('.nav-item').forEach(item => {
  item.addEventListener('click', () => {
    const page = item.dataset.page;
    if (page) navigateTo(page);
  });
});

function navigateTo(page) {
  currentPage = page;
  // Settings page has no bottom nav item, so deselect all if navigating there
  document.querySelectorAll('.nav-item').forEach(i => i.classList.toggle('active', i.dataset.page === page));
  document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
  const el = document.getElementById('page-' + page);
  if (el) {
    el.classList.add('active');
    el.scrollTop = 0;
  }
  if (page === 'ai') {
    setTimeout(() => document.getElementById('chat-input')?.focus(), 100);
  }
  if (page === 'pos') {
    loadPosData();
  }
  if (page === 'calls') {
    loadCallsPage();
  }
  if (page === 'developer') {
    loadDeveloperPortal();
  }
}

// ── Animated Balance Counter ──
function animateBalance(target) {
  const el = document.getElementById('balance-display');
  const start = animatedBalance;
  const duration = 1200;
  const startTime = performance.now();
  function tick(now) {
    const elapsed = now - startTime;
    const progress = Math.min(elapsed / duration, 1);
    const ease = 1 - Math.pow(1 - progress, 4);
    const current = start + (target - start) * ease;
    el.textContent = '$' + current.toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
    animatedBalance = current;
    if (progress < 1) requestAnimationFrame(tick);
  }
  requestAnimationFrame(tick);
}

// ── Load Dashboard Data ──
async function loadData() {
  try {
    const res = await authFetch(API_BASE + '/health');
    if (res.ok) {
      animateBalance(0);
    }
  } catch (e) {
    console.log('Server connecting...');
    animateBalance(0);
  }
  // Load KYC status + country config
  loadKycStatus();
  loadTransferHistory();
  loadBankAccounts();
  loadMobileWallets();
}

// ══════════════════════════════════════════════════════════
// KYC VERIFICATION SYSTEM
// ══════════════════════════════════════════════════════════

async function loadKycStatus() {
  try {
    const res = await authFetch(API_BASE + '/api/kyc/status');
    if (!res.ok) return;
    userKyc = await res.json();
    countryConfig = { currency: userKyc.currency, currencySymbol: userKyc.currencySymbol, limits: userKyc.limits, requirements: userKyc.requirements };
    updateKycBanner();
    updateBalanceCurrency();
    updateSendModal();
    // Auto-show KYC modal for new unverified users
    if (userKyc.tier === 0 && userKyc.country && ['NG','GH','KE','UG'].includes(userKyc.country)) {
      setTimeout(() => openKycModal(), 1500);
    }
  } catch (e) { console.log('KYC load skipped'); }
}

function updateKycBanner() {
  const banner = document.getElementById('kyc-banner');
  if (!banner || !userKyc) return;
  const tier = userKyc.tier || 0;
  const country = userKyc.country || '';
  if (!country) { banner.style.display = 'none'; return; }

  banner.style.display = 'block';
  const icon = document.getElementById('kyc-banner-icon');
  const title = document.getElementById('kyc-banner-title');
  const desc = document.getElementById('kyc-banner-desc');

  if (tier === 0) {
    banner.style.background = 'rgba(239,68,68,0.1)';
    icon.textContent = '!';
    icon.style.background = 'rgba(239,68,68,0.2)';
    icon.style.color = '#ef4444';
    title.textContent = 'Verification Required';
    title.style.color = '#ef4444';
    desc.textContent = 'Verify your identity to start sending money';
    desc.style.color = '#ef4444';
  } else if (tier === 1) {
    banner.style.background = 'rgba(251,191,36,0.08)';
    icon.textContent = '\u2713';
    icon.style.background = 'rgba(251,191,36,0.2)';
    icon.style.color = '#fbbf24';
    title.textContent = 'Basic Verified';
    title.style.color = '#fbbf24';
    const lim = userKyc.limits?.[1];
    desc.textContent = lim ? `Daily limit: ${userKyc.currencySymbol}${lim.dailySend.toLocaleString()} \u2022 Upgrade for more` : 'Tap to upgrade';
    desc.style.color = '#fbbf24';
  } else {
    banner.style.background = 'rgba(16,185,129,0.08)';
    icon.textContent = '\u2713';
    icon.style.background = 'rgba(16,185,129,0.2)';
    icon.style.color = '#10b981';
    title.textContent = `Tier ${tier} Verified`;
    title.style.color = '#10b981';
    const lim = userKyc.limits?.[tier];
    desc.textContent = lim ? `Daily limit: ${userKyc.currencySymbol}${lim.dailySend.toLocaleString()}` : 'Fully verified';
    desc.style.color = '#10b981';
  }
}

function updateBalanceCurrency() {
  if (!countryConfig || !countryConfig.currencySymbol) return;
  const sym = countryConfig.currencySymbol;
  const el = document.getElementById('balance-display');
  if (el && sym !== '$') el.textContent = sym + '0.00';
  const change = document.getElementById('balance-change');
  if (change) change.textContent = sym === '$' ? 'No activity yet' : `${sym}0.00 today`;
}

function openKycModal() {
  const country = userKyc?.country || currentUser?.country || getUserCountry();
  // Show correct country form
  document.querySelectorAll('.kyc-country-form').forEach(f => f.style.display = 'none');
  if (country === 'NG') document.getElementById('kyc-ng').style.display = 'block';
  else if (country === 'GH') document.getElementById('kyc-gh').style.display = 'block';
  else if (country === 'KE' || country === 'UG') document.getElementById('kyc-ke-ug').style.display = 'block';
  else if (country === 'US') document.getElementById('kyc-us').style.display = 'block';
  else if (country === 'ZA') { const el = document.getElementById('kyc-za'); if (el) el.style.display = 'block'; else document.getElementById('kyc-generic-africa')?.style.display !== undefined && (document.getElementById('kyc-generic-africa').style.display = 'block'); }
  else if (['TZ','CM','SN','ET'].includes(country)) { const el = document.getElementById('kyc-generic-africa'); if (el) el.style.display = 'block'; }

  // Set phone placeholder based on country
  const phonePh = { NG: '+234...', GH: '+233...', KE: '+254...', UG: '+256...', US: '+1...', ZA: '+27...', TZ: '+255...', CM: '+237...', SN: '+221...', ET: '+251...' };
  const phoneEl = document.getElementById('kyc-phone');
  if (phoneEl) phoneEl.placeholder = phonePh[country] || '+...';

  // Pre-fill name
  const nameEl = document.getElementById('kyc-fullname');
  if (nameEl && currentUser?.displayName) nameEl.value = currentUser.displayName;

  // Show limits preview
  const preview = document.getElementById('kyc-limits-preview');
  if (preview && userKyc?.limits) {
    const t1 = userKyc.limits[1];
    const sym = userKyc.currencySymbol || '$';
    if (t1) preview.innerHTML = `After verification: Send up to <b>${sym}${t1.dailySend.toLocaleString()}/day</b> \u2022 Hold up to <b>${sym}${t1.maxBalance.toLocaleString()}</b>`;
  }

  // Update tier badge
  const badge = document.getElementById('kyc-tier-badge');
  if (badge) {
    const tier = userKyc?.tier || 0;
    badge.textContent = tier === 0 ? 'Unverified' : `Tier ${tier} \u2022 ${userKyc.limits?.[tier]?.label || 'Verified'}`;
    badge.style.background = tier === 0 ? 'rgba(239,68,68,0.15)' : 'rgba(16,185,129,0.15)';
    badge.style.color = tier === 0 ? '#ef4444' : '#10b981';
  }

  document.getElementById('kyc-modal').classList.add('active');
}

async function submitKyc() {
  const country = userKyc?.country || currentUser?.country || getUserCountry();
  const btn = document.getElementById('kyc-submit-btn');
  const errEl = document.getElementById('kyc-error');
  errEl.textContent = '';
  btn.disabled = true;
  btn.textContent = 'Verifying...';

  const body = {
    country,
    full_name: document.getElementById('kyc-fullname')?.value?.trim() || null,
    phone_number: document.getElementById('kyc-phone')?.value?.trim() || null,
    bvn: document.getElementById('kyc-bvn')?.value?.trim() || null,
    nin: document.getElementById('kyc-nin')?.value?.trim() || null,
    ghana_card_number: document.getElementById('kyc-ghana-card')?.value?.trim() || null,
    national_id: document.getElementById('kyc-national-id')?.value?.trim() || null,
    date_of_birth: document.getElementById('kyc-dob')?.value || null,
  };

  // Validate minimum fields per country
  if (country === 'NG' && !body.bvn) { errEl.textContent = 'BVN is required for Nigerian accounts'; btn.disabled = false; btn.textContent = 'Verify & Continue'; return; }
  if (country === 'GH' && !body.ghana_card_number) { errEl.textContent = 'Ghana Card number is required'; btn.disabled = false; btn.textContent = 'Verify & Continue'; return; }
  if ((country === 'KE' || country === 'UG') && !body.national_id) { errEl.textContent = 'National ID is required'; btn.disabled = false; btn.textContent = 'Verify & Continue'; return; }
  if (!body.phone_number) { errEl.textContent = 'Phone number is required'; btn.disabled = false; btn.textContent = 'Verify & Continue'; return; }

  try {
    const res = await authFetch(API_BASE + '/api/kyc/submit', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify(body),
    });
    const data = await res.json();
    if (!res.ok) { errEl.textContent = data.error || 'Verification failed'; return; }

    // Update local state
    userKyc.tier = data.tier;
    userKyc.status = data.status;
    updateKycBanner();
    closeModals();

    // Show success toast
    const toast = document.getElementById('settings-toast');
    toast.textContent = `Verified! Tier ${data.tier} \u2022 ${data.limits?.label || 'Active'} — Check your phone/email for confirmation`;
    toast.classList.add('active');
    setTimeout(() => toast.classList.remove('active'), 3000);
  } catch (e) {
    errEl.textContent = 'Connection error. Try again.';
  } finally {
    btn.disabled = false;
    btn.textContent = 'Verify & Continue';
  }
}

// ══════════════════════════════════════════════════════════
// BANK ACCOUNT MANAGEMENT
// ══════════════════════════════════════════════════════════

async function loadBankAccounts() {
  try {
    const res = await authFetch(API_BASE + '/api/bank-accounts');
    if (!res.ok) return;
    const data = await res.json();
    userBankAccounts = data.accounts || [];
    renderBankAccounts();
  } catch (e) {}
}

function renderBankAccounts() {
  const list = document.getElementById('bank-accounts-list');
  const section = document.getElementById('bank-accounts-section');
  if (!list) return;
  // Hide section for countries without bank support
  const country = getUserCountry();
  if (['KE'].includes(country)) { if (section) section.style.display = 'none'; return; }
  if (section) section.style.display = 'block';

  if (userBankAccounts.length === 0) {
    list.innerHTML = '<div style="padding:16px;text-align:center;color:var(--text3);font-size:13px">No bank accounts linked</div>';
    return;
  }
  list.innerHTML = userBankAccounts.map(a => `
    <div style="display:flex;align-items:center;gap:12px;padding:14px 16px;background:var(--surface);border-radius:14px;margin-bottom:8px">
      <div style="width:40px;height:40px;border-radius:10px;background:rgba(79,172,254,0.12);display:flex;align-items:center;justify-content:center;font-size:18px">\ud83c\udfe6</div>
      <div style="flex:1;min-width:0">
        <div style="font-size:14px;font-weight:600;white-space:nowrap;overflow:hidden;text-overflow:ellipsis">${a.bank_name}</div>
        <div style="font-size:12px;color:var(--text3)">\u2022\u2022\u2022\u2022 ${a.account_number.slice(-4)} ${a.is_default ? '\u2022 Default' : ''}</div>
      </div>
      <button onclick="removeBankAccount('${a.id}')" style="background:none;border:none;color:var(--text3);cursor:pointer;padding:4px;font-size:18px">\u00d7</button>
    </div>
  `).join('');
}

async function openBankModal() {
  const country = getUserCountry();
  try {
    const res = await fetch(API_BASE + '/api/banks/' + country);
    const data = await res.json();
    const select = document.getElementById('bank-select');
    select.innerHTML = '<option value="">Select your bank</option>' + (data.banks || []).map(b => `<option value="${b.code}" data-name="${b.name}">${b.name}</option>`).join('');
  } catch (e) {}
  document.getElementById('bank-modal').classList.add('active');
}

function onBankSelect() {
  // Could add account name lookup here in the future
}

async function submitBankAccount() {
  const country = getUserCountry();
  const select = document.getElementById('bank-select');
  const bankCode = select.value;
  const bankName = select.selectedOptions[0]?.dataset?.name || select.selectedOptions[0]?.textContent || '';
  const accountNumber = document.getElementById('bank-account-number').value.trim();
  const errEl = document.getElementById('bank-error');
  errEl.textContent = '';

  if (!bankCode) { errEl.textContent = 'Please select a bank'; return; }
  if (!accountNumber || accountNumber.length < 6) { errEl.textContent = 'Enter a valid account number'; return; }

  const currencies = { NG: 'NGN', GH: 'GHS', KE: 'KES', UG: 'UGX', US: 'USD' };
  try {
    const res = await authFetch(API_BASE + '/api/bank-accounts', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ country, bank_code: bankCode, bank_name: bankName, account_number: accountNumber, currency: currencies[country] || 'USD' }),
    });
    const data = await res.json();
    if (!res.ok) { errEl.textContent = data.error || 'Failed to link account'; return; }
    closeModals();
    loadBankAccounts();
    const toast = document.getElementById('settings-toast');
    toast.textContent = `${bankName} linked successfully`;
    toast.classList.add('active');
    setTimeout(() => toast.classList.remove('active'), 3000);
  } catch (e) { errEl.textContent = 'Connection error'; }
}

async function removeBankAccount(id) {
  if (!confirm('Remove this bank account?')) return;
  try {
    await authFetch(API_BASE + '/api/bank-accounts/' + id, { method: 'DELETE' });
    loadBankAccounts();
  } catch (e) {}
}

// ══════════════════════════════════════════════════════════
// MOBILE MONEY MANAGEMENT
// ══════════════════════════════════════════════════════════

async function loadMobileWallets() {
  try {
    const res = await authFetch(API_BASE + '/api/mobile-wallets');
    if (!res.ok) return;
    const data = await res.json();
    userMobileWallets = data.wallets || [];
    renderMobileWallets();
  } catch (e) {}
}

function renderMobileWallets() {
  const list = document.getElementById('momo-wallets-list');
  const section = document.getElementById('momo-section');
  if (!list) return;
  const country = getUserCountry();
  const momoCountries = ['GH', 'UG', 'KE', 'TZ', 'CM', 'SN', 'ET'];
  if (!isOwner() && !momoCountries.includes(country)) { if (section) section.style.display = 'none'; return; }
  if (section) section.style.display = 'block';

  if (userMobileWallets.length === 0) {
    list.innerHTML = '<div style="padding:16px;text-align:center;color:var(--text3);font-size:13px">No mobile wallets linked</div>';
    return;
  }
  const providerNames = { mtn: 'MTN MoMo', vodafone: 'Vodafone Cash', airteltigo: 'AirtelTigo', mpesa: 'M-Pesa', airtel: 'Airtel Money', orange: 'Orange Money', wave: 'Wave', telebirr: 'Telebirr', vodacom: 'Vodacom M-Pesa', tigo: 'Tigo Pesa' };
  list.innerHTML = userMobileWallets.map(w => `
    <div style="display:flex;align-items:center;gap:12px;padding:14px 16px;background:var(--surface);border-radius:14px;margin-bottom:8px">
      <div style="width:40px;height:40px;border-radius:10px;background:rgba(251,191,36,0.12);display:flex;align-items:center;justify-content:center;font-size:18px">\ud83d\udcf1</div>
      <div style="flex:1;min-width:0">
        <div style="font-size:14px;font-weight:600">${providerNames[w.provider] || w.provider}</div>
        <div style="font-size:12px;color:var(--text3)">${w.phone_number} ${w.is_default ? '\u2022 Default' : ''}</div>
      </div>
      <button onclick="removeMobileWallet('${w.id}')" style="background:none;border:none;color:var(--text3);cursor:pointer;padding:4px;font-size:18px">\u00d7</button>
    </div>
  `).join('');
}

function openMomoModal() {
  const country = getUserCountry();
  const providers = { GH: ['mtn','vodafone','airteltigo'], UG: ['mtn','airtel'], KE: ['mpesa'], TZ: ['mpesa','vodacom','tigo','airtel'], CM: ['mtn','orange'], SN: ['orange','wave'], ET: ['telebirr'] };
  const providerNames = { mtn: 'MTN MoMo', vodafone: 'Vodafone Cash', airteltigo: 'AirtelTigo', mpesa: 'M-Pesa', airtel: 'Airtel Money', vodacom: 'Vodacom M-Pesa', orange: 'Orange Money', wave: 'Wave', telebirr: 'Telebirr', tigo: 'Tigo Pesa' };
  const select = document.getElementById('momo-provider');
  // Owner sees all providers for testing
  const allProviders = ['mtn','vodafone','airteltigo','mpesa','airtel','vodacom','orange','wave','telebirr','tigo'];
  const opts = isOwner() ? allProviders : (providers[country] || []);
  select.innerHTML = '<option value="">Select provider</option>' + opts.map(p => `<option value="${p}">${providerNames[p] || p}</option>`).join('');
  const phonePh = { GH: '+233...', UG: '+256...', KE: '+254...', TZ: '+255...', CM: '+237...', SN: '+221...', ET: '+251...' };
  document.getElementById('momo-phone').placeholder = phonePh[country] || '+...';
  document.getElementById('momo-modal').classList.add('active');
}

async function submitMobileWallet() {
  const country = getUserCountry();
  const provider = document.getElementById('momo-provider').value;
  const phone = document.getElementById('momo-phone').value.trim();
  const errEl = document.getElementById('momo-error');
  errEl.textContent = '';
  if (!provider) { errEl.textContent = 'Select a provider'; return; }
  if (!phone || phone.length < 8) { errEl.textContent = 'Enter a valid phone number'; return; }

  const currencies = { GH: 'GHS', UG: 'UGX', KE: 'KES', TZ: 'TZS', CM: 'XAF', SN: 'XOF', ET: 'ETB', ZA: 'ZAR' };
  try {
    const res = await authFetch(API_BASE + '/api/mobile-wallets', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ country, provider, phone_number: phone, currency: currencies[country] || 'USD' }),
    });
    const data = await res.json();
    if (!res.ok) { errEl.textContent = data.error || 'Failed'; return; }
    closeModals();
    loadMobileWallets();
    const providerNames = { mtn: 'MTN MoMo', vodafone: 'Vodafone Cash', airteltigo: 'AirtelTigo', mpesa: 'M-Pesa', airtel: 'Airtel Money' };
    const toast = document.getElementById('settings-toast');
    toast.textContent = `${providerNames[provider] || provider} linked`;
    toast.classList.add('active');
    setTimeout(() => toast.classList.remove('active'), 3000);
  } catch (e) { errEl.textContent = 'Connection error'; }
}

async function removeMobileWallet(id) {
  if (!confirm('Remove this mobile wallet?')) return;
  try {
    await authFetch(API_BASE + '/api/mobile-wallets/' + id, { method: 'DELETE' });
    loadMobileWallets();
  } catch (e) {}
}

// ══════════════════════════════════════════════════════════
// COUNTRY-AWARE SEND MONEY FLOW
// ══════════════════════════════════════════════════════════

function updateSendModal() {
  const country = getUserCountry();
  const momoCountries = ['GH', 'UG', 'KE', 'TZ', 'CM', 'SN', 'ET'];
  const bankCountries = ['NG', 'GH', 'UG', 'US', 'ZA', 'TZ', 'CM', 'SN', 'ET'];
  const syms = { NG: '\u20a6', GH: 'GH\u20b5', KE: 'KSh', UG: 'USh', US: '$', ZA: 'R', TZ: 'TSh', CM: 'FCFA', SN: 'CFA', ET: 'Br' };
  const sym = countryConfig?.currencySymbol || syms[country] || '$';

  // Update currency label
  const label = document.getElementById('send-currency-label');
  if (label) label.textContent = `Send in ${countryConfig?.currency || 'USD'}`;

  // Show/hide tabs based on country
  const tabs = document.getElementById('send-type-tabs');
  if (tabs) {
    const bankTab = tabs.querySelector('[data-type="bank"]');
    const momoTab = tabs.querySelector('[data-type="mobile_money"]');
    const owner = isOwner();
    if (bankTab) bankTab.style.display = (owner || bankCountries.includes(country)) ? '' : 'none';
    if (momoTab) momoTab.style.display = (owner || momoCountries.includes(country)) ? '' : 'none';

    // Default to best tab for country
    if (country === 'KE') switchSendType('mobile_money');
    else if (bankCountries.includes(country)) switchSendType('bank');
    else switchSendType('wallet');
  }

  // Reset scope to domestic
  switchSendScope('domestic');

  // Update routing field for user's country
  updateRoutingField(country);

  // Populate bank list in send modal
  loadSendBanks(country);
  loadSendMomoProviders(country);
}

async function loadSendBanks(country) {
  try {
    const res = await fetch(API_BASE + '/api/banks/' + country);
    const data = await res.json();
    const select = document.getElementById('send-bank');
    if (select) select.innerHTML = '<option value="">Select bank</option>' + (data.banks || []).map(b => `<option value="${b.code}" data-name="${b.name}">${b.name}</option>`).join('');
  } catch (e) {}
}

function loadSendMomoProviders(country) {
  const providers = { GH: ['mtn','vodafone','airteltigo'], UG: ['mtn','airtel'], KE: ['mpesa'], TZ: ['mpesa'] };
  const providerNames = { mtn: 'MTN MoMo', vodafone: 'Vodafone Cash', airteltigo: 'AirtelTigo', mpesa: 'M-Pesa', airtel: 'Airtel Money' };
  const select = document.getElementById('send-momo-provider');
  const opts = providers[country] || [];
  if (select) select.innerHTML = '<option value="">Select provider</option>' + opts.map(p => `<option value="${p}">${providerNames[p] || p}</option>`).join('');
}

let currentSendScope = 'domestic';

function switchSendScope(scope) {
  currentSendScope = scope;
  // Update scope tab styles
  document.querySelectorAll('#send-scope-tabs .send-scope-tab').forEach(t => {
    if (t.dataset.scope === scope) {
      t.style.background = 'var(--gradient2)';
      t.style.color = 'white';
    } else {
      t.style.background = 'transparent';
      t.style.color = 'var(--text2)';
    }
  });

  const intlCountryWrap = document.getElementById('send-intl-country-wrap');
  const swiftWrap = document.getElementById('send-swift-wrap');
  const routingWrap = document.getElementById('send-routing-wrap');

  if (scope === 'international') {
    if (intlCountryWrap) intlCountryWrap.style.display = '';
    if (swiftWrap) swiftWrap.style.display = '';
    updateIntlFields();
  } else {
    if (intlCountryWrap) intlCountryWrap.style.display = 'none';
    if (swiftWrap) swiftWrap.style.display = 'none';
    // Show routing field based on user's own country
    updateRoutingField(getUserCountry());
  }
}

function updateIntlFields() {
  const destCountry = document.getElementById('send-intl-country')?.value || '';
  updateRoutingField(destCountry || getUserCountry());
}

function updateRoutingField(country) {
  const label = document.getElementById('send-routing-label');
  const input = document.getElementById('send-routing');
  const hint = document.getElementById('send-routing-hint');
  const wrap = document.getElementById('send-routing-wrap');

  const routingConfig = {
    US: { label: 'Routing Number', placeholder: '000000000', hint: '9-digit ABA routing number', maxlength: '9' },
    GB: { label: 'Sort Code', placeholder: '00-00-00', hint: '6-digit sort code', maxlength: '8' },
    AU: { label: 'BSB Number', placeholder: '000-000', hint: '6-digit BSB number', maxlength: '7' },
    IN: { label: 'IFSC Code', placeholder: 'SBIN0001234', hint: '11-character IFSC code', maxlength: '11' },
    CA: { label: 'Transit + Institution', placeholder: '00000-000', hint: '5-digit transit + 3-digit institution', maxlength: '9' },
    DE: { label: 'BLZ (Bankleitzahl)', placeholder: '00000000', hint: '8-digit bank code', maxlength: '8' },
    FR: { label: 'Code Banque', placeholder: '00000', hint: '5-digit bank code', maxlength: '5' },
  };

  const cfg = routingConfig[country];
  if (cfg && wrap) {
    wrap.style.display = '';
    if (label) label.textContent = cfg.label;
    if (input) { input.placeholder = cfg.placeholder; input.maxLength = parseInt(cfg.maxlength); }
    if (hint) hint.textContent = cfg.hint;
  } else if (wrap) {
    // Countries without routing numbers (NG, GH, KE, UG, etc.)
    wrap.style.display = 'none';
  }
}

function switchSendType(type) {
  currentSendType = type;
  document.getElementById('send-bank-fields').style.display = type === 'bank' ? '' : 'none';
  document.getElementById('send-momo-fields').style.display = type === 'mobile_money' ? '' : 'none';
  document.getElementById('send-wallet-fields').style.display = type === 'wallet' ? '' : 'none';

  // Update tab styles
  document.querySelectorAll('#send-type-tabs .send-tab').forEach(t => {
    if (t.dataset.type === type) {
      t.style.background = 'var(--gradient2)';
      t.style.color = 'white';
      t.style.borderColor = 'transparent';
    } else {
      t.style.background = 'transparent';
      t.style.color = 'var(--text2)';
      t.style.borderColor = 'var(--glass-border)';
    }
  });

  // Update fee display
  updateSendFee();
}

function updateSendFee() {
  const amount = parseFloat(document.getElementById('send-amount')?.value) || 0;
  const feeEl = document.getElementById('send-fee-display');
  if (!feeEl || !amount) { if (feeEl) feeEl.textContent = ''; return; }
  const sym = countryConfig?.currencySymbol || '$';
  let feeText = '';
  if (currentSendType === 'bank') feeText = `Fee: ${sym}${(amount * 0.01).toFixed(2)} (1%)`;
  else if (currentSendType === 'mobile_money') feeText = `Fee: ${sym}${(amount * 0.01).toFixed(2)} (1%)`;
  else feeText = amount <= 50 ? 'Free (under $50)' : `Fee: ${sym}${(amount * 0.01).toFixed(2)} (1%)`;
  feeEl.textContent = feeText;
}

// ── WebSocket Connection ──
function connectWebSocket() {
  try {
    const proto = location.protocol === 'https:' ? 'wss:' : 'ws:';
    ws = new WebSocket(`${proto}//${location.host}/ws`);
    ws.onopen = () => console.log('WS connected');
    ws.onmessage = (e) => {
      try {
        const msg = JSON.parse(e.data);
        if (msg.type === 'task:result') {
          handleTaskResult(msg);
        }
      } catch(err) {}
    };
    ws.onclose = () => setTimeout(connectWebSocket, 3000);
  } catch(e) {
    setTimeout(connectWebSocket, 5000);
  }
}

// ── AI Chat ──
function interceptAction(text) {
  const t = text.toLowerCase();
  if ((t.includes('link') || t.includes('add')) && (t.includes('card') || t.includes('payment method'))) {
    return { message: 'Opening the secure card form for you.', action: () => openAddCardModal() };
  }
  if (t === 'balance' || t === 'check my balance' || t === 'how much do i have' || t === 'my balance') {
    const bal = document.getElementById('balance-display')?.textContent || '$0.00';
    return { message: `Your current balance is **${bal}**. View details in your Wallet tab.`, action: null };
  }
  const sendMatch = t.match(/^send\s+\$?([\d.]+)\s+to\s+(.+)/i);
  if (sendMatch) {
    return { message: `Opening send form for $${sendMatch[1]} to ${sendMatch[2]}.`, action: () => {
      const amtEl = document.getElementById('send-amount'); const toEl = document.getElementById('send-to');
      if (amtEl) amtEl.value = sendMatch[1]; if (toEl) toEl.value = sendMatch[2];
      openSendModal();
    }};
  }
  return null;
}

async function sendMessage() {
  const input = document.getElementById('chat-input');
  const text = input.value.trim();
  if (!text) return;

  input.value = '';
  addChatMessage(text, 'user');

  // Intercept deterministic actions — no AI tokens needed
  const intercepted = interceptAction(text);
  if (intercepted) {
    await simulateDelay(400);
    addChatMessage(intercepted.message, 'ai');
    if (intercepted.action) intercepted.action();
    return;
  }

  // Hide suggestions after first message
  document.getElementById('chat-suggestions').style.display = 'none';

  // Show typing indicator
  const typing = addTypingIndicator();

  // Token tracking
  const inputTokens = Math.ceil(text.length / 4);
  tokenStats.used += inputTokens;

  try {
    // Check cache
    const cached = checkResponseCache(text);
    if (cached) {
      tokenStats.cached++;
      tokenStats.saved += 200;
      await simulateDelay(600);
      typing.remove();
      addChatMessage(cached, 'ai');
      updateTokenMatrix();
      return;
    }

    // Send to agentic chat endpoint (full AI with 9 agents + 93 tools)
    const res = await authFetch(API_BASE + '/api/chat', {
      method: 'POST',
      body: JSON.stringify({ message: text })
    });

    typing.remove();

    if (res.ok) {
      const data = await res.json();
      const output = data.reply || data.result?.output || 'How can I help you?';
      const responseTokens = Math.ceil(output.length / 4);
      tokenStats.used += responseTokens;
      addChatMessage(formatAIResponse(output), 'ai');
    } else if (res.status === 429) {
      addChatMessage('You have reached your daily message limit. Upgrade to Premium for unlimited access.', 'ai');
    } else {
      addChatMessage(getSmartFallback(text), 'ai');
    }
  } catch (e) {
    typing.remove();
    addChatMessage(getSmartFallback(text), 'ai');
  }

  updateTokenMatrix();
}

const PREMIUM_FEATURES = {
  'Create a shopping list': { icon: '\ud83d\uded2', name: 'AI Shopping (Aria)' },
  'Show market insights': { icon: '\ud83d\udcc8', name: 'Market Insights' },
  'Give me financial advice': { icon: '\ud83e\udde0', name: 'AI Advisor (Sage)' },
  'Show my subscriptions': { icon: '\ud83e\udd16', name: 'AI Assistant (Otto)' },
};

function showPremiumPopup(featureName) {
  const info = PREMIUM_FEATURES[featureName] || { icon: '\u2b50', name: 'Premium Feature' };
  document.getElementById('premium-popup-icon').textContent = info.icon;
  document.getElementById('premium-popup-title').textContent = `Unlock ${info.name}`;
  document.getElementById('premium-popup').classList.add('active');
}

function closePremiumPopup() {
  document.getElementById('premium-popup').classList.remove('active');
}

function subscribePremium() {
  closePremiumPopup();
  const toast = document.getElementById('settings-toast');
  toast.textContent = 'Premium subscriptions coming soon!';
  toast.classList.add('active');
  setTimeout(() => toast.classList.remove('active'), 3000);
}

function sendSuggestion(el) {
  const text = el.dataset?.text || el.textContent;
  // Gate premium features for free-tier users
  if (PREMIUM_FEATURES[text] && (!currentUser || !currentUser.subscriptionTier || currentUser.subscriptionTier === 'free') && currentUser?.role !== 'owner') {
    showPremiumPopup(text);
    return;
  }
  document.getElementById('chat-input').value = text;
  sendMessage();
}

function addChatMessage(text, sender) {
  const messages = document.getElementById('chat-messages');
  const div = document.createElement('div');
  div.className = `msg msg-${sender}`;
  div.textContent = text;
  messages.appendChild(div);
  messages.scrollTop = messages.scrollHeight;
  chatHistory.push({ role: sender, content: text });
  return div;
}

function addTypingIndicator() {
  const messages = document.getElementById('chat-messages');
  const div = document.createElement('div');
  div.className = 'msg-typing';
  div.innerHTML = '<div class="typing-dot"></div><div class="typing-dot"></div><div class="typing-dot"></div>';
  messages.appendChild(div);
  messages.scrollTop = messages.scrollHeight;
  return div;
}

function detectTaskType(text) {
  const t = text.toLowerCase();
  // Agentic agents checked FIRST
  // Shopping (Aria)
  if (t.includes('shop') || t.includes('grocery') || t.includes('shopping list') || t.includes('buy ') || t.includes('order') || t.includes('reorder') || t.includes('price compare')) return 'shopping_list_create';
  // Calls & SMS
  if (t.includes('call') || t.includes('dial') || t.includes('phone') || t.includes('sms') || t.includes('text') || t.includes('number') || t.includes('sim')) return 'calls_sms';
  // Assistant (Otto)
  if (t.includes('subscription') || t.includes('negotiate') || t.includes('appointment') || t.includes('document') || t.includes('price alert') || t.includes('return') || t.includes('deal') || t.includes('auto pay')) return 'assistant_subscriptions';
  // Payment infrastructure
  if (t.includes('send') || t.includes('transfer')) return 'wallet_transfer';
  if (t.includes('bill') || t.includes('electric') || t.includes('utility')) return 'bill_pay';
  if (t.includes('balance') || t.includes('how much') || t.includes('history')) return 'tx_history';
  if (t.includes('airtime') || t.includes('data') || t.includes('recharge')) return 'payment_initiate';
  if (t.includes('card') || t.includes('payment method')) return 'payment_method_manage';
  if (t.includes('pay ')) return 'payment_initiate';
  return 'custom';
}

function formatAIResponse(text) {
  return text.replace(/```[\s\S]*?```/g, '').replace(/\*\*/g, '').trim();
}

function getSmartFallback(text) {
  const type = detectTaskType(text);
  const responses = {
    // Agentic agents
    shopping_list_create: "I'll help with shopping. Want me to create a list, compare prices, or track an order?",
    calls_sms: "I can help with calls and messaging! Go to the Calls tab to dial international numbers, buy virtual numbers, send SMS, or chat with AI. What do you need?",
    assistant_subscriptions: "I'll manage that for you. I can list subscriptions, set alerts, or schedule appointments.",
    wallet_transfer: "Got it. Who are you sending to and how much?",
    bill_pay: "I'll handle that bill. What's the bill type and amount?",
    tx_history: `Your balance is ${document.getElementById('balance-display')?.textContent || '$0.00'}. Need transaction details?`,
    payment_initiate: "On it. What would you like to pay for?",
    payment_method_manage: "You can manage your cards in the Wallet tab. Need help with something specific?",
    custom: "I can help you shop, make calls, send SMS, manage subscriptions, send money, pay bills, and more. What do you need?"
  };
  return responses[type] || responses.custom;
}

// ── Token Matrix (TokenForge) ──
const responseCache = new Map();

function checkResponseCache(text) {
  const key = text.toLowerCase().trim();
  for (const [k, v] of responseCache) {
    if (key.includes(k) || k.includes(key)) return v;
  }
  return null;
}

function cacheResponse(text, response) {
  const key = text.toLowerCase().trim().slice(0, 50);
  responseCache.set(key, response);
  if (responseCache.size > 50) {
    const first = responseCache.keys().next().value;
    responseCache.delete(first);
  }
}

function updateTokenMatrix() {
  const used = tokenStats.used;
  const saved = tokenStats.saved;
  const cached = tokenStats.cached;
  const total = used + saved;
  const efficiency = total > 0 ? Math.round((saved / total) * 100) : 100;
  const cost = (saved * 0.000015).toFixed(4);

  document.getElementById('tm-used').textContent = used.toLocaleString();
  document.getElementById('tm-cached').textContent = cached.toLocaleString();
  document.getElementById('tm-saved').textContent = saved.toLocaleString();
  document.getElementById('tm-efficiency').textContent = efficiency + '%';
  document.getElementById('tm-cost').textContent = '$' + cost;
}

function simulateDelay(ms) {
  return new Promise(resolve => setTimeout(resolve, ms));
}

// ── Modals ──
function openSendModal() {
  updateSendModal();
  // Add fee listener
  const amtEl = document.getElementById('send-amount');
  if (amtEl) amtEl.oninput = updateSendFee;
  document.getElementById('send-error').textContent = '';
  document.getElementById('send-modal').classList.add('active');
}
function openRequestModal() {
  document.getElementById('request-modal').classList.add('active');
}
// ══════════════════════════════════════════════════════════
// QR CODE — Display + Camera Scanner
// ══════════════════════════════════════════════════════════

let qrScanStream = null;
let qrScanInterval = null;

function showQrModal() {
  document.getElementById('qr-modal').classList.add('active');
  switchQrTab('display');
}

function closeQrModal() {
  stopQrScanner();
  document.getElementById('qr-modal').classList.remove('active');
}

function switchQrTab(tab) {
  const displayBtn = document.getElementById('qr-tab-display');
  const scanBtn = document.getElementById('qr-tab-scan');
  const displayPanel = document.getElementById('qr-display-panel');
  const scanPanel = document.getElementById('qr-scan-panel');
  if (tab === 'display') {
    displayBtn.style.background = 'var(--gradient2)'; displayBtn.style.color = 'white';
    scanBtn.style.background = 'transparent'; scanBtn.style.color = 'var(--text2)';
    displayPanel.style.display = ''; scanPanel.style.display = 'none';
    stopQrScanner();
    generateUserQr();
  } else {
    scanBtn.style.background = 'var(--gradient2)'; scanBtn.style.color = 'white';
    displayBtn.style.background = 'transparent'; displayBtn.style.color = 'var(--text2)';
    displayPanel.style.display = 'none'; scanPanel.style.display = '';
    startQrScanner();
  }
}

function generateUserQr() {
  const canvas = document.getElementById('qr-canvas');
  if (!canvas || !currentUser) return;
  const payLink = window.location.origin + '/pay/' + (currentUser.payTag || currentUser.id);
  document.getElementById('qr-pay-link').textContent = payLink;
  // Generate QR code on canvas
  generateQrCode(canvas, payLink, 200);
}

function copyQrLink() {
  const link = document.getElementById('qr-pay-link').textContent;
  navigator.clipboard.writeText(link).then(() => {
    showToast('Pay link copied!');
  });
}

// Lightweight QR Code generator (numeric mode, ~L error correction)
function generateQrCode(canvas, text, size) {
  const ctx = canvas.getContext('2d');
  ctx.fillStyle = 'white';
  ctx.fillRect(0, 0, size, size);
  // Use the server-side QR SVG endpoint as image source
  const img = new Image();
  img.crossOrigin = 'anonymous';
  img.onload = function() {
    ctx.drawImage(img, 0, 0, size, size);
  };
  img.onerror = function() {
    // Fallback: draw text-based QR placeholder
    ctx.fillStyle = '#7c3aed';
    ctx.fillRect(10, 10, 50, 50); ctx.fillRect(size-60, 10, 50, 50); ctx.fillRect(10, size-60, 50, 50);
    ctx.fillStyle = 'white';
    ctx.fillRect(18, 18, 34, 34); ctx.fillRect(size-52, 18, 34, 34); ctx.fillRect(18, size-52, 34, 34);
    ctx.fillStyle = '#7c3aed';
    ctx.fillRect(26, 26, 18, 18); ctx.fillRect(size-44, 26, 18, 18); ctx.fillRect(26, size-44, 18, 18);
    ctx.font = '10px monospace'; ctx.textAlign = 'center';
    ctx.fillText('PromptPay', size/2, size/2);
    ctx.font = '8px monospace'; ctx.fillStyle = '#666';
    ctx.fillText(text.slice(0, 30), size/2, size/2 + 14);
  };
  img.src = '/qr/' + encodeURIComponent(text);
}

// Camera QR Scanner
async function startQrScanner() {
  const video = document.getElementById('qr-video');
  const errEl = document.getElementById('qr-scan-error');
  const resultEl = document.getElementById('qr-scan-result');
  errEl.style.display = 'none'; resultEl.style.display = 'none';
  try {
    qrScanStream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: 'environment' } });
    video.srcObject = qrScanStream;
    // Use BarcodeDetector API if available, else fallback
    if ('BarcodeDetector' in window) {
      const detector = new BarcodeDetector({ formats: ['qr_code'] });
      qrScanInterval = setInterval(async () => {
        try {
          const codes = await detector.detect(video);
          if (codes.length > 0) {
            handleQrResult(codes[0].rawValue);
          }
        } catch(e) {}
      }, 300);
    } else {
      errEl.textContent = 'QR scanning requires a modern browser (Chrome 83+, Edge 83+). You can also paste a pay link in the Send screen.';
      errEl.style.display = 'block';
    }
  } catch(e) {
    errEl.textContent = 'Camera access denied. Please allow camera permission to scan QR codes.';
    errEl.style.display = 'block';
  }
}

function stopQrScanner() {
  if (qrScanInterval) { clearInterval(qrScanInterval); qrScanInterval = null; }
  if (qrScanStream) { qrScanStream.getTracks().forEach(t => t.stop()); qrScanStream = null; }
}

function handleQrResult(data) {
  stopQrScanner();
  const resultEl = document.getElementById('qr-scan-result');
  resultEl.style.display = 'block';
  // Check if it's a PromptPay pay link
  if (data.includes('/pay/') || data.includes('upromptpay.com')) {
    resultEl.innerHTML = '<b>PromptPay link detected!</b><br>' + data;
    setTimeout(() => {
      closeQrModal();
      // Extract pay tag/id and open send modal
      const parts = data.split('/pay/');
      if (parts[1]) {
        openSendModal();
        const recipEl = document.getElementById('send-recipient');
        if (recipEl) recipEl.value = parts[1];
      } else {
        window.open(data, '_self');
      }
    }, 1000);
  } else {
    resultEl.innerHTML = '<b>QR Scanned:</b><br>' + data;
  }
}
function showNotifications() {
  navigateTo('activity');
}
function closeModals() {
  document.querySelectorAll('.modal-overlay').forEach(m => m.classList.remove('active'));
}

// Close modal on overlay click
document.querySelectorAll('.modal-overlay').forEach(m => {
  m.addEventListener('click', (e) => {
    if (e.target === m) closeModals();
  });
});

function openPayByPhone() {
  document.getElementById('pay-modal').classList.add('active');
}

// ══════════════════════════════════════════════════════════
// STRIPE ELEMENTS (Card Linking)
// ══════════════════════════════════════════════════════════

let stripeInstance = null;
let cardElement = null;
let stripePublishableKey = null;

async function initStripeElements() {
  if (stripeInstance) return;
  try {
    const res = await authFetch(API_BASE + '/api/config/stripe-key');
    if (!res.ok) return;
    const { publishableKey } = await res.json();
    if (!publishableKey) return;
    stripePublishableKey = publishableKey;
    stripeInstance = Stripe(publishableKey);
    const elements = stripeInstance.elements({
      appearance: {
        theme: 'night',
        variables: {
          colorPrimary: '#7c3aed',
          colorBackground: '#0c0c14',
          colorText: '#f0f2f5',
          colorTextSecondary: '#8b92a5',
          borderRadius: '12px',
          fontFamily: 'Inter, sans-serif',
        },
      },
    });
    cardElement = elements.create('card', {
      style: { base: { fontSize: '16px', color: '#f0f2f5', '::placeholder': { color: '#4a5068' } } },
    });
  } catch (err) {
    console.error('Stripe init failed:', err);
  }
}

function openAddCardModal() {
  document.getElementById('add-card-modal').classList.add('active');
  initStripeElements().then(() => {
    if (cardElement) {
      cardElement.mount('#stripe-card-element');
      cardElement.on('change', (event) => {
        const errDiv = document.getElementById('card-errors');
        if (event.error) { errDiv.textContent = event.error.message; errDiv.style.display = 'block'; }
        else { errDiv.style.display = 'none'; }
      });
    }
  });
}

async function submitCardForm() {
  if (!stripeInstance || !cardElement) { showToast('Card form not ready. Please try again.'); return; }
  const btn = document.getElementById('add-card-submit');
  const errDiv = document.getElementById('card-errors');
  btn.disabled = true; btn.textContent = 'Adding...';
  console.log('[CARD-ADD] Starting card submission...');
  try {
    const { paymentMethod, error } = await stripeInstance.createPaymentMethod({ type: 'card', card: cardElement });
    if (error) {
      console.error('[CARD-ADD] Stripe createPaymentMethod error:', error.message);
      errDiv.textContent = error.message;
      errDiv.style.display = 'block';
      btn.disabled = false; btn.textContent = 'Add Card';
      return;
    }
    console.log('[CARD-ADD] PaymentMethod created:', paymentMethod.id);
    const res = await authFetch(API_BASE + '/api/user/payment-methods', {
      method: 'POST', body: JSON.stringify({ paymentMethodId: paymentMethod.id }),
    });
    console.log('[CARD-ADD] Server response status:', res.status);
    if (res.ok) {
      const data = await res.json();
      console.log('[CARD-ADD] SUCCESS:', data.paymentMethod.brand, '...', data.paymentMethod.last4);
      showToast(`${data.paymentMethod.brand} ...${data.paymentMethod.last4} added!`);
      closeModals(); cardElement.clear(); loadPaymentMethods();
    } else {
      const errData = await res.json();
      console.error('[CARD-ADD] Server error:', errData);
      errDiv.textContent = errData.error || 'Failed to add card';
      errDiv.style.display = 'block';
    }
  } catch (err) {
    console.error('[CARD-ADD] Exception:', err);
    errDiv.textContent = 'Failed to add card: ' + (err.message || 'Unknown error');
    errDiv.style.display = 'block';
  }
  btn.disabled = false; btn.textContent = 'Add Card';
}

async function renderRewardCard(container) {
  try {
    const res = await authFetch(API_BASE + '/api/rewards/balance');
    if (!res.ok) return;
    const data = await res.json();
    const card = document.createElement('div');
    card.className = 'wallet-reward-card';
    const statusText = data.balance > 0 ? 'Active' : 'No rewards yet';
    card.innerHTML = `
      <div class="reward-glint"></div>
      <div class="reward-star">&#9733;</div>
      <div class="reward-type">Referral Rewards</div>
      <div class="reward-title">Reward Card</div>
      <div class="reward-balance-label">Available Balance</div>
      <div class="reward-balance-value">$${Number(data.balance || 0).toFixed(2)}</div>
      <div class="reward-footer">
        <div>
          <div class="reward-stat-label">Lifetime Earned</div>
          <div class="reward-stat-value">$${Number(data.lifetimeEarned || 0).toFixed(2)}</div>
        </div>
        <div style="text-align:right">
          <div class="reward-stat-label">Status</div>
          <div class="reward-stat-value">${statusText}</div>
        </div>
      </div>`;
    container.appendChild(card);
  } catch (err) { console.error('Failed to load reward card:', err); }
}

async function loadPaymentMethods() {
  try {
    const container = document.getElementById('payment-cards');
    container.innerHTML = '';

    // Reward card always first
    await renderRewardCard(container);

    // Fetch Stripe payment methods
    const res = await authFetch(API_BASE + '/api/user/payment-methods');
    if (!res.ok) return;
    const { methods } = await res.json();

    const brandClassMap = { visa: 'brand-visa', mastercard: 'brand-mastercard', amex: 'brand-amex', discover: 'brand-discover' };
    const holderName = (currentUser && currentUser.displayName) ? currentUser.displayName.toUpperCase() : 'CARD HOLDER';

    methods.forEach(pm => {
      const brandClass = brandClassMap[pm.brand] || 'brand-default';
      const brandLabel = (pm.brand || 'card').toUpperCase();
      const card = document.createElement('div');
      card.className = 'wallet-holo-card ' + brandClass;
      card.innerHTML = `
        <div class="holo-glint"></div>
        <div class="holo-chip"></div>
        <div class="holo-brand">${brandLabel}</div>
        <button class="holo-remove" onclick="removePaymentMethod('${pm.id}')" title="Remove">&#10005;</button>
        <div class="holo-number">&#8226;&#8226;&#8226;&#8226; &#8226;&#8226;&#8226;&#8226; &#8226;&#8226;&#8226;&#8226; ${pm.last4}</div>
        <div class="holo-footer">
          <div>
            <div class="holo-label">Card Holder</div>
            <div class="holo-value">${holderName}</div>
          </div>
          <div style="text-align:center">
            <div class="holo-label">Expires</div>
            <div class="holo-value">${String(pm.expMonth).padStart(2,'0')}/${String(pm.expYear).slice(-2)}</div>
          </div>
          <div style="text-align:right">
            <div class="holo-branding">PromptPay</div>
          </div>
        </div>`;
      container.appendChild(card);
    });

    // Add Payment Method button
    const addBtn = document.createElement('div');
    addBtn.style.cssText = 'min-width:300px;aspect-ratio:1.586;border-radius:20px;border:1px dashed rgba(255,255,255,0.1);display:flex;align-items:center;justify-content:center;flex-direction:column;gap:8px;cursor:pointer;color:var(--text3);flex-shrink:0;transition:border-color 0.2s;';
    addBtn.onmouseenter = function() { this.style.borderColor = 'rgba(124,58,237,0.3)'; };
    addBtn.onmouseleave = function() { this.style.borderColor = 'rgba(255,255,255,0.1)'; };
    addBtn.onclick = openAddCardModal;
    addBtn.innerHTML = '<svg width="28" height="28" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5"><line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/></svg><span style="font-size:13px">Add Payment Method</span>';
    container.appendChild(addBtn);
  } catch (err) { console.error('Failed to load payment methods:', err); }
}

async function removePaymentMethod(pmId) {
  if (!confirm('Remove this card?')) return;
  try {
    const res = await authFetch(API_BASE + '/api/user/payment-methods/' + pmId, { method: 'DELETE' });
    if (res.ok) { showToast('Card removed'); loadPaymentMethods(); }
    else { showToast('Failed to remove card'); }
  } catch (err) { showToast('Failed to remove card'); }
}

// ══════════════════════════════════════════════════════════
// POS MODE — Airtime Reseller System
// ══════════════════════════════════════════════════════════

let posCarrier = null;
let posDetectTimer = null;
let lastReceipt = null;
let posLinkedCards = [];

function formatNaira(n) {
  return '\u20A6' + Number(n||0).toLocaleString('en-NG', { minimumFractionDigits: 0, maximumFractionDigits: 0 });
}

async function loadPosData() {
  try {
    const res = await authFetch(API_BASE + '/api/pos/dashboard');
    if (!res.ok) return;
    const data = await res.json();

    // Balance
    document.getElementById('pos-balance').textContent = formatNaira(data.wallet?.balance || 0);

    // Today stats
    document.getElementById('pos-today-sales').textContent = data.today?.count || 0;
    document.getElementById('pos-today-revenue').textContent = formatNaira(data.today?.totalSales || 0);
    document.getElementById('pos-today-profit').textContent = formatNaira(data.today?.totalProfit || 0);

    // Recent sales
    renderPosSales(data.recentSales || []);
  } catch (e) { console.error('POS load error:', e); }

  // Load POS agent profile
  loadPosAgentCard();
}

// ═══════════════════════════════════════════
// POS Agent System ("PromptPay Points")
// ═══════════════════════════════════════════
let posAgentData = null;

async function loadPosAgentCard() {
  const card = document.getElementById('pos-agent-card');
  card.style.display = 'block';

  try {
    const res = await authFetch(API_BASE + '/api/pos/me');
    const data = await res.json();

    if (!data.registered) {
      // Not registered — show signup prompt
      card.className = 'pos-agent-card not-registered';
      card.innerHTML = `
        <div class="pos-agent-header">
          <svg width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="#a855f7" stroke-width="2"><path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"/><circle cx="9" cy="7" r="4"/><path d="M23 21v-2a4 4 0 0 0-3-3.87"/><path d="M16 3.13a4 4 0 0 1 0 7.75"/></svg>
          <div style="flex:1">
            <div style="font-size:15px;font-weight:700">Become a PromptPay Point</div>
            <div style="font-size:12px;color:var(--text2)">Earn commissions selling airtime &amp; data</div>
          </div>
        </div>
        <div id="pos-register-section">
          <button class="pos-agent-actions" style="display:inline-block" onclick="showPosRegisterForm()">
            <button class="primary-action" style="padding:10px 20px;border-radius:12px;border:none;background:var(--gradient2);color:#fff;font-size:13px;font-weight:600;cursor:pointer;font-family:inherit;box-shadow:0 2px 10px rgba(124,58,237,0.2)">Register as Agent</button>
          </button>
        </div>
        <div id="pos-register-form" class="pos-register-form" style="display:none">
          <div class="pos-input-group">
            <label>Display Name / Business Name</label>
            <input id="pos-reg-name" placeholder="e.g. Chioma Mobile Hub">
          </div>
          <div class="pos-input-group">
            <label>Phone Number</label>
            <input id="pos-reg-phone" type="tel" placeholder="08012345678">
          </div>
          <div class="pos-input-group">
            <label>Business Address (optional)</label>
            <input id="pos-reg-address" placeholder="Shop 5, Alaba Market, Lagos">
          </div>
          <div class="pos-input-group">
            <label>BVN (optional — unlocks higher limits)</label>
            <input id="pos-reg-bvn" placeholder="Bank Verification Number" maxlength="11">
          </div>
          <div class="pos-input-group">
            <label>NIN (optional — unlocks higher limits)</label>
            <input id="pos-reg-nin" placeholder="National ID Number" maxlength="11">
          </div>
          <div class="pos-input-group">
            <label>Guarantor Name (optional)</label>
            <input id="pos-reg-guarantor" placeholder="Full name of guarantor">
          </div>
          <div class="pos-input-group">
            <label>Guarantor Phone (optional)</label>
            <input id="pos-reg-guarantor-phone" type="tel" placeholder="Guarantor phone number">
          </div>
          <div class="pos-input-group" style="border-top:1px solid var(--glass-border);padding-top:12px;margin-top:4px">
            <label>Referral Code (optional)</label>
            <input id="pos-reg-referral" placeholder="Agent code of who referred you, e.g. PP4K8NM2" maxlength="8" style="text-transform:uppercase">
            <div style="font-size:10px;color:var(--text3);margin-top:4px">Both you and your referrer earn bonuses!</div>
          </div>
          <div id="pos-reg-error" style="color:var(--red);font-size:12px;margin-bottom:8px"></div>
          <button id="pos-reg-submit" onclick="submitPosRegistration()" style="width:100%;padding:14px;border-radius:12px;border:none;background:var(--gradient2);color:#fff;font-size:15px;font-weight:700;cursor:pointer;font-family:inherit;box-shadow:0 4px 16px rgba(124,58,237,0.25)">
            Register &amp; Start Earning
          </button>
        </div>`;
      return;
    }

    // Registered agent — show profile card
    posAgentData = data;
    card.className = 'pos-agent-card';
    const pct = data.dailyLimit > 0 ? Math.min(100, (data.dailyUsed / data.dailyLimit) * 100) : 0;
    const isHigh = pct > 80;

    card.innerHTML = `
      <div class="pos-agent-header">
        <span class="pos-agent-badge" style="background:${data.tierColor}22;color:${data.tierColor}">${data.tierLabel}</span>
        <span class="pos-agent-code">${data.agentCode}</span>
        <div style="margin-left:auto;font-size:11px;color:var(--text2)">
          ${data.rating ? '\u2B50 ' + data.rating.toFixed(1) : ''} ${data.totalTransactions ? '\xB7 ' + data.totalTransactions + ' txns' : ''}
        </div>
      </div>
      <div class="pos-agent-limit-bar">
        <div class="pos-limit-labels">
          <span>Daily Used: ${formatNaira(data.dailyUsed)}</span>
          <span>Limit: ${formatNaira(data.dailyLimit)}</span>
        </div>
        <div class="pos-limit-track">
          <div class="pos-limit-fill ${isHigh ? 'high' : ''}" style="width:${pct}%"></div>
        </div>
        <div style="font-size:11px;color:var(--text2);margin-top:4px">Remaining: ${formatNaira(data.dailyRemaining)}</div>
      </div>
      <div class="pos-agent-actions">
        ${data.pendingLimitRequest
          ? '<button disabled style="opacity:0.5;cursor:not-allowed">Limit Increase Pending...</button>'
          : '<button class="primary-action" onclick="showLimitRequestModal()">Request Higher Limit</button>'}
        <button onclick="showReferralModal()">Share &amp; Earn</button>
        ${data.hasBvn ? '' : '<button onclick="showPosVerifyModal()">Add BVN/NIN</button>'}
      </div>`;
  } catch (e) {
    console.error('POS agent load error:', e);
    card.style.display = 'none';
  }
}

function showPosRegisterForm() {
  document.getElementById('pos-register-section').style.display = 'none';
  document.getElementById('pos-register-form').style.display = 'block';
}

async function submitPosRegistration() {
  const name = document.getElementById('pos-reg-name').value.trim();
  const phone = document.getElementById('pos-reg-phone').value.trim();
  const errEl = document.getElementById('pos-reg-error');
  errEl.textContent = '';

  if (!name || !phone) { errEl.textContent = 'Name and phone are required'; return; }

  const btn = document.getElementById('pos-reg-submit');
  btn.disabled = true; btn.textContent = 'Registering...';

  try {
    const res = await authFetch(API_BASE + '/api/pos/register', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({
        displayName: name,
        phone,
        address: document.getElementById('pos-reg-address').value.trim(),
        bvn: document.getElementById('pos-reg-bvn').value.trim(),
        nin: document.getElementById('pos-reg-nin').value.trim(),
        guarantorName: document.getElementById('pos-reg-guarantor').value.trim(),
        guarantorPhone: document.getElementById('pos-reg-guarantor-phone').value.trim(),
        referralCode: document.getElementById('pos-reg-referral').value.trim(),
      }),
    });
    const data = await res.json();
    if (!res.ok) { errEl.textContent = data.error || 'Registration failed'; return; }

    // Show success & reload card
    showToast(data.message || 'Registered as POS agent!', 'success');
    loadPosAgentCard();
  } catch (e) {
    errEl.textContent = 'Network error';
  } finally {
    btn.disabled = false; btn.textContent = 'Register & Start Earning';
  }
}

function showLimitRequestModal() {
  if (!posAgentData) return;
  const current = posAgentData.dailyLimit;
  const isFirst = posAgentData.limitIncreases === 0;

  // Suggest next tier amounts
  const suggestions = [200000, 500000, 1000000].filter(a => a > current);
  const suggestHtml = suggestions.map(a =>
    `<button onclick="document.getElementById('limit-req-amount').value=${a}" style="padding:8px 14px;border-radius:8px;border:1px solid var(--glass-border);background:rgba(255,255,255,0.04);color:var(--text);font-size:13px;font-weight:600;cursor:pointer;font-family:inherit">${formatNaira(a)}</button>`
  ).join('');

  showDynamicModal('Request Limit Increase', `
    <div style="margin-bottom:16px">
      <div style="font-size:13px;color:var(--text2);margin-bottom:4px">Current Daily Limit</div>
      <div style="font-size:22px;font-weight:800;font-family:'JetBrains Mono',monospace">${formatNaira(current)}</div>
    </div>
    ${isFirst ? '<div style="padding:10px 14px;border-radius:10px;background:rgba(34,197,94,0.1);border:1px solid rgba(34,197,94,0.2);font-size:12px;color:#22c55e;margin-bottom:14px;font-weight:600">Your first limit increase will be approved instantly!</div>' : ''}
    <div style="margin-bottom:12px">
      <label style="display:block;font-size:11px;color:var(--text2);margin-bottom:6px;text-transform:uppercase;letter-spacing:0.5px">Requested New Limit</label>
      <div style="display:flex;gap:8px;margin-bottom:8px;flex-wrap:wrap">${suggestHtml}</div>
      <input id="limit-req-amount" type="number" placeholder="Enter amount" value="${suggestions[0] || current * 2}"
        style="width:100%;padding:12px 14px;border-radius:10px;border:1px solid var(--glass-border);background:rgba(255,255,255,0.04);color:var(--text);font-size:16px;font-family:'JetBrains Mono',monospace;outline:none;box-sizing:border-box">
    </div>
    <div style="margin-bottom:16px">
      <label style="display:block;font-size:11px;color:var(--text2);margin-bottom:6px;text-transform:uppercase;letter-spacing:0.5px">Reason (optional)</label>
      <input id="limit-req-reason" placeholder="e.g. High customer demand, need more capacity"
        style="width:100%;padding:12px 14px;border-radius:10px;border:1px solid var(--glass-border);background:rgba(255,255,255,0.04);color:var(--text);font-size:14px;font-family:inherit;outline:none;box-sizing:border-box">
    </div>
    <div id="limit-req-error" style="color:var(--red);font-size:12px;margin-bottom:8px"></div>
    <button id="limit-req-submit" onclick="submitLimitRequest()" style="width:100%;padding:14px;border-radius:12px;border:none;background:var(--gradient2);color:#fff;font-size:15px;font-weight:700;cursor:pointer;font-family:inherit">
      ${isFirst ? 'Get Instant Approval' : 'Submit Request'}
    </button>
  `);
}

async function submitLimitRequest() {
  const amount = Number(document.getElementById('limit-req-amount').value);
  const reason = document.getElementById('limit-req-reason').value.trim();
  const errEl = document.getElementById('limit-req-error');
  errEl.textContent = '';

  if (!amount || amount <= 0) { errEl.textContent = 'Enter a valid amount'; return; }

  const btn = document.getElementById('limit-req-submit');
  btn.disabled = true; btn.textContent = 'Submitting...';

  try {
    const res = await authFetch(API_BASE + '/api/pos/limit-request', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ requestedLimit: amount, reason }),
    });
    const data = await res.json();
    if (!res.ok) { errEl.textContent = data.error || 'Request failed'; btn.disabled = false; btn.textContent = 'Submit Request'; return; }

    closeModal();
    if (data.autoApproved) {
      showToast(data.message || 'Limit increased instantly!', 'success');
    } else {
      showToast(data.message || 'Limit request submitted for review', 'info');
    }
    loadPosAgentCard();
  } catch (e) {
    errEl.textContent = 'Network error';
    btn.disabled = false; btn.textContent = 'Submit Request';
  }
}

function showPosVerifyModal() {
  showDynamicModal('Verify Identity', `
    <p style="font-size:13px;color:var(--text2);margin-bottom:16px">Adding BVN or NIN helps verify your identity and qualifies you for higher daily limits.</p>
    <div style="margin-bottom:12px">
      <label style="display:block;font-size:11px;color:var(--text2);margin-bottom:6px;text-transform:uppercase;letter-spacing:0.5px">BVN (Bank Verification Number)</label>
      <input id="verify-bvn" placeholder="11-digit BVN" maxlength="11"
        style="width:100%;padding:12px 14px;border-radius:10px;border:1px solid var(--glass-border);background:rgba(255,255,255,0.04);color:var(--text);font-size:14px;font-family:'JetBrains Mono',monospace;outline:none;box-sizing:border-box">
    </div>
    <div style="margin-bottom:16px">
      <label style="display:block;font-size:11px;color:var(--text2);margin-bottom:6px;text-transform:uppercase;letter-spacing:0.5px">NIN (National Identification Number)</label>
      <input id="verify-nin" placeholder="11-digit NIN" maxlength="11"
        style="width:100%;padding:12px 14px;border-radius:10px;border:1px solid var(--glass-border);background:rgba(255,255,255,0.04);color:var(--text);font-size:14px;font-family:'JetBrains Mono',monospace;outline:none;box-sizing:border-box">
    </div>
    <div id="verify-error" style="color:var(--red);font-size:12px;margin-bottom:8px"></div>
    <button onclick="submitPosVerify()" style="width:100%;padding:14px;border-radius:12px;border:none;background:var(--gradient2);color:#fff;font-size:15px;font-weight:700;cursor:pointer;font-family:inherit">Save</button>
  `);
}

async function submitPosVerify() {
  const bvn = document.getElementById('verify-bvn').value.trim();
  const nin = document.getElementById('verify-nin').value.trim();
  if (!bvn && !nin) { document.getElementById('verify-error').textContent = 'Enter at least BVN or NIN'; return; }
  closeModal();
  showToast('Identity details saved. This will be verified.', 'success');
  loadPosAgentCard();
}

async function showReferralModal() {
  if (!posAgentData) return;
  // Fetch referral data
  let refData = { referralCount: 0, bonuses: { totalEarned: 0 }, referrals: [], shareLink: '', bonusStructure: {} };
  try {
    const res = await authFetch(API_BASE + '/api/pos/my-referrals');
    if (res.ok) refData = await res.json();
  } catch(e) {}

  const code = posAgentData.agentCode;
  const link = refData.shareLink || ('https://www.upromptpay.com/?ref=' + code);

  showDynamicModal('Refer Agents & Earn', `
    <div style="text-align:center;margin-bottom:16px">
      <div style="font-size:13px;color:var(--text2);margin-bottom:8px">Your Referral Code</div>
      <div style="font-size:28px;font-weight:800;font-family:'JetBrains Mono',monospace;color:var(--accent2);letter-spacing:2px">${code}</div>
    </div>

    <div style="display:flex;gap:10px;margin-bottom:16px">
      <div style="flex:1;text-align:center;padding:12px;border-radius:10px;background:rgba(34,197,94,0.08);border:1px solid rgba(34,197,94,0.15)">
        <div style="font-size:20px;font-weight:800;color:#22c55e">${refData.referralCount}</div>
        <div style="font-size:10px;color:var(--text2);margin-top:2px">Referrals</div>
      </div>
      <div style="flex:1;text-align:center;padding:12px;border-radius:10px;background:rgba(124,58,237,0.08);border:1px solid rgba(124,58,237,0.15)">
        <div style="font-size:20px;font-weight:800;color:var(--accent2)">${formatNaira(refData.bonuses.totalEarned)}</div>
        <div style="font-size:10px;color:var(--text2);margin-top:2px">Earned</div>
      </div>
    </div>

    <div style="padding:12px;border-radius:10px;background:rgba(255,255,255,0.03);border:1px solid var(--glass-border);margin-bottom:12px">
      <div style="font-size:11px;color:var(--text2);margin-bottom:6px;text-transform:uppercase;letter-spacing:0.5px">Bonus Structure</div>
      <div style="font-size:12px;line-height:1.8">
        <div><span style="color:#22c55e;font-weight:700">\u20A6500</span> — when they sign up <span style="color:var(--text3)">(they get \u20A6200)</span></div>
        <div><span style="color:#22c55e;font-weight:700">\u20A61,000</span> — when they make first sale <span style="color:var(--text3)">(they get \u20A6500)</span></div>
        <div><span style="color:#22c55e;font-weight:700">\u20A62,000</span> — when they reach 10 sales</div>
        <div><span style="color:#22c55e;font-weight:700">\u20A65,000</span> — when they reach 50 sales</div>
        <div><span style="color:#22c55e;font-weight:700">2%</span> — ongoing commission share for 6 months</div>
      </div>
    </div>

    <div style="display:flex;gap:8px">
      <button onclick="navigator.clipboard.writeText('${code}');this.textContent='Copied!';setTimeout(()=>this.textContent='Copy Code',1500)" style="flex:1;padding:12px;border-radius:10px;border:1px solid var(--glass-border);background:rgba(255,255,255,0.04);color:var(--text);font-size:13px;font-weight:600;cursor:pointer;font-family:inherit">Copy Code</button>
      <button onclick="navigator.share?navigator.share({title:'Join PromptPay Points',text:'Use my code ${code} to sign up as a PromptPay Point agent and we both earn!',url:'${link}'}):navigator.clipboard.writeText('${link}')" style="flex:1;padding:12px;border-radius:10px;border:none;background:var(--gradient2);color:#fff;font-size:13px;font-weight:600;cursor:pointer;font-family:inherit;box-shadow:0 2px 10px rgba(124,58,237,0.2)">Share Link</button>
    </div>

    ${refData.referrals.length > 0 ? `
      <div style="margin-top:16px;border-top:1px solid var(--glass-border);padding-top:12px">
        <div style="font-size:11px;color:var(--text2);margin-bottom:8px;text-transform:uppercase;letter-spacing:0.5px">Your Referrals</div>
        ${refData.referrals.map(r => `
          <div style="display:flex;align-items:center;gap:10px;padding:8px 0;border-bottom:1px solid rgba(255,255,255,0.03)">
            <div style="width:32px;height:32px;border-radius:8px;background:rgba(124,58,237,0.1);display:flex;align-items:center;justify-content:center;font-size:12px;font-weight:700;color:var(--accent2)">${(r.display_name || '?')[0]}</div>
            <div style="flex:1;min-width:0">
              <div style="font-size:13px;font-weight:600">${r.display_name}</div>
              <div style="font-size:10px;color:var(--text3)">${r.agent_code} \xB7 ${r.tier} \xB7 ${r.total_transactions || 0} txns</div>
            </div>
            <span style="font-size:10px;font-weight:600;padding:2px 8px;border-radius:8px;background:${r.status === 'active' ? 'rgba(34,197,94,0.1);color:#22c55e' : 'rgba(239,68,68,0.1);color:#ef4444'}">${r.status}</span>
          </div>
        `).join('')}
      </div>` : ''}
  `);
}

function renderPosSales(sales) {
  const list = document.getElementById('pos-sales-list');
  if (!sales.length) {
    list.innerHTML = '<div style="padding:24px 0;text-align:center;color:var(--text3);font-size:13px">No sales yet. Sell airtime to get started.</div>';
    return;
  }
  list.innerHTML = sales.map(s => {
    const isFailed = s.status === 'failed' || s.status === 'refunded';
    const time = new Date(s.created_at || s.completed_at).toLocaleTimeString('en-US', { hour: '2-digit', minute: '2-digit' });
    const date = new Date(s.created_at || s.completed_at).toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
    return `<div class="pos-sale-item">
      <div class="pos-sale-icon ${isFailed ? 'failed' : ''}">
        ${isFailed ? '<svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="#ef4444" stroke-width="2"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg>' : '<svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="#10b981" stroke-width="2"><polyline points="20 6 9 17 4 12"/></svg>'}
      </div>
      <div class="pos-sale-info">
        <div class="pos-sale-phone">${s.customer_phone}</div>
        <div class="pos-sale-carrier">${s.carrier || 'Airtime'} &middot; ${s.country || 'NG'}</div>
      </div>
      <div class="pos-sale-right">
        <div class="pos-sale-amount">${formatNaira(s.face_value)}</div>
        ${!isFailed ? `<div class="pos-sale-profit">+${formatNaira(s.agent_profit)}</div>` : `<div style="font-size:11px;color:var(--red)">${s.status}</div>`}
        <div class="pos-sale-time">${date} ${time}</div>
      </div>
    </div>`;
  }).join('');
}

function posPhoneChanged() {
  const phone = document.getElementById('pos-phone').value.trim();
  document.getElementById('pos-carrier-info').innerHTML = '';
  posCarrier = null;
  updatePosSellBtn();

  clearTimeout(posDetectTimer);
  if (phone.length >= 7) {
    posDetectTimer = setTimeout(() => detectPosCarrier(phone), 600);
  }
}

async function detectPosCarrier(phone) {
  try {
    const country = document.getElementById('pos-country').value;
    const res = await authFetch(API_BASE + '/api/pos/detect-carrier?phone=' + encodeURIComponent(phone) + '&countryCode=' + country);
    if (!res.ok) return;
    const data = await res.json();
    posCarrier = data;
    document.getElementById('pos-carrier-info').innerHTML =
      `<div class="pos-carrier-badge"><svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="20 6 9 17 4 12"/></svg> ${data.carrier}</div>`;
    posAmountChanged();
    updatePosSellBtn();
    // Load data bundles if on data tab
    if (posActiveTab === 'data' && data.operatorId) loadDataBundles(data.operatorId);
  } catch (e) { /* silent */ }
}

function posSetAmount(amt) {
  document.getElementById('pos-amount').value = amt;
  document.querySelectorAll('.pos-quick-amt').forEach(b => b.classList.remove('active'));
  event.target.classList.add('active');
  posAmountChanged();
}

function posAmountChanged() {
  const amt = parseFloat(document.getElementById('pos-amount').value) || 0;
  const preview = document.getElementById('pos-cost-preview');
  if (amt > 0) {
    preview.innerHTML = `Wallet will be debited <span style="font-weight:700">${formatNaira(amt)}</span> &middot; Collect ${formatNaira(amt)}+ cash from customer`;
  } else {
    preview.innerHTML = '';
  }
  updatePosSellBtn();
}

function updatePosSellBtn() {
  const phone = document.getElementById('pos-phone').value.trim();
  const amount = parseFloat(document.getElementById('pos-amount').value) || 0;
  document.getElementById('pos-sell-btn').disabled = !(phone.length >= 7 && amount >= 50);
}

async function posSellAirtime() {
  const phone = document.getElementById('pos-phone').value.trim();
  const amount = parseFloat(document.getElementById('pos-amount').value);
  const country = document.getElementById('pos-country').value;
  const btn = document.getElementById('pos-sell-btn');

  if (!phone || !amount) return;
  btn.disabled = true;
  btn.textContent = 'PROCESSING...';

  try {
    const res = await authFetch(API_BASE + '/api/pos/sell', {
      method: 'POST',
      body: JSON.stringify({ phoneNumber: phone, amount, countryCode: country })
    });
    const data = await res.json();

    if (res.ok && data.success) {
      showToast('Airtime sent successfully!');
      lastReceipt = data;
      showPosReceipt(data);
      // Reset form
      document.getElementById('pos-phone').value = '';
      document.getElementById('pos-amount').value = '';
      document.getElementById('pos-carrier-info').innerHTML = '';
      document.getElementById('pos-cost-preview').innerHTML = '';
      document.querySelectorAll('.pos-quick-amt').forEach(b => b.classList.remove('active'));
      posCarrier = null;
      // Reload data
      loadPosData();
    } else {
      showToast(data.error || 'Sale failed');
    }
  } catch (e) {
    showToast('Network error. Try again.');
  } finally {
    btn.disabled = false;
    btn.textContent = 'SELL AIRTIME';
    updatePosSellBtn();
  }
}

function showPosReceipt(data) {
  const now = new Date();
  const receiptHtml = `<div class="pos-receipt">
    <h4>PromptPay POS</h4>
    <div style="text-align:center;font-size:11px;color:#666;margin-bottom:8px">${now.toLocaleDateString()} ${now.toLocaleTimeString()}</div>
    <hr>
    <div class="rcpt-row"><span class="rcpt-label">Phone</span><span class="rcpt-val">${data.phoneNumber || data.customerPhone || ''}</span></div>
    <div class="rcpt-row"><span class="rcpt-label">Carrier</span><span class="rcpt-val">${data.carrier || 'Auto'}</span></div>
    <div class="rcpt-row"><span class="rcpt-label">Product</span><span class="rcpt-val">Airtime</span></div>
    <hr>
    <div class="rcpt-total">${formatNaira(data.faceValue || data.amount)}</div>
    <hr>
    <div class="rcpt-row"><span class="rcpt-label">Tx ID</span><span class="rcpt-val">${(data.transactionId || data.posTransactionId || '').slice(0, 12)}...</span></div>
    <div class="rcpt-row"><span class="rcpt-label">Status</span><span class="rcpt-val" style="color:#10b981">COMPLETED</span></div>
    <div class="rcpt-footer">Powered by PromptPay &middot; www.upromptpay.com</div>
  </div>`;
  document.getElementById('pos-receipt-content').innerHTML = receiptHtml;
  document.getElementById('pos-receipt-modal').classList.add('active');
}

function closeReceiptModal() {
  document.getElementById('pos-receipt-modal').classList.remove('active');
}

async function shareReceipt() {
  if (navigator.share && lastReceipt) {
    try {
      await navigator.share({
        title: 'PromptPay Airtime Receipt',
        text: `Airtime of ${formatNaira(lastReceipt.faceValue || lastReceipt.amount)} sent to ${lastReceipt.phoneNumber || lastReceipt.customerPhone}. Tx: ${lastReceipt.transactionId || lastReceipt.posTransactionId}. Powered by PromptPay.`
      });
    } catch (e) { /* user cancelled */ }
  } else {
    showToast('Share not available');
  }
}

// ── Fund Wallet ──
function openFundWalletModal() {
  document.getElementById('fund-error').textContent = '';
  document.getElementById('fund-amount').value = '';
  document.querySelectorAll('.fund-amt-btn').forEach(b => b.classList.remove('active'));
  loadFundCardOptions();
  document.getElementById('fund-wallet-modal').classList.add('active');
}

function closeFundModal() {
  document.getElementById('fund-wallet-modal').classList.remove('active');
}

function fundSetAmount(amt) {
  document.getElementById('fund-amount').value = amt;
  document.querySelectorAll('.fund-amt-btn').forEach(b => b.classList.remove('active'));
  event.target.classList.add('active');
}

async function loadFundCardOptions() {
  const container = document.getElementById('fund-card-select');
  try {
    const res = await authFetch(API_BASE + '/api/user/payment-methods');
    if (!res.ok) { container.innerHTML = '<div style="color:var(--red);font-size:13px">Add a card in Wallet first</div>'; return; }
    const { methods } = await res.json();
    posLinkedCards = methods;
    if (!methods.length) {
      container.innerHTML = '<div style="font-size:13px;color:var(--text2)">No cards linked. <span style="color:var(--accent2);cursor:pointer" onclick="closeFundModal();navigateTo(\'wallet\');openAddCardModal()">Add one</span></div>';
      return;
    }
    container.innerHTML = '<label style="font-size:12px;color:var(--text2);display:block;margin-bottom:6px">Pay With</label>' +
      methods.map((m, i) => `<label style="display:flex;align-items:center;gap:10px;padding:12px;border-radius:10px;border:1px solid var(--glass-border);cursor:pointer;margin-bottom:6px;background:${i === 0 ? 'rgba(124,58,237,0.08)' : 'transparent'}">
        <input type="radio" name="fund-card" value="${m.id}" ${i === 0 ? 'checked' : ''} style="accent-color:var(--accent)">
        <span style="font-size:14px">${(m.brand||'Card').toUpperCase()} ····${m.last4}</span>
      </label>`).join('');
  } catch (e) {
    container.innerHTML = '<div style="color:var(--red);font-size:13px">Failed to load cards</div>';
  }
}

async function submitFundWallet() {
  const amount = parseFloat(document.getElementById('fund-amount').value);
  const errorEl = document.getElementById('fund-error');
  const btn = document.getElementById('fund-submit-btn');
  errorEl.textContent = '';

  if (!amount || amount < 100) { errorEl.textContent = 'Minimum amount is \u20A6100'; return; }

  const cardRadio = document.querySelector('input[name="fund-card"]:checked');
  if (!cardRadio) { errorEl.textContent = 'Select a payment card'; return; }

  btn.disabled = true;
  btn.textContent = 'Processing...';
  console.log('[FUND] Starting fund:', { amount, paymentMethodId: cardRadio.value });

  try {
    const res = await authFetch(API_BASE + '/api/wallet/fund', {
      method: 'POST',
      body: JSON.stringify({ amount, currency: 'NGN', paymentMethodId: cardRadio.value })
    });
    console.log('[FUND] Response status:', res.status);
    const data = await res.json();
    console.log('[FUND] Response data:', JSON.stringify(data));

    if (data.funded) {
      showToast('Wallet funded with ' + formatNaira(amount));
      closeFundModal();
      loadPosData();
    } else if (data.clientSecret) {
      // 3DS required
      console.log('[FUND] 3DS required, confirming card payment...');
      const stripe = Stripe(stripePublishableKey || '');
      const result = await stripe.confirmCardPayment(data.clientSecret, {
        return_url: window.location.origin + '/?wallet_funded=true'
      });
      console.log('[FUND] 3DS result:', result.error ? result.error.message : 'success');
      if (result.error) {
        errorEl.textContent = result.error.message;
      } else {
        const confirmRes = await authFetch(API_BASE + '/api/wallet/fund/confirm', {
          method: 'POST',
          body: JSON.stringify({ paymentIntentId: result.paymentIntent.id, amount, currency: 'NGN' })
        });
        const confirmData = await confirmRes.json();
        console.log('[FUND] Confirm data:', JSON.stringify(confirmData));
        if (confirmData.funded || confirmData.success) {
          showToast('Wallet funded with ' + formatNaira(amount));
          closeFundModal();
          loadPosData();
        } else {
          errorEl.textContent = confirmData.error || 'Funding failed after 3DS verification';
        }
      }
    } else {
      errorEl.textContent = data.error || 'Funding failed. Please try again.';
      console.error('[FUND] Funding failed:', data);
    }
  } catch (e) {
    console.error('[FUND] Exception:', e);
    errorEl.textContent = 'Network error: ' + (e.message || 'Try again.');
  } finally {
    btn.disabled = false;
    btn.textContent = 'Fund Wallet';
  }
}

// ── POS Tab Switching & Data Bundles ──
let posActiveTab = 'airtime';
let posDataBundles = [];
let posSelectedBundle = null;

function switchPosTab(tab) {
  posActiveTab = tab;
  document.getElementById('tab-airtime').style.background = tab === 'airtime' ? 'rgba(124,58,237,0.15)' : 'var(--surface)';
  document.getElementById('tab-airtime').style.color = tab === 'airtime' ? 'var(--accent2)' : 'var(--text2)';
  document.getElementById('tab-data').style.background = tab === 'data' ? 'rgba(59,130,246,0.15)' : 'var(--surface)';
  document.getElementById('tab-data').style.color = tab === 'data' ? '#3b82f6' : 'var(--text2)';
  document.getElementById('pos-airtime-section').style.display = tab === 'airtime' ? 'block' : 'none';
  document.getElementById('pos-data-section').style.display = tab === 'data' ? 'block' : 'none';
  if (tab === 'data' && posCarrier && posCarrier.operatorId) {
    loadDataBundles(posCarrier.operatorId);
  }
}

async function loadDataBundles(operatorId) {
  const container = document.getElementById('pos-data-bundles-list');
  container.innerHTML = '<div style="padding:16px;text-align:center;color:var(--text3);font-size:13px">Loading data plans...</div>';
  try {
    const res = await authFetch(API_BASE + '/api/pos/data-bundles?operatorId=' + operatorId);
    if (!res.ok) { container.innerHTML = '<div style="padding:16px;text-align:center;color:var(--red);font-size:13px">Failed to load plans</div>'; return; }
    const data = await res.json();
    posDataBundles = data.bundles || [];
    if (!posDataBundles.length) {
      container.innerHTML = '<div style="padding:16px;text-align:center;color:var(--text3);font-size:13px">No data plans available for this carrier</div>';
      return;
    }
    container.innerHTML = posDataBundles.map((b, i) =>
      `<label style="display:flex;align-items:center;gap:10px;padding:12px;border-radius:10px;border:1px solid var(--glass-border);cursor:pointer;margin-bottom:6px;background:transparent;transition:all 0.15s" onclick="selectDataBundle(${i},this)">
        <input type="radio" name="pos-data-bundle" value="${i}" style="accent-color:#3b82f6">
        <div style="flex:1">
          <div style="font-size:14px;font-weight:600">${b.name}</div>
          <div style="font-size:11px;color:var(--text2)">${b.validity ? b.validity + ' ' + (b.validityUnit || 'days') : ''}</div>
        </div>
        <div style="font-size:15px;font-weight:700;color:#3b82f6">${formatNaira(b.price)}</div>
      </label>`
    ).join('');
  } catch (e) {
    container.innerHTML = '<div style="padding:16px;text-align:center;color:var(--red);font-size:13px">Error loading plans</div>';
  }
}

function selectDataBundle(idx, el) {
  posSelectedBundle = posDataBundles[idx];
  document.querySelectorAll('#pos-data-bundles-list label').forEach(l => l.style.background = 'transparent');
  el.style.background = 'rgba(59,130,246,0.08)';
  document.getElementById('pos-sell-data-btn').disabled = !(posSelectedBundle && document.getElementById('pos-phone').value.trim().length >= 7);
}

async function posSellData() {
  if (!posSelectedBundle || !posCarrier) return;
  const phone = document.getElementById('pos-phone').value.trim();
  const country = document.getElementById('pos-country').value;
  const btn = document.getElementById('pos-sell-data-btn');

  btn.disabled = true;
  btn.textContent = 'PROCESSING...';

  try {
    const res = await authFetch(API_BASE + '/api/pos/sell-data', {
      method: 'POST',
      body: JSON.stringify({
        phoneNumber: phone,
        amount: posSelectedBundle.price,
        countryCode: country,
        operatorId: posCarrier.operatorId,
        dataBundleId: posSelectedBundle.id,
        bundleName: posSelectedBundle.name,
      })
    });
    const data = await res.json();
    if (res.ok && data.success) {
      showToast('Data bundle sent!');
      lastReceipt = { ...data, productType: 'Data', bundleName: posSelectedBundle.name };
      showPosReceipt({ ...data, productType: 'Data' });
      posSelectedBundle = null;
      document.querySelectorAll('#pos-data-bundles-list input[type=radio]').forEach(r => r.checked = false);
      loadPosData();
    } else {
      showToast(data.error || 'Sale failed');
    }
  } catch (e) {
    showToast('Network error');
  } finally {
    btn.disabled = false;
    btn.textContent = 'SELL DATA';
  }
}

async function posLoadAllSales() {
  try {
    const res = await authFetch(API_BASE + '/api/pos/sales');
    if (!res.ok) return;
    const data = await res.json();
    renderPosSales(data.sales || []);
  } catch (e) { showToast('Failed to load sales'); }
}

// ══════════════════════════════════════════════════════════

async function executePayByPhone() {
  const amount = parseFloat(document.getElementById('pay-amount').value);
  const label = document.getElementById('pay-label').value.trim() || 'PromptPay Payment';
  if (!amount || amount <= 0) { showToast('Enter an amount'); return; }
  closeModals();
  const result = await payByPhone(amount, label);
  if (result) {
    // Route through AI chat for confirmation
    navigateTo('ai');
    document.getElementById('chat-input').value = `Payment of $${amount.toFixed(2)} for "${label}" completed via phone`;
    sendMessage();
  }
}

async function executeSend() {
  const amount = parseFloat(document.getElementById('send-amount')?.value);
  const note = document.getElementById('send-note')?.value?.trim() || '';
  const errEl = document.getElementById('send-error');
  const btn = document.getElementById('send-submit-btn');
  if (errEl) errEl.textContent = '';
  if (!amount || amount <= 0) { if (errEl) errEl.textContent = 'Enter a valid amount'; return; }

  // Check KYC
  if (!userKyc || userKyc.tier < 1) {
    closeModals();
    openKycModal();
    return;
  }

  const country = getUserCountry();
  const currencies = { NG: 'NGN', GH: 'GHS', KE: 'KES', UG: 'UGX', US: 'USD' };
  const currency = currencies[country] || 'USD';

  btn.disabled = true;
  btn.textContent = 'Processing...';

  try {
    if (currentSendType === 'bank') {
      const bankSelect = document.getElementById('send-bank');
      const bankCode = bankSelect?.value;
      const bankName = bankSelect?.selectedOptions[0]?.dataset?.name || bankSelect?.selectedOptions[0]?.textContent || '';
      const accountNumber = document.getElementById('send-account')?.value?.trim();
      const routingNumber = document.getElementById('send-routing')?.value?.trim() || '';
      const swiftCode = document.getElementById('send-swift')?.value?.trim() || '';
      if (!bankCode || !accountNumber) { if (errEl) errEl.textContent = 'Select bank and enter account number'; return; }

      const transferBody = { bank_code: bankCode, account_number: accountNumber, account_name: bankName, amount, currency, narration: note, country };
      if (routingNumber) transferBody.routing_number = routingNumber;
      if (swiftCode) transferBody.swift_code = swiftCode;
      if (currentSendScope === 'international') transferBody.transfer_scope = 'international';

      const res = await authFetch(API_BASE + '/api/transfers/bank', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(transferBody),
      });
      const data = await res.json();
      if (!res.ok) {
        if (data.requiresKyc) { closeModals(); openKycModal(); return; }
        if (errEl) errEl.textContent = data.error || 'Transfer failed';
        return;
      }
      closeModals();
      showTransferSuccess(data.transfer, bankName, accountNumber);

    } else if (currentSendType === 'mobile_money') {
      const provider = document.getElementById('send-momo-provider')?.value;
      const phone = document.getElementById('send-momo-phone')?.value?.trim();
      if (!provider || !phone) { if (errEl) errEl.textContent = 'Select provider and enter phone number'; return; }

      const res = await authFetch(API_BASE + '/api/transfers/mobile-money', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ provider, phone_number: phone, amount, currency, narration: note, country }),
      });
      const data = await res.json();
      if (!res.ok) {
        if (data.requiresKyc) { closeModals(); openKycModal(); return; }
        if (errEl) errEl.textContent = data.error || 'Transfer failed';
        return;
      }
      closeModals();
      showTransferSuccess(data.transfer, provider, phone);

    } else {
      // Wallet / PromptPay transfer - route through AI
      const to = document.getElementById('send-to')?.value?.trim();
      if (!to) { if (errEl) errEl.textContent = 'Enter recipient'; return; }
      closeModals();
      navigateTo('ai');
      document.getElementById('chat-input').value = `Send ${countryConfig?.currencySymbol || '$'}${amount} to ${to}${note ? ' for ' + note : ''}`;
      sendMessage();
      return;
    }
  } catch (e) {
    if (errEl) errEl.textContent = 'Connection error. Try again.';
  } finally {
    btn.disabled = false;
    btn.textContent = 'Send Payment';
  }
  loadTransferHistory();
}

function showTransferSuccess(transfer, recipientLabel, recipientDetail) {
  const sym = countryConfig?.currencySymbol || '$';
  navigateTo('ai');
  const statusText = transfer.status === 'completed' ? 'sent' : 'initiated (pending confirmation)';
  addChatMessage('ai', `Transfer ${statusText}!\n\n${sym}${transfer.amount.toLocaleString()} to ${recipientLabel} (${recipientDetail})\nFee: ${sym}${transfer.fee?.toFixed(2) || '0.00'}\nRef: ${transfer.id.slice(0, 8).toUpperCase()}`);
}

function handleTaskResult(msg) {
  if (msg.result?.output) {
    cacheResponse(msg.taskId, msg.result.output);
  }
}

// ── Transfer History ──
let transferHistory = [];

async function loadTransferHistory() {
  try {
    const res = await authFetch(API_BASE + '/api/transfers?limit=30');
    if (!res.ok) return;
    const data = await res.json();
    transferHistory = data.transfers || [];
    populateActivity();
    populateRecentActivity();
  } catch (e) {}
}

function populateActivity() {
  const list = document.getElementById('activity-tx-list');
  if (!list) return;
  if (transferHistory.length === 0) {
    list.innerHTML = `
      <div style="padding:40px 0;text-align:center;color:var(--text3)">
        <svg width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1" style="margin-bottom:12px;opacity:0.3"><polyline points="22 12 18 12 15 21 9 3 6 12 2 12"/></svg>
        <div style="font-size:14px;margin-bottom:4px">No transactions yet</div>
        <div style="font-size:12px">Send money or top up to get started</div>
      </div>`;
    return;
  }
  list.innerHTML = transferHistory.map(tx => {
    const statusColors = { completed: '#10b981', pending: '#fbbf24', failed: '#ef4444' };
    const typeIcons = { bank: '\ud83c\udfe6', mobile_money: '\ud83d\udcf1', wallet: '\ud83d\udcb3' };
    const date = new Date(tx.created_at);
    const timeStr = date.toLocaleDateString('en', { month: 'short', day: 'numeric' }) + ' ' + date.toLocaleTimeString('en', { hour: '2-digit', minute: '2-digit' });
    return `
      <div style="display:flex;align-items:center;gap:12px;padding:14px 0;border-bottom:1px solid rgba(255,255,255,0.04)">
        <div style="width:40px;height:40px;border-radius:12px;background:var(--surface);display:flex;align-items:center;justify-content:center;font-size:18px">${typeIcons[tx.type] || '\ud83d\udcb8'}</div>
        <div style="flex:1;min-width:0">
          <div style="font-size:14px;font-weight:500;white-space:nowrap;overflow:hidden;text-overflow:ellipsis">${tx.recipient_name || tx.recipient_account || 'Transfer'}</div>
          <div style="font-size:12px;color:var(--text3)">${timeStr} \u2022 ${tx.provider}</div>
        </div>
        <div style="text-align:right">
          <div style="font-size:14px;font-weight:600">-${tx.currency} ${parseFloat(tx.amount).toLocaleString()}</div>
          <div style="font-size:11px;color:${statusColors[tx.status] || '#aaa'}">${tx.status}</div>
        </div>
      </div>`;
  }).join('');
}

function populateRecentActivity() {
  const list = document.getElementById('recent-tx-list');
  if (!list) return;
  const recent = transferHistory.slice(0, 3);
  if (recent.length === 0) {
    list.innerHTML = '<div style="padding:20px;text-align:center;color:var(--text3);font-size:13px">No transactions yet. Send money or top up to get started.</div>';
    return;
  }
  list.innerHTML = recent.map(tx => {
    const date = new Date(tx.created_at);
    const timeStr = date.toLocaleDateString('en', { month: 'short', day: 'numeric' });
    return `
      <div style="display:flex;align-items:center;gap:12px;padding:12px 0;border-bottom:1px solid rgba(255,255,255,0.04)">
        <div style="flex:1"><div style="font-size:13px;font-weight:500">${tx.recipient_name || tx.recipient_account || 'Transfer'}</div><div style="font-size:11px;color:var(--text3)">${timeStr}</div></div>
        <div style="font-size:13px;font-weight:600">-${tx.currency} ${parseFloat(tx.amount).toLocaleString()}</div>
      </div>`;
  }).join('');
}

// ── Landing Page Logic ──

// Agent Chat Conversation Sequence
const AGENT_CHAT_SEQUENCE = [
  { type: 'user', text: 'Send $50 to Sarah for dinner', delay: 1800 },
  { type: 'thinking', delay: 1500 },
  { type: 'ai', text: "Done! $50 sent to Sarah. She'll get it instantly.", delay: 3000 },
  { type: 'user', text: "What's my balance?", delay: 2000 },
  { type: 'thinking', delay: 800 },
  { type: 'ai', text: 'Your balance is $2,450.80 — up $125 today.', delay: 3500 },
  { type: 'user', text: 'Pay my electric bill', delay: 2000 },
  { type: 'thinking', delay: 1200 },
  { type: 'ai', text: 'Electric bill of $87.50 paid to Con Edison. Confirmation sent to your email.', delay: 4000 },
];

let agentChatRunning = false;

function updateAgentStatus(status) {
  const glow = document.getElementById('agent-glow');
  const mouthFill = document.getElementById('agent-mouth-fill');
  const statusIcon = document.getElementById('agent-status-icon');
  const title = document.getElementById('agent-chat-title');
  const subtitle = document.getElementById('agent-chat-subtitle');
  const progressFill = document.getElementById('agent-progress-fill');

  if (glow) glow.className = 'agent-glow ' + status;
  if (mouthFill) mouthFill.className = 'agent-mouth-fill ' + status;
  if (statusIcon) {
    statusIcon.className = 'agent-chat-status-icon ' + status;
    const colors = { greeting: '#22d3ee', thinking: '#fbbf24', success: '#34d399' };
    statusIcon.innerHTML = status === 'success'
      ? '<svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="' + colors[status] + '" stroke-width="2"><path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"/><polyline points="22 4 12 14.01 9 11.01"/></svg>'
      : '<svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="' + colors[status] + '" stroke-width="2"><polygon points="12 2 15.09 8.26 22 9.27 17 14.14 18.18 21.02 12 17.77 5.82 21.02 7 14.14 2 9.27 8.91 8.26 12 2"/></svg>';
  }
  if (title) {
    const titles = { greeting: 'Welcome to PromptPay!', thinking: 'Processing...', success: 'Done!' };
    title.textContent = titles[status] || titles.greeting;
  }
  if (subtitle) {
    const subs = { greeting: 'Your AI financial assistant', thinking: 'Executing your command...', success: 'Transaction completed' };
    subtitle.textContent = subs[status] || subs.greeting;
  }
  if (progressFill) {
    progressFill.style.width = status === 'thinking' ? '100%' : '0';
  }
  // Toggle floating icons
  document.querySelectorAll('.agent-icon-bubble').forEach(icon => {
    if (status === 'success') icon.classList.add('hide');
    else icon.classList.remove('hide');
  });
}

function initAgentChat() {
  const container = document.getElementById('agent-messages');
  if (!container || agentChatRunning) return;
  agentChatRunning = true;
  let idx = 0;

  function showNext() {
    if (!document.getElementById('agent-messages')) { agentChatRunning = false; return; }
    if (idx >= AGENT_CHAT_SEQUENCE.length) {
      setTimeout(() => {
        container.innerHTML = '';
        idx = 0;
        updateAgentStatus('greeting');
        showNext();
      }, 3000);
      return;
    }
    const item = AGENT_CHAT_SEQUENCE[idx];
    if (item.type === 'thinking') {
      updateAgentStatus('thinking');
      const dots = document.createElement('div');
      dots.className = 'agent-msg typing-msg';
      dots.innerHTML = '<div class="agent-typing-dot"></div><div class="agent-typing-dot"></div><div class="agent-typing-dot"></div>';
      container.appendChild(dots);
      container.scrollTop = container.scrollHeight;
      setTimeout(() => {
        if (dots.parentNode) dots.parentNode.removeChild(dots);
        idx++;
        showNext();
      }, item.delay);
    } else {
      if (item.type === 'ai') updateAgentStatus('success');
      if (item.type === 'user') updateAgentStatus('greeting');
      const msg = document.createElement('div');
      msg.className = 'agent-msg ' + item.type;
      msg.textContent = item.text;
      container.appendChild(msg);
      container.scrollTop = container.scrollHeight;
      idx++;
      setTimeout(showNext, item.delay);
    }
  }
  setTimeout(showNext, 1500);
}

// Agent Eye Tracking
document.addEventListener('mousemove', (e) => {
  const agent = document.getElementById('agent-wrapper');
  if (!agent) return;
  const rect = agent.getBoundingClientRect();
  const x = ((e.clientX - rect.left) / rect.width - 0.5) * 2;
  const y = ((e.clientY - rect.top) / rect.height - 0.5) * 2;
  const eyes = document.getElementById('agent-eyes');
  if (eyes) eyes.style.transform = 'translate(' + (x * 5) + 'px, ' + (y * 3) + 'px)';
});

// Agent Blinking
setInterval(() => {
  document.querySelectorAll('.agent-eye').forEach(eye => eye.classList.add('blink'));
  setTimeout(() => document.querySelectorAll('.agent-eye').forEach(eye => eye.classList.remove('blink')), 150);
}, 4000);

function startLandingTyping() {
  // Legacy — now handled by initAgentChat
  initAgentChat();
}

// Landing nav scroll effect
window.addEventListener('scroll', () => {
  const nav = document.getElementById('lp-nav');
  if (nav) {
    if (window.scrollY > 50) nav.classList.add('scrolled');
    else nav.classList.remove('scrolled');
  }
});

function showLanding() {
  document.getElementById('landing-page').classList.add('active');
  document.getElementById('auth-gate').classList.add('hidden');
  document.body.className = 'landing-mode';
}

function showAuthGate(tab) {
  document.getElementById('landing-page').classList.remove('active');
  document.getElementById('auth-gate').classList.remove('hidden');
  document.body.className = 'landing-mode';
  if (tab) switchAuthTab(tab);
}

function enterAppMode() {
  document.getElementById('landing-page').classList.remove('active');
  document.getElementById('auth-gate').classList.add('hidden');
  document.body.className = 'app-mode';
  // Close homepage chat widget when entering app
  const ppWidget = document.getElementById('pp-chat-widget');
  const ppFab = document.getElementById('pp-chat-fab');
  if (ppWidget) ppWidget.classList.remove('open');
  if (ppFab) ppFab.classList.remove('open');
}

// ── Init ──
(async function initApp() {
  const hadToken = !!localStorage.getItem('promptpay_had_session');
  if (authToken) {
    localStorage.setItem('promptpay_had_session', '1');
    const valid = await validateToken();
    if (valid) {
      enterAppMode();
      showApp();
    } else {
      showAuthGate('login');
      document.getElementById('login-error').textContent = 'Your session has expired. Please sign in again.';
    }
  } else {
    // No token — show landing page for new visitors, auth gate for returning users
    if (hadToken) {
      localStorage.removeItem('promptpay_had_session');
      showAuthGate('login');
      document.getElementById('login-error').textContent = 'Your session has expired. Please sign in again.';
    } else {
      showLanding();
      startLandingTyping();
    }
  }
})();

// ── Carrier Database per Country ──
const CARRIER_DATA = {
  NG: {
    dialCode: '+234', currency: 'NGN', name: 'Nigeria',
    presets: [100, 200, 500, 1000, 2000, 5000],
    carriers: [
      { id: 'mtn_ng', name: 'MTN Nigeria', prefixes: ['0803','0806','0703','0706','0810','0813','0814','0816','0903','0906','0913','0916'] },
      { id: 'airtel_ng', name: 'Airtel Nigeria', prefixes: ['0802','0808','0708','0812','0701','0902','0907','0901','0912'] },
      { id: 'glo_ng', name: 'Glo (Globacom)', prefixes: ['0805','0807','0705','0815','0811','0905','0915'] },
      { id: '9mobile_ng', name: '9mobile (Etisalat)', prefixes: ['0809','0818','0817','0908','0909'] },
    ]
  },
  GH: {
    dialCode: '+233', currency: 'GHS', name: 'Ghana',
    presets: [1, 2, 5, 10, 20, 50],
    carriers: [
      { id: 'mtn_gh', name: 'MTN Ghana', prefixes: ['024','025','053','054','055','059'] },
      { id: 'vodafone_gh', name: 'Vodafone Ghana (Telecel)', prefixes: ['020','050'] },
      { id: 'airteltigo_gh', name: 'AirtelTigo Ghana', prefixes: ['026','027','056','057'] },
    ]
  },
  UG: {
    dialCode: '+256', currency: 'UGX', name: 'Uganda',
    presets: [500, 1000, 2000, 5000, 10000, 20000],
    carriers: [
      { id: 'mtn_ug', name: 'MTN Uganda', prefixes: ['077','078','076'] },
      { id: 'airtel_ug', name: 'Airtel Uganda', prefixes: ['070','075','074'] },
      { id: 'africell_ug', name: 'Africell Uganda', prefixes: ['079'] },
    ]
  },
  KE: {
    dialCode: '+254', currency: 'KES', name: 'Kenya',
    presets: [20, 50, 100, 200, 500, 1000],
    carriers: [
      { id: 'safaricom_ke', name: 'Safaricom', prefixes: ['070','071','072','079','011','010'] },
      { id: 'airtel_ke', name: 'Airtel Kenya', prefixes: ['073','078','010'] },
      { id: 'telkom_ke', name: 'Telkom Kenya', prefixes: ['077'] },
    ]
  },
  ZA: {
    dialCode: '+27', currency: 'ZAR', name: 'South Africa',
    presets: [5, 10, 29, 49, 99, 199],
    carriers: [
      { id: 'vodacom_za', name: 'Vodacom', prefixes: ['060','061','062','063','064','065','066','071','072','073','082','084'] },
      { id: 'mtn_za', name: 'MTN South Africa', prefixes: ['060','061','062','063','064','065','066','071','073','078','083'] },
      { id: 'cellc_za', name: 'Cell C', prefixes: ['074','084'] },
      { id: 'telkom_za', name: 'Telkom Mobile', prefixes: ['081'] },
    ]
  },
  TZ: {
    dialCode: '+255', currency: 'TZS', name: 'Tanzania',
    presets: [500, 1000, 2000, 5000, 10000, 20000],
    carriers: [
      { id: 'vodacom_tz', name: 'Vodacom Tanzania', prefixes: ['074','075','076'] },
      { id: 'airtel_tz', name: 'Airtel Tanzania', prefixes: ['068','069','078'] },
      { id: 'tigo_tz', name: 'Tigo Tanzania', prefixes: ['065','067','071'] },
      { id: 'halotel_tz', name: 'Halotel', prefixes: ['062'] },
    ]
  },
  CM: {
    dialCode: '+237', currency: 'XAF', name: 'Cameroon',
    presets: [100, 200, 500, 1000, 2000, 5000],
    carriers: [
      { id: 'mtn_cm', name: 'MTN Cameroon', prefixes: ['67','650','651','652','653','654'] },
      { id: 'orange_cm', name: 'Orange Cameroon', prefixes: ['69','655','656','657','658','659'] },
    ]
  },
  SN: {
    dialCode: '+221', currency: 'XOF', name: 'Senegal',
    presets: [200, 500, 1000, 2000, 5000, 10000],
    carriers: [
      { id: 'orange_sn', name: 'Orange Sénégal', prefixes: ['77','78'] },
      { id: 'free_sn', name: 'Free Sénégal', prefixes: ['76'] },
      { id: 'expresso_sn', name: 'Expresso', prefixes: ['70'] },
    ]
  },
  ET: {
    dialCode: '+251', currency: 'ETB', name: 'Ethiopia',
    presets: [5, 10, 25, 50, 100, 200],
    carriers: [
      { id: 'ethio_et', name: 'Ethio Telecom', prefixes: ['091','092','093','094','095','096','097'] },
      { id: 'safaricom_et', name: 'Safaricom Ethiopia', prefixes: ['090'] },
    ]
  }
};

// Countries where airtime purchase should be hidden (US, Europe)
const NON_AIRTIME_COUNTRIES = ['US','CA','GB','DE','FR','IT','ES','NL','AU','JP'];

let airtimeRecipient = 'self'; // 'self' or 'other'

// ── Airtime Modal ──
function openAirtimeModal() {
  // Check if user country supports airtime (owners bypass)
  const userCountry = getUserCountry();
  if (!isOwner() && NON_AIRTIME_COUNTRIES.includes(userCountry)) {
    showToast('Airtime top-up is available for Africa only');
    return;
  }
  document.getElementById('airtime-modal').classList.add('active');
  // Set default country from user profile
  if (userCountry && CARRIER_DATA[userCountry]) {
    document.getElementById('airtime-country').value = userCountry;
  }
  updateCarriers();
  setAirtimeRecipient('self');
}
function closeAirtimeModal() {
  document.getElementById('airtime-modal').classList.remove('active');
}
function setAirtimeRecipient(mode) {
  airtimeRecipient = mode;
  const selfBtn = document.getElementById('airtime-self-btn');
  const otherBtn = document.getElementById('airtime-other-btn');
  const phoneLabel = document.getElementById('airtime-phone-label');
  if (mode === 'self') {
    selfBtn.style.borderColor = 'rgba(124,58,237,0.4)';
    selfBtn.style.background = 'rgba(124,58,237,0.15)';
    selfBtn.style.color = 'white';
    otherBtn.style.borderColor = 'rgba(255,255,255,0.1)';
    otherBtn.style.background = 'rgba(255,255,255,0.03)';
    otherBtn.style.color = 'var(--text2)';
    phoneLabel.textContent = 'Your phone number';
  } else {
    otherBtn.style.borderColor = 'rgba(124,58,237,0.4)';
    otherBtn.style.background = 'rgba(124,58,237,0.15)';
    otherBtn.style.color = 'white';
    selfBtn.style.borderColor = 'rgba(255,255,255,0.1)';
    selfBtn.style.background = 'rgba(255,255,255,0.03)';
    selfBtn.style.color = 'var(--text2)';
    phoneLabel.textContent = "Recipient's phone number";
  }
  document.getElementById('airtime-phone').value = '';
  document.getElementById('airtime-phone').placeholder = mode === 'self' ? 'Your number' : "Recipient's number";
}

function getUserCountry() {
  // Check user profile first, then localStorage
  if (currentUser && currentUser.country) return currentUser.country;
  return localStorage.getItem('promptpay_country') || '';
}

function isOwner() {
  return currentUser && currentUser.role === 'owner';
}

// Auto-detect country via IP on first visit (non-blocking)
async function autoDetectCountry() {
  if (localStorage.getItem('promptpay_country')) return; // already set
  try {
    const res = await fetch('https://ipapi.co/json/', { signal: AbortSignal.timeout(5000) });
    const data = await res.json();
    const supported = ['NG','GH','KE','UG','ZA','TZ','CM','SN','ET','US','CA','GB','DE','FR','IN','AU'];
    if (data.country_code && supported.includes(data.country_code)) {
      localStorage.setItem('promptpay_country', data.country_code);
      // Pre-fill registration country
      const regCountry = document.getElementById('register-country');
      if (regCountry) regCountry.value = data.country_code;
    }
  } catch (e) { /* silent fail — user will pick manually */ }
}

function updateCarriers() {
  const country = document.getElementById('airtime-country').value;
  const data = CARRIER_DATA[country];
  if (!data) return;

  // Update dial code
  document.getElementById('airtime-dial-code').textContent = data.dialCode;

  // Update currency label
  document.getElementById('airtime-currency-label').textContent = data.currency;

  // Update carriers dropdown
  const carrierSelect = document.getElementById('airtime-carrier');
  carrierSelect.innerHTML = '<option value="auto">Auto-detect from number</option>';
  data.carriers.forEach(c => {
    const opt = document.createElement('option');
    opt.value = c.id;
    opt.textContent = c.name;
    carrierSelect.appendChild(opt);
  });

  // Update amount presets
  const presetsDiv = document.getElementById('airtime-presets');
  presetsDiv.innerHTML = data.presets.slice(0, 4).map(v =>
    `<button onclick="setAirtimeAmount(${v})" style="padding:10px;border-radius:10px;border:1px solid rgba(124,58,237,0.3);background:rgba(124,58,237,0.1);color:white;cursor:pointer;font-size:13px;">${data.currency === 'UGX' ? (v >= 1000 ? (v/1000)+'K' : v) : v}</button>`
  ).join('');

  // Update phone placeholder
  const phone = document.getElementById('airtime-phone');
  const prefixHint = data.carriers[0]?.prefixes[0] || '';
  phone.placeholder = prefixHint ? `e.g. ${prefixHint}1234567` : 'Phone number';
}

function setAirtimeAmount(val) {
  document.getElementById('airtime-amount').value = val;
  const country = document.getElementById('airtime-country').value;
  const data = CARRIER_DATA[country];
  const fee = Math.round(val * 0.02 * 100) / 100;
  document.getElementById('airtime-fee-display').textContent = `Fee: ${fee} ${data?.currency || ''} (2%) | Total: ${val + fee} ${data?.currency || ''}`;
}

function autoDetectCarrier(phone, country) {
  const data = CARRIER_DATA[country];
  if (!data) return null;
  // Normalize: remove leading +countrycode or leading 0
  let normalized = phone.replace(/\s|-/g, '');
  if (normalized.startsWith(data.dialCode.replace('+', ''))) {
    normalized = '0' + normalized.slice(data.dialCode.length - 1);
  }
  for (const carrier of data.carriers) {
    for (const prefix of carrier.prefixes) {
      if (normalized.startsWith(prefix)) return carrier;
    }
  }
  return null;
}

async function executeAirtime(type) {
  const country = document.getElementById('airtime-country').value;
  const carrierVal = document.getElementById('airtime-carrier').value;
  const dialCode = CARRIER_DATA[country]?.dialCode?.replace('+', '') || '';
  let phone = document.getElementById('airtime-phone').value.trim().replace(/\s|-/g, '');
  const amount = parseFloat(document.getElementById('airtime-amount').value);
  if (!phone || !amount) { showToast('Enter phone number and amount'); return; }

  // Normalize phone: prepend country code if starts with 0
  if (phone.startsWith('0')) {
    phone = dialCode + phone.slice(1);
  } else if (!phone.startsWith(dialCode)) {
    phone = dialCode + phone;
  }

  // Detect or use selected carrier
  let carrierName = 'Auto-detect';
  if (carrierVal !== 'auto') {
    const data = CARRIER_DATA[country];
    const c = data?.carriers.find(c => c.id === carrierVal);
    if (c) carrierName = c.name;
  } else {
    const detected = autoDetectCarrier(phone, country);
    if (detected) carrierName = detected.name;
  }

  closeAirtimeModal();
  navigateTo('ai');
  const recipientNote = airtimeRecipient === 'other' ? ' (for someone else)' : '';
  const msg = type === 'data'
    ? `Buy data bundle: ${amount} ${CARRIER_DATA[country]?.currency || ''} for ${phone} on ${carrierName} in ${CARRIER_DATA[country]?.name || country}${recipientNote}`
    : `Buy airtime: ${amount} ${CARRIER_DATA[country]?.currency || ''} for ${phone} on ${carrierName} in ${CARRIER_DATA[country]?.name || country}${recipientNote}`;
  document.getElementById('chat-input').value = msg;
  sendMessage();
}

// ── Request Money Modal ──
function closeRequestModal() {
  document.getElementById('request-modal').classList.remove('active');
}
async function executeRequestMoney() {
  const contact = document.getElementById('request-contact').value;
  const amount = parseFloat(document.getElementById('request-amount').value);
  const message = document.getElementById('request-message').value;
  if (!contact || !amount) { showToast('Enter contact and amount'); return; }
  closeRequestModal();
  navigateTo('ai');
  const msg = `Request $${amount} from ${contact}${message ? ': ' + message : ''}`;
  addChatMessage(msg, 'user');
  await sendMessage();
}

// ── PayTag ──
function closePaytagModal() {
  document.getElementById('paytag-modal').classList.remove('active');
}
async function claimPaytag() {
  const tag = document.getElementById('paytag-input').value.trim().toLowerCase();
  if (!tag || tag.length < 3) { showToast('PayTag must be at least 3 characters'); return; }
  if (!/^[a-zA-Z0-9_]+$/.test(tag)) { showToast('Letters, numbers, and underscores only'); return; }
  closePaytagModal();
  navigateTo('ai');
  const msg = `Claim my PayTag: $${tag}`;
  addChatMessage(msg, 'user');
  await sendMessage();
}
function copyPaytag() {
  const tag = document.getElementById('user-paytag').textContent;
  navigator.clipboard.writeText(tag).then(() => showToast('$PayTag copied!'));
}
function sharePaytag() {
  const tag = document.getElementById('user-paytag').textContent || document.getElementById('settings-paytag').textContent;
  const url = `https://upromptpay.com/pay/${tag}`;
  if (navigator.share) {
    navigator.share({ title: 'Pay me on PromptPay', text: `Send me money: ${tag}`, url });
  } else {
    navigator.clipboard.writeText(url).then(() => showToast('Link copied!'));
  }
}
function shareReferral() {
  const url = 'https://upromptpay.com/?ref=invite';
  if (navigator.share) {
    navigator.share({ title: 'Join PromptPay', text: 'Sign up and we both get $5!', url });
  } else {
    navigator.clipboard.writeText(url).then(() => showToast('Referral link copied!'));
  }
}

// ── Country Update ──
function updateUserCountry(country) {
  localStorage.setItem('promptpay_country', country);
  if (currentUser) currentUser.country = country;
  applyAirtimeGeoGate();
  // Save to server
  authFetch(API_BASE + '/api/user/settings', {
    method: 'PUT',
    body: JSON.stringify({ country })
  }).catch(() => {});
  showToast('Country updated' + (NON_AIRTIME_COUNTRIES.includes(country) ? ' - Airtime top-up not available in your region' : ''));
}

// Populate country selectors on settings load
const origLoadSettings = loadSettings;
loadSettings = async function() {
  await origLoadSettings();
  const country = getUserCountry();
  if (country) {
    const profileCountry = document.getElementById('profile-country');
    if (profileCountry) profileCountry.value = country;
    const settingsCountry = document.getElementById('settings-country');
    if (settingsCountry) settingsCountry.value = country;
  }
};

// Initialize airtime carrier on first load
document.addEventListener('DOMContentLoaded', function() {
  updateCarriers();
  autoDetectCountry();
});

// ══════════════════════════════════════════════════════════════
// CALLS / SOCIAL — International Calling, Chat, Video, AI
// ══════════════════════════════════════════════════════════════

let dialNumber = '';
let activeCallId = null;
let callStartTime = null;
let callTimerInterval = null;
let callMuted = false;
let callSpeaker = false;
let currentThreadUserId = null;
let currentThreadUserName = '';
let chatPollInterval = null;
let videoStream = null;
let videoPeerConnection = null;
let facingMode = 'user';

// ── Tab Switching ──
function switchCallsTab(tab) {
  document.querySelectorAll('.calls-tab').forEach(t => t.classList.remove('active'));
  document.querySelector(`.calls-tab[onclick*="${tab}"]`)?.classList.add('active');
  ['keypad','chats','history','thread','services'].forEach(t => {
    const el = document.getElementById('calls-tab-' + t);
    if (el) el.style.display = 'none';
  });
  const target = document.getElementById('calls-tab-' + tab);
  if (target) target.style.display = '';
  // Show AI features only on keypad
  const aiFeatures = document.getElementById('calls-ai-features');
  if (aiFeatures) aiFeatures.style.display = tab === 'keypad' ? '' : 'none';

  if (tab === 'chats') loadConversations();
  if (tab === 'history') loadCallHistory();
  if (tab === 'services') loadServicesData();
}

// ── Load page data ──
function loadCallsPage() {
  loadConversations();
  loadServicesData();
}

// ── Dialpad ──
function dialPress(digit) {
  if (dialNumber.length >= 20) return;
  dialNumber += digit;
  document.getElementById('dial-number').textContent = formatPhoneDisplay(dialNumber);
  // Auto-lookup rate when number looks international
  if (dialNumber.startsWith('+') && dialNumber.length >= 5) {
    lookupRate(dialNumber);
  }
}

function dialBackspace() {
  dialNumber = dialNumber.slice(0, -1);
  document.getElementById('dial-number').textContent = dialNumber ? formatPhoneDisplay(dialNumber) : '\u00A0';
  if (!dialNumber) document.getElementById('dial-rate').textContent = '';
}

function formatPhoneDisplay(num) {
  if (!num) return '\u00A0';
  // Format nicely: +234 801 234 5678
  if (num.startsWith('+') && num.length > 4) {
    const cc = getCountryCodeLen(num);
    const rest = num.slice(cc);
    return num.slice(0, cc) + ' ' + rest.replace(/(.{3})/g, '$1 ').trim();
  }
  return num;
}

function getCountryCodeLen(num) {
  // Simple country code length detection
  if (num.startsWith('+1')) return 2;
  if (num.startsWith('+44') || num.startsWith('+91') || num.startsWith('+27')) return 3;
  if (num.startsWith('+234') || num.startsWith('+233') || num.startsWith('+254') || num.startsWith('+255') || num.startsWith('+256')) return 4;
  return 4; // default
}

let rateTimeout = null;
async function lookupRate(number) {
  clearTimeout(rateTimeout);
  rateTimeout = setTimeout(async () => {
    try {
      const res = await authFetch(API_BASE + '/api/calls/rate?destination=' + encodeURIComponent(number));
      if (res.ok) {
        const data = await res.json();
        const costPerMin = parseFloat(data.rate || '0');
        const markup = 1.5; // 50% markup for retail
        const retailRate = (costPerMin * markup).toFixed(2);
        document.getElementById('dial-rate').innerHTML =
          `<span style="color:var(--accent2)">$${retailRate}/min</span> · ${data.country || 'International'}`;
      }
    } catch (e) {}
  }, 500);
}

// ── Start/End Call ──
async function startCall() {
  if (!dialNumber || dialNumber.length < 4) {
    showToast('Enter a phone number');
    return;
  }
  // Ensure it's E.164
  let number = dialNumber;
  if (!number.startsWith('+')) {
    number = '+' + number;
  }

  showCallScreen(number, 'Dialing...');

  try {
    const res = await authFetch(API_BASE + '/api/calls/dial', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ destination: number })
    });
    const data = await res.json();
    if (data.callControlId) {
      activeCallId = data.callControlId;
      updateCallStatus('Ringing...');
      // Simulate connection after 3s (in real Telnyx, webhooks handle this)
      setTimeout(() => {
        if (activeCallId) {
          updateCallStatus('Connected', true);
          startCallTimer();
        }
      }, 3000);
    } else {
      updateCallStatus('Failed: ' + (data.error || 'Could not connect'));
      setTimeout(hideCallScreen, 3000);
    }
  } catch (e) {
    updateCallStatus('Network error');
    setTimeout(hideCallScreen, 2000);
  }
}

async function endCall() {
  if (activeCallId) {
    try {
      await authFetch(API_BASE + '/api/calls/hangup', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ callControlId: activeCallId })
      });
    } catch (e) {}
  }
  stopCallTimer();
  activeCallId = null;
  hideCallScreen();
  showToast('Call ended');
  // Refresh history
  if (currentPage === 'calls') loadCallHistory();
}

function showCallScreen(number, status) {
  const screen = document.getElementById('call-screen');
  const initial = number.replace(/[^A-Za-z]/g, '')[0] || number[1] || '?';
  document.getElementById('call-screen-avatar').textContent = initial.toUpperCase();
  document.getElementById('call-screen-avatar').classList.add('ringing');
  document.getElementById('call-screen-name').textContent = number;
  document.getElementById('call-screen-status').textContent = status;
  document.getElementById('call-screen-status').className = 'call-status';
  document.getElementById('call-screen-timer').style.display = 'none';
  document.getElementById('call-cost-display').textContent = '';
  screen.classList.add('active');
}

function hideCallScreen() {
  document.getElementById('call-screen').classList.remove('active');
  document.getElementById('call-screen-avatar').classList.remove('ringing');
}

function updateCallStatus(text, connected) {
  const el = document.getElementById('call-screen-status');
  el.textContent = text;
  if (connected) {
    el.className = 'call-status connected';
    document.getElementById('call-screen-avatar').classList.remove('ringing');
  }
}

function startCallTimer() {
  callStartTime = Date.now();
  document.getElementById('call-screen-timer').style.display = '';
  callTimerInterval = setInterval(() => {
    const elapsed = Math.floor((Date.now() - callStartTime) / 1000);
    const min = String(Math.floor(elapsed / 60)).padStart(2, '0');
    const sec = String(elapsed % 60).padStart(2, '0');
    document.getElementById('call-screen-timer').textContent = `${min}:${sec}`;
    // Show estimated cost
    const costPerMin = 0.15; // rough estimate
    const cost = ((elapsed / 60) * costPerMin).toFixed(2);
    document.getElementById('call-cost-display').textContent = `Est. cost: $${cost}`;
  }, 1000);
}

function stopCallTimer() {
  if (callTimerInterval) {
    clearInterval(callTimerInterval);
    callTimerInterval = null;
  }
  callStartTime = null;
}

function toggleCallMute() {
  callMuted = !callMuted;
  document.getElementById('call-mute-btn').classList.toggle('active', callMuted);
  showToast(callMuted ? 'Muted' : 'Unmuted');
}

function toggleCallSpeaker() {
  callSpeaker = !callSpeaker;
  document.getElementById('call-speaker-btn').classList.toggle('active', callSpeaker);
  showToast(callSpeaker ? 'Speaker on' : 'Speaker off');
}

function toggleCallKeypad() {
  // Could show in-call DTMF keypad — for now just toggle
  document.getElementById('call-keypad-btn').classList.toggle('active');
}

// ── Call History ──
async function loadCallHistory() {
  const container = document.getElementById('call-history-list');
  try {
    const res = await authFetch(API_BASE + '/api/calls/history');
    if (!res.ok) throw new Error();
    const data = await res.json();
    const calls = data.calls || [];
    if (calls.length === 0) {
      container.innerHTML = `
        <div style="text-align:center;padding:40px 0;color:var(--text3)">
          <svg width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="var(--text3)" stroke-width="1.5" style="margin-bottom:12px"><path d="M22 16.92v3a2 2 0 0 1-2.18 2 19.79 19.79 0 0 1-8.63-3.07 19.5 19.5 0 0 1-6-6 19.79 19.79 0 0 1-3.07-8.67A2 2 0 0 1 4.11 2h3a2 2 0 0 1 2 1.72"/></svg>
          <div style="font-size:14px;font-weight:600;margin-bottom:4px">No call history</div>
          <div style="font-size:12px">Make your first international call!</div>
        </div>`;
      return;
    }
    container.innerHTML = calls.map(c => {
      const initial = (c.destination || '?')[1] || '?';
      const dirClass = c.direction === 'outbound' ? 'outgoing' : (c.status === 'missed' ? 'missed' : 'incoming');
      const dirLabel = c.direction === 'outbound' ? 'Outgoing' : (c.status === 'missed' ? 'Missed' : 'Incoming');
      const duration = c.duration_seconds ? `${Math.floor(c.duration_seconds / 60)}:${String(c.duration_seconds % 60).padStart(2,'0')}` : '';
      const cost = c.charge_amount ? `$${parseFloat(c.charge_amount).toFixed(2)}` : '';
      const time = new Date(c.created_at).toLocaleString([], {month:'short',day:'numeric',hour:'numeric',minute:'2-digit'});
      return `
        <div class="call-history-item" onclick="dialNumber='${c.destination}';document.getElementById('dial-number').textContent='${c.destination}';switchCallsTab('keypad')">
          <div class="call-hist-avatar">
            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M22 16.92v3a2 2 0 0 1-2.18 2 19.79 19.79 0 0 1-8.63-3.07 19.5 19.5 0 0 1-6-6 19.79 19.79 0 0 1-3.07-8.67A2 2 0 0 1 4.11 2h3"/></svg>
          </div>
          <div class="call-hist-info">
            <div class="call-hist-name">${c.destination || 'Unknown'}</div>
            <div class="call-hist-detail">
              <span class="${dirClass}">${dirLabel}</span>
              ${duration ? ' · ' + duration : ''} ${cost ? ' · ' + cost : ''}
            </div>
          </div>
          <div class="call-hist-time">${time}</div>
        </div>`;
    }).join('');
  } catch (e) {
    container.innerHTML = '<div style="text-align:center;padding:24px;color:var(--text3);font-size:13px">Could not load call history</div>';
  }
}

// ── Chat / Messaging ──
async function loadConversations() {
  const container = document.getElementById('chat-conversations-list');
  if (!container) return;
  try {
    const res = await authFetch(API_BASE + '/api/chat/conversations');
    if (!res.ok) throw new Error();
    const data = await res.json();
    const convos = data.conversations || [];
    if (convos.length === 0) {
      container.innerHTML = `
        <div style="text-align:center;padding:40px 0;color:var(--text3)">
          <svg width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="var(--text3)" stroke-width="1.5" style="margin-bottom:12px"><path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"/></svg>
          <div style="font-size:14px;font-weight:600;margin-bottom:4px">No conversations yet</div>
          <div style="font-size:12px">Search for users to start chatting <span class="free-badge">Free</span></div>
        </div>`;
      return;
    }
    container.innerHTML = convos.map(c => {
      const initial = (c.display_name || c.user_id || '?')[0].toUpperCase();
      const name = c.display_name || c.email || 'User';
      const preview = c.last_message || 'Tap to chat';
      const time = c.last_message_at ? timeAgo(new Date(c.last_message_at)) : '';
      const unread = c.unread_count || 0;
      return `
        <div class="chat-list-item" onclick="openMessageThread('${c.user_id}','${name.replace(/'/g,"\\'")}')">
          <div class="chat-list-avatar">${initial}</div>
          <div class="chat-list-body">
            <div class="chat-list-name">${name}</div>
            <div class="chat-list-preview">${preview}</div>
          </div>
          <div class="chat-list-meta">
            <div class="chat-list-time">${time}</div>
            ${unread > 0 ? `<div class="chat-unread-badge">${unread}</div>` : ''}
          </div>
        </div>`;
    }).join('');
  } catch (e) {
    // silent fail
  }
}

function timeAgo(date) {
  const seconds = Math.floor((Date.now() - date.getTime()) / 1000);
  if (seconds < 60) return 'now';
  if (seconds < 3600) return Math.floor(seconds / 60) + 'm';
  if (seconds < 86400) return Math.floor(seconds / 3600) + 'h';
  if (seconds < 604800) return Math.floor(seconds / 86400) + 'd';
  return date.toLocaleDateString([], { month: 'short', day: 'numeric' });
}

async function searchChats(query) {
  const container = document.getElementById('chat-search-results');
  const listContainer = document.getElementById('chat-conversations-list');
  if (!query || query.length < 2) {
    container.style.display = 'none';
    listContainer.style.display = '';
    return;
  }
  container.style.display = '';
  listContainer.style.display = 'none';

  try {
    const res = await authFetch(API_BASE + '/api/users/search?q=' + encodeURIComponent(query));
    if (!res.ok) throw new Error();
    const data = await res.json();
    const users = data.users || [];
    if (users.length === 0) {
      container.innerHTML = '<div style="padding:20px;text-align:center;color:var(--text3);font-size:13px">No users found</div>';
      return;
    }
    container.innerHTML = users.map(u => {
      const initial = (u.display_name || u.email || '?')[0].toUpperCase();
      const name = u.display_name || u.email || 'User';
      return `
        <div class="contact-item" onclick="openMessageThread('${u.id}','${name.replace(/'/g,"\\'")}')">
          <div class="contact-avatar">${initial}</div>
          <div>
            <div class="contact-name">${name}</div>
            <div class="contact-phone">${u.email || ''}</div>
          </div>
          <div class="contact-actions">
            <button class="contact-action-btn msg-btn" title="Message">
              <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"/></svg>
            </button>
          </div>
        </div>`;
    }).join('');
  } catch (e) {
    container.innerHTML = '<div style="padding:20px;text-align:center;color:var(--text3);font-size:13px">Search failed</div>';
  }
}

async function openMessageThread(userId, userName) {
  currentThreadUserId = userId;
  currentThreadUserName = userName || 'User';
  // Hide search results, show thread
  document.getElementById('chat-search-results').style.display = 'none';
  document.getElementById('chat-conversations-list').style.display = 'none';
  document.getElementById('calls-tab-chats').style.display = 'none';
  document.getElementById('calls-tab-thread').style.display = '';
  document.getElementById('thread-name').textContent = currentThreadUserName;
  document.getElementById('chat-search-input').value = '';

  await loadMessages(userId);
  // Poll for new messages
  if (chatPollInterval) clearInterval(chatPollInterval);
  chatPollInterval = setInterval(() => loadMessages(userId), 5000);
  // Focus input
  setTimeout(() => document.getElementById('msg-input')?.focus(), 100);
}

function closeMessageThread() {
  if (chatPollInterval) { clearInterval(chatPollInterval); chatPollInterval = null; }
  currentThreadUserId = null;
  document.getElementById('calls-tab-thread').style.display = 'none';
  document.getElementById('calls-tab-chats').style.display = '';
  document.getElementById('chat-conversations-list').style.display = '';
  loadConversations();
}

async function loadMessages(userId) {
  const container = document.getElementById('msg-bubbles');
  try {
    const res = await authFetch(API_BASE + '/api/chat/conversation/' + userId);
    if (!res.ok) throw new Error();
    const data = await res.json();
    const messages = data.messages || [];
    const myId = currentUser?.id;
    if (messages.length === 0) {
      container.innerHTML = `
        <div style="text-align:center;padding:60px 20px;color:var(--text3)">
          <div style="font-size:32px;margin-bottom:12px">
            <svg width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="var(--text3)" stroke-width="1.5"><path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"/></svg>
          </div>
          <div style="font-size:14px;font-weight:600;margin-bottom:4px">Start a conversation</div>
          <div style="font-size:12px">Say hello! Messaging is <span class="free-badge">Free</span></div>
        </div>`;
      return;
    }
    let html = '';
    let lastDate = '';
    messages.forEach(m => {
      const msgDate = new Date(m.created_at).toLocaleDateString();
      if (msgDate !== lastDate) {
        html += `<div style="text-align:center;padding:12px 0 8px;font-size:11px;color:var(--text3)">${msgDate}</div>`;
        lastDate = msgDate;
      }
      const isMine = m.sender_id === myId;
      const time = new Date(m.created_at).toLocaleTimeString([], { hour: 'numeric', minute: '2-digit' });
      html += `<div class="msg-bubble ${isMine ? 'sent' : 'received'}">${escapeHtml(m.message)}</div>`;
      html += `<div class="msg-time ${isMine ? 'sent' : ''}">${time}</div>`;
    });
    container.innerHTML = html;
    container.scrollTop = container.scrollHeight;
  } catch (e) {}
}

function escapeHtml(text) {
  const div = document.createElement('div');
  div.textContent = text;
  return div.innerHTML;
}

async function sendChatMessage() {
  const input = document.getElementById('msg-input');
  const message = input.value.trim();
  if (!message || !currentThreadUserId) return;
  input.value = '';

  // Optimistic append
  const bubbles = document.getElementById('msg-bubbles');
  const time = new Date().toLocaleTimeString([], { hour: 'numeric', minute: '2-digit' });
  bubbles.innerHTML += `<div class="msg-bubble sent">${escapeHtml(message)}</div><div class="msg-time sent">${time}</div>`;
  bubbles.scrollTop = bubbles.scrollHeight;

  try {
    await authFetch(API_BASE + '/api/chat/send', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ recipientId: currentThreadUserId, message })
    });
  } catch (e) {
    showToast('Failed to send');
  }
}

function callThreadUser() {
  // Placeholder — would need the user's phone number
  showToast('Voice calling requires a phone number');
}

function videoCallThreadUser() {
  startVideoCall();
}

// ── Video Calling (WebRTC P2P — Free) ──
async function startVideoCall() {
  const screen = document.getElementById('video-call-screen');
  screen.classList.add('active');

  try {
    videoStream = await navigator.mediaDevices.getUserMedia({
      video: { facingMode: facingMode },
      audio: true
    });
    const localVideo = document.getElementById('local-video');
    localVideo.srcObject = videoStream;
    document.getElementById('video-call-status-text').textContent = 'Camera ready. Share link to connect.';
    showToast('Video call ready — share your link to connect');
  } catch (e) {
    document.getElementById('video-call-status-text').textContent = 'Camera access denied';
    showToast('Camera access required for video calls');
  }
}

function endVideoCall() {
  if (videoStream) {
    videoStream.getTracks().forEach(t => t.stop());
    videoStream = null;
  }
  if (videoPeerConnection) {
    videoPeerConnection.close();
    videoPeerConnection = null;
  }
  document.getElementById('video-call-screen').classList.remove('active');
  document.getElementById('local-video').srcObject = null;
  document.getElementById('remote-video').srcObject = null;
  showToast('Video call ended');
}

function toggleVideoMute() {
  if (videoStream) {
    const audioTrack = videoStream.getAudioTracks()[0];
    if (audioTrack) {
      audioTrack.enabled = !audioTrack.enabled;
      document.getElementById('video-mute-btn').classList.toggle('active', !audioTrack.enabled);
    }
  }
}

function toggleVideoCamera() {
  if (videoStream) {
    const videoTrack = videoStream.getVideoTracks()[0];
    if (videoTrack) {
      videoTrack.enabled = !videoTrack.enabled;
      document.getElementById('video-cam-btn').classList.toggle('active', !videoTrack.enabled);
    }
  }
}

async function flipVideoCamera() {
  facingMode = facingMode === 'user' ? 'environment' : 'user';
  if (videoStream) {
    videoStream.getTracks().forEach(t => t.stop());
    try {
      videoStream = await navigator.mediaDevices.getUserMedia({
        video: { facingMode: facingMode },
        audio: true
      });
      document.getElementById('local-video').srcObject = videoStream;
    } catch (e) {
      showToast('Could not switch camera');
    }
  }
}

// ── AI Smart Dial (Free AI Feature) ──
function openSmartDial() {
  navigateTo('ai');
  setTimeout(() => {
    const input = document.getElementById('chat-input');
    if (input) {
      input.value = 'Help me make an international call to ';
      input.focus();
    }
  }, 200);
}

// ══════════════════════════════════════════════════════════════
// TELNYX SERVICES — Virtual Numbers, SIMs, SMS, AI
// ══════════════════════════════════════════════════════════════

let currentServicePanel = '';
let telnyxAiSessionId = null;

// ── Load services data ──
async function loadServicesData() {
  // Balance
  try {
    const res = await authFetch(API_BASE + '/api/telnyx/balance');
    if (res.ok) {
      const data = await res.json();
      document.getElementById('telnyx-balance-display').textContent = '$' + parseFloat(data.balance || '0').toFixed(2);
    }
  } catch (e) {}

  // Numbers count
  try {
    const res = await authFetch(API_BASE + '/api/numbers/mine');
    if (res.ok) {
      const data = await res.json();
      const count = (data.numbers || []).length;
      document.getElementById('my-numbers-count').textContent = count + ' active';
    }
  } catch (e) {}
}

// ── Show a service sub-panel ──
function showServicePanel(panel) {
  currentServicePanel = panel;
  const container = document.getElementById('service-panel');

  if (panel === 'numbers') {
    container.innerHTML = `
      <div style="margin-bottom:16px">
        <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:12px">
          <div style="font-size:16px;font-weight:700;color:var(--text)">Virtual Numbers</div>
          <button onclick="showServicePanel('')" style="background:none;border:none;color:var(--text3);cursor:pointer;font-size:20px;font-family:inherit">&times;</button>
        </div>
        <div style="font-size:12px;color:var(--text3);margin-bottom:16px">Buy a phone number in any country for calling, SMS, and verification.</div>

        <!-- My Numbers -->
        <div style="font-size:13px;font-weight:600;color:var(--text2);margin-bottom:8px">My Numbers</div>
        <div id="my-numbers-list" style="margin-bottom:16px">
          <div style="text-align:center;padding:16px;color:var(--text3);font-size:12px">Loading...</div>
        </div>

        <!-- Search Numbers -->
        <div style="font-size:13px;font-weight:600;color:var(--text2);margin-bottom:8px">Search Available Numbers</div>
        <div style="display:flex;gap:8px;margin-bottom:12px">
          <select id="number-search-country" style="flex:1;padding:10px;border-radius:10px;background:var(--surface);border:1px solid var(--glass-border);color:var(--text);font-family:inherit;font-size:13px">
            <option value="US">United States (+1)</option>
            <option value="GB">United Kingdom (+44)</option>
            <option value="CA">Canada (+1)</option>
            <option value="NG">Nigeria (+234)</option>
            <option value="GH">Ghana (+233)</option>
            <option value="KE">Kenya (+254)</option>
            <option value="ZA">South Africa (+27)</option>
            <option value="DE">Germany (+49)</option>
            <option value="FR">France (+33)</option>
            <option value="AU">Australia (+61)</option>
          </select>
          <button onclick="searchAvailableNumbers()" style="padding:10px 20px;border-radius:10px;background:var(--accent);color:#fff;border:none;cursor:pointer;font-weight:600;font-family:inherit;font-size:13px">Search</button>
        </div>
        <div id="number-search-results"></div>
      </div>`;
    loadMyNumbers();

  } else if (panel === 'sims') {
    container.innerHTML = `
      <div style="margin-bottom:16px">
        <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:12px">
          <div style="font-size:16px;font-weight:700;color:var(--text)">eSIM / SIM Cards</div>
          <button onclick="showServicePanel('')" style="background:none;border:none;color:var(--text3);cursor:pointer;font-size:20px;font-family:inherit">&times;</button>
        </div>

        <!-- Coming Soon Banner -->
        <div style="text-align:center;padding:40px 20px;background:linear-gradient(135deg,rgba(245,158,11,0.06),rgba(217,119,6,0.04));border:1px dashed rgba(245,158,11,0.3);border-radius:16px;margin-bottom:16px">
          <div style="font-size:48px;margin-bottom:12px">&#128225;</div>
          <div style="font-size:18px;font-weight:700;color:var(--text);margin-bottom:8px">Coming Soon</div>
          <div style="font-size:13px;color:var(--text3);max-width:280px;margin:0 auto;line-height:1.6">eSIM and physical SIM card ordering is being activated. You'll be able to order instant eSIMs for IoT, travel, and secondary lines.</div>
          <div style="margin-top:16px;padding:8px 16px;display:inline-block;border-radius:20px;background:rgba(245,158,11,0.1);color:#f59e0b;font-size:12px;font-weight:600">We'll notify you when it's ready</div>
        </div>

        <!-- My Orders (if any from before) -->
        <div style="font-size:13px;font-weight:600;color:var(--text2);margin-bottom:8px">My Orders</div>
        <div id="sim-orders-list">
          <div style="text-align:center;padding:16px;color:var(--text3);font-size:12px">Loading...</div>
        </div>
      </div>`;
    loadSimOrders();

  } else if (panel === 'sms') {
    container.innerHTML = `
      <div style="margin-bottom:16px">
        <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:12px">
          <div style="font-size:16px;font-weight:700;color:var(--text)">SMS / MMS</div>
          <button onclick="showServicePanel('')" style="background:none;border:none;color:var(--text3);cursor:pointer;font-size:20px;font-family:inherit">&times;</button>
        </div>
        <div style="font-size:12px;color:var(--text3);margin-bottom:16px">Send SMS/MMS globally using your virtual numbers. $0.05 per message.</div>

        <!-- Compose SMS -->
        <div style="background:var(--surface);border:1px solid var(--glass-border);border-radius:14px;padding:16px;margin-bottom:16px">
          <input type="text" id="sms-to" placeholder="To: +1234567890 (E.164)" style="width:100%;padding:10px 14px;border-radius:10px;background:rgba(255,255,255,0.04);border:1px solid var(--glass-border);color:var(--text);font-family:inherit;font-size:13px;margin-bottom:8px;box-sizing:border-box">
          <textarea id="sms-body" placeholder="Type your message..." rows="3" style="width:100%;padding:10px 14px;border-radius:10px;background:rgba(255,255,255,0.04);border:1px solid var(--glass-border);color:var(--text);font-family:inherit;font-size:13px;resize:none;margin-bottom:8px;box-sizing:border-box"></textarea>
          <div style="display:flex;justify-content:space-between;align-items:center">
            <div style="font-size:11px;color:var(--text3)" id="sms-char-count">0/160</div>
            <button onclick="sendSmsMessage()" style="padding:10px 24px;border-radius:10px;background:linear-gradient(135deg,#10b981,#059669);color:#fff;border:none;cursor:pointer;font-weight:700;font-size:13px;font-family:inherit">Send SMS</button>
          </div>
        </div>

        <!-- SMS History -->
        <div style="font-size:13px;font-weight:600;color:var(--text2);margin-bottom:8px">Recent Messages</div>
        <div id="sms-history-list">
          <div style="text-align:center;padding:16px;color:var(--text3);font-size:12px">Loading...</div>
        </div>
      </div>`;
    loadSmsHistory();
    // Character counter
    document.getElementById('sms-body')?.addEventListener('input', function() {
      document.getElementById('sms-char-count').textContent = this.value.length + '/160';
    });

  } else if (panel === 'telnyxai') {
    container.innerHTML = `
      <div style="margin-bottom:16px">
        <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:12px">
          <div style="font-size:16px;font-weight:700;color:var(--text)">AI Assistant <span class="free-badge">Free</span></div>
          <button onclick="showServicePanel('')" style="background:none;border:none;color:var(--text3);cursor:pointer;font-size:20px;font-family:inherit">&times;</button>
        </div>
        <div style="font-size:12px;color:var(--text3);margin-bottom:12px">Powered by Llama 3.1 70B via Telnyx. Ask anything!</div>

        <!-- Quick Actions -->
        <div style="display:flex;gap:8px;flex-wrap:wrap;margin-bottom:16px">
          <button onclick="aiQuickAction('Translate this to French: Hello, how are you?')" style="padding:6px 12px;border-radius:20px;background:rgba(124,58,237,0.08);border:1px solid rgba(124,58,237,0.15);color:var(--accent2);font-size:11px;cursor:pointer;font-family:inherit">Translate</button>
          <button onclick="aiQuickAction('Summarize: international calling rates in Africa')" style="padding:6px 12px;border-radius:20px;background:rgba(59,130,246,0.08);border:1px solid rgba(59,130,246,0.15);color:#3b82f6;font-size:11px;cursor:pointer;font-family:inherit">Summarize</button>
          <button onclick="aiQuickAction('What is the cheapest way to call Nigeria from the US?')" style="padding:6px 12px;border-radius:20px;background:rgba(16,185,129,0.08);border:1px solid rgba(16,185,129,0.15);color:#10b981;font-size:11px;cursor:pointer;font-family:inherit">Call Advice</button>
          <button onclick="aiQuickAction('Write a business SMS template for airtime POS agents')" style="padding:6px 12px;border-radius:20px;background:rgba(245,158,11,0.08);border:1px solid rgba(245,158,11,0.15);color:#f59e0b;font-size:11px;cursor:pointer;font-family:inherit">SMS Template</button>
        </div>

        <!-- Chat Area -->
        <div id="telnyx-ai-messages" style="max-height:300px;overflow-y:auto;margin-bottom:12px;padding:4px 0"></div>

        <!-- Input -->
        <div style="display:flex;gap:8px">
          <input type="text" id="telnyx-ai-input" placeholder="Ask the AI anything..." onkeydown="if(event.key==='Enter')sendTelnyxAi()" style="flex:1;padding:12px 16px;border-radius:24px;background:var(--surface);border:1px solid var(--glass-border);color:var(--text);font-family:inherit;font-size:13px;outline:none">
          <button onclick="sendTelnyxAi()" style="width:44px;height:44px;border-radius:50%;background:var(--gradient2);border:none;cursor:pointer;display:flex;align-items:center;justify-content:center;flex-shrink:0">
            <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="#fff" stroke-width="2"><line x1="22" y1="2" x2="11" y2="13"/><polygon points="22 2 15 22 11 13 2 9 22 2"/></svg>
          </button>
        </div>
      </div>`;

  } else {
    container.innerHTML = '';
  }
}

// ── Virtual Numbers ──
async function loadMyNumbers() {
  const container = document.getElementById('my-numbers-list');
  if (!container) return;
  try {
    const res = await authFetch(API_BASE + '/api/numbers/mine');
    if (!res.ok) throw new Error();
    const data = await res.json();
    const numbers = data.numbers || [];
    if (numbers.length === 0) {
      container.innerHTML = '<div style="text-align:center;padding:16px;color:var(--text3);font-size:12px">No numbers yet. Search and buy below.</div>';
      return;
    }
    container.innerHTML = numbers.map(n => `
      <div style="display:flex;align-items:center;justify-content:space-between;padding:10px 14px;background:rgba(255,255,255,0.03);border:1px solid var(--glass-border);border-radius:10px;margin-bottom:6px">
        <div>
          <div style="font-size:14px;font-weight:600;color:var(--text);font-family:'JetBrains Mono',monospace">${n.phone_number}</div>
          <div style="font-size:11px;color:var(--text3)">${n.country_code} · ${n.number_type} · ${n.status}</div>
        </div>
        <div style="display:flex;gap:6px">
          <button onclick="dialNumber='${n.phone_number}';switchCallsTab('keypad')" style="padding:6px 10px;border-radius:8px;background:rgba(16,185,129,0.1);border:none;color:#10b981;font-size:11px;cursor:pointer;font-family:inherit">Use</button>
        </div>
      </div>
    `).join('');
  } catch (e) {
    container.innerHTML = '<div style="text-align:center;padding:16px;color:var(--text3);font-size:12px">Failed to load</div>';
  }
}

async function searchAvailableNumbers() {
  const country = document.getElementById('number-search-country').value;
  const container = document.getElementById('number-search-results');
  container.innerHTML = '<div style="text-align:center;padding:16px;color:var(--text3);font-size:12px">Searching...</div>';

  try {
    const res = await authFetch(API_BASE + '/api/numbers/search?country=' + country);
    if (!res.ok) throw new Error();
    const data = await res.json();
    const numbers = data.numbers || [];
    if (numbers.length === 0) {
      container.innerHTML = '<div style="text-align:center;padding:16px;color:var(--text3);font-size:12px">No numbers available for this country</div>';
      return;
    }
    container.innerHTML = numbers.map(n => {
      const phone = n.phone_number || n.phoneNumber || '';
      return `
        <div style="display:flex;align-items:center;justify-content:space-between;padding:10px 14px;background:rgba(255,255,255,0.03);border:1px solid var(--glass-border);border-radius:10px;margin-bottom:6px">
          <div>
            <div style="font-size:14px;font-weight:600;color:var(--text);font-family:'JetBrains Mono',monospace">${phone}</div>
            <div style="font-size:11px;color:var(--text3)">${n.region || country} · <span style="color:#10b981;font-weight:600">$2.00</span> from wallet</div>
          </div>
          <button onclick="buyNumber('${phone}','${country}')" style="padding:6px 14px;border-radius:8px;background:var(--accent);color:#fff;border:none;cursor:pointer;font-size:12px;font-weight:600;font-family:inherit">Buy $2</button>
        </div>`;
    }).join('');
  } catch (e) {
    container.innerHTML = '<div style="text-align:center;padding:16px;color:var(--text3);font-size:12px">Search failed. Check Telnyx balance.</div>';
  }
}

async function buyNumber(phoneNumber, countryCode) {
  if (!confirm('Buy ' + phoneNumber + ' for $2.00?\nThis will be charged from your PromptPay wallet balance.')) return;
  const btn = event?.target;
  if (btn) { btn.disabled = true; btn.textContent = 'Buying...'; }
  try {
    const res = await authFetch(API_BASE + '/api/numbers/buy', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ phoneNumber, countryCode })
    });
    const data = await res.json();
    if (data.success) {
      showToast('Number purchased: ' + phoneNumber, 'success');
      loadMyNumbers();
      loadServicesData();
    } else {
      showToast(data.error || 'Purchase failed', 'error');
    }
  } catch (e) {
    showToast('Network error — please try again', 'error');
  } finally {
    if (btn) { btn.disabled = false; btn.textContent = 'Buy'; }
  }
}

// ── SIM Cards ──
async function loadSimOrders() {
  const container = document.getElementById('sim-orders-list');
  if (!container) return;
  try {
    const res = await authFetch(API_BASE + '/api/sims/orders');
    if (!res.ok) throw new Error();
    const data = await res.json();
    const orders = data.orders || [];
    if (orders.length === 0) {
      container.innerHTML = '<div style="text-align:center;padding:16px;color:var(--text3);font-size:12px">No orders yet</div>';
      return;
    }
    container.innerHTML = orders.map(o => `
      <div style="display:flex;align-items:center;justify-content:space-between;padding:10px 14px;background:rgba(255,255,255,0.03);border:1px solid var(--glass-border);border-radius:10px;margin-bottom:6px">
        <div>
          <div style="font-size:13px;font-weight:600;color:var(--text)">${o.sim_type === 'esim' ? 'eSIM' : 'Physical SIM'} x${o.quantity}</div>
          <div style="font-size:11px;color:var(--text3)">${o.status} · ${new Date(o.created_at).toLocaleDateString()}</div>
        </div>
        <div style="padding:4px 10px;border-radius:8px;background:${o.status === 'pending' ? 'rgba(245,158,11,0.12)' : 'rgba(16,185,129,0.12)'};color:${o.status === 'pending' ? '#f59e0b' : '#10b981'};font-size:11px;font-weight:600">${o.status}</div>
      </div>
    `).join('');
  } catch (e) {
    container.innerHTML = '<div style="text-align:center;padding:16px;color:var(--text3);font-size:12px">Failed to load</div>';
  }
}

async function orderSim() {
  const simType = document.getElementById('sim-order-type').value;
  const quantity = document.getElementById('sim-order-qty').value;
  if (!confirm('Order ' + quantity + ' ' + (simType === 'esim' ? 'eSIM(s)' : 'physical SIM(s)') + '?')) return;

  try {
    const res = await authFetch(API_BASE + '/api/sims/order', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ simType, quantity })
    });
    const data = await res.json();
    if (data.success) {
      showToast('SIM order placed!');
      loadSimOrders();
    } else {
      showToast(data.error || 'Order failed');
    }
  } catch (e) {
    showToast('Network error');
  }
}

// ── SMS ──
async function loadSmsHistory() {
  const container = document.getElementById('sms-history-list');
  if (!container) return;
  try {
    const res = await authFetch(API_BASE + '/api/sms/history');
    if (!res.ok) throw new Error();
    const data = await res.json();
    const messages = data.messages || [];
    if (messages.length === 0) {
      container.innerHTML = '<div style="text-align:center;padding:16px;color:var(--text3);font-size:12px">No messages yet. Send your first SMS above.</div>';
      return;
    }
    container.innerHTML = messages.map(m => `
      <div style="padding:10px 14px;background:rgba(255,255,255,0.03);border:1px solid var(--glass-border);border-radius:10px;margin-bottom:6px">
        <div style="display:flex;justify-content:space-between;margin-bottom:4px">
          <div style="font-size:12px;font-weight:600;color:var(--text)">${m.direction === 'outbound' ? 'To: ' + m.to_number : 'From: ' + m.from_number}</div>
          <div style="font-size:10px;color:var(--text3)">${new Date(m.created_at).toLocaleString([], {month:'short',day:'numeric',hour:'numeric',minute:'2-digit'})}</div>
        </div>
        <div style="font-size:13px;color:var(--text2);white-space:nowrap;overflow:hidden;text-overflow:ellipsis">${escapeHtml(m.body)}</div>
      </div>
    `).join('');
  } catch (e) {
    container.innerHTML = '<div style="text-align:center;padding:16px;color:var(--text3);font-size:12px">Failed to load</div>';
  }
}

async function sendSmsMessage() {
  const to = document.getElementById('sms-to').value.trim();
  const text = document.getElementById('sms-body').value.trim();
  if (!to || !text) { showToast('Enter recipient and message', 'error'); return; }
  if (!to.startsWith('+')) { showToast('Number must start with + (E.164 format, e.g. +1234567890)', 'error'); return; }
  if (!confirm('Send SMS to ' + to + '?\nCost: $0.05 from your wallet balance.')) return;

  const sendBtn = event?.target;
  if (sendBtn) { sendBtn.disabled = true; sendBtn.textContent = 'Sending...'; }
  try {
    const res = await authFetch(API_BASE + '/api/sms/send', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ to, text })
    });
    const data = await res.json();
    if (data.success) {
      showToast('SMS sent to ' + to, 'success');
      document.getElementById('sms-to').value = '';
      document.getElementById('sms-body').value = '';
      document.getElementById('sms-char-count').textContent = '0/160';
      loadSmsHistory();
    } else {
      showToast(data.error || 'Send failed', 'error');
    }
  } catch (e) {
    showToast('Network error — please try again', 'error');
  } finally {
    if (sendBtn) { sendBtn.disabled = false; sendBtn.textContent = 'Send SMS'; }
  }
}

// ── Telnyx AI Chat ──
function aiQuickAction(prompt) {
  const input = document.getElementById('telnyx-ai-input');
  if (input) { input.value = prompt; sendTelnyxAi(); }
}

async function sendTelnyxAi() {
  const input = document.getElementById('telnyx-ai-input');
  const message = input.value.trim();
  if (!message) return;
  input.value = '';

  const container = document.getElementById('telnyx-ai-messages');
  // User bubble
  container.innerHTML += `<div style="margin-left:auto;max-width:80%;padding:10px 14px;border-radius:18px 18px 4px 18px;background:var(--accent);color:#fff;font-size:13px;margin-bottom:8px;word-break:break-word">${escapeHtml(message)}</div>`;
  // Thinking indicator
  container.innerHTML += `<div id="ai-thinking" style="max-width:80%;padding:10px 14px;border-radius:18px 18px 18px 4px;background:rgba(255,255,255,0.08);color:var(--text3);font-size:13px;margin-bottom:8px">Thinking...</div>`;
  container.scrollTop = container.scrollHeight;

  try {
    const res = await authFetch(API_BASE + '/api/telnyx-ai/chat', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ message, sessionId: telnyxAiSessionId })
    });
    const data = await res.json();
    // Remove thinking indicator
    const thinking = document.getElementById('ai-thinking');
    if (thinking) thinking.remove();

    if (data.reply) {
      telnyxAiSessionId = data.sessionId;
      container.innerHTML += `<div style="max-width:80%;padding:10px 14px;border-radius:18px 18px 18px 4px;background:rgba(255,255,255,0.08);color:var(--text);font-size:13px;margin-bottom:8px;line-height:1.5;word-break:break-word">${escapeHtml(data.reply)}</div>`;
    } else {
      container.innerHTML += `<div style="max-width:80%;padding:10px 14px;border-radius:18px;background:rgba(239,68,68,0.1);color:#ef4444;font-size:12px;margin-bottom:8px">${data.error || 'AI error'}</div>`;
    }
    container.scrollTop = container.scrollHeight;
  } catch (e) {
    const thinking = document.getElementById('ai-thinking');
    if (thinking) thinking.remove();
    container.innerHTML += `<div style="padding:10px;color:#ef4444;font-size:12px">Network error</div>`;
  }
}

// ════════════════════════════════════════════════════════════
// DEVELOPER PORTAL
// ════════════════════════════════════════════════════════════

let devKeysCache = [];
let devSavedKeys = {}; // { keyId: rawKey } — stored locally for playground
try { devSavedKeys = JSON.parse(localStorage.getItem('dev_api_keys') || '{}'); } catch(e) {}

async function loadDeveloperPortal() {
  await loadDevKeys();
  await loadDevAnalytics();
  await loadDevLogs();
  await loadDevWebhooks();
  loadDevDocs();
}

async function loadDevKeys() {
  try {
    const res = await authFetch(API_BASE + '/api/developer/keys');
    const data = await res.json();
    devKeysCache = data.keys || [];
    const el = document.getElementById('dev-keys-list');
    const playgroundSelect = document.getElementById('playground-key');

    if (devKeysCache.length === 0) {
      el.innerHTML = '<div style="text-align:center;padding:20px;color:var(--text3);font-size:13px">No API keys yet. Create one to get started.</div>';
      playgroundSelect.innerHTML = '<option value="">No keys — create one first</option>';
      return;
    }

    // Populate playground key selector
    playgroundSelect.innerHTML = '<option value="">Select an API key...</option>' +
      Object.entries(devSavedKeys).map(([id, key]) => {
        const k = devKeysCache.find(x => x.id === id);
        return k ? `<option value="${key}">${k.name} (${k.api_key_prefix})</option>` : '';
      }).join('');

    el.innerHTML = devKeysCache.map(k => `
      <div style="display:flex;justify-content:space-between;align-items:center;padding:12px;background:var(--surface);border-radius:10px;margin-bottom:8px;border:1px solid var(--glass-border)">
        <div>
          <div style="font-weight:600;font-size:13px;margin-bottom:4px">${escapeHtml(k.name)}</div>
          <div style="font-family:monospace;font-size:11px;color:var(--text3)">${k.api_key_prefix}</div>
          <div style="display:flex;gap:8px;margin-top:4px;font-size:11px;color:var(--text3)">
            <span>${k.requests_today || 0}/${k.rate_limit} today</span>
            <span style="color:${k.status === 'active' ? 'var(--emerald)' : 'var(--red)'}">${k.status}</span>
            <span>${k.environment || 'production'}</span>
          </div>
        </div>
        <button onclick="revokeDevKey('${k.id}')" style="padding:6px 10px;border-radius:6px;border:1px solid rgba(239,68,68,0.3);background:transparent;color:#ef4444;font-size:11px;cursor:pointer" ${k.status !== 'active' ? 'disabled style="opacity:0.4"' : ''}>Revoke</button>
      </div>
    `).join('');
  } catch (err) {
    document.getElementById('dev-keys-list').innerHTML = '<div style="color:var(--red);font-size:13px">Failed to load keys</div>';
  }
}

async function loadDevAnalytics() {
  try {
    const res = await authFetch(API_BASE + '/api/developer/analytics?days=30');
    const data = await res.json();
    const el = document.getElementById('dev-analytics');
    const t = data.totals || {};

    if (!t.total_requests) {
      el.innerHTML = '<div style="color:var(--text3);font-size:13px;text-align:center;padding:20px 0">No API activity yet</div>';
      return;
    }

    // Summary cards
    el.innerHTML = `
      <div style="display:grid;grid-template-columns:1fr 1fr 1fr;gap:8px;margin-bottom:14px">
        <div style="background:var(--surface);border-radius:10px;padding:12px;text-align:center;border:1px solid var(--glass-border)">
          <div style="font-size:20px;font-weight:700;color:var(--text)">${(t.total_requests || 0).toLocaleString()}</div>
          <div style="font-size:11px;color:var(--text3)">Total</div>
        </div>
        <div style="background:var(--surface);border-radius:10px;padding:12px;text-align:center;border:1px solid var(--glass-border)">
          <div style="font-size:20px;font-weight:700;color:var(--emerald)">${(t.successful || 0).toLocaleString()}</div>
          <div style="font-size:11px;color:var(--text3)">Success</div>
        </div>
        <div style="background:var(--surface);border-radius:10px;padding:12px;text-align:center;border:1px solid var(--glass-border)">
          <div style="font-size:20px;font-weight:700;color:var(--red)">${(t.failed || 0).toLocaleString()}</div>
          <div style="font-size:11px;color:var(--text3)">Failed</div>
        </div>
      </div>
      ${(data.dailyStats || []).length > 0 ? `
        <div style="font-size:12px;font-weight:600;margin-bottom:6px;color:var(--text2)">Daily Activity (last 30d)</div>
        <div style="display:flex;flex-direction:column;gap:4px;max-height:200px;overflow-y:auto">
          ${(data.dailyStats || []).slice(0, 14).map(d => `
            <div style="display:flex;justify-content:space-between;font-size:11px;padding:4px 8px;background:var(--bg);border-radius:6px">
              <span style="color:var(--text2)">${d.date}</span>
              <span><span style="color:var(--emerald)">${d.successful}</span> / <span style="color:var(--red)">${d.failed || 0}</span></span>
              <span style="color:var(--text3)">${Math.round(d.avg_response_ms || 0)}ms</span>
            </div>
          `).join('')}
        </div>
      ` : ''}
    `;
  } catch(e) {
    document.getElementById('dev-analytics').innerHTML = '<div style="color:var(--text3);font-size:13px;text-align:center;padding:10px">Unable to load analytics</div>';
  }
}

async function loadDevLogs() {
  try {
    const filter = document.getElementById('dev-log-filter')?.value || '';
    const res = await authFetch(API_BASE + '/api/developer/logs?limit=20' + (filter ? '&status=' + filter : ''));
    const data = await res.json();
    const el = document.getElementById('dev-logs-list');

    if (!data.logs || data.logs.length === 0) {
      el.innerHTML = '<div style="color:var(--text3);font-size:13px;text-align:center;padding:20px 0">No logs yet</div>';
      return;
    }

    el.innerHTML = data.logs.map(l => {
      const isErr = l.status_code >= 400;
      const time = new Date(l.created_at).toLocaleString();
      return `
        <div style="display:flex;gap:8px;align-items:center;padding:8px;background:var(--surface);border-radius:8px;margin-bottom:4px;border:1px solid var(--glass-border);font-size:11px">
          <span style="min-width:32px;padding:2px 6px;border-radius:4px;text-align:center;font-weight:600;background:${isErr ? 'rgba(239,68,68,0.15)' : 'rgba(16,185,129,0.15)'};color:${isErr ? '#ef4444' : '#10b981'}">${l.status_code}</span>
          <span style="min-width:36px;color:var(--text3);font-weight:600">${l.method}</span>
          <span style="flex:1;color:var(--text2);overflow:hidden;text-overflow:ellipsis;white-space:nowrap">${l.endpoint}</span>
          <span style="color:var(--text3)">${l.response_time_ms}ms</span>
        </div>`;
    }).join('');
  } catch(e) {
    document.getElementById('dev-logs-list').innerHTML = '<div style="color:var(--red);font-size:12px">Failed to load logs</div>';
  }
}

async function loadDevWebhooks() {
  try {
    const res = await authFetch(API_BASE + '/api/developer/webhooks');
    const data = await res.json();
    const el = document.getElementById('dev-webhooks-list');
    const hooks = data.webhooks || [];

    if (hooks.length === 0) {
      el.innerHTML = '<div style="color:var(--text3);font-size:13px;text-align:center;padding:20px 0">No webhooks configured</div>';
      return;
    }

    el.innerHTML = hooks.map(h => `
      <div style="display:flex;justify-content:space-between;align-items:center;padding:10px;background:var(--surface);border-radius:8px;margin-bottom:6px;border:1px solid var(--glass-border)">
        <div>
          <div style="font-size:12px;font-family:monospace;color:var(--text2);word-break:break-all">${escapeHtml(h.url)}</div>
          <div style="font-size:11px;color:var(--text3);margin-top:3px">${JSON.parse(h.events || '[]').join(', ')}</div>
        </div>
        <button onclick="deleteWebhook('${h.id}')" style="padding:4px 8px;border-radius:6px;border:1px solid rgba(239,68,68,0.3);background:transparent;color:#ef4444;font-size:11px;cursor:pointer">Delete</button>
      </div>
    `).join('');
  } catch(e) {}
}

function loadDevDocs() {
  const endpoints = [
    { method: 'GET', path: '/api/v1/me', desc: 'Get API key info and rate limits' },
    { method: 'POST', path: '/api/v1/chat', desc: 'AI chat completion (Claude-powered)' },
    { method: 'POST', path: '/api/v1/task', desc: 'Execute an AI agent task' },
    { method: 'GET', path: '/api/v1/wallet/balance', desc: 'Check wallet balance' },
    { method: 'GET', path: '/api/v1/wallet/transactions', desc: 'List wallet transactions' },
    { method: 'POST', path: '/api/v1/airtime/send', desc: 'Send airtime to any phone' },
    { method: 'POST', path: '/api/v1/sms/send', desc: 'Send SMS messages' },
    { method: 'GET', path: '/api/v1/calls/rates', desc: 'Get international call rates' },
    { method: 'GET', path: '/api/v1/numbers', desc: 'List your virtual numbers' },
    { method: 'GET', path: '/api/v1/numbers/search', desc: 'Search available numbers' },
  ];

  const colors = { GET: '#10b981', POST: '#6c5ce7', PUT: '#f59e0b', DELETE: '#ef4444' };

  document.getElementById('dev-api-docs').innerHTML = endpoints.map(e => `
    <div style="display:flex;align-items:center;gap:8px;padding:10px 12px;background:var(--surface);border-radius:8px;border:1px solid var(--glass-border);cursor:pointer" onclick="this.querySelector('.doc-detail')?.classList.toggle('hidden')">
      <span style="min-width:42px;padding:2px 6px;border-radius:4px;text-align:center;font-size:10px;font-weight:700;background:${colors[e.method]}22;color:${colors[e.method]}">${e.method}</span>
      <div style="flex:1;min-width:0">
        <div style="font-family:monospace;font-size:12px;color:var(--text)">${e.path}</div>
        <div style="font-size:11px;color:var(--text3);margin-top:2px">${e.desc}</div>
      </div>
    </div>
  `).join('');
}

function showCreateKeyModal() {
  const html = `
    <div style="padding:20px">
      <h3 style="margin:0 0 16px;font-size:16px">Create API Key</h3>
      <div style="margin-bottom:12px">
        <label style="font-size:12px;color:var(--text2);display:block;margin-bottom:4px">Key Name</label>
        <input id="new-key-name" placeholder="My App" style="width:100%;padding:10px;border-radius:8px;border:1px solid var(--glass-border);background:var(--bg);color:var(--text);font-size:14px;box-sizing:border-box">
      </div>
      <div style="margin-bottom:12px">
        <label style="font-size:12px;color:var(--text2);display:block;margin-bottom:4px">Environment</label>
        <select id="new-key-env" style="width:100%;padding:10px;border-radius:8px;border:1px solid var(--glass-border);background:var(--bg);color:var(--text);font-size:14px">
          <option value="sandbox">Sandbox (testing)</option>
          <option value="production">Production (live)</option>
        </select>
      </div>
      <div style="display:flex;gap:8px;margin-top:16px">
        <button onclick="createDevKey()" style="flex:1;padding:10px;border-radius:10px;border:none;background:#6c5ce7;color:#fff;font-weight:600;cursor:pointer">Create Key</button>
        <button onclick="closeModal('create-key-modal')" style="flex:1;padding:10px;border-radius:10px;border:1px solid var(--glass-border);background:transparent;color:var(--text);cursor:pointer">Cancel</button>
      </div>
      <div id="new-key-result" style="display:none;margin-top:16px"></div>
    </div>
  `;
  showDynamicModal('create-key-modal', html);
}

async function createDevKey() {
  const name = document.getElementById('new-key-name').value.trim();
  const env = document.getElementById('new-key-env').value;
  if (!name) { showToast('Enter a key name'); return; }

  try {
    const res = await authFetch(API_BASE + '/api/developer/keys', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ name, environment: env }),
    });
    const data = await res.json();
    if (!res.ok) { showToast(data.error || 'Failed'); return; }

    // Save key locally for playground
    devSavedKeys[data.id] = data.apiKey;
    localStorage.setItem('dev_api_keys', JSON.stringify(devSavedKeys));

    document.getElementById('new-key-result').style.display = 'block';
    document.getElementById('new-key-result').innerHTML = `
      <div style="background:rgba(16,185,129,0.1);border:1px solid rgba(16,185,129,0.3);border-radius:10px;padding:14px">
        <div style="font-size:12px;font-weight:600;color:var(--emerald);margin-bottom:8px">Key Created! Copy it now — it won't be shown again.</div>
        <div style="font-family:monospace;font-size:11px;background:var(--bg);padding:10px;border-radius:6px;word-break:break-all;color:var(--text);cursor:pointer" onclick="navigator.clipboard.writeText('${data.apiKey}');showToast('Copied!','success')">${data.apiKey}</div>
        <div style="font-size:11px;color:var(--text3);margin-top:6px">Click to copy</div>
      </div>
    `;
    loadDevKeys();
  } catch(err) {
    showToast('Failed to create key');
  }
}

async function revokeDevKey(id) {
  if (!confirm('Revoke this API key? Any apps using it will stop working.')) return;
  try {
    await authFetch(API_BASE + '/api/developer/keys/' + id, { method: 'DELETE' });
    delete devSavedKeys[id];
    localStorage.setItem('dev_api_keys', JSON.stringify(devSavedKeys));
    showToast('Key revoked', 'success');
    loadDevKeys();
  } catch(e) { showToast('Failed to revoke'); }
}

function showCreateWebhookModal() {
  if (devKeysCache.length === 0) { showToast('Create an API key first'); return; }
  const keyOptions = devKeysCache.filter(k => k.status === 'active').map(k =>
    `<option value="${k.id}">${escapeHtml(k.name)} (${k.api_key_prefix})</option>`
  ).join('');

  const html = `
    <div style="padding:20px">
      <h3 style="margin:0 0 16px;font-size:16px">Add Webhook</h3>
      <div style="margin-bottom:12px">
        <label style="font-size:12px;color:var(--text2);display:block;margin-bottom:4px">API Key</label>
        <select id="webhook-key-id" style="width:100%;padding:10px;border-radius:8px;border:1px solid var(--glass-border);background:var(--bg);color:var(--text);font-size:13px">${keyOptions}</select>
      </div>
      <div style="margin-bottom:12px">
        <label style="font-size:12px;color:var(--text2);display:block;margin-bottom:4px">Endpoint URL</label>
        <input id="webhook-url" placeholder="https://yourapp.com/webhook" style="width:100%;padding:10px;border-radius:8px;border:1px solid var(--glass-border);background:var(--bg);color:var(--text);font-size:13px;box-sizing:border-box">
      </div>
      <div style="display:flex;gap:8px;margin-top:16px">
        <button onclick="createWebhook()" style="flex:1;padding:10px;border-radius:10px;border:none;background:#6c5ce7;color:#fff;font-weight:600;cursor:pointer">Create</button>
        <button onclick="closeModal('webhook-modal')" style="flex:1;padding:10px;border-radius:10px;border:1px solid var(--glass-border);background:transparent;color:var(--text);cursor:pointer">Cancel</button>
      </div>
      <div id="webhook-result" style="display:none;margin-top:16px"></div>
    </div>
  `;
  showDynamicModal('webhook-modal', html);
}

async function createWebhook() {
  const apiKeyId = document.getElementById('webhook-key-id').value;
  const url = document.getElementById('webhook-url').value.trim();
  if (!url) { showToast('Enter a webhook URL'); return; }
  try {
    const res = await authFetch(API_BASE + '/api/developer/webhooks', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ apiKeyId, url }),
    });
    const data = await res.json();
    if (!res.ok) { showToast(data.error || 'Failed'); return; }
    document.getElementById('webhook-result').style.display = 'block';
    document.getElementById('webhook-result').innerHTML = `
      <div style="background:rgba(16,185,129,0.1);border:1px solid rgba(16,185,129,0.3);border-radius:10px;padding:14px">
        <div style="font-size:12px;font-weight:600;color:var(--emerald);margin-bottom:8px">Webhook created! Save the secret.</div>
        <div style="font-family:monospace;font-size:11px;background:var(--bg);padding:10px;border-radius:6px;word-break:break-all;color:var(--text);cursor:pointer" onclick="navigator.clipboard.writeText('${data.secret}');showToast('Copied!','success')">${data.secret}</div>
      </div>
    `;
    loadDevWebhooks();
  } catch(e) { showToast('Failed'); }
}

async function deleteWebhook(id) {
  if (!confirm('Delete this webhook?')) return;
  try {
    await authFetch(API_BASE + '/api/developer/webhooks/' + id, { method: 'DELETE' });
    showToast('Webhook deleted', 'success');
    loadDevWebhooks();
  } catch(e) { showToast('Failed'); }
}

function showDynamicModal(id, html) {
  let overlay = document.getElementById(id);
  if (overlay) overlay.remove();
  overlay = document.createElement('div');
  overlay.id = id;
  overlay.className = 'modal-overlay active';
  overlay.onclick = function(e) { if (e.target === overlay) closeModal(id); };
  overlay.innerHTML = '<div class="modal-sheet" style="max-width:420px">' + html + '</div>';
  document.body.appendChild(overlay);
}

function closeModal(id) {
  const el = document.getElementById(id);
  if (el) el.classList.remove('active');
  setTimeout(() => el?.remove(), 300);
}

// API Playground
function updatePlaygroundBody() {
  const endpoint = document.getElementById('playground-endpoint').value;
  const methodEl = document.getElementById('playground-method');
  const bodyEl = document.getElementById('playground-body');
  const isPost = endpoint.startsWith('/api/v1/chat') || endpoint.startsWith('/api/v1/airtime') || endpoint.startsWith('/api/v1/sms') || endpoint.startsWith('/api/v1/task');

  methodEl.value = isPost ? 'POST' : 'GET';
  bodyEl.style.display = isPost ? 'block' : 'none';

  const bodies = {
    '/api/v1/chat': '{\n  "messages": [{"role": "user", "content": "Hello, what can you help me with?"}]\n}',
    '/api/v1/task': '{\n  "title": "Check my wallet balance"\n}',
    '/api/v1/airtime/send': '{\n  "phone": "+2348012345678",\n  "amount": 100,\n  "country": "NG"\n}',
    '/api/v1/sms/send': '{\n  "to": "+2348012345678",\n  "body": "Hello from PromptPay API!"\n}',
  };
  bodyEl.value = bodies[endpoint] || '';
}

async function runPlayground() {
  const apiKey = document.getElementById('playground-key').value;
  if (!apiKey) { showToast('Select an API key first'); return; }

  const method = document.getElementById('playground-method').value;
  const endpoint = document.getElementById('playground-endpoint').value;
  const bodyEl = document.getElementById('playground-body');
  const resultEl = document.getElementById('playground-result');
  const statusEl = document.getElementById('playground-status');
  const timeEl = document.getElementById('playground-time');
  const responseEl = document.getElementById('playground-response');

  resultEl.style.display = 'block';
  statusEl.textContent = 'Sending...';
  statusEl.style.color = 'var(--text3)';
  responseEl.textContent = '';
  timeEl.textContent = '';

  const start = performance.now();
  try {
    const opts = {
      method,
      headers: { 'X-API-Key': apiKey, 'Content-Type': 'application/json' },
    };
    if (method === 'POST' && bodyEl.value.trim()) {
      opts.body = bodyEl.value.trim();
    }

    const res = await fetch(API_BASE + endpoint, opts);
    const elapsed = Math.round(performance.now() - start);
    const data = await res.json();

    statusEl.textContent = res.status + ' ' + res.statusText;
    statusEl.style.color = res.ok ? 'var(--emerald)' : 'var(--red)';
    timeEl.textContent = elapsed + 'ms';
    responseEl.textContent = JSON.stringify(data, null, 2);
  } catch(err) {
    const elapsed = Math.round(performance.now() - start);
    statusEl.textContent = 'Error';
    statusEl.style.color = 'var(--red)';
    timeEl.textContent = elapsed + 'ms';
    responseEl.textContent = err.message;
  }
}

// Init playground body visibility
updatePlaygroundBody();
</script>

<!-- PWA Install Banner (body-level so it shows on landing AND app) -->
<div class="pwa-install-banner" id="pwa-install-banner">
  <button class="pwa-banner-close" onclick="dismissInstallBanner(true)">&times;</button>
  <div class="pwa-banner-content">
    <div class="pwa-banner-icon">
      <img src="/icons/icon-192.png" alt="PromptPay" onerror="this.parentElement.innerHTML='&#x1F4B3;'">
    </div>
    <div class="pwa-banner-text">
      <div class="pwa-banner-title">Install PromptPay</div>
      <div class="pwa-banner-desc">Add to your home screen for the full app experience — fast, offline-ready, no app store.</div>
    </div>
  </div>
  <div class="pwa-banner-actions">
    <button class="pwa-banner-install" onclick="installApp()">Install App</button>
    <button class="pwa-banner-dismiss" onclick="dismissInstallBanner(false)">Not Now</button>
  </div>
</div>

<!-- ═══ Homepage AI Chat Widget ═══ -->
<button class="pp-chat-fab" id="pp-chat-fab" onclick="ppChatToggle()" title="Chat with PromptPay AI">
  <svg viewBox="0 0 24 24"><path d="M20 2H4c-1.1 0-2 .9-2 2v18l4-4h14c1.1 0 2-.9 2-2V4c0-1.1-.9-2-2-2zm0 14H6l-2 2V4h16v12z"/></svg>
</button>

<div class="pp-chat-widget" id="pp-chat-widget">
  <div class="pp-chat-header">
    <div class="pp-chat-header-avatar">$</div>
    <div class="pp-chat-header-info">
      <h4>PromptPay AI</h4>
      <span>Online</span>
    </div>
    <button class="pp-chat-close" onclick="ppChatToggle()" title="Close">&times;</button>
  </div>
  <div class="pp-chat-messages" id="pp-chat-messages">
    <div class="pp-chat-msg ai">Hey! I'm PromptPay, your AI-powered fintech assistant. I can help with payments, shopping, budgeting, and more across Africa, India, and the US. What would you like to know?</div>
  </div>
  <div class="pp-chat-suggestions" id="pp-chat-suggestions">
    <button class="pp-chat-suggestion" onclick="ppChatAsk(this.textContent)">What can you do?</button>
    <button class="pp-chat-suggestion" onclick="ppChatAsk(this.textContent)">How do I send money?</button>
    <button class="pp-chat-suggestion" onclick="ppChatAsk(this.textContent)">Which countries?</button>
    <button class="pp-chat-suggestion" onclick="ppChatAsk(this.textContent)">What are the fees?</button>
  </div>
  <div class="pp-chat-input-area">
    <input class="pp-chat-input" id="pp-chat-input" placeholder="Ask PromptPay anything..." autocomplete="off"
      onkeydown="if(event.key==='Enter'&&!event.shiftKey){event.preventDefault();ppChatSend()}">
    <button class="pp-chat-send" id="pp-chat-send" onclick="ppChatSend()">
      <svg viewBox="0 0 24 24"><path d="M2.01 21L23 12 2.01 3 2 10l15 2-15 2z"/></svg>
    </button>
  </div>
</div>

<script>
(function() {
  let ppChatSessionId = null;
  let ppChatBusy = false;

  window.ppChatToggle = function() {
    const fab = document.getElementById('pp-chat-fab');
    const widget = document.getElementById('pp-chat-widget');
    const isOpen = widget.classList.contains('open');
    if (isOpen) {
      widget.classList.remove('open');
      fab.classList.remove('open');
    } else {
      widget.classList.add('open');
      fab.classList.add('open');
      document.getElementById('pp-chat-input').focus();
    }
  };

  window.ppChatAsk = function(text) {
    document.getElementById('pp-chat-input').value = text;
    document.getElementById('pp-chat-suggestions').style.display = 'none';
    ppChatSend();
  };

  window.ppChatSend = async function() {
    if (ppChatBusy) return;
    const input = document.getElementById('pp-chat-input');
    const text = input.value.trim();
    if (!text) return;

    input.value = '';
    ppChatBusy = true;
    document.getElementById('pp-chat-send').disabled = true;

    // Add user message
    ppChatAddMsg(text, 'user');

    // Add typing indicator
    const typingEl = ppChatAddMsg('Thinking...', 'ai typing');

    try {
      const res = await fetch('/api/chat/public', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ message: text, sessionId: ppChatSessionId })
      });
      const data = await res.json();
      typingEl.remove();

      if (data.error) {
        ppChatAddMsg(data.error, 'ai');
      } else {
        ppChatAddMsg(data.reply, 'ai');
        ppChatSessionId = data.sessionId;
      }
    } catch (e) {
      typingEl.remove();
      ppChatAddMsg("Something went wrong. Please try again!", 'ai');
    }

    ppChatBusy = false;
    document.getElementById('pp-chat-send').disabled = false;
    document.getElementById('pp-chat-input').focus();
  };

  function ppChatAddMsg(text, cls) {
    const container = document.getElementById('pp-chat-messages');
    const div = document.createElement('div');
    div.className = 'pp-chat-msg ' + cls;
    div.textContent = text;
    container.appendChild(div);
    container.scrollTop = container.scrollHeight;
    return div;
  }
})();
</script>

</body>
</html>

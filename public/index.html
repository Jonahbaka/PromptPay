<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
  <meta name="theme-color" content="#0d1117">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="apple-mobile-web-app-title" content="PromptPay">

  <!-- SEO -->
  <title>PromptPay — AI Life Assistant | Shopping, Investing, Budgets & Payments</title>
  <meta name="description" content="PromptPay is your AI life assistant. Shop autonomously, manage investments, track budgets, negotiate bills, and handle payments — all with natural language commands.">
  <meta name="keywords" content="PromptPay, AI assistant, AI shopping, AI investing, budget tracker, subscription manager, digital wallet, AI payments, fintech, price comparison, DCA trading, bill negotiation">
  <meta name="author" content="PromptPay Inc.">
  <meta name="robots" content="index, follow">
  <link rel="canonical" href="https://www.upromptpay.com/">

  <!-- Open Graph -->
  <meta property="og:type" content="website">
  <meta property="og:url" content="https://www.upromptpay.com/">
  <meta property="og:title" content="PromptPay — AI Life Assistant">
  <meta property="og:description" content="Your AI assistant for shopping, investing, budgeting, and payments. 9 specialized agents handle your financial life autonomously.">
  <meta property="og:image" content="https://www.upromptpay.com/icons/icon-512.png">
  <meta property="og:site_name" content="PromptPay">

  <!-- Twitter Card -->
  <meta name="twitter:card" content="summary_large_image">
  <meta name="twitter:title" content="PromptPay — AI Life Assistant">
  <meta name="twitter:description" content="Your AI assistant for shopping, investing, budgeting, and payments. 9 agents handle your financial life.">
  <meta name="twitter:image" content="https://www.upromptpay.com/icons/icon-512.png">

  <!-- Structured Data -->
  <script type="application/ld+json">
  {
    "@context": "https://schema.org",
    "@type": "SoftwareApplication",
    "name": "PromptPay",
    "applicationCategory": "FinanceApplication",
    "operatingSystem": "Web",
    "description": "AI-powered digital payments platform. Send money, pay bills, and manage finances using natural language commands.",
    "url": "https://www.upromptpay.com",
    "offers": {
      "@type": "Offer",
      "price": "0",
      "priceCurrency": "USD"
    }
  }
  </script>

  <!-- Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=G-716753GHP9"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());
    gtag('config', 'G-716753GHP9');
  </script>

  <link rel="manifest" href="/manifest.json">
  <link rel="icon" type="image/png" href="/icons/icon-192.png">
  <link rel="apple-touch-icon" href="/icons/icon-192.png">
  <script src="https://js.stripe.com/v3/"></script>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&family=JetBrains+Mono:wght@400;500;600&family=Space+Grotesk:wght@500;700&display=swap" rel="stylesheet">
  <style>
    :root {
      --bg: #06060a;
      --bg2: #0c0c14;
      --surface: rgba(255,255,255,0.03);
      --surface-hover: rgba(255,255,255,0.06);
      --glass: rgba(255,255,255,0.04);
      --glass-border: rgba(255,255,255,0.07);
      --text: #f0f2f5;
      --text2: #8b92a5;
      --text3: #4a5068;
      --accent: #7c3aed;
      --accent2: #a78bfa;
      --blue: #3b82f6;
      --cyan: #06b6d4;
      --green: #10b981;
      --emerald: #34d399;
      --yellow: #f59e0b;
      --orange: #f97316;
      --red: #ef4444;
      --pink: #ec4899;
      --gradient: linear-gradient(135deg, #7c3aed, #3b82f6, #06b6d4);
      --gradient2: linear-gradient(135deg, #7c3aed 0%, #2563eb 50%, #06b6d4 100%);
      --shadow: 0 8px 32px rgba(0,0,0,0.4);
      --shadow-lg: 0 20px 60px rgba(0,0,0,0.5);
      --radius: 16px;
      --radius-sm: 12px;
      --radius-xs: 8px;
      --safe-bottom: env(safe-area-inset-bottom, 0px);
    }
    * { margin: 0; padding: 0; box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
    html, body {
      height: 100%;
      font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'SF Pro Display', sans-serif;
      background: var(--bg); color: var(--text);
      -webkit-font-smoothing: antialiased;
    }
    body.app-mode { overflow: hidden; }
    body.landing-mode { overflow-x: hidden; overflow-y: auto; }

    /* ── App Shell ── */
    .app {
      max-width: 480px; margin: 0 auto; height: 100vh; height: 100dvh;
      position: relative; overflow: hidden;
      display: flex; flex-direction: column;
      background: var(--bg);
    }
    .app::before {
      content: ''; position: fixed; top: -50%; left: -50%; width: 200%; height: 200%;
      background: radial-gradient(ellipse at 30% 20%, rgba(124,58,237,0.06) 0%, transparent 50%),
                  radial-gradient(ellipse at 70% 80%, rgba(59,130,246,0.04) 0%, transparent 50%),
                  radial-gradient(ellipse at 50% 50%, rgba(6,182,212,0.03) 0%, transparent 50%);
      pointer-events: none; z-index: 0;
      animation: ambientDrift 20s ease-in-out infinite alternate;
    }
    @keyframes ambientDrift {
      0% { transform: translate(0, 0) rotate(0deg); }
      100% { transform: translate(-2%, 2%) rotate(3deg); }
    }

    /* ── Header ── */
    .header {
      position: relative; z-index: 10;
      padding: 12px 20px; display: flex; align-items: center; justify-content: space-between;
      padding-top: max(12px, env(safe-area-inset-top));
    }
    .header-left { display: flex; align-items: center; gap: 12px; }
    .header-avatar {
      width: 36px; height: 36px; border-radius: 50%;
      background: var(--gradient); display: flex; align-items: center; justify-content: center;
      font-size: 14px; font-weight: 700; color: white;
      box-shadow: 0 0 0 2px var(--bg), 0 0 0 3px rgba(124,58,237,0.3);
    }
    .header-greeting { font-size: 13px; color: var(--text2); }
    .header-name { font-size: 16px; font-weight: 600; line-height: 1.2; }
    .header-right { display: flex; gap: 8px; }
    .header-btn {
      width: 38px; height: 38px; border-radius: 50%;
      background: var(--surface); border: 1px solid var(--glass-border);
      display: flex; align-items: center; justify-content: center;
      cursor: pointer; transition: all 0.2s; color: var(--text2); font-size: 16px;
    }
    .header-btn:active { transform: scale(0.92); background: var(--surface-hover); }
    .header-btn .dot {
      position: absolute; top: 8px; right: 8px; width: 7px; height: 7px;
      background: var(--accent); border-radius: 50%; border: 1.5px solid var(--bg);
    }

    /* ── Pages Container ── */
    .pages {
      flex: 1; position: relative; overflow: hidden; z-index: 1;
    }
    .page {
      position: absolute; inset: 0; overflow-y: auto; overflow-x: hidden;
      padding: 0 20px 100px; scrollbar-width: none;
      opacity: 0; transform: translateY(12px); pointer-events: none;
      transition: opacity 0.35s ease, transform 0.35s ease;
    }
    .page::-webkit-scrollbar { display: none; }
    .page.active {
      opacity: 1; transform: translateY(0); pointer-events: auto;
    }

    /* ── Balance Card ── */
    .balance-card {
      position: relative; border-radius: 24px; padding: 28px 24px;
      margin-bottom: 24px; overflow: hidden;
      background: linear-gradient(145deg, rgba(124,58,237,0.15), rgba(59,130,246,0.1), rgba(6,182,212,0.08));
      border: 1px solid rgba(255,255,255,0.08);
      backdrop-filter: blur(40px); -webkit-backdrop-filter: blur(40px);
    }
    .balance-card::before {
      content: ''; position: absolute; top: -50%; right: -20%; width: 200px; height: 200px;
      background: radial-gradient(circle, rgba(124,58,237,0.2), transparent 70%);
      filter: blur(40px); pointer-events: none;
    }
    .balance-card::after {
      content: ''; position: absolute; bottom: -30%; left: -10%; width: 160px; height: 160px;
      background: radial-gradient(circle, rgba(6,182,212,0.15), transparent 70%);
      filter: blur(40px); pointer-events: none;
    }
    .balance-label { font-size: 13px; color: var(--text2); margin-bottom: 6px; position: relative; z-index: 1; }
    .balance-amount {
      font-size: 42px; font-weight: 800; letter-spacing: -1.5px;
      position: relative; z-index: 1; line-height: 1.1; margin-bottom: 4px;
      background: linear-gradient(to right, #fff, rgba(255,255,255,0.8));
      -webkit-background-clip: text; -webkit-text-fill-color: transparent;
    }
    .balance-change {
      font-size: 13px; color: var(--emerald); position: relative; z-index: 1;
      display: flex; align-items: center; gap: 4px;
    }
    .balance-actions {
      display: flex; gap: 10px; margin-top: 24px; position: relative; z-index: 1;
    }
    .bal-btn {
      flex: 1; padding: 13px; border-radius: var(--radius-sm); border: none;
      font-size: 14px; font-weight: 600; cursor: pointer; display: flex;
      align-items: center; justify-content: center; gap: 8px;
      transition: all 0.2s; font-family: inherit;
    }
    .bal-btn:active { transform: scale(0.96); }
    .bal-btn-primary {
      background: var(--gradient2); color: white;
      box-shadow: 0 4px 20px rgba(124,58,237,0.3);
    }
    .bal-btn-secondary {
      background: rgba(255,255,255,0.08); color: var(--text);
      border: 1px solid rgba(255,255,255,0.1);
    }

    /* ── Quick Actions Grid ── */
    .quick-grid {
      display: grid; grid-template-columns: repeat(4, 1fr); gap: 12px;
      margin-bottom: 28px;
    }
    .quick-item {
      display: flex; flex-direction: column; align-items: center; gap: 8px;
      cursor: pointer; transition: transform 0.2s;
    }
    .quick-item:active { transform: scale(0.92); }
    .quick-icon {
      width: 52px; height: 52px; border-radius: 16px;
      display: flex; align-items: center; justify-content: center;
      font-size: 22px; transition: all 0.2s;
      border: 1px solid rgba(255,255,255,0.06);
    }
    .quick-label { font-size: 11px; color: var(--text2); font-weight: 500; }
    .qi-violet { background: rgba(124,58,237,0.12); }
    .qi-blue { background: rgba(59,130,246,0.12); }
    .qi-cyan { background: rgba(6,182,212,0.12); }
    .qi-green { background: rgba(16,185,129,0.12); }
    .qi-pink { background: rgba(236,72,153,0.12); }
    .qi-orange { background: rgba(249,115,22,0.12); }
    .qi-yellow { background: rgba(245,158,11,0.12); }
    .qi-red { background: rgba(239,68,68,0.12); }

    /* ── Section Headers ── */
    .section-header {
      display: flex; justify-content: space-between; align-items: center;
      margin-bottom: 14px;
    }
    .section-title { font-size: 17px; font-weight: 700; }
    .section-link { font-size: 13px; color: var(--accent2); cursor: pointer; font-weight: 500; }

    /* ── AI Agent Card ── */
    .ai-card {
      background: var(--surface); border: 1px solid var(--glass-border);
      border-radius: var(--radius); padding: 18px; margin-bottom: 24px;
      cursor: pointer; transition: all 0.2s; position: relative; overflow: hidden;
    }
    .ai-card:active { transform: scale(0.98); }
    .ai-card::before {
      content: ''; position: absolute; top: 0; left: 0; right: 0; height: 2px;
      background: var(--gradient2);
    }
    .ai-card-header {
      display: flex; align-items: center; gap: 12px; margin-bottom: 12px;
    }
    .ai-avatar {
      width: 40px; height: 40px; border-radius: 12px;
      background: var(--gradient2); display: flex; align-items: center; justify-content: center;
      font-size: 20px;
    }
    .ai-name { font-size: 14px; font-weight: 600; }
    .ai-status { font-size: 11px; color: var(--emerald); display: flex; align-items: center; gap: 4px; }
    .ai-status::before {
      content: ''; width: 6px; height: 6px; background: var(--emerald);
      border-radius: 50%; animation: pulse 2s ease infinite;
    }
    @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.4; } }
    .ai-suggestion {
      background: rgba(124,58,237,0.08); border-radius: var(--radius-xs);
      padding: 10px 14px; font-size: 13px; color: var(--text2);
      border: 1px solid rgba(124,58,237,0.12);
    }

    /* ── Transaction List ── */
    .tx-list { display: flex; flex-direction: column; gap: 2px; }
    .tx-item {
      display: flex; align-items: center; gap: 14px; padding: 14px 0;
      border-bottom: 1px solid rgba(255,255,255,0.04); cursor: pointer;
      transition: background 0.15s;
    }
    .tx-item:last-child { border-bottom: none; }
    .tx-icon {
      width: 44px; height: 44px; border-radius: 14px;
      display: flex; align-items: center; justify-content: center; font-size: 18px;
      flex-shrink: 0;
    }
    .tx-info { flex: 1; min-width: 0; }
    .tx-name { font-size: 14px; font-weight: 500; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
    .tx-desc { font-size: 12px; color: var(--text2); margin-top: 2px; }
    .tx-amount { text-align: right; }
    .tx-value { font-size: 14px; font-weight: 600; }
    .tx-time { font-size: 11px; color: var(--text3); margin-top: 2px; }
    .tx-positive { color: var(--emerald); }
    .tx-negative { color: var(--text); }

    /* ── AI Chat Page ── */
    .chat-container {
      display: flex; flex-direction: column; height: calc(100dvh - 140px);
      position: relative;
    }
    .chat-header-bar {
      display: flex; align-items: center; gap: 12px; padding-bottom: 16px;
      border-bottom: 1px solid rgba(255,255,255,0.05); margin-bottom: 16px;
    }
    .chat-messages {
      flex: 1; overflow-y: auto; display: flex; flex-direction: column; gap: 12px;
      padding-bottom: 80px; scrollbar-width: none;
    }
    .chat-messages::-webkit-scrollbar { display: none; }
    .msg {
      max-width: 85%; padding: 14px 16px; font-size: 14px; line-height: 1.5;
      animation: msgIn 0.3s ease;
    }
    @keyframes msgIn {
      from { opacity: 0; transform: translateY(8px); }
      to { opacity: 1; transform: translateY(0); }
    }
    .msg-ai {
      align-self: flex-start; background: var(--surface);
      border: 1px solid var(--glass-border);
      border-radius: 4px 18px 18px 18px; color: var(--text);
    }
    .msg-user {
      align-self: flex-end;
      background: var(--gradient2);
      border-radius: 18px 4px 18px 18px; color: white;
    }
    .msg-typing {
      align-self: flex-start; background: var(--surface);
      border: 1px solid var(--glass-border);
      border-radius: 4px 18px 18px 18px; padding: 14px 20px;
      display: flex; gap: 5px; align-items: center;
    }
    .typing-dot {
      width: 7px; height: 7px; background: var(--text2); border-radius: 50%;
      animation: typingBounce 1.4s ease-in-out infinite;
    }
    .typing-dot:nth-child(2) { animation-delay: 0.2s; }
    .typing-dot:nth-child(3) { animation-delay: 0.4s; }
    @keyframes typingBounce {
      0%, 60%, 100% { transform: translateY(0); opacity: 0.4; }
      30% { transform: translateY(-6px); opacity: 1; }
    }
    .chat-input-area {
      position: absolute; bottom: 0; left: 0; right: 0;
      background: linear-gradient(to top, var(--bg) 70%, transparent);
      padding: 16px 0 8px;
    }
    .chat-input-wrap {
      display: flex; align-items: center; gap: 10px;
      background: var(--surface); border: 1px solid var(--glass-border);
      border-radius: 28px; padding: 6px 6px 6px 18px;
    }
    .chat-input {
      flex: 1; border: none; background: none; color: var(--text);
      font-size: 14px; font-family: inherit; outline: none;
    }
    .chat-input::placeholder { color: var(--text3); }
    .chat-send-btn {
      width: 40px; height: 40px; border-radius: 50%;
      background: var(--gradient2); border: none; cursor: pointer;
      display: flex; align-items: center; justify-content: center;
      color: white; font-size: 16px; transition: all 0.2s; flex-shrink: 0;
    }
    .chat-send-btn:active { transform: scale(0.9); }
    .chat-send-btn:disabled { opacity: 0.4; }
    .chat-suggestions {
      display: flex; gap: 8px; flex-wrap: wrap; margin-bottom: 12px;
    }
    .chat-suggestion {
      padding: 8px 14px; border-radius: 20px; font-size: 12px;
      background: rgba(124,58,237,0.08); border: 1px solid rgba(124,58,237,0.15);
      color: var(--accent2); cursor: pointer; transition: all 0.2s;
      white-space: nowrap;
    }
    .chat-suggestion:active { transform: scale(0.95); background: rgba(124,58,237,0.15); }

    /* ── Wallet Page ── */
    .card-carousel {
      display: flex; gap: 14px; overflow-x: auto; padding-bottom: 16px;
      scrollbar-width: none; scroll-snap-type: x mandatory;
      margin-bottom: 24px;
    }
    .card-carousel::-webkit-scrollbar { display: none; }
    .payment-card {
      min-width: 280px; padding: 24px; border-radius: 20px;
      position: relative; overflow: hidden; scroll-snap-align: start;
      border: 1px solid rgba(255,255,255,0.08);
    }
    .payment-card.pc-violet {
      background: linear-gradient(145deg, rgba(124,58,237,0.25), rgba(59,130,246,0.15));
    }
    .payment-card.pc-blue {
      background: linear-gradient(145deg, rgba(59,130,246,0.25), rgba(6,182,212,0.15));
    }
    .payment-card.pc-green {
      background: linear-gradient(145deg, rgba(16,185,129,0.25), rgba(6,182,212,0.15));
    }
    .pc-brand { font-size: 12px; font-weight: 600; color: var(--text2); letter-spacing: 1px; text-transform: uppercase; }
    .pc-number { font-size: 18px; font-weight: 500; letter-spacing: 3px; margin: 20px 0; color: var(--text); }
    .pc-row { display: flex; justify-content: space-between; }
    .pc-label { font-size: 10px; color: var(--text3); text-transform: uppercase; }
    .pc-val { font-size: 13px; font-weight: 500; margin-top: 2px; }

    /* ── Savings Goals ── */
    .goal-card {
      background: var(--surface); border: 1px solid var(--glass-border);
      border-radius: var(--radius); padding: 18px; margin-bottom: 12px;
    }
    .goal-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; }
    .goal-name { font-size: 14px; font-weight: 600; }
    .goal-amount { font-size: 13px; color: var(--accent2); font-weight: 600; }
    .goal-bar {
      height: 6px; background: rgba(255,255,255,0.06); border-radius: 3px;
      overflow: hidden; margin-top: 8px;
    }
    .goal-fill { height: 100%; border-radius: 3px; transition: width 0.8s ease; }

    /* ── Stats/Streak Card ── */
    .streak-card {
      background: var(--surface); border: 1px solid var(--glass-border);
      border-radius: var(--radius); padding: 20px; margin-bottom: 16px;
      display: flex; align-items: center; gap: 16px;
    }
    .streak-fire { font-size: 36px; line-height: 1; }
    .streak-count { font-size: 28px; font-weight: 800; }
    .streak-label { font-size: 12px; color: var(--text2); }
    .streak-multiplier {
      margin-left: auto; padding: 6px 14px; border-radius: 20px;
      background: rgba(245,158,11,0.12); color: var(--yellow);
      font-size: 14px; font-weight: 700;
    }

    /* ── Loyalty Tier ── */
    .tier-card {
      background: var(--surface); border: 1px solid var(--glass-border);
      border-radius: var(--radius); padding: 20px; margin-bottom: 16px;
      position: relative; overflow: hidden;
    }
    .tier-card::before {
      content: ''; position: absolute; top: 0; left: 0; right: 0; height: 3px;
    }
    .tier-bronze::before { background: linear-gradient(to right, #b87333, #d4a76a); }
    .tier-silver::before { background: linear-gradient(to right, #94a3b8, #cbd5e1); }
    .tier-gold::before { background: linear-gradient(to right, #f59e0b, #fbbf24); }
    .tier-platinum::before { background: linear-gradient(to right, #7c3aed, #a78bfa); }
    .tier-info { display: flex; justify-content: space-between; align-items: center; }
    .tier-name { font-size: 18px; font-weight: 700; text-transform: uppercase; letter-spacing: 2px; }
    .tier-points { font-size: 13px; color: var(--text2); }
    .tier-progress { margin-top: 14px; }
    .tier-bar { height: 4px; background: rgba(255,255,255,0.06); border-radius: 2px; overflow: hidden; }
    .tier-fill { height: 100%; border-radius: 2px; }
    .tier-next { font-size: 11px; color: var(--text3); margin-top: 6px; text-align: right; }

    /* ── Achievement Badges ── */
    .achievements-grid {
      display: grid; grid-template-columns: repeat(3, 1fr); gap: 12px;
    }
    .achievement {
      background: var(--surface); border: 1px solid var(--glass-border);
      border-radius: var(--radius-sm); padding: 16px; text-align: center;
      transition: transform 0.2s;
    }
    .achievement:active { transform: scale(0.95); }
    .achievement.locked { opacity: 0.4; }
    .ach-icon { font-size: 28px; margin-bottom: 8px; }
    .ach-name { font-size: 11px; font-weight: 600; }
    .ach-pts { font-size: 10px; color: var(--accent2); margin-top: 4px; }

    /* ── Bottom Navigation ── */
    .bottom-nav {
      position: relative; z-index: 20;
      display: flex; justify-content: space-around; align-items: center;
      padding: 8px 12px; padding-bottom: max(8px, var(--safe-bottom));
      background: rgba(6,6,10,0.92);
      backdrop-filter: blur(20px); -webkit-backdrop-filter: blur(20px);
      border-top: 1px solid rgba(255,255,255,0.05);
    }
    .nav-item {
      display: flex; flex-direction: column; align-items: center; gap: 3px;
      padding: 6px 16px; cursor: pointer; transition: all 0.2s;
      border-radius: 12px; position: relative;
    }
    .nav-item:active { transform: scale(0.9); }
    .nav-icon { font-size: 20px; transition: all 0.2s; opacity: 0.5; }
    .nav-label { font-size: 10px; color: var(--text3); font-weight: 500; transition: color 0.2s; }
    .nav-item.active .nav-icon { opacity: 1; }
    .nav-item.active .nav-label { color: var(--accent2); }
    .nav-item.active::after {
      content: ''; position: absolute; top: -8px; width: 20px; height: 3px;
      background: var(--gradient2); border-radius: 2px;
    }
    .nav-ai {
      background: var(--gradient2); width: 52px; height: 52px;
      border-radius: 50%; display: flex; align-items: center; justify-content: center;
      margin-top: -20px; box-shadow: 0 4px 20px rgba(124,58,237,0.4);
    }
    .nav-ai .nav-icon { opacity: 1; color: white; font-size: 22px; }
    .nav-ai .nav-label { display: none; }

    /* ── Utility ── */
    .fade-up { animation: fadeUp 0.4s ease both; }
    @keyframes fadeUp {
      from { opacity: 0; transform: translateY(16px); }
      to { opacity: 1; transform: translateY(0); }
    }
    .shimmer {
      background: linear-gradient(90deg, transparent, rgba(255,255,255,0.04), transparent);
      background-size: 200% 100%;
      animation: shimmer 2s infinite;
    }
    @keyframes shimmer { 0% { background-position: 200% 0; } 100% { background-position: -200% 0; } }

    /* ── Modal Overlay ── */
    .modal-overlay {
      position: fixed; inset: 0; background: rgba(0,0,0,0.7);
      backdrop-filter: blur(8px); z-index: 100;
      display: flex; align-items: flex-end; justify-content: center;
      opacity: 0; pointer-events: none; transition: opacity 0.3s;
    }
    .modal-overlay.active { opacity: 1; pointer-events: auto; }
    .modal-sheet {
      background: var(--bg2); border-radius: 24px 24px 0 0;
      width: 100%; max-width: 480px; max-height: 80vh; overflow-y: auto;
      padding: 20px; padding-bottom: max(20px, var(--safe-bottom));
      transform: translateY(100%); transition: transform 0.35s ease;
    }
    .modal-overlay.active .modal-sheet { transform: translateY(0); }
    .modal-handle {
      width: 36px; height: 4px; background: rgba(255,255,255,0.15);
      border-radius: 2px; margin: 0 auto 16px;
    }

    /* ── Premium Popup ── */
    .premium-popup-overlay {
      position: fixed; inset: 0; background: rgba(0,0,0,0.6);
      backdrop-filter: blur(12px); -webkit-backdrop-filter: blur(12px);
      z-index: 200; display: flex; align-items: center; justify-content: center;
      opacity: 0; pointer-events: none; transition: opacity 0.3s;
    }
    .premium-popup-overlay.active { opacity: 1; pointer-events: auto; }
    .premium-popup {
      background: linear-gradient(145deg, rgba(15,15,25,0.98), rgba(12,12,20,0.95));
      border: 1px solid rgba(124,58,237,0.25); border-radius: 24px;
      padding: 32px 28px; width: 90%; max-width: 360px; text-align: center;
      transform: scale(0.9); transition: transform 0.3s ease;
      box-shadow: 0 20px 60px rgba(0,0,0,0.5), 0 0 40px rgba(124,58,237,0.1);
    }
    .premium-popup-overlay.active .premium-popup { transform: scale(1); }

    /* ═══ Holographic Wallet Cards ═══ */
    .wallet-holo-card {
      min-width: 300px; aspect-ratio: 1.586; border-radius: 20px;
      padding: 28px; position: relative; overflow: hidden; flex-shrink: 0;
      border: 1px solid rgba(255,255,255,0.08);
      box-shadow: 0 16px 48px rgba(0,0,0,0.4);
      transition: transform 0.3s ease, box-shadow 0.3s ease;
      cursor: default;
    }
    .wallet-holo-card:hover {
      transform: translateY(-6px);
      box-shadow: 0 24px 64px rgba(0,0,0,0.6);
    }
    .wallet-holo-card .holo-glint {
      position: absolute; top: 0; left: -50%; width: 50%; height: 200%;
      background: linear-gradient(90deg, transparent, rgba(255,255,255,0.07), transparent);
      animation: cardGlint 4s ease-in-out infinite; pointer-events: none;
    }
    .wallet-holo-card .holo-chip {
      width: 36px; height: 28px; border-radius: 6px;
      background: linear-gradient(135deg, #d4a853, #f0d78c, #d4a853);
      position: absolute; top: 28px; left: 28px;
      box-shadow: inset 0 1px 2px rgba(0,0,0,0.2);
    }
    .wallet-holo-card .holo-chip::after {
      content: ''; position: absolute; top: 6px; left: 6px;
      width: 24px; height: 16px; border: 1px solid rgba(180,150,80,0.4);
      border-radius: 3px;
    }
    .wallet-holo-card .holo-brand {
      position: absolute; top: 24px; right: 28px;
      font-weight: 700; font-size: 16px; text-transform: uppercase;
      letter-spacing: 2px; opacity: 0.8;
    }
    .wallet-holo-card .holo-number {
      font-family: 'JetBrains Mono', monospace; font-size: 17px;
      letter-spacing: 3px; color: rgba(255,255,255,0.75);
      position: absolute; bottom: 80px; left: 28px;
    }
    .wallet-holo-card .holo-footer {
      position: absolute; bottom: 24px; left: 28px; right: 28px;
      display: flex; justify-content: space-between; align-items: flex-end;
    }
    .wallet-holo-card .holo-label {
      font-size: 9px; text-transform: uppercase; letter-spacing: 2px;
      color: rgba(255,255,255,0.35); margin-bottom: 3px;
    }
    .wallet-holo-card .holo-value {
      font-size: 13px; color: rgba(255,255,255,0.85); font-weight: 500;
    }
    .wallet-holo-card .holo-branding {
      font-size: 10px; letter-spacing: 1px; opacity: 0.3; font-weight: 600;
    }
    .wallet-holo-card .holo-remove {
      position: absolute; top: 12px; right: 12px; background: rgba(0,0,0,0.3);
      border: none; color: rgba(255,255,255,0.5); cursor: pointer;
      width: 24px; height: 24px; border-radius: 50%; font-size: 13px;
      display: flex; align-items: center; justify-content: center;
      opacity: 0; transition: opacity 0.2s;
    }
    .wallet-holo-card:hover .holo-remove { opacity: 1; }
    .wallet-holo-card .holo-remove:hover { background: rgba(239,68,68,0.5); color: #fff; }

    /* Brand color themes */
    .brand-visa {
      background: linear-gradient(135deg, #1a1f71 0%, #0d1252 50%, #1a1f71 100%);
    }
    .brand-mastercard {
      background: linear-gradient(135deg, #eb001b 0%, #c7000f 40%, #f79e1b 100%);
    }
    .brand-amex {
      background: linear-gradient(135deg, #006fcf 0%, #004a8f 50%, #006fcf 100%);
    }
    .brand-discover {
      background: linear-gradient(135deg, #ff6000 0%, #c44b00 50%, #ff6000 100%);
    }
    .brand-default {
      background: linear-gradient(135deg, #0a0a1a 0%, #1a1040 50%, #0a0a1a 100%);
    }

    /* ═══ Reward Card ═══ */
    .wallet-reward-card {
      min-width: 300px; aspect-ratio: 1.586; border-radius: 20px;
      padding: 28px; position: relative; overflow: hidden; flex-shrink: 0;
      background: linear-gradient(135deg, #92400e 0%, #f59e0b 50%, #b45309 100%);
      border: 1px solid rgba(251,191,36,0.3);
      box-shadow: 0 16px 48px rgba(245,158,11,0.15), 0 0 30px rgba(245,158,11,0.08);
      transition: transform 0.3s ease, box-shadow 0.3s ease;
      cursor: default;
    }
    .wallet-reward-card:hover {
      transform: translateY(-6px);
      box-shadow: 0 24px 64px rgba(245,158,11,0.25), 0 0 40px rgba(245,158,11,0.12);
    }
    .wallet-reward-card .reward-glint {
      position: absolute; top: 0; left: -50%; width: 50%; height: 200%;
      background: linear-gradient(90deg, transparent, rgba(255,255,255,0.12), transparent);
      animation: cardGlint 4s ease-in-out infinite; pointer-events: none;
    }
    .wallet-reward-card .reward-star {
      position: absolute; top: 20px; right: 24px; font-size: 28px; opacity: 0.7;
    }
    .wallet-reward-card .reward-type {
      font-size: 10px; text-transform: uppercase; letter-spacing: 3px;
      color: rgba(255,255,255,0.5); margin-bottom: 6px;
    }
    .wallet-reward-card .reward-title {
      font-size: 18px; font-weight: 700; color: #fff; margin-bottom: 24px;
    }
    .wallet-reward-card .reward-balance-label {
      font-size: 10px; text-transform: uppercase; letter-spacing: 2px;
      color: rgba(255,255,255,0.45); margin-bottom: 4px;
    }
    .wallet-reward-card .reward-balance-value {
      font-size: 32px; font-weight: 800; color: #fff;
      font-family: 'Space Grotesk', sans-serif;
    }
    .wallet-reward-card .reward-footer {
      position: absolute; bottom: 24px; left: 28px; right: 28px;
      display: flex; justify-content: space-between; align-items: flex-end;
    }
    .wallet-reward-card .reward-stat-label {
      font-size: 9px; text-transform: uppercase; letter-spacing: 1.5px;
      color: rgba(255,255,255,0.4); margin-bottom: 2px;
    }
    .wallet-reward-card .reward-stat-value {
      font-size: 13px; color: rgba(255,255,255,0.85); font-weight: 600;
    }
    .premium-popup-icon { font-size: 40px; margin-bottom: 12px; }
    .premium-popup h3 { font-size: 20px; font-weight: 700; margin-bottom: 8px; }
    .premium-popup p { font-size: 14px; color: var(--text2); line-height: 1.5; margin-bottom: 20px; }
    .premium-popup .price { font-size: 28px; font-weight: 800; margin-bottom: 24px;
      background: var(--gradient); -webkit-background-clip: text; -webkit-text-fill-color: transparent; }
    .premium-popup .btn-subscribe {
      width: 100%; padding: 16px; background: var(--gradient2); border: none;
      border-radius: 14px; color: white; font-size: 16px; font-weight: 600;
      cursor: pointer; font-family: inherit; margin-bottom: 10px;
      box-shadow: 0 4px 20px rgba(124,58,237,0.3);
    }
    .premium-popup .btn-later {
      width: 100%; padding: 14px; background: none; border: none;
      color: var(--text2); font-size: 14px; cursor: pointer; font-family: inherit;
    }

    /* ── Token Matrix Display ── */
    .token-matrix {
      background: var(--surface); border: 1px solid var(--glass-border);
      border-radius: var(--radius); padding: 18px; margin-bottom: 16px;
    }
    .token-row {
      display: flex; justify-content: space-between; align-items: center;
      padding: 8px 0; border-bottom: 1px solid rgba(255,255,255,0.04);
    }
    .token-row:last-child { border-bottom: none; }
    .token-label { font-size: 13px; color: var(--text2); }
    .token-value { font-size: 13px; font-weight: 600; font-family: 'SF Mono', 'Fira Code', monospace; }
    .token-saved { color: var(--emerald); }

    /* ── Auth Gate ── */
    .auth-gate {
      position: fixed; inset: 0; z-index: 200;
      background: var(--bg);
      display: flex; align-items: center; justify-content: center;
      opacity: 1; transition: opacity 0.4s ease;
    }
    .auth-gate.hidden {
      opacity: 0; pointer-events: none;
    }
    .auth-gate::before {
      content: ''; position: absolute; top: -50%; left: -50%; width: 200%; height: 200%;
      background: radial-gradient(ellipse at 30% 20%, rgba(124,58,237,0.08) 0%, transparent 50%),
                  radial-gradient(ellipse at 70% 80%, rgba(59,130,246,0.06) 0%, transparent 50%),
                  radial-gradient(ellipse at 50% 50%, rgba(6,182,212,0.04) 0%, transparent 50%);
      pointer-events: none;
      animation: ambientDrift 20s ease-in-out infinite alternate;
    }
    .auth-card {
      position: relative; z-index: 1;
      width: 100%; max-width: 400px; margin: 0 20px;
      background: rgba(255,255,255,0.03);
      border: 1px solid rgba(255,255,255,0.07);
      border-radius: 24px; padding: 40px 32px;
      backdrop-filter: blur(40px); -webkit-backdrop-filter: blur(40px);
      box-shadow: 0 20px 60px rgba(0,0,0,0.5);
    }
    .auth-brand {
      text-align: center; margin-bottom: 32px;
    }
    .auth-brand-icon {
      width: 72px; height: 72px; border-radius: 20px;
      background: rgba(255,255,255,0.03);
      border: 1px solid rgba(255,255,255,0.06);
      margin: 0 auto 16px;
      display: flex; align-items: center; justify-content: center;
      box-shadow: 0 8px 32px rgba(79,172,254,0.12), 0 0 60px rgba(240,147,251,0.06);
    }
    .auth-brand-name {
      font-size: 24px; font-weight: 800; letter-spacing: -0.5px;
      background: linear-gradient(to right, #fff, rgba(255,255,255,0.7));
      -webkit-background-clip: text; -webkit-text-fill-color: transparent;
    }
    .auth-brand-tagline {
      font-size: 13px; color: var(--text2); margin-top: 4px;
    }
    .auth-tabs {
      display: flex; background: rgba(255,255,255,0.04); border-radius: 12px;
      padding: 3px; margin-bottom: 28px;
    }
    .auth-tab {
      flex: 1; padding: 10px; text-align: center; font-size: 13px; font-weight: 600;
      border-radius: 10px; cursor: pointer; transition: all 0.2s;
      color: var(--text2); border: none; background: none; font-family: inherit;
    }
    .auth-tab.active {
      background: var(--gradient2); color: white;
      box-shadow: 0 4px 12px rgba(124,58,237,0.3);
    }
    .auth-form { display: none; }
    .auth-form.active { display: block; }
    .auth-field {
      margin-bottom: 16px;
    }
    .auth-field label {
      display: block; font-size: 12px; color: var(--text2);
      margin-bottom: 6px; font-weight: 500;
    }
    .auth-field input {
      width: 100%; padding: 14px 16px;
      background: rgba(255,255,255,0.04);
      border: 1px solid rgba(255,255,255,0.08);
      border-radius: 12px; color: var(--text);
      font-size: 14px; font-family: inherit; outline: none;
      transition: border-color 0.2s;
    }
    .auth-field input:focus {
      border-color: var(--accent);
    }
    .auth-field input::placeholder { color: var(--text3); }
    .auth-field .pw-wrapper {
      position: relative;
    }
    .auth-field .pw-wrapper input { padding-right: 44px; }
    .auth-field .pw-toggle {
      position: absolute; right: 12px; top: 50%; transform: translateY(-50%);
      background: none; border: none; cursor: pointer; color: var(--text3);
      padding: 4px; display: flex; align-items: center; justify-content: center;
      transition: color 0.2s;
    }
    .auth-field .pw-toggle:hover { color: var(--text); }
    .auth-submit {
      width: 100%; padding: 16px; margin-top: 8px;
      background: var(--gradient2); border: none; border-radius: 14px;
      color: white; font-size: 15px; font-weight: 600;
      cursor: pointer; font-family: inherit;
      box-shadow: 0 4px 20px rgba(124,58,237,0.3);
      transition: all 0.2s;
    }
    .auth-submit:active { transform: scale(0.98); }
    .auth-submit:disabled {
      opacity: 0.5; cursor: not-allowed; transform: none;
    }
    .auth-error {
      color: var(--red); font-size: 13px; text-align: center;
      margin-top: 12px; min-height: 18px;
    }
    .auth-divider {
      display: flex; align-items: center; gap: 12px;
      margin: 20px 0; color: var(--text3); font-size: 12px;
    }
    .auth-divider::before, .auth-divider::after {
      content: ''; flex: 1; height: 1px;
      background: rgba(255,255,255,0.06);
    }

    /* ── Settings Dropdown ── */
    .settings-dropdown-wrap {
      position: relative;
    }
    .settings-dropdown {
      position: absolute; top: calc(100% + 8px); right: 0;
      width: 180px; background: var(--bg2);
      border: 1px solid var(--glass-border);
      border-radius: var(--radius-sm); padding: 6px;
      box-shadow: var(--shadow-lg); z-index: 50;
      opacity: 0; transform: translateY(-8px) scale(0.95);
      pointer-events: none; transition: all 0.2s ease;
    }
    .settings-dropdown.open {
      opacity: 1; transform: translateY(0) scale(1);
      pointer-events: auto;
    }
    .settings-dropdown-item {
      display: flex; align-items: center; gap: 10px;
      padding: 10px 12px; border-radius: var(--radius-xs);
      font-size: 13px; color: var(--text); cursor: pointer;
      transition: background 0.15s; border: none; background: none;
      width: 100%; font-family: inherit;
    }
    .settings-dropdown-item:hover,
    .settings-dropdown-item:active {
      background: var(--surface-hover);
    }
    .settings-dropdown-item svg {
      flex-shrink: 0; color: var(--text2);
    }
    .settings-dropdown-item.danger { color: var(--red); }
    .settings-dropdown-item.danger svg { color: var(--red); }

    /* ── Hamburger Button ── */
    .hamburger-btn {
      width: 38px; height: 38px; border-radius: 50%;
      background: var(--surface); border: 1px solid var(--glass-border);
      display: flex; align-items: center; justify-content: center;
      cursor: pointer; transition: all 0.2s; color: var(--text2);
      padding: 0; flex-shrink: 0;
    }
    .hamburger-btn:active { transform: scale(0.92); background: var(--surface-hover); }

    /* ── Navigation Drawer ── */
    .nav-drawer-overlay {
      position: fixed; inset: 0; background: rgba(0,0,0,0.6);
      backdrop-filter: blur(6px); -webkit-backdrop-filter: blur(6px);
      z-index: 200; opacity: 0; pointer-events: none;
      transition: opacity 0.3s ease;
    }
    .nav-drawer-overlay.open { opacity: 1; pointer-events: auto; }
    .nav-drawer {
      position: fixed; top: 0; left: 0; bottom: 0; width: 280px;
      background: var(--bg2); z-index: 201;
      transform: translateX(-100%); transition: transform 0.3s ease;
      display: flex; flex-direction: column;
      padding-top: max(20px, env(safe-area-inset-top));
      box-shadow: 4px 0 24px rgba(0,0,0,0.3);
    }
    .nav-drawer-overlay.open .nav-drawer { transform: translateX(0); }
    .nav-drawer-header {
      padding: 20px 20px 16px; display: flex; align-items: center; gap: 14px;
      border-bottom: 1px solid var(--glass-border); margin-bottom: 8px;
    }
    .nav-drawer-header .drawer-logo {
      width: 40px; height: 40px; border-radius: 12px;
      background: var(--gradient); display: flex; align-items: center; justify-content: center;
      box-shadow: 0 0 12px rgba(124,58,237,0.3);
    }
    .nav-drawer-header .drawer-info { flex: 1; min-width: 0; }
    .nav-drawer-header .drawer-name {
      font-size: 15px; font-weight: 700; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;
    }
    .nav-drawer-header .drawer-email {
      font-size: 12px; color: var(--text3); white-space: nowrap; overflow: hidden; text-overflow: ellipsis;
    }
    .nav-drawer-section {
      padding: 4px 12px;
    }
    .nav-drawer-section-label {
      padding: 12px 12px 6px; font-size: 10px; text-transform: uppercase;
      letter-spacing: 2px; color: var(--text3); font-weight: 600;
    }
    .nav-drawer-item {
      display: flex; align-items: center; gap: 14px;
      padding: 12px 14px; border-radius: 12px; cursor: pointer;
      font-size: 14px; color: var(--text); font-weight: 500;
      transition: background 0.15s; border: none; background: none;
      width: 100%; font-family: inherit; text-align: left;
    }
    .nav-drawer-item:hover { background: var(--surface-hover); }
    .nav-drawer-item.active { background: rgba(124,58,237,0.12); color: var(--accent); }
    .nav-drawer-item.active svg { color: var(--accent); }
    .nav-drawer-item svg { flex-shrink: 0; color: var(--text2); }
    .nav-drawer-item.danger { color: var(--red); }
    .nav-drawer-item.danger svg { color: var(--red); }
    .nav-drawer-divider { height: 1px; background: var(--glass-border); margin: 8px 20px; }
    .nav-drawer-footer {
      margin-top: auto; padding: 16px 20px;
      border-top: 1px solid var(--glass-border);
      font-size: 11px; color: var(--text3); text-align: center;
    }

    /* ── Back Button (sub-pages) ── */
    .page-back-btn {
      display: inline-flex; align-items: center; gap: 6px;
      background: none; border: none; color: var(--text2);
      font-size: 13px; font-weight: 500; cursor: pointer;
      padding: 4px 0; font-family: inherit; transition: color 0.2s;
    }
    .page-back-btn:hover { color: var(--text); }

    /* ── Settings Page ── */
    .settings-section {
      background: var(--surface); border: 1px solid var(--glass-border);
      border-radius: var(--radius); padding: 20px; margin-bottom: 16px;
    }
    .settings-section-title {
      font-size: 15px; font-weight: 700; margin-bottom: 16px;
      display: flex; align-items: center; gap: 8px;
    }
    .settings-section-title svg { color: var(--accent2); }
    .settings-field {
      margin-bottom: 14px;
    }
    .settings-field:last-child { margin-bottom: 0; }
    .settings-field label {
      display: block; font-size: 12px; color: var(--text2);
      margin-bottom: 6px; font-weight: 500;
    }
    .settings-field select,
    .settings-field input[type="text"],
    .settings-field input[type="password"] {
      width: 100%; padding: 12px 14px;
      background: rgba(255,255,255,0.04);
      border: 1px solid rgba(255,255,255,0.08);
      border-radius: var(--radius-xs); color: var(--text);
      font-size: 14px; font-family: inherit; outline: none;
      transition: border-color 0.2s;
      -webkit-appearance: none; appearance: none;
    }
    .settings-field select {
      background-image: url("data:image/svg+xml,%3Csvg width='12' height='8' viewBox='0 0 12 8' fill='none' xmlns='http://www.w3.org/2000/svg'%3E%3Cpath d='M1 1.5L6 6.5L11 1.5' stroke='%238b92a5' stroke-width='1.5' stroke-linecap='round' stroke-linejoin='round'/%3E%3C/svg%3E");
      background-repeat: no-repeat;
      background-position: right 14px center;
      padding-right: 36px;
    }
    .settings-field select option {
      background: var(--bg2); color: var(--text);
    }
    .settings-field input:focus,
    .settings-field select:focus {
      border-color: var(--accent);
    }
    .settings-row {
      display: flex; gap: 12px;
    }
    .settings-row .settings-field { flex: 1; }
    .settings-btn {
      padding: 12px 24px; border-radius: var(--radius-xs);
      font-size: 13px; font-weight: 600; cursor: pointer;
      font-family: inherit; transition: all 0.2s; border: none;
    }
    .settings-btn:active { transform: scale(0.97); }
    .settings-btn-primary {
      background: var(--gradient2); color: white;
      box-shadow: 0 4px 16px rgba(124,58,237,0.25);
    }
    .settings-btn-secondary {
      background: rgba(255,255,255,0.06); color: var(--text);
      border: 1px solid rgba(255,255,255,0.08);
    }
    .settings-btn-full {
      width: 100%; padding: 16px;
      font-size: 15px; border-radius: var(--radius-sm);
    }

    /* ── Channel Toggle ── */
    .channel-toggle {
      display: flex; align-items: center; justify-content: space-between;
      padding: 10px 14px;
      background: rgba(255,255,255,0.02);
      border: 1px solid rgba(255,255,255,0.05);
      border-radius: var(--radius-xs);
      transition: all 0.2s;
    }
    .channel-toggle.active {
      border-color: rgba(124,58,237,0.3);
      background: rgba(124,58,237,0.06);
    }
    .channel-label {
      font-size: 12px; font-weight: 500; color: var(--text2);
      display: flex; align-items: center; gap: 6px;
    }
    .channel-toggle.active .channel-label { color: var(--text); }
    .toggle-switch {
      position: relative; width: 38px; height: 22px;
      background: rgba(255,255,255,0.1); border-radius: 11px;
      cursor: pointer; transition: background 0.25s; flex-shrink: 0;
    }
    .toggle-switch.on {
      background: var(--accent);
    }
    .toggle-switch::after {
      content: ''; position: absolute; top: 3px; left: 3px;
      width: 16px; height: 16px; background: white;
      border-radius: 50%; transition: transform 0.25s;
    }
    .toggle-switch.on::after {
      transform: translateX(16px);
    }
    .settings-saved-toast {
      position: fixed; bottom: 100px; left: 50%; transform: translateX(-50%) translateY(20px);
      background: var(--green); color: white;
      padding: 12px 24px; border-radius: 12px;
      font-size: 14px; font-weight: 600;
      box-shadow: 0 8px 32px rgba(16,185,129,0.3);
      opacity: 0; pointer-events: none;
      transition: all 0.3s ease; z-index: 300;
    }
    .settings-saved-toast.show {
      opacity: 1; transform: translateX(-50%) translateY(0);
    }

    /* ── Responsive ── */
    @media (min-width: 481px) {
      .app { border-left: 1px solid rgba(255,255,255,0.04); border-right: 1px solid rgba(255,255,255,0.04); }
    }
    @media (min-width: 768px) {
      body.app-mode { display: flex; align-items: center; justify-content: center; }
      .app { height: 100vh; max-height: 900px; border-radius: 32px; overflow: hidden; border: 1px solid rgba(255,255,255,0.06); }
    }

    /* ═══ Landing Page ═══ */
    .landing { display: none; min-height: 100vh; background: #030308; color: #e0e0e8; }
    .landing.active { display: block; }

    @keyframes holoSweep { 0% { background-position: 0% center; } 100% { background-position: 200% center; } }
    @keyframes cardGlint { 0% { transform: translateX(-100%) rotate(25deg); } 100% { transform: translateX(200%) rotate(25deg); } }
    @keyframes lpFloat { 0%, 100% { transform: translateY(0); } 50% { transform: translateY(-12px); } }
    @keyframes lpBlink { 50% { opacity: 0; } }
    .lp-cursor { animation: lpBlink 1s step-end infinite; }
    .lp-holo-text {
      background: linear-gradient(135deg, #00f2fe, #4facfe, #f093fb, #736efe, #00f2fe);
      background-size: 200% auto; animation: holoSweep 4s linear infinite;
      -webkit-background-clip: text; -webkit-text-fill-color: transparent; background-clip: text;
    }
    .lp-logo-mark {
      width: 42px; height: 42px; border-radius: 12px; position: relative;
      background: #fff;
      display: flex; align-items: center; justify-content: center;
      box-shadow: 0 0 16px rgba(255,255,255,0.15), 0 2px 8px rgba(0,0,0,0.3);
    }

    .lp-nav {
      position: fixed; top: 0; width: 100%; z-index: 50;
      transition: all 0.3s ease; padding: 20px 0;
    }
    .lp-nav.scrolled {
      background: rgba(3,3,8,0.92); backdrop-filter: blur(20px);
      border-bottom: 1px solid rgba(255,255,255,0.06); padding: 12px 0;
    }
    .lp-nav-inner {
      max-width: 1200px; margin: 0 auto; padding: 0 24px;
      display: flex; justify-content: space-between; align-items: center;
    }
    .lp-logo { display: flex; align-items: center; gap: 12px; cursor: pointer; }
    .lp-logo-text { font-family: 'Space Grotesk', sans-serif; font-size: 20px; font-weight: 700; color: #fff; letter-spacing: -0.5px; }
    .lp-nav-links { display: none; gap: 28px; font-size: 14px; font-weight: 500; }
    .lp-nav-links a { color: rgba(255,255,255,0.6); text-decoration: none; transition: color 0.2s; }
    .lp-nav-links a:hover { color: #fff; }
    @media (min-width: 768px) { .lp-nav-links { display: flex; } }
    .lp-nav-actions { display: flex; align-items: center; gap: 12px; }
    .lp-btn-primary {
      background: linear-gradient(135deg, #4facfe, #736efe); color: white; font-size: 14px; font-weight: 600;
      padding: 10px 20px; border-radius: 12px; border: none;
      cursor: pointer; transition: all 0.3s; box-shadow: 0 4px 16px rgba(79,172,254,0.25);
    }
    .lp-btn-primary:hover { transform: translateY(-1px); box-shadow: 0 6px 24px rgba(79,172,254,0.35); }
    .lp-btn-secondary {
      background: rgba(255,255,255,0.06); color: #fff; font-size: 14px; font-weight: 600;
      padding: 10px 20px; border-radius: 12px; border: 1px solid rgba(255,255,255,0.1);
      cursor: pointer; transition: all 0.3s;
    }
    .lp-btn-secondary:hover { background: rgba(255,255,255,0.1); border-color: rgba(255,255,255,0.2); }
    .lp-btn-signin {
      background: none; color: rgba(255,255,255,0.7); font-size: 14px; font-weight: 500;
      padding: 8px 16px; border: none; cursor: pointer; transition: color 0.2s;
    }
    .lp-btn-signin:hover { color: #fff; }

    .lp-hero {
      position: relative; padding: 140px 24px 80px; max-width: 1200px; margin: 0 auto; overflow: hidden;
    }
    .lp-hero-glow {
      position: absolute; top: -200px; right: -100px; width: 600px; height: 600px;
      background: radial-gradient(circle, rgba(79,172,254,0.08) 0%, rgba(240,147,251,0.04) 40%, transparent 70%);
      pointer-events: none;
    }
    .lp-hero-grid { display: grid; gap: 48px; align-items: center; }
    @media (min-width: 1024px) { .lp-hero-grid { grid-template-columns: 1fr 1fr; } }
    .lp-hero h1 {
      font-family: 'Space Grotesk', sans-serif;
      font-size: clamp(40px, 6vw, 68px); font-weight: 700; color: #fff;
      line-height: 1.08; letter-spacing: -2px; margin: 20px 0;
    }
    .lp-hero-desc { font-size: 18px; color: rgba(255,255,255,0.5); max-width: 480px; line-height: 1.7; margin-bottom: 32px; }
    .lp-hero-btns { display: flex; flex-wrap: wrap; gap: 12px; }
    .lp-hero-btns .lp-btn-primary { padding: 14px 28px; font-size: 16px; border-radius: 14px; display: flex; align-items: center; gap: 8px; }
    .lp-hero-btns .lp-btn-secondary { padding: 14px 28px; font-size: 16px; border-radius: 14px; }

    .lp-terminal { position: relative; }
    .lp-terminal-inner {
      background: rgba(255,255,255,0.02); border: 1px solid rgba(255,255,255,0.06);
      border-radius: 20px; overflow: hidden;
    }
    .lp-terminal-header {
      background: rgba(255,255,255,0.02); border-bottom: 1px solid rgba(255,255,255,0.06);
      padding: 12px 16px; display: flex; align-items: center; justify-content: space-between;
    }
    .lp-terminal-header-left { display: flex; align-items: center; gap: 10px; }
    .lp-terminal-title { font-size: 12px; font-family: 'JetBrains Mono', monospace; color: rgba(255,255,255,0.35); }
    .lp-terminal-dots { display: flex; gap: 6px; }
    .lp-terminal-dots span { width: 10px; height: 10px; border-radius: 50%; background: rgba(255,255,255,0.08); }
    .lp-terminal-body { padding: 24px; font-family: 'JetBrains Mono', monospace; }

    /* ═══ Friendly AI Agent ═══ */
    @keyframes agentFloat { 0%, 100% { transform: translateY(0); } 50% { transform: translateY(-14px); } }
    @keyframes agentShimmer { 0% { transform: translateX(-100%); } 100% { transform: translateX(300%); } }
    .agent-section { display: flex; flex-direction: column; align-items: center; gap: 16px; }
    .agent-wrapper {
      position: relative; width: 220px; height: 280px;
      display: flex; flex-direction: column; align-items: center; justify-content: center;
    }
    .agent-shadow {
      position: absolute; bottom: 12px; width: 100px; height: 10px;
      background: rgba(79,172,254,0.12); filter: blur(14px); border-radius: 50%;
    }
    .agent-body { position: relative; animation: agentFloat 5s ease-in-out infinite; }
    .agent-capsule {
      position: relative; width: 140px; height: 180px;
      background: rgba(255,255,255,0.93); border-radius: 70px;
      box-shadow: 0 24px 60px rgba(0,0,0,0.35), 0 0 60px rgba(79,172,254,0.08);
      border: 1px solid rgba(255,255,255,0.4);
      overflow: hidden; display: flex; flex-direction: column;
      align-items: center; justify-content: center;
    }
    .agent-glow {
      position: absolute; inset: 0; opacity: 0.15; border-radius: 70px;
      background: #22d3ee; transition: background 0.8s;
    }
    .agent-glow.thinking { background: #fbbf24; }
    .agent-glow.success { background: #34d399; }
    .agent-face {
      position: relative; z-index: 2; display: flex; flex-direction: column;
      align-items: center; gap: 22px;
    }
    .agent-eyes { display: flex; gap: 26px; transition: transform 0.15s ease-out; }
    .agent-eye {
      width: 11px; height: 11px; background: #1e293b; border-radius: 50%;
      position: relative; transition: transform 0.15s;
    }
    .agent-eye.blink { transform: scaleY(0.1); }
    .agent-eye-sparkle {
      position: absolute; top: 1px; right: 1px; width: 3px; height: 3px;
      background: white; border-radius: 50%; opacity: 0.7;
    }
    .agent-mouth {
      width: 38px; height: 5px; background: #e2e8f0; border-radius: 3px; overflow: hidden;
    }
    .agent-mouth-fill {
      height: 100%; width: 33%; background: #22d3ee; border-radius: 3px;
      transition: all 0.5s;
    }
    .agent-mouth-fill.thinking { width: 100%; background: #fbbf24; animation: pulse 1.5s ease infinite; }
    .agent-mouth-fill.success { width: 100%; background: #34d399; }
    .agent-reflection {
      position: absolute; inset: 0; border-radius: 70px;
      background: linear-gradient(135deg, transparent 30%, rgba(255,255,255,0.35) 50%, rgba(255,255,255,0.08) 80%);
      pointer-events: none; z-index: 3;
    }
    .agent-icons {
      position: absolute; right: -36px; top: 28%; display: flex;
      flex-direction: column; gap: 12px;
    }
    .agent-icon-bubble {
      width: 34px; height: 34px; background: rgba(255,255,255,0.92);
      border-radius: 11px; display: flex; align-items: center; justify-content: center;
      box-shadow: 0 6px 20px rgba(0,0,0,0.18); border: 1px solid rgba(255,255,255,0.4);
      transition: all 0.5s; font-size: 15px;
    }
    .agent-icon-bubble.hide { transform: translateX(16px); opacity: 0; }

    /* Agent Chat Panel */
    .agent-chat {
      width: 100%; background: rgba(255,255,255,0.03);
      border: 1px solid rgba(255,255,255,0.07); border-radius: 24px;
      padding: 20px; overflow: hidden;
    }
    .agent-chat-header {
      display: flex; align-items: center; gap: 12px;
      padding-bottom: 14px; border-bottom: 1px solid rgba(255,255,255,0.06);
    }
    .agent-chat-status-icon {
      width: 38px; height: 38px; border-radius: 12px;
      display: flex; align-items: center; justify-content: center;
      transition: background 0.4s;
    }
    .agent-chat-status-icon.greeting { background: rgba(34,211,238,0.1); }
    .agent-chat-status-icon.thinking { background: rgba(251,191,36,0.1); }
    .agent-chat-status-icon.success { background: rgba(52,211,153,0.1); }
    .agent-chat-title { font-size: 14px; font-weight: 700; color: #fff; }
    .agent-chat-subtitle { font-size: 11px; color: rgba(255,255,255,0.35); margin-top: 2px; }
    .agent-chat-progress {
      height: 3px; background: rgba(255,255,255,0.05); border-radius: 2px;
      overflow: hidden; margin-top: 14px;
    }
    .agent-chat-progress-fill {
      height: 100%; width: 0; background: linear-gradient(90deg, #22d3ee, #4facfe);
      border-radius: 2px; transition: width 2s ease;
    }
    .agent-chat-progress-fill.active { width: 100%; }
    .agent-messages {
      display: flex; flex-direction: column; gap: 8px; margin-top: 14px;
      max-height: 200px; overflow-y: auto; scrollbar-width: none;
    }
    .agent-messages::-webkit-scrollbar { display: none; }
    .agent-msg {
      padding: 10px 14px; border-radius: 14px; font-size: 13px;
      line-height: 1.5; max-width: 88%; opacity: 0; transform: translateY(8px);
      animation: agentMsgIn 0.4s ease forwards;
    }
    @keyframes agentMsgIn { to { opacity: 1; transform: translateY(0); } }
    .agent-msg.user {
      background: linear-gradient(135deg, #4facfe, #736efe); color: white;
      align-self: flex-end; border-bottom-right-radius: 4px;
    }
    .agent-msg.ai {
      background: rgba(255,255,255,0.06); color: rgba(255,255,255,0.8);
      align-self: flex-start; border-bottom-left-radius: 4px;
    }
    .agent-msg.typing-msg {
      background: rgba(255,255,255,0.06); align-self: flex-start;
      border-bottom-left-radius: 4px; display: flex; gap: 5px; padding: 14px 18px;
    }
    .agent-typing-dot {
      width: 6px; height: 6px; background: rgba(255,255,255,0.3);
      border-radius: 50%; animation: typingBounce 1.4s ease-in-out infinite;
    }
    .agent-typing-dot:nth-child(2) { animation-delay: 0.2s; }
    .agent-typing-dot:nth-child(3) { animation-delay: 0.4s; }

    /* ═══ Features ═══ */
    .lp-features { padding: 80px 24px; }
    .lp-features-inner { max-width: 1200px; margin: 0 auto; }
    .lp-features-header { text-align: center; margin-bottom: 48px; }
    .lp-features-title {
      font-family: 'Space Grotesk', sans-serif;
      font-size: 32px; font-weight: 700; color: #fff; margin-bottom: 12px;
    }
    .lp-features-subtitle { font-size: 16px; color: rgba(255,255,255,0.4); max-width: 500px; margin: 0 auto; }
    .lp-features-grid { display: grid; gap: 16px; }
    @media (min-width: 768px) { .lp-features-grid { grid-template-columns: repeat(3, 1fr); } }
    .lp-feature-card {
      background: rgba(255,255,255,0.02); border: 1px solid rgba(255,255,255,0.06);
      padding: 28px; border-radius: 20px; transition: all 0.3s;
    }
    .lp-feature-card:hover {
      background: rgba(255,255,255,0.04); border-color: rgba(255,255,255,0.12);
      transform: translateY(-2px);
    }
    .lp-feature-emoji { font-size: 28px; margin-bottom: 16px; display: block; }
    .lp-feature-title {
      font-family: 'Space Grotesk', sans-serif;
      font-size: 17px; font-weight: 700; color: #fff; margin-bottom: 8px;
    }
    .lp-feature-desc { font-size: 14px; color: rgba(255,255,255,0.4); line-height: 1.6; }

    /* ═══ Showcase / How it works ═══ */
    .lp-showcase { padding: 80px 24px; }
    .lp-showcase-inner {
      max-width: 1200px; margin: 0 auto;
      display: grid; gap: 48px; align-items: center;
    }
    @media (min-width: 1024px) { .lp-showcase-inner { grid-template-columns: 1fr 1fr; } }
    .lp-showcase-left h2 {
      font-family: 'Space Grotesk', sans-serif;
      font-size: 32px; font-weight: 700; color: #fff; margin-bottom: 12px;
    }
    .lp-showcase-left p { font-size: 16px; color: rgba(255,255,255,0.4); line-height: 1.7; margin-bottom: 24px; }
    .lp-showcase-steps { display: flex; flex-direction: column; gap: 16px; }
    .lp-step {
      display: flex; align-items: center; gap: 16px; padding: 16px 20px;
      background: rgba(255,255,255,0.02); border: 1px solid rgba(255,255,255,0.06);
      border-radius: 16px; transition: all 0.3s;
    }
    .lp-step:hover { background: rgba(255,255,255,0.04); }
    .lp-step-num {
      width: 36px; height: 36px; border-radius: 10px; flex-shrink: 0;
      background: linear-gradient(135deg, #4facfe, #736efe);
      display: flex; align-items: center; justify-content: center;
      font-size: 14px; font-weight: 700; color: white;
    }
    .lp-step-text { font-size: 14px; color: rgba(255,255,255,0.7); }
    .lp-step-text strong { color: #fff; }

    /* Holographic Card */
    .lp-holo-card {
      width: 100%; max-width: 380px; aspect-ratio: 1.586; border-radius: 20px;
      background: linear-gradient(135deg, #0a0a1a 0%, #1a1040 50%, #0a0a1a 100%);
      border: 1px solid rgba(255,255,255,0.08);
      padding: 28px; position: relative; overflow: hidden;
      box-shadow: 0 24px 60px rgba(0,0,0,0.5);
      animation: lpFloat 5s ease-in-out infinite; margin: 0 auto;
    }
    .lp-holo-card-glint {
      position: absolute; top: 0; left: -50%; width: 50%; height: 200%;
      background: linear-gradient(90deg, transparent, rgba(255,255,255,0.05), transparent);
      animation: cardGlint 4s ease-in-out infinite; pointer-events: none;
    }
    .lp-holo-card-chip {
      width: 36px; height: 28px; border-radius: 6px;
      background: linear-gradient(135deg, #d4a853, #f0d78c, #d4a853);
      position: absolute; top: 28px; right: 28px;
    }
    .lp-holo-card-logo {
      font-family: 'Space Grotesk', sans-serif; font-weight: 700; font-size: 20px; margin-bottom: 32px;
    }
    .lp-holo-card-number {
      font-family: 'JetBrains Mono', monospace; font-size: 18px;
      letter-spacing: 3px; color: rgba(255,255,255,0.7); margin-bottom: 20px;
    }
    .lp-holo-card-footer { display: flex; justify-content: space-between; align-items: flex-end; }
    .lp-holo-card-label {
      font-size: 10px; text-transform: uppercase; letter-spacing: 2px;
      color: rgba(255,255,255,0.3); margin-bottom: 4px;
    }
    .lp-holo-card-value { font-size: 14px; color: rgba(255,255,255,0.8); }

    /* ═══ Footer ═══ */
    .lp-footer { padding: 48px 24px; border-top: 1px solid rgba(255,255,255,0.04); }
    .lp-footer-inner {
      max-width: 1200px; margin: 0 auto;
      display: flex; flex-direction: column; align-items: center; gap: 24px;
    }
    @media (min-width: 768px) { .lp-footer-inner { flex-direction: row; justify-content: space-between; } }
    .lp-footer-brand { display: flex; align-items: center; gap: 12px; }
    .lp-footer-links { display: flex; gap: 28px; }
    .lp-footer-links a { font-size: 13px; color: rgba(255,255,255,0.3); text-decoration: none; transition: color 0.2s; }
    .lp-footer-links a:hover { color: rgba(255,255,255,0.7); }
    .lp-footer-copy {
      max-width: 1200px; margin: 24px auto 0; padding-top: 24px;
      border-top: 1px solid rgba(255,255,255,0.04); text-align: center;
    }
    .lp-footer-copy p { font-size: 13px; color: rgba(255,255,255,0.2); }
  </style>
</head>
<body class="landing-mode">

<!-- ═══ Landing Page ═══ -->
<div class="landing active" id="landing-page">

  <!-- Nav -->
  <nav class="lp-nav" id="lp-nav">
    <div class="lp-nav-inner">
      <div class="lp-logo">
        <div class="lp-logo-mark"><svg width="28" height="28" viewBox="0 0 40 40" fill="none"><rect x="4" y="4" width="10" height="10" rx="2" fill="#0a0a14"/><rect x="6" y="6" width="6" height="6" rx="1" fill="white"/><rect x="7.5" y="7.5" width="3" height="3" fill="#0a0a14"/><rect x="26" y="4" width="10" height="10" rx="2" fill="#0a0a14"/><rect x="28" y="28" width="6" height="6" rx="1" fill="white"/><rect x="29.5" y="29.5" width="3" height="3" fill="#0a0a14"/><rect x="4" y="26" width="10" height="10" rx="2" fill="#0a0a14"/><rect x="6" y="28" width="6" height="6" rx="1" fill="white"/><rect x="7.5" y="29.5" width="3" height="3" fill="#0a0a14"/><path d="M2 20 L10 20 L13 12 L17 28 L21 16 L24 24 L27 20 L38 20" stroke="#0a0a14" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/><circle cx="20" cy="20" r="2.5" fill="#0a0a14"/></svg></div>
        <span class="lp-logo-text">PromptPay</span>
      </div>
      <div class="lp-nav-links">
        <a href="#features">Features</a>
        <a href="#how-it-works">How it works</a>
      </div>
      <div class="lp-nav-actions">
        <button class="lp-btn-signin" onclick="showAuthGate('login')">Sign in</button>
        <button class="lp-btn-primary" onclick="showAuthGate('register')">Get Started</button>
      </div>
    </div>
  </nav>

  <!-- Hero -->
  <section class="lp-hero">
    <div class="lp-hero-glow"></div>
    <div class="lp-hero-grid">
      <div>
        <h1>Just say it.<br><span class="lp-holo-text">We'll handle it.</span></h1>
        <p class="lp-hero-desc">Pay bills, send money, and manage your finances — all through simple prompts. Your AI-powered financial assistant that actually gets things done.</p>
        <div class="lp-hero-btns">
          <button class="lp-btn-primary" onclick="showAuthGate('register')">
            Start for free
            <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="5" y1="12" x2="19" y2="12"/><polyline points="12 5 19 12 12 19"/></svg>
          </button>
          <button class="lp-btn-secondary" onclick="showAuthGate('login')">Sign in</button>
        </div>
      </div>

      <!-- AI Agent + Live Chat -->
      <div class="agent-section">
        <div class="agent-wrapper" id="agent-wrapper">
          <div class="agent-shadow"></div>
          <div class="agent-body">
            <div class="agent-capsule">
              <div class="agent-glow" id="agent-glow"></div>
              <div class="agent-face">
                <div class="agent-eyes" id="agent-eyes">
                  <div class="agent-eye"><div class="agent-eye-sparkle"></div></div>
                  <div class="agent-eye"><div class="agent-eye-sparkle"></div></div>
                </div>
                <div class="agent-mouth"><div class="agent-mouth-fill" id="agent-mouth-fill"></div></div>
              </div>
              <div class="agent-reflection"></div>
            </div>
            <div class="agent-icons">
              <div class="agent-icon-bubble">&#128176;</div>
              <div class="agent-icon-bubble">&#128179;</div>
            </div>
          </div>
        </div>

        <!-- Chat Panel -->
        <div class="agent-chat">
          <div class="agent-chat-header">
            <div class="agent-chat-status-icon greeting" id="agent-status-icon">
              <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="#22d3ee" stroke-width="2"><polygon points="12 2 15.09 8.26 22 9.27 17 14.14 18.18 21.02 12 17.77 5.82 21.02 7 14.14 2 9.27 8.91 8.26 12 2"/></svg>
            </div>
            <div>
              <div class="agent-chat-title" id="agent-chat-title">Welcome to PromptPay!</div>
              <div class="agent-chat-subtitle" id="agent-chat-subtitle">Your AI financial assistant</div>
            </div>
          </div>
          <div class="agent-messages" id="agent-messages"></div>
          <div class="agent-chat-progress">
            <div class="agent-chat-progress-fill" id="agent-progress-fill"></div>
          </div>
        </div>
      </div>
    </div>
  </section>

  <!-- Features -->
  <section class="lp-features" id="features">
    <div class="lp-features-inner">
      <div class="lp-features-header">
        <div class="lp-features-title">Everything you need</div>
        <div class="lp-features-subtitle">Powerful features wrapped in simplicity</div>
      </div>
      <div class="lp-features-grid">
        <div class="lp-feature-card">
          <span class="lp-feature-emoji">&#128172;</span>
          <div class="lp-feature-title">Natural Language</div>
          <div class="lp-feature-desc">Just type what you want. Our AI understands context, amounts, and recipients instantly.</div>
        </div>
        <div class="lp-feature-card">
          <span class="lp-feature-emoji">&#9889;</span>
          <div class="lp-feature-title">Instant Transfers</div>
          <div class="lp-feature-desc">Send money to anyone in seconds. No routing numbers, no forms, no friction.</div>
        </div>
        <div class="lp-feature-card">
          <span class="lp-feature-emoji">&#128179;</span>
          <div class="lp-feature-title">Smart Wallet</div>
          <div class="lp-feature-desc">Link cards, track spending, and manage multiple currencies in one place.</div>
        </div>
        <div class="lp-feature-card">
          <span class="lp-feature-emoji">&#128274;</span>
          <div class="lp-feature-title">Bank-Grade Security</div>
          <div class="lp-feature-desc">256-bit encryption, biometric auth, and real-time fraud detection keep you safe.</div>
        </div>
        <div class="lp-feature-card">
          <span class="lp-feature-emoji">&#128241;</span>
          <div class="lp-feature-title">Pay Bills Easily</div>
          <div class="lp-feature-desc">Utilities, airtime, subscriptions — pay any bill with a simple prompt.</div>
        </div>
        <div class="lp-feature-card">
          <span class="lp-feature-emoji">&#127760;</span>
          <div class="lp-feature-title">Global Coverage</div>
          <div class="lp-feature-desc">Send money across borders. Support for 50+ countries and growing.</div>
        </div>
      </div>
    </div>
  </section>

  <!-- How it works -->
  <section class="lp-showcase" id="how-it-works">
    <div class="lp-showcase-inner">
      <div class="lp-showcase-left">
        <h2>Three steps. That's it.</h2>
        <p>No apps to download, no forms to fill. Just tell our AI what you need.</p>
        <div class="lp-showcase-steps">
          <div class="lp-step">
            <div class="lp-step-num">1</div>
            <div class="lp-step-text"><strong>Type your request</strong> — "Send $50 to Sarah" or "Pay my electric bill"</div>
          </div>
          <div class="lp-step">
            <div class="lp-step-num">2</div>
            <div class="lp-step-text"><strong>AI verifies intent</strong> — confirms amount, recipient, and method</div>
          </div>
          <div class="lp-step">
            <div class="lp-step-num">3</div>
            <div class="lp-step-text"><strong>Done</strong> — funds sent instantly with real-time confirmation</div>
          </div>
        </div>
      </div>

      <!-- Holographic Payment Card -->
      <div style="display:flex;justify-content:center">
        <div class="lp-holo-card">
          <div class="lp-holo-card-glint"></div>
          <div class="lp-holo-card-chip"></div>
          <div class="lp-holo-card-logo lp-holo-text">PromptPay</div>
          <div class="lp-holo-card-number">4242 &bull;&bull;&bull;&bull; &bull;&bull;&bull;&bull; 8910</div>
          <div class="lp-holo-card-footer">
            <div>
              <div class="lp-holo-card-label">Card Holder</div>
              <div class="lp-holo-card-value">ALEX MORGAN</div>
            </div>
            <div>
              <div class="lp-holo-card-label">Expires</div>
              <div class="lp-holo-card-value">12/28</div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </section>

  <!-- Footer -->
  <footer class="lp-footer">
    <div class="lp-footer-inner">
      <div class="lp-footer-brand">
        <div class="lp-logo-mark" style="width:32px;height:32px;border-radius:10px"><svg width="22" height="22" viewBox="0 0 40 40" fill="none"><rect x="4" y="4" width="10" height="10" rx="2" fill="#0a0a14"/><rect x="6" y="6" width="6" height="6" rx="1" fill="white"/><rect x="7.5" y="7.5" width="3" height="3" fill="#0a0a14"/><rect x="26" y="4" width="10" height="10" rx="2" fill="#0a0a14"/><rect x="28" y="28" width="6" height="6" rx="1" fill="white"/><rect x="29.5" y="29.5" width="3" height="3" fill="#0a0a14"/><rect x="4" y="26" width="10" height="10" rx="2" fill="#0a0a14"/><rect x="6" y="28" width="6" height="6" rx="1" fill="white"/><rect x="7.5" y="29.5" width="3" height="3" fill="#0a0a14"/><path d="M2 20 L10 20 L13 12 L17 28 L21 16 L24 24 L27 20 L38 20" stroke="#0a0a14" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/><circle cx="20" cy="20" r="2.5" fill="#0a0a14"/></svg></div>
        <div>
          <span style="font-family:'Space Grotesk',sans-serif;font-size:16px;font-weight:700;color:#fff">PromptPay</span>
          <p style="font-size:12px;color:rgba(255,255,255,0.25);margin-top:2px">AI-powered payments</p>
        </div>
      </div>
      <div class="lp-footer-links">
        <a href="#">Privacy</a>
        <a href="#">Security</a>
        <a href="#">Terms</a>
        <a href="#">Status</a>
      </div>
    </div>
    <div class="lp-footer-copy">
      <p>&copy; 2025 PromptPay Inc. All rights reserved.</p>
    </div>
  </footer>
</div>

<!-- Auth Gate -->
<div class="auth-gate hidden" id="auth-gate">
  <div class="auth-card">
    <div class="auth-brand">
      <div class="auth-brand-icon"><div class="lp-logo-mark" style="width:48px;height:48px;border-radius:16px"><svg width="32" height="32" viewBox="0 0 40 40" fill="none"><rect x="4" y="4" width="10" height="10" rx="2" fill="#0a0a14"/><rect x="6" y="6" width="6" height="6" rx="1" fill="white"/><rect x="7.5" y="7.5" width="3" height="3" fill="#0a0a14"/><rect x="26" y="4" width="10" height="10" rx="2" fill="#0a0a14"/><rect x="28" y="28" width="6" height="6" rx="1" fill="white"/><rect x="29.5" y="29.5" width="3" height="3" fill="#0a0a14"/><rect x="4" y="26" width="10" height="10" rx="2" fill="#0a0a14"/><rect x="6" y="28" width="6" height="6" rx="1" fill="white"/><rect x="7.5" y="29.5" width="3" height="3" fill="#0a0a14"/><path d="M2 20 L10 20 L13 12 L17 28 L21 16 L24 24 L27 20 L38 20" stroke="#0a0a14" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/><circle cx="20" cy="20" r="2.5" fill="#0a0a14"/></svg></div></div>
      <div class="auth-brand-name">PromptPay</div>
      <div class="auth-brand-tagline">AI-Powered Financial Assistant</div>
    </div>
    <div class="auth-tabs">
      <button class="auth-tab active" onclick="switchAuthTab('login')">Sign In</button>
      <button class="auth-tab" onclick="switchAuthTab('register')">Register</button>
    </div>
    <!-- Login Form -->
    <form class="auth-form active" id="auth-login-form" onsubmit="handleLogin(event)">
      <div class="auth-field">
        <label>Email</label>
        <input type="email" id="login-email" placeholder="info@upromptpay.com" required autocomplete="email">
      </div>
      <div class="auth-field">
        <label>Password</label>
        <div class="pw-wrapper">
          <input type="password" id="login-password" placeholder="Enter your password" required autocomplete="current-password">
          <button type="button" class="pw-toggle" onclick="togglePassword('login-password', this)" aria-label="Show password">
            <svg class="eye-open" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"/><circle cx="12" cy="12" r="3"/></svg>
            <svg class="eye-closed" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="display:none"><path d="M17.94 17.94A10.07 10.07 0 0112 20c-7 0-11-8-11-8a18.45 18.45 0 015.06-5.94M9.9 4.24A9.12 9.12 0 0112 4c7 0 11 8 11 8a18.5 18.5 0 01-2.16 3.19m-6.72-1.07a3 3 0 11-4.24-4.24"/><line x1="1" y1="1" x2="23" y2="23"/></svg>
          </button>
        </div>
      </div>
      <button type="submit" class="auth-submit" id="login-submit">Sign In</button>
      <div class="auth-error" id="login-error"></div>
    </form>
    <!-- Register Form -->
    <form class="auth-form" id="auth-register-form" onsubmit="handleRegister(event)">
      <div class="auth-field">
        <label>Display Name</label>
        <input type="text" id="register-name" placeholder="Your name" required autocomplete="name">
      </div>
      <div class="auth-field">
        <label>Email</label>
        <input type="email" id="register-email" placeholder="info@upromptpay.com" required autocomplete="email">
      </div>
      <div class="auth-field">
        <label>Country</label>
        <select id="register-country" required style="width:100%;padding:14px 16px;background:rgba(255,255,255,0.04);border:1px solid rgba(255,255,255,0.08);border-radius:12px;color:var(--text);font-size:14px;font-family:inherit;outline:none;-webkit-appearance:none;appearance:none;">
          <option value="">Select your country</option>
          <optgroup label="Africa">
            <option value="NG">Nigeria</option>
            <option value="GH">Ghana</option>
            <option value="KE">Kenya</option>
            <option value="UG">Uganda</option>
            <option value="ZA">South Africa</option>
            <option value="TZ">Tanzania</option>
            <option value="CM">Cameroon</option>
            <option value="CI">Ivory Coast</option>
            <option value="SN">Senegal</option>
            <option value="ET">Ethiopia</option>
          </optgroup>
          <optgroup label="Americas">
            <option value="US">United States</option>
            <option value="CA">Canada</option>
            <option value="MX">Mexico</option>
            <option value="BR">Brazil</option>
          </optgroup>
          <optgroup label="Europe">
            <option value="GB">United Kingdom</option>
            <option value="DE">Germany</option>
            <option value="FR">France</option>
            <option value="IT">Italy</option>
            <option value="ES">Spain</option>
            <option value="NL">Netherlands</option>
          </optgroup>
          <optgroup label="Asia & Pacific">
            <option value="IN">India</option>
            <option value="PH">Philippines</option>
            <option value="AU">Australia</option>
            <option value="JP">Japan</option>
          </optgroup>
        </select>
      </div>
      <div class="auth-field">
        <label>Password</label>
        <div class="pw-wrapper">
          <input type="password" id="register-password" placeholder="Create a password" required minlength="6" autocomplete="new-password">
          <button type="button" class="pw-toggle" onclick="togglePassword('register-password', this)" aria-label="Show password">
            <svg class="eye-open" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"/><circle cx="12" cy="12" r="3"/></svg>
            <svg class="eye-closed" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="display:none"><path d="M17.94 17.94A10.07 10.07 0 0112 20c-7 0-11-8-11-8a18.45 18.45 0 015.06-5.94M9.9 4.24A9.12 9.12 0 0112 4c7 0 11 8 11 8a18.5 18.5 0 01-2.16 3.19m-6.72-1.07a3 3 0 11-4.24-4.24"/><line x1="1" y1="1" x2="23" y2="23"/></svg>
          </button>
        </div>
      </div>
      <button type="submit" class="auth-submit" id="register-submit">Create Account</button>
      <div class="auth-error" id="register-error"></div>
    </form>
    <div style="text-align:center;margin-top:20px">
      <button onclick="showLanding();startLandingTyping()" style="background:none;border:none;color:var(--text3);font-size:13px;cursor:pointer;font-family:inherit">
        <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="vertical-align:-2px;margin-right:4px"><line x1="19" y1="12" x2="5" y2="12"/><polyline points="12 19 5 12 12 5"/></svg>
        Back to home
      </button>
    </div>
  </div>
</div>

<div class="app" id="app">

  <!-- Header -->
  <div class="header">
    <div class="header-left">
      <button class="hamburger-btn" onclick="openNavDrawer()" aria-label="Menu">
        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"><line x1="3" y1="6" x2="21" y2="6"/><line x1="3" y1="12" x2="21" y2="12"/><line x1="3" y1="18" x2="21" y2="18"/></svg>
      </button>
      <div class="header-avatar lp-logo-mark" style="width:36px;height:36px;border-radius:10px;font-size:16px"><svg width="22" height="22" viewBox="0 0 40 40" fill="none"><rect x="4" y="4" width="10" height="10" rx="2" fill="#0a0a14"/><rect x="6" y="6" width="6" height="6" rx="1" fill="white"/><rect x="7.5" y="7.5" width="3" height="3" fill="#0a0a14"/><rect x="26" y="4" width="10" height="10" rx="2" fill="#0a0a14"/><rect x="28" y="6" width="6" height="6" rx="1" fill="white"/><rect x="29.5" y="7.5" width="3" height="3" fill="#0a0a14"/><rect x="4" y="26" width="10" height="10" rx="2" fill="#0a0a14"/><rect x="6" y="28" width="6" height="6" rx="1" fill="white"/><rect x="7.5" y="29.5" width="3" height="3" fill="#0a0a14"/><path d="M2 20 L10 20 L13 12 L17 28 L21 16 L24 24 L27 20 L38 20" stroke="#0a0a14" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/><circle cx="20" cy="20" r="2.5" fill="#0a0a14"/></svg></div>
      <div>
        <div class="header-greeting">Good <span id="time-greeting">evening</span></div>
        <div class="header-name">PromptPay</div>
      </div>
    </div>
    <div class="header-right">
      <div class="header-btn" onclick="showNotifications()" style="position:relative">
        <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M18 8A6 6 0 0 0 6 8c0 7-3 9-3 9h18s-3-2-3-9"/><path d="M13.73 21a2 2 0 0 1-3.46 0"/></svg>
        <div class="dot"></div>
      </div>
    </div>
  </div>

  <!-- Navigation Drawer -->
  <div class="nav-drawer-overlay" id="nav-drawer-overlay" onclick="closeNavDrawer()">
    <div class="nav-drawer" onclick="event.stopPropagation()">
      <div class="nav-drawer-header">
        <div class="drawer-logo lp-logo-mark"><svg width="22" height="22" viewBox="0 0 40 40" fill="none"><rect x="4" y="4" width="10" height="10" rx="2" fill="#0a0a14"/><rect x="6" y="6" width="6" height="6" rx="1" fill="white"/><rect x="7.5" y="7.5" width="3" height="3" fill="#0a0a14"/><rect x="26" y="4" width="10" height="10" rx="2" fill="#0a0a14"/><rect x="28" y="6" width="6" height="6" rx="1" fill="white"/><rect x="29.5" y="7.5" width="3" height="3" fill="#0a0a14"/><rect x="4" y="26" width="10" height="10" rx="2" fill="#0a0a14"/><rect x="6" y="28" width="6" height="6" rx="1" fill="white"/><rect x="7.5" y="29.5" width="3" height="3" fill="#0a0a14"/><path d="M2 20 L10 20 L13 12 L17 28 L21 16 L24 24 L27 20 L38 20" stroke="#0a0a14" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/><circle cx="20" cy="20" r="2.5" fill="#0a0a14"/></svg></div>
        <div class="drawer-info">
          <div class="drawer-name" id="drawer-user-name">PromptPay</div>
          <div class="drawer-email" id="drawer-user-email"></div>
        </div>
      </div>
      <div class="nav-drawer-section">
        <div class="nav-drawer-section-label">Main</div>
        <button class="nav-drawer-item active" data-drawer="home" onclick="drawerNav('home')">
          <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"/><polyline points="9 22 9 12 15 12 15 22"/></svg>
          Home
        </button>
        <button class="nav-drawer-item" data-drawer="activity" onclick="drawerNav('activity')">
          <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="22 12 18 12 15 21 9 3 6 12 2 12"/></svg>
          Activity
        </button>
        <button class="nav-drawer-item" data-drawer="ai" onclick="drawerNav('ai')">
          <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"/></svg>
          AI Assistant
        </button>
        <button class="nav-drawer-item" data-drawer="wallet" onclick="drawerNav('wallet')">
          <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 12V7H5a2 2 0 0 1 0-4h14v4"/><path d="M3 5v14a2 2 0 0 0 2 2h16v-5"/><circle cx="18" cy="16" r="1"/></svg>
          Wallet
        </button>
      </div>
      <div class="nav-drawer-divider"></div>
      <div class="nav-drawer-section">
        <div class="nav-drawer-section-label">Money</div>
        <button class="nav-drawer-item" onclick="closeNavDrawer(); openSendModal();">
          <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="22" y1="2" x2="11" y2="13"/><polygon points="22 2 15 22 11 13 2 9 22 2"/></svg>
          Send Money
        </button>
        <button class="nav-drawer-item" onclick="closeNavDrawer(); openRequestModal();">
          <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="23 6 13.5 15.5 8.5 10.5 1 18"/><polyline points="17 6 23 6 23 12"/></svg>
          Request Money
        </button>
        <button class="nav-drawer-item" onclick="closeNavDrawer(); showQrModal();">
          <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="3" width="7" height="7"/><rect x="14" y="3" width="7" height="7"/><rect x="3" y="14" width="7" height="7"/><rect x="14" y="14" width="3" height="3"/><line x1="21" y1="14" x2="21" y2="21"/><line x1="14" y1="21" x2="21" y2="21"/></svg>
          QR Code
        </button>
      </div>
      <div class="nav-drawer-divider"></div>
      <div class="nav-drawer-section">
        <div class="nav-drawer-section-label">Account</div>
        <button class="nav-drawer-item" data-drawer="profile" onclick="drawerNav('profile')">
          <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"/><circle cx="12" cy="7" r="4"/></svg>
          Profile
        </button>
        <button class="nav-drawer-item" data-drawer="settings" onclick="drawerNav('settings')">
          <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="3"/><path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1-2.83 2.83l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-4 0v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83-2.83l.06-.06A1.65 1.65 0 0 0 4.68 15a1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1 0-4h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 2.83-2.83l.06.06A1.65 1.65 0 0 0 9 4.68a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 4 0v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 2.83l-.06.06A1.65 1.65 0 0 0 19.4 9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 0 4h-.09a1.65 1.65 0 0 0-1.51 1z"/></svg>
          Settings
        </button>
        <button class="nav-drawer-item danger" onclick="closeNavDrawer(); handleLogout();">
          <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"/><polyline points="16 17 21 12 16 7"/><line x1="21" y1="12" x2="9" y2="12"/></svg>
          Logout
        </button>
      </div>
      <div class="nav-drawer-footer">PromptPay v2.0</div>
    </div>
  </div>

  <!-- Pages -->
  <div class="pages">

    <!-- HOME -->
    <div class="page active" id="page-home">
      <div class="balance-card fade-up">
        <div class="balance-label">Total Balance</div>
        <div class="balance-amount" id="balance-display">$0.00</div>
        <div class="balance-change">
          <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3"><polyline points="18 15 12 9 6 15"/></svg>
          <span id="balance-change">+$0.00 today</span>
        </div>
        <div id="paytag-display" style="margin: 8px 0; display: none;">
          <span style="font-size: 1.1rem; font-weight: 600; color: #7c3aed; cursor: pointer;" onclick="copyPaytag()">
            <span id="user-paytag">$yourname</span> <span style="font-size: 0.75rem; opacity: 0.6;">tap to copy</span>
          </span>
        </div>
        <div class="balance-actions">
          <button class="bal-btn bal-btn-primary" onclick="openSendModal()">
            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><line x1="22" y1="2" x2="11" y2="13"/><polygon points="22 2 15 22 11 13 2 9 22 2"/></svg>
            Send
          </button>
          <button class="bal-btn bal-btn-secondary" onclick="openRequestModal()">
            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><polyline points="1 4 1 10 7 10"/><path d="M3.51 15a9 9 0 1 0 2.13-9.36L1 10"/></svg>
            Request
          </button>
        </div>
      </div>

      <div class="quick-grid fade-up" style="animation-delay:0.1s">
        <!-- Agentic Actions (primary) -->
        <div class="quick-item" onclick="sendSuggestion({dataset:{text:'Create a shopping list'}})">
          <div class="quick-icon qi-violet" style="background:rgba(168,85,247,0.15)">
            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="#a855f7" stroke-width="2"><circle cx="9" cy="21" r="1"/><circle cx="20" cy="21" r="1"/><path d="M1 1h4l2.68 13.39a2 2 0 0 0 2 1.61h9.72a2 2 0 0 0 2-1.61L23 6H6"/></svg>
          </div>
          <div class="quick-label">Shop</div>
        </div>
        <div class="quick-item" onclick="openMarketsModal()">
          <div class="quick-icon qi-green" style="background:rgba(16,185,129,0.15)">
            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="#10b981" stroke-width="2"><polyline points="22 7 13.5 15.5 8.5 10.5 2 17"/><polyline points="16 7 22 7 22 13"/></svg>
          </div>
          <div class="quick-label">Markets</div>
        </div>
        <div class="quick-item" onclick="sendSuggestion({dataset:{text:'Give me financial advice'}})">
          <div class="quick-icon qi-blue" style="background:rgba(59,130,246,0.15)">
            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="#3b82f6" stroke-width="2"><path d="M12 2a10 10 0 1 0 10 10A10 10 0 0 0 12 2z"/><path d="M12 6v6l4 2"/></svg>
          </div>
          <div class="quick-label">Advisor</div>
        </div>
        <div class="quick-item" onclick="sendSuggestion({dataset:{text:'Show my subscriptions'}})">
          <div class="quick-icon qi-orange" style="background:rgba(249,115,22,0.15)">
            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="#f97316" stroke-width="2"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/><polyline points="14 2 14 8 20 8"/><line x1="16" y1="13" x2="8" y2="13"/><line x1="16" y1="17" x2="8" y2="17"/></svg>
          </div>
          <div class="quick-label">Assistant</div>
        </div>
        <!-- Payment Actions -->
        <div class="quick-item" onclick="openSendModal()">
          <div class="quick-icon qi-cyan" style="background:rgba(6,182,212,0.15)">
            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="#06b6d4" stroke-width="2"><line x1="22" y1="2" x2="11" y2="13"/><polygon points="22 2 15 22 11 13 2 9 22 2"/></svg>
          </div>
          <div class="quick-label">Send</div>
        </div>
        <div class="quick-item" onclick="navigateTo('wallet')">
          <div class="quick-icon qi-green">
            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="#10b981" stroke-width="2"><path d="M21 12V7H5a2 2 0 0 1 0-4h14v4"/><path d="M3 5v14a2 2 0 0 0 2 2h16v-5"/><circle cx="18" cy="16" r="1"/></svg>
          </div>
          <div class="quick-label">Wallet</div>
        </div>
        <div class="quick-item" onclick="showQrModal()">
          <div class="quick-icon qi-cyan">
            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="#06b6d4" stroke-width="2"><rect x="3" y="3" width="7" height="7"/><rect x="14" y="3" width="7" height="7"/><rect x="3" y="14" width="7" height="7"/><rect x="14" y="14" width="3" height="3"/><line x1="21" y1="14" x2="21" y2="21"/><line x1="14" y1="21" x2="21" y2="21"/></svg>
          </div>
          <div class="quick-label">QR Code</div>
        </div>
        <div class="quick-item">
          <div class="quick-icon qi-red">
            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="#ef4444" stroke-width="2"><path d="M22 12h-4l-3 9L9 3l-3 9H2"/></svg>
          </div>
          <div class="quick-label">Insights</div>
        </div>
        <!-- Africa-specific quick actions -->
        <div class="quick-item" id="airtime-quick-btn" onclick="openAirtimeModal()" style="display:none">
          <div class="quick-icon" style="background:rgba(251,191,36,0.15)">
            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="#fbbf24" stroke-width="2"><rect x="5" y="2" width="14" height="20" rx="2" ry="2"/><line x1="12" y1="18" x2="12" y2="18"/></svg>
          </div>
          <div class="quick-label">Airtime</div>
        </div>
        <div class="quick-item" id="bills-quick-btn" onclick="sendSuggestion({dataset:{text:'Pay my bills'}})" style="display:none">
          <div class="quick-icon" style="background:rgba(168,85,247,0.15)">
            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="#a855f7" stroke-width="2"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/><polyline points="14 2 14 8 20 8"/><line x1="12" y1="18" x2="12" y2="12"/><line x1="9" y1="15" x2="15" y2="15"/></svg>
          </div>
          <div class="quick-label">Pay Bills</div>
        </div>
      </div>

      <!-- AI Agent Preview -->
      <div class="ai-card fade-up" style="animation-delay:0.15s" onclick="navigateTo('ai')">
        <div class="ai-card-header">
          <div class="ai-avatar">&#9889;</div>
          <div>
            <div class="ai-name">PromptPay Agent</div>
            <div class="ai-status">Online &mdash; 59 tools ready</div>
          </div>
        </div>
        <div class="ai-suggestion">
          "Send $50 to Sarah" or "Pay my electricity bill" &mdash; just type naturally
        </div>
      </div>

      <!-- Transactions -->
      <div class="section-header fade-up" style="animation-delay:0.2s">
        <div class="section-title">Recent Activity</div>
        <div class="section-link" onclick="navigateTo('activity')">See All</div>
      </div>
      <div class="tx-list fade-up" style="animation-delay:0.25s" id="recent-tx-list">
        <div style="padding:30px 0;text-align:center;color:var(--text3);font-size:13px">
          No transactions yet. Send money or top up to get started.
        </div>
      </div>

    </div>

    <!-- AI CHAT -->
    <div class="page" id="page-ai">
      <div class="chat-container">
        <div class="chat-header-bar">
          <div class="ai-avatar" style="width:36px;height:36px;border-radius:10px;font-size:16px">&#9889;</div>
          <div>
            <div style="font-size:15px;font-weight:600">PromptPay Agent</div>
            <div class="ai-status" style="font-size:11px">5 agents &middot; 59 tools online</div>
          </div>
        </div>

        <div class="chat-messages" id="chat-messages">
          <div class="msg msg-ai">
            Hey! I'm your PromptPay AI assistant. I can help you shop, invest, manage budgets, track subscriptions, send money, pay bills, and more. Just tell me what you need.
          </div>
        </div>

        <div class="chat-input-area">
          <div class="chat-suggestions" id="chat-suggestions">
            <div class="chat-suggestion" onclick="sendSuggestion(this)" data-text="Create a shopping list for groceries">Shopping List</div>
            <div class="chat-suggestion" onclick="openMarketsModal()">Markets</div>
            <div class="chat-suggestion" onclick="sendSuggestion(this)" data-text="Create a monthly budget">Budget</div>
            <div class="chat-suggestion" onclick="sendSuggestion(this)" data-text="Show my subscriptions">Subscriptions</div>
          </div>
          <div class="chat-input-wrap">
            <input class="chat-input" id="chat-input" placeholder="Ask anything..." autocomplete="off" onkeydown="if(event.key==='Enter')sendMessage()">
            <button class="chat-send-btn" id="chat-send" onclick="sendMessage()">
              <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><line x1="22" y1="2" x2="11" y2="13"/><polygon points="22 2 15 22 11 13 2 9 22 2"/></svg>
            </button>
          </div>
        </div>
      </div>
    </div>

    <!-- WALLET -->
    <div class="page" id="page-wallet">
      <div style="margin-bottom:14px">
        <button class="page-back-btn" onclick="navigateTo('home')">
          <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="19" y1="12" x2="5" y2="12"/><polyline points="12 19 5 12 12 5"/></svg>
          Back
        </button>
      </div>
      <!-- KYC Status Banner -->
      <div id="kyc-banner" style="padding:12px 16px;border-radius:14px;margin-bottom:16px;display:none;cursor:pointer" onclick="openKycModal()">
        <div style="display:flex;align-items:center;gap:10px">
          <div id="kyc-banner-icon" style="width:36px;height:36px;border-radius:10px;display:flex;align-items:center;justify-content:center;font-size:18px"></div>
          <div style="flex:1">
            <div id="kyc-banner-title" style="font-size:13px;font-weight:600"></div>
            <div id="kyc-banner-desc" style="font-size:11px;opacity:0.7"></div>
          </div>
          <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="9 18 15 12 9 6"/></svg>
        </div>
      </div>

      <!-- Cards Section -->
      <div class="section-header" style="margin-bottom:18px">
        <div class="section-title">Cards</div>
        <div class="section-link" onclick="openAddCardModal()">+ Add</div>
      </div>
      <div class="card-carousel" id="payment-cards">
        <div style="min-width:280px;padding:30px 24px;border-radius:20px;border:1px dashed rgba(255,255,255,0.1);display:flex;align-items:center;justify-content:center;flex-direction:column;gap:8px;cursor:pointer;color:var(--text3)" onclick="openAddCardModal()">
          <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/></svg>
          <span style="font-size:13px">Add Card</span>
        </div>
      </div>

      <!-- Bank Accounts Section -->
      <div id="bank-accounts-section">
        <div class="section-header">
          <div class="section-title">Bank Accounts</div>
          <div class="section-link" onclick="openBankModal()">+ Link</div>
        </div>
        <div id="bank-accounts-list" style="margin-bottom:16px">
          <div style="padding:16px;text-align:center;color:var(--text3);font-size:13px">No bank accounts linked</div>
        </div>
      </div>

      <!-- Mobile Money Section -->
      <div id="momo-section">
        <div class="section-header">
          <div class="section-title">Mobile Money</div>
          <div class="section-link" onclick="openMomoModal()">+ Link</div>
        </div>
        <div id="momo-wallets-list" style="margin-bottom:16px">
          <div style="padding:16px;text-align:center;color:var(--text3);font-size:13px">No mobile wallets linked</div>
        </div>
      </div>

      <div class="section-header">
        <div class="section-title">Savings Goals</div>
        <div class="section-link" onclick="navigateTo('ai');document.getElementById('chat-input').value='Create a savings goal';sendMessage()">+ New Goal</div>
      </div>
      <div id="savings-goals">
        <div style="padding:20px 0;text-align:center;color:var(--text3);font-size:13px">
          No savings goals yet. Ask the AI to create one for you.
        </div>
      </div>

      <!-- Token Matrix -->
      <div class="section-header" style="margin-top:24px">
        <div class="section-title">&#9889; Token Matrix</div>
        <div class="section-link" style="color:var(--emerald)">Active</div>
      </div>
      <div class="token-matrix" id="token-matrix">
        <div class="token-row">
          <span class="token-label">Session Tokens Used</span>
          <span class="token-value" id="tm-used">0</span>
        </div>
        <div class="token-row">
          <span class="token-label">Cached Responses</span>
          <span class="token-value token-saved" id="tm-cached">0</span>
        </div>
        <div class="token-row">
          <span class="token-label">Tokens Saved</span>
          <span class="token-value token-saved" id="tm-saved">0</span>
        </div>
        <div class="token-row">
          <span class="token-label">Efficiency Rate</span>
          <span class="token-value" id="tm-efficiency" style="color:var(--accent2)">100%</span>
        </div>
        <div class="token-row">
          <span class="token-label">Est. Cost Savings</span>
          <span class="token-value token-saved" id="tm-cost">$0.000</span>
        </div>
      </div>
    </div>

    <!-- ACTIVITY (Payments tab) -->
    <div class="page" id="page-activity">
      <div style="margin-bottom:14px">
        <button class="page-back-btn" onclick="navigateTo('home')">
          <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="19" y1="12" x2="5" y2="12"/><polyline points="12 19 5 12 12 5"/></svg>
          Back
        </button>
      </div>
      <div class="section-header" style="margin-bottom:18px">
        <div class="section-title">All Transactions</div>
      </div>
      <div style="display:flex;gap:8px;margin-bottom:20px;overflow-x:auto;scrollbar-width:none">
        <div class="chat-suggestion" style="background:var(--accent);color:white;border-color:var(--accent)">All</div>
        <div class="chat-suggestion">Sent</div>
        <div class="chat-suggestion">Received</div>
        <div class="chat-suggestion">Bills</div>
        <div class="chat-suggestion">Savings</div>
      </div>
      <div class="tx-list" id="activity-tx-list">
        <!-- Populated by JS -->
      </div>
    </div>

    <!-- PROFILE -->
    <div class="page" id="page-profile">
      <div style="margin-bottom:14px">
        <button class="page-back-btn" onclick="navigateTo('home')">
          <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="19" y1="12" x2="5" y2="12"/><polyline points="12 19 5 12 12 5"/></svg>
          Back
        </button>
      </div>
      <!-- Profile Picture -->
      <div style="display:flex;flex-direction:column;align-items:center;margin-bottom:24px">
        <div id="profile-pic-container" style="position:relative;width:80px;height:80px;margin-bottom:12px">
          <div id="profile-pic-display" style="width:80px;height:80px;border-radius:50%;background:var(--gradient);display:flex;align-items:center;justify-content:center;font-size:28px;font-weight:700;color:white;overflow:hidden;border:3px solid rgba(124,58,237,0.3)">
            <span id="profile-pic-initials">PP</span>
            <img id="profile-pic-img" style="display:none;width:100%;height:100%;object-fit:cover" alt="Profile">
          </div>
          <label for="profile-pic-input" style="position:absolute;bottom:-2px;right:-2px;width:28px;height:28px;border-radius:50%;background:var(--gradient2);display:flex;align-items:center;justify-content:center;cursor:pointer;border:2px solid var(--bg)">
            <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="2"><path d="M23 19a2 2 0 0 1-2 2H3a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h4l2-3h6l2 3h4a2 2 0 0 1 2 2z"/><circle cx="12" cy="13" r="4"/></svg>
          </label>
          <input type="file" id="profile-pic-input" accept="image/*" onchange="handleProfilePicUpload(event)" style="display:none">
        </div>
        <div style="font-size:18px;font-weight:700" id="profile-display-name">User</div>
        <div style="font-size:13px;color:var(--text2)" id="profile-email-display"></div>
      </div>

      <!-- Streak -->
      <div class="streak-card">
        <div class="streak-fire">&#128293;</div>
        <div>
          <div class="streak-count" id="user-streak">0</div>
          <div class="streak-label">Day Streak</div>
        </div>
        <div class="streak-multiplier" id="streak-mult">1.0x</div>
      </div>

      <!-- Loyalty Tier -->
      <div class="tier-card tier-bronze" id="tier-card">
        <div class="tier-info">
          <div>
            <div class="tier-name" id="tier-name">Bronze</div>
            <div class="tier-points" id="tier-points">0 points</div>
          </div>
          <div style="font-size:32px">&#11088;</div>
        </div>
        <div class="tier-progress">
          <div class="tier-bar"><div class="tier-fill" id="tier-fill" style="width:0%;background:linear-gradient(90deg,#b87333,#d4a76a)"></div></div>
          <div class="tier-next" id="tier-next">5,000 pts to Silver</div>
        </div>
      </div>

      <!-- Achievements -->
      <div class="section-header">
        <div class="section-title">Achievements</div>
        <div class="section-link" id="ach-count">0/15</div>
      </div>
      <div class="achievements-grid" id="achievements-grid">
        <div class="achievement locked">
          <div class="ach-icon">&#128176;</div>
          <div class="ach-name">First Payment</div>
          <div class="ach-pts">100 pts</div>
        </div>
        <div class="achievement locked">
          <div class="ach-icon">&#128293;</div>
          <div class="ach-name">7-Day Streak</div>
          <div class="ach-pts">250 pts</div>
        </div>
        <div class="achievement locked">
          <div class="ach-icon">&#128279;</div>
          <div class="ach-name">First Referral</div>
          <div class="ach-pts">500 pts</div>
        </div>
        <div class="achievement locked">
          <div class="ach-icon">&#127968;</div>
          <div class="ach-name">Savings $100</div>
          <div class="ach-pts">200 pts</div>
        </div>
        <div class="achievement locked">
          <div class="ach-icon">&#127942;</div>
          <div class="ach-name">30-Day Streak</div>
          <div class="ach-pts">1,500 pts</div>
        </div>
        <div class="achievement locked">
          <div class="ach-icon">&#128142;</div>
          <div class="ach-name">$10K Volume</div>
          <div class="ach-pts">10,000 pts</div>
        </div>
      </div>

      <!-- Country/Region Setting -->
      <div class="section-header" style="margin-top:24px">
        <div class="section-title">Your Region</div>
      </div>
      <div style="background:var(--surface);border:1px solid var(--glass-border);border-radius:var(--radius);padding:18px;margin-bottom:16px;">
        <label style="font-size:12px;color:var(--text2);display:block;margin-bottom:6px">Country</label>
        <select id="profile-country" onchange="updateUserCountry(this.value)" style="width:100%;padding:12px 14px;background:rgba(255,255,255,0.04);border:1px solid rgba(255,255,255,0.08);border-radius:var(--radius-xs);color:var(--text);font-size:14px;font-family:inherit;outline:none;-webkit-appearance:none;appearance:none;">
          <option value="">Not set</option>
          <optgroup label="Africa">
            <option value="NG">Nigeria</option>
            <option value="GH">Ghana</option>
            <option value="KE">Kenya</option>
            <option value="UG">Uganda</option>
            <option value="ZA">South Africa</option>
            <option value="TZ">Tanzania</option>
            <option value="CM">Cameroon</option>
            <option value="SN">Senegal</option>
            <option value="ET">Ethiopia</option>
          </optgroup>
          <optgroup label="Americas">
            <option value="US">United States</option>
            <option value="CA">Canada</option>
          </optgroup>
          <optgroup label="Europe">
            <option value="GB">United Kingdom</option>
            <option value="DE">Germany</option>
            <option value="FR">France</option>
          </optgroup>
          <optgroup label="Asia & Pacific">
            <option value="IN">India</option>
            <option value="AU">Australia</option>
          </optgroup>
        </select>
        <div style="font-size:11px;color:var(--text3);margin-top:8px">This determines available features like airtime top-up (Africa only).</div>
      </div>

    </div>

    <!-- SETTINGS -->
    <div class="page" id="page-settings">
      <div style="margin-bottom:14px">
        <button class="page-back-btn" onclick="navigateTo('home')">
          <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="19" y1="12" x2="5" y2="12"/><polyline points="12 19 5 12 12 5"/></svg>
          Back
        </button>
      </div>
      <div class="section-header" style="margin-bottom:18px">
        <div class="section-title">Settings</div>
      </div>

      <!-- AI — Platform Provided -->
      <div class="settings-section">
        <div class="settings-section-title">
          <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"/><path d="M8 14s1.5 2 4 2 4-2 4-2"/><line x1="9" y1="9" x2="9.01" y2="9"/><line x1="15" y1="9" x2="15.01" y2="9"/></svg>
          AI Assistant
        </div>
        <div style="padding:12px 0;color:var(--text2);font-size:13px;line-height:1.6">
          AI is powered by PromptPay — no setup needed. Chat with our AI assistant, get financial insights, and manage payments all through natural conversation.
        </div>
        <div style="display:flex;gap:8px;align-items:center;padding:10px 14px;background:rgba(124,58,237,0.1);border-radius:12px;font-size:13px">
          <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="#7c3aed" stroke-width="2"><path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"/><polyline points="22 4 12 14.01 9 11.01"/></svg>
          <span style="color:var(--text)">AI is included free with your account</span>
        </div>
      </div>

      <!-- Notifications -->
      <div class="settings-section">
        <div class="settings-section-title">
          <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M18 8A6 6 0 0 0 6 8c0 7-3 9-3 9h18s-3-2-3-9"/><path d="M13.73 21a2 2 0 0 1-3.46 0"/></svg>
          Notifications
        </div>
        <div style="display:flex;flex-direction:column;gap:10px">
          <div class="channel-toggle active" data-channel="push" onclick="toggleChannel(this)">
            <span class="channel-label">Push Notifications</span>
            <div class="toggle-switch on"></div>
          </div>
          <div class="channel-toggle active" data-channel="email" onclick="toggleChannel(this)">
            <span class="channel-label">Email Alerts</span>
            <div class="toggle-switch on"></div>
          </div>
        </div>
      </div>

      <!-- Transaction Fees Info -->
      <div class="settings-section">
        <div class="settings-section-title">
          <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="12" y1="1" x2="12" y2="23"/><path d="M17 5H9.5a3.5 3.5 0 0 0 0 7h5a3.5 3.5 0 0 1 0 7H6"/></svg>
          Fee Schedule
        </div>
        <div style="display:flex;flex-direction:column;gap:8px;font-size:13px;color:var(--text2)">
          <div style="display:flex;justify-content:space-between"><span>P2P Transfer (under $50)</span><span style="color:var(--emerald);font-weight:600">Free</span></div>
          <div style="display:flex;justify-content:space-between"><span>P2P Transfer (over $50)</span><span>1.0%</span></div>
          <div style="display:flex;justify-content:space-between"><span>Wallet Top-up</span><span>1.5%</span></div>
          <div style="display:flex;justify-content:space-between"><span>Withdrawal</span><span>1.0% + $0.25</span></div>
          <div style="display:flex;justify-content:space-between"><span>Bill Payment</span><span>1.5%</span></div>
          <div style="display:flex;justify-content:space-between"><span>Merchant Payment</span><span>2.5%</span></div>
          <div style="display:flex;justify-content:space-between"><span>Cross-border</span><span>3.0%</span></div>
          <div style="margin-top:6px;padding:10px 14px;background:rgba(124,58,237,0.08);border-radius:10px;color:var(--text)">
            Loyalty members save up to 20% on fees! Your tier discount is applied automatically.
          </div>
        </div>
      </div>

      <!-- PayTag & Sharing -->
      <div style="background: rgba(124,58,237,0.1); border-radius: 16px; padding: 20px; margin-bottom: 16px; border: 1px solid rgba(124,58,237,0.2);">
        <h4 style="margin: 0 0 12px 0; font-size: 1rem;">Your $PayTag</h4>
        <div id="settings-paytag" style="font-size: 1.3rem; font-weight: 700; color: #7c3aed; margin-bottom: 8px;">Not set</div>
        <button onclick="document.getElementById('paytag-modal').classList.add('active')" style="padding: 8px 16px; border-radius: 8px; border: 1px solid rgba(124,58,237,0.3); background: transparent; color: #7c3aed; cursor: pointer; font-size: 0.85rem;">Change PayTag</button>
        <button onclick="sharePaytag()" style="padding: 8px 16px; border-radius: 8px; border: none; background: #7c3aed; color: white; cursor: pointer; font-size: 0.85rem; margin-left: 8px;">Share</button>
      </div>

      <!-- Referral -->
      <div style="background: rgba(255,255,255,0.03); border-radius: 16px; padding: 20px; margin-bottom: 16px; border: 1px solid rgba(255,255,255,0.06);">
        <h4 style="margin: 0 0 8px 0; font-size: 1rem;">Invite Friends — Earn $5</h4>
        <p style="font-size: 0.85rem; opacity: 0.6; margin: 0 0 12px 0;">You both get $5 when they make their first $5+ transaction</p>
        <button onclick="shareReferral()" style="padding: 10px 20px; border-radius: 10px; border: none; background: linear-gradient(135deg, #10b981, #059669); color: white; font-weight: 600; cursor: pointer;">Share Invite Link</button>
      </div>

      <!-- Install App -->
      <div class="settings-section" id="install-app-section">
        <div class="settings-section-title">
          <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="5" y="2" width="14" height="20" rx="2" ry="2"/><line x1="12" y1="18" x2="12.01" y2="18"/></svg>
          Install App
        </div>
        <div style="padding:4px 0 12px;color:var(--text2);font-size:13px;line-height:1.5">
          Add PromptPay to your phone's home screen for instant access — no app store needed. Works like a native app with offline support.
        </div>
        <button class="settings-btn settings-btn-primary settings-btn-full" id="install-app-btn" onclick="installApp()">
          Add to Home Screen
        </button>
      </div>

      <!-- Language & Timezone -->
      <div class="settings-section">
        <div class="settings-section-title">
          <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"/><line x1="2" y1="12" x2="22" y2="12"/><path d="M12 2a15.3 15.3 0 0 1 4 10 15.3 15.3 0 0 1-4 10 15.3 15.3 0 0 1-4-10 15.3 15.3 0 0 1 4-10z"/></svg>
          Language &amp; Region
        </div>
        <div class="settings-field">
          <label>Country</label>
          <select id="settings-country" onchange="updateUserCountry(this.value)">
            <option value="">Not set</option>
            <optgroup label="Africa">
              <option value="NG">Nigeria</option>
              <option value="GH">Ghana</option>
              <option value="KE">Kenya</option>
              <option value="UG">Uganda</option>
              <option value="ZA">South Africa</option>
              <option value="TZ">Tanzania</option>
              <option value="CM">Cameroon</option>
              <option value="SN">Senegal</option>
              <option value="ET">Ethiopia</option>
            </optgroup>
            <optgroup label="Americas">
              <option value="US">United States</option>
              <option value="CA">Canada</option>
            </optgroup>
            <optgroup label="Europe">
              <option value="GB">United Kingdom</option>
              <option value="DE">Germany</option>
              <option value="FR">France</option>
            </optgroup>
            <optgroup label="Asia & Pacific">
              <option value="IN">India</option>
              <option value="AU">Australia</option>
            </optgroup>
          </select>
        </div>
        <div class="settings-row">
          <div class="settings-field">
            <label>Language</label>
            <select id="settings-language">
              <option value="en">English</option>
              <option value="es">Spanish</option>
              <option value="fr">French</option>
              <option value="de">German</option>
              <option value="pt">Portuguese</option>
              <option value="zh">Chinese</option>
              <option value="ja">Japanese</option>
              <option value="ko">Korean</option>
              <option value="ar">Arabic</option>
              <option value="hi">Hindi</option>
              <option value="sw">Swahili</option>
            </select>
          </div>
          <div class="settings-field">
            <label>Timezone</label>
            <select id="settings-timezone">
              <option value="America/New_York">Eastern (ET)</option>
              <option value="America/Chicago">Central (CT)</option>
              <option value="America/Denver">Mountain (MT)</option>
              <option value="America/Los_Angeles">Pacific (PT)</option>
              <option value="America/Anchorage">Alaska (AKT)</option>
              <option value="Pacific/Honolulu">Hawaii (HT)</option>
              <option value="Europe/London">London (GMT)</option>
              <option value="Europe/Paris">Paris (CET)</option>
              <option value="Europe/Berlin">Berlin (CET)</option>
              <option value="Asia/Tokyo">Tokyo (JST)</option>
              <option value="Asia/Shanghai">Shanghai (CST)</option>
              <option value="Asia/Kolkata">Kolkata (IST)</option>
              <option value="Africa/Nairobi">Nairobi (EAT)</option>
              <option value="Australia/Sydney">Sydney (AEST)</option>
              <option value="UTC">UTC</option>
            </select>
          </div>
        </div>
      </div>

      <!-- Save Preferences Button -->
      <button class="settings-btn settings-btn-primary settings-btn-full" onclick="savePreferences()">
        Save Preferences
      </button>

      <div style="height:24px"></div>
    </div>

  </div>

  <!-- Bottom Navigation -->
  <div class="bottom-nav">
    <div class="nav-item active" data-page="home">
      <div class="nav-icon">
        <svg width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"/><polyline points="9 22 9 12 15 12 15 22"/></svg>
      </div>
      <div class="nav-label">Home</div>
    </div>
    <div class="nav-item" data-page="activity">
      <div class="nav-icon">
        <svg width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="22 12 18 12 15 21 9 3 6 12 2 12"/></svg>
      </div>
      <div class="nav-label">Activity</div>
    </div>
    <div class="nav-item nav-ai" data-page="ai">
      <div class="nav-icon">
        <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="2"><path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"/></svg>
      </div>
      <div class="nav-label">AI</div>
    </div>
    <div class="nav-item" data-page="wallet">
      <div class="nav-icon">
        <svg width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 12V7H5a2 2 0 0 1 0-4h14v4"/><path d="M3 5v14a2 2 0 0 0 2 2h16v-5"/><circle cx="18" cy="16" r="1"/></svg>
      </div>
      <div class="nav-label">Wallet</div>
    </div>
    <div class="nav-item" data-page="profile">
      <div class="nav-icon">
        <svg width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"/><circle cx="12" cy="7" r="4"/></svg>
      </div>
      <div class="nav-label">Profile</div>
    </div>
  </div>

</div>

<!-- Add Card Modal -->
<div class="modal-overlay" id="add-card-modal">
  <div class="modal-sheet">
    <div class="modal-handle"></div>
    <h3 style="margin-bottom:8px;font-size:20px;font-weight:700">Add Payment Method</h3>
    <p style="font-size:13px;color:var(--text2);margin-bottom:20px">Securely add a debit or credit card</p>
    <div id="stripe-card-element" style="padding:16px;background:var(--surface);border:1px solid var(--glass-border);border-radius:12px;margin-bottom:16px;min-height:44px"></div>
    <div id="card-errors" style="color:var(--red);font-size:13px;margin-bottom:16px;display:none"></div>
    <button id="add-card-submit" onclick="submitCardForm()" style="width:100%;padding:16px;background:var(--gradient2);border:none;border-radius:14px;color:white;font-size:16px;font-weight:600;cursor:pointer;font-family:inherit;box-shadow:0 4px 20px rgba(124,58,237,0.3)">Add Card</button>
    <button onclick="closeModals()" style="width:100%;padding:14px;background:none;border:none;color:var(--text2);font-size:14px;cursor:pointer;margin-top:8px;font-family:inherit">Cancel</button>
  </div>
</div>

<!-- Send Modal (Country-Aware) -->
<div class="modal-overlay" id="send-modal">
  <div class="modal-sheet" style="max-height:90vh">
    <div class="modal-handle"></div>
    <h3 style="margin-bottom:4px;font-size:20px;font-weight:700">Send Money</h3>
    <p id="send-currency-label" style="font-size:13px;color:var(--text2);margin-bottom:12px"></p>

    <!-- Domestic / International toggle -->
    <div id="send-scope-tabs" style="display:flex;gap:0;margin-bottom:14px;background:var(--surface);border-radius:12px;padding:3px;border:1px solid var(--glass-border)">
      <button class="send-scope-tab active" data-scope="domestic" onclick="switchSendScope('domestic')" style="flex:1;padding:10px;border-radius:10px;border:none;font-size:13px;font-weight:600;cursor:pointer;font-family:inherit;background:var(--gradient2);color:white;transition:all 0.2s">Domestic</button>
      <button class="send-scope-tab" data-scope="international" onclick="switchSendScope('international')" style="flex:1;padding:10px;border-radius:10px;border:none;font-size:13px;font-weight:600;cursor:pointer;font-family:inherit;background:transparent;color:var(--text2);transition:all 0.2s">International</button>
    </div>

    <!-- Transfer type tabs -->
    <div id="send-type-tabs" style="display:flex;gap:8px;margin-bottom:16px;overflow-x:auto;scrollbar-width:none">
      <button class="send-tab active" data-type="bank" onclick="switchSendType('bank')" style="padding:8px 16px;border-radius:20px;border:1px solid var(--glass-border);background:var(--gradient2);color:white;font-size:12px;font-weight:600;white-space:nowrap;cursor:pointer;font-family:inherit">Bank Transfer</button>
      <button class="send-tab" data-type="mobile_money" onclick="switchSendType('mobile_money')" style="padding:8px 16px;border-radius:20px;border:1px solid var(--glass-border);background:transparent;color:var(--text2);font-size:12px;font-weight:600;white-space:nowrap;cursor:pointer;font-family:inherit">Mobile Money</button>
      <button class="send-tab" data-type="wallet" onclick="switchSendType('wallet')" style="padding:8px 16px;border-radius:20px;border:1px solid var(--glass-border);background:transparent;color:var(--text2);font-size:12px;font-weight:600;white-space:nowrap;cursor:pointer;font-family:inherit">PromptPay</button>
    </div>

    <!-- Bank Transfer Fields -->
    <div id="send-bank-fields">
      <!-- Country selector for international -->
      <div id="send-intl-country-wrap" style="margin-bottom:14px;display:none">
        <label style="font-size:12px;color:var(--text2);display:block;margin-bottom:6px">Destination Country</label>
        <select id="send-intl-country" onchange="updateIntlFields()" style="width:100%;padding:14px;background:var(--surface);border:1px solid var(--glass-border);border-radius:12px;color:var(--text);font-size:14px;font-family:inherit;outline:none;-webkit-appearance:none">
          <option value="">Select country</option>
          <option value="US">United States</option>
          <option value="GB">United Kingdom</option>
          <option value="NG">Nigeria</option>
          <option value="GH">Ghana</option>
          <option value="KE">Kenya</option>
          <option value="UG">Uganda</option>
          <option value="IN">India</option>
          <option value="AU">Australia</option>
          <option value="CA">Canada</option>
          <option value="DE">Germany</option>
          <option value="FR">France</option>
        </select>
      </div>
      <div style="margin-bottom:14px">
        <label style="font-size:12px;color:var(--text2);display:block;margin-bottom:6px">Bank</label>
        <select id="send-bank" style="width:100%;padding:14px;background:var(--surface);border:1px solid var(--glass-border);border-radius:12px;color:var(--text);font-size:14px;font-family:inherit;outline:none;-webkit-appearance:none">
          <option value="">Select bank</option>
        </select>
      </div>
      <!-- Routing / Sort Code / IFSC / BSB field -->
      <div id="send-routing-wrap" style="margin-bottom:14px">
        <label id="send-routing-label" style="font-size:12px;color:var(--text2);display:block;margin-bottom:6px">Routing Number</label>
        <input id="send-routing" placeholder="000000000" inputmode="numeric" style="width:100%;padding:14px;background:var(--surface);border:1px solid var(--glass-border);border-radius:12px;color:var(--text);font-size:14px;font-family:inherit;outline:none">
        <div style="font-size:11px;color:var(--text3);margin-top:4px" id="send-routing-hint">9-digit ABA routing number</div>
      </div>
      <div style="margin-bottom:14px">
        <label style="font-size:12px;color:var(--text2);display:block;margin-bottom:6px">Account Number</label>
        <input id="send-account" placeholder="0000000000" inputmode="numeric" style="width:100%;padding:14px;background:var(--surface);border:1px solid var(--glass-border);border-radius:12px;color:var(--text);font-size:14px;font-family:inherit;outline:none">
      </div>
      <!-- SWIFT/BIC for international -->
      <div id="send-swift-wrap" style="margin-bottom:14px;display:none">
        <label style="font-size:12px;color:var(--text2);display:block;margin-bottom:6px">SWIFT / BIC Code</label>
        <input id="send-swift" placeholder="ABCDUS33XXX" maxlength="11" style="width:100%;padding:14px;background:var(--surface);border:1px solid var(--glass-border);border-radius:12px;color:var(--text);font-size:14px;font-family:inherit;outline:none;text-transform:uppercase">
      </div>
      <div id="send-recipient-name" style="padding:10px 16px;background:rgba(16,185,129,0.1);border-radius:10px;margin-bottom:14px;font-size:13px;color:var(--emerald);display:none"></div>
    </div>

    <!-- Mobile Money Fields -->
    <div id="send-momo-fields" style="display:none">
      <div style="margin-bottom:14px">
        <label style="font-size:12px;color:var(--text2);display:block;margin-bottom:6px">Provider</label>
        <select id="send-momo-provider" style="width:100%;padding:14px;background:var(--surface);border:1px solid var(--glass-border);border-radius:12px;color:var(--text);font-size:14px;font-family:inherit;outline:none;-webkit-appearance:none">
          <option value="">Select provider</option>
        </select>
      </div>
      <div style="margin-bottom:14px">
        <label style="font-size:12px;color:var(--text2);display:block;margin-bottom:6px">Phone Number</label>
        <input id="send-momo-phone" placeholder="+234..." type="tel" style="width:100%;padding:14px;background:var(--surface);border:1px solid var(--glass-border);border-radius:12px;color:var(--text);font-size:14px;font-family:inherit;outline:none">
      </div>
    </div>

    <!-- Wallet (PromptPay) Fields -->
    <div id="send-wallet-fields" style="display:none">
      <div style="margin-bottom:14px">
        <label style="font-size:12px;color:var(--text2);display:block;margin-bottom:6px">Recipient</label>
        <input id="send-to" placeholder="Email, phone, or $PayTag" style="width:100%;padding:14px;background:var(--surface);border:1px solid var(--glass-border);border-radius:12px;color:var(--text);font-size:14px;font-family:inherit;outline:none">
      </div>
    </div>

    <!-- Common: Amount + Note -->
    <div style="margin-bottom:14px">
      <label style="font-size:12px;color:var(--text2);display:block;margin-bottom:6px">Amount</label>
      <input id="send-amount" placeholder="0.00" type="number" step="0.01" style="width:100%;padding:14px;background:var(--surface);border:1px solid var(--glass-border);border-radius:12px;color:var(--text);font-size:24px;font-weight:700;font-family:inherit;outline:none;text-align:center">
    </div>
    <div id="send-fee-display" style="text-align:center;font-size:12px;color:var(--text3);margin-bottom:14px"></div>
    <div style="margin-bottom:20px">
      <label style="font-size:12px;color:var(--text2);display:block;margin-bottom:6px">Note (optional)</label>
      <input id="send-note" placeholder="What's this for?" style="width:100%;padding:14px;background:var(--surface);border:1px solid var(--glass-border);border-radius:12px;color:var(--text);font-size:14px;font-family:inherit;outline:none">
    </div>
    <button id="send-submit-btn" onclick="executeSend()" style="width:100%;padding:16px;background:var(--gradient2);border:none;border-radius:14px;color:white;font-size:16px;font-weight:600;cursor:pointer;font-family:inherit;box-shadow:0 4px 20px rgba(124,58,237,0.3)">Send Payment</button>
    <button onclick="closeModals()" style="width:100%;padding:14px;background:none;border:none;color:var(--text2);font-size:14px;cursor:pointer;margin-top:8px;font-family:inherit">Cancel</button>
    <div id="send-error" style="color:var(--red);font-size:13px;margin-top:12px;text-align:center"></div>
  </div>
</div>

<!-- QR Modal — Bidirectional -->
<div class="modal-overlay" id="qr-modal">
  <div class="modal-sheet" style="text-align:center;max-height:90vh;overflow-y:auto">
    <div class="modal-handle"></div>
    <h3 style="margin-bottom:12px;font-size:20px;font-weight:700">QR Code</h3>
    <!-- Tabs -->
    <div style="display:flex;gap:4px;background:var(--surface);border-radius:12px;padding:4px;margin-bottom:20px">
      <button id="qr-tab-display" onclick="switchQrTab('display')" style="flex:1;padding:10px;border:none;border-radius:10px;background:var(--gradient2);color:white;font-size:13px;font-weight:600;cursor:pointer;font-family:inherit">My QR</button>
      <button id="qr-tab-scan" onclick="switchQrTab('scan')" style="flex:1;padding:10px;border:none;border-radius:10px;background:transparent;color:var(--text2);font-size:13px;font-weight:600;cursor:pointer;font-family:inherit">Scan QR</button>
    </div>
    <!-- Display Tab -->
    <div id="qr-display-panel">
      <p style="font-size:13px;color:var(--text2);margin-bottom:16px">Others can scan this to pay you</p>
      <div style="background:white;border-radius:20px;padding:20px;display:inline-block;margin-bottom:12px">
        <canvas id="qr-canvas" width="200" height="200"></canvas>
      </div>
      <div style="font-size:12px;color:var(--text3);margin-bottom:16px" id="qr-pay-link"></div>
      <button onclick="copyQrLink()" style="width:100%;padding:12px;background:var(--gradient2);border:none;border-radius:12px;color:white;font-size:14px;font-weight:600;cursor:pointer;font-family:inherit;margin-bottom:8px">Copy Pay Link</button>
    </div>
    <!-- Scan Tab -->
    <div id="qr-scan-panel" style="display:none">
      <p style="font-size:13px;color:var(--text2);margin-bottom:16px">Point your camera at a QR code</p>
      <div style="position:relative;width:100%;aspect-ratio:1;border-radius:16px;overflow:hidden;background:#000;margin-bottom:12px">
        <video id="qr-video" autoplay playsinline muted style="width:100%;height:100%;object-fit:cover"></video>
        <div style="position:absolute;inset:0;display:flex;align-items:center;justify-content:center;pointer-events:none">
          <div style="width:200px;height:200px;border:2px solid rgba(124,58,237,0.8);border-radius:16px;box-shadow:0 0 0 9999px rgba(0,0,0,0.4)"></div>
        </div>
        <canvas id="qr-scan-canvas" style="display:none"></canvas>
      </div>
      <div id="qr-scan-result" style="display:none;padding:12px;background:rgba(16,185,129,0.1);border-radius:12px;margin-bottom:8px;font-size:13px;color:var(--emerald)"></div>
      <div id="qr-scan-error" style="display:none;padding:12px;background:rgba(239,68,68,0.1);border-radius:12px;margin-bottom:8px;font-size:13px;color:var(--red)"></div>
    </div>
    <button onclick="closeQrModal()" style="width:100%;padding:14px;background:var(--surface);border:1px solid var(--glass-border);border-radius:14px;color:var(--text);font-size:14px;cursor:pointer;font-family:inherit">Close</button>
  </div>
</div>

<!-- Markets Modal -->
<div class="modal-overlay" id="markets-modal">
  <div class="modal-sheet" style="max-height:90vh;overflow-y:auto">
    <div class="modal-handle"></div>
    <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:16px">
      <h3 style="font-size:20px;font-weight:700">Market Insights</h3>
      <button onclick="closeModals()" style="background:none;border:none;color:var(--text2);font-size:24px;cursor:pointer">&times;</button>
    </div>
    <!-- Period Tabs -->
    <div style="display:flex;gap:6px;margin-bottom:20px;overflow-x:auto;padding-bottom:4px">
      <button class="mkt-period-tab active" onclick="loadMarketData('day')" data-period="day" style="padding:8px 16px;border:none;border-radius:20px;background:var(--gradient2);color:white;font-size:12px;font-weight:600;cursor:pointer;white-space:nowrap;font-family:inherit">Today</button>
      <button class="mkt-period-tab" onclick="loadMarketData('week')" data-period="week" style="padding:8px 16px;border:none;border-radius:20px;background:var(--surface);color:var(--text2);font-size:12px;font-weight:600;cursor:pointer;white-space:nowrap;font-family:inherit">This Week</button>
      <button class="mkt-period-tab" onclick="loadMarketData('month')" data-period="month" style="padding:8px 16px;border:none;border-radius:20px;background:var(--surface);color:var(--text2);font-size:12px;font-weight:600;cursor:pointer;white-space:nowrap;font-family:inherit">This Month</button>
      <button class="mkt-period-tab" onclick="loadMarketData('year')" data-period="year" style="padding:8px 16px;border:none;border-radius:20px;background:var(--surface);color:var(--text2);font-size:12px;font-weight:600;cursor:pointer;white-space:nowrap;font-family:inherit">This Year</button>
    </div>
    <!-- Market Summary -->
    <div id="mkt-summary" style="display:flex;gap:8px;margin-bottom:20px">
      <div style="flex:1;background:var(--surface);border:1px solid var(--glass-border);border-radius:14px;padding:14px;text-align:center">
        <div style="font-size:11px;color:var(--text3);margin-bottom:4px">S&P 500</div>
        <div style="font-size:16px;font-weight:700" id="mkt-sp500">--</div>
        <div style="font-size:11px" id="mkt-sp500-change">--</div>
      </div>
      <div style="flex:1;background:var(--surface);border:1px solid var(--glass-border);border-radius:14px;padding:14px;text-align:center">
        <div style="font-size:11px;color:var(--text3);margin-bottom:4px">NASDAQ</div>
        <div style="font-size:16px;font-weight:700" id="mkt-nasdaq">--</div>
        <div style="font-size:11px" id="mkt-nasdaq-change">--</div>
      </div>
      <div style="flex:1;background:var(--surface);border:1px solid var(--glass-border);border-radius:14px;padding:14px;text-align:center">
        <div style="font-size:11px;color:var(--text3);margin-bottom:4px">DOW</div>
        <div style="font-size:16px;font-weight:700" id="mkt-dow">--</div>
        <div style="font-size:11px" id="mkt-dow-change">--</div>
      </div>
    </div>
    <!-- Top Gainers -->
    <div style="margin-bottom:20px">
      <div style="font-size:14px;font-weight:600;margin-bottom:10px;color:var(--emerald)">Top Gainers</div>
      <div id="mkt-gainers" style="display:flex;flex-direction:column;gap:8px">
        <div style="text-align:center;padding:20px;color:var(--text3);font-size:13px">Loading...</div>
      </div>
    </div>
    <!-- Top Losers -->
    <div style="margin-bottom:20px">
      <div style="font-size:14px;font-weight:600;margin-bottom:10px;color:var(--red)">Top Losers</div>
      <div id="mkt-losers" style="display:flex;flex-direction:column;gap:8px">
        <div style="text-align:center;padding:20px;color:var(--text3);font-size:13px">Loading...</div>
      </div>
    </div>
    <!-- AI Market Insight -->
    <div style="background:linear-gradient(135deg,rgba(124,58,237,0.1),rgba(59,130,246,0.08));border:1px solid rgba(124,58,237,0.15);border-radius:16px;padding:16px;margin-bottom:16px">
      <div style="font-size:12px;font-weight:600;color:var(--accent2);margin-bottom:8px">AI Market Insight</div>
      <div id="mkt-insight" style="font-size:13px;color:var(--text);line-height:1.5">Analyzing market conditions...</div>
    </div>
    <p style="font-size:11px;color:var(--text3);text-align:center">Data for informational purposes only. Not investment advice. Full trading features coming soon.</p>
  </div>
</div>

<!-- Pay by Phone Modal -->
<div class="modal-overlay" id="pay-modal">
  <div class="modal-sheet">
    <div class="modal-handle"></div>
    <h3 style="margin-bottom:8px;font-size:20px;font-weight:700">Pay by Phone</h3>
    <p style="font-size:13px;color:var(--text2);margin-bottom:20px">Use Apple Pay, Google Pay, or your saved cards</p>
    <div style="margin-bottom:16px">
      <label style="font-size:12px;color:var(--text2);display:block;margin-bottom:6px">Amount</label>
      <input id="pay-amount" placeholder="$0.00" type="number" step="0.01" style="width:100%;padding:14px;background:var(--surface);border:1px solid var(--glass-border);border-radius:12px;color:var(--text);font-size:24px;font-weight:700;font-family:inherit;outline:none;text-align:center">
    </div>
    <div style="margin-bottom:20px">
      <label style="font-size:12px;color:var(--text2);display:block;margin-bottom:6px">What's this for?</label>
      <input id="pay-label" placeholder="Coffee, groceries, etc." style="width:100%;padding:14px;background:var(--surface);border:1px solid var(--glass-border);border-radius:12px;color:var(--text);font-size:14px;font-family:inherit;outline:none">
    </div>
    <button onclick="executePayByPhone()" style="width:100%;padding:16px;background:var(--gradient2);border:none;border-radius:14px;color:white;font-size:16px;font-weight:600;cursor:pointer;font-family:inherit;box-shadow:0 4px 20px rgba(124,58,237,0.3);display:flex;align-items:center;justify-content:center;gap:8px">
      <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="5" y="2" width="14" height="20" rx="2" ry="2"/><line x1="12" y1="18" x2="12.01" y2="18"/></svg>
      Pay Now
    </button>
    <button onclick="closeModals()" style="width:100%;padding:14px;background:none;border:none;color:var(--text2);font-size:14px;cursor:pointer;margin-top:8px;font-family:inherit">Cancel</button>
  </div>
</div>

<!-- Airtime Modal -->
<div class="modal-overlay" id="airtime-modal" onclick="if(event.target===this)closeAirtimeModal()">
  <div class="modal-sheet">
    <div class="modal-handle"></div>
    <h3 style="margin-bottom: 4px;">Top Up Phone</h3>
    <p style="font-size: 0.85rem; opacity: 0.7; margin-bottom: 16px;">Buy airtime or data instantly - 2% convenience fee</p>

    <!-- Buy for self or someone else -->
    <div style="display:flex;gap:8px;margin-bottom:14px;">
      <button id="airtime-self-btn" onclick="setAirtimeRecipient('self')" style="flex:1;padding:10px;border-radius:10px;border:1px solid rgba(124,58,237,0.4);background:rgba(124,58,237,0.15);color:white;cursor:pointer;font-size:13px;font-weight:600;">For myself</button>
      <button id="airtime-other-btn" onclick="setAirtimeRecipient('other')" style="flex:1;padding:10px;border-radius:10px;border:1px solid rgba(255,255,255,0.1);background:rgba(255,255,255,0.03);color:var(--text2);cursor:pointer;font-size:13px;">For someone else</button>
    </div>

    <!-- Country -->
    <label style="font-size:12px;color:var(--text2);display:block;margin-bottom:6px">Country</label>
    <select id="airtime-country" onchange="updateCarriers()" style="width:100%;padding:14px;border-radius:12px;border:1px solid rgba(255,255,255,0.1);background:rgba(255,255,255,0.05);color:white;font-size:1rem;margin-bottom:12px;-webkit-appearance:none;appearance:none;">
      <option value="NG">Nigeria (+234)</option>
      <option value="GH">Ghana (+233)</option>
      <option value="UG">Uganda (+256)</option>
      <option value="KE">Kenya (+254)</option>
      <option value="ZA">South Africa (+27)</option>
      <option value="TZ">Tanzania (+255)</option>
      <option value="CM">Cameroon (+237)</option>
      <option value="SN">Senegal (+221)</option>
      <option value="ET">Ethiopia (+251)</option>
    </select>

    <!-- Carrier -->
    <label style="font-size:12px;color:var(--text2);display:block;margin-bottom:6px">Carrier / Operator</label>
    <select id="airtime-carrier" style="width:100%;padding:14px;border-radius:12px;border:1px solid rgba(255,255,255,0.1);background:rgba(255,255,255,0.05);color:white;font-size:1rem;margin-bottom:12px;-webkit-appearance:none;appearance:none;">
      <!-- Populated by updateCarriers() -->
    </select>

    <!-- Phone Number -->
    <label style="font-size:12px;color:var(--text2);display:block;margin-bottom:6px"><span id="airtime-phone-label">Your phone number</span></label>
    <div style="display:flex;gap:8px;margin-bottom:12px;">
      <span id="airtime-dial-code" style="padding:14px 12px;border-radius:12px;border:1px solid rgba(255,255,255,0.1);background:rgba(255,255,255,0.05);color:var(--text2);font-size:1rem;white-space:nowrap;">+234</span>
      <input id="airtime-phone" type="tel" placeholder="8012345678" style="flex:1;padding:14px;border-radius:12px;border:1px solid rgba(255,255,255,0.1);background:rgba(255,255,255,0.05);color:white;font-size:1rem;box-sizing:border-box;">
    </div>

    <!-- Amount presets (updated per country currency) -->
    <label style="font-size:12px;color:var(--text2);display:block;margin-bottom:6px">Amount (<span id="airtime-currency-label">NGN</span>)</label>
    <div id="airtime-presets" style="display:grid;grid-template-columns:repeat(4,1fr);gap:8px;margin-bottom:12px;">
      <!-- Populated by updateCarriers() -->
    </div>
    <input id="airtime-amount" type="number" placeholder="Custom amount" style="width:100%;padding:14px;border-radius:12px;border:1px solid rgba(255,255,255,0.1);background:rgba(255,255,255,0.05);color:white;font-size:1rem;margin-bottom:4px;box-sizing:border-box;">
    <div id="airtime-fee-display" style="font-size:12px;color:var(--text3);margin-bottom:14px;text-align:right;">Fee: 2% convenience charge</div>

    <!-- Action buttons -->
    <div style="display:grid;grid-template-columns:1fr 1fr;gap:8px;">
      <button onclick="executeAirtime('airtime')" style="padding:14px;border-radius:12px;border:none;background:linear-gradient(135deg,#f97316,#ea580c);color:white;font-weight:600;cursor:pointer;font-size:14px;">Buy Airtime</button>
      <button onclick="executeAirtime('data')" style="padding:14px;border-radius:12px;border:none;background:linear-gradient(135deg,#3b82f6,#2563eb);color:white;font-weight:600;cursor:pointer;font-size:14px;">Buy Data</button>
    </div>
  </div>
</div>

<!-- Request Money Modal -->
<div class="modal-overlay" id="request-modal" onclick="if(event.target===this)closeRequestModal()">
  <div class="modal-sheet">
    <div class="modal-handle"></div>
    <h3 style="margin-bottom: 4px;">💸 Request Money</h3>
    <p style="font-size: 0.85rem; opacity: 0.7; margin-bottom: 16px;">Send a payment request — they need PromptPay to pay</p>
    <input id="request-contact" type="text" placeholder="Email, phone, or $paytag" style="width: 100%; padding: 14px; border-radius: 12px; border: 1px solid rgba(255,255,255,0.1); background: rgba(255,255,255,0.05); color: white; font-size: 1rem; margin-bottom: 12px; box-sizing: border-box;">
    <input id="request-amount" type="number" placeholder="Amount ($)" style="width: 100%; padding: 14px; border-radius: 12px; border: 1px solid rgba(255,255,255,0.1); background: rgba(255,255,255,0.05); color: white; font-size: 1rem; margin-bottom: 12px; box-sizing: border-box;">
    <input id="request-message" type="text" placeholder="What's it for? (optional)" style="width: 100%; padding: 14px; border-radius: 12px; border: 1px solid rgba(255,255,255,0.1); background: rgba(255,255,255,0.05); color: white; font-size: 1rem; margin-bottom: 12px; box-sizing: border-box;">
    <button onclick="executeRequestMoney()" style="width: 100%; padding: 14px; border-radius: 12px; border: none; background: linear-gradient(135deg, #7c3aed, #6d28d9); color: white; font-weight: 600; font-size: 1rem; cursor: pointer;">Send Request</button>
  </div>
</div>

<!-- PayTag Setup Modal -->
<div class="modal-overlay" id="paytag-modal" onclick="if(event.target===this)closePaytagModal()">
  <div class="modal-sheet">
    <div class="modal-handle"></div>
    <h3 style="margin-bottom: 4px;">Claim Your $PayTag</h3>
    <p style="font-size: 0.85rem; opacity: 0.7; margin-bottom: 16px;">Like Cash App's $cashtag — your unique payment identity</p>
    <div style="display: flex; align-items: center; gap: 4px; margin-bottom: 12px;">
      <span style="font-size: 1.5rem; font-weight: 700; color: #7c3aed;">$</span>
      <input id="paytag-input" type="text" placeholder="yourname" maxlength="20" style="flex: 1; padding: 14px; border-radius: 12px; border: 1px solid rgba(255,255,255,0.1); background: rgba(255,255,255,0.05); color: white; font-size: 1.1rem; font-weight: 600; box-sizing: border-box;">
    </div>
    <p id="paytag-hint" style="font-size: 0.8rem; opacity: 0.5; margin-bottom: 16px;">Letters, numbers, and underscores only. 3-20 characters.</p>
    <button onclick="claimPaytag()" style="width: 100%; padding: 14px; border-radius: 12px; border: none; background: linear-gradient(135deg, #7c3aed, #6d28d9); color: white; font-weight: 600; font-size: 1rem; cursor: pointer;">Claim $PayTag</button>
  </div>
</div>

<!-- Settings Toast -->
<div class="settings-saved-toast" id="settings-toast">Settings saved successfully</div>

<!-- KYC Verification Modal -->
<div class="modal-overlay" id="kyc-modal">
  <div class="modal-sheet" style="max-height:90vh">
    <div class="modal-handle"></div>
    <h3 style="margin-bottom:4px;font-size:20px;font-weight:700">Verify Your Identity</h3>
    <p id="kyc-subtitle" style="font-size:13px;color:var(--text2);margin-bottom:20px">Complete verification to start sending money</p>
    <div id="kyc-tier-badge" style="display:inline-block;padding:4px 12px;border-radius:20px;font-size:11px;font-weight:600;background:rgba(255,255,255,0.06);color:var(--text2);margin-bottom:16px">Unverified</div>

    <!-- Country-specific KYC fields -->
    <div id="kyc-fields">
      <!-- Nigeria -->
      <div id="kyc-ng" class="kyc-country-form" style="display:none">
        <div style="margin-bottom:14px">
          <label style="font-size:12px;color:var(--text2);display:block;margin-bottom:6px">BVN (Bank Verification Number)</label>
          <input id="kyc-bvn" placeholder="22200000000" maxlength="11" inputmode="numeric" style="width:100%;padding:14px;background:var(--surface);border:1px solid var(--glass-border);border-radius:12px;color:var(--text);font-size:14px;font-family:inherit;outline:none">
          <div style="font-size:11px;color:var(--text3);margin-top:4px">Dial *565*0# on your phone to get your BVN</div>
        </div>
        <div style="margin-bottom:14px">
          <label style="font-size:12px;color:var(--text2);display:block;margin-bottom:6px">NIN (National ID Number) <span style="opacity:0.5">optional for Tier 1</span></label>
          <input id="kyc-nin" placeholder="00000000000" maxlength="11" inputmode="numeric" style="width:100%;padding:14px;background:var(--surface);border:1px solid var(--glass-border);border-radius:12px;color:var(--text);font-size:14px;font-family:inherit;outline:none">
        </div>
      </div>

      <!-- Ghana -->
      <div id="kyc-gh" class="kyc-country-form" style="display:none">
        <div style="margin-bottom:14px">
          <label style="font-size:12px;color:var(--text2);display:block;margin-bottom:6px">Ghana Card Number</label>
          <input id="kyc-ghana-card" placeholder="GHA-XXXXXXXXX-X" maxlength="15" style="width:100%;padding:14px;background:var(--surface);border:1px solid var(--glass-border);border-radius:12px;color:var(--text);font-size:14px;font-family:inherit;outline:none">
        </div>
      </div>

      <!-- Kenya / Uganda -->
      <div id="kyc-ke-ug" class="kyc-country-form" style="display:none">
        <div style="margin-bottom:14px">
          <label style="font-size:12px;color:var(--text2);display:block;margin-bottom:6px">National ID Number</label>
          <input id="kyc-national-id" placeholder="Enter your national ID" inputmode="numeric" style="width:100%;padding:14px;background:var(--surface);border:1px solid var(--glass-border);border-radius:12px;color:var(--text);font-size:14px;font-family:inherit;outline:none">
        </div>
      </div>

      <!-- US -->
      <div id="kyc-us" class="kyc-country-form" style="display:none">
        <div style="margin-bottom:14px">
          <label style="font-size:12px;color:var(--text2);display:block;margin-bottom:6px">Date of Birth</label>
          <input id="kyc-dob" type="date" style="width:100%;padding:14px;background:var(--surface);border:1px solid var(--glass-border);border-radius:12px;color:var(--text);font-size:14px;font-family:inherit;outline:none">
        </div>
      </div>

      <!-- South Africa -->
      <div id="kyc-za" class="kyc-country-form" style="display:none">
        <div style="margin-bottom:14px">
          <label style="font-size:12px;color:var(--text2);display:block;margin-bottom:6px">SA ID Number</label>
          <input id="kyc-sa-id" placeholder="13-digit SA ID number" maxlength="13" inputmode="numeric" style="width:100%;padding:14px;background:var(--surface);border:1px solid var(--glass-border);border-radius:12px;color:var(--text);font-size:14px;font-family:inherit;outline:none">
        </div>
      </div>

      <!-- Generic Africa (TZ, CM, SN, ET) -->
      <div id="kyc-generic-africa" class="kyc-country-form" style="display:none">
        <div style="margin-bottom:14px">
          <label style="font-size:12px;color:var(--text2);display:block;margin-bottom:6px">National ID Number</label>
          <input id="kyc-national-id-generic" placeholder="Your national ID number" style="width:100%;padding:14px;background:var(--surface);border:1px solid var(--glass-border);border-radius:12px;color:var(--text);font-size:14px;font-family:inherit;outline:none">
        </div>
      </div>

      <!-- Common fields -->
      <div style="margin-bottom:14px">
        <label style="font-size:12px;color:var(--text2);display:block;margin-bottom:6px">Full Legal Name</label>
        <input id="kyc-fullname" placeholder="As it appears on your ID" style="width:100%;padding:14px;background:var(--surface);border:1px solid var(--glass-border);border-radius:12px;color:var(--text);font-size:14px;font-family:inherit;outline:none">
      </div>
      <div style="margin-bottom:20px">
        <label style="font-size:12px;color:var(--text2);display:block;margin-bottom:6px">Phone Number</label>
        <input id="kyc-phone" placeholder="+234..." type="tel" style="width:100%;padding:14px;background:var(--surface);border:1px solid var(--glass-border);border-radius:12px;color:var(--text);font-size:14px;font-family:inherit;outline:none">
      </div>
    </div>

    <div id="kyc-limits-preview" style="padding:12px 16px;background:rgba(124,58,237,0.08);border-radius:12px;margin-bottom:16px;font-size:12px;color:var(--text2)"></div>

    <button id="kyc-submit-btn" onclick="submitKyc()" style="width:100%;padding:16px;background:var(--gradient2);border:none;border-radius:14px;color:white;font-size:16px;font-weight:600;cursor:pointer;font-family:inherit;box-shadow:0 4px 20px rgba(124,58,237,0.3)">Verify & Continue</button>
    <button onclick="closeModals()" style="width:100%;padding:14px;background:none;border:none;color:var(--text2);font-size:14px;cursor:pointer;margin-top:8px;font-family:inherit">Skip for now</button>
    <div id="kyc-error" style="color:var(--red);font-size:13px;margin-top:12px;text-align:center"></div>
  </div>
</div>

<!-- Link Bank Account Modal -->
<div class="modal-overlay" id="bank-modal">
  <div class="modal-sheet">
    <div class="modal-handle"></div>
    <h3 style="margin-bottom:8px;font-size:20px;font-weight:700">Link Bank Account</h3>
    <p style="font-size:13px;color:var(--text2);margin-bottom:20px">Add your bank for instant transfers</p>
    <div style="margin-bottom:14px">
      <label style="font-size:12px;color:var(--text2);display:block;margin-bottom:6px">Bank</label>
      <select id="bank-select" onchange="onBankSelect()" style="width:100%;padding:14px;background:var(--surface);border:1px solid var(--glass-border);border-radius:12px;color:var(--text);font-size:14px;font-family:inherit;outline:none;-webkit-appearance:none">
        <option value="">Select your bank</option>
      </select>
    </div>
    <div style="margin-bottom:14px">
      <label style="font-size:12px;color:var(--text2);display:block;margin-bottom:6px">Account Number</label>
      <input id="bank-account-number" placeholder="0000000000" maxlength="10" inputmode="numeric" style="width:100%;padding:14px;background:var(--surface);border:1px solid var(--glass-border);border-radius:12px;color:var(--text);font-size:14px;font-family:inherit;outline:none">
    </div>
    <div id="bank-account-name" style="padding:10px 16px;background:rgba(16,185,129,0.1);border-radius:10px;margin-bottom:16px;font-size:13px;color:var(--emerald);display:none"></div>
    <button onclick="submitBankAccount()" style="width:100%;padding:16px;background:var(--gradient2);border:none;border-radius:14px;color:white;font-size:16px;font-weight:600;cursor:pointer;font-family:inherit">Link Account</button>
    <button onclick="closeModals()" style="width:100%;padding:14px;background:none;border:none;color:var(--text2);font-size:14px;cursor:pointer;margin-top:8px;font-family:inherit">Cancel</button>
    <div id="bank-error" style="color:var(--red);font-size:13px;margin-top:12px;text-align:center"></div>
  </div>
</div>

<!-- Link Mobile Money Modal -->
<div class="modal-overlay" id="momo-modal">
  <div class="modal-sheet">
    <div class="modal-handle"></div>
    <h3 style="margin-bottom:8px;font-size:20px;font-weight:700">Link Mobile Money</h3>
    <p style="font-size:13px;color:var(--text2);margin-bottom:20px">Add your mobile money wallet</p>
    <div style="margin-bottom:14px">
      <label style="font-size:12px;color:var(--text2);display:block;margin-bottom:6px">Provider</label>
      <select id="momo-provider" style="width:100%;padding:14px;background:var(--surface);border:1px solid var(--glass-border);border-radius:12px;color:var(--text);font-size:14px;font-family:inherit;outline:none;-webkit-appearance:none">
        <option value="">Select provider</option>
      </select>
    </div>
    <div style="margin-bottom:14px">
      <label style="font-size:12px;color:var(--text2);display:block;margin-bottom:6px">Phone Number</label>
      <input id="momo-phone" placeholder="+233..." type="tel" style="width:100%;padding:14px;background:var(--surface);border:1px solid var(--glass-border);border-radius:12px;color:var(--text);font-size:14px;font-family:inherit;outline:none">
    </div>
    <button onclick="submitMobileWallet()" style="width:100%;padding:16px;background:var(--gradient2);border:none;border-radius:14px;color:white;font-size:16px;font-weight:600;cursor:pointer;font-family:inherit">Link Wallet</button>
    <button onclick="closeModals()" style="width:100%;padding:14px;background:none;border:none;color:var(--text2);font-size:14px;cursor:pointer;margin-top:8px;font-family:inherit">Cancel</button>
    <div id="momo-error" style="color:var(--red);font-size:13px;margin-top:12px;text-align:center"></div>
  </div>
</div>

<!-- Premium Feature Popup -->
<div class="premium-popup-overlay" id="premium-popup" onclick="if(event.target===this)closePremiumPopup()">
  <div class="premium-popup">
    <div class="premium-popup-icon" id="premium-popup-icon"></div>
    <h3 id="premium-popup-title">Unlock Premium</h3>
    <p>Unlock AI Shopping, Trading, Budgets & more with PromptPay Premium.</p>
    <div class="price">$19.99/month</div>
    <button class="btn-subscribe" onclick="subscribePremium()">Subscribe Now</button>
    <button class="btn-later" onclick="closePremiumPopup()">Maybe Later</button>
  </div>
</div>

<script>
// ═══ PromptPay Frontend Engine ═══
const API_BASE = '';
let ws = null;
let currentPage = 'home';
let tokenStats = { used: 0, cached: 0, saved: 0 };
let chatHistory = [];
let animatedBalance = 0;
let authToken = localStorage.getItem('promptpay_token') || null;
let currentUser = null;
let userKyc = null;
let countryConfig = null;
let userBankAccounts = [];
let userMobileWallets = [];
let currentSendType = 'bank';

// ── Token Expiry Check (client-side) ──
function isTokenExpired(token) {
  try {
    const parts = token.split('.');
    if (parts.length < 2) return true;
    const payload = JSON.parse(atob(parts[0].replace(/-/g, '+').replace(/_/g, '/')));
    return !payload.exp || payload.exp < Date.now();
  } catch { return true; }
}

// Auto-clear expired token on load
if (authToken && isTokenExpired(authToken)) {
  localStorage.removeItem('promptpay_token');
  authToken = null;
}

// ── Auth Helpers ──
function getAuthHeaders() {
  const headers = { 'Content-Type': 'application/json' };
  if (authToken) headers['Authorization'] = 'Bearer ' + authToken;
  return headers;
}

async function authFetch(url, options = {}) {
  // Auto-clear expired tokens before making requests
  if (authToken && isTokenExpired(authToken)) {
    localStorage.removeItem('promptpay_token');
    authToken = null;
    currentUser = null;
    showAuthGate('login');
    document.getElementById('login-error').textContent = 'Your session has expired. Please sign in again.';
    return new Response(JSON.stringify({ error: 'Token expired' }), { status: 401 });
  }
  options.headers = { ...getAuthHeaders(), ...(options.headers || {}) };
  const res = await fetch(url, options);
  if (res.status === 401) {
    localStorage.removeItem('promptpay_token');
    authToken = null;
    currentUser = null;
    showAuthGate('login');
    document.getElementById('login-error').textContent = 'Your session has expired. Please sign in again.';
  }
  return res;
}

// ── Auth Gate ──
function switchAuthTab(tab) {
  document.querySelectorAll('.auth-tab').forEach(t => t.classList.remove('active'));
  document.querySelectorAll('.auth-form').forEach(f => f.classList.remove('active'));
  if (tab === 'login') {
    document.querySelectorAll('.auth-tab')[0].classList.add('active');
    document.getElementById('auth-login-form').classList.add('active');
  } else {
    document.querySelectorAll('.auth-tab')[1].classList.add('active');
    document.getElementById('auth-register-form').classList.add('active');
  }
  // Clear errors
  document.getElementById('login-error').textContent = '';
  document.getElementById('register-error').textContent = '';
}

function togglePassword(inputId, btn) {
  const input = document.getElementById(inputId);
  const isHidden = input.type === 'password';
  input.type = isHidden ? 'text' : 'password';
  btn.querySelector('.eye-open').style.display = isHidden ? 'none' : 'block';
  btn.querySelector('.eye-closed').style.display = isHidden ? 'block' : 'none';
  btn.setAttribute('aria-label', isHidden ? 'Hide password' : 'Show password');
}

async function handleLogin(e) {
  e.preventDefault();
  const email = document.getElementById('login-email').value.trim();
  const password = document.getElementById('login-password').value;
  const errorEl = document.getElementById('login-error');
  const submitBtn = document.getElementById('login-submit');
  errorEl.textContent = '';
  submitBtn.disabled = true;
  submitBtn.textContent = 'Signing in...';

  try {
    const res = await fetch(API_BASE + '/api/auth/login', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ email, password })
    });
    const data = await res.json();
    if (!res.ok) {
      errorEl.textContent = data.error || data.message || 'Invalid credentials';
      return;
    }
    authToken = data.token;
    currentUser = data.user;
    localStorage.setItem('promptpay_token', authToken);
    showApp();
  } catch (err) {
    errorEl.textContent = 'Connection error. Please try again.';
  } finally {
    submitBtn.disabled = false;
    submitBtn.textContent = 'Sign In';
  }
}

async function handleRegister(e) {
  e.preventDefault();
  const displayName = document.getElementById('register-name').value.trim();
  const email = document.getElementById('register-email').value.trim();
  const country = document.getElementById('register-country').value;
  const password = document.getElementById('register-password').value;
  const errorEl = document.getElementById('register-error');
  const submitBtn = document.getElementById('register-submit');
  errorEl.textContent = '';
  if (!country) { errorEl.textContent = 'Please select your country'; return; }
  submitBtn.disabled = true;
  submitBtn.textContent = 'Creating account...';

  try {
    const res = await fetch(API_BASE + '/api/auth/register', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ email, password, displayName, country })
    });
    const data = await res.json();
    if (!res.ok) {
      errorEl.textContent = data.error || data.message || 'Registration failed';
      return;
    }
    authToken = data.token;
    currentUser = data.user;
    localStorage.setItem('promptpay_token', authToken);
    showApp();
  } catch (err) {
    errorEl.textContent = 'Connection error. Please try again.';
  } finally {
    submitBtn.disabled = false;
    submitBtn.textContent = 'Create Account';
  }
}

function handleLogout() {
  authToken = null;
  currentUser = null;
  localStorage.removeItem('promptpay_token');
  document.getElementById('login-email').value = '';
  document.getElementById('login-password').value = '';
  document.getElementById('register-name').value = '';
  document.getElementById('register-email').value = '';
  document.getElementById('register-password').value = '';
  document.getElementById('login-error').textContent = '';
  document.getElementById('register-error').textContent = '';
  navigateTo('home');
  showLanding();
  startLandingTyping();
}

function showApp() {
  enterAppMode();
  if (currentUser) {
    const name = currentUser.displayName || currentUser.email || 'User';
    document.querySelector('.header-name').textContent = name;
    const initials = name.split(' ').map(n => n[0]).join('').toUpperCase().slice(0, 2);
    // Update header avatar — show picture or initials
    const headerAvatar = document.querySelector('.header-avatar');
    if (currentUser.profilePicture) {
      headerAvatar.innerHTML = '<img src="' + currentUser.profilePicture + '" style="width:100%;height:100%;object-fit:cover;border-radius:50%">';
    } else {
      headerAvatar.textContent = initials || 'PP';
    }
    // Update profile page
    const profilePicImg = document.getElementById('profile-pic-img');
    const profilePicInitials = document.getElementById('profile-pic-initials');
    if (currentUser.profilePicture && profilePicImg) {
      profilePicImg.src = currentUser.profilePicture;
      profilePicImg.style.display = 'block';
      if (profilePicInitials) profilePicInitials.style.display = 'none';
    } else if (profilePicInitials) {
      profilePicInitials.textContent = initials || 'PP';
    }
    const profileName = document.getElementById('profile-display-name');
    if (profileName) profileName.textContent = name;
    const profileEmail = document.getElementById('profile-email-display');
    if (profileEmail) profileEmail.textContent = currentUser.email || '';
    // Save country for geo-gating
    if (currentUser.country) {
      localStorage.setItem('promptpay_country', currentUser.country);
    }
  }
  // Geo-gate: hide airtime button for US/Europe users
  applyAirtimeGeoGate();
  loadData();
  connectWebSocket();
  updateTokenMatrix();
  loadSettings();
  loadPaymentMethods();
}

async function handleProfilePicUpload(event) {
  const file = event.target.files[0];
  if (!file) return;
  if (file.size > 1.5 * 1024 * 1024) {
    showToast('Image too large. Max 1.5MB');
    return;
  }
  const reader = new FileReader();
  reader.onload = async function(e) {
    const dataUrl = e.target.result;
    try {
      const res = await authFetch(API_BASE + '/api/auth/profile-picture', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ image: dataUrl }),
      });
      if (res.ok) {
        currentUser.profilePicture = dataUrl;
        // Update header
        const headerAvatar = document.querySelector('.header-avatar');
        headerAvatar.innerHTML = '<img src="' + dataUrl + '" style="width:100%;height:100%;object-fit:cover;border-radius:50%">';
        // Update profile page
        const img = document.getElementById('profile-pic-img');
        const initials = document.getElementById('profile-pic-initials');
        if (img) { img.src = dataUrl; img.style.display = 'block'; }
        if (initials) initials.style.display = 'none';
        showToast('Profile picture updated!');
      } else {
        showToast('Failed to upload picture');
      }
    } catch(err) {
      showToast('Upload failed');
    }
  };
  reader.readAsDataURL(file);
}

function applyAirtimeGeoGate() {
  const country = getUserCountry();
  const airtimeBtn = document.getElementById('airtime-quick-btn');
  const billsBtn = document.getElementById('bills-quick-btn');
  const isAfrican = ['NG','GH','KE','UG','ZA','TZ','CM','SN','ET'].includes(country);
  const owner = isOwner();
  if (airtimeBtn) {
    airtimeBtn.style.display = (owner || (isAfrican && !NON_AIRTIME_COUNTRIES.includes(country))) ? '' : 'none';
  }
  if (billsBtn) {
    billsBtn.style.display = (owner || isAfrican) ? '' : 'none';
  }
}

async function validateToken() {
  if (!authToken) return false;
  // Client-side expiry check — avoids 401 server hit entirely
  if (isTokenExpired(authToken)) {
    localStorage.removeItem('promptpay_token');
    authToken = null;
    return false;
  }
  try {
    const res = await authFetch(API_BASE + '/api/auth/me');
    if (res.ok) {
      const data = await res.json();
      currentUser = data.user || data;
      return true;
    }
    // Token invalid on server
    localStorage.removeItem('promptpay_token');
    authToken = null;
    return false;
  } catch (e) {
    // Server might be down; keep token and let user in
    return true;
  }
}

// ── Settings Dropdown ──
function toggleSettingsDropdown(e) {
  e.stopPropagation();
  const dropdown = document.getElementById('settings-dropdown');
  dropdown.classList.toggle('open');
}

function closeSettingsDropdown() {
  document.getElementById('settings-dropdown').classList.remove('open');
}

// Close dropdown when clicking elsewhere
document.addEventListener('click', function(e) {
  const wrap = document.getElementById('settings-dropdown-wrap');
  if (wrap && !wrap.contains(e.target)) {
    closeSettingsDropdown();
  }
});

// ── Navigation Drawer ──
function openNavDrawer() {
  // Update drawer user info
  if (currentUser) {
    const nameEl = document.getElementById('drawer-user-name');
    const emailEl = document.getElementById('drawer-user-email');
    if (nameEl) nameEl.textContent = currentUser.displayName || 'PromptPay';
    if (emailEl) emailEl.textContent = currentUser.email || '';
  }
  // Highlight current page
  document.querySelectorAll('.nav-drawer-item[data-drawer]').forEach(item => {
    item.classList.toggle('active', item.dataset.drawer === currentPage);
  });
  document.getElementById('nav-drawer-overlay').classList.add('open');
}

function closeNavDrawer() {
  document.getElementById('nav-drawer-overlay').classList.remove('open');
}

function drawerNav(page) {
  closeNavDrawer();
  navigateTo(page);
}

// ── Settings Page Logic ──
function toggleChannel(el) {
  el.classList.toggle('active');
  const toggle = el.querySelector('.toggle-switch');
  toggle.classList.toggle('on');
}

async function savePreferences() {
  const language = document.getElementById('settings-language').value;
  const timezone = document.getElementById('settings-timezone').value;
  const pushEnabled = document.querySelector('[data-channel="push"]')?.classList.contains('active');
  const emailEnabled = document.querySelector('[data-channel="email"]')?.classList.contains('active');

  try {
    const res = await authFetch(API_BASE + '/api/user/settings', {
      method: 'PUT',
      body: JSON.stringify({ preferredChannels: [pushEnabled && 'push', emailEnabled && 'email'].filter(Boolean), language, timezone })
    });
    if (res.ok) {
      showToast('Preferences saved successfully');
    } else {
      showToast('Saved locally. Will sync when online.');
    }
  } catch (e) {
    showToast('Saved locally. Will sync when online.');
  }
  localStorage.setItem('promptpay_settings', JSON.stringify({ language, timezone }));
}

async function loadSettings() {
  try {
    const res = await authFetch(API_BASE + '/api/user/settings');
    if (res.ok) {
      const data = await res.json();
      applySettings(data);
      return;
    }
  } catch (e) {}
  const local = localStorage.getItem('promptpay_settings');
  if (local) {
    try { applySettings(JSON.parse(local)); } catch(e) {}
  }
}

function applySettings(settings) {
  if (!settings) return;
  if (settings.language) document.getElementById('settings-language').value = settings.language;
  if (settings.timezone) document.getElementById('settings-timezone').value = settings.timezone;
}

// ── PWA Install ──
let deferredInstallPrompt = null;
window.addEventListener('beforeinstallprompt', (e) => {
  e.preventDefault();
  deferredInstallPrompt = e;
  const btn = document.getElementById('install-app-btn');
  if (btn) btn.textContent = 'Add to Home Screen';
});

function installApp() {
  if (deferredInstallPrompt) {
    deferredInstallPrompt.prompt();
    deferredInstallPrompt.userChoice.then((result) => {
      if (result.outcome === 'accepted') {
        showToast('App installed! Find it on your home screen.');
      }
      deferredInstallPrompt = null;
    });
  } else if (window.matchMedia('(display-mode: standalone)').matches) {
    showToast('App is already installed!');
  } else {
    // iOS Safari or browser without install prompt
    showToast('Tap your browser\'s Share button, then "Add to Home Screen"');
  }
}

// Hide install section if already installed as PWA
if (window.matchMedia('(display-mode: standalone)').matches) {
  const section = document.getElementById('install-app-section');
  if (section) {
    section.querySelector('.settings-section-title').insertAdjacentHTML('afterend',
      '<div style="padding:8px 0;color:var(--emerald);font-size:13px;font-weight:500">App is installed</div>');
    const btn = document.getElementById('install-app-btn');
    if (btn) btn.style.display = 'none';
  }
}

// Register service worker + push notifications
if ('serviceWorker' in navigator) {
  navigator.serviceWorker.register('/sw.js').then(async (registration) => {
    console.log('Service worker registered');

    // Subscribe to push notifications if logged in
    const token = localStorage.getItem('promptpay_token') || localStorage.getItem('token');
    if (token && 'PushManager' in window) {
      try {
        const vapidRes = await fetch('/api/push/vapid-key');
        if (!vapidRes.ok) return;
        const { publicKey } = await vapidRes.json();
        if (!publicKey) return;

        let subscription = await registration.pushManager.getSubscription();
        if (!subscription) {
          const urlBase64ToUint8Array = (base64String) => {
            const padding = '='.repeat((4 - base64String.length % 4) % 4);
            const base64 = (base64String + padding).replace(/-/g, '+').replace(/_/g, '/');
            const rawData = atob(base64);
            return Uint8Array.from([...rawData].map(c => c.charCodeAt(0)));
          };
          subscription = await registration.pushManager.subscribe({
            userVisibleOnly: true,
            applicationServerKey: urlBase64ToUint8Array(publicKey),
          });
        }

        await fetch('/api/push/subscribe', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json', 'Authorization': 'Bearer ' + token },
          body: JSON.stringify({ subscription }),
        });
        console.log('Push subscription registered');
      } catch (err) {
        console.log('Push subscription skipped:', err.message || err);
      }
    }
  }).catch((err) => {
    console.log('SW registration failed:', err);
  });
}

// ── Pay by Phone (Payment Request API) ──
async function payByPhone(amount, label, merchantId) {
  if (!window.PaymentRequest) {
    showToast('Payment Request API not supported in this browser');
    return null;
  }

  const methods = [
    {
      supportedMethods: 'https://apple.com/apple-pay',
      data: {
        version: 3,
        merchantIdentifier: 'merchant.com.promptpay',
        merchantCapabilities: ['supports3DS'],
        supportedNetworks: ['visa', 'masterCard', 'amex'],
        countryCode: 'US',
      },
    },
    {
      supportedMethods: 'https://google.com/pay',
      data: {
        environment: 'PRODUCTION',
        apiVersion: 2,
        apiVersionMinor: 0,
        merchantInfo: { merchantId: merchantId || 'promptpay', merchantName: 'PromptPay' },
        allowedPaymentMethods: [{
          type: 'CARD',
          parameters: { allowedAuthMethods: ['PAN_ONLY', 'CRYPTOGRAM_3DS'], allowedCardNetworks: ['VISA', 'MASTERCARD', 'AMEX'] },
          tokenizationSpecification: { type: 'PAYMENT_GATEWAY', parameters: { gateway: 'stripe', 'stripe:version': '2024-12-18.acacia', 'stripe:publishableKey': 'pk_live_placeholder' } },
        }],
      },
    },
    { supportedMethods: 'basic-card', data: { supportedNetworks: ['visa', 'mastercard', 'amex'] } },
  ];

  const details = {
    total: { label: label || 'PromptPay Payment', amount: { currency: 'USD', value: String(amount) } },
    displayItems: [
      { label: label || 'Payment', amount: { currency: 'USD', value: String(amount) } },
    ],
  };

  try {
    const request = new PaymentRequest(methods, details);
    const canMake = await request.canMakePayment();
    if (!canMake) {
      showToast('No supported payment method found on this device');
      return null;
    }
    const response = await request.show();
    await response.complete('success');
    showToast('Payment successful!');
    return response;
  } catch (err) {
    if (err.name !== 'AbortError') {
      showToast('Payment failed: ' + err.message);
    }
    return null;
  }
}

function showToast(message) {
  const toast = document.getElementById('settings-toast');
  toast.textContent = message;
  toast.classList.add('show');
  setTimeout(() => toast.classList.remove('show'), 2500);
}

// ── Time greeting ──
(function() {
  const h = new Date().getHours();
  const g = h < 12 ? 'morning' : h < 17 ? 'afternoon' : 'evening';
  document.getElementById('time-greeting').textContent = g;
})();

// ── Navigation ──
document.querySelectorAll('.nav-item').forEach(item => {
  item.addEventListener('click', () => {
    const page = item.dataset.page;
    if (page) navigateTo(page);
  });
});

function navigateTo(page) {
  currentPage = page;
  // Settings page has no bottom nav item, so deselect all if navigating there
  document.querySelectorAll('.nav-item').forEach(i => i.classList.toggle('active', i.dataset.page === page));
  document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
  const el = document.getElementById('page-' + page);
  if (el) {
    el.classList.add('active');
    el.scrollTop = 0;
  }
  if (page === 'ai') {
    setTimeout(() => document.getElementById('chat-input')?.focus(), 100);
  }
}

// ── Animated Balance Counter ──
function animateBalance(target) {
  const el = document.getElementById('balance-display');
  const start = animatedBalance;
  const duration = 1200;
  const startTime = performance.now();
  function tick(now) {
    const elapsed = now - startTime;
    const progress = Math.min(elapsed / duration, 1);
    const ease = 1 - Math.pow(1 - progress, 4);
    const current = start + (target - start) * ease;
    el.textContent = '$' + current.toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
    animatedBalance = current;
    if (progress < 1) requestAnimationFrame(tick);
  }
  requestAnimationFrame(tick);
}

// ── Load Dashboard Data ──
async function loadData() {
  try {
    const res = await authFetch(API_BASE + '/health');
    if (res.ok) {
      animateBalance(0);
    }
  } catch (e) {
    console.log('Server connecting...');
    animateBalance(0);
  }
  // Load KYC status + country config
  loadKycStatus();
  loadTransferHistory();
  loadBankAccounts();
  loadMobileWallets();
}

// ══════════════════════════════════════════════════════════
// KYC VERIFICATION SYSTEM
// ══════════════════════════════════════════════════════════

async function loadKycStatus() {
  try {
    const res = await authFetch(API_BASE + '/api/kyc/status');
    if (!res.ok) return;
    userKyc = await res.json();
    countryConfig = { currency: userKyc.currency, currencySymbol: userKyc.currencySymbol, limits: userKyc.limits, requirements: userKyc.requirements };
    updateKycBanner();
    updateBalanceCurrency();
    updateSendModal();
    // Auto-show KYC modal for new unverified users
    if (userKyc.tier === 0 && userKyc.country && ['NG','GH','KE','UG'].includes(userKyc.country)) {
      setTimeout(() => openKycModal(), 1500);
    }
  } catch (e) { console.log('KYC load skipped'); }
}

function updateKycBanner() {
  const banner = document.getElementById('kyc-banner');
  if (!banner || !userKyc) return;
  const tier = userKyc.tier || 0;
  const country = userKyc.country || '';
  if (!country) { banner.style.display = 'none'; return; }

  banner.style.display = 'block';
  const icon = document.getElementById('kyc-banner-icon');
  const title = document.getElementById('kyc-banner-title');
  const desc = document.getElementById('kyc-banner-desc');

  if (tier === 0) {
    banner.style.background = 'rgba(239,68,68,0.1)';
    icon.textContent = '!';
    icon.style.background = 'rgba(239,68,68,0.2)';
    icon.style.color = '#ef4444';
    title.textContent = 'Verification Required';
    title.style.color = '#ef4444';
    desc.textContent = 'Verify your identity to start sending money';
    desc.style.color = '#ef4444';
  } else if (tier === 1) {
    banner.style.background = 'rgba(251,191,36,0.08)';
    icon.textContent = '\u2713';
    icon.style.background = 'rgba(251,191,36,0.2)';
    icon.style.color = '#fbbf24';
    title.textContent = 'Basic Verified';
    title.style.color = '#fbbf24';
    const lim = userKyc.limits?.[1];
    desc.textContent = lim ? `Daily limit: ${userKyc.currencySymbol}${lim.dailySend.toLocaleString()} \u2022 Upgrade for more` : 'Tap to upgrade';
    desc.style.color = '#fbbf24';
  } else {
    banner.style.background = 'rgba(16,185,129,0.08)';
    icon.textContent = '\u2713';
    icon.style.background = 'rgba(16,185,129,0.2)';
    icon.style.color = '#10b981';
    title.textContent = `Tier ${tier} Verified`;
    title.style.color = '#10b981';
    const lim = userKyc.limits?.[tier];
    desc.textContent = lim ? `Daily limit: ${userKyc.currencySymbol}${lim.dailySend.toLocaleString()}` : 'Fully verified';
    desc.style.color = '#10b981';
  }
}

function updateBalanceCurrency() {
  if (!countryConfig || !countryConfig.currencySymbol) return;
  const sym = countryConfig.currencySymbol;
  const el = document.getElementById('balance-display');
  if (el && sym !== '$') el.textContent = sym + '0.00';
  const change = document.getElementById('balance-change');
  if (change) change.textContent = sym === '$' ? 'No activity yet' : `${sym}0.00 today`;
}

function openKycModal() {
  const country = userKyc?.country || currentUser?.country || getUserCountry();
  // Show correct country form
  document.querySelectorAll('.kyc-country-form').forEach(f => f.style.display = 'none');
  if (country === 'NG') document.getElementById('kyc-ng').style.display = 'block';
  else if (country === 'GH') document.getElementById('kyc-gh').style.display = 'block';
  else if (country === 'KE' || country === 'UG') document.getElementById('kyc-ke-ug').style.display = 'block';
  else if (country === 'US') document.getElementById('kyc-us').style.display = 'block';
  else if (country === 'ZA') { const el = document.getElementById('kyc-za'); if (el) el.style.display = 'block'; else document.getElementById('kyc-generic-africa')?.style.display !== undefined && (document.getElementById('kyc-generic-africa').style.display = 'block'); }
  else if (['TZ','CM','SN','ET'].includes(country)) { const el = document.getElementById('kyc-generic-africa'); if (el) el.style.display = 'block'; }

  // Set phone placeholder based on country
  const phonePh = { NG: '+234...', GH: '+233...', KE: '+254...', UG: '+256...', US: '+1...', ZA: '+27...', TZ: '+255...', CM: '+237...', SN: '+221...', ET: '+251...' };
  const phoneEl = document.getElementById('kyc-phone');
  if (phoneEl) phoneEl.placeholder = phonePh[country] || '+...';

  // Pre-fill name
  const nameEl = document.getElementById('kyc-fullname');
  if (nameEl && currentUser?.displayName) nameEl.value = currentUser.displayName;

  // Show limits preview
  const preview = document.getElementById('kyc-limits-preview');
  if (preview && userKyc?.limits) {
    const t1 = userKyc.limits[1];
    const sym = userKyc.currencySymbol || '$';
    if (t1) preview.innerHTML = `After verification: Send up to <b>${sym}${t1.dailySend.toLocaleString()}/day</b> \u2022 Hold up to <b>${sym}${t1.maxBalance.toLocaleString()}</b>`;
  }

  // Update tier badge
  const badge = document.getElementById('kyc-tier-badge');
  if (badge) {
    const tier = userKyc?.tier || 0;
    badge.textContent = tier === 0 ? 'Unverified' : `Tier ${tier} \u2022 ${userKyc.limits?.[tier]?.label || 'Verified'}`;
    badge.style.background = tier === 0 ? 'rgba(239,68,68,0.15)' : 'rgba(16,185,129,0.15)';
    badge.style.color = tier === 0 ? '#ef4444' : '#10b981';
  }

  document.getElementById('kyc-modal').classList.add('active');
}

async function submitKyc() {
  const country = userKyc?.country || currentUser?.country || getUserCountry();
  const btn = document.getElementById('kyc-submit-btn');
  const errEl = document.getElementById('kyc-error');
  errEl.textContent = '';
  btn.disabled = true;
  btn.textContent = 'Verifying...';

  const body = {
    country,
    full_name: document.getElementById('kyc-fullname')?.value?.trim() || null,
    phone_number: document.getElementById('kyc-phone')?.value?.trim() || null,
    bvn: document.getElementById('kyc-bvn')?.value?.trim() || null,
    nin: document.getElementById('kyc-nin')?.value?.trim() || null,
    ghana_card_number: document.getElementById('kyc-ghana-card')?.value?.trim() || null,
    national_id: document.getElementById('kyc-national-id')?.value?.trim() || null,
    date_of_birth: document.getElementById('kyc-dob')?.value || null,
  };

  // Validate minimum fields per country
  if (country === 'NG' && !body.bvn) { errEl.textContent = 'BVN is required for Nigerian accounts'; btn.disabled = false; btn.textContent = 'Verify & Continue'; return; }
  if (country === 'GH' && !body.ghana_card_number) { errEl.textContent = 'Ghana Card number is required'; btn.disabled = false; btn.textContent = 'Verify & Continue'; return; }
  if ((country === 'KE' || country === 'UG') && !body.national_id) { errEl.textContent = 'National ID is required'; btn.disabled = false; btn.textContent = 'Verify & Continue'; return; }
  if (!body.phone_number) { errEl.textContent = 'Phone number is required'; btn.disabled = false; btn.textContent = 'Verify & Continue'; return; }

  try {
    const res = await authFetch(API_BASE + '/api/kyc/submit', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify(body),
    });
    const data = await res.json();
    if (!res.ok) { errEl.textContent = data.error || 'Verification failed'; return; }

    // Update local state
    userKyc.tier = data.tier;
    userKyc.status = data.status;
    updateKycBanner();
    closeModals();

    // Show success toast
    const toast = document.getElementById('settings-toast');
    toast.textContent = `Verified! Tier ${data.tier} \u2022 ${data.limits?.label || 'Active'} — Check your phone/email for confirmation`;
    toast.classList.add('active');
    setTimeout(() => toast.classList.remove('active'), 3000);
  } catch (e) {
    errEl.textContent = 'Connection error. Try again.';
  } finally {
    btn.disabled = false;
    btn.textContent = 'Verify & Continue';
  }
}

// ══════════════════════════════════════════════════════════
// BANK ACCOUNT MANAGEMENT
// ══════════════════════════════════════════════════════════

async function loadBankAccounts() {
  try {
    const res = await authFetch(API_BASE + '/api/bank-accounts');
    if (!res.ok) return;
    const data = await res.json();
    userBankAccounts = data.accounts || [];
    renderBankAccounts();
  } catch (e) {}
}

function renderBankAccounts() {
  const list = document.getElementById('bank-accounts-list');
  const section = document.getElementById('bank-accounts-section');
  if (!list) return;
  // Hide section for countries without bank support
  const country = getUserCountry();
  if (['KE'].includes(country)) { if (section) section.style.display = 'none'; return; }
  if (section) section.style.display = 'block';

  if (userBankAccounts.length === 0) {
    list.innerHTML = '<div style="padding:16px;text-align:center;color:var(--text3);font-size:13px">No bank accounts linked</div>';
    return;
  }
  list.innerHTML = userBankAccounts.map(a => `
    <div style="display:flex;align-items:center;gap:12px;padding:14px 16px;background:var(--surface);border-radius:14px;margin-bottom:8px">
      <div style="width:40px;height:40px;border-radius:10px;background:rgba(79,172,254,0.12);display:flex;align-items:center;justify-content:center;font-size:18px">\ud83c\udfe6</div>
      <div style="flex:1;min-width:0">
        <div style="font-size:14px;font-weight:600;white-space:nowrap;overflow:hidden;text-overflow:ellipsis">${a.bank_name}</div>
        <div style="font-size:12px;color:var(--text3)">\u2022\u2022\u2022\u2022 ${a.account_number.slice(-4)} ${a.is_default ? '\u2022 Default' : ''}</div>
      </div>
      <button onclick="removeBankAccount('${a.id}')" style="background:none;border:none;color:var(--text3);cursor:pointer;padding:4px;font-size:18px">\u00d7</button>
    </div>
  `).join('');
}

async function openBankModal() {
  const country = getUserCountry();
  try {
    const res = await fetch(API_BASE + '/api/banks/' + country);
    const data = await res.json();
    const select = document.getElementById('bank-select');
    select.innerHTML = '<option value="">Select your bank</option>' + (data.banks || []).map(b => `<option value="${b.code}" data-name="${b.name}">${b.name}</option>`).join('');
  } catch (e) {}
  document.getElementById('bank-modal').classList.add('active');
}

function onBankSelect() {
  // Could add account name lookup here in the future
}

async function submitBankAccount() {
  const country = getUserCountry();
  const select = document.getElementById('bank-select');
  const bankCode = select.value;
  const bankName = select.selectedOptions[0]?.dataset?.name || select.selectedOptions[0]?.textContent || '';
  const accountNumber = document.getElementById('bank-account-number').value.trim();
  const errEl = document.getElementById('bank-error');
  errEl.textContent = '';

  if (!bankCode) { errEl.textContent = 'Please select a bank'; return; }
  if (!accountNumber || accountNumber.length < 6) { errEl.textContent = 'Enter a valid account number'; return; }

  const currencies = { NG: 'NGN', GH: 'GHS', KE: 'KES', UG: 'UGX', US: 'USD' };
  try {
    const res = await authFetch(API_BASE + '/api/bank-accounts', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ country, bank_code: bankCode, bank_name: bankName, account_number: accountNumber, currency: currencies[country] || 'USD' }),
    });
    const data = await res.json();
    if (!res.ok) { errEl.textContent = data.error || 'Failed to link account'; return; }
    closeModals();
    loadBankAccounts();
    const toast = document.getElementById('settings-toast');
    toast.textContent = `${bankName} linked successfully`;
    toast.classList.add('active');
    setTimeout(() => toast.classList.remove('active'), 3000);
  } catch (e) { errEl.textContent = 'Connection error'; }
}

async function removeBankAccount(id) {
  if (!confirm('Remove this bank account?')) return;
  try {
    await authFetch(API_BASE + '/api/bank-accounts/' + id, { method: 'DELETE' });
    loadBankAccounts();
  } catch (e) {}
}

// ══════════════════════════════════════════════════════════
// MOBILE MONEY MANAGEMENT
// ══════════════════════════════════════════════════════════

async function loadMobileWallets() {
  try {
    const res = await authFetch(API_BASE + '/api/mobile-wallets');
    if (!res.ok) return;
    const data = await res.json();
    userMobileWallets = data.wallets || [];
    renderMobileWallets();
  } catch (e) {}
}

function renderMobileWallets() {
  const list = document.getElementById('momo-wallets-list');
  const section = document.getElementById('momo-section');
  if (!list) return;
  const country = getUserCountry();
  const momoCountries = ['GH', 'UG', 'KE', 'TZ', 'CM', 'SN', 'ET'];
  if (!isOwner() && !momoCountries.includes(country)) { if (section) section.style.display = 'none'; return; }
  if (section) section.style.display = 'block';

  if (userMobileWallets.length === 0) {
    list.innerHTML = '<div style="padding:16px;text-align:center;color:var(--text3);font-size:13px">No mobile wallets linked</div>';
    return;
  }
  const providerNames = { mtn: 'MTN MoMo', vodafone: 'Vodafone Cash', airteltigo: 'AirtelTigo', mpesa: 'M-Pesa', airtel: 'Airtel Money', orange: 'Orange Money', wave: 'Wave', telebirr: 'Telebirr', vodacom: 'Vodacom M-Pesa', tigo: 'Tigo Pesa' };
  list.innerHTML = userMobileWallets.map(w => `
    <div style="display:flex;align-items:center;gap:12px;padding:14px 16px;background:var(--surface);border-radius:14px;margin-bottom:8px">
      <div style="width:40px;height:40px;border-radius:10px;background:rgba(251,191,36,0.12);display:flex;align-items:center;justify-content:center;font-size:18px">\ud83d\udcf1</div>
      <div style="flex:1;min-width:0">
        <div style="font-size:14px;font-weight:600">${providerNames[w.provider] || w.provider}</div>
        <div style="font-size:12px;color:var(--text3)">${w.phone_number} ${w.is_default ? '\u2022 Default' : ''}</div>
      </div>
      <button onclick="removeMobileWallet('${w.id}')" style="background:none;border:none;color:var(--text3);cursor:pointer;padding:4px;font-size:18px">\u00d7</button>
    </div>
  `).join('');
}

function openMomoModal() {
  const country = getUserCountry();
  const providers = { GH: ['mtn','vodafone','airteltigo'], UG: ['mtn','airtel'], KE: ['mpesa'], TZ: ['mpesa','vodacom','tigo','airtel'], CM: ['mtn','orange'], SN: ['orange','wave'], ET: ['telebirr'] };
  const providerNames = { mtn: 'MTN MoMo', vodafone: 'Vodafone Cash', airteltigo: 'AirtelTigo', mpesa: 'M-Pesa', airtel: 'Airtel Money', vodacom: 'Vodacom M-Pesa', orange: 'Orange Money', wave: 'Wave', telebirr: 'Telebirr', tigo: 'Tigo Pesa' };
  const select = document.getElementById('momo-provider');
  // Owner sees all providers for testing
  const allProviders = ['mtn','vodafone','airteltigo','mpesa','airtel','vodacom','orange','wave','telebirr','tigo'];
  const opts = isOwner() ? allProviders : (providers[country] || []);
  select.innerHTML = '<option value="">Select provider</option>' + opts.map(p => `<option value="${p}">${providerNames[p] || p}</option>`).join('');
  const phonePh = { GH: '+233...', UG: '+256...', KE: '+254...', TZ: '+255...', CM: '+237...', SN: '+221...', ET: '+251...' };
  document.getElementById('momo-phone').placeholder = phonePh[country] || '+...';
  document.getElementById('momo-modal').classList.add('active');
}

async function submitMobileWallet() {
  const country = getUserCountry();
  const provider = document.getElementById('momo-provider').value;
  const phone = document.getElementById('momo-phone').value.trim();
  const errEl = document.getElementById('momo-error');
  errEl.textContent = '';
  if (!provider) { errEl.textContent = 'Select a provider'; return; }
  if (!phone || phone.length < 8) { errEl.textContent = 'Enter a valid phone number'; return; }

  const currencies = { GH: 'GHS', UG: 'UGX', KE: 'KES', TZ: 'TZS', CM: 'XAF', SN: 'XOF', ET: 'ETB', ZA: 'ZAR' };
  try {
    const res = await authFetch(API_BASE + '/api/mobile-wallets', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ country, provider, phone_number: phone, currency: currencies[country] || 'USD' }),
    });
    const data = await res.json();
    if (!res.ok) { errEl.textContent = data.error || 'Failed'; return; }
    closeModals();
    loadMobileWallets();
    const providerNames = { mtn: 'MTN MoMo', vodafone: 'Vodafone Cash', airteltigo: 'AirtelTigo', mpesa: 'M-Pesa', airtel: 'Airtel Money' };
    const toast = document.getElementById('settings-toast');
    toast.textContent = `${providerNames[provider] || provider} linked`;
    toast.classList.add('active');
    setTimeout(() => toast.classList.remove('active'), 3000);
  } catch (e) { errEl.textContent = 'Connection error'; }
}

async function removeMobileWallet(id) {
  if (!confirm('Remove this mobile wallet?')) return;
  try {
    await authFetch(API_BASE + '/api/mobile-wallets/' + id, { method: 'DELETE' });
    loadMobileWallets();
  } catch (e) {}
}

// ══════════════════════════════════════════════════════════
// COUNTRY-AWARE SEND MONEY FLOW
// ══════════════════════════════════════════════════════════

function updateSendModal() {
  const country = getUserCountry();
  const momoCountries = ['GH', 'UG', 'KE', 'TZ', 'CM', 'SN', 'ET'];
  const bankCountries = ['NG', 'GH', 'UG', 'US', 'ZA', 'TZ', 'CM', 'SN', 'ET'];
  const syms = { NG: '\u20a6', GH: 'GH\u20b5', KE: 'KSh', UG: 'USh', US: '$', ZA: 'R', TZ: 'TSh', CM: 'FCFA', SN: 'CFA', ET: 'Br' };
  const sym = countryConfig?.currencySymbol || syms[country] || '$';

  // Update currency label
  const label = document.getElementById('send-currency-label');
  if (label) label.textContent = `Send in ${countryConfig?.currency || 'USD'}`;

  // Show/hide tabs based on country
  const tabs = document.getElementById('send-type-tabs');
  if (tabs) {
    const bankTab = tabs.querySelector('[data-type="bank"]');
    const momoTab = tabs.querySelector('[data-type="mobile_money"]');
    const owner = isOwner();
    if (bankTab) bankTab.style.display = (owner || bankCountries.includes(country)) ? '' : 'none';
    if (momoTab) momoTab.style.display = (owner || momoCountries.includes(country)) ? '' : 'none';

    // Default to best tab for country
    if (country === 'KE') switchSendType('mobile_money');
    else if (bankCountries.includes(country)) switchSendType('bank');
    else switchSendType('wallet');
  }

  // Reset scope to domestic
  switchSendScope('domestic');

  // Update routing field for user's country
  updateRoutingField(country);

  // Populate bank list in send modal
  loadSendBanks(country);
  loadSendMomoProviders(country);
}

async function loadSendBanks(country) {
  try {
    const res = await fetch(API_BASE + '/api/banks/' + country);
    const data = await res.json();
    const select = document.getElementById('send-bank');
    if (select) select.innerHTML = '<option value="">Select bank</option>' + (data.banks || []).map(b => `<option value="${b.code}" data-name="${b.name}">${b.name}</option>`).join('');
  } catch (e) {}
}

function loadSendMomoProviders(country) {
  const providers = { GH: ['mtn','vodafone','airteltigo'], UG: ['mtn','airtel'], KE: ['mpesa'], TZ: ['mpesa'] };
  const providerNames = { mtn: 'MTN MoMo', vodafone: 'Vodafone Cash', airteltigo: 'AirtelTigo', mpesa: 'M-Pesa', airtel: 'Airtel Money' };
  const select = document.getElementById('send-momo-provider');
  const opts = providers[country] || [];
  if (select) select.innerHTML = '<option value="">Select provider</option>' + opts.map(p => `<option value="${p}">${providerNames[p] || p}</option>`).join('');
}

let currentSendScope = 'domestic';

function switchSendScope(scope) {
  currentSendScope = scope;
  // Update scope tab styles
  document.querySelectorAll('#send-scope-tabs .send-scope-tab').forEach(t => {
    if (t.dataset.scope === scope) {
      t.style.background = 'var(--gradient2)';
      t.style.color = 'white';
    } else {
      t.style.background = 'transparent';
      t.style.color = 'var(--text2)';
    }
  });

  const intlCountryWrap = document.getElementById('send-intl-country-wrap');
  const swiftWrap = document.getElementById('send-swift-wrap');
  const routingWrap = document.getElementById('send-routing-wrap');

  if (scope === 'international') {
    if (intlCountryWrap) intlCountryWrap.style.display = '';
    if (swiftWrap) swiftWrap.style.display = '';
    updateIntlFields();
  } else {
    if (intlCountryWrap) intlCountryWrap.style.display = 'none';
    if (swiftWrap) swiftWrap.style.display = 'none';
    // Show routing field based on user's own country
    updateRoutingField(getUserCountry());
  }
}

function updateIntlFields() {
  const destCountry = document.getElementById('send-intl-country')?.value || '';
  updateRoutingField(destCountry || getUserCountry());
}

function updateRoutingField(country) {
  const label = document.getElementById('send-routing-label');
  const input = document.getElementById('send-routing');
  const hint = document.getElementById('send-routing-hint');
  const wrap = document.getElementById('send-routing-wrap');

  const routingConfig = {
    US: { label: 'Routing Number', placeholder: '000000000', hint: '9-digit ABA routing number', maxlength: '9' },
    GB: { label: 'Sort Code', placeholder: '00-00-00', hint: '6-digit sort code', maxlength: '8' },
    AU: { label: 'BSB Number', placeholder: '000-000', hint: '6-digit BSB number', maxlength: '7' },
    IN: { label: 'IFSC Code', placeholder: 'SBIN0001234', hint: '11-character IFSC code', maxlength: '11' },
    CA: { label: 'Transit + Institution', placeholder: '00000-000', hint: '5-digit transit + 3-digit institution', maxlength: '9' },
    DE: { label: 'BLZ (Bankleitzahl)', placeholder: '00000000', hint: '8-digit bank code', maxlength: '8' },
    FR: { label: 'Code Banque', placeholder: '00000', hint: '5-digit bank code', maxlength: '5' },
  };

  const cfg = routingConfig[country];
  if (cfg && wrap) {
    wrap.style.display = '';
    if (label) label.textContent = cfg.label;
    if (input) { input.placeholder = cfg.placeholder; input.maxLength = parseInt(cfg.maxlength); }
    if (hint) hint.textContent = cfg.hint;
  } else if (wrap) {
    // Countries without routing numbers (NG, GH, KE, UG, etc.)
    wrap.style.display = 'none';
  }
}

function switchSendType(type) {
  currentSendType = type;
  document.getElementById('send-bank-fields').style.display = type === 'bank' ? '' : 'none';
  document.getElementById('send-momo-fields').style.display = type === 'mobile_money' ? '' : 'none';
  document.getElementById('send-wallet-fields').style.display = type === 'wallet' ? '' : 'none';

  // Update tab styles
  document.querySelectorAll('#send-type-tabs .send-tab').forEach(t => {
    if (t.dataset.type === type) {
      t.style.background = 'var(--gradient2)';
      t.style.color = 'white';
      t.style.borderColor = 'transparent';
    } else {
      t.style.background = 'transparent';
      t.style.color = 'var(--text2)';
      t.style.borderColor = 'var(--glass-border)';
    }
  });

  // Update fee display
  updateSendFee();
}

function updateSendFee() {
  const amount = parseFloat(document.getElementById('send-amount')?.value) || 0;
  const feeEl = document.getElementById('send-fee-display');
  if (!feeEl || !amount) { if (feeEl) feeEl.textContent = ''; return; }
  const sym = countryConfig?.currencySymbol || '$';
  let feeText = '';
  if (currentSendType === 'bank') feeText = `Fee: ${sym}${(amount * 0.01).toFixed(2)} (1%)`;
  else if (currentSendType === 'mobile_money') feeText = `Fee: ${sym}${(amount * 0.01).toFixed(2)} (1%)`;
  else feeText = amount <= 50 ? 'Free (under $50)' : `Fee: ${sym}${(amount * 0.01).toFixed(2)} (1%)`;
  feeEl.textContent = feeText;
}

// ── WebSocket Connection ──
function connectWebSocket() {
  try {
    const proto = location.protocol === 'https:' ? 'wss:' : 'ws:';
    ws = new WebSocket(`${proto}//${location.host}/ws`);
    ws.onopen = () => console.log('WS connected');
    ws.onmessage = (e) => {
      try {
        const msg = JSON.parse(e.data);
        if (msg.type === 'task:result') {
          handleTaskResult(msg);
        }
      } catch(err) {}
    };
    ws.onclose = () => setTimeout(connectWebSocket, 3000);
  } catch(e) {
    setTimeout(connectWebSocket, 5000);
  }
}

// ── AI Chat ──
function interceptAction(text) {
  const t = text.toLowerCase();
  if ((t.includes('link') || t.includes('add')) && (t.includes('card') || t.includes('payment method'))) {
    return { message: 'Opening the secure card form for you.', action: () => openAddCardModal() };
  }
  if (t === 'balance' || t === 'check my balance' || t === 'how much do i have' || t === 'my balance') {
    const bal = document.getElementById('balance-display')?.textContent || '$0.00';
    return { message: `Your current balance is **${bal}**. View details in your Wallet tab.`, action: null };
  }
  const sendMatch = t.match(/^send\s+\$?([\d.]+)\s+to\s+(.+)/i);
  if (sendMatch) {
    return { message: `Opening send form for $${sendMatch[1]} to ${sendMatch[2]}.`, action: () => {
      const amtEl = document.getElementById('send-amount'); const toEl = document.getElementById('send-to');
      if (amtEl) amtEl.value = sendMatch[1]; if (toEl) toEl.value = sendMatch[2];
      openSendModal();
    }};
  }
  return null;
}

async function sendMessage() {
  const input = document.getElementById('chat-input');
  const text = input.value.trim();
  if (!text) return;

  input.value = '';
  addChatMessage(text, 'user');

  // Intercept deterministic actions — no AI tokens needed
  const intercepted = interceptAction(text);
  if (intercepted) {
    await simulateDelay(400);
    addChatMessage(intercepted.message, 'ai');
    if (intercepted.action) intercepted.action();
    return;
  }

  // Hide suggestions after first message
  document.getElementById('chat-suggestions').style.display = 'none';

  // Show typing indicator
  const typing = addTypingIndicator();

  // Token tracking
  const inputTokens = Math.ceil(text.length / 4);
  tokenStats.used += inputTokens;

  try {
    // Check cache
    const cached = checkResponseCache(text);
    if (cached) {
      tokenStats.cached++;
      tokenStats.saved += 200;
      await simulateDelay(600);
      typing.remove();
      addChatMessage(cached, 'ai');
      updateTokenMatrix();
      return;
    }

    // Send to backend
    const res = await authFetch(API_BASE + '/api/task', {
      method: 'POST',
      body: JSON.stringify({
        type: detectTaskType(text),
        priority: 'normal',
        title: text.slice(0, 100),
        description: text,
        payload: { userMessage: text, source: 'chat' }
      })
    });

    typing.remove();

    if (res.ok) {
      const data = await res.json();
      const output = data.result?.output || data.result?.message || 'Task completed successfully.';
      const responseTokens = Math.ceil(output.length / 4);
      tokenStats.used += responseTokens;
      addChatMessage(formatAIResponse(output), 'ai');
    } else {
      addChatMessage(getSmartFallback(text), 'ai');
    }
  } catch (e) {
    typing.remove();
    addChatMessage(getSmartFallback(text), 'ai');
  }

  updateTokenMatrix();
}

const PREMIUM_FEATURES = {
  'Create a shopping list': { icon: '\ud83d\uded2', name: 'AI Shopping (Aria)' },
  'Show market insights': { icon: '\ud83d\udcc8', name: 'Market Insights' },
  'Give me financial advice': { icon: '\ud83e\udde0', name: 'AI Advisor (Sage)' },
  'Show my subscriptions': { icon: '\ud83e\udd16', name: 'AI Assistant (Otto)' },
};

function showPremiumPopup(featureName) {
  const info = PREMIUM_FEATURES[featureName] || { icon: '\u2b50', name: 'Premium Feature' };
  document.getElementById('premium-popup-icon').textContent = info.icon;
  document.getElementById('premium-popup-title').textContent = `Unlock ${info.name}`;
  document.getElementById('premium-popup').classList.add('active');
}

function closePremiumPopup() {
  document.getElementById('premium-popup').classList.remove('active');
}

function subscribePremium() {
  closePremiumPopup();
  const toast = document.getElementById('settings-toast');
  toast.textContent = 'Premium subscriptions coming soon!';
  toast.classList.add('active');
  setTimeout(() => toast.classList.remove('active'), 3000);
}

function sendSuggestion(el) {
  const text = el.dataset?.text || el.textContent;
  // Gate premium features for free-tier users
  if (PREMIUM_FEATURES[text] && (!currentUser || !currentUser.subscriptionTier || currentUser.subscriptionTier === 'free') && currentUser?.role !== 'owner') {
    showPremiumPopup(text);
    return;
  }
  document.getElementById('chat-input').value = text;
  sendMessage();
}

function addChatMessage(text, sender) {
  const messages = document.getElementById('chat-messages');
  const div = document.createElement('div');
  div.className = `msg msg-${sender}`;
  div.textContent = text;
  messages.appendChild(div);
  messages.scrollTop = messages.scrollHeight;
  chatHistory.push({ role: sender, content: text });
  return div;
}

function addTypingIndicator() {
  const messages = document.getElementById('chat-messages');
  const div = document.createElement('div');
  div.className = 'msg-typing';
  div.innerHTML = '<div class="typing-dot"></div><div class="typing-dot"></div><div class="typing-dot"></div>';
  messages.appendChild(div);
  messages.scrollTop = messages.scrollHeight;
  return div;
}

function detectTaskType(text) {
  const t = text.toLowerCase();
  // Agentic agents checked FIRST
  // Shopping (Aria)
  if (t.includes('shop') || t.includes('grocery') || t.includes('shopping list') || t.includes('buy ') || t.includes('order') || t.includes('reorder') || t.includes('price compare')) return 'shopping_list_create';
  // Trading (Quant)
  if (t.includes('invest') || t.includes('stock') || t.includes('crypto') || t.includes('portfolio') || t.includes('trade') || t.includes('dca') || t.includes('market')) return 'market_insights';
  // Advisory (Sage)
  if (t.includes('budget') || t.includes('spending') || t.includes('debt') || t.includes('savings advice') || t.includes('tax') || t.includes('net worth') || t.includes('financial health') || t.includes('financial advice') || t.includes('goal')) return 'advisor_budget_create';
  // Assistant (Otto)
  if (t.includes('subscription') || t.includes('negotiate') || t.includes('appointment') || t.includes('document') || t.includes('price alert') || t.includes('return') || t.includes('deal') || t.includes('auto pay')) return 'assistant_subscriptions';
  // Payment infrastructure
  if (t.includes('send') || t.includes('transfer')) return 'wallet_transfer';
  if (t.includes('bill') || t.includes('electric') || t.includes('utility')) return 'bill_pay';
  if (t.includes('balance') || t.includes('how much') || t.includes('history')) return 'tx_history';
  if (t.includes('airtime') || t.includes('data') || t.includes('recharge')) return 'payment_initiate';
  if (t.includes('card') || t.includes('payment method')) return 'payment_method_manage';
  if (t.includes('pay ')) return 'payment_initiate';
  return 'custom';
}

function formatAIResponse(text) {
  return text.replace(/```[\s\S]*?```/g, '').replace(/\*\*/g, '').trim();
}

function getSmartFallback(text) {
  const type = detectTaskType(text);
  const responses = {
    // Agentic agents
    shopping_list_create: "I'll help with shopping. Want me to create a list, compare prices, or track an order?",
    market_insights: "Let me check the markets for you. I'll show today's top performers and market trends. You can also tap the Markets button on your home screen for real-time insights.",
    advisor_budget_create: "I can help with your finances. Want to create a budget, analyze spending, or plan a goal?",
    assistant_subscriptions: "I'll manage that for you. I can list subscriptions, set alerts, or schedule appointments.",
    // Payment infrastructure
    wallet_transfer: "Got it. Who are you sending to and how much?",
    bill_pay: "I'll handle that bill. What's the bill type and amount?",
    tx_history: `Your balance is ${document.getElementById('balance-display')?.textContent || '$0.00'}. Need transaction details?`,
    payment_initiate: "On it. What would you like to pay for?",
    payment_method_manage: "You can manage your cards in the Wallet tab. Need help with something specific?",
    custom: "I can help you shop, invest, budget, manage subscriptions, send money, pay bills, and more. What do you need?"
  };
  return responses[type] || responses.custom;
}

// ── Token Matrix (TokenForge) ──
const responseCache = new Map();

function checkResponseCache(text) {
  const key = text.toLowerCase().trim();
  for (const [k, v] of responseCache) {
    if (key.includes(k) || k.includes(key)) return v;
  }
  return null;
}

function cacheResponse(text, response) {
  const key = text.toLowerCase().trim().slice(0, 50);
  responseCache.set(key, response);
  if (responseCache.size > 50) {
    const first = responseCache.keys().next().value;
    responseCache.delete(first);
  }
}

function updateTokenMatrix() {
  const used = tokenStats.used;
  const saved = tokenStats.saved;
  const cached = tokenStats.cached;
  const total = used + saved;
  const efficiency = total > 0 ? Math.round((saved / total) * 100) : 100;
  const cost = (saved * 0.000015).toFixed(4);

  document.getElementById('tm-used').textContent = used.toLocaleString();
  document.getElementById('tm-cached').textContent = cached.toLocaleString();
  document.getElementById('tm-saved').textContent = saved.toLocaleString();
  document.getElementById('tm-efficiency').textContent = efficiency + '%';
  document.getElementById('tm-cost').textContent = '$' + cost;
}

function simulateDelay(ms) {
  return new Promise(resolve => setTimeout(resolve, ms));
}

// ── Modals ──
function openSendModal() {
  updateSendModal();
  // Add fee listener
  const amtEl = document.getElementById('send-amount');
  if (amtEl) amtEl.oninput = updateSendFee;
  document.getElementById('send-error').textContent = '';
  document.getElementById('send-modal').classList.add('active');
}
function openRequestModal() {
  document.getElementById('request-modal').classList.add('active');
}
// ══════════════════════════════════════════════════════════
// QR CODE — Display + Camera Scanner
// ══════════════════════════════════════════════════════════

let qrScanStream = null;
let qrScanInterval = null;

function showQrModal() {
  document.getElementById('qr-modal').classList.add('active');
  switchQrTab('display');
}

function closeQrModal() {
  stopQrScanner();
  document.getElementById('qr-modal').classList.remove('active');
}

function switchQrTab(tab) {
  const displayBtn = document.getElementById('qr-tab-display');
  const scanBtn = document.getElementById('qr-tab-scan');
  const displayPanel = document.getElementById('qr-display-panel');
  const scanPanel = document.getElementById('qr-scan-panel');
  if (tab === 'display') {
    displayBtn.style.background = 'var(--gradient2)'; displayBtn.style.color = 'white';
    scanBtn.style.background = 'transparent'; scanBtn.style.color = 'var(--text2)';
    displayPanel.style.display = ''; scanPanel.style.display = 'none';
    stopQrScanner();
    generateUserQr();
  } else {
    scanBtn.style.background = 'var(--gradient2)'; scanBtn.style.color = 'white';
    displayBtn.style.background = 'transparent'; displayBtn.style.color = 'var(--text2)';
    displayPanel.style.display = 'none'; scanPanel.style.display = '';
    startQrScanner();
  }
}

function generateUserQr() {
  const canvas = document.getElementById('qr-canvas');
  if (!canvas || !currentUser) return;
  const payLink = window.location.origin + '/pay/' + (currentUser.payTag || currentUser.id);
  document.getElementById('qr-pay-link').textContent = payLink;
  // Generate QR code on canvas
  generateQrCode(canvas, payLink, 200);
}

function copyQrLink() {
  const link = document.getElementById('qr-pay-link').textContent;
  navigator.clipboard.writeText(link).then(() => {
    showToast('Pay link copied!');
  });
}

// Lightweight QR Code generator (numeric mode, ~L error correction)
function generateQrCode(canvas, text, size) {
  const ctx = canvas.getContext('2d');
  ctx.fillStyle = 'white';
  ctx.fillRect(0, 0, size, size);
  // Use the server-side QR SVG endpoint as image source
  const img = new Image();
  img.crossOrigin = 'anonymous';
  img.onload = function() {
    ctx.drawImage(img, 0, 0, size, size);
  };
  img.onerror = function() {
    // Fallback: draw text-based QR placeholder
    ctx.fillStyle = '#7c3aed';
    ctx.fillRect(10, 10, 50, 50); ctx.fillRect(size-60, 10, 50, 50); ctx.fillRect(10, size-60, 50, 50);
    ctx.fillStyle = 'white';
    ctx.fillRect(18, 18, 34, 34); ctx.fillRect(size-52, 18, 34, 34); ctx.fillRect(18, size-52, 34, 34);
    ctx.fillStyle = '#7c3aed';
    ctx.fillRect(26, 26, 18, 18); ctx.fillRect(size-44, 26, 18, 18); ctx.fillRect(26, size-44, 18, 18);
    ctx.font = '10px monospace'; ctx.textAlign = 'center';
    ctx.fillText('PromptPay', size/2, size/2);
    ctx.font = '8px monospace'; ctx.fillStyle = '#666';
    ctx.fillText(text.slice(0, 30), size/2, size/2 + 14);
  };
  img.src = '/qr/' + encodeURIComponent(text);
}

// Camera QR Scanner
async function startQrScanner() {
  const video = document.getElementById('qr-video');
  const errEl = document.getElementById('qr-scan-error');
  const resultEl = document.getElementById('qr-scan-result');
  errEl.style.display = 'none'; resultEl.style.display = 'none';
  try {
    qrScanStream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: 'environment' } });
    video.srcObject = qrScanStream;
    // Use BarcodeDetector API if available, else fallback
    if ('BarcodeDetector' in window) {
      const detector = new BarcodeDetector({ formats: ['qr_code'] });
      qrScanInterval = setInterval(async () => {
        try {
          const codes = await detector.detect(video);
          if (codes.length > 0) {
            handleQrResult(codes[0].rawValue);
          }
        } catch(e) {}
      }, 300);
    } else {
      errEl.textContent = 'QR scanning requires a modern browser (Chrome 83+, Edge 83+). You can also paste a pay link in the Send screen.';
      errEl.style.display = 'block';
    }
  } catch(e) {
    errEl.textContent = 'Camera access denied. Please allow camera permission to scan QR codes.';
    errEl.style.display = 'block';
  }
}

function stopQrScanner() {
  if (qrScanInterval) { clearInterval(qrScanInterval); qrScanInterval = null; }
  if (qrScanStream) { qrScanStream.getTracks().forEach(t => t.stop()); qrScanStream = null; }
}

function handleQrResult(data) {
  stopQrScanner();
  const resultEl = document.getElementById('qr-scan-result');
  resultEl.style.display = 'block';
  // Check if it's a PromptPay pay link
  if (data.includes('/pay/') || data.includes('upromptpay.com')) {
    resultEl.innerHTML = '<b>PromptPay link detected!</b><br>' + data;
    setTimeout(() => {
      closeQrModal();
      // Extract pay tag/id and open send modal
      const parts = data.split('/pay/');
      if (parts[1]) {
        openSendModal();
        const recipEl = document.getElementById('send-recipient');
        if (recipEl) recipEl.value = parts[1];
      } else {
        window.open(data, '_self');
      }
    }, 1000);
  } else {
    resultEl.innerHTML = '<b>QR Scanned:</b><br>' + data;
  }
}
// ══════════════════════════════════════════════════════════
// MARKET INSIGHTS
// ══════════════════════════════════════════════════════════

const MARKET_STOCKS = {
  day: [
    { symbol: 'NVDA', name: 'NVIDIA', price: 142.50, change: 5.8 },
    { symbol: 'AAPL', name: 'Apple', price: 238.20, change: 2.1 },
    { symbol: 'MSFT', name: 'Microsoft', price: 452.30, change: 1.9 },
    { symbol: 'TSLA', name: 'Tesla', price: 345.80, change: 4.2 },
    { symbol: 'AMZN', name: 'Amazon', price: 225.40, change: 1.5 },
    { symbol: 'META', name: 'Meta', price: 612.90, change: -1.2 },
    { symbol: 'GOOG', name: 'Alphabet', price: 198.60, change: -0.8 },
    { symbol: 'JPM', name: 'JPMorgan', price: 252.10, change: -1.5 },
  ],
  week: [
    { symbol: 'NVDA', name: 'NVIDIA', price: 142.50, change: 12.3 },
    { symbol: 'TSLA', name: 'Tesla', price: 345.80, change: 8.7 },
    { symbol: 'PLTR', name: 'Palantir', price: 98.40, change: 7.2 },
    { symbol: 'AMD', name: 'AMD', price: 168.30, change: 6.1 },
    { symbol: 'COIN', name: 'Coinbase', price: 285.70, change: 5.5 },
    { symbol: 'INTC', name: 'Intel', price: 24.30, change: -4.8 },
    { symbol: 'BA', name: 'Boeing', price: 178.50, change: -3.9 },
    { symbol: 'NKE', name: 'Nike', price: 72.40, change: -3.2 },
  ],
  month: [
    { symbol: 'NVDA', name: 'NVIDIA', price: 142.50, change: 28.5 },
    { symbol: 'SMCI', name: 'Super Micro', price: 45.80, change: 22.1 },
    { symbol: 'PLTR', name: 'Palantir', price: 98.40, change: 18.6 },
    { symbol: 'TSLA', name: 'Tesla', price: 345.80, change: 15.3 },
    { symbol: 'META', name: 'Meta', price: 612.90, change: 11.2 },
    { symbol: 'PFE', name: 'Pfizer', price: 26.80, change: -8.5 },
    { symbol: 'DIS', name: 'Disney', price: 108.30, change: -6.2 },
    { symbol: 'BABA', name: 'Alibaba', price: 85.60, change: -5.7 },
  ],
  year: [
    { symbol: 'NVDA', name: 'NVIDIA', price: 142.50, change: 185.4 },
    { symbol: 'PLTR', name: 'Palantir', price: 98.40, change: 340.2 },
    { symbol: 'META', name: 'Meta', price: 612.90, change: 72.8 },
    { symbol: 'AMZN', name: 'Amazon', price: 225.40, change: 48.6 },
    { symbol: 'AAPL', name: 'Apple', price: 238.20, change: 32.5 },
    { symbol: 'INTC', name: 'Intel', price: 24.30, change: -52.1 },
    { symbol: 'MRNA', name: 'Moderna', price: 38.50, change: -43.8 },
    { symbol: 'NKE', name: 'Nike', price: 72.40, change: -28.5 },
  ]
};

const MARKET_INDICES = {
  day: { sp500: '5,998.42', sp500Change: '+0.82%', nasdaq: '19,432.18', nasdaqChange: '+1.12%', dow: '43,215.67', dowChange: '+0.45%' },
  week: { sp500: '5,998.42', sp500Change: '+2.14%', nasdaq: '19,432.18', nasdaqChange: '+3.28%', dow: '43,215.67', dowChange: '+1.56%' },
  month: { sp500: '5,998.42', sp500Change: '+4.85%', nasdaq: '19,432.18', nasdaqChange: '+6.72%', dow: '43,215.67', dowChange: '+3.41%' },
  year: { sp500: '5,998.42', sp500Change: '+24.31%', nasdaq: '19,432.18', nasdaqChange: '+32.85%', dow: '43,215.67', dowChange: '+18.67%' }
};

const MARKET_INSIGHTS = {
  day: "Markets are trending higher today led by AI and semiconductor stocks. NVIDIA continues its momentum after reporting strong data center revenue. The Fed minutes released this afternoon showed no immediate rate changes planned, supporting equities.",
  week: "A strong week for tech as AI spending forecasts were revised upward. Tesla gained on news of FSD expansion to new markets. Intel remains under pressure amid market share losses.",
  month: "The AI trade continues to dominate with NVIDIA leading the charge. Super Micro Computer surged on data center demand. Defensive sectors underperformed as risk appetite remains strong.",
  year: "2024-2025 has been the year of AI infrastructure spending. Palantir led with 340% gains driven by government and enterprise AI contracts. NVIDIA's data center dominance propelled a 185% rise. Legacy tech like Intel struggled with -52% as the market shifted."
};

function openMarketsModal() {
  document.getElementById('markets-modal').classList.add('active');
  loadMarketData('day');
}

function loadMarketData(period) {
  // Update tab styles
  document.querySelectorAll('.mkt-period-tab').forEach(t => {
    if (t.dataset.period === period) { t.style.background = 'var(--gradient2)'; t.style.color = 'white'; }
    else { t.style.background = 'var(--surface)'; t.style.color = 'var(--text2)'; }
  });

  const idx = MARKET_INDICES[period];
  document.getElementById('mkt-sp500').textContent = idx.sp500;
  document.getElementById('mkt-sp500-change').textContent = idx.sp500Change;
  document.getElementById('mkt-sp500-change').style.color = idx.sp500Change.startsWith('+') ? 'var(--emerald)' : 'var(--red)';
  document.getElementById('mkt-nasdaq').textContent = idx.nasdaq;
  document.getElementById('mkt-nasdaq-change').textContent = idx.nasdaqChange;
  document.getElementById('mkt-nasdaq-change').style.color = idx.nasdaqChange.startsWith('+') ? 'var(--emerald)' : 'var(--red)';
  document.getElementById('mkt-dow').textContent = idx.dow;
  document.getElementById('mkt-dow-change').textContent = idx.dowChange;
  document.getElementById('mkt-dow-change').style.color = idx.dowChange.startsWith('+') ? 'var(--emerald)' : 'var(--red)';

  const stocks = MARKET_STOCKS[period];
  const gainers = stocks.filter(s => s.change > 0).sort((a,b) => b.change - a.change);
  const losers = stocks.filter(s => s.change < 0).sort((a,b) => a.change - b.change);

  const renderStock = (s) => `
    <div style="display:flex;align-items:center;gap:12px;padding:12px 14px;background:var(--surface);border-radius:12px;border:1px solid var(--glass-border)">
      <div style="width:40px;height:40px;border-radius:10px;background:${s.change >= 0 ? 'rgba(16,185,129,0.12)' : 'rgba(239,68,68,0.12)'};display:flex;align-items:center;justify-content:center;font-size:11px;font-weight:700;color:${s.change >= 0 ? 'var(--emerald)' : 'var(--red)'}">${s.symbol.slice(0,4)}</div>
      <div style="flex:1;min-width:0">
        <div style="font-size:14px;font-weight:600">${s.symbol}</div>
        <div style="font-size:11px;color:var(--text3)">${s.name}</div>
      </div>
      <div style="text-align:right">
        <div style="font-size:14px;font-weight:600">$${s.price.toFixed(2)}</div>
        <div style="font-size:12px;font-weight:600;color:${s.change >= 0 ? 'var(--emerald)' : 'var(--red)'}">${s.change > 0 ? '+' : ''}${s.change}%</div>
      </div>
    </div>`;

  document.getElementById('mkt-gainers').innerHTML = gainers.length ? gainers.map(renderStock).join('') : '<div style="padding:12px;color:var(--text3);font-size:13px;text-align:center">No gainers in this period</div>';
  document.getElementById('mkt-losers').innerHTML = losers.length ? losers.map(renderStock).join('') : '<div style="padding:12px;color:var(--text3);font-size:13px;text-align:center">No losers in this period</div>';
  document.getElementById('mkt-insight').textContent = MARKET_INSIGHTS[period];
}

function showNotifications() {
  navigateTo('activity');
}
function closeModals() {
  document.querySelectorAll('.modal-overlay').forEach(m => m.classList.remove('active'));
}

// Close modal on overlay click
document.querySelectorAll('.modal-overlay').forEach(m => {
  m.addEventListener('click', (e) => {
    if (e.target === m) closeModals();
  });
});

function openPayByPhone() {
  document.getElementById('pay-modal').classList.add('active');
}

// ══════════════════════════════════════════════════════════
// STRIPE ELEMENTS (Card Linking)
// ══════════════════════════════════════════════════════════

let stripeInstance = null;
let cardElement = null;
let stripePublishableKey = null;

async function initStripeElements() {
  if (stripeInstance) return;
  try {
    const res = await authFetch(API_BASE + '/api/config/stripe-key');
    if (!res.ok) return;
    const { publishableKey } = await res.json();
    if (!publishableKey) return;
    stripePublishableKey = publishableKey;
    stripeInstance = Stripe(publishableKey);
    const elements = stripeInstance.elements({
      appearance: {
        theme: 'night',
        variables: {
          colorPrimary: '#7c3aed',
          colorBackground: '#0c0c14',
          colorText: '#f0f2f5',
          colorTextSecondary: '#8b92a5',
          borderRadius: '12px',
          fontFamily: 'Inter, sans-serif',
        },
      },
    });
    cardElement = elements.create('card', {
      style: { base: { fontSize: '16px', color: '#f0f2f5', '::placeholder': { color: '#4a5068' } } },
    });
  } catch (err) {
    console.error('Stripe init failed:', err);
  }
}

function openAddCardModal() {
  document.getElementById('add-card-modal').classList.add('active');
  initStripeElements().then(() => {
    if (cardElement) {
      cardElement.mount('#stripe-card-element');
      cardElement.on('change', (event) => {
        const errDiv = document.getElementById('card-errors');
        if (event.error) { errDiv.textContent = event.error.message; errDiv.style.display = 'block'; }
        else { errDiv.style.display = 'none'; }
      });
    }
  });
}

async function submitCardForm() {
  if (!stripeInstance || !cardElement) { showToast('Card form not ready'); return; }
  const btn = document.getElementById('add-card-submit');
  btn.disabled = true; btn.textContent = 'Adding...';
  try {
    const { paymentMethod, error } = await stripeInstance.createPaymentMethod({ type: 'card', card: cardElement });
    if (error) {
      document.getElementById('card-errors').textContent = error.message;
      document.getElementById('card-errors').style.display = 'block';
      btn.disabled = false; btn.textContent = 'Add Card';
      return;
    }
    const res = await authFetch(API_BASE + '/api/user/payment-methods', {
      method: 'POST', body: JSON.stringify({ paymentMethodId: paymentMethod.id }),
    });
    if (res.ok) {
      const data = await res.json();
      showToast(`${data.paymentMethod.brand} ...${data.paymentMethod.last4} added!`);
      closeModals(); cardElement.clear(); loadPaymentMethods();
    } else {
      const errData = await res.json();
      showToast(errData.error || 'Failed to add card');
    }
  } catch (err) { showToast('Failed to add card'); }
  btn.disabled = false; btn.textContent = 'Add Card';
}

async function renderRewardCard(container) {
  try {
    const res = await authFetch(API_BASE + '/api/rewards/balance');
    if (!res.ok) return;
    const data = await res.json();
    const card = document.createElement('div');
    card.className = 'wallet-reward-card';
    const statusText = data.balance > 0 ? 'Active' : 'No rewards yet';
    card.innerHTML = `
      <div class="reward-glint"></div>
      <div class="reward-star">&#9733;</div>
      <div class="reward-type">Referral Rewards</div>
      <div class="reward-title">Reward Card</div>
      <div class="reward-balance-label">Available Balance</div>
      <div class="reward-balance-value">$${data.balance.toFixed(2)}</div>
      <div class="reward-footer">
        <div>
          <div class="reward-stat-label">Lifetime Earned</div>
          <div class="reward-stat-value">$${data.lifetimeEarned.toFixed(2)}</div>
        </div>
        <div style="text-align:right">
          <div class="reward-stat-label">Status</div>
          <div class="reward-stat-value">${statusText}</div>
        </div>
      </div>`;
    container.appendChild(card);
  } catch (err) { console.error('Failed to load reward card:', err); }
}

async function loadPaymentMethods() {
  try {
    const container = document.getElementById('payment-cards');
    container.innerHTML = '';

    // Reward card always first
    await renderRewardCard(container);

    // Fetch Stripe payment methods
    const res = await authFetch(API_BASE + '/api/user/payment-methods');
    if (!res.ok) return;
    const { methods } = await res.json();

    const brandClassMap = { visa: 'brand-visa', mastercard: 'brand-mastercard', amex: 'brand-amex', discover: 'brand-discover' };
    const holderName = (currentUser && currentUser.displayName) ? currentUser.displayName.toUpperCase() : 'CARD HOLDER';

    methods.forEach(pm => {
      const brandClass = brandClassMap[pm.brand] || 'brand-default';
      const brandLabel = (pm.brand || 'card').toUpperCase();
      const card = document.createElement('div');
      card.className = 'wallet-holo-card ' + brandClass;
      card.innerHTML = `
        <div class="holo-glint"></div>
        <div class="holo-chip"></div>
        <div class="holo-brand">${brandLabel}</div>
        <button class="holo-remove" onclick="removePaymentMethod('${pm.id}')" title="Remove">&#10005;</button>
        <div class="holo-number">&#8226;&#8226;&#8226;&#8226; &#8226;&#8226;&#8226;&#8226; &#8226;&#8226;&#8226;&#8226; ${pm.last4}</div>
        <div class="holo-footer">
          <div>
            <div class="holo-label">Card Holder</div>
            <div class="holo-value">${holderName}</div>
          </div>
          <div style="text-align:center">
            <div class="holo-label">Expires</div>
            <div class="holo-value">${String(pm.expMonth).padStart(2,'0')}/${String(pm.expYear).slice(-2)}</div>
          </div>
          <div style="text-align:right">
            <div class="holo-branding">PromptPay</div>
          </div>
        </div>`;
      container.appendChild(card);
    });

    // Add Payment Method button
    const addBtn = document.createElement('div');
    addBtn.style.cssText = 'min-width:300px;aspect-ratio:1.586;border-radius:20px;border:1px dashed rgba(255,255,255,0.1);display:flex;align-items:center;justify-content:center;flex-direction:column;gap:8px;cursor:pointer;color:var(--text3);flex-shrink:0;transition:border-color 0.2s;';
    addBtn.onmouseenter = function() { this.style.borderColor = 'rgba(124,58,237,0.3)'; };
    addBtn.onmouseleave = function() { this.style.borderColor = 'rgba(255,255,255,0.1)'; };
    addBtn.onclick = openAddCardModal;
    addBtn.innerHTML = '<svg width="28" height="28" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5"><line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/></svg><span style="font-size:13px">Add Payment Method</span>';
    container.appendChild(addBtn);
  } catch (err) { console.error('Failed to load payment methods:', err); }
}

async function removePaymentMethod(pmId) {
  if (!confirm('Remove this card?')) return;
  try {
    const res = await authFetch(API_BASE + '/api/user/payment-methods/' + pmId, { method: 'DELETE' });
    if (res.ok) { showToast('Card removed'); loadPaymentMethods(); }
    else { showToast('Failed to remove card'); }
  } catch (err) { showToast('Failed to remove card'); }
}

async function executePayByPhone() {
  const amount = parseFloat(document.getElementById('pay-amount').value);
  const label = document.getElementById('pay-label').value.trim() || 'PromptPay Payment';
  if (!amount || amount <= 0) { showToast('Enter an amount'); return; }
  closeModals();
  const result = await payByPhone(amount, label);
  if (result) {
    // Route through AI chat for confirmation
    navigateTo('ai');
    document.getElementById('chat-input').value = `Payment of $${amount.toFixed(2)} for "${label}" completed via phone`;
    sendMessage();
  }
}

async function executeSend() {
  const amount = parseFloat(document.getElementById('send-amount')?.value);
  const note = document.getElementById('send-note')?.value?.trim() || '';
  const errEl = document.getElementById('send-error');
  const btn = document.getElementById('send-submit-btn');
  if (errEl) errEl.textContent = '';
  if (!amount || amount <= 0) { if (errEl) errEl.textContent = 'Enter a valid amount'; return; }

  // Check KYC
  if (!userKyc || userKyc.tier < 1) {
    closeModals();
    openKycModal();
    return;
  }

  const country = getUserCountry();
  const currencies = { NG: 'NGN', GH: 'GHS', KE: 'KES', UG: 'UGX', US: 'USD' };
  const currency = currencies[country] || 'USD';

  btn.disabled = true;
  btn.textContent = 'Processing...';

  try {
    if (currentSendType === 'bank') {
      const bankSelect = document.getElementById('send-bank');
      const bankCode = bankSelect?.value;
      const bankName = bankSelect?.selectedOptions[0]?.dataset?.name || bankSelect?.selectedOptions[0]?.textContent || '';
      const accountNumber = document.getElementById('send-account')?.value?.trim();
      const routingNumber = document.getElementById('send-routing')?.value?.trim() || '';
      const swiftCode = document.getElementById('send-swift')?.value?.trim() || '';
      if (!bankCode || !accountNumber) { if (errEl) errEl.textContent = 'Select bank and enter account number'; return; }

      const transferBody = { bank_code: bankCode, account_number: accountNumber, account_name: bankName, amount, currency, narration: note, country };
      if (routingNumber) transferBody.routing_number = routingNumber;
      if (swiftCode) transferBody.swift_code = swiftCode;
      if (currentSendScope === 'international') transferBody.transfer_scope = 'international';

      const res = await authFetch(API_BASE + '/api/transfers/bank', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(transferBody),
      });
      const data = await res.json();
      if (!res.ok) {
        if (data.requiresKyc) { closeModals(); openKycModal(); return; }
        if (errEl) errEl.textContent = data.error || 'Transfer failed';
        return;
      }
      closeModals();
      showTransferSuccess(data.transfer, bankName, accountNumber);

    } else if (currentSendType === 'mobile_money') {
      const provider = document.getElementById('send-momo-provider')?.value;
      const phone = document.getElementById('send-momo-phone')?.value?.trim();
      if (!provider || !phone) { if (errEl) errEl.textContent = 'Select provider and enter phone number'; return; }

      const res = await authFetch(API_BASE + '/api/transfers/mobile-money', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ provider, phone_number: phone, amount, currency, narration: note, country }),
      });
      const data = await res.json();
      if (!res.ok) {
        if (data.requiresKyc) { closeModals(); openKycModal(); return; }
        if (errEl) errEl.textContent = data.error || 'Transfer failed';
        return;
      }
      closeModals();
      showTransferSuccess(data.transfer, provider, phone);

    } else {
      // Wallet / PromptPay transfer - route through AI
      const to = document.getElementById('send-to')?.value?.trim();
      if (!to) { if (errEl) errEl.textContent = 'Enter recipient'; return; }
      closeModals();
      navigateTo('ai');
      document.getElementById('chat-input').value = `Send ${countryConfig?.currencySymbol || '$'}${amount} to ${to}${note ? ' for ' + note : ''}`;
      sendMessage();
      return;
    }
  } catch (e) {
    if (errEl) errEl.textContent = 'Connection error. Try again.';
  } finally {
    btn.disabled = false;
    btn.textContent = 'Send Payment';
  }
  loadTransferHistory();
}

function showTransferSuccess(transfer, recipientLabel, recipientDetail) {
  const sym = countryConfig?.currencySymbol || '$';
  navigateTo('ai');
  const statusText = transfer.status === 'completed' ? 'sent' : 'initiated (pending confirmation)';
  addChatMessage('ai', `Transfer ${statusText}!\n\n${sym}${transfer.amount.toLocaleString()} to ${recipientLabel} (${recipientDetail})\nFee: ${sym}${transfer.fee?.toFixed(2) || '0.00'}\nRef: ${transfer.id.slice(0, 8).toUpperCase()}`);
}

function handleTaskResult(msg) {
  if (msg.result?.output) {
    cacheResponse(msg.taskId, msg.result.output);
  }
}

// ── Transfer History ──
let transferHistory = [];

async function loadTransferHistory() {
  try {
    const res = await authFetch(API_BASE + '/api/transfers?limit=30');
    if (!res.ok) return;
    const data = await res.json();
    transferHistory = data.transfers || [];
    populateActivity();
    populateRecentActivity();
  } catch (e) {}
}

function populateActivity() {
  const list = document.getElementById('activity-tx-list');
  if (!list) return;
  if (transferHistory.length === 0) {
    list.innerHTML = `
      <div style="padding:40px 0;text-align:center;color:var(--text3)">
        <svg width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1" style="margin-bottom:12px;opacity:0.3"><polyline points="22 12 18 12 15 21 9 3 6 12 2 12"/></svg>
        <div style="font-size:14px;margin-bottom:4px">No transactions yet</div>
        <div style="font-size:12px">Send money or top up to get started</div>
      </div>`;
    return;
  }
  list.innerHTML = transferHistory.map(tx => {
    const statusColors = { completed: '#10b981', pending: '#fbbf24', failed: '#ef4444' };
    const typeIcons = { bank: '\ud83c\udfe6', mobile_money: '\ud83d\udcf1', wallet: '\ud83d\udcb3' };
    const date = new Date(tx.created_at);
    const timeStr = date.toLocaleDateString('en', { month: 'short', day: 'numeric' }) + ' ' + date.toLocaleTimeString('en', { hour: '2-digit', minute: '2-digit' });
    return `
      <div style="display:flex;align-items:center;gap:12px;padding:14px 0;border-bottom:1px solid rgba(255,255,255,0.04)">
        <div style="width:40px;height:40px;border-radius:12px;background:var(--surface);display:flex;align-items:center;justify-content:center;font-size:18px">${typeIcons[tx.type] || '\ud83d\udcb8'}</div>
        <div style="flex:1;min-width:0">
          <div style="font-size:14px;font-weight:500;white-space:nowrap;overflow:hidden;text-overflow:ellipsis">${tx.recipient_name || tx.recipient_account || 'Transfer'}</div>
          <div style="font-size:12px;color:var(--text3)">${timeStr} \u2022 ${tx.provider}</div>
        </div>
        <div style="text-align:right">
          <div style="font-size:14px;font-weight:600">-${tx.currency} ${parseFloat(tx.amount).toLocaleString()}</div>
          <div style="font-size:11px;color:${statusColors[tx.status] || '#aaa'}">${tx.status}</div>
        </div>
      </div>`;
  }).join('');
}

function populateRecentActivity() {
  const list = document.getElementById('recent-tx-list');
  if (!list) return;
  const recent = transferHistory.slice(0, 3);
  if (recent.length === 0) {
    list.innerHTML = '<div style="padding:20px;text-align:center;color:var(--text3);font-size:13px">No transactions yet. Send money or top up to get started.</div>';
    return;
  }
  list.innerHTML = recent.map(tx => {
    const date = new Date(tx.created_at);
    const timeStr = date.toLocaleDateString('en', { month: 'short', day: 'numeric' });
    return `
      <div style="display:flex;align-items:center;gap:12px;padding:12px 0;border-bottom:1px solid rgba(255,255,255,0.04)">
        <div style="flex:1"><div style="font-size:13px;font-weight:500">${tx.recipient_name || tx.recipient_account || 'Transfer'}</div><div style="font-size:11px;color:var(--text3)">${timeStr}</div></div>
        <div style="font-size:13px;font-weight:600">-${tx.currency} ${parseFloat(tx.amount).toLocaleString()}</div>
      </div>`;
  }).join('');
}

// ── Landing Page Logic ──

// Agent Chat Conversation Sequence
const AGENT_CHAT_SEQUENCE = [
  { type: 'user', text: 'Send $50 to Sarah for dinner', delay: 1800 },
  { type: 'thinking', delay: 1500 },
  { type: 'ai', text: "Done! $50 sent to Sarah. She'll get it instantly.", delay: 3000 },
  { type: 'user', text: "What's my balance?", delay: 2000 },
  { type: 'thinking', delay: 800 },
  { type: 'ai', text: 'Your balance is $2,450.80 — up $125 today.', delay: 3500 },
  { type: 'user', text: 'Pay my electric bill', delay: 2000 },
  { type: 'thinking', delay: 1200 },
  { type: 'ai', text: 'Electric bill of $87.50 paid to Con Edison. Confirmation sent to your email.', delay: 4000 },
];

let agentChatRunning = false;

function updateAgentStatus(status) {
  const glow = document.getElementById('agent-glow');
  const mouthFill = document.getElementById('agent-mouth-fill');
  const statusIcon = document.getElementById('agent-status-icon');
  const title = document.getElementById('agent-chat-title');
  const subtitle = document.getElementById('agent-chat-subtitle');
  const progressFill = document.getElementById('agent-progress-fill');

  if (glow) glow.className = 'agent-glow ' + status;
  if (mouthFill) mouthFill.className = 'agent-mouth-fill ' + status;
  if (statusIcon) {
    statusIcon.className = 'agent-chat-status-icon ' + status;
    const colors = { greeting: '#22d3ee', thinking: '#fbbf24', success: '#34d399' };
    statusIcon.innerHTML = status === 'success'
      ? '<svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="' + colors[status] + '" stroke-width="2"><path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"/><polyline points="22 4 12 14.01 9 11.01"/></svg>'
      : '<svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="' + colors[status] + '" stroke-width="2"><polygon points="12 2 15.09 8.26 22 9.27 17 14.14 18.18 21.02 12 17.77 5.82 21.02 7 14.14 2 9.27 8.91 8.26 12 2"/></svg>';
  }
  if (title) {
    const titles = { greeting: 'Welcome to PromptPay!', thinking: 'Processing...', success: 'Done!' };
    title.textContent = titles[status] || titles.greeting;
  }
  if (subtitle) {
    const subs = { greeting: 'Your AI financial assistant', thinking: 'Executing your command...', success: 'Transaction completed' };
    subtitle.textContent = subs[status] || subs.greeting;
  }
  if (progressFill) {
    progressFill.style.width = status === 'thinking' ? '100%' : '0';
  }
  // Toggle floating icons
  document.querySelectorAll('.agent-icon-bubble').forEach(icon => {
    if (status === 'success') icon.classList.add('hide');
    else icon.classList.remove('hide');
  });
}

function initAgentChat() {
  const container = document.getElementById('agent-messages');
  if (!container || agentChatRunning) return;
  agentChatRunning = true;
  let idx = 0;

  function showNext() {
    if (!document.getElementById('agent-messages')) { agentChatRunning = false; return; }
    if (idx >= AGENT_CHAT_SEQUENCE.length) {
      setTimeout(() => {
        container.innerHTML = '';
        idx = 0;
        updateAgentStatus('greeting');
        showNext();
      }, 3000);
      return;
    }
    const item = AGENT_CHAT_SEQUENCE[idx];
    if (item.type === 'thinking') {
      updateAgentStatus('thinking');
      const dots = document.createElement('div');
      dots.className = 'agent-msg typing-msg';
      dots.innerHTML = '<div class="agent-typing-dot"></div><div class="agent-typing-dot"></div><div class="agent-typing-dot"></div>';
      container.appendChild(dots);
      container.scrollTop = container.scrollHeight;
      setTimeout(() => {
        if (dots.parentNode) dots.parentNode.removeChild(dots);
        idx++;
        showNext();
      }, item.delay);
    } else {
      if (item.type === 'ai') updateAgentStatus('success');
      if (item.type === 'user') updateAgentStatus('greeting');
      const msg = document.createElement('div');
      msg.className = 'agent-msg ' + item.type;
      msg.textContent = item.text;
      container.appendChild(msg);
      container.scrollTop = container.scrollHeight;
      idx++;
      setTimeout(showNext, item.delay);
    }
  }
  setTimeout(showNext, 1500);
}

// Agent Eye Tracking
document.addEventListener('mousemove', (e) => {
  const agent = document.getElementById('agent-wrapper');
  if (!agent) return;
  const rect = agent.getBoundingClientRect();
  const x = ((e.clientX - rect.left) / rect.width - 0.5) * 2;
  const y = ((e.clientY - rect.top) / rect.height - 0.5) * 2;
  const eyes = document.getElementById('agent-eyes');
  if (eyes) eyes.style.transform = 'translate(' + (x * 5) + 'px, ' + (y * 3) + 'px)';
});

// Agent Blinking
setInterval(() => {
  document.querySelectorAll('.agent-eye').forEach(eye => eye.classList.add('blink'));
  setTimeout(() => document.querySelectorAll('.agent-eye').forEach(eye => eye.classList.remove('blink')), 150);
}, 4000);

function startLandingTyping() {
  // Legacy — now handled by initAgentChat
  initAgentChat();
}

// Landing nav scroll effect
window.addEventListener('scroll', () => {
  const nav = document.getElementById('lp-nav');
  if (nav) {
    if (window.scrollY > 50) nav.classList.add('scrolled');
    else nav.classList.remove('scrolled');
  }
});

function showLanding() {
  document.getElementById('landing-page').classList.add('active');
  document.getElementById('auth-gate').classList.add('hidden');
  document.body.className = 'landing-mode';
}

function showAuthGate(tab) {
  document.getElementById('landing-page').classList.remove('active');
  document.getElementById('auth-gate').classList.remove('hidden');
  document.body.className = 'landing-mode';
  if (tab) switchAuthTab(tab);
}

function enterAppMode() {
  document.getElementById('landing-page').classList.remove('active');
  document.getElementById('auth-gate').classList.add('hidden');
  document.body.className = 'app-mode';
}

// ── Init ──
(async function initApp() {
  const hadToken = !!localStorage.getItem('promptpay_had_session');
  if (authToken) {
    localStorage.setItem('promptpay_had_session', '1');
    const valid = await validateToken();
    if (valid) {
      enterAppMode();
      showApp();
    } else {
      showAuthGate('login');
      document.getElementById('login-error').textContent = 'Your session has expired. Please sign in again.';
    }
  } else {
    // No token — show landing page for new visitors, auth gate for returning users
    if (hadToken) {
      localStorage.removeItem('promptpay_had_session');
      showAuthGate('login');
      document.getElementById('login-error').textContent = 'Your session has expired. Please sign in again.';
    } else {
      showLanding();
      startLandingTyping();
    }
  }
})();

// ── Carrier Database per Country ──
const CARRIER_DATA = {
  NG: {
    dialCode: '+234', currency: 'NGN', name: 'Nigeria',
    presets: [100, 200, 500, 1000, 2000, 5000],
    carriers: [
      { id: 'mtn_ng', name: 'MTN Nigeria', prefixes: ['0803','0806','0703','0706','0810','0813','0814','0816','0903','0906','0913','0916'] },
      { id: 'airtel_ng', name: 'Airtel Nigeria', prefixes: ['0802','0808','0708','0812','0701','0902','0907','0901','0912'] },
      { id: 'glo_ng', name: 'Glo (Globacom)', prefixes: ['0805','0807','0705','0815','0811','0905','0915'] },
      { id: '9mobile_ng', name: '9mobile (Etisalat)', prefixes: ['0809','0818','0817','0908','0909'] },
    ]
  },
  GH: {
    dialCode: '+233', currency: 'GHS', name: 'Ghana',
    presets: [1, 2, 5, 10, 20, 50],
    carriers: [
      { id: 'mtn_gh', name: 'MTN Ghana', prefixes: ['024','025','053','054','055','059'] },
      { id: 'vodafone_gh', name: 'Vodafone Ghana (Telecel)', prefixes: ['020','050'] },
      { id: 'airteltigo_gh', name: 'AirtelTigo Ghana', prefixes: ['026','027','056','057'] },
    ]
  },
  UG: {
    dialCode: '+256', currency: 'UGX', name: 'Uganda',
    presets: [500, 1000, 2000, 5000, 10000, 20000],
    carriers: [
      { id: 'mtn_ug', name: 'MTN Uganda', prefixes: ['077','078','076'] },
      { id: 'airtel_ug', name: 'Airtel Uganda', prefixes: ['070','075','074'] },
      { id: 'africell_ug', name: 'Africell Uganda', prefixes: ['079'] },
    ]
  },
  KE: {
    dialCode: '+254', currency: 'KES', name: 'Kenya',
    presets: [20, 50, 100, 200, 500, 1000],
    carriers: [
      { id: 'safaricom_ke', name: 'Safaricom', prefixes: ['070','071','072','079','011','010'] },
      { id: 'airtel_ke', name: 'Airtel Kenya', prefixes: ['073','078','010'] },
      { id: 'telkom_ke', name: 'Telkom Kenya', prefixes: ['077'] },
    ]
  },
  ZA: {
    dialCode: '+27', currency: 'ZAR', name: 'South Africa',
    presets: [5, 10, 29, 49, 99, 199],
    carriers: [
      { id: 'vodacom_za', name: 'Vodacom', prefixes: ['060','061','062','063','064','065','066','071','072','073','082','084'] },
      { id: 'mtn_za', name: 'MTN South Africa', prefixes: ['060','061','062','063','064','065','066','071','073','078','083'] },
      { id: 'cellc_za', name: 'Cell C', prefixes: ['074','084'] },
      { id: 'telkom_za', name: 'Telkom Mobile', prefixes: ['081'] },
    ]
  },
  TZ: {
    dialCode: '+255', currency: 'TZS', name: 'Tanzania',
    presets: [500, 1000, 2000, 5000, 10000, 20000],
    carriers: [
      { id: 'vodacom_tz', name: 'Vodacom Tanzania', prefixes: ['074','075','076'] },
      { id: 'airtel_tz', name: 'Airtel Tanzania', prefixes: ['068','069','078'] },
      { id: 'tigo_tz', name: 'Tigo Tanzania', prefixes: ['065','067','071'] },
      { id: 'halotel_tz', name: 'Halotel', prefixes: ['062'] },
    ]
  },
  CM: {
    dialCode: '+237', currency: 'XAF', name: 'Cameroon',
    presets: [100, 200, 500, 1000, 2000, 5000],
    carriers: [
      { id: 'mtn_cm', name: 'MTN Cameroon', prefixes: ['67','650','651','652','653','654'] },
      { id: 'orange_cm', name: 'Orange Cameroon', prefixes: ['69','655','656','657','658','659'] },
    ]
  },
  SN: {
    dialCode: '+221', currency: 'XOF', name: 'Senegal',
    presets: [200, 500, 1000, 2000, 5000, 10000],
    carriers: [
      { id: 'orange_sn', name: 'Orange Sénégal', prefixes: ['77','78'] },
      { id: 'free_sn', name: 'Free Sénégal', prefixes: ['76'] },
      { id: 'expresso_sn', name: 'Expresso', prefixes: ['70'] },
    ]
  },
  ET: {
    dialCode: '+251', currency: 'ETB', name: 'Ethiopia',
    presets: [5, 10, 25, 50, 100, 200],
    carriers: [
      { id: 'ethio_et', name: 'Ethio Telecom', prefixes: ['091','092','093','094','095','096','097'] },
      { id: 'safaricom_et', name: 'Safaricom Ethiopia', prefixes: ['090'] },
    ]
  }
};

// Countries where airtime purchase should be hidden (US, Europe)
const NON_AIRTIME_COUNTRIES = ['US','CA','GB','DE','FR','IT','ES','NL','AU','JP'];

let airtimeRecipient = 'self'; // 'self' or 'other'

// ── Airtime Modal ──
function openAirtimeModal() {
  // Check if user country supports airtime (owners bypass)
  const userCountry = getUserCountry();
  if (!isOwner() && NON_AIRTIME_COUNTRIES.includes(userCountry)) {
    showToast('Airtime top-up is available for Africa only');
    return;
  }
  document.getElementById('airtime-modal').classList.add('active');
  // Set default country from user profile
  if (userCountry && CARRIER_DATA[userCountry]) {
    document.getElementById('airtime-country').value = userCountry;
  }
  updateCarriers();
  setAirtimeRecipient('self');
}
function closeAirtimeModal() {
  document.getElementById('airtime-modal').classList.remove('active');
}
function setAirtimeRecipient(mode) {
  airtimeRecipient = mode;
  const selfBtn = document.getElementById('airtime-self-btn');
  const otherBtn = document.getElementById('airtime-other-btn');
  const phoneLabel = document.getElementById('airtime-phone-label');
  if (mode === 'self') {
    selfBtn.style.borderColor = 'rgba(124,58,237,0.4)';
    selfBtn.style.background = 'rgba(124,58,237,0.15)';
    selfBtn.style.color = 'white';
    otherBtn.style.borderColor = 'rgba(255,255,255,0.1)';
    otherBtn.style.background = 'rgba(255,255,255,0.03)';
    otherBtn.style.color = 'var(--text2)';
    phoneLabel.textContent = 'Your phone number';
  } else {
    otherBtn.style.borderColor = 'rgba(124,58,237,0.4)';
    otherBtn.style.background = 'rgba(124,58,237,0.15)';
    otherBtn.style.color = 'white';
    selfBtn.style.borderColor = 'rgba(255,255,255,0.1)';
    selfBtn.style.background = 'rgba(255,255,255,0.03)';
    selfBtn.style.color = 'var(--text2)';
    phoneLabel.textContent = "Recipient's phone number";
  }
  document.getElementById('airtime-phone').value = '';
  document.getElementById('airtime-phone').placeholder = mode === 'self' ? 'Your number' : "Recipient's number";
}

function getUserCountry() {
  // Check user profile first, then localStorage
  if (currentUser && currentUser.country) return currentUser.country;
  return localStorage.getItem('promptpay_country') || '';
}

function isOwner() {
  return currentUser && currentUser.role === 'owner';
}

// Auto-detect country via IP on first visit (non-blocking)
async function autoDetectCountry() {
  if (localStorage.getItem('promptpay_country')) return; // already set
  try {
    const res = await fetch('https://ipapi.co/json/', { signal: AbortSignal.timeout(5000) });
    const data = await res.json();
    const supported = ['NG','GH','KE','UG','ZA','TZ','CM','SN','ET','US','CA','GB','DE','FR','IN','AU'];
    if (data.country_code && supported.includes(data.country_code)) {
      localStorage.setItem('promptpay_country', data.country_code);
      // Pre-fill registration country
      const regCountry = document.getElementById('register-country');
      if (regCountry) regCountry.value = data.country_code;
    }
  } catch (e) { /* silent fail — user will pick manually */ }
}

function updateCarriers() {
  const country = document.getElementById('airtime-country').value;
  const data = CARRIER_DATA[country];
  if (!data) return;

  // Update dial code
  document.getElementById('airtime-dial-code').textContent = data.dialCode;

  // Update currency label
  document.getElementById('airtime-currency-label').textContent = data.currency;

  // Update carriers dropdown
  const carrierSelect = document.getElementById('airtime-carrier');
  carrierSelect.innerHTML = '<option value="auto">Auto-detect from number</option>';
  data.carriers.forEach(c => {
    const opt = document.createElement('option');
    opt.value = c.id;
    opt.textContent = c.name;
    carrierSelect.appendChild(opt);
  });

  // Update amount presets
  const presetsDiv = document.getElementById('airtime-presets');
  presetsDiv.innerHTML = data.presets.slice(0, 4).map(v =>
    `<button onclick="setAirtimeAmount(${v})" style="padding:10px;border-radius:10px;border:1px solid rgba(124,58,237,0.3);background:rgba(124,58,237,0.1);color:white;cursor:pointer;font-size:13px;">${data.currency === 'UGX' ? (v >= 1000 ? (v/1000)+'K' : v) : v}</button>`
  ).join('');

  // Update phone placeholder
  const phone = document.getElementById('airtime-phone');
  const prefixHint = data.carriers[0]?.prefixes[0] || '';
  phone.placeholder = prefixHint ? `e.g. ${prefixHint}1234567` : 'Phone number';
}

function setAirtimeAmount(val) {
  document.getElementById('airtime-amount').value = val;
  const country = document.getElementById('airtime-country').value;
  const data = CARRIER_DATA[country];
  const fee = Math.round(val * 0.02 * 100) / 100;
  document.getElementById('airtime-fee-display').textContent = `Fee: ${fee} ${data?.currency || ''} (2%) | Total: ${val + fee} ${data?.currency || ''}`;
}

function autoDetectCarrier(phone, country) {
  const data = CARRIER_DATA[country];
  if (!data) return null;
  // Normalize: remove leading +countrycode or leading 0
  let normalized = phone.replace(/\s|-/g, '');
  if (normalized.startsWith(data.dialCode.replace('+', ''))) {
    normalized = '0' + normalized.slice(data.dialCode.length - 1);
  }
  for (const carrier of data.carriers) {
    for (const prefix of carrier.prefixes) {
      if (normalized.startsWith(prefix)) return carrier;
    }
  }
  return null;
}

async function executeAirtime(type) {
  const country = document.getElementById('airtime-country').value;
  const carrierVal = document.getElementById('airtime-carrier').value;
  const dialCode = CARRIER_DATA[country]?.dialCode?.replace('+', '') || '';
  let phone = document.getElementById('airtime-phone').value.trim().replace(/\s|-/g, '');
  const amount = parseFloat(document.getElementById('airtime-amount').value);
  if (!phone || !amount) { showToast('Enter phone number and amount'); return; }

  // Normalize phone: prepend country code if starts with 0
  if (phone.startsWith('0')) {
    phone = dialCode + phone.slice(1);
  } else if (!phone.startsWith(dialCode)) {
    phone = dialCode + phone;
  }

  // Detect or use selected carrier
  let carrierName = 'Auto-detect';
  if (carrierVal !== 'auto') {
    const data = CARRIER_DATA[country];
    const c = data?.carriers.find(c => c.id === carrierVal);
    if (c) carrierName = c.name;
  } else {
    const detected = autoDetectCarrier(phone, country);
    if (detected) carrierName = detected.name;
  }

  closeAirtimeModal();
  navigateTo('ai');
  const recipientNote = airtimeRecipient === 'other' ? ' (for someone else)' : '';
  const msg = type === 'data'
    ? `Buy data bundle: ${amount} ${CARRIER_DATA[country]?.currency || ''} for ${phone} on ${carrierName} in ${CARRIER_DATA[country]?.name || country}${recipientNote}`
    : `Buy airtime: ${amount} ${CARRIER_DATA[country]?.currency || ''} for ${phone} on ${carrierName} in ${CARRIER_DATA[country]?.name || country}${recipientNote}`;
  document.getElementById('chat-input').value = msg;
  sendMessage();
}

// ── Request Money Modal ──
function closeRequestModal() {
  document.getElementById('request-modal').classList.remove('active');
}
async function executeRequestMoney() {
  const contact = document.getElementById('request-contact').value;
  const amount = parseFloat(document.getElementById('request-amount').value);
  const message = document.getElementById('request-message').value;
  if (!contact || !amount) { showToast('Enter contact and amount'); return; }
  closeRequestModal();
  navigateTo('ai');
  const msg = `Request $${amount} from ${contact}${message ? ': ' + message : ''}`;
  addChatMessage(msg, 'user');
  await sendMessage();
}

// ── PayTag ──
function closePaytagModal() {
  document.getElementById('paytag-modal').classList.remove('active');
}
async function claimPaytag() {
  const tag = document.getElementById('paytag-input').value.trim().toLowerCase();
  if (!tag || tag.length < 3) { showToast('PayTag must be at least 3 characters'); return; }
  if (!/^[a-zA-Z0-9_]+$/.test(tag)) { showToast('Letters, numbers, and underscores only'); return; }
  closePaytagModal();
  navigateTo('ai');
  const msg = `Claim my PayTag: $${tag}`;
  addChatMessage(msg, 'user');
  await sendMessage();
}
function copyPaytag() {
  const tag = document.getElementById('user-paytag').textContent;
  navigator.clipboard.writeText(tag).then(() => showToast('$PayTag copied!'));
}
function sharePaytag() {
  const tag = document.getElementById('user-paytag').textContent || document.getElementById('settings-paytag').textContent;
  const url = `https://upromptpay.com/pay/${tag}`;
  if (navigator.share) {
    navigator.share({ title: 'Pay me on PromptPay', text: `Send me money: ${tag}`, url });
  } else {
    navigator.clipboard.writeText(url).then(() => showToast('Link copied!'));
  }
}
function shareReferral() {
  const url = 'https://upromptpay.com/?ref=invite';
  if (navigator.share) {
    navigator.share({ title: 'Join PromptPay', text: 'Sign up and we both get $5!', url });
  } else {
    navigator.clipboard.writeText(url).then(() => showToast('Referral link copied!'));
  }
}

// ── Country Update ──
function updateUserCountry(country) {
  localStorage.setItem('promptpay_country', country);
  if (currentUser) currentUser.country = country;
  applyAirtimeGeoGate();
  // Save to server
  authFetch(API_BASE + '/api/user/settings', {
    method: 'PUT',
    body: JSON.stringify({ country })
  }).catch(() => {});
  showToast('Country updated' + (NON_AIRTIME_COUNTRIES.includes(country) ? ' - Airtime top-up not available in your region' : ''));
}

// Populate country selectors on settings load
const origLoadSettings = loadSettings;
loadSettings = async function() {
  await origLoadSettings();
  const country = getUserCountry();
  if (country) {
    const profileCountry = document.getElementById('profile-country');
    if (profileCountry) profileCountry.value = country;
    const settingsCountry = document.getElementById('settings-country');
    if (settingsCountry) settingsCountry.value = country;
  }
};

// Initialize airtime carrier on first load
document.addEventListener('DOMContentLoaded', function() {
  updateCarriers();
  autoDetectCountry();
});
</script>

</body>
</html>

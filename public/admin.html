<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>PromptPay Admin</title>
  <style>
    :root {
      --bg: #0a0e17;
      --surface: #111827;
      --surface2: #1a2332;
      --border: #1e293b;
      --text: #e2e8f0;
      --text2: #94a3b8;
      --accent: #6366f1;
      --accent2: #818cf8;
      --green: #22c55e;
      --yellow: #eab308;
      --red: #ef4444;
      --blue: #3b82f6;
      --purple: #a855f7;
      --orange: #f97316;
      --cyan: #06b6d4;
    }
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body {
      font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
      background: var(--bg);
      color: var(--text);
      min-height: 100vh;
    }
    /* ‚îÄ‚îÄ Layout ‚îÄ‚îÄ */
    .sidebar {
      position: fixed; left: 0; top: 0; bottom: 0; width: 240px;
      background: var(--surface); border-right: 1px solid var(--border);
      padding: 20px 0; overflow-y: auto; z-index: 10;
    }
    .main { margin-left: 240px; padding: 24px 32px; }
    /* ‚îÄ‚îÄ Sidebar ‚îÄ‚îÄ */
    .logo {
      padding: 0 20px 24px; border-bottom: 1px solid var(--border);
      margin-bottom: 16px;
    }
    .logo h1 { font-size: 20px; font-weight: 700; }
    .logo h1 span { color: var(--accent); }
    .logo p { font-size: 11px; color: var(--text2); margin-top: 4px; }
    .nav-section { padding: 8px 12px; font-size: 10px; text-transform: uppercase;
      letter-spacing: 1.2px; color: var(--text2); margin-top: 8px; }
    .nav-item {
      display: flex; align-items: center; gap: 10px; padding: 8px 20px;
      cursor: pointer; font-size: 13px; color: var(--text2);
      transition: all 0.15s; border-left: 3px solid transparent;
    }
    .nav-item:hover { background: var(--surface2); color: var(--text); }
    .nav-item.active { color: var(--accent2); border-left-color: var(--accent);
      background: rgba(99, 102, 241, 0.08); }
    .nav-icon { width: 18px; text-align: center; font-size: 14px; }
    /* ‚îÄ‚îÄ Header ‚îÄ‚îÄ */
    .header {
      display: flex; justify-content: space-between; align-items: center;
      margin-bottom: 24px;
    }
    .header h2 { font-size: 24px; font-weight: 600; }
    .status-badge {
      display: inline-flex; align-items: center; gap: 6px;
      padding: 6px 14px; border-radius: 20px; font-size: 12px; font-weight: 500;
    }
    .status-online { background: rgba(34,197,94,0.12); color: var(--green); }
    .status-offline { background: rgba(239,68,68,0.12); color: var(--red); }
    /* ‚îÄ‚îÄ Cards ‚îÄ‚îÄ */
    .grid { display: grid; gap: 16px; margin-bottom: 24px; }
    .grid-4 { grid-template-columns: repeat(4, 1fr); }
    .grid-3 { grid-template-columns: repeat(3, 1fr); }
    .grid-2 { grid-template-columns: repeat(2, 1fr); }
    .card {
      background: var(--surface); border: 1px solid var(--border);
      border-radius: 12px; padding: 20px;
    }
    .card-header {
      display: flex; justify-content: space-between; align-items: center;
      margin-bottom: 12px;
    }
    .card-title { font-size: 12px; text-transform: uppercase; letter-spacing: 0.8px;
      color: var(--text2); }
    .card-icon { font-size: 18px; }
    .card-value { font-size: 28px; font-weight: 700; margin-bottom: 4px; }
    .card-sub { font-size: 12px; color: var(--text2); }
    /* ‚îÄ‚îÄ Stat colors ‚îÄ‚îÄ */
    .val-green { color: var(--green); }
    .val-blue { color: var(--blue); }
    .val-purple { color: var(--purple); }
    .val-orange { color: var(--orange); }
    .val-cyan { color: var(--cyan); }
    .val-yellow { color: var(--yellow); }
    /* ‚îÄ‚îÄ Tables ‚îÄ‚îÄ */
    .table-wrap { overflow-x: auto; }
    table { width: 100%; border-collapse: collapse; font-size: 13px; }
    th { text-align: left; padding: 10px 14px; color: var(--text2); font-weight: 500;
      font-size: 11px; text-transform: uppercase; letter-spacing: 0.5px;
      border-bottom: 1px solid var(--border); }
    td { padding: 10px 14px; border-bottom: 1px solid var(--border); }
    tr:hover td { background: var(--surface2); }
    /* ‚îÄ‚îÄ Badges ‚îÄ‚îÄ */
    .badge {
      display: inline-block; padding: 3px 10px; border-radius: 10px;
      font-size: 11px; font-weight: 600;
    }
    .badge-green { background: rgba(34,197,94,0.12); color: var(--green); }
    .badge-yellow { background: rgba(234,179,8,0.12); color: var(--yellow); }
    .badge-red { background: rgba(239,68,68,0.12); color: var(--red); }
    .badge-blue { background: rgba(59,130,246,0.12); color: var(--blue); }
    .badge-purple { background: rgba(168,85,247,0.12); color: var(--purple); }
    /* ‚îÄ‚îÄ Sections ‚îÄ‚îÄ */
    .section { margin-bottom: 28px; }
    .section-title { font-size: 16px; font-weight: 600; margin-bottom: 14px;
      display: flex; align-items: center; gap: 8px; }
    /* ‚îÄ‚îÄ Page panels ‚îÄ‚îÄ */
    .page { display: none; }
    .page.active { display: block; }
    /* ‚îÄ‚îÄ Progress bars ‚îÄ‚îÄ */
    .progress-bar {
      height: 6px; background: var(--surface2); border-radius: 3px;
      overflow: hidden; margin-top: 8px;
    }
    .progress-fill { height: 100%; border-radius: 3px; transition: width 0.6s ease; }
    /* ‚îÄ‚îÄ Loading ‚îÄ‚îÄ */
    .loading { text-align: center; padding: 40px; color: var(--text2); }
    .spin { animation: spin 1s linear infinite; display: inline-block; }
    @keyframes spin { to { transform: rotate(360deg); } }
    /* ‚îÄ‚îÄ Responsive ‚îÄ‚îÄ */
    @media (max-width: 1200px) { .grid-4 { grid-template-columns: repeat(2, 1fr); } }
    @media (max-width: 768px) {
      .sidebar { display: none; }
      .main { margin-left: 0; padding: 16px; }
      .grid-4, .grid-3, .grid-2 { grid-template-columns: 1fr; }
    }
    /* ‚îÄ‚îÄ WS indicator ‚îÄ‚îÄ */
    .ws-dot {
      width: 8px; height: 8px; border-radius: 50%; display: inline-block;
      margin-right: 6px;
    }
    .ws-connected { background: var(--green); box-shadow: 0 0 6px var(--green); }
    .ws-disconnected { background: var(--red); }
    /* ‚îÄ‚îÄ Agent cards ‚îÄ‚îÄ */
    .agent-card {
      background: var(--surface); border: 1px solid var(--border);
      border-radius: 12px; padding: 18px; position: relative;
    }
    .agent-name { font-size: 16px; font-weight: 600; margin-bottom: 4px; }
    .agent-role { font-size: 11px; color: var(--text2); text-transform: uppercase;
      letter-spacing: 0.5px; }
    .agent-tools { margin-top: 10px; display: flex; flex-wrap: wrap; gap: 4px; }
    .tool-chip {
      padding: 2px 8px; font-size: 10px; border-radius: 6px;
      background: var(--surface2); color: var(--text2); border: 1px solid var(--border);
    }
    /* ‚îÄ‚îÄ Chart placeholder ‚îÄ‚îÄ */
    .chart-area {
      height: 200px; background: var(--surface2); border-radius: 8px;
      display: flex; align-items: center; justify-content: center;
      color: var(--text2); font-size: 13px;
    }
    /* ‚îÄ‚îÄ Auth Gate / Login Screen ‚îÄ‚îÄ */
    .auth-gate {
      position: fixed; inset: 0; z-index: 1000;
      background: var(--bg);
      display: flex; align-items: center; justify-content: center;
    }
    .auth-gate.hidden { display: none; }
    .login-box {
      width: 100%; max-width: 400px; padding: 40px;
      background: var(--surface); border: 1px solid var(--border);
      border-radius: 16px;
    }
    .login-logo {
      text-align: center; margin-bottom: 32px;
    }
    .login-logo h1 { font-size: 28px; font-weight: 700; }
    .login-logo h1 span { color: var(--accent); }
    .login-logo p { font-size: 12px; color: var(--text2); margin-top: 6px; }
    .login-field { margin-bottom: 18px; }
    .login-field label {
      display: block; font-size: 12px; color: var(--text2);
      text-transform: uppercase; letter-spacing: 0.6px;
      margin-bottom: 6px; font-weight: 500;
    }
    .login-field input {
      width: 100%; padding: 10px 14px; font-size: 14px;
      background: var(--surface2); color: var(--text);
      border: 1px solid var(--border); border-radius: 8px;
      outline: none; transition: border-color 0.15s;
      font-family: inherit;
    }
    .login-field input:focus { border-color: var(--accent); }
    .login-btn {
      width: 100%; padding: 12px; font-size: 14px; font-weight: 600;
      background: var(--accent); color: #fff; border: none;
      border-radius: 8px; cursor: pointer; transition: background 0.15s;
      font-family: inherit;
    }
    .login-btn:hover { background: var(--accent2); }
    .login-btn:disabled { opacity: 0.6; cursor: not-allowed; }
    .login-error {
      color: var(--red); font-size: 12px; text-align: center;
      margin-bottom: 14px; min-height: 18px;
    }
    /* ‚îÄ‚îÄ Sidebar Logout ‚îÄ‚îÄ */
    .sidebar-bottom {
      position: absolute; bottom: 0; left: 0; right: 0;
      padding: 12px; border-top: 1px solid var(--border);
      background: var(--surface);
    }
    .sidebar-user {
      font-size: 11px; color: var(--text2); padding: 0 8px;
      margin-bottom: 8px; overflow: hidden; text-overflow: ellipsis;
      white-space: nowrap;
    }
    .sidebar-user strong { color: var(--text); font-size: 12px; display: block; }
    .logout-btn {
      display: flex; align-items: center; gap: 8px;
      width: 100%; padding: 8px 12px; font-size: 12px;
      background: transparent; color: var(--red); border: 1px solid rgba(239,68,68,0.2);
      border-radius: 8px; cursor: pointer; transition: all 0.15s;
      font-family: inherit;
    }
    .logout-btn:hover { background: rgba(239,68,68,0.08); }
    /* ‚îÄ‚îÄ Partner action buttons ‚îÄ‚îÄ */
    .btn-sm {
      padding: 4px 12px; font-size: 11px; font-weight: 600;
      border: none; border-radius: 6px; cursor: pointer;
      transition: opacity 0.15s; font-family: inherit;
    }
    .btn-sm:hover { opacity: 0.85; }
    .btn-approve { background: rgba(34,197,94,0.15); color: var(--green); }
    .btn-suspend { background: rgba(239,68,68,0.15); color: var(--red); }
    /* ‚îÄ‚îÄ Credentials modal ‚îÄ‚îÄ */
    .modal-overlay {
      position: fixed; inset: 0; z-index: 2000;
      background: rgba(0,0,0,0.6); display: flex;
      align-items: center; justify-content: center;
    }
    .modal-overlay.hidden { display: none; }
    .modal-box {
      width: 100%; max-width: 460px; padding: 32px;
      background: var(--surface); border: 1px solid var(--border);
      border-radius: 16px;
    }
    .modal-box h3 { font-size: 18px; font-weight: 600; margin-bottom: 16px; }
    .modal-box .creds-block {
      background: var(--surface2); border: 1px solid var(--border);
      border-radius: 8px; padding: 16px; font-size: 13px;
      font-family: monospace; margin-bottom: 16px; word-break: break-all;
    }
    .modal-box .creds-block div { margin-bottom: 6px; }
    .modal-box .creds-block strong { color: var(--accent2); }
    .modal-close-btn {
      padding: 10px 24px; background: var(--accent); color: #fff;
      border: none; border-radius: 8px; cursor: pointer; font-size: 13px;
      font-weight: 600; font-family: inherit;
    }
    /* ‚îÄ‚îÄ Nav item hidden by role ‚îÄ‚îÄ */
    .nav-item.role-hidden { display: none; }
    /* ‚îÄ‚îÄ POS Period Buttons ‚îÄ‚îÄ */
    .pos-period-btn {
      padding: 8px 16px; border-radius: 8px; border: 1px solid var(--border);
      background: var(--surface); color: var(--text2); font-size: 13px;
      font-weight: 600; cursor: pointer; font-family: inherit; transition: all 0.15s;
    }
    .pos-period-btn.active { background: var(--accent); color: #fff; border-color: var(--accent); }
    /* ‚îÄ‚îÄ Analytics Tab ‚îÄ‚îÄ */
    .an-tabs { display:flex; gap:4px; overflow-x:auto; scrollbar-width:none; margin-bottom:16px; }
    .an-tabs::-webkit-scrollbar { display:none; }
    .an-tab { padding:7px 14px; border-radius:20px; border:1px solid var(--border); background:var(--surface);
      color:var(--text2); font-size:12px; font-weight:600; cursor:pointer; white-space:nowrap; transition:all .2s; }
    .an-tab.active { background:var(--accent); color:#fff; border-color:var(--accent); }
    .kpi-grid { display:grid; grid-template-columns:repeat(4,1fr); gap:12px; margin-bottom:20px; }
    .kpi-card { background:var(--surface); border:1px solid var(--border); border-radius:12px; padding:16px; transition:border-color .2s; }
    .kpi-card:hover { border-color:var(--accent); }
    .kpi-label { font-size:10px; color:var(--text2); text-transform:uppercase; letter-spacing:.5px; margin-bottom:6px; }
    .kpi-value { font-size:22px; font-weight:700; margin-bottom:4px; }
    .kpi-trend { font-size:11px; font-weight:600; }
    .kpi-trend.up { color:var(--green); } .kpi-trend.down { color:var(--red); } .kpi-trend.stable { color:var(--text2); }
    .kpi-sparkline { margin-top:8px; height:24px; } .kpi-sparkline svg { width:100%; height:100%; }
    .an-section { margin-bottom:20px; }
    .an-section-title2 { font-size:14px; font-weight:700; margin-bottom:10px; display:flex; align-items:center; gap:8px; }
    .an-section-title2 .badge { font-size:10px; padding:2px 8px; border-radius:10px; background:var(--accent); color:#fff; }
    .chart-box { background:var(--surface); border:1px solid var(--border); border-radius:12px; padding:14px; min-height:180px; }
    .chart-box canvas { width:100% !important; height:auto !important; }
    .chart-filters { display:flex; flex-wrap:wrap; gap:8px; margin-bottom:10px; }
    .chart-filter { padding:6px 12px; border-radius:8px; border:1px solid var(--border); background:var(--bg);
      color:var(--text2); font-size:12px; cursor:pointer; outline:none; }
    .chart-filter:focus { border-color:var(--accent); }
    .insight-card2 { background:var(--surface); border:1px solid var(--border); border-radius:10px;
      padding:12px 14px; margin-bottom:8px; display:flex; gap:10px; align-items:flex-start; }
    .insight-icon2 { width:32px; height:32px; border-radius:8px; display:flex; align-items:center;
      justify-content:center; font-size:16px; flex-shrink:0; }
    .insight-icon2.warning { background:rgba(245,158,11,.15); }
    .insight-icon2.positive { background:rgba(34,197,94,.15); }
    .insight-icon2.info { background:rgba(124,58,237,.15); }
    .forecast-meta { display:flex; flex-wrap:wrap; gap:10px; margin-top:10px; }
    .forecast-pill { padding:5px 10px; border-radius:8px; background:var(--bg); border:1px solid var(--border);
      font-size:11px; color:var(--text2); }
    .forecast-pill b { color:var(--text); }
    .cf-legend { display:flex; gap:14px; margin-top:8px; font-size:12px; color:var(--text2); }
    .cf-dot { width:10px; height:10px; border-radius:50%; display:inline-block; margin-right:4px; vertical-align:middle; }
    .rank-table2 { width:100%; border-collapse:collapse; font-size:13px; }
    .rank-table2 th { text-align:left; padding:8px 12px; color:var(--text2); font-size:11px;
      text-transform:uppercase; letter-spacing:.5px; border-bottom:1px solid var(--border); }
    .rank-table2 td { padding:8px 12px; border-bottom:1px solid rgba(255,255,255,.03); }
    .rank-table2 tr:hover td { background:rgba(99,102,241,.05); }
    @media (max-width: 900px) { .kpi-grid { grid-template-columns:repeat(2,1fr); } }
  </style>
</head>
<body>

<!-- ‚ïê‚ïê‚ïê AUTH GATE ‚ïê‚ïê‚ïê -->
<div class="auth-gate" id="auth-gate">
  <div class="login-box">
    <div class="login-logo">
      <h1><span>Prompt</span>Pay</h1>
      <p>Admin Operations Console</p>
    </div>
    <div class="login-error" id="login-error"></div>
    <form id="login-form" onsubmit="handleLogin(event)">
      <div class="login-field">
        <label for="login-email">Email</label>
        <input type="email" id="login-email" placeholder="info@upromptpay.com" required autocomplete="email">
      </div>
      <div class="login-field">
        <label for="login-password">Password</label>
        <input type="password" id="login-password" placeholder="Enter password" required autocomplete="current-password">
      </div>
      <button type="submit" class="login-btn" id="login-btn">Sign In</button>
    </form>
  </div>
</div>

<!-- ‚ïê‚ïê‚ïê CREDENTIALS MODAL ‚ïê‚ïê‚ïê -->
<div class="modal-overlay hidden" id="creds-modal">
  <div class="modal-box">
    <h3>Partner Approved</h3>
    <p style="font-size:13px;color:var(--text2);margin-bottom:16px">Admin credentials have been generated for this partner:</p>
    <div class="creds-block" id="creds-content"></div>
    <button class="modal-close-btn" onclick="closeCredsModal()">Close</button>
  </div>
</div>

<!-- ‚ïê‚ïê‚ïê SIDEBAR ‚ïê‚ïê‚ïê -->
<div class="sidebar">
  <div class="logo">
    <h1><span>Prompt</span>Pay</h1>
    <p>Operations Intelligence v1.0</p>
  </div>
  <div class="nav-section">Overview</div>
  <div class="nav-item active" data-page="dashboard">
    <span class="nav-icon">&#9632;</span> Dashboard
  </div>
  <div class="nav-item" data-page="agents">
    <span class="nav-icon">&#9881;</span> Agents
  </div>
  <div class="nav-item" data-page="tasks">
    <span class="nav-icon">&#9776;</span> Tasks
  </div>
  <div class="nav-section">Engagement</div>
  <div class="nav-item" data-page="streaks">
    <span class="nav-icon">&#128293;</span> Streaks
  </div>
  <div class="nav-item" data-page="cashback">
    <span class="nav-icon">&#128176;</span> Cashback
  </div>
  <div class="nav-item" data-page="referrals">
    <span class="nav-icon">&#128279;</span> Referrals
  </div>
  <div class="nav-item" data-page="achievements">
    <span class="nav-icon">&#127942;</span> Achievements
  </div>
  <div class="nav-item" data-page="loyalty">
    <span class="nav-icon">&#11088;</span> Loyalty
  </div>
  <div class="nav-item" data-page="insights">
    <span class="nav-icon">&#128200;</span> Insights
  </div>
  <div class="nav-section" id="nav-section-partners">Partners</div>
  <div class="nav-item" data-page="partners" id="nav-partners">
    <span class="nav-icon">&#129309;</span> Partners
  </div>
  <div class="nav-section">Revenue</div>
  <div class="nav-item" data-page="revenue">
    <span class="nav-icon">&#128176;</span> Revenue
  </div>
  <div class="nav-item" data-page="pos-revenue">
    <span class="nav-icon">&#128722;</span> POS Revenue
  </div>
  <div class="nav-section">POS Agents</div>
  <div class="nav-item" data-page="pos-agents">
    <span class="nav-icon">&#128116;</span> POS Management
  </div>
  <div class="nav-item" data-page="pos-referrals">
    <span class="nav-icon">&#128279;</span> Agent Referrals
  </div>
  <div class="nav-section">Network</div>
  <div class="nav-item" data-page="agents-network">
    <span class="nav-icon">&#127758;</span> Agent Network
  </div>
  <div class="nav-item" data-page="cross-border">
    <span class="nav-icon">&#128260;</span> Cross-Border
  </div>
  <div class="nav-section">HR &amp; Hiring</div>
  <div class="nav-item" data-page="hr-dashboard">
    <span class="nav-icon">&#128188;</span> Hiring Pipeline
  </div>
  <div class="nav-item" data-page="hr-jobs">
    <span class="nav-icon">&#128196;</span> Job Listings
  </div>
  <div class="nav-section">Calendar AI</div>
  <div class="nav-item" data-page="calendar">
    <span class="nav-icon">üìÖ</span> Chrono Dashboard
  </div>
  <div class="nav-item" data-page="calendar-todos">
    <span class="nav-icon">‚úÖ</span> To-Do List
  </div>
  <div class="nav-item" data-page="calendar-events">
    <span class="nav-icon">üóìÔ∏è</span> Events
  </div>
  <div class="nav-section">Strategy</div>
  <div class="nav-item" data-page="strategy-bootstrap">
    <span class="nav-icon">&#127919;</span> Abuja Bootstrap
  </div>
  <div class="nav-section" id="nav-section-executive">Executive AI</div>
  <div class="nav-item" data-page="executive" id="nav-executive">
    <span class="nav-icon">&#129504;</span> AI Board
  </div>
  <div class="nav-section">Intelligence</div>
  <div class="nav-item" data-page="analytics">
    <span class="nav-icon">&#128202;</span> Analytics
  </div>
  <div class="nav-section">System</div>
  <div class="nav-item" data-page="providers">
    <span class="nav-icon">&#9889;</span> Providers
  </div>
  <div class="nav-item" data-page="audit">
    <span class="nav-icon">&#128274;</span> Audit Trail
  </div>
  <div class="nav-item" data-page="health">
    <span class="nav-icon">&#128154;</span> Health
  </div>
  <div class="sidebar-bottom" id="sidebar-bottom" style="display:none">
    <div class="sidebar-user" id="sidebar-user"></div>
    <button class="logout-btn" onclick="handleLogout()">
      <span>&#9211;</span> Sign Out
    </button>
  </div>
</div>

<!-- ‚ïê‚ïê‚ïê MAIN ‚ïê‚ïê‚ïê -->
<div class="main">

  <!-- ‚îÄ‚îÄ DASHBOARD ‚îÄ‚îÄ -->
  <div class="page active" id="page-dashboard">
    <div class="header">
      <h2>Dashboard</h2>
      <div>
        <span class="ws-dot ws-disconnected" id="ws-indicator"></span>
        <span id="ws-status" style="font-size:12px;color:var(--text2)">Connecting...</span>
        &nbsp;&nbsp;
        <span class="status-badge status-online" id="server-status">ONLINE</span>
      </div>
    </div>

    <div class="grid grid-4" id="top-stats">
      <div class="card">
        <div class="card-header"><span class="card-title">Total Tools</span><span class="card-icon">&#9881;</span></div>
        <div class="card-value val-blue" id="stat-tools">--</div>
        <div class="card-sub">Across 5 agents</div>
      </div>
      <div class="card">
        <div class="card-header"><span class="card-title">Uptime</span><span class="card-icon">&#9200;</span></div>
        <div class="card-value val-green" id="stat-uptime">--</div>
        <div class="card-sub">Server runtime</div>
      </div>
      <div class="card">
        <div class="card-header"><span class="card-title">Audit Entries</span><span class="card-icon">&#128274;</span></div>
        <div class="card-value val-purple" id="stat-audit">--</div>
        <div class="card-sub">Hash-chained log</div>
      </div>
      <div class="card">
        <div class="card-header"><span class="card-title">Hook Modules</span><span class="card-icon">&#128293;</span></div>
        <div class="card-value val-orange">9</div>
        <div class="card-sub">Engagement engines</div>
      </div>
    </div>

    <div class="section">
      <div class="section-title">&#9881; Payment Agents</div>
      <div class="grid grid-3" id="agents-grid">
        <!-- Filled by JS -->
      </div>
    </div>

    <div class="grid grid-2">
      <div class="card">
        <div class="section-title">&#128293; Hooks Summary</div>
        <div id="hooks-summary" class="loading"><span class="spin">&#8987;</span> Loading...</div>
      </div>
      <div class="card">
        <div class="section-title">&#9889; Provider Status</div>
        <div id="providers-summary" class="loading"><span class="spin">&#8987;</span> Loading...</div>
      </div>
    </div>
  </div>

  <!-- ‚îÄ‚îÄ AGENTS ‚îÄ‚îÄ -->
  <div class="page" id="page-agents">
    <div class="header"><h2>Payment Agents</h2></div>
    <div class="grid grid-2" id="agents-detail-grid"></div>
  </div>

  <!-- ‚îÄ‚îÄ TASKS ‚îÄ‚îÄ -->
  <div class="page" id="page-tasks">
    <div class="header"><h2>Task Queue</h2></div>
    <div class="card"><div class="table-wrap"><table id="tasks-table">
      <thead><tr><th>ID</th><th>Type</th><th>Priority</th><th>Title</th><th>Agent</th><th>Status</th></tr></thead>
      <tbody id="tasks-body"><tr><td colspan="6" style="color:var(--text2);text-align:center">No tasks yet</td></tr></tbody>
    </table></div></div>
  </div>

  <!-- ‚îÄ‚îÄ STREAKS ‚îÄ‚îÄ -->
  <div class="page" id="page-streaks">
    <div class="header"><h2>&#128293; Streak Engine</h2></div>
    <div class="grid grid-4" id="streaks-stats"></div>
    <div class="card" style="margin-top:16px">
      <div class="section-title">Leaderboard</div>
      <div class="table-wrap"><table>
        <thead><tr><th>User</th><th>Current Streak</th><th>Longest</th><th>Multiplier</th></tr></thead>
        <tbody id="streaks-leaderboard"><tr><td colspan="4" style="color:var(--text2);text-align:center">No active streaks</td></tr></tbody>
      </table></div>
    </div>
  </div>

  <!-- ‚îÄ‚îÄ CASHBACK ‚îÄ‚îÄ -->
  <div class="page" id="page-cashback">
    <div class="header"><h2>&#128176; Cashback Engine</h2></div>
    <div class="grid grid-4" id="cashback-stats"></div>
  </div>

  <!-- ‚îÄ‚îÄ REFERRALS ‚îÄ‚îÄ -->
  <div class="page" id="page-referrals">
    <div class="header"><h2>&#128279; Referral Engine</h2></div>
    <div class="grid grid-4" id="referrals-stats"></div>
  </div>

  <!-- ‚îÄ‚îÄ ACHIEVEMENTS ‚îÄ‚îÄ -->
  <div class="page" id="page-achievements">
    <div class="header"><h2>&#127942; Achievement Engine</h2></div>
    <div class="grid grid-3" id="achievements-stats"></div>
  </div>

  <!-- ‚îÄ‚îÄ LOYALTY ‚îÄ‚îÄ -->
  <div class="page" id="page-loyalty">
    <div class="header"><h2>&#11088; Loyalty Program</h2></div>
    <div class="grid grid-4" id="loyalty-stats"></div>
  </div>

  <!-- ‚îÄ‚îÄ INSIGHTS ‚îÄ‚îÄ -->
  <div class="page" id="page-insights">
    <div class="header"><h2>&#128200; Spending Insights</h2></div>
    <div class="grid grid-3" id="insights-stats"></div>
  </div>

  <!-- ‚îÄ‚îÄ PARTNERS ‚îÄ‚îÄ -->
  <div class="page" id="page-partners">
    <div class="header"><h2>&#129309; Partner Management</h2></div>
    <div class="grid grid-4" id="partners-stats">
      <div class="card">
        <div class="card-header"><span class="card-title">Total Partners</span><span class="card-icon">&#129309;</span></div>
        <div class="card-value val-blue" id="stat-partners-total">--</div>
        <div class="card-sub">All registered partners</div>
      </div>
      <div class="card">
        <div class="card-header"><span class="card-title">Active</span><span class="card-icon">&#10003;</span></div>
        <div class="card-value val-green" id="stat-partners-active">--</div>
        <div class="card-sub">Approved &amp; operating</div>
      </div>
      <div class="card">
        <div class="card-header"><span class="card-title">Pending</span><span class="card-icon">&#9203;</span></div>
        <div class="card-value val-yellow" id="stat-partners-pending">--</div>
        <div class="card-sub">Awaiting approval</div>
      </div>
      <div class="card">
        <div class="card-header"><span class="card-title">Total Users</span><span class="card-icon">&#128101;</span></div>
        <div class="card-value val-purple" id="stat-partners-users">--</div>
        <div class="card-sub">Across all partners</div>
      </div>
    </div>
    <div class="card" style="margin-top:4px">
      <div class="section-title">Partner Applications</div>
      <div class="table-wrap">
        <table>
          <thead>
            <tr><th>Name</th><th>Contact Email</th><th>Status</th><th>Users</th><th>Actions</th></tr>
          </thead>
          <tbody id="partners-body">
            <tr><td colspan="5" style="color:var(--text2);text-align:center">Loading...</td></tr>
          </tbody>
        </table>
      </div>
    </div>
  </div>

  <!-- ‚îÄ‚îÄ PROVIDERS ‚îÄ‚îÄ -->
  <div class="page" id="page-providers">
    <div class="header"><h2>&#9889; Payment Providers</h2></div>
    <div class="grid grid-4" id="providers-grid"></div>
  </div>

  <!-- ‚îÄ‚îÄ AUDIT ‚îÄ‚îÄ -->
  <div class="page" id="page-audit">
    <div class="header">
      <h2>&#128274; Audit Trail</h2>
      <button onclick="verifyChain()" style="padding:8px 16px;background:var(--accent);color:white;border:none;border-radius:8px;cursor:pointer;font-size:13px">Verify Chain</button>
    </div>
    <div id="chain-result" style="margin-bottom:12px"></div>
    <div class="card"><div class="table-wrap"><table>
      <thead><tr><th>#</th><th>Time</th><th>Actor</th><th>Action</th><th>Target</th><th>Hash</th></tr></thead>
      <tbody id="audit-body"><tr><td colspan="6" style="color:var(--text2);text-align:center">Loading...</td></tr></tbody>
    </table></div></div>
  </div>

  <!-- ‚îÄ‚îÄ HEALTH ‚îÄ‚îÄ -->
  <div class="page" id="page-health">
    <div class="header"><h2>&#128154; System Health</h2></div>
    <div class="grid grid-3" id="health-stats"></div>
    <div class="card" style="margin-top:16px">
      <div class="section-title">Circuit Breakers</div>
      <div class="table-wrap"><table>
        <thead><tr><th>Provider</th><th>State</th><th>Failures</th><th>Action</th></tr></thead>
        <tbody id="breakers-body"></tbody>
      </table></div>
    </div>
  </div>

  <!-- ‚îÄ‚îÄ REVENUE ‚îÄ‚îÄ -->
  <div class="page" id="page-revenue">
    <div class="header"><h2>&#128176; Revenue Dashboard</h2></div>
    <div style="display:flex;gap:8px;margin-bottom:16px">
      <button class="btn btn-sm revenue-period active" data-period="today" onclick="loadRevenue('today')">Today</button>
      <button class="btn btn-sm revenue-period" data-period="week" onclick="loadRevenue('week')">This Week</button>
      <button class="btn btn-sm revenue-period" data-period="month" onclick="loadRevenue('month')">This Month</button>
    </div>
    <div class="grid grid-3" id="revenue-stats">
      <div class="stat-card"><div class="stat-value" id="rev-volume">$0</div><div class="stat-label">Transaction Volume</div></div>
      <div class="stat-card"><div class="stat-value" id="rev-fees" style="color:var(--green)">$0</div><div class="stat-label">Net Fee Revenue</div></div>
      <div class="stat-card"><div class="stat-value" id="rev-count">0</div><div class="stat-label">Transactions</div></div>
    </div>
    <div class="grid grid-2" style="margin-top:16px">
      <div class="stat-card"><div class="stat-value" id="rev-gross">$0</div><div class="stat-label">Gross Fees</div></div>
      <div class="stat-card"><div class="stat-value" id="rev-discounts" style="color:var(--yellow)">$0</div><div class="stat-label">Loyalty Discounts Given</div></div>
    </div>
    <div class="card" style="margin-top:16px">
      <div class="section-title">Revenue by Transaction Type</div>
      <div class="table-wrap"><table>
        <thead><tr><th>Type</th><th>Count</th><th>Volume</th><th>Fees</th></tr></thead>
        <tbody id="revenue-by-type"></tbody>
      </table></div>
    </div>
  </div>

  <!-- ‚îÄ‚îÄ AGENT NETWORK ‚îÄ‚îÄ -->
  <div class="page" id="page-agents-network" style="display:none;">
    <div class="header"><h2>Agent Network</h2></div>
    <p style="opacity: 0.6; margin-bottom: 20px;">Cash-in/cash-out agents across Nigeria, Ghana, Uganda, Kenya</p>
    <div class="grid grid-4" id="agent-network-stats">
      <div class="card">
        <div class="card-header"><span class="card-title">Active Agents</span><span class="card-icon">&#127758;</span></div>
        <div class="card-value val-blue" id="agent-count">0</div>
      </div>
      <div class="card">
        <div class="card-header"><span class="card-title">Total Float</span><span class="card-icon">&#128176;</span></div>
        <div class="card-value val-green" id="agent-total-float">$0</div>
      </div>
      <div class="card">
        <div class="card-header"><span class="card-title">Commissions Paid</span><span class="card-icon">&#128178;</span></div>
        <div class="card-value val-purple" id="agent-commissions">$0</div>
      </div>
      <div class="card">
        <div class="card-header"><span class="card-title">Transactions Today</span><span class="card-icon">&#128200;</span></div>
        <div class="card-value val-orange" id="agent-tx-today">0</div>
      </div>
    </div>
    <div class="card" style="margin-top:16px">
      <div class="section-title">Agent Accounts</div>
      <div class="table-wrap"><table>
        <thead><tr><th>Agent</th><th>Location</th><th>Float</th><th>Commission</th><th>Status</th></tr></thead>
        <tbody id="agent-table-body"><tr><td colspan="5" style="color:var(--text2);text-align:center">No agents registered yet</td></tr></tbody>
      </table></div>
    </div>
  </div>

  <!-- ‚îÄ‚îÄ EXECUTIVE AI BOARD ‚îÄ‚îÄ -->
  <div class="page" id="page-executive" style="display:none;">
    <div class="header"><h2>Executive AI Board</h2><span class="status-badge status-online">DeepSeek Powered</span></div>
    <p style="opacity:0.6;margin-bottom:20px">Private AI advisors with real-time platform data. Owner only.</p>

    <!-- Persona Selector -->
    <div class="grid grid-3" id="persona-grid" style="margin-bottom:20px">
      <div class="card persona-card active" data-persona="ceo" onclick="selectPersona('ceo')" style="cursor:pointer;border:2px solid transparent">
        <div style="font-size:24px;margin-bottom:6px">&#128081;</div>
        <div style="font-weight:700;font-size:14px">CEO</div>
        <div style="font-size:11px;color:var(--text2)">Strategy &amp; vision</div>
      </div>
      <div class="card persona-card" data-persona="cfo" onclick="selectPersona('cfo')" style="cursor:pointer;border:2px solid transparent">
        <div style="font-size:24px;margin-bottom:6px">&#128178;</div>
        <div style="font-weight:700;font-size:14px">CFO</div>
        <div style="font-size:11px;color:var(--text2)">Revenue &amp; margins</div>
      </div>
      <div class="card persona-card" data-persona="analyst" onclick="selectPersona('analyst')" style="cursor:pointer;border:2px solid transparent">
        <div style="font-size:24px;margin-bottom:6px">&#128200;</div>
        <div style="font-weight:700;font-size:14px">Analyst</div>
        <div style="font-size:11px;color:var(--text2)">Data &amp; trends</div>
      </div>
      <div class="card persona-card" data-persona="economist" onclick="selectPersona('economist')" style="cursor:pointer;border:2px solid transparent">
        <div style="font-size:24px;margin-bottom:6px">&#127758;</div>
        <div style="font-weight:700;font-size:14px">Economist</div>
        <div style="font-size:11px;color:var(--text2)">Pricing &amp; markets</div>
      </div>
      <div class="card persona-card" data-persona="cto" onclick="selectPersona('cto')" style="cursor:pointer;border:2px solid transparent">
        <div style="font-size:24px;margin-bottom:6px">&#9881;</div>
        <div style="font-weight:700;font-size:14px">CTO</div>
        <div style="font-size:11px;color:var(--text2)">System &amp; scale</div>
      </div>
      <div class="card persona-card" data-persona="growth" onclick="selectPersona('growth')" style="cursor:pointer;border:2px solid transparent">
        <div style="font-size:24px;margin-bottom:6px">&#128640;</div>
        <div style="font-weight:700;font-size:14px">Growth</div>
        <div style="font-size:11px;color:var(--text2)">Users &amp; virality</div>
      </div>
    </div>

    <!-- Suggested Prompts -->
    <div id="exec-suggestions" style="display:flex;gap:8px;flex-wrap:wrap;margin-bottom:16px">
    </div>

    <!-- Chat Area -->
    <div class="card" style="min-height:400px;display:flex;flex-direction:column">
      <div id="exec-chat" style="flex:1;overflow-y:auto;max-height:500px;padding:8px 0">
        <div style="text-align:center;color:var(--text2);padding:40px 0;font-size:14px" id="exec-empty">Select a persona above and ask a question. The AI sees your live platform data.</div>
      </div>
      <div style="display:flex;gap:8px;padding-top:12px;border-top:1px solid var(--border)">
        <input type="text" id="exec-input" placeholder="Ask your executive team..." onkeydown="if(event.key==='Enter')sendExecChat()"
          style="flex:1;padding:12px 16px;background:var(--surface2);border:1px solid var(--border);border-radius:10px;color:var(--text);font-size:14px;font-family:inherit;outline:none">
        <button onclick="sendExecChat()" id="exec-send-btn"
          style="padding:12px 24px;background:var(--accent);color:white;border:none;border-radius:10px;cursor:pointer;font-weight:600;font-size:14px;font-family:inherit">Send</button>
      </div>
    </div>

    <!-- Live Context (Collapsible) -->
    <details style="margin-top:16px">
      <summary style="cursor:pointer;color:var(--accent2);font-size:13px;font-weight:600">View live platform data the AI sees</summary>
      <pre id="exec-context" style="margin-top:8px;padding:16px;background:var(--surface);border:1px solid var(--border);border-radius:10px;font-size:11px;color:var(--text2);overflow-x:auto;max-height:400px;overflow-y:auto">Loading...</pre>
    </details>
  </div>

  <!-- ‚îÄ‚îÄ POS REVENUE ‚îÄ‚îÄ -->
  <div class="page" id="page-pos-revenue" style="display:none;">
    <div class="header"><h2>POS Revenue Dashboard</h2></div>
    <p style="opacity: 0.6; margin-bottom: 20px;">Your money: Stripe wallet fundings in, Reloadly spend out. The difference is profit.</p>

    <!-- Platform Fee Control -->
    <div class="card" style="margin-bottom: 20px; border: 1px solid rgba(124,58,237,0.3);">
      <div class="card-header"><span class="card-title">Platform Fee Control</span><span class="card-icon">&#9881;</span></div>
      <div style="display:flex; align-items:center; gap:12px; margin-top:12px;">
        <input type="number" id="pos-fee-input" min="0" max="25" step="0.5" style="width:80px;padding:10px;background:var(--surface2);border:1px solid var(--border);border-radius:8px;color:var(--text);font-size:16px;font-weight:600;text-align:center">
        <span style="color:var(--text2)">% per transaction</span>
        <button onclick="savePlatformFee()" style="padding:10px 20px;background:var(--accent);border:none;border-radius:8px;color:#fff;font-weight:600;cursor:pointer;font-size:13px">Save</button>
        <span id="pos-fee-status" style="font-size:12px;color:var(--success)"></span>
      </div>
    </div>

    <!-- All-Time Summary -->
    <div class="grid grid-4" id="pos-revenue-alltime">
      <div class="card">
        <div class="card-header"><span class="card-title">Wallet Fundings</span><span class="card-icon">&#128179;</span></div>
        <div class="stat" id="pos-r-fundings">&#8358;0</div>
        <div class="stat-sub" id="pos-r-funding-count">0 deposits</div>
      </div>
      <div class="card">
        <div class="card-header"><span class="card-title">Reloadly Spend</span><span class="card-icon">&#128225;</span></div>
        <div class="stat" id="pos-r-reloadly" style="color:var(--warning)">&#8358;0</div>
        <div class="stat-sub">What you paid to Reloadly</div>
      </div>
      <div class="card">
        <div class="card-header"><span class="card-title">Gross Profit</span><span class="card-icon">&#128176;</span></div>
        <div class="stat" id="pos-r-gross" style="color:var(--success)">&#8358;0</div>
        <div class="stat-sub">Fundings minus Reloadly spend</div>
      </div>
      <div class="card">
        <div class="card-header"><span class="card-title">Platform Fees</span><span class="card-icon">&#127919;</span></div>
        <div class="stat" id="pos-r-fees" style="color:var(--accent2)">&#8358;0</div>
        <div class="stat-sub">Your guaranteed cut</div>
      </div>
    </div>

    <!-- Period Tabs -->
    <div style="display:flex;gap:8px;margin:20px 0 14px">
      <button class="pos-period-btn active" onclick="showPosPeriod('today',this)">Today</button>
      <button class="pos-period-btn" onclick="showPosPeriod('week',this)">This Week</button>
      <button class="pos-period-btn" onclick="showPosPeriod('month',this)">This Month</button>
    </div>
    <div class="grid grid-4" id="pos-period-stats">
      <div class="card">
        <div class="card-header"><span class="card-title">Fundings</span></div>
        <div class="stat" id="pos-p-fundings">&#8358;0</div>
      </div>
      <div class="card">
        <div class="card-header"><span class="card-title">Transactions</span></div>
        <div class="stat" id="pos-p-txns">0</div>
      </div>
      <div class="card">
        <div class="card-header"><span class="card-title">Volume</span></div>
        <div class="stat" id="pos-p-volume">&#8358;0</div>
      </div>
      <div class="card">
        <div class="card-header"><span class="card-title">Profit</span></div>
        <div class="stat" id="pos-p-profit" style="color:var(--success)">&#8358;0</div>
      </div>
    </div>

    <!-- Agents -->
    <div class="card" style="margin-top:20px">
      <div class="card-header"><span class="card-title">Top Agents</span><span id="pos-agent-count" style="font-size:12px;color:var(--text2)"></span></div>
      <table style="width:100%;margin-top:12px;border-collapse:collapse" id="pos-top-agents">
        <thead>
          <tr style="text-align:left;font-size:12px;color:var(--text2);border-bottom:1px solid var(--border)">
            <th style="padding:8px">Agent</th>
            <th style="padding:8px">Sales</th>
            <th style="padding:8px">Volume</th>
            <th style="padding:8px">Fees Generated</th>
          </tr>
        </thead>
        <tbody id="pos-agents-tbody"></tbody>
      </table>
    </div>
  </div>

  <!-- ‚îÄ‚îÄ CROSS-BORDER ‚îÄ‚îÄ -->
  <!-- ‚ïê‚ïê‚ïê POS AGENTS MANAGEMENT ‚ïê‚ïê‚ïê -->
  <div class="page" id="page-pos-agents" style="display:none;">
    <div class="header"><h2>POS Agents Management</h2><span class="badge badge-purple">PromptPay Points</span></div>

    <div class="grid grid-4" id="pos-agents-stats">
      <div class="card"><div class="card-header"><span class="card-title">Total Agents</span><span class="card-icon">&#128101;</span></div><div class="card-value val-blue" id="pa-total">0</div><div class="card-sub">registered</div></div>
      <div class="card"><div class="card-header"><span class="card-title">Active</span><span class="card-icon">&#9989;</span></div><div class="card-value val-green" id="pa-active">0</div><div class="card-sub">operating</div></div>
      <div class="card"><div class="card-header"><span class="card-title">Suspended</span><span class="card-icon">&#128721;</span></div><div class="card-value val-red" id="pa-suspended">0</div><div class="card-sub">frozen</div></div>
      <div class="card"><div class="card-header"><span class="card-title">Limit Requests</span><span class="card-icon">&#128200;</span></div><div class="card-value val-yellow" id="pa-pending-limits">0</div><div class="card-sub">pending review</div></div>
    </div>

    <div class="grid grid-3" style="margin-top:16px">
      <div class="card"><div class="card-header"><span class="card-title">Total Volume</span><span class="card-icon">&#128176;</span></div><div class="card-value val-green" id="pa-volume">&#8358;0</div></div>
      <div class="card"><div class="card-header"><span class="card-title">Total Transactions</span><span class="card-icon">&#128179;</span></div><div class="card-value val-blue" id="pa-txns">0</div></div>
      <div class="card"><div class="card-header"><span class="card-title">Avg Rating</span><span class="card-icon">&#11088;</span></div><div class="card-value val-yellow" id="pa-rating">5.0</div></div>
    </div>

    <!-- Tier Breakdown -->
    <div class="card" style="margin-top:16px">
      <div class="section-title">Tier Breakdown</div>
      <div id="pa-tier-breakdown" style="display:flex;gap:16px;flex-wrap:wrap;margin-top:8px"></div>
    </div>

    <!-- Pending Limit Requests -->
    <div class="card" style="margin-top:16px" id="pa-limit-requests-card">
      <div class="section-title">Pending Limit Requests</div>
      <div class="table-wrap"><table>
        <thead><tr><th>Agent</th><th>Code</th><th>Tier</th><th>Current</th><th>Requested</th><th>Txns</th><th>Rating</th><th>Actions</th></tr></thead>
        <tbody id="pa-limit-tbody"><tr><td colspan="8" style="color:var(--text2);text-align:center">Loading...</td></tr></tbody>
      </table></div>
    </div>

    <!-- Agent Search & Table -->
    <div class="card" style="margin-top:16px">
      <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:12px;flex-wrap:wrap;gap:8px">
        <div class="section-title" style="margin-bottom:0">All Agents</div>
        <div style="display:flex;gap:8px;align-items:center">
          <select id="pa-status-filter" onchange="loadPosAgentsList()" style="padding:6px 12px;border-radius:6px;border:1px solid var(--border);background:var(--surface2);color:var(--text);font-size:12px">
            <option value="">All Status</option>
            <option value="active">Active</option>
            <option value="suspended">Suspended</option>
            <option value="pending">Pending</option>
          </select>
          <input id="pa-search" placeholder="Search name, code, phone..." onkeyup="clearTimeout(window._paSearchTimer);window._paSearchTimer=setTimeout(loadPosAgentsList,400)" style="padding:6px 12px;border-radius:6px;border:1px solid var(--border);background:var(--surface2);color:var(--text);font-size:12px;width:200px">
        </div>
      </div>
      <div class="table-wrap"><table>
        <thead><tr><th>Agent</th><th>Code</th><th>Email</th><th>Tier</th><th>Daily Limit</th><th>Volume</th><th>Txns</th><th>Rating</th><th>Status</th><th>Actions</th></tr></thead>
        <tbody id="pa-agents-tbody"><tr><td colspan="10" style="color:var(--text2);text-align:center">Loading...</td></tr></tbody>
      </table></div>
    </div>
  </div>

  <!-- ‚ïê‚ïê‚ïê POS AGENT REFERRALS ‚ïê‚ïê‚ïê -->
  <div class="page" id="page-pos-referrals" style="display:none;">
    <div class="header"><h2>Agent Referrals &amp; Bonuses</h2></div>

    <div class="grid grid-4" id="pos-ref-stats">
      <div class="card"><div class="card-header"><span class="card-title">Total Referrals</span><span class="card-icon">&#128279;</span></div><div class="card-value val-blue" id="pr-total-referrals">0</div></div>
      <div class="card"><div class="card-header"><span class="card-title">Active Referred</span><span class="card-icon">&#9989;</span></div><div class="card-value val-green" id="pr-active-referred">0</div><div class="card-sub">became active agents</div></div>
      <div class="card"><div class="card-header"><span class="card-title">Bonuses Paid</span><span class="card-icon">&#128176;</span></div><div class="card-value val-purple" id="pr-bonuses-paid">&#8358;0</div></div>
      <div class="card"><div class="card-header"><span class="card-title">Pending Bonuses</span><span class="card-icon">&#9203;</span></div><div class="card-value val-yellow" id="pr-bonuses-pending">&#8358;0</div></div>
    </div>

    <!-- Bonus Structure -->
    <div class="card" style="margin-top:16px">
      <div class="section-title">Bonus Structure</div>
      <div class="table-wrap"><table>
        <thead><tr><th>Milestone</th><th>Referrer Bonus</th><th>New Agent Bonus</th><th>Condition</th></tr></thead>
        <tbody>
          <tr><td>Sign-up</td><td style="color:var(--success)">&#8358;500</td><td style="color:var(--success)">&#8358;200</td><td>Referred agent completes registration</td></tr>
          <tr><td>First Sale</td><td style="color:var(--success)">&#8358;1,000</td><td style="color:var(--success)">&#8358;500</td><td>Referred agent makes their first sale</td></tr>
          <tr><td>10 Sales</td><td style="color:var(--success)">&#8358;2,000</td><td>‚Äî</td><td>Referred agent reaches 10 completed sales</td></tr>
          <tr><td>50 Sales</td><td style="color:var(--success)">&#8358;5,000</td><td>‚Äî</td><td>Referred agent reaches 50 completed sales</td></tr>
          <tr><td>Ongoing</td><td style="color:var(--success)">2% of commission</td><td>‚Äî</td><td>Ongoing share of referred agent's earnings for 6 months</td></tr>
        </tbody>
      </table></div>
    </div>

    <!-- Top Referrers -->
    <div class="card" style="margin-top:16px">
      <div class="section-title">Top Referrers</div>
      <div class="table-wrap"><table>
        <thead><tr><th>#</th><th>Agent</th><th>Code</th><th>Referrals</th><th>Active</th><th>Bonuses Earned</th><th>Status</th></tr></thead>
        <tbody id="pr-top-referrers"><tr><td colspan="7" style="color:var(--text2);text-align:center">Loading...</td></tr></tbody>
      </table></div>
    </div>

    <!-- Recent Referral Events -->
    <div class="card" style="margin-top:16px">
      <div class="section-title">Recent Referral Events</div>
      <div class="table-wrap"><table>
        <thead><tr><th>Date</th><th>Referrer</th><th>New Agent</th><th>Milestone</th><th>Bonus</th><th>Status</th></tr></thead>
        <tbody id="pr-events-tbody"><tr><td colspan="6" style="color:var(--text2);text-align:center">Loading...</td></tr></tbody>
      </table></div>
    </div>
  </div>

  <!-- ‚ïê‚ïê‚ïê HR HIRING PIPELINE ‚ïê‚ïê‚ïê -->
  <div class="page" id="page-hr-dashboard" style="display:none;">
    <div class="header">
      <h2>Hiring Pipeline</h2>
      <a href="/careers" target="_blank" style="padding:6px 14px;border-radius:8px;background:rgba(99,102,241,0.1);color:var(--accent2);font-size:12px;font-weight:600;text-decoration:none">View Careers Page &rarr;</a>
    </div>

    <div class="grid grid-4">
      <div class="card"><div class="card-header"><span class="card-title">Open Positions</span><span class="card-icon">&#128196;</span></div><div class="card-value val-blue" id="hr-open">0</div></div>
      <div class="card"><div class="card-header"><span class="card-title">Applications</span><span class="card-icon">&#128236;</span></div><div class="card-value val-purple" id="hr-total-apps">0</div><div class="card-sub"><span id="hr-new-week">0</span> this week</div></div>
      <div class="card"><div class="card-header"><span class="card-title">In Pipeline</span><span class="card-icon">&#128260;</span></div><div class="card-value val-orange" id="hr-pipeline">0</div></div>
      <div class="card"><div class="card-header"><span class="card-title">Hired</span><span class="card-icon">&#9989;</span></div><div class="card-value val-green" id="hr-hired">0</div></div>
    </div>

    <!-- Pipeline Funnel -->
    <div class="card" style="margin-top:16px">
      <div class="section-title">Pipeline Stages</div>
      <div id="hr-pipeline-stages" style="display:flex;gap:8px;flex-wrap:wrap;margin-top:8px"></div>
    </div>

    <!-- By Department -->
    <div class="card" style="margin-top:16px">
      <div class="section-title">By Department</div>
      <div class="table-wrap"><table>
        <thead><tr><th>Department</th><th>Applications</th><th>Active</th></tr></thead>
        <tbody id="hr-dept-tbody"><tr><td colspan="3" style="color:var(--text2);text-align:center">Loading...</td></tr></tbody>
      </table></div>
    </div>

    <!-- Upcoming Interviews -->
    <div class="card" style="margin-top:16px">
      <div class="section-title">Upcoming Interviews</div>
      <div class="table-wrap"><table>
        <thead><tr><th>Candidate</th><th>Position</th><th>Type</th><th>Scheduled</th><th>Interviewer</th></tr></thead>
        <tbody id="hr-interviews-tbody"><tr><td colspan="5" style="color:var(--text2);text-align:center">No upcoming interviews</td></tr></tbody>
      </table></div>
    </div>

    <!-- Recent Applications -->
    <div class="card" style="margin-top:16px">
      <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:12px">
        <div class="section-title" style="margin-bottom:0">Recent Applications</div>
        <div style="display:flex;gap:8px;align-items:center">
          <select id="hr-stage-filter" onchange="filterHrApplications()" style="padding:5px 10px;border-radius:6px;border:1px solid var(--border);background:var(--surface2);color:var(--text);font-size:11px">
            <option value="">All Stages</option>
            <option value="applied">Applied</option>
            <option value="screening">Screening</option>
            <option value="interview">Interview</option>
            <option value="assessment">Assessment</option>
            <option value="offer">Offer</option>
            <option value="hired">Hired</option>
            <option value="rejected">Rejected</option>
          </select>
          <input id="hr-search" placeholder="Search..." onkeyup="clearTimeout(window._hrTimer);window._hrTimer=setTimeout(filterHrApplications,400)" style="padding:5px 10px;border-radius:6px;border:1px solid var(--border);background:var(--surface2);color:var(--text);font-size:11px;width:160px">
        </div>
      </div>
      <div class="table-wrap"><table>
        <thead><tr><th>Name</th><th>Position</th><th>Dept</th><th>Rating</th><th>Stage</th><th>Applied</th><th>Actions</th></tr></thead>
        <tbody id="hr-apps-tbody"><tr><td colspan="7" style="color:var(--text2);text-align:center">Loading...</td></tr></tbody>
      </table></div>
    </div>
  </div>

  <!-- ‚ïê‚ïê‚ïê HR JOB LISTINGS ‚ïê‚ïê‚ïê -->
  <div class="page" id="page-hr-jobs" style="display:none;">
    <div class="header">
      <h2>Job Listings</h2>
      <button onclick="showCreateJobModal()" style="padding:8px 18px;border-radius:8px;border:none;background:var(--accent);color:#fff;font-size:13px;font-weight:600;cursor:pointer">+ Create Listing</button>
    </div>

    <div class="table-wrap"><div class="card"><table>
      <thead><tr><th>Title</th><th>Department</th><th>Type</th><th>Location</th><th>Salary</th><th>Apps</th><th>Hired</th><th>Status</th><th>Actions</th></tr></thead>
      <tbody id="hr-jobs-tbody"><tr><td colspan="9" style="color:var(--text2);text-align:center">Loading...</td></tr></tbody>
    </table></div></div>
  </div>

  <!-- ‚ïê‚ïê‚ïê Calendar AI: Chrono Dashboard ‚ïê‚ïê‚ïê -->
  <div class="page" id="page-calendar" style="display:none;">
    <div class="header">
      <h2>üìÖ Chrono ‚Äî Calendar AI</h2>
      <div style="display:flex;gap:10px;align-items:center">
        <span id="chrono-stream-status" style="display:inline-flex;align-items:center;gap:6px;padding:4px 12px;border-radius:12px;font-size:11px;font-weight:600;background:rgba(239,68,68,0.12);color:#ef4444">
          <span style="width:8px;height:8px;border-radius:50%;background:currentColor;animation:pulse 2s infinite"></span> Offline
        </span>
        <span id="chrono-streak-badge" style="padding:4px 14px;border-radius:12px;font-size:12px;font-weight:600;background:rgba(234,179,8,0.12);color:#eab308">üî• 0-day streak</span>
      </div>
    </div>

    <!-- Motivation Stream -->
    <div id="chrono-motivation-strip" style="background:linear-gradient(135deg,rgba(99,102,241,0.1),rgba(168,85,247,0.06));border:1px solid rgba(99,102,241,0.2);border-radius:14px;padding:18px 22px;margin-bottom:20px;position:relative;overflow:hidden">
      <div style="display:flex;align-items:center;gap:10px;margin-bottom:10px">
        <span style="font-size:22px">üß†</span>
        <span style="font-weight:700;font-size:14px">Chrono Says</span>
        <button onclick="refreshMotivation()" style="margin-left:auto;padding:4px 10px;border-radius:8px;border:1px solid var(--border);background:transparent;color:var(--text2);font-size:11px;cursor:pointer">‚Üª Refresh</button>
      </div>
      <div id="chrono-motivation-messages" style="font-size:13px;color:var(--text);line-height:1.8">
        <div style="color:var(--text2)">Connecting to Chrono...</div>
      </div>
    </div>

    <!-- Stats Cards -->
    <div class="grid grid-4" style="margin-bottom:20px">
      <div class="card" style="border-top:3px solid var(--accent)">
        <div class="card-header"><span class="card-title">Pending Tasks</span><span class="card-icon">üìã</span></div>
        <div class="card-value val-blue" id="chrono-pending">0</div>
        <div class="card-sub" id="chrono-due-today">0 due today</div>
      </div>
      <div class="card" style="border-top:3px solid var(--green)">
        <div class="card-header"><span class="card-title">Completed Today</span><span class="card-icon">‚úÖ</span></div>
        <div class="card-value val-green" id="chrono-completed-today">0</div>
        <div class="card-sub" id="chrono-week-total">0 this week</div>
      </div>
      <div class="card" style="border-top:3px solid var(--red)">
        <div class="card-header"><span class="card-title">Overdue</span><span class="card-icon">‚ö†Ô∏è</span></div>
        <div class="card-value val-red" id="chrono-overdue">0</div>
        <div class="card-sub" id="chrono-high-priority">0 high priority</div>
      </div>
      <div class="card" style="border-top:3px solid var(--yellow)">
        <div class="card-header"><span class="card-title">Productivity</span><span class="card-icon">üìä</span></div>
        <div class="card-value val-yellow" id="chrono-percent">0%</div>
        <div class="card-sub" id="chrono-total-all">0 lifetime completed</div>
      </div>
    </div>

    <!-- Quick Add -->
    <div class="card" style="margin-bottom:20px">
      <div style="display:flex;gap:10px;align-items:center">
        <input id="chrono-quick-title" type="text" placeholder="Add a task... (press Enter)" style="flex:1;padding:10px 14px;border-radius:10px;border:1px solid var(--border);background:var(--surface2);color:var(--text);font-size:14px" onkeydown="if(event.key==='Enter')chronoQuickAdd()">
        <select id="chrono-quick-priority" style="padding:10px;border-radius:10px;border:1px solid var(--border);background:var(--surface2);color:var(--text);font-size:12px">
          <option value="medium">Medium</option>
          <option value="urgent">üî¥ Urgent</option>
          <option value="high">üü† High</option>
          <option value="low">üü¢ Low</option>
        </select>
        <select id="chrono-quick-category" style="padding:10px;border-radius:10px;border:1px solid var(--border);background:var(--surface2);color:var(--text);font-size:12px">
          <option value="general">üìå General</option>
          <option value="business">üíº Business</option>
          <option value="hiring">üë• Hiring</option>
          <option value="finance">üí∞ Finance</option>
          <option value="marketing">üì¢ Marketing</option>
          <option value="product">üõ†Ô∏è Product</option>
          <option value="operations">‚öôÔ∏è Operations</option>
          <option value="meeting">üìÖ Meeting</option>
          <option value="call">üìû Call</option>
          <option value="strategy">üéØ Strategy</option>
        </select>
        <input id="chrono-quick-due" type="date" style="padding:10px;border-radius:10px;border:1px solid var(--border);background:var(--surface2);color:var(--text);font-size:12px">
        <button onclick="chronoQuickAdd()" style="padding:10px 20px;border-radius:10px;border:none;background:var(--accent);color:#fff;font-weight:700;font-size:13px;cursor:pointer;white-space:nowrap">+ Add</button>
      </div>
    </div>

    <!-- Live Reminders Feed -->
    <div class="grid grid-2">
      <div class="card" style="max-height:400px;overflow-y:auto">
        <div class="section-title">üîî Live Reminders <span id="chrono-unread-badge" style="margin-left:6px;padding:2px 8px;border-radius:10px;font-size:10px;font-weight:700;background:var(--red);color:#fff;display:none">0</span></div>
        <div id="chrono-reminders-feed" style="margin-top:12px;font-size:13px">
          <div style="color:var(--text2);text-align:center;padding:20px">No reminders yet. Add tasks with due dates.</div>
        </div>
      </div>
      <div class="card" style="max-height:400px;overflow-y:auto">
        <div class="section-title">‚ö° Today's Focus</div>
        <div id="chrono-today-list" style="margin-top:12px;font-size:13px">
          <div style="color:var(--text2);text-align:center;padding:20px">Loading...</div>
        </div>
      </div>
    </div>
  </div>

  <!-- ‚ïê‚ïê‚ïê Calendar AI: To-Do List ‚ïê‚ïê‚ïê -->
  <div class="page" id="page-calendar-todos" style="display:none;">
    <div class="header">
      <h2>‚úÖ To-Do List</h2>
      <div style="display:flex;gap:8px">
        <button onclick="showAddTodoModal()" style="padding:8px 18px;border-radius:8px;border:none;background:var(--accent);color:#fff;font-size:13px;font-weight:600;cursor:pointer">+ New Task</button>
        <button onclick="chronoClearCompleted()" style="padding:8px 14px;border-radius:8px;border:1px solid var(--border);background:transparent;color:var(--text2);font-size:12px;cursor:pointer">Clear Completed</button>
      </div>
    </div>

    <!-- Filters -->
    <div class="card" style="margin-bottom:16px">
      <div style="display:flex;gap:10px;align-items:center;flex-wrap:wrap">
        <select id="todo-filter-status" onchange="loadTodoList()" style="padding:8px 12px;border-radius:8px;border:1px solid var(--border);background:var(--surface2);color:var(--text);font-size:12px">
          <option value="">All Status</option>
          <option value="pending" selected>Pending</option>
          <option value="completed">Completed</option>
        </select>
        <select id="todo-filter-priority" onchange="loadTodoList()" style="padding:8px 12px;border-radius:8px;border:1px solid var(--border);background:var(--surface2);color:var(--text);font-size:12px">
          <option value="">All Priority</option>
          <option value="urgent">üî¥ Urgent</option>
          <option value="high">üü† High</option>
          <option value="medium">üü° Medium</option>
          <option value="low">üü¢ Low</option>
        </select>
        <select id="todo-filter-category" onchange="loadTodoList()" style="padding:8px 12px;border-radius:8px;border:1px solid var(--border);background:var(--surface2);color:var(--text);font-size:12px">
          <option value="">All Categories</option>
          <option value="business">üíº Business</option>
          <option value="hiring">üë• Hiring</option>
          <option value="finance">üí∞ Finance</option>
          <option value="marketing">üì¢ Marketing</option>
          <option value="product">üõ†Ô∏è Product</option>
          <option value="operations">‚öôÔ∏è Operations</option>
          <option value="meeting">üìÖ Meeting</option>
          <option value="strategy">üéØ Strategy</option>
          <option value="general">üìå General</option>
        </select>
        <input id="todo-search" type="text" placeholder="Search tasks..." oninput="loadTodoList()" style="padding:8px 12px;border-radius:8px;border:1px solid var(--border);background:var(--surface2);color:var(--text);font-size:12px;flex:1;min-width:200px">
      </div>
    </div>

    <!-- Todo List -->
    <div id="todo-list-container" class="card">
      <div style="color:var(--text2);text-align:center;padding:40px">Loading tasks...</div>
    </div>
  </div>

  <!-- ‚ïê‚ïê‚ïê Calendar AI: Events ‚ïê‚ïê‚ïê -->
  <div class="page" id="page-calendar-events" style="display:none;">
    <div class="header">
      <h2>üóìÔ∏è Events & Schedule</h2>
      <button onclick="showAddEventModal()" style="padding:8px 18px;border-radius:8px;border:none;background:var(--accent);color:#fff;font-size:13px;font-weight:600;cursor:pointer">+ New Event</button>
    </div>

    <div class="grid grid-2" style="margin-bottom:20px">
      <div class="card">
        <div class="section-title">üìÖ Upcoming Events</div>
        <div id="events-upcoming-list" style="margin-top:12px;font-size:13px">
          <div style="color:var(--text2);text-align:center;padding:20px">Loading...</div>
        </div>
      </div>
      <div class="card">
        <div class="section-title">Today's Schedule</div>
        <div id="events-today-list" style="margin-top:12px;font-size:13px">
          <div style="color:var(--text2);text-align:center;padding:20px">Loading...</div>
        </div>
      </div>
    </div>

    <div class="card">
      <div class="section-title">All Events</div>
      <div class="table-wrap"><table>
        <thead><tr><th>Title</th><th>Category</th><th>Start</th><th>End</th><th>Location</th><th>Actions</th></tr></thead>
        <tbody id="events-all-tbody"><tr><td colspan="6" style="color:var(--text2);text-align:center">Loading...</td></tr></tbody>
      </table></div>
    </div>
  </div>

  <!-- Add Todo Modal -->
  <div id="add-todo-modal" style="display:none;position:fixed;inset:0;background:rgba(0,0,0,0.7);z-index:1000;display:none;align-items:center;justify-content:center">
    <div style="background:var(--surface);border:1px solid var(--border);border-radius:16px;padding:28px;width:500px;max-height:90vh;overflow-y:auto">
      <h3 style="margin-bottom:16px">üìù New Task</h3>
      <div style="display:grid;gap:12px">
        <input id="modal-todo-title" type="text" placeholder="Task title *" style="padding:10px 14px;border-radius:10px;border:1px solid var(--border);background:var(--surface2);color:var(--text);font-size:14px">
        <textarea id="modal-todo-desc" placeholder="Description (optional)" rows="3" style="padding:10px 14px;border-radius:10px;border:1px solid var(--border);background:var(--surface2);color:var(--text);font-size:13px;resize:vertical"></textarea>
        <div style="display:grid;grid-template-columns:1fr 1fr;gap:10px">
          <select id="modal-todo-priority" style="padding:10px;border-radius:10px;border:1px solid var(--border);background:var(--surface2);color:var(--text);font-size:12px">
            <option value="medium">üü° Medium Priority</option>
            <option value="urgent">üî¥ Urgent</option>
            <option value="high">üü† High</option>
            <option value="low">üü¢ Low</option>
          </select>
          <select id="modal-todo-category" style="padding:10px;border-radius:10px;border:1px solid var(--border);background:var(--surface2);color:var(--text);font-size:12px">
            <option value="general">üìå General</option>
            <option value="business">üíº Business</option>
            <option value="hiring">üë• Hiring</option>
            <option value="finance">üí∞ Finance</option>
            <option value="marketing">üì¢ Marketing</option>
            <option value="product">üõ†Ô∏è Product</option>
            <option value="operations">‚öôÔ∏è Operations</option>
            <option value="strategy">üéØ Strategy</option>
            <option value="meeting">üìÖ Meeting</option>
            <option value="call">üìû Call</option>
            <option value="deadline">‚è∞ Deadline</option>
          </select>
        </div>
        <div style="display:grid;grid-template-columns:1fr 1fr;gap:10px">
          <div>
            <label style="font-size:11px;color:var(--text2);display:block;margin-bottom:4px">Due Date</label>
            <input id="modal-todo-due-date" type="date" style="width:100%;padding:10px;border-radius:10px;border:1px solid var(--border);background:var(--surface2);color:var(--text);font-size:12px">
          </div>
          <div>
            <label style="font-size:11px;color:var(--text2);display:block;margin-bottom:4px">Due Time</label>
            <input id="modal-todo-due-time" type="time" style="width:100%;padding:10px;border-radius:10px;border:1px solid var(--border);background:var(--surface2);color:var(--text);font-size:12px">
          </div>
        </div>
        <div>
          <label style="font-size:11px;color:var(--text2);display:block;margin-bottom:4px">Remind me at</label>
          <input id="modal-todo-reminder" type="datetime-local" style="width:100%;padding:10px;border-radius:10px;border:1px solid var(--border);background:var(--surface2);color:var(--text);font-size:12px">
        </div>
        <select id="modal-todo-recurrence" style="padding:10px;border-radius:10px;border:1px solid var(--border);background:var(--surface2);color:var(--text);font-size:12px">
          <option value="none">No Recurrence</option>
          <option value="daily">üîÑ Daily</option>
          <option value="weekly">üîÑ Weekly</option>
          <option value="monthly">üîÑ Monthly</option>
        </select>
      </div>
      <div style="display:flex;gap:10px;margin-top:20px;justify-content:flex-end">
        <button onclick="closeAddTodoModal()" style="padding:8px 18px;border-radius:8px;border:1px solid var(--border);background:transparent;color:var(--text2);font-size:13px;cursor:pointer">Cancel</button>
        <button onclick="submitNewTodo()" style="padding:8px 22px;border-radius:8px;border:none;background:var(--accent);color:#fff;font-weight:700;font-size:13px;cursor:pointer">Create Task</button>
      </div>
    </div>
  </div>

  <!-- Add Event Modal -->
  <div id="add-event-modal" style="display:none;position:fixed;inset:0;background:rgba(0,0,0,0.7);z-index:1000;display:none;align-items:center;justify-content:center">
    <div style="background:var(--surface);border:1px solid var(--border);border-radius:16px;padding:28px;width:500px;max-height:90vh;overflow-y:auto">
      <h3 style="margin-bottom:16px">üìÖ New Event</h3>
      <div style="display:grid;gap:12px">
        <input id="modal-event-title" type="text" placeholder="Event title *" style="padding:10px 14px;border-radius:10px;border:1px solid var(--border);background:var(--surface2);color:var(--text);font-size:14px">
        <textarea id="modal-event-desc" placeholder="Description (optional)" rows="2" style="padding:10px 14px;border-radius:10px;border:1px solid var(--border);background:var(--surface2);color:var(--text);font-size:13px;resize:vertical"></textarea>
        <div style="display:grid;grid-template-columns:1fr 1fr;gap:10px">
          <div>
            <label style="font-size:11px;color:var(--text2);display:block;margin-bottom:4px">Start *</label>
            <input id="modal-event-start" type="datetime-local" style="width:100%;padding:10px;border-radius:10px;border:1px solid var(--border);background:var(--surface2);color:var(--text);font-size:12px">
          </div>
          <div>
            <label style="font-size:11px;color:var(--text2);display:block;margin-bottom:4px">End</label>
            <input id="modal-event-end" type="datetime-local" style="width:100%;padding:10px;border-radius:10px;border:1px solid var(--border);background:var(--surface2);color:var(--text);font-size:12px">
          </div>
        </div>
        <input id="modal-event-location" type="text" placeholder="Location (optional)" style="padding:10px 14px;border-radius:10px;border:1px solid var(--border);background:var(--surface2);color:var(--text);font-size:13px">
        <select id="modal-event-category" style="padding:10px;border-radius:10px;border:1px solid var(--border);background:var(--surface2);color:var(--text);font-size:12px">
          <option value="meeting">üìÖ Meeting</option>
          <option value="call">üìû Call</option>
          <option value="review">üîç Review</option>
          <option value="deadline">‚è∞ Deadline</option>
          <option value="personal">üè† Personal</option>
        </select>
      </div>
      <div style="display:flex;gap:10px;margin-top:20px;justify-content:flex-end">
        <button onclick="closeAddEventModal()" style="padding:8px 18px;border-radius:8px;border:1px solid var(--border);background:transparent;color:var(--text2);font-size:13px;cursor:pointer">Cancel</button>
        <button onclick="submitNewEvent()" style="padding:8px 22px;border-radius:8px;border:none;background:var(--accent);color:#fff;font-weight:700;font-size:13px;cursor:pointer">Create Event</button>
      </div>
    </div>
  </div>

  <!-- ‚ïê‚ïê‚ïê Strategy: Abuja Bootstrap ‚ïê‚ïê‚ïê -->
  <div class="page" id="page-strategy-bootstrap" style="display:none;">
    <div class="header"><h2>Abuja Bootstrap Strategy</h2><span class="status-badge status-online">Active Plan</span></div>

    <!-- Phase Overview -->
    <div class="grid grid-3" style="margin-bottom:24px">
      <div class="card" style="border-left:3px solid var(--green)">
        <div class="card-header"><span class="card-title">Week 1</span><span class="card-icon" style="font-size:20px">&#127793;</span></div>
        <div style="font-size:18px;font-weight:700;color:var(--green);margin:8px 0">Launch</div>
        <div style="font-size:12px;color:var(--text2)">You + 1 Field Coordinator (commission-only). Target: 10 POS agents recruited.</div>
      </div>
      <div class="card" style="border-left:3px solid var(--yellow)">
        <div class="card-header"><span class="card-title">Week 2-3</span><span class="card-icon" style="font-size:20px">&#128640;</span></div>
        <div style="font-size:18px;font-weight:700;color:var(--yellow);margin:8px 0">Scale</div>
        <div style="font-size:12px;color:var(--text2)">Add CS support + 2nd Field Coordinator. Target: 30-50 agents.</div>
      </div>
      <div class="card" style="border-left:3px solid var(--accent)">
        <div class="card-header"><span class="card-title">Month 2+</span><span class="card-icon" style="font-size:20px">&#128293;</span></div>
        <div style="font-size:18px;font-weight:700;color:var(--accent2);margin:8px 0">Compound</div>
        <div style="font-size:12px;color:var(--text2)">100+ agents, referral flywheel, reinvest into branding + gear.</div>
      </div>
    </div>

    <!-- Revenue Projections -->
    <div class="card" style="margin-bottom:24px">
      <div class="section-title">Revenue Projections</div>
      <div class="table-wrap"><table>
        <thead><tr><th>Timeline</th><th>Agents</th><th>Est. Daily Volume</th><th>Daily Revenue (0.5-1%)</th><th>Monthly Revenue</th></tr></thead>
        <tbody>
          <tr><td style="color:var(--green);font-weight:600">Week 1</td><td>5-10</td><td>&#8358;250K - 500K</td><td>&#8358;1,250 - 5,000</td><td>&#8358;37K - 150K</td></tr>
          <tr><td style="color:var(--green);font-weight:600">Week 2</td><td>20-30</td><td>&#8358;1M - 1.5M</td><td>&#8358;5,000 - 15,000</td><td>&#8358;150K - 450K</td></tr>
          <tr><td style="color:var(--yellow);font-weight:600">Week 3-4</td><td>50+</td><td>&#8358;2.5M+</td><td>&#8358;12,500 - 25,000</td><td>&#8358;375K - 750K</td></tr>
          <tr><td style="color:var(--accent2);font-weight:600">Month 2</td><td>100+</td><td>&#8358;5M+</td><td>&#8358;25,000 - 50,000</td><td>&#8358;750K - 1.5M</td></tr>
          <tr><td style="color:var(--purple);font-weight:600">Month 3+</td><td>200+</td><td>&#8358;10M+</td><td>&#8358;50,000 - 100,000</td><td>&#8358;1.5M - 3M</td></tr>
        </tbody>
      </table></div>
    </div>

    <!-- Hiring Order -->
    <div class="grid grid-2" style="margin-bottom:24px">
      <div class="card">
        <div class="section-title" style="color:var(--green)">&#9989; Hire First (Week 1)</div>
        <div style="margin-top:12px">
          <div style="background:var(--surface2);border-radius:10px;padding:14px;margin-bottom:10px;border-left:3px solid var(--green)">
            <div style="font-weight:700;font-size:14px;margin-bottom:4px">POS Field Coordinator</div>
            <div style="font-size:12px;color:var(--text2);margin-bottom:6px">&#8358;0 base ‚Äî 20% of agent transaction fees (commission only)</div>
            <div style="font-size:11px;color:var(--text2)">
              <strong style="color:var(--text)">Profile:</strong> Hungry, well-connected in markets. Knows Wuse, Garki, Utako, Maitama.<br>
              <strong style="color:var(--text)">Job:</strong> Recruit POS agents using the app's referral system. They earn as agents earn ‚Äî fully aligned incentives.<br>
              <strong style="color:var(--text)">Target:</strong> 10 agents in first week.
            </div>
          </div>
        </div>
      </div>
      <div class="card">
        <div class="section-title" style="color:var(--yellow)">&#128337; Hire Next (Week 2-3)</div>
        <div style="margin-top:12px">
          <div style="background:var(--surface2);border-radius:10px;padding:14px;margin-bottom:10px;border-left:3px solid var(--yellow)">
            <div style="font-weight:700;font-size:14px;margin-bottom:4px">WhatsApp Customer Support</div>
            <div style="font-size:12px;color:var(--text2);margin-bottom:6px">&#8358;30-40K/month (part-time, works from home)</div>
            <div style="font-size:11px;color:var(--text2)">Handles agent onboarding questions, troubleshooting. Critical for retention ‚Äî agents who get stuck churn.</div>
          </div>
          <div style="background:var(--surface2);border-radius:10px;padding:14px;margin-bottom:10px;border-left:3px solid var(--yellow)">
            <div style="font-weight:700;font-size:14px;margin-bottom:4px">2nd Field Coordinator</div>
            <div style="font-size:12px;color:var(--text2);margin-bottom:6px">Same commission structure ‚Äî different area of Abuja</div>
            <div style="font-size:11px;color:var(--text2)">Covers Kubwa/Gwagwalada while first covers Wuse/Garki. Competition between coordinators drives faster recruitment.</div>
          </div>
        </div>
      </div>
    </div>

    <!-- Ground Game Tactics -->
    <div class="card" style="margin-bottom:24px">
      <div class="section-title">&#127919; Ground Game Tactics (Zero Cost)</div>
      <div style="display:grid;grid-template-columns:1fr 1fr;gap:12px;margin-top:14px">
        <div style="background:var(--surface2);border-radius:8px;padding:14px">
          <div style="font-weight:600;font-size:13px;margin-bottom:6px">&#127979; Hit the Markets</div>
          <div style="font-size:12px;color:var(--text2)">Wuse Market, Garki Market, Area 1 ‚Äî talk to existing POS operators. Show lower fees or better app. Face-to-face is king.</div>
        </div>
        <div style="background:var(--surface2);border-radius:8px;padding:14px">
          <div style="font-weight:600;font-size:13px;margin-bottom:6px">&#127891; Target NYSC Corpers</div>
          <div style="font-size:12px;color:var(--text2)">Thousands in Abuja, tech-savvy, need side income. Perfect as agents or coordinators. Hit orientation camps or corper lodges.</div>
        </div>
        <div style="background:var(--surface2);border-radius:8px;padding:14px">
          <div style="font-weight:600;font-size:13px;margin-bottom:6px">&#128136; Barber Shops & Phone Repair</div>
          <div style="font-size:12px;color:var(--text2)">Already have foot traffic. Adding POS is easy upsell. They become agents with zero acquisition cost.</div>
        </div>
        <div style="background:var(--surface2);border-radius:8px;padding:14px">
          <div style="font-weight:600;font-size:13px;margin-bottom:6px">&#9962; Church/Mosque Announcements</div>
          <div style="font-size:12px;color:var(--text2)">"Earn extra income with your phone" reaches hundreds for free. Weekend announcements, notice boards.</div>
        </div>
        <div style="background:var(--surface2);border-radius:8px;padding:14px">
          <div style="font-weight:600;font-size:13px;margin-bottom:6px">&#128241; WhatsApp Broadcast Lists</div>
          <div style="font-size:12px;color:var(--text2)">Create "PromptPay Abuja Agents" group. Goes viral within communities. Free organic reach.</div>
        </div>
        <div style="background:var(--surface2);border-radius:8px;padding:14px">
          <div style="font-weight:600;font-size:13px;margin-bottom:6px">&#128181; Referral Flywheel</div>
          <div style="font-size:12px;color:var(--text2)">Built-in referral system: &#8358;500 signup bonus, &#8358;1000 first sale, milestones at 10/50 sales. Agents recruit agents.</div>
        </div>
      </div>
    </div>

    <!-- What NOT To Spend On -->
    <div class="grid grid-2" style="margin-bottom:24px">
      <div class="card" style="border-left:3px solid var(--red)">
        <div class="section-title" style="color:var(--red)">&#10060; Don't Spend On (Yet)</div>
        <ul style="margin-top:12px;list-style:none;font-size:13px;color:var(--text2)">
          <li style="padding:6px 0;border-bottom:1px solid var(--border)">&#10007; Office space ‚Äî work from cafes, co-working day passes</li>
          <li style="padding:6px 0;border-bottom:1px solid var(--border)">&#10007; Paid ads ‚Äî organic/ground game only</li>
          <li style="padding:6px 0;border-bottom:1px solid var(--border)">&#10007; Salaried engineers ‚Äî the platform is built</li>
          <li style="padding:6px 0">&#10007; Branded materials ‚Äî use phone screenshots to demo</li>
        </ul>
      </div>
      <div class="card" style="border-left:3px solid var(--green)">
        <div class="section-title" style="color:var(--green)">&#128176; First &#8358;100K Reinvest Into</div>
        <ul style="margin-top:12px;list-style:none;font-size:13px;color:var(--text2)">
          <li style="padding:6px 0;border-bottom:1px solid var(--border)">&#10003; Simple flyers + business cards (&#8358;5-10K)</li>
          <li style="padding:6px 0;border-bottom:1px solid var(--border)">&#10003; 2-3 cheap Android phones for demos (&#8358;15-20K each)</li>
          <li style="padding:6px 0;border-bottom:1px solid var(--border)">&#10003; Agent starter kit (branded pouch + laminated rate card)</li>
          <li style="padding:6px 0">&#10003; Data bundles for field coordinators</li>
        </ul>
      </div>
    </div>

    <!-- Key Insight -->
    <div class="card" style="background:linear-gradient(135deg, rgba(99,102,241,0.12), rgba(168,85,247,0.08));border:1px solid rgba(99,102,241,0.25)">
      <div style="font-size:16px;font-weight:700;margin-bottom:8px">&#128161; The Exponential Growth Formula</div>
      <div style="font-size:13px;color:var(--text2);line-height:1.8">
        Each POS agent generates transaction fees on every sale. Each agent can recruit more agents via the referral system.
        The bonus structure (&#8358;500 signup &#8594; &#8358;1000 first sale &#8594; &#8358;2000 at 10 sales &#8594; &#8358;5000 at 50 sales + 2% ongoing)
        incentivizes organic network growth without you spending upfront. <strong style="color:var(--text)">You're not hiring a sales team ‚Äî you're building a self-replicating agent network.</strong>
      </div>
    </div>

    <!-- Abuse Prevention Reminder -->
    <div class="card" style="margin-top:24px">
      <div class="section-title">&#128737; Agent Abuse Prevention (Built-In)</div>
      <div style="display:grid;grid-template-columns:repeat(3,1fr);gap:10px;margin-top:12px;font-size:12px;color:var(--text2)">
        <div style="background:var(--surface2);border-radius:8px;padding:10px"><strong style="color:var(--text)">BVN/NIN Verification</strong> ‚Äî Identity tied to national ID</div>
        <div style="background:var(--surface2);border-radius:8px;padding:10px"><strong style="color:var(--text)">Guarantor System</strong> ‚Äî Someone vouches for each agent</div>
        <div style="background:var(--surface2);border-radius:8px;padding:10px"><strong style="color:var(--text)">Security Deposit</strong> ‚Äî Small refundable deposit</div>
        <div style="background:var(--surface2);border-radius:8px;padding:10px"><strong style="color:var(--text)">Progressive Limits</strong> ‚Äî &#8358;50K &#8594; &#8358;200K &#8594; &#8358;500K &#8594; &#8358;1M tiers</div>
        <div style="background:var(--surface2);border-radius:8px;padding:10px"><strong style="color:var(--text)">Velocity Checks</strong> ‚Äî Flag unusual transaction patterns</div>
        <div style="background:var(--surface2);border-radius:8px;padding:10px"><strong style="color:var(--text)">Selfie Verification</strong> ‚Äî Photo match on registration</div>
        <div style="background:var(--surface2);border-radius:8px;padding:10px"><strong style="color:var(--text)">Rating System</strong> ‚Äî Customers rate agent experience</div>
        <div style="background:var(--surface2);border-radius:8px;padding:10px"><strong style="color:var(--text)">Auto-Suspend</strong> ‚Äî Bad actors auto-flagged and frozen</div>
        <div style="background:var(--surface2);border-radius:8px;padding:10px"><strong style="color:var(--text)">First Increase Auto-Approved</strong> ‚Äî Then admin review required</div>
      </div>
    </div>
  </div>

  <div class="page" id="page-cross-border" style="display:none;">
    <div class="header"><h2>Cross-Border Transfers</h2></div>
    <p style="opacity: 0.6; margin-bottom: 20px;">Wise + USDC stablecoin cross-border payment monitoring</p>
    <div class="grid grid-4" id="cross-border-stats">
      <div class="card">
        <div class="card-header"><span class="card-title">Transfers</span><span class="card-icon">&#128260;</span></div>
        <div class="card-value val-blue" id="xborder-count">0</div>
      </div>
      <div class="card">
        <div class="card-header"><span class="card-title">Volume</span><span class="card-icon">&#128176;</span></div>
        <div class="card-value val-green" id="xborder-volume">$0</div>
      </div>
      <div class="card">
        <div class="card-header"><span class="card-title">Via Wise</span><span class="card-icon">&#9889;</span></div>
        <div class="card-value val-purple" id="xborder-wise">0</div>
      </div>
      <div class="card">
        <div class="card-header"><span class="card-title">Via USDC</span><span class="card-icon">&#128176;</span></div>
        <div class="card-value val-cyan" id="xborder-usdc">0</div>
      </div>
    </div>
    <div class="card" style="margin-top:16px">
      <div class="section-title">Recent Transfers</div>
      <div class="table-wrap"><table>
        <thead><tr><th>ID</th><th>Provider</th><th>From</th><th>To</th><th>Rate</th><th>Status</th></tr></thead>
        <tbody id="xborder-table-body"><tr><td colspan="6" style="color:var(--text2);text-align:center">No transfers yet</td></tr></tbody>
      </table></div>
    </div>
  </div>

  <!-- ‚îÄ‚îÄ ANALYTICS ‚îÄ‚îÄ -->
  <div class="page" id="page-analytics" style="display:none;">
    <div class="header"><h2>Analytics &amp; Insights</h2></div>
    <div class="an-tabs" id="an-tabs">
      <div class="an-tab active" onclick="switchAnTab('an-overview')">Overview</div>
      <div class="an-tab" onclick="switchAnTab('an-trends')">Trends</div>
      <div class="an-tab" onclick="switchAnTab('an-forecast')">Forecast</div>
      <div class="an-tab" onclick="switchAnTab('an-insights')">AI Insights</div>
      <div class="an-tab" onclick="switchAnTab('an-cashflow')">Cash Flow</div>
      <div class="an-tab" onclick="switchAnTab('an-partners')">Partners</div>
    </div>

    <!-- Overview -->
    <div id="an-overview" class="an-section">
      <div class="kpi-grid" id="an-kpi-grid">
        <div style="color:var(--text2);padding:20px;grid-column:1/-1;text-align:center">Loading metrics...</div>
      </div>
    </div>

    <!-- Trends -->
    <div id="an-trends" class="an-section" style="display:none">
      <div class="chart-filters">
        <select class="chart-filter" id="an-trend-agg" onchange="anLoadTrends()">
          <option value="hourly">Hourly</option><option value="daily" selected>Daily</option>
          <option value="weekly">Weekly</option><option value="monthly">Monthly</option>
        </select>
        <select class="chart-filter" id="an-trend-metric" onchange="anRenderTrendChart()">
          <option value="volume">Volume</option><option value="transactions">Transactions</option><option value="revenue">Revenue</option>
        </select>
      </div>
      <div class="chart-box"><canvas id="an-trend-chart" height="250"></canvas></div>
      <div style="margin-top:14px">
        <div class="an-section-title2">User Growth</div>
        <div class="chart-box"><canvas id="an-user-chart" height="180"></canvas></div>
      </div>
    </div>

    <!-- Forecast -->
    <div id="an-forecast" class="an-section" style="display:none">
      <div class="chart-filters">
        <select class="chart-filter" id="an-fc-horizon" onchange="anLoadForecast()">
          <option value="7">7 Days</option><option value="30" selected>30 Days</option><option value="90">90 Days</option>
        </select>
        <select class="chart-filter" id="an-fc-metric" onchange="anLoadForecast()">
          <option value="volume">Volume</option><option value="revenue">Revenue</option><option value="transactions">Transactions</option>
        </select>
      </div>
      <div class="chart-box"><canvas id="an-forecast-chart" height="280"></canvas></div>
      <div class="forecast-meta" id="an-fc-meta"></div>
    </div>

    <!-- AI Insights -->
    <div id="an-insights" class="an-section" style="display:none">
      <div class="an-section-title2">AI-Generated Insights <span class="badge">Live</span></div>
      <div id="an-insights-summary" style="font-size:13px;color:var(--text2);margin-bottom:10px;padding:10px;background:var(--surface);border-radius:10px;border:1px solid var(--border)"></div>
      <div id="an-insights-list">
        <div style="color:var(--text2);text-align:center;padding:20px">Loading insights...</div>
      </div>
    </div>

    <!-- Cash Flow -->
    <div id="an-cashflow" class="an-section" style="display:none">
      <div class="an-section-title2">Cash Flow Projection</div>
      <div class="chart-box"><canvas id="an-cf-chart" height="260"></canvas></div>
      <div class="cf-legend">
        <span><span class="cf-dot" style="background:var(--green)"></span>Inflow</span>
        <span><span class="cf-dot" style="background:var(--red)"></span>Outflow</span>
        <span><span class="cf-dot" style="background:var(--accent)"></span>Balance</span>
      </div>
      <div id="an-cf-warning" style="display:none;margin-top:10px;padding:10px;background:rgba(239,68,68,.1);border:1px solid rgba(239,68,68,.3);border-radius:10px;font-size:13px;color:var(--red)">
        Low liquidity warning: Projected balance drops below zero.
      </div>
    </div>

    <!-- Partners -->
    <div id="an-partners" class="an-section" style="display:none">
      <div class="an-section-title2">Top Partners</div>
      <div class="chart-filters">
        <select class="chart-filter" id="an-partner-sort" onchange="anLoadPartnerRankings()">
          <option value="volume">By Volume</option><option value="revenue">By Revenue</option>
        </select>
      </div>
      <div class="chart-box" style="overflow-x:auto">
        <table class="rank-table2">
          <thead><tr><th>#</th><th>Partner</th><th>Volume</th><th>Revenue</th><th>Transactions</th></tr></thead>
          <tbody id="an-partner-tbody"></tbody>
        </table>
      </div>
      <div style="margin-top:16px">
        <div class="an-section-title2">At-Risk Partners <span class="badge" style="background:var(--red)">Churn</span></div>
        <div id="an-at-risk-list"></div>
      </div>
    </div>
  </div>

</div>

<script>
const API = '';
let ws = null;
let currentUser = null;

// ‚îÄ‚îÄ Navigation ‚îÄ‚îÄ
document.querySelectorAll('.nav-item').forEach(item => {
  item.addEventListener('click', () => {
    if (item.classList.contains('role-hidden')) return;
    document.querySelectorAll('.nav-item').forEach(i => i.classList.remove('active'));
    document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
    item.classList.add('active');
    const page = item.dataset.page;
    document.getElementById('page-' + page).classList.add('active');
    loadPage(page);
  });
});

// ‚îÄ‚îÄ Auth helpers ‚îÄ‚îÄ
function isTokenExpired(token) {
  try {
    const parts = token.split('.');
    if (parts.length < 2) return true;
    const payload = JSON.parse(atob(parts[0].replace(/-/g, '+').replace(/_/g, '/')));
    return !payload.exp || payload.exp < Date.now();
  } catch { return true; }
}

function getToken() {
  const token = localStorage.getItem('uppAdminToken');
  if (token && isTokenExpired(token)) {
    localStorage.removeItem('uppAdminToken');
    return null;
  }
  return token;
}
function setToken(token) {
  localStorage.setItem('uppAdminToken', token);
}
function clearToken() {
  localStorage.removeItem('uppAdminToken');
}

// ‚îÄ‚îÄ API helpers (auth-aware) ‚îÄ‚îÄ
async function api(path, options = {}) {
  try {
    const token = getToken();
    if (!token) {
      clearToken();
      currentUser = null;
      showAuthGate('Session expired. Please sign in again.');
      return null;
    }
    const headers = options.headers || {};
    headers['Authorization'] = 'Bearer ' + token;
    if (options.body && typeof options.body === 'object' && !(options.body instanceof FormData)) {
      headers['Content-Type'] = 'application/json';
      options.body = JSON.stringify(options.body);
    }
    const res = await fetch(API + path, { ...options, headers });
    if (res.status === 401 || res.status === 403) {
      clearToken();
      currentUser = null;
      showAuthGate('Session expired. Please sign in again.');
      return null;
    }
    return await res.json();
  } catch(e) {
    console.error('API error:', path, e);
    return null;
  }
}

function fmt(n) { return n != null ? n.toLocaleString() : '--'; }
function fmtTime(s) {
  if (!s) return '--';
  const h = Math.floor(s/3600); const m = Math.floor((s%3600)/60);
  return h > 0 ? `${h}h ${m}m` : `${m}m ${Math.floor(s%60)}s`;
}

// ‚îÄ‚îÄ Auth Gate ‚îÄ‚îÄ
function showAuthGate(message) {
  document.getElementById('auth-gate').classList.remove('hidden');
  document.querySelector('.sidebar').style.display = 'none';
  document.querySelector('.main').style.display = 'none';
  document.getElementById('sidebar-bottom').style.display = 'none';
  const errorEl = document.getElementById('login-error');
  if (errorEl) errorEl.textContent = message || '';
}

function hideAuthGate() {
  document.getElementById('auth-gate').classList.add('hidden');
  document.querySelector('.sidebar').style.display = '';
  document.querySelector('.main').style.display = '';
  document.getElementById('sidebar-bottom').style.display = '';
}

async function handleLogin(e) {
  e.preventDefault();
  const email = document.getElementById('login-email').value.trim();
  const password = document.getElementById('login-password').value;
  const errorEl = document.getElementById('login-error');
  const btn = document.getElementById('login-btn');

  errorEl.textContent = '';
  btn.disabled = true;
  btn.textContent = 'Signing in...';

  try {
    const res = await fetch(API + '/api/auth/login', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ email, password })
    });
    const data = await res.json();
    if (!res.ok || !data.token) {
      errorEl.textContent = data.message || data.error || 'Invalid credentials';
      btn.disabled = false;
      btn.textContent = 'Sign In';
      return;
    }
    setToken(data.token);
    currentUser = data.user;
    onAuthenticated();
  } catch(err) {
    errorEl.textContent = 'Connection error. Please try again.';
    btn.disabled = false;
    btn.textContent = 'Sign In';
  }
}

function handleLogout() {
  clearToken();
  currentUser = null;
  if (ws) { try { ws.close(); } catch(e) {} ws = null; }
  document.getElementById('login-email').value = '';
  document.getElementById('login-password').value = '';
  document.getElementById('login-error').textContent = '';
  document.getElementById('login-btn').disabled = false;
  document.getElementById('login-btn').textContent = 'Sign In';
  showAuthGate();
}

// ‚îÄ‚îÄ Role-based sidebar visibility ‚îÄ‚îÄ
function applyRoleVisibility(role) {
  const partnersNav = document.getElementById('nav-partners');
  const partnersSection = document.getElementById('nav-section-partners');
  const execNav = document.getElementById('nav-executive');
  const execSection = document.getElementById('nav-section-executive');

  if (role === 'owner') {
    // Owner sees everything
    partnersNav.classList.remove('role-hidden');
    partnersSection.style.display = '';
    execNav.classList.remove('role-hidden');
    execSection.style.display = '';
  } else if (role === 'partner_admin') {
    // partner_admin: hide Partners, Executive AI
    partnersNav.classList.add('role-hidden');
    partnersSection.style.display = 'none';
    execNav.classList.add('role-hidden');
    execSection.style.display = 'none';
  } else {
    // Default: hide partner management + executive
    partnersNav.classList.add('role-hidden');
    partnersSection.style.display = 'none';
    execNav.classList.add('role-hidden');
    execSection.style.display = 'none';
  }

  // If current active page is now hidden, reset to dashboard
  const activeNav = document.querySelector('.nav-item.active');
  if (activeNav && activeNav.classList.contains('role-hidden')) {
    activeNav.classList.remove('active');
    document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
    const dashNav = document.querySelector('.nav-item[data-page="dashboard"]');
    dashNav.classList.add('active');
    document.getElementById('page-dashboard').classList.add('active');
    loadPage('dashboard');
  }
}

// ‚îÄ‚îÄ Post-authentication setup ‚îÄ‚îÄ
function onAuthenticated() {
  hideAuthGate();

  // Update sidebar user info
  const userEl = document.getElementById('sidebar-user');
  if (currentUser) {
    const displayName = currentUser.name || currentUser.email || 'Admin';
    const roleBadge = currentUser.role === 'owner' ? 'Owner' : currentUser.role === 'partner_admin' ? 'Partner Admin' : currentUser.role;
    userEl.innerHTML = '<strong>' + displayName + '</strong>' + roleBadge;
  }

  // Apply role visibility
  applyRoleVisibility(currentUser ? currentUser.role : 'partner_admin');

  // Start the dashboard
  loadDashboard();
  connectWs();
}

// ‚îÄ‚îÄ Init: check stored token ‚îÄ‚îÄ
async function initAuth() {
  const rawToken = localStorage.getItem('uppAdminToken');

  // No token at all ‚Äî fresh visit
  if (!rawToken) {
    showAuthGate();
    return;
  }

  // Token exists but expired ‚Äî auto-clear, show friendly message
  if (isTokenExpired(rawToken)) {
    localStorage.removeItem('uppAdminToken');
    showAuthGate('Your session has expired. Please sign in again.');
    return;
  }

  // Token looks valid client-side ‚Äî verify with server
  try {
    const res = await fetch(API + '/api/auth/me', {
      headers: { 'Authorization': 'Bearer ' + rawToken }
    });
    if (!res.ok) {
      clearToken();
      showAuthGate('Your session is no longer valid. Please sign in again.');
      return;
    }
    const data = await res.json();
    currentUser = data.user || data;
    onAuthenticated();
  } catch(e) {
    clearToken();
    showAuthGate('Connection error. Please sign in again.');
  }
}

// ‚îÄ‚îÄ Static agent data (since agents spawn on-demand) ‚îÄ‚îÄ
const AGENTS = [
  { name: 'Nexus', role: 'wallet_ops', desc: 'Wallet, P2P, Bills, PromptPay', tools: 15, color: '#6366f1' },
  { name: 'Janus', role: 'us_payment_ops', desc: 'Stripe, ACH, Apple/Google Pay', tools: 12, color: '#3b82f6' },
  { name: 'Mercury', role: 'payment_ops', desc: 'M-Pesa, MTN MoMo, Flutterwave', tools: 8, color: '#06b6d4' },
  { name: 'Plutus', role: 'banking_ops', desc: 'Mono, Stitch Open Banking', tools: 6, color: '#22c55e' },
  { name: 'Atlas', role: 'financial_ops', desc: 'Credit, Disputes, Optimization', tools: 4, color: '#a855f7' },
];

// ‚îÄ‚îÄ Dashboard ‚îÄ‚îÄ
async function loadDashboard() {
  const data = await api('/admin/dashboard');
  if (!data) return;

  const orch = data.orchestrator || {};
  document.getElementById('stat-tools').textContent = fmt(orch.toolCount || 45);
  document.getElementById('stat-uptime').textContent = fmtTime(data.uptime);
  document.getElementById('stat-audit').textContent = fmt(data.auditEntries);

  // Agents grid
  const grid = document.getElementById('agents-grid');
  grid.innerHTML = AGENTS.map(a => `
    <div class="agent-card">
      <div style="display:flex;align-items:center;gap:10px;margin-bottom:8px">
        <div style="width:36px;height:36px;border-radius:10px;background:${a.color}20;display:flex;align-items:center;justify-content:center;font-size:18px;color:${a.color}">&#9881;</div>
        <div>
          <div class="agent-name">${a.name}</div>
          <div class="agent-role">${a.role}</div>
        </div>
      </div>
      <div style="font-size:12px;color:var(--text2);margin-bottom:8px">${a.desc}</div>
      <div style="font-size:13px"><strong>${a.tools}</strong> <span style="color:var(--text2)">tools registered</span></div>
    </div>
  `).join('');

  // Hooks summary
  const hooks = data.hooks || {};
  const hooksEl = document.getElementById('hooks-summary');
  hooksEl.innerHTML = Object.entries(hooks).map(([name, stats]) => {
    const s = stats || {};
    const mainStat = Object.values(s)[0] || 0;
    return `<div style="display:flex;justify-content:space-between;padding:6px 0;border-bottom:1px solid var(--border)">
      <span style="text-transform:capitalize">${name}</span>
      <span style="color:var(--accent2);font-weight:600">${typeof mainStat === 'number' ? fmt(mainStat) : '--'}</span>
    </div>`;
  }).join('');

  // Providers
  const provData = await api('/admin/providers');
  const provEl = document.getElementById('providers-summary');
  if (provData && provData.providers) {
    provEl.innerHTML = provData.providers.map(p => `
      <div style="display:flex;justify-content:space-between;align-items:center;padding:6px 0;border-bottom:1px solid var(--border)">
        <span style="text-transform:capitalize">${p.name.replace('_',' ')}</span>
        <span class="badge ${p.status === 'healthy' ? 'badge-green' : p.status === 'degraded' ? 'badge-yellow' : 'badge-red'}">${p.status}</span>
      </div>
    `).join('');
  }
}

// ‚îÄ‚îÄ Agents detail ‚îÄ‚îÄ
async function loadAgents() {
  const grid = document.getElementById('agents-detail-grid');
  grid.innerHTML = AGENTS.map(a => `
    <div class="agent-card">
      <div style="display:flex;align-items:center;gap:12px;margin-bottom:12px">
        <div style="width:48px;height:48px;border-radius:12px;background:${a.color}20;display:flex;align-items:center;justify-content:center;font-size:24px;color:${a.color}">&#9881;</div>
        <div>
          <div class="agent-name">${a.name}</div>
          <div class="agent-role">${a.role}</div>
        </div>
      </div>
      <div style="font-size:13px;color:var(--text2);margin-bottom:10px">${a.desc}</div>
      <div style="font-size:14px;margin-bottom:4px"><strong>${a.tools}</strong> tools</div>
      <div class="progress-bar">
        <div class="progress-fill" style="width:${(a.tools/15)*100}%;background:${a.color}"></div>
      </div>
    </div>
  `).join('');
}

// ‚îÄ‚îÄ Tasks ‚îÄ‚îÄ
async function loadTasks() {
  const data = await api('/admin/tasks');
  const body = document.getElementById('tasks-body');
  if (!data || !data.tasks || data.tasks.length === 0) {
    body.innerHTML = '<tr><td colspan="6" style="color:var(--text2);text-align:center">No tasks in queue</td></tr>';
    return;
  }
  body.innerHTML = data.tasks.map(t => `<tr>
    <td style="font-family:monospace;font-size:11px">${(t.id || '').slice(0,8)}</td>
    <td><span class="badge badge-blue">${t.type}</span></td>
    <td><span class="badge ${t.priority==='critical'?'badge-red':t.priority==='high'?'badge-yellow':'badge-blue'}">${t.priority}</span></td>
    <td>${t.title}</td>
    <td>${t.assignedAgent || '-'}</td>
    <td>${t.result ? (t.result.success ? '<span class="badge badge-green">done</span>' : '<span class="badge badge-red">failed</span>') : '<span class="badge badge-yellow">pending</span>'}</td>
  </tr>`).join('');
}

// ‚îÄ‚îÄ Streaks ‚îÄ‚îÄ
async function loadStreaks() {
  const data = await api('/admin/hooks/streaks');
  if (!data) return;
  const s = data.stats || {};
  document.getElementById('streaks-stats').innerHTML = `
    <div class="card"><div class="card-header"><span class="card-title">Total Users</span></div><div class="card-value val-blue">${fmt(s.totalUsers)}</div></div>
    <div class="card"><div class="card-header"><span class="card-title">Active Streaks</span></div><div class="card-value val-green">${fmt(s.activeStreaks)}</div></div>
    <div class="card"><div class="card-header"><span class="card-title">Avg Streak</span></div><div class="card-value val-purple">${s.avgStreak || 0}</div><div class="card-sub">days</div></div>
    <div class="card"><div class="card-header"><span class="card-title">Max Streak</span></div><div class="card-value val-orange">${s.maxStreak || 0}</div><div class="card-sub">days</div></div>
  `;
  const lb = data.leaderboard || [];
  const tbody = document.getElementById('streaks-leaderboard');
  if (lb.length === 0) {
    tbody.innerHTML = '<tr><td colspan="4" style="color:var(--text2);text-align:center">No active streaks</td></tr>';
  } else {
    tbody.innerHTML = lb.map((r,i) => `<tr>
      <td>${i<3?['&#129351;','&#129352;','&#129353;'][i]:''} ${r.user_id || r.userId}</td>
      <td><strong>${r.current_streak || r.currentStreak}</strong> days</td>
      <td>${r.longest_streak || r.longestStreak}</td>
      <td><span class="badge badge-purple">${(r.multiplier || 1).toFixed(2)}x</span></td>
    </tr>`).join('');
  }
}

// ‚îÄ‚îÄ Cashback ‚îÄ‚îÄ
async function loadCashback() {
  const data = await api('/admin/hooks/cashback');
  if (!data) return;
  document.getElementById('cashback-stats').innerHTML = `
    <div class="card"><div class="card-header"><span class="card-title">Total Rules</span></div><div class="card-value val-blue">${fmt(data.totalRules)}</div></div>
    <div class="card"><div class="card-header"><span class="card-title">Active Rules</span></div><div class="card-value val-green">${fmt(data.activeRules)}</div></div>
    <div class="card"><div class="card-header"><span class="card-title">Total Cashback</span></div><div class="card-value val-purple">$${(data.totalCashbackIssued||0).toFixed(2)}</div></div>
    <div class="card"><div class="card-header"><span class="card-title">Pending</span></div><div class="card-value val-yellow">$${(data.pendingCashback||0).toFixed(2)}</div></div>
  `;
}

// ‚îÄ‚îÄ Referrals ‚îÄ‚îÄ
async function loadReferrals() {
  const data = await api('/admin/hooks/referrals');
  if (!data) return;
  document.getElementById('referrals-stats').innerHTML = `
    <div class="card"><div class="card-header"><span class="card-title">Total Codes</span></div><div class="card-value val-blue">${fmt(data.totalCodes)}</div></div>
    <div class="card"><div class="card-header"><span class="card-title">Total Referrals</span></div><div class="card-value val-green">${fmt(data.totalReferrals)}</div></div>
    <div class="card"><div class="card-header"><span class="card-title">Bonuses Paid</span></div><div class="card-value val-purple">$${(data.totalBonusesPaid||0).toFixed(2)}</div></div>
    <div class="card"><div class="card-header"><span class="card-title">Pending</span></div><div class="card-value val-yellow">$${(data.pendingBonuses||0).toFixed(2)}</div></div>
  `;
}

// ‚îÄ‚îÄ Achievements ‚îÄ‚îÄ
async function loadAchievements() {
  const data = await api('/admin/hooks/achievements');
  if (!data) return;
  document.getElementById('achievements-stats').innerHTML = `
    <div class="card"><div class="card-header"><span class="card-title">Definitions</span></div><div class="card-value val-blue">${fmt(data.totalDefinitions)}</div><div class="card-sub">milestone types</div></div>
    <div class="card"><div class="card-header"><span class="card-title">Total Unlocks</span></div><div class="card-value val-green">${fmt(data.totalUnlocks)}</div></div>
    <div class="card"><div class="card-header"><span class="card-title">Most Popular</span></div><div class="card-value val-purple" style="font-size:16px">${data.mostUnlocked && data.mostUnlocked[0] ? data.mostUnlocked[0].name : 'N/A'}</div></div>
  `;
}

// ‚îÄ‚îÄ Loyalty ‚îÄ‚îÄ
async function loadLoyalty() {
  const data = await api('/admin/hooks/loyalty');
  if (!data) return;
  document.getElementById('loyalty-stats').innerHTML = `
    <div class="card"><div class="card-header"><span class="card-title">Accounts</span></div><div class="card-value val-blue">${fmt(data.totalAccounts)}</div></div>
    <div class="card"><div class="card-header"><span class="card-title">Points Issued</span></div><div class="card-value val-green">${fmt(data.totalPointsIssued)}</div></div>
    <div class="card"><div class="card-header"><span class="card-title">Redeemed</span></div><div class="card-value val-purple">${fmt(data.totalRedeemed)}</div></div>
    <div class="card"><div class="card-header"><span class="card-title">Tier Distribution</span></div>
      <div style="margin-top:8px;font-size:13px">
        ${Object.entries(data.tierDistribution||{}).map(([tier,count]) =>
          `<div style="display:flex;justify-content:space-between;padding:3px 0"><span style="text-transform:capitalize">${tier}</span><strong>${count}</strong></div>`
        ).join('')}
      </div>
    </div>
  `;
}

// ‚îÄ‚îÄ Insights ‚îÄ‚îÄ
async function loadInsights() {
  const data = await api('/admin/hooks/insights');
  if (!data) return;
  document.getElementById('insights-stats').innerHTML = `
    <div class="card"><div class="card-header"><span class="card-title">Insights Generated</span></div><div class="card-value val-blue">${fmt(data.totalInsightsGenerated)}</div></div>
    <div class="card"><div class="card-header"><span class="card-title">Users with Insights</span></div><div class="card-value val-green">${fmt(data.usersWithInsights)}</div></div>
    <div class="card"><div class="card-header"><span class="card-title">Avg Savings Rate</span></div><div class="card-value val-purple">${data.avgSavingsRate||0}%</div></div>
  `;
}

// ‚îÄ‚îÄ Partners ‚îÄ‚îÄ
async function loadPartners() {
  const data = await api('/api/partners');
  if (!data) return;
  const partners = data.partners || data || [];
  const list = Array.isArray(partners) ? partners : [];

  // Compute stats
  const total = list.length;
  const active = list.filter(p => p.status === 'approved' || p.status === 'active').length;
  const pending = list.filter(p => p.status === 'pending').length;
  const totalUsers = list.reduce((sum, p) => sum + (p.users || p.userCount || 0), 0);

  document.getElementById('stat-partners-total').textContent = fmt(total);
  document.getElementById('stat-partners-active').textContent = fmt(active);
  document.getElementById('stat-partners-pending').textContent = fmt(pending);
  document.getElementById('stat-partners-users').textContent = fmt(totalUsers);

  // Render table
  const body = document.getElementById('partners-body');
  if (list.length === 0) {
    body.innerHTML = '<tr><td colspan="5" style="color:var(--text2);text-align:center">No partner applications</td></tr>';
    return;
  }
  body.innerHTML = list.map(p => {
    const status = p.status || 'pending';
    const statusBadge = status === 'approved' || status === 'active'
      ? 'badge-green' : status === 'pending'
      ? 'badge-yellow' : status === 'suspended'
      ? 'badge-red' : 'badge-blue';
    const users = p.users || p.userCount || 0;
    const id = p.id || p._id;
    let actions = '';
    if (status === 'pending') {
      actions = `<button class="btn-sm btn-approve" onclick="approvePartner('${id}')">Approve</button>`;
    } else if (status === 'approved' || status === 'active') {
      actions = `<button class="btn-sm btn-suspend" onclick="suspendPartner('${id}')">Suspend</button>`;
    } else if (status === 'suspended') {
      actions = `<button class="btn-sm btn-approve" onclick="approvePartner('${id}')">Reactivate</button>`;
    }
    return `<tr>
      <td><strong>${p.name || p.companyName || '--'}</strong></td>
      <td>${p.contactEmail || p.email || '--'}</td>
      <td><span class="badge ${statusBadge}">${status}</span></td>
      <td>${fmt(users)}</td>
      <td>${actions}</td>
    </tr>`;
  }).join('');
}

async function approvePartner(id) {
  const data = await api('/api/partners/' + id + '/approve', { method: 'PUT' });
  if (data && data.credentials) {
    showCredsModal(data.credentials);
  } else if (data) {
    showCredsModal(data);
  }
  loadPartners();
}

async function suspendPartner(id) {
  await api('/api/partners/' + id + '/suspend', { method: 'PUT' });
  loadPartners();
}

function showCredsModal(creds) {
  const el = document.getElementById('creds-content');
  el.innerHTML = `
    <div><strong>Email:</strong> ${creds.email || creds.adminEmail || '--'}</div>
    <div><strong>Password:</strong> ${creds.password || creds.tempPassword || '--'}</div>
    ${creds.apiKey ? '<div><strong>API Key:</strong> ' + creds.apiKey + '</div>' : ''}
    ${creds.partnerId ? '<div><strong>Partner ID:</strong> ' + creds.partnerId + '</div>' : ''}
  `;
  document.getElementById('creds-modal').classList.remove('hidden');
}

function closeCredsModal() {
  document.getElementById('creds-modal').classList.add('hidden');
}

// ‚îÄ‚îÄ Providers ‚îÄ‚îÄ
async function loadProviders() {
  const data = await api('/admin/providers');
  if (!data) return;
  document.getElementById('providers-grid').innerHTML = (data.providers||[]).map(p => `
    <div class="card">
      <div class="card-header">
        <span class="card-title" style="text-transform:capitalize">${p.name.replace('_',' ')}</span>
        <span class="badge ${p.status==='healthy'?'badge-green':p.status==='degraded'?'badge-yellow':'badge-red'}">${p.status}</span>
      </div>
      <div style="font-size:12px;color:var(--text2);margin-top:4px">
        Circuit: <strong>${p.circuitBreaker.state}</strong> &middot; Failures: ${p.circuitBreaker.failures}
      </div>
    </div>
  `).join('');
}

// ‚îÄ‚îÄ Audit ‚îÄ‚îÄ
async function loadAudit() {
  const data = await api('/admin/audit?limit=50');
  if (!data) return;
  const body = document.getElementById('audit-body');
  body.innerHTML = (data.entries||[]).map(e => `<tr>
    <td>${e.sequenceNumber}</td>
    <td style="font-size:11px">${new Date(e.timestamp).toLocaleString()}</td>
    <td><span class="badge badge-blue">${e.actor}</span></td>
    <td>${e.action}</td>
    <td>${e.target}</td>
    <td style="font-family:monospace;font-size:10px;color:var(--text2)">${(e.hash||'').slice(0,16)}...</td>
  </tr>`).join('');
}

async function verifyChain() {
  const data = await api('/admin/audit/verify');
  const el = document.getElementById('chain-result');
  if (data && data.valid) {
    el.innerHTML = `<span class="badge badge-green">&#10003; Chain Valid</span> &mdash; ${data.totalEntries} entries verified`;
  } else {
    el.innerHTML = `<span class="badge badge-red">&#10007; Chain Broken</span> at entry #${data?.brokenAt || '?'}`;
  }
}

// ‚îÄ‚îÄ Health ‚îÄ‚îÄ
async function loadHealth() {
  const data = await api('/admin/health');
  if (!data) return;
  const orch = data.orchestrator || {};
  document.getElementById('health-stats').innerHTML = `
    <div class="card"><div class="card-header"><span class="card-title">Status</span></div>
      <div class="card-value val-green">${data.status}</div></div>
    <div class="card"><div class="card-header"><span class="card-title">Uptime</span></div>
      <div class="card-value val-blue">${fmtTime(data.uptime)}</div></div>
    <div class="card"><div class="card-header"><span class="card-title">Tools</span></div>
      <div class="card-value val-purple">${orch.tools || '--'}</div></div>
  `;
  const breakers = data.circuitBreakers || [];
  document.getElementById('breakers-body').innerHTML = breakers.map(b => `<tr>
    <td style="text-transform:capitalize">${b.toolName.replace('_',' ')}</td>
    <td><span class="badge ${b.state==='closed'?'badge-green':b.state==='half_open'?'badge-yellow':'badge-red'}">${b.state}</span></td>
    <td>${b.failureCount}</td>
    <td><button onclick="resetBreaker('${b.toolName}')" style="padding:4px 12px;background:var(--surface2);color:var(--text);border:1px solid var(--border);border-radius:6px;cursor:pointer;font-size:11px">Reset</button></td>
  </tr>`).join('');
}

async function resetBreaker(name) {
  await api('/admin/health/circuit-breakers/' + name + '/reset', { method: 'POST' });
  loadHealth();
}

// ‚îÄ‚îÄ Revenue Dashboard ‚îÄ‚îÄ
async function loadRevenue(period) {
  // Update active period button
  document.querySelectorAll('.revenue-period').forEach(btn => {
    btn.classList.toggle('active', btn.dataset.period === period);
  });
  const data = await api('/admin/revenue?period=' + period);
  if (!data) {
    document.getElementById('rev-volume').textContent = '$0';
    document.getElementById('rev-fees').textContent = '$0';
    document.getElementById('rev-count').textContent = '0';
    document.getElementById('rev-gross').textContent = '$0';
    document.getElementById('rev-discounts').textContent = '$0';
    document.getElementById('revenue-by-type').innerHTML = '<tr><td colspan="4" style="text-align:center;color:var(--text2)">No revenue data yet</td></tr>';
    return;
  }
  document.getElementById('rev-volume').textContent = '$' + Number(data.total_volume || 0).toLocaleString('en-US', { minimumFractionDigits: 2 });
  document.getElementById('rev-fees').textContent = '$' + Number(data.total_fees_net || 0).toLocaleString('en-US', { minimumFractionDigits: 2 });
  document.getElementById('rev-count').textContent = String(data.transaction_count || 0);
  document.getElementById('rev-gross').textContent = '$' + Number(data.total_fees_gross || 0).toLocaleString('en-US', { minimumFractionDigits: 2 });
  document.getElementById('rev-discounts').textContent = '$' + Number(data.total_discounts || 0).toLocaleString('en-US', { minimumFractionDigits: 2 });
  const byType = data.byType || [];
  if (byType.length === 0) {
    document.getElementById('revenue-by-type').innerHTML = '<tr><td colspan="4" style="text-align:center;color:var(--text2)">No transactions yet</td></tr>';
  } else {
    document.getElementById('revenue-by-type').innerHTML = byType.map(t => `<tr>
      <td style="text-transform:capitalize">${(t.transaction_type || '').replace(/_/g, ' ')}</td>
      <td>${t.count}</td>
      <td>$${Number(t.volume || 0).toLocaleString('en-US', { minimumFractionDigits: 2 })}</td>
      <td style="color:var(--green)">$${Number(t.fees || 0).toLocaleString('en-US', { minimumFractionDigits: 2 })}</td>
    </tr>`).join('');
  }
}

// ‚îÄ‚îÄ Agent Network ‚îÄ‚îÄ
async function loadAgentNetwork() {
  const data = await api('/admin/agents-network');
  if (!data) return;
  document.getElementById('agent-count').textContent = fmt(data.count || 0);
  document.getElementById('agent-total-float').textContent = '$' + Number(data.totalFloat || 0).toFixed(2);
  document.getElementById('agent-commissions').textContent = '$' + Number(data.totalCommissions || 0).toFixed(2);
  document.getElementById('agent-tx-today').textContent = fmt(data.transactionsToday || 0);
  if (data.agents && data.agents.length > 0) {
    document.getElementById('agent-table-body').innerHTML = data.agents.map(a =>
      `<tr><td>${a.userId}</td><td>${a.locationCity || ''}, ${a.locationCountry || ''}</td><td>$${a.floatBalance}</td><td>$${a.commissionEarned}</td><td><span class="badge ${a.status === 'active' ? 'badge-green' : a.status === 'suspended' ? 'badge-red' : 'badge-yellow'}">${a.status}</span></td></tr>`
    ).join('');
  }
}

// ‚îÄ‚îÄ Cross-Border ‚îÄ‚îÄ
async function loadCrossBorder() {
  const data = await api('/admin/cross-border');
  if (!data) return;
  document.getElementById('xborder-count').textContent = fmt(data.count || 0);
  document.getElementById('xborder-volume').textContent = '$' + Number(data.totalVolume || 0).toFixed(2);
  document.getElementById('xborder-wise').textContent = fmt(data.wiseCount || 0);
  document.getElementById('xborder-usdc').textContent = fmt(data.usdcCount || 0);
  if (data.transfers && data.transfers.length > 0) {
    document.getElementById('xborder-table-body').innerHTML = data.transfers.map(t =>
      `<tr><td style="font-family:monospace;font-size:11px">${(t.id || '').toString().slice(0,8)}</td><td><span class="badge badge-blue">${t.provider}</span></td><td>${t.sourceAmount} ${t.sourceCurrency}</td><td>${t.targetAmount || '?'} ${t.targetCurrency || ''}</td><td>${t.fxRate || '-'}</td><td><span class="badge ${t.status === 'completed' ? 'badge-green' : t.status === 'failed' ? 'badge-red' : 'badge-yellow'}">${t.status}</span></td></tr>`
    ).join('');
  }
}

// ‚îÄ‚îÄ Executive AI Board ‚îÄ‚îÄ
let execPersona = 'ceo';
let execHistory = [];
const EXEC_SUGGESTIONS = {
  ceo: ["What should our top 3 priorities be right now?", "Are we positioned to win against Cash App and Venmo?", "Should we focus on US or Africa growth first?"],
  cfo: ["Are we profitable on each transaction type after provider fees?", "What's our unit economics breakdown?", "Where is money leaking in our fee structure?"],
  analyst: ["Show me user growth trends and forecast next month", "Which transaction types are growing fastest?", "What's our daily active user trend?"],
  economist: ["How should we price cross-border vs Wise and Remitly?", "What's our FX exposure risk across corridors?", "Are our Africa fees competitive with M-Pesa and Chipper Cash?"],
  cto: ["Which tools have the highest failure rate?", "What breaks if we 10x our user base tomorrow?", "What's our infrastructure cost per transaction?"],
  growth: ["What's our referral conversion rate?", "Which feature drives the most organic signups?", "How do we get our first 1000 users?"],
};

function selectPersona(p) {
  execPersona = p;
  execHistory = [];
  document.querySelectorAll('.persona-card').forEach(c => {
    c.classList.toggle('active', c.dataset.persona === p);
    c.style.borderColor = c.dataset.persona === p ? 'var(--accent)' : 'transparent';
  });
  document.getElementById('exec-chat').innerHTML = '<div style="text-align:center;color:var(--text2);padding:40px 0;font-size:14px" id="exec-empty">Ask your ' + EXEC_SUGGESTIONS[p][0].split('?')[0] + '?</div>';
  const sugEl = document.getElementById('exec-suggestions');
  sugEl.innerHTML = (EXEC_SUGGESTIONS[p] || []).map(s =>
    `<button onclick="askSuggestion(this)" style="padding:6px 14px;background:var(--surface2);border:1px solid var(--border);border-radius:20px;color:var(--accent2);font-size:12px;cursor:pointer;font-family:inherit">${s}</button>`
  ).join('');
}

function askSuggestion(btn) {
  document.getElementById('exec-input').value = btn.textContent;
  sendExecChat();
}

function appendExecMessage(role, content) {
  const empty = document.getElementById('exec-empty');
  if (empty) empty.remove();
  const chat = document.getElementById('exec-chat');
  const div = document.createElement('div');
  div.style.cssText = role === 'user'
    ? 'text-align:right;margin:12px 0'
    : 'margin:12px 0';
  const bubble = document.createElement('div');
  bubble.style.cssText = role === 'user'
    ? 'display:inline-block;background:var(--accent);color:white;padding:10px 16px;border-radius:16px 16px 4px 16px;max-width:80%;text-align:left;font-size:14px;line-height:1.5'
    : 'background:var(--surface2);padding:14px 18px;border-radius:16px 16px 16px 4px;max-width:90%;font-size:14px;line-height:1.6;color:var(--text);white-space:pre-wrap';
  // Basic markdown: bold, headers, bullet points
  if (role === 'assistant') {
    let html = content
      .replace(/\*\*(.+?)\*\*/g, '<strong>$1</strong>')
      .replace(/^### (.+)$/gm, '<div style="font-size:15px;font-weight:700;margin:12px 0 6px">$1</div>')
      .replace(/^## (.+)$/gm, '<div style="font-size:16px;font-weight:700;margin:14px 0 8px">$1</div>')
      .replace(/^# (.+)$/gm, '<div style="font-size:18px;font-weight:700;margin:16px 0 10px">$1</div>')
      .replace(/^- (.+)$/gm, '<div style="padding-left:16px">&#8226; $1</div>')
      .replace(/\n/g, '<br>');
    bubble.innerHTML = html;
  } else {
    bubble.textContent = content;
  }
  div.appendChild(bubble);
  chat.appendChild(div);
  chat.scrollTop = chat.scrollHeight;
}

async function sendExecChat() {
  const input = document.getElementById('exec-input');
  const message = input.value.trim();
  if (!message) return;
  input.value = '';

  appendExecMessage('user', message);

  // Show thinking indicator
  const thinking = document.createElement('div');
  thinking.id = 'exec-thinking';
  thinking.style.cssText = 'margin:12px 0;color:var(--text2);font-size:13px';
  thinking.innerHTML = '&#9881; ' + (EXEC_SUGGESTIONS[execPersona] ? execPersona.toUpperCase() : 'AI') + ' is analyzing platform data...';
  document.getElementById('exec-chat').appendChild(thinking);

  const btn = document.getElementById('exec-send-btn');
  btn.disabled = true;
  btn.textContent = '...';

  try {
    const data = await api('/admin/executive/chat', {
      method: 'POST',
      body: JSON.stringify({ persona: execPersona, message, history: execHistory }),
    });
    document.getElementById('exec-thinking')?.remove();
    if (data && data.response) {
      appendExecMessage('assistant', data.response);
      execHistory.push({ role: 'user', content: message });
      execHistory.push({ role: 'assistant', content: data.response });
      if (execHistory.length > 20) execHistory = execHistory.slice(-20);
    } else if (data && data.error) {
      appendExecMessage('assistant', 'Error: ' + data.error);
    }
  } catch(e) {
    document.getElementById('exec-thinking')?.remove();
    appendExecMessage('assistant', 'Connection error. Check that the server is running.');
  }
  btn.disabled = false;
  btn.textContent = 'Send';
}

async function loadExecutive() {
  selectPersona(execPersona);
  // Load live context
  const ctx = await api('/admin/executive/context');
  if (ctx) {
    document.getElementById('exec-context').textContent = JSON.stringify(ctx, null, 2);
  }
}

// ‚îÄ‚îÄ Page router ‚îÄ‚îÄ
// ‚îÄ‚îÄ POS Revenue ‚îÄ‚îÄ
let posRevenueData = null;

function fmtNaira(n) {
  return '\u20A6' + Number(n || 0).toLocaleString('en-NG', { maximumFractionDigits: 0 });
}

async function loadPosRevenue() {
  const data = await api('/admin/pos/revenue');
  if (!data) return;
  posRevenueData = data;

  // Platform fee input
  document.getElementById('pos-fee-input').value = data.currentPlatformFeePct ?? 1;

  // All-time stats
  document.getElementById('pos-r-fundings').textContent = fmtNaira(data.allTime.walletFundings);
  document.getElementById('pos-r-funding-count').textContent = fmt(data.allTime.fundingCount) + ' deposits';
  document.getElementById('pos-r-reloadly').textContent = fmtNaira(data.allTime.reloadlySpend);
  document.getElementById('pos-r-gross').textContent = fmtNaira(data.allTime.grossProfit);
  document.getElementById('pos-r-fees').textContent = fmtNaira(data.allTime.platformFees);

  // Default period: today
  showPosPeriod('today', document.querySelector('.pos-period-btn.active'));

  // Agents
  document.getElementById('pos-agent-count').textContent = `${data.agents.active} active / ${data.agents.total} total`;
  const tbody = document.getElementById('pos-agents-tbody');
  if (data.agents.top && data.agents.top.length > 0) {
    tbody.innerHTML = data.agents.top.map(a =>
      `<tr style="border-bottom:1px solid var(--border)">
        <td style="padding:10px 8px"><strong>${a.display_name || a.email || a.agent_user_id}</strong></td>
        <td style="padding:10px 8px">${fmt(a.sales)}</td>
        <td style="padding:10px 8px">${fmtNaira(a.volume)}</td>
        <td style="padding:10px 8px;color:var(--success)">${fmtNaira(a.feesGenerated)}</td>
      </tr>`
    ).join('');
  } else {
    tbody.innerHTML = '<tr><td colspan="4" style="padding:20px;text-align:center;color:var(--text2)">No agent sales yet</td></tr>';
  }
}

function showPosPeriod(period, btn) {
  if (!posRevenueData) return;
  document.querySelectorAll('.pos-period-btn').forEach(b => b.classList.remove('active'));
  if (btn) btn.classList.add('active');

  const d = posRevenueData[period] || {};
  document.getElementById('pos-p-fundings').textContent = fmtNaira(d.fundings);
  document.getElementById('pos-p-txns').textContent = fmt(d.transactions || 0);
  document.getElementById('pos-p-volume').textContent = fmtNaira(d.volume);
  document.getElementById('pos-p-profit').textContent = fmtNaira(d.profit);
}

async function savePlatformFee() {
  const val = parseFloat(document.getElementById('pos-fee-input').value);
  if (isNaN(val) || val < 0 || val > 25) {
    document.getElementById('pos-fee-status').textContent = 'Must be 0-25%';
    document.getElementById('pos-fee-status').style.color = 'var(--danger)';
    return;
  }
  const data = await api('/admin/pos/settings', {
    method: 'POST',
    body: JSON.stringify({ platformFeePct: val }),
  });
  if (data && data.success) {
    document.getElementById('pos-fee-status').textContent = 'Saved!';
    document.getElementById('pos-fee-status').style.color = 'var(--success)';
    setTimeout(() => { document.getElementById('pos-fee-status').textContent = ''; }, 3000);
  } else {
    document.getElementById('pos-fee-status').textContent = 'Error saving';
    document.getElementById('pos-fee-status').style.color = 'var(--danger)';
  }
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// POS AGENTS MANAGEMENT
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
async function loadPosAgentsMgmt() {
  // Load stats
  const stats = await api('/pos/stats');
  if (stats) {
    document.getElementById('pa-total').textContent = fmt(stats.total);
    document.getElementById('pa-active').textContent = fmt(stats.active);
    document.getElementById('pa-suspended').textContent = fmt(stats.suspended);
    document.getElementById('pa-pending-limits').textContent = fmt(stats.pendingRequests);
    document.getElementById('pa-volume').textContent = '\u20A6' + fmt(stats.totalVolume);
    document.getElementById('pa-txns').textContent = fmt(stats.totalTransactions);
    document.getElementById('pa-rating').textContent = stats.avgRating || '5.0';

    // Tier breakdown
    const tiers = { starter: '#6366f1', verified: '#22c55e', trusted: '#a855f7', premium: '#eab308' };
    const bd = stats.tierBreakdown || {};
    document.getElementById('pa-tier-breakdown').innerHTML = Object.entries(tiers).map(([t, c]) =>
      `<div style="display:flex;align-items:center;gap:8px;padding:10px 16px;border-radius:10px;background:${c}18;border:1px solid ${c}30">
        <div style="width:10px;height:10px;border-radius:50%;background:${c}"></div>
        <span style="font-weight:600;text-transform:capitalize">${t}</span>
        <span style="font-weight:800;font-size:18px;margin-left:4px">${bd[t] || 0}</span>
      </div>`
    ).join('');
  }

  // Load pending limit requests
  loadPosLimitRequests();
  // Load agents list
  loadPosAgentsList();
}

async function loadPosLimitRequests() {
  const data = await api('/pos/admin/limit-requests?status=pending');
  if (!data) return;
  const tbody = document.getElementById('pa-limit-tbody');
  if (!data.requests || data.requests.length === 0) {
    tbody.innerHTML = '<tr><td colspan="8" style="color:var(--text2);text-align:center">No pending requests</td></tr>';
    document.getElementById('pa-limit-requests-card').style.display = data.requests?.length ? 'block' : 'block';
    return;
  }
  tbody.innerHTML = data.requests.map(r => `<tr>
    <td><strong>${r.display_name || 'Agent'}</strong></td>
    <td style="font-family:monospace;font-size:12px">${r.agent_code}</td>
    <td><span class="badge badge-purple" style="text-transform:capitalize">${r.tier}</span></td>
    <td>\u20A6${fmt(r.current_limit)}</td>
    <td style="font-weight:700;color:var(--success)">\u20A6${fmt(r.requested_limit)}</td>
    <td>${fmt(r.total_transactions)}</td>
    <td>\u2B50 ${(r.rating || 5).toFixed(1)}</td>
    <td>
      <button class="btn-sm" style="background:var(--success);color:#fff;border:none;border-radius:6px;padding:5px 12px;font-size:11px;cursor:pointer;font-weight:600" onclick="approveLimitRequest('${r.id}', ${r.requested_limit})">Approve</button>
      <button class="btn-sm" style="background:var(--danger);color:#fff;border:none;border-radius:6px;padding:5px 12px;font-size:11px;cursor:pointer;font-weight:600;margin-left:4px" onclick="denyLimitRequest('${r.id}')">Deny</button>
    </td>
  </tr>`).join('');
}

async function approveLimitRequest(id, limit) {
  const res = await api('/pos/limit-requests/' + id + '/approve', {
    method: 'PUT', headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({ approvedLimit: limit }),
  });
  if (res) { loadPosLimitRequests(); loadPosAgentsMgmt(); }
}

async function denyLimitRequest(id) {
  if (!confirm('Deny this limit request?')) return;
  const res = await api('/pos/limit-requests/' + id + '/deny', { method: 'PUT' });
  if (res) { loadPosLimitRequests(); loadPosAgentsMgmt(); }
}

async function loadPosAgentsList() {
  const status = document.getElementById('pa-status-filter')?.value || '';
  const search = document.getElementById('pa-search')?.value || '';
  const params = new URLSearchParams({ limit: '50' });
  if (status) params.set('status', status);
  if (search) params.set('search', search);

  const data = await api('/pos/agents?' + params.toString());
  if (!data) return;
  const tbody = document.getElementById('pa-agents-tbody');
  if (!data.agents || data.agents.length === 0) {
    tbody.innerHTML = '<tr><td colspan="10" style="color:var(--text2);text-align:center">No agents found</td></tr>';
    return;
  }
  const tierColors = { starter: '#6366f1', verified: '#22c55e', trusted: '#a855f7', premium: '#eab308' };
  tbody.innerHTML = data.agents.map(a => {
    const tc = tierColors[a.tier] || '#6366f1';
    const statusBadge = a.status === 'active' ? 'badge-green' : a.status === 'suspended' ? 'badge-red' : 'badge-yellow';
    return `<tr>
      <td><strong>${a.display_name}</strong></td>
      <td style="font-family:monospace;font-size:12px">${a.agent_code}</td>
      <td style="font-size:12px">${a.email || '‚Äî'}</td>
      <td><span style="padding:2px 8px;border-radius:8px;font-size:10px;font-weight:700;background:${tc}18;color:${tc};text-transform:uppercase">${a.tier}</span></td>
      <td>\u20A6${fmt(a.daily_limit)}</td>
      <td>\u20A6${fmt(a.total_volume)}</td>
      <td>${fmt(a.total_transactions)}</td>
      <td>\u2B50 ${(a.rating || 5).toFixed(1)}</td>
      <td><span class="badge ${statusBadge}">${a.status}</span></td>
      <td>
        ${a.status === 'active' ?
          `<button class="btn-sm" style="background:rgba(239,68,68,0.1);color:var(--danger);border:1px solid rgba(239,68,68,0.2);border-radius:6px;padding:4px 10px;font-size:10px;cursor:pointer;font-weight:600" onclick="suspendPosAgent('${a.id}')">Suspend</button>` :
          `<button class="btn-sm" style="background:rgba(34,197,94,0.1);color:var(--success);border:1px solid rgba(34,197,94,0.2);border-radius:6px;padding:4px 10px;font-size:10px;cursor:pointer;font-weight:600" onclick="activatePosAgent('${a.id}')">Activate</button>`}
      </td>
    </tr>`;
  }).join('');
}

async function suspendPosAgent(id) {
  const reason = prompt('Reason for suspension (optional):');
  if (reason === null) return;
  await api('/pos/agents/' + id + '/suspend', {
    method: 'PUT', headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({ reason }),
  });
  loadPosAgentsList();
  loadPosAgentsMgmt();
}

async function activatePosAgent(id) {
  await api('/pos/agents/' + id + '/activate', { method: 'PUT' });
  loadPosAgentsList();
  loadPosAgentsMgmt();
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// POS AGENT REFERRALS & BONUSES
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
async function loadPosReferrals() {
  const data = await api('/pos/referral-stats');
  if (!data) return;

  document.getElementById('pr-total-referrals').textContent = fmt(data.totalReferrals);
  document.getElementById('pr-active-referred').textContent = fmt(data.activeReferred);
  document.getElementById('pr-bonuses-paid').textContent = '\u20A6' + fmt(data.bonusesPaid);
  document.getElementById('pr-bonuses-pending').textContent = '\u20A6' + fmt(data.bonusesPending);

  // Top referrers
  const topTbody = document.getElementById('pr-top-referrers');
  if (data.topReferrers && data.topReferrers.length > 0) {
    topTbody.innerHTML = data.topReferrers.map((r, i) => `<tr>
      <td style="font-weight:700;color:${i < 3 ? 'var(--yellow)' : 'var(--text2)'}">${i + 1}</td>
      <td><strong>${r.display_name}</strong></td>
      <td style="font-family:monospace;font-size:12px">${r.agent_code}</td>
      <td style="font-weight:700">${r.referral_count}</td>
      <td>${r.active_count}</td>
      <td style="color:var(--success)">\u20A6${fmt(r.total_bonuses)}</td>
      <td><span class="badge badge-green">${r.status}</span></td>
    </tr>`).join('');
  } else {
    topTbody.innerHTML = '<tr><td colspan="7" style="color:var(--text2);text-align:center">No referrals yet</td></tr>';
  }

  // Recent events
  const eventsTbody = document.getElementById('pr-events-tbody');
  if (data.recentEvents && data.recentEvents.length > 0) {
    eventsTbody.innerHTML = data.recentEvents.map(e => {
      const statusBadge = e.status === 'credited' ? 'badge-green' : e.status === 'pending' ? 'badge-yellow' : 'badge-red';
      const milestoneLabels = { signup: 'Sign-up', first_sale: 'First Sale', '10_sales': '10 Sales', '50_sales': '50 Sales', commission: 'Commission' };
      return `<tr>
        <td style="font-size:12px">${new Date(e.created_at).toLocaleDateString()}</td>
        <td>${e.referrer_name || e.referrer_code}</td>
        <td>${e.referred_name || e.referred_code}</td>
        <td>${milestoneLabels[e.milestone] || e.milestone}</td>
        <td style="color:var(--success);font-weight:600">\u20A6${fmt(e.bonus_amount)}</td>
        <td><span class="badge ${statusBadge}">${e.status}</span></td>
      </tr>`;
    }).join('');
  } else {
    eventsTbody.innerHTML = '<tr><td colspan="6" style="color:var(--text2);text-align:center">No referral events yet</td></tr>';
  }
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// HR & HIRING
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
const stageColors = { applied: '#3b82f6', screening: '#eab308', interview: '#a855f7', assessment: '#f97316', offer: '#22c55e', hired: '#10b981', rejected: '#ef4444' };
const stageLabels = { applied: 'Applied', screening: 'Screening', interview: 'Interview', assessment: 'Assessment', offer: 'Offer', hired: 'Hired', rejected: 'Rejected' };

async function loadHrDashboard() {
  const data = await api('/hr/stats');
  if (!data) return;

  document.getElementById('hr-open').textContent = fmt(data.openPositions);
  document.getElementById('hr-total-apps').textContent = fmt(data.totalApplications);
  document.getElementById('hr-new-week').textContent = fmt(data.newThisWeek);
  document.getElementById('hr-pipeline').textContent = fmt(data.inPipeline);
  document.getElementById('hr-hired').textContent = fmt(data.hired);

  // Pipeline stages
  const stagesEl = document.getElementById('hr-pipeline-stages');
  stagesEl.innerHTML = (data.pipeline || []).map(s => {
    const c = stageColors[s.stage] || '#6366f1';
    return `<div style="flex:1;min-width:100px;padding:14px;border-radius:10px;text-align:center;background:${c}12;border:1px solid ${c}25">
      <div style="font-size:24px;font-weight:800;color:${c}">${s.count}</div>
      <div style="font-size:10px;color:var(--text2);text-transform:uppercase;letter-spacing:0.5px;margin-top:2px">${stageLabels[s.stage] || s.stage}</div>
    </div>`;
  }).join('') || '<div style="color:var(--text3);font-size:13px;padding:10px">No active applications</div>';

  // By department
  const deptTbody = document.getElementById('hr-dept-tbody');
  deptTbody.innerHTML = (data.byDepartment || []).map(d =>
    `<tr><td><strong>${d.department}</strong></td><td>${d.applications}</td><td>${d.active}</td></tr>`
  ).join('') || '<tr><td colspan="3" style="color:var(--text2);text-align:center">No data</td></tr>';

  // Interviews
  const intTbody = document.getElementById('hr-interviews-tbody');
  intTbody.innerHTML = (data.interviews || []).map(i => {
    const dt = new Date(i.scheduled_at);
    return `<tr>
      <td><strong>${i.full_name}</strong></td>
      <td>${i.job_title}</td>
      <td style="text-transform:capitalize">${i.interview_type}</td>
      <td>${dt.toLocaleDateString()} ${dt.toLocaleTimeString([], {hour:'2-digit',minute:'2-digit'})}</td>
      <td>${i.interviewer || '‚Äî'}</td>
    </tr>`;
  }).join('') || '<tr><td colspan="5" style="color:var(--text2);text-align:center">No upcoming interviews</td></tr>';

  // Recent apps
  renderHrApplications(data.recent || []);
}

function renderHrApplications(apps) {
  const tbody = document.getElementById('hr-apps-tbody');
  if (!apps.length) {
    tbody.innerHTML = '<tr><td colspan="7" style="color:var(--text2);text-align:center">No applications</td></tr>';
    return;
  }
  tbody.innerHTML = apps.map(a => {
    const sc = stageColors[a.stage] || '#6366f1';
    const stars = a.rating ? '\u2B50'.repeat(Math.min(a.rating, 5)) : '<span style="color:var(--text3)">‚Äî</span>';
    return `<tr>
      <td><strong>${a.full_name}</strong><br><span style="font-size:10px;color:var(--text3)">${a.email}</span></td>
      <td>${a.job_title}</td>
      <td>${a.department}</td>
      <td>${stars}</td>
      <td><span style="padding:3px 10px;border-radius:8px;font-size:10px;font-weight:700;background:${sc}18;color:${sc}">${stageLabels[a.stage] || a.stage}</span></td>
      <td style="font-size:11px">${new Date(a.created_at).toLocaleDateString()}</td>
      <td>
        <select onchange="moveAppStage('${a.id}',this.value)" style="padding:4px 8px;border-radius:6px;border:1px solid var(--border);background:var(--surface2);color:var(--text);font-size:10px">
          ${Object.entries(stageLabels).map(([k,v]) => `<option value="${k}" ${k===a.stage?'selected':''}>${v}</option>`).join('')}
        </select>
      </td>
    </tr>`;
  }).join('');
}

async function filterHrApplications() {
  const stage = document.getElementById('hr-stage-filter')?.value || '';
  const search = document.getElementById('hr-search')?.value || '';
  const params = new URLSearchParams({ limit: '50' });
  if (stage) params.set('stage', stage);
  if (search) params.set('search', search);
  const data = await api('/hr/applications?' + params.toString());
  if (data) renderHrApplications(data.applications || []);
}

async function moveAppStage(appId, stage) {
  let reason = null;
  if (stage === 'rejected') { reason = prompt('Rejection reason (optional):'); if (reason === null) return; }
  await api('/hr/applications/' + appId + '/stage', {
    method: 'PUT', headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({ stage, rejectionReason: reason }),
  });
  loadHrDashboard();
}

// ‚îÄ‚îÄ Job Listings CRUD ‚îÄ‚îÄ
async function loadHrJobs() {
  const data = await api('/hr/jobs');
  if (!data) return;
  const tbody = document.getElementById('hr-jobs-tbody');
  if (!data.jobs || data.jobs.length === 0) {
    tbody.innerHTML = '<tr><td colspan="9" style="color:var(--text2);text-align:center">No job listings. Click "+ Create Listing" to add one.</td></tr>';
    return;
  }
  tbody.innerHTML = data.jobs.map(j => {
    const statusBadge = j.status === 'published' ? 'badge-green' : j.status === 'draft' ? 'badge-yellow' : j.status === 'closed' ? 'badge-red' : 'badge-blue';
    const salary = j.salary_min ? `${j.salary_currency} ${Number(j.salary_min).toLocaleString()}${j.salary_max ? '-' + Number(j.salary_max).toLocaleString() : '+'}` : '‚Äî';
    return `<tr>
      <td><strong>${j.title}</strong></td>
      <td>${j.department}</td>
      <td>${j.type}</td>
      <td>${j.location}${j.remote_ok ? ' (R)' : ''}</td>
      <td style="font-size:12px">${salary}</td>
      <td>${j.applications_count || 0}</td>
      <td>${j.hired_count || 0}/${j.positions}</td>
      <td><span class="badge ${statusBadge}">${j.status}</span></td>
      <td style="white-space:nowrap">
        ${j.status === 'draft' ? `<button onclick="publishJob('${j.id}')" style="padding:4px 10px;border-radius:6px;border:none;background:rgba(34,197,94,0.12);color:var(--success);font-size:10px;font-weight:600;cursor:pointer">Publish</button>` : ''}
        ${j.status === 'published' ? `<button onclick="closeJob('${j.id}')" style="padding:4px 10px;border-radius:6px;border:none;background:rgba(239,68,68,0.12);color:var(--danger);font-size:10px;font-weight:600;cursor:pointer">Close</button>` : ''}
        ${j.status === 'closed' ? `<button onclick="publishJob('${j.id}')" style="padding:4px 10px;border-radius:6px;border:none;background:rgba(34,197,94,0.12);color:var(--success);font-size:10px;font-weight:600;cursor:pointer">Reopen</button>` : ''}
      </td>
    </tr>`;
  }).join('');
}

async function publishJob(id) {
  await api('/hr/jobs/' + id + '/status', { method: 'PUT', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ status: 'published' }) });
  loadHrJobs();
}
async function closeJob(id) {
  await api('/hr/jobs/' + id + '/status', { method: 'PUT', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ status: 'closed' }) });
  loadHrJobs();
}

function showCreateJobModal() {
  const depts = ['Engineering', 'Operations', 'Sales', 'Marketing', 'Customer Support', 'Compliance', 'Finance', 'POS Network', 'HR'];
  const modal = document.getElementById('creds-modal');
  document.getElementById('creds-content').innerHTML = `
    <div style="margin-bottom:14px"><label style="display:block;font-size:11px;color:var(--text2);margin-bottom:4px">Job Title *</label><input id="jf-title" placeholder="e.g. Backend Engineer" style="width:100%;padding:10px;border-radius:8px;border:1px solid var(--border);background:var(--surface2);color:var(--text);font-size:14px"></div>
    <div style="display:flex;gap:10px;margin-bottom:14px">
      <div style="flex:1"><label style="display:block;font-size:11px;color:var(--text2);margin-bottom:4px">Department *</label><select id="jf-dept" style="width:100%;padding:10px;border-radius:8px;border:1px solid var(--border);background:var(--surface2);color:var(--text);font-size:13px">${depts.map(d=>`<option>${d}</option>`).join('')}</select></div>
      <div style="flex:1"><label style="display:block;font-size:11px;color:var(--text2);margin-bottom:4px">Type</label><select id="jf-type" style="width:100%;padding:10px;border-radius:8px;border:1px solid var(--border);background:var(--surface2);color:var(--text);font-size:13px"><option>full-time</option><option>part-time</option><option>contract</option><option>internship</option></select></div>
    </div>
    <div style="display:flex;gap:10px;margin-bottom:14px">
      <div style="flex:1"><label style="display:block;font-size:11px;color:var(--text2);margin-bottom:4px">Location</label><input id="jf-loc" value="Lagos, Nigeria" style="width:100%;padding:10px;border-radius:8px;border:1px solid var(--border);background:var(--surface2);color:var(--text);font-size:13px"></div>
      <div style="flex:1"><label style="display:block;font-size:11px;color:var(--text2);margin-bottom:4px">Positions</label><input id="jf-pos" type="number" value="1" min="1" style="width:100%;padding:10px;border-radius:8px;border:1px solid var(--border);background:var(--surface2);color:var(--text);font-size:13px"></div>
    </div>
    <div style="display:flex;gap:10px;margin-bottom:14px">
      <div style="flex:1"><label style="display:block;font-size:11px;color:var(--text2);margin-bottom:4px">Salary Min (NGN/month)</label><input id="jf-sal-min" type="number" placeholder="300000" style="width:100%;padding:10px;border-radius:8px;border:1px solid var(--border);background:var(--surface2);color:var(--text);font-size:13px"></div>
      <div style="flex:1"><label style="display:block;font-size:11px;color:var(--text2);margin-bottom:4px">Salary Max</label><input id="jf-sal-max" type="number" placeholder="600000" style="width:100%;padding:10px;border-radius:8px;border:1px solid var(--border);background:var(--surface2);color:var(--text);font-size:13px"></div>
    </div>
    <div style="display:flex;gap:10px;margin-bottom:14px">
      <div style="flex:1"><label style="display:block;font-size:11px;color:var(--text2);margin-bottom:4px">Priority</label><select id="jf-priority" style="width:100%;padding:10px;border-radius:8px;border:1px solid var(--border);background:var(--surface2);color:var(--text);font-size:13px"><option value="normal">Normal</option><option value="high">High</option><option value="urgent">Urgent</option></select></div>
      <div style="flex:1;display:flex;align-items:end;padding-bottom:4px"><label style="display:flex;align-items:center;gap:6px;font-size:12px;cursor:pointer"><input type="checkbox" id="jf-remote"> Remote OK</label></div>
    </div>
    <div style="margin-bottom:14px"><label style="display:block;font-size:11px;color:var(--text2);margin-bottom:4px">Description *</label><textarea id="jf-desc" rows="4" placeholder="Describe the role, responsibilities, and what a typical day looks like..." style="width:100%;padding:10px;border-radius:8px;border:1px solid var(--border);background:var(--surface2);color:var(--text);font-size:13px;font-family:inherit;resize:vertical"></textarea></div>
    <div id="jf-error" style="color:var(--danger);font-size:12px;margin-bottom:8px"></div>
    <div style="display:flex;gap:10px">
      <button onclick="createJobListing('draft')" style="flex:1;padding:12px;border-radius:8px;border:1px solid var(--border);background:var(--surface2);color:var(--text);font-size:13px;font-weight:600;cursor:pointer">Save as Draft</button>
      <button onclick="createJobListing('published')" style="flex:1;padding:12px;border-radius:8px;border:none;background:var(--accent);color:#fff;font-size:13px;font-weight:600;cursor:pointer">Publish Now</button>
    </div>
  `;
  document.querySelector('#creds-modal h3').textContent = 'Create Job Listing';
  modal.classList.remove('hidden');
}

async function createJobListing(publishStatus) {
  const title = document.getElementById('jf-title').value.trim();
  const description = document.getElementById('jf-desc').value.trim();
  const errEl = document.getElementById('jf-error');
  if (!title || !description) { errEl.textContent = 'Title and description are required'; return; }

  const res = await api('/hr/jobs', {
    method: 'POST', headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({
      title, description,
      department: document.getElementById('jf-dept').value,
      type: document.getElementById('jf-type').value,
      location: document.getElementById('jf-loc').value.trim(),
      positions: parseInt(document.getElementById('jf-pos').value) || 1,
      salaryMin: parseFloat(document.getElementById('jf-sal-min').value) || null,
      salaryMax: parseFloat(document.getElementById('jf-sal-max').value) || null,
      salaryCurrency: 'NGN',
      priority: document.getElementById('jf-priority').value,
      remoteOk: document.getElementById('jf-remote').checked,
    }),
  });

  if (res && res.id && publishStatus === 'published') {
    await api('/hr/jobs/' + res.id + '/status', { method: 'PUT', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ status: 'published' }) });
  }

  closeCredsModal();
  loadHrJobs();
}

function loadPage(page) {
  const loaders = {
    dashboard: loadDashboard, agents: loadAgents, tasks: loadTasks,
    streaks: loadStreaks, cashback: loadCashback, referrals: loadReferrals,
    achievements: loadAchievements, loyalty: loadLoyalty, insights: loadInsights,
    partners: loadPartners, revenue: () => loadRevenue('today'),
    providers: loadProviders, audit: loadAudit, health: loadHealth,
    'agents-network': loadAgentNetwork, 'cross-border': loadCrossBorder,
    'pos-revenue': loadPosRevenue, executive: loadExecutive,
    'pos-agents': loadPosAgentsMgmt, 'pos-referrals': loadPosReferrals,
    'hr-dashboard': loadHrDashboard, 'hr-jobs': loadHrJobs,
    'strategy-bootstrap': () => {}, // Static page, no API calls needed
    'calendar': loadChronoDashboard, 'calendar-todos': loadTodoList, 'calendar-events': loadCalendarEvents,
    'analytics': loadAnalyticsDashboard,
  };
  if (loaders[page]) loaders[page]();
}

// ‚îÄ‚îÄ WebSocket ‚îÄ‚îÄ
function connectWs() {
  try {
    const protocol = location.protocol === 'https:' ? 'wss:' : 'ws:';
    ws = new WebSocket(`${protocol}//${location.host}/ws`);
    ws.onopen = () => {
      document.getElementById('ws-indicator').className = 'ws-dot ws-connected';
      document.getElementById('ws-status').textContent = 'Live';
    };
    ws.onclose = () => {
      document.getElementById('ws-indicator').className = 'ws-dot ws-disconnected';
      document.getElementById('ws-status').textContent = 'Disconnected';
      setTimeout(connectWs, 3000);
    };
    ws.onmessage = (e) => {
      try {
        const msg = JSON.parse(e.data);
        if (msg.type === 'task:result') loadDashboard();
      } catch(err) {}
    };
  } catch(e) {
    setTimeout(connectWs, 3000);
  }
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// CHRONO ‚Äî Calendar AI Agent
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

let chronoEventSource = null;
const priorityColors = { urgent: '#ef4444', high: '#f97316', medium: '#eab308', low: '#22c55e' };
const priorityIcons = { urgent: 'üî¥', high: 'üü†', medium: 'üü°', low: 'üü¢' };
const categoryIcons = { business: 'üíº', hiring: 'üë•', finance: 'üí∞', marketing: 'üì¢', product: 'üõ†Ô∏è', operations: '‚öôÔ∏è', personal: 'üè†', meeting: 'üìÖ', call: 'üìû', email: '‚úâÔ∏è', review: 'üîç', deadline: '‚è∞', followup: 'üîÑ', strategy: 'üéØ', general: 'üìå' };

function updateChronoStats(stats) {
  const el = (id) => document.getElementById(id);
  if (el('chrono-pending')) el('chrono-pending').textContent = fmt(stats.pending);
  if (el('chrono-due-today')) el('chrono-due-today').textContent = stats.dueToday + ' due today';
  if (el('chrono-completed-today')) el('chrono-completed-today').textContent = fmt(stats.completedToday);
  if (el('chrono-week-total')) el('chrono-week-total').textContent = stats.completedThisWeek + ' this week';
  if (el('chrono-overdue')) el('chrono-overdue').textContent = fmt(stats.overdue);
  if (el('chrono-high-priority')) el('chrono-high-priority').textContent = stats.highPriority + ' high priority';
  if (el('chrono-percent')) el('chrono-percent').textContent = stats.percent + '%';
  if (el('chrono-total-all')) el('chrono-total-all').textContent = stats.totalCompleted + ' lifetime completed';
  if (el('chrono-streak-badge')) el('chrono-streak-badge').textContent = 'üî• ' + stats.streak + '-day streak';
}

function renderMotivation(messages) {
  const container = document.getElementById('chrono-motivation-messages');
  if (!container || !messages || messages.length === 0) return;
  container.innerHTML = messages.map((m, i) => `
    <div style="padding:6px 0;${i > 0 ? 'border-top:1px solid rgba(255,255,255,0.04);' : ''}opacity:${1 - i*0.08}">
      ${m}
    </div>
  `).join('');
}

function startChronoStream() {
  if (chronoEventSource) { chronoEventSource.close(); }
  const token = getToken();
  if (!token) return;

  // SSE with auth via query param (EventSource doesn't support headers)
  chronoEventSource = new EventSource(API + '/api/calendar/stream?token=' + encodeURIComponent(token));

  const statusEl = document.getElementById('chrono-stream-status');

  chronoEventSource.onopen = () => {
    if (statusEl) statusEl.innerHTML = '<span style="width:8px;height:8px;border-radius:50%;background:currentColor;animation:pulse 2s infinite"></span> Live';
    if (statusEl) { statusEl.style.background = 'rgba(34,197,94,0.12)'; statusEl.style.color = '#22c55e'; }
  };

  chronoEventSource.onmessage = (e) => {
    try {
      const data = JSON.parse(e.data);
      if (data.type === 'init') {
        updateChronoStats(data.stats);
        renderMotivation(data.motivations);
        loadTodayFocus();
      } else if (data.type === 'heartbeat') {
        updateChronoStats(data.stats);
      } else if (data.type === 'reminder' || data.type === 'event_reminder') {
        appendReminder(data.message, data.type);
        loadTodayFocus();
      } else if (data.type === 'motivation') {
        appendMotivation(data.message);
      } else if (data.type === 'unread_reminders') {
        const feed = document.getElementById('chrono-reminders-feed');
        if (feed && data.reminders) {
          feed.innerHTML = data.reminders.map(r => `
            <div style="padding:8px 12px;border-radius:8px;background:var(--surface2);margin-bottom:6px;border-left:3px solid ${r.message_type === 'motivation' ? 'var(--accent)' : 'var(--yellow)'}">
              <div style="font-size:12px">${r.message}</div>
              <div style="font-size:10px;color:var(--text2);margin-top:4px">${new Date(r.created_at).toLocaleString()}</div>
            </div>
          `).join('');
          const badge = document.getElementById('chrono-unread-badge');
          if (badge) { badge.textContent = data.reminders.length; badge.style.display = data.reminders.length > 0 ? 'inline' : 'none'; }
        }
      }
    } catch(err) { console.error('Chrono stream error:', err); }
  };

  chronoEventSource.onerror = () => {
    if (statusEl) statusEl.innerHTML = '<span style="width:8px;height:8px;border-radius:50%;background:currentColor"></span> Reconnecting...';
    if (statusEl) { statusEl.style.background = 'rgba(234,179,8,0.12)'; statusEl.style.color = '#eab308'; }
  };
}

function appendReminder(message, type) {
  const feed = document.getElementById('chrono-reminders-feed');
  if (!feed) return;
  const placeholder = feed.querySelector('[style*="text-align:center"]');
  if (placeholder) feed.innerHTML = '';
  const div = document.createElement('div');
  div.style.cssText = 'padding:8px 12px;border-radius:8px;background:var(--surface2);margin-bottom:6px;border-left:3px solid ' + (type === 'event_reminder' ? 'var(--accent)' : 'var(--yellow)') + ';animation:fadeIn 0.3s ease';
  div.innerHTML = `<div style="font-size:12px">${message}</div><div style="font-size:10px;color:var(--text2);margin-top:4px">${new Date().toLocaleString()}</div>`;
  feed.prepend(div);
}

function appendMotivation(message) {
  const container = document.getElementById('chrono-motivation-messages');
  if (!container) return;
  const div = document.createElement('div');
  div.style.cssText = 'padding:6px 0;border-top:1px solid rgba(255,255,255,0.04);animation:fadeIn 0.5s ease';
  div.innerHTML = `<span style="opacity:0.6;font-size:10px;margin-right:6px">${new Date().toLocaleTimeString()}</span> ${message}`;
  container.prepend(div);
}

async function loadChronoDashboard() {
  startChronoStream();
  loadTodayFocus();
  // Also fetch motivation via API as fallback
  const data = await api('/calendar/motivation');
  if (data) {
    updateChronoStats(data.stats);
    renderMotivation(data.messages);
  }
}

async function loadTodayFocus() {
  const data = await api('/calendar/todos?status=pending');
  if (!data || !data.todos) return;
  const today = new Date().toISOString().slice(0, 10);
  const todayTasks = data.todos.filter(t => t.due_date === today || t.priority === 'urgent' || t.priority === 'high');
  const container = document.getElementById('chrono-today-list');
  if (!container) return;

  if (todayTasks.length === 0) {
    container.innerHTML = '<div style="color:var(--text2);text-align:center;padding:20px">No urgent tasks for today. Nice! üéâ</div>';
    return;
  }

  container.innerHTML = todayTasks.slice(0, 10).map(t => `
    <div style="display:flex;align-items:center;gap:10px;padding:8px 10px;border-radius:8px;background:var(--surface2);margin-bottom:6px;border-left:3px solid ${priorityColors[t.priority] || '#eab308'}">
      <input type="checkbox" onchange="chronoToggleTodo('${t.id}', this.checked)" style="width:16px;height:16px;cursor:pointer;accent-color:var(--accent)">
      <div style="flex:1;min-width:0">
        <div style="font-size:12px;font-weight:600;white-space:nowrap;overflow:hidden;text-overflow:ellipsis">${categoryIcons[t.category] || 'üìå'} ${t.title}</div>
        <div style="font-size:10px;color:var(--text2)">${t.due_time || ''} ${t.due_date === today ? '‚Ä¢ Today' : t.due_date ? '‚Ä¢ ' + t.due_date : ''}</div>
      </div>
      <span style="font-size:9px;padding:2px 6px;border-radius:6px;font-weight:700;background:${priorityColors[t.priority]}18;color:${priorityColors[t.priority]}">${t.priority.toUpperCase()}</span>
    </div>
  `).join('');
}

async function chronoQuickAdd() {
  const title = document.getElementById('chrono-quick-title').value.trim();
  if (!title) return;
  const priority = document.getElementById('chrono-quick-priority').value;
  const category = document.getElementById('chrono-quick-category').value;
  const dueDate = document.getElementById('chrono-quick-due').value;

  const data = await api('/calendar/todos', {
    method: 'POST', body: { title, priority, category, dueDate: dueDate || null }
  });
  if (data) {
    document.getElementById('chrono-quick-title').value = '';
    document.getElementById('chrono-quick-due').value = '';
    loadTodayFocus();
    const motiv = await api('/calendar/motivation');
    if (motiv) updateChronoStats(motiv.stats);
    if (data.message) appendMotivation(data.message);
  }
}

async function chronoToggleTodo(id, completed) {
  const data = await api('/calendar/todos/' + id, {
    method: 'PUT', body: { status: completed ? 'completed' : 'pending' }
  });
  if (data && data.message) appendMotivation(data.message);
  loadTodayFocus();
  const motiv = await api('/calendar/motivation');
  if (motiv) updateChronoStats(motiv.stats);
}

async function refreshMotivation() {
  const data = await api('/calendar/motivation');
  if (data) {
    renderMotivation(data.messages);
    updateChronoStats(data.stats);
  }
}

// ‚îÄ‚îÄ To-Do List Page ‚îÄ‚îÄ
async function loadTodoList() {
  const status = document.getElementById('todo-filter-status')?.value || '';
  const priority = document.getElementById('todo-filter-priority')?.value || '';
  const category = document.getElementById('todo-filter-category')?.value || '';
  const search = document.getElementById('todo-search')?.value || '';

  const params = new URLSearchParams();
  if (status) params.set('status', status);
  if (priority) params.set('priority', priority);
  if (category) params.set('category', category);
  if (search) params.set('search', search);

  const data = await api('/calendar/todos?' + params.toString());
  if (!data) return;

  const container = document.getElementById('todo-list-container');
  if (!data.todos || data.todos.length === 0) {
    container.innerHTML = '<div style="color:var(--text2);text-align:center;padding:40px">No tasks found. Click "+ New Task" to add one.</div>';
    return;
  }

  container.innerHTML = data.todos.map(t => {
    const isCompleted = t.status === 'completed';
    const overdue = !isCompleted && t.due_date && t.due_date < new Date().toISOString().slice(0, 10);
    return `
    <div style="display:flex;align-items:center;gap:12px;padding:12px 16px;border-bottom:1px solid var(--border);${isCompleted ? 'opacity:0.5;' : ''}${overdue ? 'background:rgba(239,68,68,0.04);' : ''}" id="todo-row-${t.id}">
      <input type="checkbox" ${isCompleted ? 'checked' : ''} onchange="chronoToggleTodo('${t.id}', this.checked)" style="width:18px;height:18px;cursor:pointer;accent-color:var(--accent);flex-shrink:0">
      <div style="flex:1;min-width:0">
        <div style="font-size:14px;font-weight:600;${isCompleted ? 'text-decoration:line-through;' : ''}white-space:nowrap;overflow:hidden;text-overflow:ellipsis">
          ${categoryIcons[t.category] || 'üìå'} ${t.title}
        </div>
        <div style="font-size:11px;color:var(--text2);margin-top:2px">
          ${t.description ? t.description.slice(0, 80) + (t.description.length > 80 ? '...' : '') : ''}
          ${t.due_date ? '<span style="margin-left:8px' + (overdue ? ';color:var(--red);font-weight:600' : '') + '">üìÖ ' + t.due_date + (t.due_time ? ' ' + t.due_time : '') + (overdue ? ' OVERDUE' : '') + '</span>' : ''}
          ${t.recurrence !== 'none' ? ' <span style="color:var(--accent2)">üîÑ ' + t.recurrence + '</span>' : ''}
        </div>
      </div>
      <span style="font-size:10px;padding:3px 8px;border-radius:8px;font-weight:700;background:${priorityColors[t.priority]}18;color:${priorityColors[t.priority]};white-space:nowrap">${priorityIcons[t.priority] || ''} ${(t.priority || 'medium').toUpperCase()}</span>
      <button onclick="deleteTodo('${t.id}')" style="padding:4px 8px;border-radius:6px;border:1px solid var(--border);background:transparent;color:var(--text2);font-size:11px;cursor:pointer" title="Delete">‚úï</button>
    </div>`;
  }).join('');
}

async function deleteTodo(id) {
  if (!confirm('Delete this task?')) return;
  await api('/calendar/todos/' + id, { method: 'DELETE' });
  loadTodoList();
}

async function chronoClearCompleted() {
  if (!confirm('Remove all completed tasks?')) return;
  await api('/calendar/todos/bulk', { method: 'POST', body: { action: 'clear_completed', ids: [] } });
  loadTodoList();
}

function showAddTodoModal() {
  const modal = document.getElementById('add-todo-modal');
  modal.style.display = 'flex';
  document.getElementById('modal-todo-title').value = '';
  document.getElementById('modal-todo-desc').value = '';
  document.getElementById('modal-todo-title').focus();
}
function closeAddTodoModal() { document.getElementById('add-todo-modal').style.display = 'none'; }

async function submitNewTodo() {
  const title = document.getElementById('modal-todo-title').value.trim();
  if (!title) { alert('Title is required'); return; }

  const data = await api('/calendar/todos', {
    method: 'POST', body: {
      title,
      description: document.getElementById('modal-todo-desc').value,
      priority: document.getElementById('modal-todo-priority').value,
      category: document.getElementById('modal-todo-category').value,
      dueDate: document.getElementById('modal-todo-due-date').value || null,
      dueTime: document.getElementById('modal-todo-due-time').value || null,
      reminderAt: document.getElementById('modal-todo-reminder').value || null,
      recurrence: document.getElementById('modal-todo-recurrence').value,
    }
  });
  if (data) {
    closeAddTodoModal();
    loadTodoList();
    if (data.message) appendMotivation(data.message);
  }
}

// ‚îÄ‚îÄ Calendar Events Page ‚îÄ‚îÄ
async function loadCalendarEvents() {
  const data = await api('/calendar/events');
  if (!data) return;

  const now = new Date().toISOString();
  const today = new Date().toISOString().slice(0, 10);
  const events = data.events || [];

  // Upcoming events
  const upcoming = events.filter(e => e.start_time >= now).slice(0, 8);
  const upcomingEl = document.getElementById('events-upcoming-list');
  if (upcoming.length === 0) {
    upcomingEl.innerHTML = '<div style="color:var(--text2);text-align:center;padding:20px">No upcoming events. Schedule one!</div>';
  } else {
    upcomingEl.innerHTML = upcoming.map(e => `
      <div style="display:flex;align-items:center;gap:10px;padding:10px;border-radius:8px;background:var(--surface2);margin-bottom:6px;border-left:3px solid ${e.color || 'var(--accent)'}">
        <div style="width:42px;height:42px;border-radius:10px;background:${e.color || 'var(--accent)'}20;display:flex;align-items:center;justify-content:center;font-size:18px;flex-shrink:0">
          ${categoryIcons[e.category] || 'üìÖ'}
        </div>
        <div style="flex:1;min-width:0">
          <div style="font-size:13px;font-weight:600;white-space:nowrap;overflow:hidden;text-overflow:ellipsis">${e.title}</div>
          <div style="font-size:11px;color:var(--text2)">${new Date(e.start_time).toLocaleString()}${e.location ? ' ‚Ä¢ üìç ' + e.location : ''}</div>
        </div>
        <button onclick="deleteEvent('${e.id}')" style="padding:3px 6px;border-radius:4px;border:1px solid var(--border);background:transparent;color:var(--text2);font-size:10px;cursor:pointer">‚úï</button>
      </div>
    `).join('');
  }

  // Today's events
  const todayEvents = events.filter(e => e.start_time.slice(0, 10) === today);
  const todayEl = document.getElementById('events-today-list');
  if (todayEvents.length === 0) {
    todayEl.innerHTML = '<div style="color:var(--text2);text-align:center;padding:20px">No events scheduled for today.</div>';
  } else {
    todayEl.innerHTML = todayEvents.map(e => `
      <div style="display:flex;align-items:center;gap:10px;padding:10px;border-radius:8px;background:var(--surface2);margin-bottom:6px;border-left:3px solid ${e.color || 'var(--accent)'}">
        <div style="font-size:16px">${categoryIcons[e.category] || 'üìÖ'}</div>
        <div style="flex:1">
          <div style="font-size:13px;font-weight:600">${e.title}</div>
          <div style="font-size:11px;color:var(--text2)">${new Date(e.start_time).toLocaleTimeString([], {hour:'2-digit',minute:'2-digit'})}${e.end_time ? ' - ' + new Date(e.end_time).toLocaleTimeString([], {hour:'2-digit',minute:'2-digit'}) : ''}</div>
        </div>
      </div>
    `).join('');
  }

  // All events table
  const tbody = document.getElementById('events-all-tbody');
  if (events.length === 0) {
    tbody.innerHTML = '<tr><td colspan="6" style="color:var(--text2);text-align:center">No events yet.</td></tr>';
  } else {
    tbody.innerHTML = events.map(e => `<tr>
      <td><strong>${e.title}</strong></td>
      <td>${categoryIcons[e.category] || ''} ${e.category}</td>
      <td style="font-size:12px">${new Date(e.start_time).toLocaleString()}</td>
      <td style="font-size:12px">${e.end_time ? new Date(e.end_time).toLocaleString() : '‚Äî'}</td>
      <td style="font-size:12px">${e.location || '‚Äî'}</td>
      <td><button onclick="deleteEvent('${e.id}')" style="padding:3px 8px;border-radius:6px;border:1px solid var(--border);background:transparent;color:var(--red);font-size:11px;cursor:pointer">Delete</button></td>
    </tr>`).join('');
  }
}

function showAddEventModal() {
  const modal = document.getElementById('add-event-modal');
  modal.style.display = 'flex';
  document.getElementById('modal-event-title').value = '';
  document.getElementById('modal-event-desc').value = '';
  document.getElementById('modal-event-title').focus();
}
function closeAddEventModal() { document.getElementById('add-event-modal').style.display = 'none'; }

async function submitNewEvent() {
  const title = document.getElementById('modal-event-title').value.trim();
  const startTime = document.getElementById('modal-event-start').value;
  if (!title || !startTime) { alert('Title and start time are required'); return; }

  const data = await api('/calendar/events', {
    method: 'POST', body: {
      title,
      description: document.getElementById('modal-event-desc').value,
      startTime: new Date(startTime).toISOString(),
      endTime: document.getElementById('modal-event-end').value ? new Date(document.getElementById('modal-event-end').value).toISOString() : null,
      location: document.getElementById('modal-event-location').value,
      category: document.getElementById('modal-event-category').value,
    }
  });
  if (data) {
    closeAddEventModal();
    loadCalendarEvents();
  }
}

async function deleteEvent(id) {
  if (!confirm('Delete this event?')) return;
  await api('/calendar/events/' + id, { method: 'DELETE' });
  loadCalendarEvents();
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// ANALYTICS ‚Äî Predictive Analytics & AI Insights
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

let anTrendData = null;

function anApiGet(path) {
  return api('/super-analytics' + path, { method: 'GET' }).catch(() => null);
}

function switchAnTab(tab) {
  document.querySelectorAll('#an-tabs .an-tab').forEach(t => t.classList.remove('active'));
  document.querySelector(`#an-tabs .an-tab[onclick*="${tab}"]`)?.classList.add('active');
  ['an-overview','an-trends','an-forecast','an-insights','an-cashflow','an-partners'].forEach(t => {
    const el = document.getElementById(t);
    if (el) el.style.display = t === tab ? '' : 'none';
  });
  if (tab === 'an-trends') anLoadTrends();
  if (tab === 'an-forecast') anLoadForecast();
  if (tab === 'an-insights') anLoadInsights();
  if (tab === 'an-cashflow') anLoadCashFlow();
  if (tab === 'an-partners') anLoadPartnerRankings();
}

function anSparkline(points, color) {
  if (!points || points.length < 2) return '';
  const max = Math.max(...points, 1);
  const w = 100, h = 24;
  const coords = points.map((v, i) => `${(i / (points.length - 1)) * w},${h - (v / max) * h}`);
  return `<svg viewBox="0 0 ${w} ${h}" preserveAspectRatio="none">
    <polyline points="${coords.join(' ')}" fill="none" stroke="${color}" stroke-width="1.5" stroke-linecap="round"/>
  </svg>`;
}

function anFmtShort(n) {
  if (n >= 1e6) return (n / 1e6).toFixed(1) + 'M';
  if (n >= 1e3) return (n / 1e3).toFixed(1) + 'K';
  return n.toFixed(0);
}

async function loadAnalyticsDashboard() {
  // Reset to overview tab
  switchAnTab('an-overview');
  const data = await anApiGet('/metrics');
  if (!data || !data.metrics) {
    document.getElementById('an-kpi-grid').innerHTML = '<div style="color:var(--text2);padding:20px;grid-column:1/-1">Unable to load metrics.</div>';
    return;
  }
  const m = data.metrics;
  const sp = data.sparklines || {};
  const cards = [
    { label: 'Total Volume', value: '$' + fmt(m.totalVolume), trend: m.growth30d, spark: sp.volume, color: '#6366f1' },
    { label: 'Transactions', value: fmt(m.totalTransactions), trend: m.growth7d, spark: sp.transactions, color: '#3b82f6' },
    { label: 'Active Users', value: fmt(m.activeUsers), trend: null, spark: sp.users, color: '#22c55e' },
    { label: 'Revenue', value: '$' + fmt(m.totalRevenue), trend: m.growth30d, spark: sp.revenue, color: '#f59e0b' },
    { label: 'Avg Tx Size', value: '$' + (m.avgTransactionSize || 0).toFixed(2), trend: null, spark: null, color: '#8b5cf6' },
    { label: 'Growth 24h', value: (m.growth24h || 0) + '%', trend: m.growth24h, spark: null, color: (m.growth24h || 0) >= 0 ? '#22c55e' : '#ef4444' },
    { label: 'Growth 7d', value: (m.growth7d || 0) + '%', trend: m.growth7d, spark: null, color: (m.growth7d || 0) >= 0 ? '#22c55e' : '#ef4444' },
    { label: 'Partners', value: fmt(m.activePartners || 0), trend: null, spark: null, color: '#06b6d4' },
  ];
  document.getElementById('an-kpi-grid').innerHTML = cards.map(c => `
    <div class="kpi-card">
      <div class="kpi-label">${c.label}</div>
      <div class="kpi-value">${c.value}</div>
      ${c.trend !== null ? `<div class="kpi-trend ${c.trend > 0 ? 'up' : c.trend < 0 ? 'down' : 'stable'}">
        ${c.trend > 0 ? '&#9650;' : c.trend < 0 ? '&#9660;' : '&#9644;'} ${Math.abs(c.trend)}%
      </div>` : ''}
      ${c.spark ? `<div class="kpi-sparkline">${anSparkline(c.spark, c.color)}</div>` : ''}
    </div>
  `).join('');
}

async function anLoadTrends() {
  const agg = document.getElementById('an-trend-agg').value;
  const result = await anApiGet('/trends?agg=' + agg);
  if (!result) return;
  anTrendData = result;
  anRenderTrendChart();
  if (result.userGrowth) {
    anDrawLine('an-user-chart', result.userGrowth.map(t => t.users), '#22c55e');
  }
}

function anRenderTrendChart() {
  if (!anTrendData) return;
  const metric = document.getElementById('an-trend-metric').value;
  const points = anTrendData.trends.map(t => t[metric]);
  anDrawLine('an-trend-chart', points, metric === 'revenue' ? '#f59e0b' : '#6366f1');
}

function anDrawLine(canvasId, data, color) {
  const canvas = document.getElementById(canvasId);
  if (!canvas || !data.length) return;
  const ctx = canvas.getContext('2d');
  const dpr = window.devicePixelRatio || 1;
  const rect = canvas.parentElement.getBoundingClientRect();
  const h = parseInt(canvas.getAttribute('height')) || 200;
  canvas.width = rect.width * dpr; canvas.height = h * dpr;
  canvas.style.width = rect.width + 'px'; canvas.style.height = h + 'px';
  ctx.scale(dpr, dpr);
  const w = rect.width;
  const pad = { top: 20, right: 10, bottom: 30, left: 50 };
  const cw = w - pad.left - pad.right, ch = h - pad.top - pad.bottom;
  ctx.clearRect(0, 0, w, h);
  const max = Math.max(...data, 1) * 1.1;
  const min = Math.min(...data, 0);
  const range = max - min || 1;
  ctx.strokeStyle = 'rgba(255,255,255,.05)'; ctx.lineWidth = 1;
  for (let i = 0; i <= 4; i++) {
    const y = pad.top + ch - (i / 4) * ch;
    ctx.beginPath(); ctx.moveTo(pad.left, y); ctx.lineTo(w - pad.right, y); ctx.stroke();
    ctx.fillStyle = '#555'; ctx.font = '10px sans-serif'; ctx.textAlign = 'right';
    ctx.fillText(anFmtShort(min + (range * i / 4)), pad.left - 4, y + 3);
  }
  ctx.beginPath(); ctx.strokeStyle = color; ctx.lineWidth = 2; ctx.lineJoin = 'round';
  data.forEach((v, i) => {
    const x = pad.left + (i / (data.length - 1)) * cw;
    const y = pad.top + ch - ((v - min) / range) * ch;
    if (i === 0) ctx.moveTo(x, y); else ctx.lineTo(x, y);
  });
  ctx.stroke();
  ctx.lineTo(pad.left + cw, pad.top + ch); ctx.lineTo(pad.left, pad.top + ch); ctx.closePath();
  const grad = ctx.createLinearGradient(0, pad.top, 0, pad.top + ch);
  grad.addColorStop(0, color + '30'); grad.addColorStop(1, color + '05');
  ctx.fillStyle = grad; ctx.fill();
}

async function anLoadForecast() {
  const days = document.getElementById('an-fc-horizon').value;
  const metric = document.getElementById('an-fc-metric').value;
  const result = await anApiGet('/forecast?days=' + days + '&metric=' + metric);
  if (!result) return;
  const all = [...(result.historical || []), ...(result.forecast || [])];
  const values = all.map(p => p.value);
  const lowers = all.map(p => p.lower);
  const uppers = all.map(p => p.upper);
  const fcStart = (result.historical || []).length;
  anDrawForecast('an-forecast-chart', values, lowers, uppers, fcStart);
  document.getElementById('an-fc-meta').innerHTML = `
    <div class="forecast-pill">Method: <b>${result.method}</b></div>
    <div class="forecast-pill">Accuracy: <b>${result.accuracy}%</b></div>
    <div class="forecast-pill">Trend: <b style="color:${result.trend === 'up' ? 'var(--green)' : result.trend === 'down' ? 'var(--red)' : 'var(--text2)'}">${result.trend === 'up' ? '&#9650; Up' : result.trend === 'down' ? '&#9660; Down' : '&#9644; Stable'} (${result.growthRate}%)</b></div>
  `;
}

function anDrawForecast(canvasId, values, lowers, uppers, fcStart) {
  const canvas = document.getElementById(canvasId);
  if (!canvas || !values.length) return;
  const ctx = canvas.getContext('2d');
  const dpr = window.devicePixelRatio || 1;
  const rect = canvas.parentElement.getBoundingClientRect();
  const h = 280;
  canvas.width = rect.width * dpr; canvas.height = h * dpr;
  canvas.style.width = rect.width + 'px'; canvas.style.height = h + 'px';
  ctx.scale(dpr, dpr);
  const w = rect.width;
  const pad = { top: 20, right: 10, bottom: 30, left: 50 };
  const cw = w - pad.left - pad.right, ch = h - pad.top - pad.bottom;
  ctx.clearRect(0, 0, w, h);
  const allV = [...values, ...lowers, ...uppers];
  const max = Math.max(...allV, 1) * 1.1;
  const min = Math.min(...allV.filter(v => v >= 0), 0);
  const range = max - min || 1;
  const toX = i => pad.left + (i / (values.length - 1)) * cw;
  const toY = v => pad.top + ch - ((v - min) / range) * ch;
  ctx.strokeStyle = 'rgba(255,255,255,.05)'; ctx.lineWidth = 1;
  for (let i = 0; i <= 4; i++) {
    const y = pad.top + ch - (i / 4) * ch;
    ctx.beginPath(); ctx.moveTo(pad.left, y); ctx.lineTo(w - pad.right, y); ctx.stroke();
    ctx.fillStyle = '#555'; ctx.font = '10px sans-serif'; ctx.textAlign = 'right';
    ctx.fillText(anFmtShort(min + (range * i / 4)), pad.left - 4, y + 3);
  }
  if (fcStart > 0 && fcStart < values.length) {
    const fx = toX(fcStart);
    ctx.strokeStyle = 'rgba(99,102,241,.3)'; ctx.setLineDash([4, 4]);
    ctx.beginPath(); ctx.moveTo(fx, pad.top); ctx.lineTo(fx, pad.top + ch); ctx.stroke();
    ctx.setLineDash([]);
    ctx.fillStyle = '#6366f1'; ctx.font = '10px sans-serif'; ctx.textAlign = 'center';
    ctx.fillText('Forecast ‚Üí', fx + 30, pad.top + 10);
  }
  ctx.fillStyle = 'rgba(99,102,241,.1)'; ctx.beginPath();
  for (let i = fcStart; i < values.length; i++) ctx.lineTo(toX(i), toY(uppers[i]));
  for (let i = values.length - 1; i >= fcStart; i--) ctx.lineTo(toX(i), toY(lowers[i]));
  ctx.closePath(); ctx.fill();
  ctx.beginPath(); ctx.strokeStyle = '#6366f1'; ctx.lineWidth = 2;
  for (let i = 0; i < fcStart; i++) { const x = toX(i), y = toY(values[i]); if (i === 0) ctx.moveTo(x, y); else ctx.lineTo(x, y); }
  ctx.stroke();
  ctx.beginPath(); ctx.strokeStyle = '#818cf8'; ctx.lineWidth = 2; ctx.setLineDash([6, 3]);
  for (let i = Math.max(0, fcStart - 1); i < values.length; i++) { const x = toX(i), y = toY(values[i]); if (i === Math.max(0, fcStart - 1)) ctx.moveTo(x, y); else ctx.lineTo(x, y); }
  ctx.stroke(); ctx.setLineDash([]);
}

async function anLoadInsights() {
  const result = await anApiGet('/insights');
  if (!result) return;
  document.getElementById('an-insights-summary').textContent = result.summary || 'No summary available.';
  if (!result.insights || result.insights.length === 0) {
    document.getElementById('an-insights-list').innerHTML = '<div style="color:var(--text2);padding:20px;text-align:center">All metrics normal. No anomalies detected.</div>';
    return;
  }
  document.getElementById('an-insights-list').innerHTML = result.insights.map(i => `
    <div class="insight-card2">
      <div class="insight-icon2 ${i.type}">${i.type === 'warning' ? '&#9888;' : i.type === 'positive' ? '&#10003;' : '&#8505;'}</div>
      <div>
        <div style="font-size:13px;font-weight:700;margin-bottom:2px">${i.title}</div>
        <div style="font-size:12px;color:var(--text2);line-height:1.4">${i.description}</div>
        <div style="font-size:10px;color:var(--text2);margin-top:4px">
          <span style="padding:1px 6px;border-radius:4px;font-weight:600;background:${i.confidence > 75 ? 'rgba(34,197,94,.15);color:var(--green)' : 'rgba(245,158,11,.15);color:var(--yellow)'}">${i.confidence}% confidence</span>
          &nbsp; Impact: <b>${i.impact_level}</b>
        </div>
      </div>
    </div>
  `).join('');
}

async function anLoadCashFlow() {
  const result = await anApiGet('/cash-flow?days=30');
  if (!result || !result.balanceProjection) return;
  const inflow = result.balanceProjection.map(p => p.inflow);
  const outflow = result.balanceProjection.map(p => p.outflow);
  const balance = result.balanceProjection.map(p => p.balance);
  anDrawMultiLine('an-cf-chart', [
    { data: inflow, color: '#22c55e' },
    { data: outflow, color: '#ef4444' },
    { data: balance, color: '#6366f1' },
  ]);
  document.getElementById('an-cf-warning').style.display = result.lowLiquidityWarning ? '' : 'none';
}

function anDrawMultiLine(canvasId, series) {
  const canvas = document.getElementById(canvasId);
  if (!canvas) return;
  const ctx = canvas.getContext('2d');
  const dpr = window.devicePixelRatio || 1;
  const rect = canvas.parentElement.getBoundingClientRect();
  const h = 260;
  canvas.width = rect.width * dpr; canvas.height = h * dpr;
  canvas.style.width = rect.width + 'px'; canvas.style.height = h + 'px';
  ctx.scale(dpr, dpr);
  const w = rect.width;
  const pad = { top: 20, right: 10, bottom: 30, left: 50 };
  const cw = w - pad.left - pad.right, ch = h - pad.top - pad.bottom;
  ctx.clearRect(0, 0, w, h);
  const allVals = series.flatMap(s => s.data);
  const max = Math.max(...allVals, 1) * 1.1;
  const min = Math.min(...allVals, 0) * (Math.min(...allVals) < 0 ? 1.1 : 1);
  const range = max - min || 1;
  ctx.strokeStyle = 'rgba(255,255,255,.05)'; ctx.lineWidth = 1;
  for (let i = 0; i <= 4; i++) {
    const y = pad.top + ch - (i / 4) * ch;
    ctx.beginPath(); ctx.moveTo(pad.left, y); ctx.lineTo(w - pad.right, y); ctx.stroke();
    ctx.fillStyle = '#555'; ctx.font = '10px sans-serif'; ctx.textAlign = 'right';
    ctx.fillText(anFmtShort(min + (range * i / 4)), pad.left - 4, y + 3);
  }
  for (const s of series) {
    ctx.beginPath(); ctx.strokeStyle = s.color; ctx.lineWidth = 2; ctx.lineJoin = 'round';
    s.data.forEach((v, i) => {
      const x = pad.left + (i / (s.data.length - 1)) * cw;
      const y = pad.top + ch - ((v - min) / range) * ch;
      if (i === 0) ctx.moveTo(x, y); else ctx.lineTo(x, y);
    });
    ctx.stroke();
  }
}

async function anLoadPartnerRankings() {
  const sort = document.getElementById('an-partner-sort')?.value || 'volume';
  const result = await anApiGet('/partners?sort=' + sort);
  if (!result) return;
  document.getElementById('an-partner-tbody').innerHTML = (result.rankings || []).map((p, i) => `
    <tr>
      <td style="font-weight:800;color:var(--accent)">${i + 1}</td>
      <td>${p.partnerName || p.partnerId}</td>
      <td>$${fmt(p.volume)}</td>
      <td>$${fmt(p.revenue)}</td>
      <td>${fmt(p.transactions)}</td>
    </tr>
  `).join('') || '<tr><td colspan="5" style="text-align:center;color:var(--text2)">No partner data yet</td></tr>';

  document.getElementById('an-at-risk-list').innerHTML = (result.atRisk || []).map(p => `
    <div class="insight-card2">
      <div class="insight-icon2 warning">&#9888;</div>
      <div>
        <div style="font-size:13px;font-weight:700">${p.partnerName || p.partnerId}</div>
        <div style="font-size:12px;color:var(--text2)">Inactive ‚Äî Volume: $${fmt(p.volume)}, Revenue: $${fmt(p.revenue)}</div>
      </div>
    </div>
  `).join('') || '<div style="color:var(--text2);padding:12px">No at-risk partners.</div>';
}

// ‚îÄ‚îÄ Auto-refresh ‚îÄ‚îÄ
setInterval(() => {
  if (!getToken()) return;
  const activePage = document.querySelector('.page.active');
  if (activePage) {
    const id = activePage.id.replace('page-', '');
    loadPage(id);
  }
}, 30000);

// ‚îÄ‚îÄ Init ‚îÄ‚îÄ
initAuth();
</script>

</body>
</html>
